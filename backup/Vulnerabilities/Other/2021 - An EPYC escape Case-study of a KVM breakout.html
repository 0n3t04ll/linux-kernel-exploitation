<!DOCTYPE html>
<!-- saved from url=(0084)https://googleprojectzero.blogspot.com/2021/06/an-epyc-escape-case-study-of-kvm.html -->
<html class="v2" dir="ltr" lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:b="http://www.google.com/2005/gml/b" xmlns:data="http://www.google.com/2005/gml/data" xmlns:expr="http://www.google.com/2005/gml/expr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link href="./2021 - An EPYC escape Case-study of a KVM breakout_files/1529571102-css_bundle_v2.css" rel="stylesheet" type="text/css">
<meta content="width=1100" name="viewport">

<meta content="blogger" name="generator">
<link href="https://googleprojectzero.blogspot.com/favicon.ico" rel="icon" type="image/x-icon">
<link href="https://googleprojectzero.blogspot.com/2021/06/an-epyc-escape-case-study-of-kvm.html" rel="canonical">
<link rel="alternate" type="application/atom+xml" title="Project Zero - Atom" href="https://googleprojectzero.blogspot.com/feeds/posts/default">
<link rel="alternate" type="application/rss+xml" title="Project Zero - RSS" href="https://googleprojectzero.blogspot.com/feeds/posts/default?alt=rss">
<link rel="service.post" type="application/atom+xml" title="Project Zero - Atom" href="https://www.blogger.com/feeds/4838136820032157985/posts/default">

<link rel="alternate" type="application/atom+xml" title="Project Zero - Atom" href="https://googleprojectzero.blogspot.com/feeds/8408446653514773445/comments/default">
<!--[if IE]><script type="text/javascript" src="https://www.blogger.com/static/v1/jsbin/1155466832-ieretrofit.js"></script>
<![endif]-->
<meta content="https://googleprojectzero.blogspot.com/2021/06/an-epyc-escape-case-study-of-kvm.html" property="og:url">
<meta content="An EPYC escape: Case-study of a KVM breakout" property="og:title">
<meta content="  Posted by Felix Wilhelm, Project Zero Introduction   KVM (for Kernel-based Virtual Machine) is the de-facto standard hypervisor for Linux-..." property="og:description">
<!--[if IE]> <script> (function() { var html5 = ("abbr,article,aside,audio,canvas,datalist,details," + "figure,footer,header,hgroup,mark,menu,meter,nav,output," + "progress,section,time,video").split(','); for (var i = 0; i < html5.length; i++) { document.createElement(html5[i]); } try { document.execCommand('BackgroundImageCache', false, true); } catch(e) {} })(); </script> <![endif]-->
<title>Project Zero: An EPYC escape: Case-study of a KVM breakout</title>
<style type="text/css">@font-face{font-family:'Open Sans';font-style:normal;font-weight:400;font-stretch:100%;src:url(//fonts.gstatic.com/s/opensans/v27/memSYaGs126MiZpBA-UvWbX2vVnXBbObj2OVZyOOSr4dVJWUgsjZ0B4taVIGxA.woff2)format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F;}@font-face{font-family:'Open Sans';font-style:normal;font-weight:400;font-stretch:100%;src:url(//fonts.gstatic.com/s/opensans/v27/memSYaGs126MiZpBA-UvWbX2vVnXBbObj2OVZyOOSr4dVJWUgsjZ0B4kaVIGxA.woff2)format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116;}@font-face{font-family:'Open Sans';font-style:normal;font-weight:400;font-stretch:100%;src:url(//fonts.gstatic.com/s/opensans/v27/memSYaGs126MiZpBA-UvWbX2vVnXBbObj2OVZyOOSr4dVJWUgsjZ0B4saVIGxA.woff2)format('woff2');unicode-range:U+1F00-1FFF;}@font-face{font-family:'Open Sans';font-style:normal;font-weight:400;font-stretch:100%;src:url(//fonts.gstatic.com/s/opensans/v27/memSYaGs126MiZpBA-UvWbX2vVnXBbObj2OVZyOOSr4dVJWUgsjZ0B4jaVIGxA.woff2)format('woff2');unicode-range:U+0370-03FF;}@font-face{font-family:'Open Sans';font-style:normal;font-weight:400;font-stretch:100%;src:url(//fonts.gstatic.com/s/opensans/v27/memSYaGs126MiZpBA-UvWbX2vVnXBbObj2OVZyOOSr4dVJWUgsjZ0B4iaVIGxA.woff2)format('woff2');unicode-range:U+0590-05FF,U+20AA,U+25CC,U+FB1D-FB4F;}@font-face{font-family:'Open Sans';font-style:normal;font-weight:400;font-stretch:100%;src:url(//fonts.gstatic.com/s/opensans/v27/memSYaGs126MiZpBA-UvWbX2vVnXBbObj2OVZyOOSr4dVJWUgsjZ0B4vaVIGxA.woff2)format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB;}@font-face{font-family:'Open Sans';font-style:normal;font-weight:400;font-stretch:100%;src:url(//fonts.gstatic.com/s/opensans/v27/memSYaGs126MiZpBA-UvWbX2vVnXBbObj2OVZyOOSr4dVJWUgsjZ0B4uaVIGxA.woff2)format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;}@font-face{font-family:'Open Sans';font-style:normal;font-weight:400;font-stretch:100%;src:url(//fonts.gstatic.com/s/opensans/v27/memSYaGs126MiZpBA-UvWbX2vVnXBbObj2OVZyOOSr4dVJWUgsjZ0B4gaVI.woff2)format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;}</style>
<style id="page-skin-1" type="text/css"><!--
/*
-----------------------------------------------
Blogger Template Style
Name:     Simple
Designer: Blogger
URL:      www.blogger.com
----------------------------------------------- */
/* Content
----------------------------------------------- */
body {
font: normal normal 12px Open Sans;
color: #000000;
background: #eeeeee none repeat scroll top left;
padding: 0 0 0 0;
}
html body .region-inner {
min-width: 0;
max-width: 100%;
width: auto;
}
h2 {
font-size: 22px;
}
a:link {
text-decoration:none;
color: #2288bb;
}
a:visited {
text-decoration:none;
color: #888888;
}
a:hover {
text-decoration:underline;
color: #33aaff;
}
.body-fauxcolumn-outer .fauxcolumn-inner {
background: transparent none repeat scroll top left;
_background-image: none;
}
.body-fauxcolumn-outer .cap-top {
position: absolute;
z-index: 1;
height: 400px;
width: 100%;
}
.body-fauxcolumn-outer .cap-top .cap-left {
width: 100%;
background: transparent none repeat-x scroll top left;
_background-image: none;
}
.content-outer {
-moz-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-webkit-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-goog-ms-box-shadow: 0 0 0 #333333;
box-shadow: 0 0 0 rgba(0, 0, 0, .15);
margin-bottom: 1px;
}
.content-inner {
padding: 10px 40px;
}
.content-inner {
background-color: #ffffff;
}
/* Header
----------------------------------------------- */
.header-outer {
background: transparent none repeat-x scroll 0 -400px;
_background-image: none;
}
.Header h1 {
font: normal normal 40px Open Sans;
color: #000000;
text-shadow: 0 0 0 rgba(0, 0, 0, .2);
}
.Header h1 a {
color: #000000;
}
.Header .description {
font-size: 18px;
color: #000000;
}
.header-inner .Header .titlewrapper {
padding: 22px 0;
}
.header-inner .Header .descriptionwrapper {
padding: 0 0;
}
/* Tabs
----------------------------------------------- */
.tabs-inner .section:first-child {
border-top: 0 solid #dddddd;
}
.tabs-inner .section:first-child ul {
margin-top: -1px;
border-top: 1px solid #dddddd;
border-left: 1px solid #dddddd;
border-right: 1px solid #dddddd;
}
.tabs-inner .widget ul {
background: transparent none repeat-x scroll 0 -800px;
_background-image: none;
border-bottom: 1px solid #dddddd;
margin-top: 0;
margin-left: -30px;
margin-right: -30px;
}
.tabs-inner .widget li a {
display: inline-block;
padding: .6em 1em;
font: normal normal 12px Open Sans;
color: #000000;
border-left: 1px solid #ffffff;
border-right: 1px solid #dddddd;
}
.tabs-inner .widget li:first-child a {
border-left: none;
}
.tabs-inner .widget li.selected a, .tabs-inner .widget li a:hover {
color: #000000;
background-color: #eeeeee;
text-decoration: none;
}
/* Columns
----------------------------------------------- */
.main-outer {
border-top: 0 solid transparent;
}
.fauxcolumn-left-outer .fauxcolumn-inner {
border-right: 1px solid transparent;
}
.fauxcolumn-right-outer .fauxcolumn-inner {
border-left: 1px solid transparent;
}
/* Headings
----------------------------------------------- */
div.widget > h2,
div.widget h2.title {
margin: 0 0 1em 0;
font: normal bold 11px 'Trebuchet MS',Trebuchet,Verdana,sans-serif;
color: #000000;
}
/* Widgets
----------------------------------------------- */
.widget .zippy {
color: #999999;
text-shadow: 2px 2px 1px rgba(0, 0, 0, .1);
}
.widget .popular-posts ul {
list-style: none;
}
/* Posts
----------------------------------------------- */
h2.date-header {
font: normal bold 11px Arial, Tahoma, Helvetica, FreeSans, sans-serif;
}
.date-header span {
background-color: #bbbbbb;
color: #ffffff;
padding: 0.4em;
letter-spacing: 3px;
margin: inherit;
}
.main-inner {
padding-top: 35px;
padding-bottom: 65px;
}
.main-inner .column-center-inner {
padding: 0 0;
}
.main-inner .column-center-inner .section {
margin: 0 1em;
}
.post {
margin: 0 0 45px 0;
}
h3.post-title, .comments h4 {
font: normal normal 22px Open Sans;
margin: .75em 0 0;
}
.post-body {
font-size: 110%;
line-height: 1.4;
position: relative;
}
.post-body img, .post-body .tr-caption-container, .Profile img, .Image img,
.BlogList .item-thumbnail img {
padding: 2px;
background: #ffffff;
border: 1px solid #eeeeee;
-moz-box-shadow: 1px 1px 5px rgba(0, 0, 0, .1);
-webkit-box-shadow: 1px 1px 5px rgba(0, 0, 0, .1);
box-shadow: 1px 1px 5px rgba(0, 0, 0, .1);
}
.post-body img, .post-body .tr-caption-container {
padding: 5px;
}
.post-body .tr-caption-container {
color: #666666;
}
.post-body .tr-caption-container img {
padding: 0;
background: transparent;
border: none;
-moz-box-shadow: 0 0 0 rgba(0, 0, 0, .1);
-webkit-box-shadow: 0 0 0 rgba(0, 0, 0, .1);
box-shadow: 0 0 0 rgba(0, 0, 0, .1);
}
.post-header {
margin: 0 0 1.5em;
line-height: 1.6;
font-size: 90%;
}
.post-footer {
margin: 20px -2px 0;
padding: 5px 10px;
color: #666666;
background-color: #eeeeee;
border-bottom: 1px solid #eeeeee;
line-height: 1.6;
font-size: 90%;
}
#comments .comment-author {
padding-top: 1.5em;
border-top: 1px solid transparent;
background-position: 0 1.5em;
}
#comments .comment-author:first-child {
padding-top: 0;
border-top: none;
}
.avatar-image-container {
margin: .2em 0 0;
}
#comments .avatar-image-container img {
border: 1px solid #eeeeee;
}
/* Comments
----------------------------------------------- */
.comments .comments-content .icon.blog-author {
background-repeat: no-repeat;
background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAYAAABWzo5XAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAAd0SU1FB9sLFwMeCjjhcOMAAAD+SURBVDjLtZSvTgNBEIe/WRRnm3U8RC1neQdsm1zSBIU9VVF1FkUguQQsD9ITmD7ECZIJSE4OZo9stoVjC/zc7ky+zH9hXwVwDpTAWWLrgS3QAe8AZgaAJI5zYAmc8r0G4AHYHQKVwII8PZrZFsBFkeRCABYiMh9BRUhnSkPTNCtVXYXURi1FpBDgArj8QU1eVXUzfnjv7yP7kwu1mYrkWlU33vs1QNu2qU8pwN0UpKoqokjWwCztrMuBhEhmh8bD5UDqur75asbcX0BGUB9/HAMB+r32hznJgXy2v0sGLBcyAJ1EK3LFcbo1s91JeLwAbwGYu7TP/3ZGfnXYPgAVNngtqatUNgAAAABJRU5ErkJggg==);
}
.comments .comments-content .loadmore a {
border-top: 1px solid #999999;
border-bottom: 1px solid #999999;
}
.comments .comment-thread.inline-thread {
background-color: #eeeeee;
}
.comments .continue {
border-top: 2px solid #999999;
}
/* Accents
---------------------------------------------- */
.section-columns td.columns-cell {
border-left: 1px solid transparent;
}
.blog-pager {
background: transparent url(//www.blogblog.com/1kt/simple/paging_dot.png) repeat-x scroll top center;
}
.blog-pager-older-link, .home-link,
.blog-pager-newer-link {
background-color: #ffffff;
padding: 5px;
}
.footer-outer {
border-top: 1px dashed #bbbbbb;
}
/* Mobile
----------------------------------------------- */
body.mobile  {
background-size: auto;
}
.mobile .body-fauxcolumn-outer {
background: transparent none repeat scroll top left;
}
.mobile .body-fauxcolumn-outer .cap-top {
background-size: 100% auto;
}
.mobile .content-outer {
-webkit-box-shadow: 0 0 3px rgba(0, 0, 0, .15);
box-shadow: 0 0 3px rgba(0, 0, 0, .15);
}
.mobile .tabs-inner .widget ul {
margin-left: 0;
margin-right: 0;
}
.mobile .post {
margin: 0;
}
.mobile .main-inner .column-center-inner .section {
margin: 0;
}
.mobile .date-header span {
padding: 0.1em 10px;
margin: 0 -10px;
}
.mobile h3.post-title {
margin: 0;
}
.mobile .blog-pager {
background: transparent none no-repeat scroll top center;
}
.mobile .footer-outer {
border-top: none;
}
.mobile .main-inner, .mobile .footer-inner {
background-color: #ffffff;
}
.mobile-index-contents {
color: #000000;
}
.mobile-link-button {
background-color: #2288bb;
}
.mobile-link-button a:link, .mobile-link-button a:visited {
color: #ffffff;
}
.mobile .tabs-inner .section:first-child {
border-top: none;
}
.mobile .tabs-inner .PageList .widget-content {
background-color: #eeeeee;
color: #000000;
border-top: 1px solid #dddddd;
border-bottom: 1px solid #dddddd;
}
.mobile .tabs-inner .PageList .widget-content .pagelist-arrow {
border-left: 1px solid #dddddd;
}

--></style>
<style id="template-skin-1" type="text/css"><!--
body {
min-width: 1120px;
}
.content-outer, .content-fauxcolumn-outer, .region-inner {
min-width: 1120px;
max-width: 1120px;
_width: 1120px;
}
.main-inner .columns {
padding-left: 0;
padding-right: 310px;
}
.main-inner .fauxcolumn-center-outer {
left: 0;
right: 310px;
/* IE6 does not respect left and right together */
_width: expression(this.parentNode.offsetWidth -
parseInt("0") -
parseInt("310px") + 'px');
}
.main-inner .fauxcolumn-left-outer {
width: 0;
}
.main-inner .fauxcolumn-right-outer {
width: 310px;
}
.main-inner .column-left-outer {
width: 0;
right: 100%;
margin-left: -0;
}
.main-inner .column-right-outer {
width: 310px;
margin-right: -310px;
}
#layout {
min-width: 0;
}
#layout .content-outer {
min-width: 0;
width: 800px;
}
#layout .region-inner {
min-width: 0;
width: auto;
}
body#layout div.add_widget {
padding: 8px;
}
body#layout div.add_widget a {
margin-left: 32px;
}
--></style>
<link href="./2021 - An EPYC escape Case-study of a KVM breakout_files/authorization.css" media="all" onload="if(media!=&#39;all&#39;)media=&#39;all&#39;" rel="stylesheet"><noscript><link href='https://www.blogger.com/dyn-css/authorization.css?targetBlogID=4838136820032157985&amp;zx=ad19ae07-700c-4360-a3d4-5f036b99e9da' rel='stylesheet'/></noscript>
<meta name="google-adsense-platform-account" content="ca-host-pub-1556223355139109">
<meta name="google-adsense-platform-domain" content="blogspot.com">

<script src="./2021 - An EPYC escape Case-study of a KVM breakout_files/cb=gapi.loaded_2" async=""></script><script type="text/javascript" src="./2021 - An EPYC escape Case-study of a KVM breakout_files/f.txt"></script><style>.gc-bubbleDefault{table-layout:auto!important}.gc-bubbleDefault,.gc-reset{background-color:transparent!important;text-align:left;padding:0!important;margin:0!important;border:0!important}.pls-bubbleTop{border-bottom:1px solid #ccc!important}.pls-contentLeft,.pls-topTail,.pls-vertShimLeft{background-image:url(//ssl.gstatic.com/s2/oz/images/stars/po/bubblev1/border_3.gif)!important}.pls-topTail{background-repeat:repeat-x!important;background-position:bottom!important}.pls-vertShim{background-color:#fff!important;text-align:right}.tbl-grey .pls-vertShim{background-color:#f5f5f5!important}.pls-vertShimLeft{background-repeat:repeat-y!important;background-position:100%!important;height:4px}.pls-vertShimRight{height:4px}.pls-confirm-container .pls-vertShim{background-color:#fff3c2!important}.pls-contentWrap{background-color:#fff!important;position:relative!important;vertical-align:top}.pls-contentLeft{background-repeat:repeat-y;background-position:100%;vertical-align:top}.pls-dropRight{background-image:url(//ssl.gstatic.com/s2/oz/images/stars/po/bubblev1/bubbleDropR_3.png)!important;background-repeat:repeat-y!important}.pls-dropBL,.pls-dropBottom,.pls-dropRight,.pls-dropTR .pls-dropBR,.pls-tailleft,.pls-vert,.pls-vert img{vertical-align:top}.pls-dropBottom{background-image:url(//ssl.gstatic.com/s2/oz/images/stars/po/bubblev1/bubbleDropB_3.png)!important;background-repeat:repeat-x!important;width:100%}.pls-topLeft{text-align:right}.pls-topLeft,.pls-topRight{background:inherit!important;vertical-align:bottom}.pls-topRight{text-align:left}.pls-bottomLeft{background:inherit!important;text-align:right}.pls-bottomRight{background:inherit!important;text-align:left;vertical-align:top}.pls-tailbottom,.pls-tailleft,.pls-tailright,.pls-tailtop{display:none;position:relative}.pls-dropBL,.pls-dropBR,.pls-dropTR,.pls-tailbottom,.pls-tailleft,.pls-tailright,.pls-tailtop{background-image:url(//ssl.gstatic.com/s2/oz/images/stars/po/bubblev1/bubbleSprite_3.png)!important;background-repeat:no-repeat}.tbl-grey .pls-dropBL,.tbl-grey .pls-dropBR,.tbl-grey .pls-dropTR,.tbl-grey .pls-tailbottom,.tbl-grey .pls-tailleft,.tbl-grey .pls-tailright,.tbl-grey .pls-tailtop{background-image:url(//ssl.gstatic.com/s2/oz/images/stars/po/bubblev1/bubbleSprite-grey.png)!important}.pls-tailbottom{background-position:-23px 0}.pls-confirm-container .pls-tailbottom{background-position:-23px -10px}.pls-tailtop{background-position:-19px -20px}.pls-tailright{background-position:0 0}.pls-tailleft{background-position:-10px 0}.pls-tailtop{vertical-align:top}.gc-bubbleDefault td{line-height:0;font-size:0}.pls-tailbottom,.pls-topLeft img,.pls-topRight img{vertical-align:bottom}.bubbleDropTR,.pls-bottomLeft,.pls-bottomLeft img,.pls-dropBottom img,.pls-dropBottomL img,.pls-dropBottomR img{vertical-align:top}.pls-dropTR{background-position:0 -22px}.pls-dropBR{background-position:0 -27px}.pls-dropBL{background-position:0 -16px}.pls-spacerbottom,.pls-spacerleft,.pls-spacerright,.pls-spacertop{position:static!important}.pls-spinner{bottom:0;position:absolute;left:0;margin:auto;right:0;top:0}</style><script async="" src="./2021 - An EPYC escape Case-study of a KVM breakout_files/lazy.min.js.下載"></script></head>
<body class=" variant-simplysimple">
<div class="navbar section" id="navbar" name="Navbar"><div class="widget Navbar" data-version="1" id="Navbar1"><script src="./2021 - An EPYC escape Case-study of a KVM breakout_files/cb=gapi.loaded_1" async=""></script><script src="./2021 - An EPYC escape Case-study of a KVM breakout_files/cb=gapi.loaded_0" async=""></script><script type="text/javascript">
    function setAttributeOnload(object, attribute, val) {
      if(window.addEventListener) {
        window.addEventListener('load',
          function(){ object[attribute] = val; }, false);
      } else {
        window.attachEvent('onload', function(){ object[attribute] = val; });
      }
    }
  </script>
<div id="navbar-iframe-container"><iframe ng-non-bindable="" frameborder="0" hspace="0" marginheight="0" marginwidth="0" scrolling="no" style="" tabindex="0" vspace="0" width="100%" id="navbar-iframe" name="navbar-iframe" src="./2021 - An EPYC escape Case-study of a KVM breakout_files/navbar.html"></iframe></div>
<script type="text/javascript" src="./2021 - An EPYC escape Case-study of a KVM breakout_files/plusone.js.下載" gapi_processed="true"></script>
<script type="text/javascript">
      gapi.load("gapi.iframes:gapi.iframes.style.bubble", function() {
        if (gapi.iframes && gapi.iframes.getContext) {
          gapi.iframes.getContext().openChild({
              url: 'https://www.blogger.com/navbar.g?targetBlogID\x3d4838136820032157985\x26blogName\x3dProject+Zero\x26publishMode\x3dPUBLISH_MODE_BLOGSPOT\x26navbarType\x3dLIGHT\x26layoutType\x3dLAYOUTS\x26searchRoot\x3dhttps://googleprojectzero.blogspot.com/search\x26blogLocale\x3den\x26v\x3d2\x26homepageUrl\x3dhttps://googleprojectzero.blogspot.com/\x26targetPostID\x3d8408446653514773445\x26blogPostOrPageUrl\x3dhttps://googleprojectzero.blogspot.com/2021/06/an-epyc-escape-case-study-of-kvm.html\x26vt\x3d7891780430481138294',
              where: document.getElementById("navbar-iframe-container"),
              id: "navbar-iframe"
          });
        }
      });
    </script><script type="text/javascript">
(function() {
var script = document.createElement('script');
script.type = 'text/javascript';
script.src = '//pagead2.googlesyndication.com/pagead/js/google_top_exp.js';
var head = document.getElementsByTagName('head')[0];
if (head) {
head.appendChild(script);
}})();
</script>
</div></div>
<div class="body-fauxcolumns">
<div class="fauxcolumn-outer body-fauxcolumn-outer">
<div class="cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left">
<div class="fauxborder-right"></div>
<div class="fauxcolumn-inner">
</div>
</div>
<div class="cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
</div>
<div class="content">
<div class="content-fauxcolumns">
<div class="fauxcolumn-outer content-fauxcolumn-outer">
<div class="cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left">
<div class="fauxborder-right"></div>
<div class="fauxcolumn-inner">
</div>
</div>
<div class="cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
</div>
<div class="content-outer">
<div class="content-cap-top cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left content-fauxborder-left">
<div class="fauxborder-right content-fauxborder-right"></div>
<div class="content-inner">
<header>
<div class="header-outer">
<div class="header-cap-top cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left header-fauxborder-left">
<div class="fauxborder-right header-fauxborder-right"></div>
<div class="region-inner header-inner">
<div class="header section" id="header" name="Header"><div class="widget Header" data-version="1" id="Header1">
<div id="header-inner">
<div class="titlewrapper">
<h1 class="title">
<a href="https://googleprojectzero.blogspot.com/">
Project Zero
</a>
</h1>
</div>
<div class="descriptionwrapper">
<p class="description"><span>News and updates from the Project Zero team at Google</span></p>
</div>
</div>
</div></div>
</div>
</div>
<div class="header-cap-bottom cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
</header>
<div class="tabs-outer">
<div class="tabs-cap-top cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left tabs-fauxborder-left">
<div class="fauxborder-right tabs-fauxborder-right"></div>
<div class="region-inner tabs-inner">
<div class="tabs no-items section" id="crosscol" name="Cross-Column"></div>
<div class="tabs no-items section" id="crosscol-overflow" name="Cross-Column 2"></div>
</div>
</div>
<div class="tabs-cap-bottom cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
<div class="main-outer">
<div class="main-cap-top cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left main-fauxborder-left">
<div class="fauxborder-right main-fauxborder-right"></div>
<div class="region-inner main-inner">
<div class="columns fauxcolumns">
<div class="fauxcolumn-outer fauxcolumn-center-outer">
<div class="cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left">
<div class="fauxborder-right"></div>
<div class="fauxcolumn-inner">
</div>
</div>
<div class="cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
<div class="fauxcolumn-outer fauxcolumn-left-outer">
<div class="cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left">
<div class="fauxborder-right"></div>
<div class="fauxcolumn-inner">
</div>
</div>
<div class="cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
<div class="fauxcolumn-outer fauxcolumn-right-outer">
<div class="cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left">
<div class="fauxborder-right"></div>
<div class="fauxcolumn-inner">
</div>
</div>
<div class="cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
<!-- corrects IE6 width calculation -->
<div class="columns-inner">
<div class="column-center-outer">
<div class="column-center-inner">
<div class="main section" id="main" name="Main"><div class="widget Blog" data-version="1" id="Blog1">
<div class="blog-posts hfeed">

          <div class="date-outer">
        
<h2 class="date-header"><span>Tuesday, June 29, 2021</span></h2>

          <div class="date-posts">
        
<div class="post-outer">
<div class="post hentry uncustomized-post-template" itemprop="blogPost" itemscope="itemscope" itemtype="http://schema.org/BlogPosting">
<meta content="4838136820032157985" itemprop="blogId">
<meta content="8408446653514773445" itemprop="postId">
<a name="8408446653514773445"></a>
<h3 class="post-title entry-title" itemprop="name">
An EPYC escape: Case-study of a KVM breakout
</h3>
<div class="post-header">
<div class="post-header-line-1"></div>
</div>
<div class="post-body entry-content" id="post-body-8408446653514773445" itemprop="description articleBody">
<style type="text/css">@import url('https://themes.googleusercontent.com/fonts/css?kit=cGvuclDC_Z1vE_cnVEU6AfLhOPS0h0oMHpEhTRSdXHM5KEqTDahEV1ECVSsZOMl9_kmCvy597kDopqFAXvpeaA');.lst-kix_xko68zpk7do4-7>li{counter-increment:lst-ctn-kix_xko68zpk7do4-7}ol.lst-kix_69oxjbhu0l4-6.start{counter-reset:lst-ctn-kix_69oxjbhu0l4-6 0}ol.lst-kix_xko68zpk7do4-0.start{counter-reset:lst-ctn-kix_xko68zpk7do4-0 0}ol.lst-kix_44h6gatzfsnw-2{list-style-type:none}ol.lst-kix_xko68zpk7do4-6.start{counter-reset:lst-ctn-kix_xko68zpk7do4-6 0}ol.lst-kix_44h6gatzfsnw-1{list-style-type:none}ol.lst-kix_44h6gatzfsnw-0{list-style-type:none}ol.lst-kix_44h6gatzfsnw-6{list-style-type:none}ul.lst-kix_5qxqo8l30oy3-6{list-style-type:none}ol.lst-kix_44h6gatzfsnw-5{list-style-type:none}ul.lst-kix_5qxqo8l30oy3-5{list-style-type:none}ol.lst-kix_44h6gatzfsnw-4{list-style-type:none}ul.lst-kix_5qxqo8l30oy3-4{list-style-type:none}ol.lst-kix_44h6gatzfsnw-3{list-style-type:none}ul.lst-kix_5qxqo8l30oy3-3{list-style-type:none}.lst-kix_44h6gatzfsnw-4>li{counter-increment:lst-ctn-kix_44h6gatzfsnw-4}ol.lst-kix_44h6gatzfsnw-8{list-style-type:none}ul.lst-kix_5qxqo8l30oy3-8{list-style-type:none}ol.lst-kix_44h6gatzfsnw-7{list-style-type:none}ul.lst-kix_5qxqo8l30oy3-7{list-style-type:none}ol.lst-kix_69oxjbhu0l4-0.start{counter-reset:lst-ctn-kix_69oxjbhu0l4-0 0}.lst-kix_44h6gatzfsnw-6>li{counter-increment:lst-ctn-kix_44h6gatzfsnw-6}.lst-kix_69oxjbhu0l4-6>li{counter-increment:lst-ctn-kix_69oxjbhu0l4-6}ol.lst-kix_69oxjbhu0l4-1.start{counter-reset:lst-ctn-kix_69oxjbhu0l4-1 0}.lst-kix_mpitsk6u2vh4-0>li:before{content:"\0025cf  "}.lst-kix_mpitsk6u2vh4-3>li:before{content:"\0025cf  "}.lst-kix_44h6gatzfsnw-8>li{counter-increment:lst-ctn-kix_44h6gatzfsnw-8}.lst-kix_mpitsk6u2vh4-2>li:before{content:"\0025a0  "}.lst-kix_mpitsk6u2vh4-1>li:before{content:"\0025cb  "}.lst-kix_gmxrph3xv6dk-8>li:before{content:"-  "}ul.lst-kix_yq73i8vx5c3y-7{list-style-type:none}.lst-kix_9lp8uyya2hbd-8>li:before{content:"-  "}ul.lst-kix_yq73i8vx5c3y-6{list-style-type:none}.lst-kix_gmxrph3xv6dk-7>li:before{content:"-  "}ul.lst-kix_yq73i8vx5c3y-5{list-style-type:none}.lst-kix_mpitsk6u2vh4-6>li:before{content:"\0025cf  "}.lst-kix_mpitsk6u2vh4-8>li:before{content:"\0025a0  "}ul.lst-kix_yq73i8vx5c3y-4{list-style-type:none}ol.lst-kix_44h6gatzfsnw-4.start{counter-reset:lst-ctn-kix_44h6gatzfsnw-4 0}ul.lst-kix_yq73i8vx5c3y-3{list-style-type:none}.lst-kix_9lp8uyya2hbd-6>li:before{content:"-  "}.lst-kix_9lp8uyya2hbd-7>li:before{content:"-  "}ul.lst-kix_yq73i8vx5c3y-2{list-style-type:none}ol.lst-kix_xko68zpk7do4-1.start{counter-reset:lst-ctn-kix_xko68zpk7do4-1 0}ul.lst-kix_yq73i8vx5c3y-1{list-style-type:none}.lst-kix_mpitsk6u2vh4-7>li:before{content:"\0025cb  "}ul.lst-kix_yq73i8vx5c3y-0{list-style-type:none}.lst-kix_gmxrph3xv6dk-4>li:before{content:"-  "}.lst-kix_xko68zpk7do4-3>li{counter-increment:lst-ctn-kix_xko68zpk7do4-3}.lst-kix_gmxrph3xv6dk-5>li:before{content:"-  "}.lst-kix_mpitsk6u2vh4-4>li:before{content:"\0025cb  "}.lst-kix_gmxrph3xv6dk-6>li:before{content:"-  "}ul.lst-kix_5qxqo8l30oy3-2{list-style-type:none}ul.lst-kix_5qxqo8l30oy3-1{list-style-type:none}ul.lst-kix_5qxqo8l30oy3-0{list-style-type:none}.lst-kix_mpitsk6u2vh4-5>li:before{content:"\0025a0  "}.lst-kix_69oxjbhu0l4-8>li{counter-increment:lst-ctn-kix_69oxjbhu0l4-8}.lst-kix_gmxrph3xv6dk-0>li:before{content:"-  "}.lst-kix_9lp8uyya2hbd-0>li:before{content:"-  "}.lst-kix_9lp8uyya2hbd-1>li:before{content:"-  "}.lst-kix_gmxrph3xv6dk-1>li:before{content:"-  "}.lst-kix_69oxjbhu0l4-2>li{counter-increment:lst-ctn-kix_69oxjbhu0l4-2}.lst-kix_9lp8uyya2hbd-2>li:before{content:"-  "}.lst-kix_9lp8uyya2hbd-3>li:before{content:"-  "}.lst-kix_xko68zpk7do4-0>li{counter-increment:lst-ctn-kix_xko68zpk7do4-0}.lst-kix_9lp8uyya2hbd-4>li:before{content:"-  "}.lst-kix_9lp8uyya2hbd-5>li:before{content:"-  "}.lst-kix_gmxrph3xv6dk-3>li:before{content:"-  "}.lst-kix_gmxrph3xv6dk-2>li:before{content:"-  "}ol.lst-kix_44h6gatzfsnw-5.start{counter-reset:lst-ctn-kix_44h6gatzfsnw-5 0}.lst-kix_44h6gatzfsnw-2>li{counter-increment:lst-ctn-kix_44h6gatzfsnw-2}.lst-kix_6q7katqp5wyr-6>li:before{content:"\0025cf  "}.lst-kix_6q7katqp5wyr-8>li:before{content:"\0025a0  "}.lst-kix_69oxjbhu0l4-1>li{counter-increment:lst-ctn-kix_69oxjbhu0l4-1}.lst-kix_6q7katqp5wyr-2>li:before{content:"\0025a0  "}ol.lst-kix_44h6gatzfsnw-3.start{counter-reset:lst-ctn-kix_44h6gatzfsnw-3 0}ol.lst-kix_69oxjbhu0l4-2{list-style-type:none}ol.lst-kix_69oxjbhu0l4-3{list-style-type:none}ol.lst-kix_69oxjbhu0l4-0{list-style-type:none}ol.lst-kix_69oxjbhu0l4-1{list-style-type:none}ul.lst-kix_p3qtgxnpnwqf-0{list-style-type:none}ul.lst-kix_p3qtgxnpnwqf-1{list-style-type:none}ul.lst-kix_p3qtgxnpnwqf-2{list-style-type:none}ul.lst-kix_p3qtgxnpnwqf-3{list-style-type:none}ol.lst-kix_69oxjbhu0l4-8{list-style-type:none}ul.lst-kix_p3qtgxnpnwqf-4{list-style-type:none}.lst-kix_6q7katqp5wyr-4>li:before{content:"\0025cb  "}ul.lst-kix_p3qtgxnpnwqf-5{list-style-type:none}.lst-kix_dvq5vbolwb6x-4>li:before{content:"\0025cb  "}ol.lst-kix_69oxjbhu0l4-6{list-style-type:none}ul.lst-kix_p3qtgxnpnwqf-6{list-style-type:none}ul.lst-kix_h05x1pycvl0d-0{list-style-type:none}ol.lst-kix_69oxjbhu0l4-7{list-style-type:none}ul.lst-kix_p3qtgxnpnwqf-7{list-style-type:none}ol.lst-kix_69oxjbhu0l4-4{list-style-type:none}ul.lst-kix_p3qtgxnpnwqf-8{list-style-type:none}ul.lst-kix_h05x1pycvl0d-2{list-style-type:none}ol.lst-kix_69oxjbhu0l4-5{list-style-type:none}ul.lst-kix_h05x1pycvl0d-1{list-style-type:none}ul.lst-kix_h05x1pycvl0d-4{list-style-type:none}ul.lst-kix_h05x1pycvl0d-3{list-style-type:none}ul.lst-kix_h05x1pycvl0d-6{list-style-type:none}ul.lst-kix_h05x1pycvl0d-5{list-style-type:none}.lst-kix_dvq5vbolwb6x-6>li:before{content:"\0025cf  "}.lst-kix_dvq5vbolwb6x-8>li:before{content:"\0025a0  "}ul.lst-kix_h05x1pycvl0d-8{list-style-type:none}ul.lst-kix_h05x1pycvl0d-7{list-style-type:none}.lst-kix_rg61eog4va0o-7>li:before{content:"\0025cb  "}.lst-kix_69oxjbhu0l4-0>li{counter-increment:lst-ctn-kix_69oxjbhu0l4-0}ul.lst-kix_gmxrph3xv6dk-6{list-style-type:none}ul.lst-kix_gmxrph3xv6dk-5{list-style-type:none}ul.lst-kix_gmxrph3xv6dk-8{list-style-type:none}ul.lst-kix_gmxrph3xv6dk-7{list-style-type:none}ul.lst-kix_gmxrph3xv6dk-2{list-style-type:none}ul.lst-kix_gmxrph3xv6dk-1{list-style-type:none}ol.lst-kix_44h6gatzfsnw-0.start{counter-reset:lst-ctn-kix_44h6gatzfsnw-0 0}ul.lst-kix_gmxrph3xv6dk-4{list-style-type:none}ul.lst-kix_vu6o8yw128np-1{list-style-type:none}ul.lst-kix_gmxrph3xv6dk-3{list-style-type:none}ul.lst-kix_vu6o8yw128np-0{list-style-type:none}ul.lst-kix_qmksthfuerg1-0{list-style-type:none}ul.lst-kix_vu6o8yw128np-3{list-style-type:none}ul.lst-kix_vu6o8yw128np-2{list-style-type:none}ul.lst-kix_qmksthfuerg1-2{list-style-type:none}ul.lst-kix_gmxrph3xv6dk-0{list-style-type:none}ul.lst-kix_vu6o8yw128np-5{list-style-type:none}ul.lst-kix_qmksthfuerg1-1{list-style-type:none}ul.lst-kix_vu6o8yw128np-4{list-style-type:none}ul.lst-kix_qmksthfuerg1-4{list-style-type:none}ul.lst-kix_vu6o8yw128np-7{list-style-type:none}ul.lst-kix_qmksthfuerg1-3{list-style-type:none}ul.lst-kix_vu6o8yw128np-6{list-style-type:none}.lst-kix_z3dz91t3nune-1>li:before{content:"\0025cb  "}ul.lst-kix_qmksthfuerg1-6{list-style-type:none}.lst-kix_p3qtgxnpnwqf-0>li:before{content:"\0025cf  "}.lst-kix_p3qtgxnpnwqf-2>li:before{content:"\0025a0  "}.lst-kix_vu6o8yw128np-0>li:before{content:"-  "}.lst-kix_vu6o8yw128np-2>li:before{content:"-  "}ul.lst-kix_qmksthfuerg1-5{list-style-type:none}ul.lst-kix_vu6o8yw128np-8{list-style-type:none}ul.lst-kix_qmksthfuerg1-8{list-style-type:none}ul.lst-kix_mpitsk6u2vh4-1{list-style-type:none}ul.lst-kix_qmksthfuerg1-7{list-style-type:none}ul.lst-kix_mpitsk6u2vh4-0{list-style-type:none}ul.lst-kix_mpitsk6u2vh4-3{list-style-type:none}ul.lst-kix_mpitsk6u2vh4-2{list-style-type:none}ul.lst-kix_mpitsk6u2vh4-5{list-style-type:none}ul.lst-kix_mpitsk6u2vh4-4{list-style-type:none}ul.lst-kix_mpitsk6u2vh4-7{list-style-type:none}.lst-kix_vu6o8yw128np-6>li:before{content:"-  "}ul.lst-kix_mpitsk6u2vh4-6{list-style-type:none}.lst-kix_44h6gatzfsnw-3>li{counter-increment:lst-ctn-kix_44h6gatzfsnw-3}ul.lst-kix_mpitsk6u2vh4-8{list-style-type:none}.lst-kix_rg61eog4va0o-1>li:before{content:"\0025cb  "}.lst-kix_z3dz91t3nune-3>li:before{content:"\0025cf  "}ul.lst-kix_rg61eog4va0o-7{list-style-type:none}.lst-kix_rg61eog4va0o-3>li:before{content:"\0025cf  "}ul.lst-kix_rg61eog4va0o-6{list-style-type:none}.lst-kix_p3qtgxnpnwqf-8>li:before{content:"\0025a0  "}ul.lst-kix_rg61eog4va0o-5{list-style-type:none}ul.lst-kix_rg61eog4va0o-4{list-style-type:none}ul.lst-kix_rg61eog4va0o-3{list-style-type:none}ul.lst-kix_rg61eog4va0o-2{list-style-type:none}ul.lst-kix_rg61eog4va0o-1{list-style-type:none}ul.lst-kix_rg61eog4va0o-0{list-style-type:none}.lst-kix_p3qtgxnpnwqf-4>li:before{content:"\0025cb  "}.lst-kix_p3qtgxnpnwqf-6>li:before{content:"\0025cf  "}.lst-kix_vu6o8yw128np-4>li:before{content:"-  "}ol.lst-kix_44h6gatzfsnw-1.start{counter-reset:lst-ctn-kix_44h6gatzfsnw-1 0}.lst-kix_rg61eog4va0o-5>li:before{content:"\0025a0  "}ul.lst-kix_rg61eog4va0o-8{list-style-type:none}.lst-kix_qmksthfuerg1-6>li:before{content:"\0025cf  "}ol.lst-kix_44h6gatzfsnw-2.start{counter-reset:lst-ctn-kix_44h6gatzfsnw-2 0}.lst-kix_fc4hxeeodeag-1>li:before{content:"\0025cb  "}.lst-kix_qmksthfuerg1-0>li:before{content:"\0025cf  "}.lst-kix_qmksthfuerg1-8>li:before{content:"\0025a0  "}.lst-kix_fc4hxeeodeag-3>li:before{content:"\0025cf  "}.lst-kix_6q7katqp5wyr-0>li:before{content:"\0025cf  "}.lst-kix_vu6o8yw128np-8>li:before{content:"-  "}.lst-kix_yq73i8vx5c3y-5>li:before{content:"-  "}.lst-kix_xko68zpk7do4-5>li{counter-increment:lst-ctn-kix_xko68zpk7do4-5}.lst-kix_fc4hxeeodeag-7>li:before{content:"\0025cb  "}.lst-kix_qmksthfuerg1-2>li:before{content:"\0025a0  "}.lst-kix_z3dz91t3nune-5>li:before{content:"\0025a0  "}.lst-kix_yq73i8vx5c3y-1>li:before{content:"-  "}.lst-kix_yq73i8vx5c3y-3>li:before{content:"-  "}.lst-kix_fc4hxeeodeag-5>li:before{content:"\0025a0  "}.lst-kix_qmksthfuerg1-4>li:before{content:"\0025cb  "}.lst-kix_z3dz91t3nune-7>li:before{content:"\0025cb  "}.lst-kix_69oxjbhu0l4-1>li:before{content:"" counter(lst-ctn-kix_69oxjbhu0l4-1,lower-latin) ". "}.lst-kix_69oxjbhu0l4-3>li:before{content:"" counter(lst-ctn-kix_69oxjbhu0l4-3,decimal) ". "}.lst-kix_69oxjbhu0l4-2>li:before{content:"" counter(lst-ctn-kix_69oxjbhu0l4-2,lower-roman) ". "}.lst-kix_69oxjbhu0l4-7>li{counter-increment:lst-ctn-kix_69oxjbhu0l4-7}.lst-kix_69oxjbhu0l4-5>li:before{content:"" counter(lst-ctn-kix_69oxjbhu0l4-5,lower-roman) ". "}.lst-kix_69oxjbhu0l4-4>li:before{content:"" counter(lst-ctn-kix_69oxjbhu0l4-4,lower-latin) ". "}.lst-kix_yq73i8vx5c3y-6>li:before{content:"-  "}.lst-kix_xko68zpk7do4-6>li:before{content:"" counter(lst-ctn-kix_xko68zpk7do4-6,decimal) ". "}.lst-kix_xko68zpk7do4-5>li:before{content:"" counter(lst-ctn-kix_xko68zpk7do4-5,lower-roman) ". "}.lst-kix_yq73i8vx5c3y-7>li:before{content:"-  "}ol.lst-kix_xko68zpk7do4-3.start{counter-reset:lst-ctn-kix_xko68zpk7do4-3 0}.lst-kix_xko68zpk7do4-4>li:before{content:"" counter(lst-ctn-kix_xko68zpk7do4-4,lower-latin) ". "}.lst-kix_yq73i8vx5c3y-8>li:before{content:"-  "}.lst-kix_xko68zpk7do4-2>li:before{content:"" counter(lst-ctn-kix_xko68zpk7do4-2,lower-roman) ". "}.lst-kix_xko68zpk7do4-6>li{counter-increment:lst-ctn-kix_xko68zpk7do4-6}.lst-kix_xko68zpk7do4-1>li:before{content:"" counter(lst-ctn-kix_xko68zpk7do4-1,lower-latin) ". "}.lst-kix_xko68zpk7do4-3>li:before{content:"" counter(lst-ctn-kix_xko68zpk7do4-3,decimal) ". "}.lst-kix_69oxjbhu0l4-0>li:before{content:"" counter(lst-ctn-kix_69oxjbhu0l4-0,decimal) ". "}ol.lst-kix_69oxjbhu0l4-3.start{counter-reset:lst-ctn-kix_69oxjbhu0l4-3 0}.lst-kix_h05x1pycvl0d-4>li:before{content:"-  "}.lst-kix_h05x1pycvl0d-6>li:before{content:"-  "}.lst-kix_xko68zpk7do4-0>li:before{content:"" counter(lst-ctn-kix_xko68zpk7do4-0,decimal) ". "}.lst-kix_h05x1pycvl0d-1>li:before{content:"-  "}.lst-kix_h05x1pycvl0d-5>li:before{content:"-  "}.lst-kix_h05x1pycvl0d-0>li:before{content:"-  "}.lst-kix_h05x1pycvl0d-8>li:before{content:"-  "}ol.lst-kix_44h6gatzfsnw-7.start{counter-reset:lst-ctn-kix_44h6gatzfsnw-7 0}.lst-kix_h05x1pycvl0d-7>li:before{content:"-  "}ul.lst-kix_6q7katqp5wyr-0{list-style-type:none}.lst-kix_44h6gatzfsnw-8>li:before{content:"" counter(lst-ctn-kix_44h6gatzfsnw-8,lower-roman) ". "}ul.lst-kix_6q7katqp5wyr-4{list-style-type:none}ul.lst-kix_6q7katqp5wyr-3{list-style-type:none}ul.lst-kix_6q7katqp5wyr-2{list-style-type:none}.lst-kix_69oxjbhu0l4-6>li:before{content:"" counter(lst-ctn-kix_69oxjbhu0l4-6,decimal) ". "}ul.lst-kix_6q7katqp5wyr-1{list-style-type:none}.lst-kix_44h6gatzfsnw-6>li:before{content:"" counter(lst-ctn-kix_44h6gatzfsnw-6,decimal) ". "}.lst-kix_69oxjbhu0l4-7>li:before{content:"" counter(lst-ctn-kix_69oxjbhu0l4-7,lower-latin) ". "}.lst-kix_h05x1pycvl0d-2>li:before{content:"-  "}.lst-kix_44h6gatzfsnw-7>li:before{content:"" counter(lst-ctn-kix_44h6gatzfsnw-7,lower-latin) ". "}.lst-kix_69oxjbhu0l4-8>li:before{content:"" counter(lst-ctn-kix_69oxjbhu0l4-8,lower-roman) ". "}.lst-kix_h05x1pycvl0d-3>li:before{content:"-  "}.lst-kix_5qxqo8l30oy3-7>li:before{content:"\0025cb  "}ul.lst-kix_dvq5vbolwb6x-0{list-style-type:none}ol.lst-kix_69oxjbhu0l4-8.start{counter-reset:lst-ctn-kix_69oxjbhu0l4-8 0}.lst-kix_44h6gatzfsnw-2>li:before{content:"" counter(lst-ctn-kix_44h6gatzfsnw-2,lower-roman) ". "}.lst-kix_44h6gatzfsnw-4>li:before{content:"" counter(lst-ctn-kix_44h6gatzfsnw-4,lower-latin) ". "}ul.lst-kix_dvq5vbolwb6x-4{list-style-type:none}.lst-kix_xko68zpk7do4-4>li{counter-increment:lst-ctn-kix_xko68zpk7do4-4}ul.lst-kix_dvq5vbolwb6x-3{list-style-type:none}.lst-kix_5qxqo8l30oy3-6>li:before{content:"\0025cf  "}ul.lst-kix_dvq5vbolwb6x-2{list-style-type:none}.lst-kix_44h6gatzfsnw-1>li:before{content:"" counter(lst-ctn-kix_44h6gatzfsnw-1,lower-latin) ". "}.lst-kix_44h6gatzfsnw-5>li:before{content:"" counter(lst-ctn-kix_44h6gatzfsnw-5,lower-roman) ". "}ul.lst-kix_dvq5vbolwb6x-1{list-style-type:none}ul.lst-kix_6q7katqp5wyr-8{list-style-type:none}ul.lst-kix_6q7katqp5wyr-7{list-style-type:none}ul.lst-kix_6q7katqp5wyr-6{list-style-type:none}ul.lst-kix_6q7katqp5wyr-5{list-style-type:none}.lst-kix_5qxqo8l30oy3-1>li:before{content:"\0025cb  "}.lst-kix_5qxqo8l30oy3-0>li:before{content:"\0025cf  "}.lst-kix_5qxqo8l30oy3-8>li:before{content:"\0025a0  "}.lst-kix_44h6gatzfsnw-3>li:before{content:"" counter(lst-ctn-kix_44h6gatzfsnw-3,decimal) ". "}ol.lst-kix_xko68zpk7do4-8.start{counter-reset:lst-ctn-kix_xko68zpk7do4-8 0}.lst-kix_5qxqo8l30oy3-2>li:before{content:"\0025a0  "}.lst-kix_5qxqo8l30oy3-3>li:before{content:"\0025cf  "}ul.lst-kix_dvq5vbolwb6x-8{list-style-type:none}ul.lst-kix_dvq5vbolwb6x-7{list-style-type:none}ul.lst-kix_dvq5vbolwb6x-6{list-style-type:none}.lst-kix_44h6gatzfsnw-0>li:before{content:"" counter(lst-ctn-kix_44h6gatzfsnw-0,decimal) ". "}ul.lst-kix_dvq5vbolwb6x-5{list-style-type:none}.lst-kix_5qxqo8l30oy3-5>li:before{content:"\0025a0  "}.lst-kix_5qxqo8l30oy3-4>li:before{content:"\0025cb  "}.lst-kix_69oxjbhu0l4-5>li{counter-increment:lst-ctn-kix_69oxjbhu0l4-5}ol.lst-kix_69oxjbhu0l4-2.start{counter-reset:lst-ctn-kix_69oxjbhu0l4-2 0}.lst-kix_dvq5vbolwb6x-3>li:before{content:"\0025cf  "}.lst-kix_dvq5vbolwb6x-2>li:before{content:"\0025a0  "}.lst-kix_dvq5vbolwb6x-1>li:before{content:"\0025cb  "}ol.lst-kix_xko68zpk7do4-6{list-style-type:none}ol.lst-kix_xko68zpk7do4-7{list-style-type:none}.lst-kix_xko68zpk7do4-7>li:before{content:"" counter(lst-ctn-kix_xko68zpk7do4-7,lower-latin) ". "}ol.lst-kix_xko68zpk7do4-8{list-style-type:none}.lst-kix_dvq5vbolwb6x-0>li:before{content:"\0025cf  "}.lst-kix_xko68zpk7do4-8>li:before{content:"" counter(lst-ctn-kix_xko68zpk7do4-8,lower-roman) ". "}.lst-kix_44h6gatzfsnw-5>li{counter-increment:lst-ctn-kix_44h6gatzfsnw-5}ol.lst-kix_xko68zpk7do4-0{list-style-type:none}ol.lst-kix_xko68zpk7do4-1{list-style-type:none}ol.lst-kix_xko68zpk7do4-2{list-style-type:none}ol.lst-kix_xko68zpk7do4-3{list-style-type:none}ol.lst-kix_xko68zpk7do4-4{list-style-type:none}ol.lst-kix_xko68zpk7do4-2.start{counter-reset:lst-ctn-kix_xko68zpk7do4-2 0}ol.lst-kix_xko68zpk7do4-5{list-style-type:none}.lst-kix_6q7katqp5wyr-7>li:before{content:"\0025cb  "}.lst-kix_xko68zpk7do4-1>li{counter-increment:lst-ctn-kix_xko68zpk7do4-1}.lst-kix_6q7katqp5wyr-3>li:before{content:"\0025cf  "}.lst-kix_6q7katqp5wyr-1>li:before{content:"\0025cb  "}ul.lst-kix_fc4hxeeodeag-1{list-style-type:none}ul.lst-kix_fc4hxeeodeag-0{list-style-type:none}ul.lst-kix_fc4hxeeodeag-3{list-style-type:none}ul.lst-kix_fc4hxeeodeag-2{list-style-type:none}ul.lst-kix_fc4hxeeodeag-5{list-style-type:none}ul.lst-kix_fc4hxeeodeag-4{list-style-type:none}ul.lst-kix_fc4hxeeodeag-7{list-style-type:none}.lst-kix_44h6gatzfsnw-0>li{counter-increment:lst-ctn-kix_44h6gatzfsnw-0}ul.lst-kix_fc4hxeeodeag-6{list-style-type:none}ul.lst-kix_fc4hxeeodeag-8{list-style-type:none}ol.lst-kix_44h6gatzfsnw-6.start{counter-reset:lst-ctn-kix_44h6gatzfsnw-6 0}.lst-kix_6q7katqp5wyr-5>li:before{content:"\0025a0  "}.lst-kix_dvq5vbolwb6x-5>li:before{content:"\0025a0  "}.lst-kix_44h6gatzfsnw-1>li{counter-increment:lst-ctn-kix_44h6gatzfsnw-1}ol.lst-kix_69oxjbhu0l4-7.start{counter-reset:lst-ctn-kix_69oxjbhu0l4-7 0}ul.lst-kix_z3dz91t3nune-0{list-style-type:none}ul.lst-kix_z3dz91t3nune-2{list-style-type:none}ul.lst-kix_z3dz91t3nune-1{list-style-type:none}ul.lst-kix_z3dz91t3nune-4{list-style-type:none}.lst-kix_dvq5vbolwb6x-7>li:before{content:"\0025cb  "}ul.lst-kix_z3dz91t3nune-3{list-style-type:none}ul.lst-kix_z3dz91t3nune-6{list-style-type:none}ul.lst-kix_z3dz91t3nune-5{list-style-type:none}ul.lst-kix_z3dz91t3nune-8{list-style-type:none}ul.lst-kix_z3dz91t3nune-7{list-style-type:none}.lst-kix_rg61eog4va0o-8>li:before{content:"\0025a0  "}ol.lst-kix_xko68zpk7do4-4.start{counter-reset:lst-ctn-kix_xko68zpk7do4-4 0}ul.lst-kix_yq73i8vx5c3y-8{list-style-type:none}ol.lst-kix_69oxjbhu0l4-4.start{counter-reset:lst-ctn-kix_69oxjbhu0l4-4 0}ol.lst-kix_xko68zpk7do4-7.start{counter-reset:lst-ctn-kix_xko68zpk7do4-7 0}.lst-kix_69oxjbhu0l4-3>li{counter-increment:lst-ctn-kix_69oxjbhu0l4-3}.lst-kix_p3qtgxnpnwqf-1>li:before{content:"\0025cb  "}.lst-kix_vu6o8yw128np-1>li:before{content:"-  "}ol.lst-kix_xko68zpk7do4-5.start{counter-reset:lst-ctn-kix_xko68zpk7do4-5 0}.lst-kix_z3dz91t3nune-2>li:before{content:"\0025a0  "}ol.lst-kix_44h6gatzfsnw-8.start{counter-reset:lst-ctn-kix_44h6gatzfsnw-8 0}.lst-kix_p3qtgxnpnwqf-3>li:before{content:"\0025cf  "}.lst-kix_fc4hxeeodeag-8>li:before{content:"\0025a0  "}.lst-kix_z3dz91t3nune-0>li:before{content:"\0025cf  "}.lst-kix_z3dz91t3nune-4>li:before{content:"\0025cb  "}.lst-kix_vu6o8yw128np-5>li:before{content:"-  "}.lst-kix_69oxjbhu0l4-4>li{counter-increment:lst-ctn-kix_69oxjbhu0l4-4}.lst-kix_vu6o8yw128np-7>li:before{content:"-  "}.lst-kix_rg61eog4va0o-0>li:before{content:"\0025cf  "}ul.lst-kix_9lp8uyya2hbd-8{list-style-type:none}.lst-kix_rg61eog4va0o-2>li:before{content:"\0025a0  "}ul.lst-kix_9lp8uyya2hbd-6{list-style-type:none}ul.lst-kix_9lp8uyya2hbd-7{list-style-type:none}.lst-kix_p3qtgxnpnwqf-7>li:before{content:"\0025cb  "}ul.lst-kix_9lp8uyya2hbd-4{list-style-type:none}ul.lst-kix_9lp8uyya2hbd-5{list-style-type:none}ul.lst-kix_9lp8uyya2hbd-2{list-style-type:none}.lst-kix_fc4hxeeodeag-0>li:before{content:"\0025cf  "}ul.lst-kix_9lp8uyya2hbd-3{list-style-type:none}.lst-kix_p3qtgxnpnwqf-5>li:before{content:"\0025a0  "}.lst-kix_rg61eog4va0o-6>li:before{content:"\0025cf  "}.lst-kix_44h6gatzfsnw-7>li{counter-increment:lst-ctn-kix_44h6gatzfsnw-7}.lst-kix_vu6o8yw128np-3>li:before{content:"-  "}.lst-kix_rg61eog4va0o-4>li:before{content:"\0025cb  "}.lst-kix_qmksthfuerg1-5>li:before{content:"\0025a0  "}.lst-kix_yq73i8vx5c3y-0>li:before{content:"-  "}ul.lst-kix_9lp8uyya2hbd-0{list-style-type:none}.lst-kix_qmksthfuerg1-1>li:before{content:"\0025cb  "}ul.lst-kix_9lp8uyya2hbd-1{list-style-type:none}ol.lst-kix_69oxjbhu0l4-5.start{counter-reset:lst-ctn-kix_69oxjbhu0l4-5 0}.lst-kix_qmksthfuerg1-7>li:before{content:"\0025cb  "}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_fc4hxeeodeag-2>li:before{content:"\0025a0  "}.lst-kix_xko68zpk7do4-2>li{counter-increment:lst-ctn-kix_xko68zpk7do4-2}.lst-kix_xko68zpk7do4-8>li{counter-increment:lst-ctn-kix_xko68zpk7do4-8}.lst-kix_z3dz91t3nune-8>li:before{content:"\0025a0  "}.lst-kix_fc4hxeeodeag-4>li:before{content:"\0025cb  "}.lst-kix_yq73i8vx5c3y-4>li:before{content:"-  "}.lst-kix_z3dz91t3nune-6>li:before{content:"\0025cf  "}.lst-kix_qmksthfuerg1-3>li:before{content:"\0025cf  "}.lst-kix_fc4hxeeodeag-6>li:before{content:"\0025cf  "}.lst-kix_yq73i8vx5c3y-2>li:before{content:"-  "}ol{margin:0;padding:0}table td,table th{padding:0}.c17{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#e0e0e0;border-top-width:1pt;border-right-width:1pt;border-left-color:#e0e0e0;vertical-align:top;border-right-color:#e0e0e0;border-left-width:1pt;border-top-style:solid;background-color:#fafafa;border-left-style:solid;border-bottom-width:1pt;width:468pt;border-top-color:#e0e0e0;border-bottom-style:solid}.c32{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:468pt;border-top-color:#000000;border-bottom-style:solid}.c4{margin-left:36pt;padding-top:0pt;padding-left:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.c8{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c21{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:16pt;font-family:"Arial";font-style:normal}.c2{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:10pt;font-family:Consolas,"Courier New";font-style:normal}.c14{margin-left:36pt;padding-top:0pt;padding-left:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.c20{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;text-align:left}.c1{font-size:10pt;font-family:Consolas,"Courier New";color:#616161;font-weight:400}.c0{font-size:10pt;font-family:Consolas,"Courier New";color:#9c27b0;font-weight:400}.c3{font-size:10pt;font-family:Consolas,"Courier New";color:#000000;font-weight:400}.c24{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.c27{color:#000000;font-weight:400;font-size:11pt;font-family:Consolas,"Courier New"}.c10{font-size:10pt;font-family:Consolas,"Courier New";color:#c53929;font-weight:400}.c38{color:#000000;font-weight:400;font-size:10pt;font-family:"Roboto"}.c16{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c5{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left}.c30{border-spacing:0;border-collapse:collapse;margin-right:auto}.c22{font-size:10pt;font-family:Consolas,"Courier New";color:#455a64;font-weight:400}.c29{color:#000000;font-weight:400;font-size:10pt;font-family:"Arial"}.c23{font-size:10pt;font-family:Consolas,"Courier New";font-weight:400}.c31{background-color:#fafafa;font-size:10.5pt;font-family:"Roboto"}.c25{text-decoration:none;vertical-align:baseline;font-style:normal}.c37{font-size:10pt;font-family:Consolas,"Courier New";color:#616161}.c36{color:#9c27b0;font-size:10pt;font-family:Consolas,"Courier New"}.c15{font-family:Consolas,"Courier New";color:#0d904f;font-weight:400}.c9{orphans:2;widows:2;height:11pt}.c13{orphans:2;widows:2}.c7{color:inherit;text-decoration:inherit}.c12{padding:0;margin:0}.c33{max-width:468pt;padding:72pt 72pt 72pt 72pt}.c35{margin-left:36pt}.c28{height:0pt}.c34{color:#0f9d58}.c19{height:1030.1pt}.c6{background-color:#ffffff}.c26{font-style:italic}.c11{height:11pt}.c18{font-weight:700}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style>
 <p class="c5 c13"><span class="c8">Posted by Felix Wilhelm, Project Zero</span></p><h2 class="c20 c13" id="h.atcddzti5hh2"><span class="c21">Introduction</span></h2>
 <p class="c5 c13"><span class="c8">KVM (for Kernel-based Virtual Machine) is the de-facto standard hypervisor for Linux-based cloud environments. Outside of Azure, almost all large-scale cloud and hosting providers are running on top of KVM, turning it into one of the fundamental security boundaries in the cloud. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span>In this blog post I describe a </span><span class="c16"><a class="c71" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2177&amp;q=owner%3Afwilhelm%40google.com&amp;can=1">vulnerability</a></span><span>&nbsp;in KVM’s AMD-specific code and discuss how this bug can be turned into a full virtual machine escape. </span><span class="c18">To the best of my knowledge, this is the first public writeup of a KVM guest-to-host breakout that does not rely on bugs in user space components such as QEMU. The discussed bug was assigned CVE-2021-29657, affects kernel versions </span><span class="c18 c31">v5.10-rc1 to v5.12-rc6</span><span class="c18">&nbsp;and was patched at the end of </span><span class="c16 c18"><a class="c71" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=a58d9166a756a0f4a6618e4f593232593d6df134">March</a></span><span class="c18">&nbsp;2021</span><span class="c18">.</span><span class="c8">&nbsp;As the bug only became exploitable in v5.10 and was discovered roughly 5 months later, most real world deployments of KVM should not be affected. I still think the issue is an interesting case study in the work required to build a stable guest-to-host escape against KVM and hope that this writeup can strengthen the case that hypervisor compromises are not only theoretical issues. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">I start with a short overview of KVM’s architecture, before diving into the bug and its exploitation.</span></p>
 <p class="c5 c9"><span class="c8"></span></p><h2 class="c20 c13" id="h.t0ejvkqgm647"><span class="c21">KVM</span></h2>
 <p class="c5 c13"><span class="c8">KVM is a Linux based open source hypervisor supporting hardware accelerated virtualization on x86, ARM, PowerPC and S/390. In contrast to the other big open source hypervisor Xen, KVM is deeply integrated with the Linux Kernel and builds on its scheduling, memory management and hardware integrations to provide efficient virtualization.</span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span>KVM is implemented as one or more kernel modules (kvm.ko plus kvm-intel.ko or kvm-amd.ko on x86) that expose a low-level IOCTL-based </span><span class="c16"><a class="c71" href="https://www.kernel.org/doc/html/latest/virt/kvm/api.html">API</a></span><span>&nbsp;to user space processes over the /dev/kvm device. Using this API, a user space process (often called VMM for Virtual Machine Manager) can create new VMs, assign vCPUs and memory, and intercept memory or IO accesses to provide access to </span><span>emulate</span><span>d or virtualization-aware hardware devices. </span><span class="c16"><a class="c71" href="https://www.qemu.org/">QEMU</a></span><span>&nbsp;has been the standard user space choice for KVM-based virtualization for a long time, but in the last few years alternatives like </span><span class="c16"><a class="c71" href="https://github.com/lkvm/lkvm">LKVM</a></span><span>, </span><span class="c16"><a class="c71" href="https://chromium.googlesource.com/chromiumos/platform/crosvm/">crosvm</a></span><span>&nbsp;or </span><span class="c16"><a class="c71" href="https://github.com/firecracker-microvm/firecracker">Firecracker</a></span><span class="c8">&nbsp;have started to become popular. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">While KVM’s reliance on a separate user space component might seem complicated at first, it has a very nice benefit: Each VM running on a KVM host has a 1:1 mapping to a Linux process, making it managable using standard Linux tools. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">This means for example, that a guest's memory can be inspected by dumping the allocated memory of its user space process or that resource limits for CPU time and memory can be applied easily. Additionally, KVM can offload most work related to device emulation to the userspace component. Outside of a couple of performance-sensitive devices related to interrupt handling, all of the complex low-level code for providing virtual disk, network or GPU access can be implemented in userspace. &nbsp;</span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">When looking at public writeups of KVM-related vulnerabilities and exploits it becomes clear that this design was a wise decision. The large majority of disclosed vulnerabilities and all publicly available exploits affect QEMU and its support for emulated/paravirtualized devices. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">Even though KVM’s kernel attack surface is significantly smaller than the one exposed by a default QEMU configuration or similar user space VMMs, a KVM vulnerability has advantages that make it very valuable for an attacker: </span></p><ul style="padding: 0;" class="c12 lst-kix_vu6o8yw128np-0 start"><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">Whereas user space VMMs can be sandboxed to reduce the impact of a VM breakout, no such option is available for KVM itself. Once an attacker is able to achieve code execution (or similarly powerful primitives like write access to page tables) in the context of the host kernel, the system is fully compromised. </span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">Due to the somewhat poor security history of QEMU, new user space VMMs like crosvm or Firecracker are written in Rust, a memory safe language. Of course, there can still be non-memory safety vulnerabilities or problems due to incorrect or buggy usage of the KVM APIs, but using Rust effectively prevents the large majority of bugs that were discovered in C-based user space VMMs in the past. </span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">Finally, a pure KVM exploit can work against targets that use proprietary or heavily modified user space VMMs. While the big cloud providers do not go into much detail about their virtualization stacks publicly, it is safe to assume that they do not depend on an unmodified QEMU version for their production workloads. In contrast, KVM’s smaller code base makes heavy modifications unlikely (and KVM’s contributor list points at a strong tendency to upstream such modifications when they exist). &nbsp;</span></li></ul>
 <p class="c5 c9 c35"><span class="c8"></span></p>
 <p class="c5 c9 c35"><span class="c8"></span></p>
 <p class="c5 c13"><span>With these advantages in mind, I decided to spend some time hunting for a KVM vulnerability that could be turned into a guest-to-host escape. In the past, I had </span><span class="c16"><a class="c71" href="https://bugs.chromium.org/p/project-zero/issues/list?q=vmx%20owner%3Afwilhelm&amp;can=1">some success</a></span><span>&nbsp;with finding vulnerabilities in KVM’s support for nested virtualization on Intel CPUs so reviewing the same functionality for AMD seemed like a good starting point. This is even more true,</span><span>&nbsp;because the recent increase of AMD’s market share in the server segment means that KVM’s AMD implementation is suddenly becoming a more interesting target than it was in the last years.</span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span>Nested virtualization, the ability for a VM (called L1) to spawn nested guests (L2), was also a niche feature for a long time. However, due to hardware improvements that reduce its overhead and increasing customer demand it’s becoming more widely available. For example, Microsoft is heavily pushing for </span><span class="c16"><a class="c71" href="https://docs.microsoft.com/en-us/windows-hardware/design/device-experiences/oem-vbs">Virtualization-based Security</a></span><span>&nbsp;as part of newer Windows versions, requiring nested virtualization to support cloud-hosted Windows installations. KVM enables support for nested virtualization on both AMD</span><span>&nbsp;and</span><span class="c8">&nbsp;Intel by default, so if an administrator or the user space VMM does not explicitly disable it, it’s part of the attack surface for a malicious or compromised VM.</span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span>AMD’s virtualization extension is called SVM (for Secure Virtual Machine) and in order to support nested virtualization, the host hypervisor needs to intercept all SVM instructions that are executed by its guests, emulate their behavior and keep its state in sync with the underlying hardware. As you might imagine, implementing this correctly is quite difficult with a large potential for complex logic flaws, making it a perfect target for manual code review.</span></p>
 <p class="c5 c9"><span class="c8"></span></p><h2 class="c20 c13" id="h.edb97hffqtq9"><span class="c21">The Bug</span></h2>
 <p class="c5 c13"><span>Before diving into the KVM codebase and the bug I discovered, I want to quickly introduce how AMD SVM works to make the rest of the post easier to understand. (For a thorough documentation see </span><span class="c16"><a class="c71" href="https://www.amd.com/system/files/TechDocs/24593.pdf">AMD64 Architecture Programmer’s Manual, Volume 2: System Programming Chapter 15</a></span><span>.) SVM adds support for 6 new instructions to x86-64 if SVM support is enabled by setting the SVME bit in the EFER MSR. The most interesting of these instructions is </span><span class="c26">VMRUN</span><span>, which (as its name suggests) is responsible for running a guest VM. </span><span class="c26">VMRUN </span><span class="c8">takes an implicit parameter via the RAX register pointing to the page-aligned physical address of a data structure called “virtual machine control block” (VMCB), which describes the state and configuration of the VM. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span>The VMCB is split into two parts: First, the State Save area, which stores the values of all guest registers, including segment and control registers. Second, the Control area which describes the configuration of the VM. The Control area describes the virtualization features enabled for a VM, &nbsp;sets which VM actions are intercepted to trigger a VM exit </span><span>and</span><span>&nbsp;stores some fundamental configuration values such as the page table address used for </span><span class="c16"><a class="c71" href="https://en.wikipedia.org/wiki/Second_Level_Address_Translation">nested paging</a></span><span class="c8">. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">If the VMCB is correctly prepared (and we are not already running in a VM), VMRUN will first save the host state in a memory region called the host save area, whose address is configured by writing a physical address to the VM_HSAVE_PA MSR. Once the host state is saved, the CPU switches to the VM context and VMRUN only returns once a VM exit is triggered for one reason or another. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">An interesting aspect of SVM is that a lot of the state recovery after a VM exit has to be done by the hypervisor. Once a VM exit occurs, only RIP, RSP and RAX are restored to the previous host values and all other general purpose registers still contain the guest values. In addition, a full context switch requires manual execution of the VMSAVE/VMLOAD instructions which save/load additional system registers (FS, SS, LDTR, STAR, LSTAR …) from memory.</span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">For nested virtualization to work, KVM intercepts execution of the VMRUN instruction and creates its own VMCB based on the VMCB the L1 guest prepared (called vmcb12 in KVM terminology). Of course, KVM can’t trust the guest provided vmcb12 and needs to carefully validate all fields that end up in the real VMCB that gets passed to the hardware (known as vmcb02).</span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span>Most of the KVM’s code for nested virtualization on AMD is implemented in </span><span class="c16"><a class="c71" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/nested.c?h=v5.11">arch/x86/kvm/svm/nested.c</a></span><span>&nbsp;and the code that intercepts VMRUN instructions of nested guests is implemented in </span><span class="c15">nested_svm_vmrun</span><span class="c8">:</span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c9"><span class="c8"></span></p><a id="t.4603a0181df4522e440958d55a04b47d07a005d3"></a><a id="t.0"></a><table class="c30"><tbody><tr class="c19"><td class="c17" colspan="1" rowspan="1">
 <p class="c5"><span class="c0">int</span><span class="c3">&nbsp;nested_svm_vmrun</span><span class="c1">(</span><span class="c0">struct</span><span class="c3">&nbsp;vcpu_svm </span><span class="c1">*</span><span class="c3">svm</span><span class="c1">)</span></p>
 <p class="c5"><span class="c1">{</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">int</span><span class="c3">&nbsp;ret</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">struct</span><span class="c3">&nbsp;vmcb </span><span class="c1">*</span><span class="c3">vmcb12</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">struct</span><span class="c3">&nbsp;vmcb </span><span class="c1">*</span><span class="c3">hsave </span><span class="c1">=</span><span class="c3">&nbsp;svm</span><span class="c1">-&gt;</span><span class="c3">nested</span><span class="c1">.</span><span class="c3">hsave</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">struct</span><span class="c3">&nbsp;vmcb </span><span class="c1">*</span><span class="c3">vmcb </span><span class="c1">=</span><span class="c3">&nbsp;svm</span><span class="c1">-&gt;</span><span class="c3">vmcb</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">struct</span><span class="c3">&nbsp;kvm_host_map map</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; u64 vmcb12_gpa</span><span class="c1">;</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c2">&nbsp; &nbsp;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; vmcb12_gpa </span><span class="c1">=</span><span class="c3">&nbsp;svm</span><span class="c1">-&gt;</span><span class="c3">vmcb</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">rax</span><span class="c1">; </span><span class="c37 c18">** </span><span class="c15">1</span><span class="c18 c37">&nbsp;**</span><span class="c1">&nbsp;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; ret </span><span class="c1">=</span><span class="c3">&nbsp;kvm_vcpu_map</span><span class="c1">(&amp;</span><span class="c3">svm</span><span class="c1">-&gt;</span><span class="c3">vcpu</span><span class="c1">,</span><span class="c3">&nbsp;gpa_to_gfn</span><span class="c1">(</span><span class="c3">vmcb12_gpa</span><span class="c1">),</span><span class="c3">&nbsp;</span><span class="c1">&amp;</span><span class="c3">map</span><span class="c1">); </span><span class="c37 c18">** </span><span class="c15">2</span><span class="c37 c18">&nbsp;**</span></p>
 <p class="c5"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; … </span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; ret </span><span class="c1">=</span><span class="c3">&nbsp;kvm_skip_emulated_instruction</span><span class="c1">(&amp;</span><span class="c3">svm</span><span class="c1">-&gt;</span><span class="c3">vcpu</span><span class="c1">);</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; vmcb12 </span><span class="c1">=</span><span class="c3">&nbsp;map</span><span class="c1">.</span><span class="c3">hva</span><span class="c1">;</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">if</span><span class="c3">&nbsp;</span><span class="c1">(!</span><span class="c3">nested_vmcb_checks</span><span class="c1">(</span><span class="c3">svm</span><span class="c1">,</span><span class="c3">&nbsp;vmcb12</span><span class="c1">))</span><span class="c3">&nbsp;</span><span class="c1">{ ** </span><span class="c15">3</span><span class="c1">&nbsp;**</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vmcb12</span><span class="c1">-&gt;</span><span class="c3">control</span><span class="c1">.</span><span class="c3">exit_code &nbsp; &nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;SVM_EXIT_ERR</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vmcb12</span><span class="c1">-&gt;</span><span class="c3">control</span><span class="c1">.</span><span class="c3">exit_code_hi </span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c10">0</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vmcb12</span><span class="c1">-&gt;</span><span class="c3">control</span><span class="c1">.</span><span class="c3">exit_info_1 &nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c10">0</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vmcb12</span><span class="c1">-&gt;</span><span class="c3">control</span><span class="c1">.</span><span class="c3">exit_info_2 &nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c10">0</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">goto</span><span class="c3">&nbsp;</span><span class="c0">out</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c23">...</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c22">/*</span></p>
 <p class="c5"><span class="c22">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Save the old vmcb, so we don't need to pick what we save, but can</span></p>
 <p class="c5"><span class="c22">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* restore everything when a VMEXIT occurs</span></p>
 <p class="c5"><span class="c22">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">es &nbsp; &nbsp; </span><span class="c1">=</span><span class="c3">&nbsp;vmcb</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">es</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">cs &nbsp; &nbsp; </span><span class="c1">=</span><span class="c3">&nbsp;vmcb</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">cs</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">ss &nbsp; &nbsp; </span><span class="c1">=</span><span class="c3">&nbsp;vmcb</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">ss</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">ds &nbsp; &nbsp; </span><span class="c1">=</span><span class="c3">&nbsp;vmcb</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">ds</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">gdtr &nbsp; </span><span class="c1">=</span><span class="c3">&nbsp;vmcb</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">gdtr</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">idtr &nbsp; </span><span class="c1">=</span><span class="c3">&nbsp;vmcb</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">idtr</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">efer &nbsp; </span><span class="c1">=</span><span class="c3">&nbsp;svm</span><span class="c1">-&gt;</span><span class="c3">vcpu</span><span class="c1">.</span><span class="c3">arch</span><span class="c1">.</span><span class="c3">efer</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">cr0 &nbsp; &nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;kvm_read_cr0</span><span class="c1">(&amp;</span><span class="c3">svm</span><span class="c1">-&gt;</span><span class="c3">vcpu</span><span class="c1">);</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">cr4 &nbsp; &nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;svm</span><span class="c1">-&gt;</span><span class="c3">vcpu</span><span class="c1">.</span><span class="c3">arch</span><span class="c1">.</span><span class="c3">cr4</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">rflags </span><span class="c1">=</span><span class="c3">&nbsp;kvm_get_rflags</span><span class="c1">(&amp;</span><span class="c3">svm</span><span class="c1">-&gt;</span><span class="c3">vcpu</span><span class="c1">);</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">rip &nbsp; &nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;kvm_rip_read</span><span class="c1">(&amp;</span><span class="c3">svm</span><span class="c1">-&gt;</span><span class="c3">vcpu</span><span class="c1">);</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">rsp &nbsp; &nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;vmcb</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">rsp</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">rax &nbsp; &nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;vmcb</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">rax</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">npt_enabled</span><span class="c1">)</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">cr3 &nbsp; &nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;vmcb</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">cr3</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">else</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">cr3 &nbsp; &nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;kvm_read_cr3</span><span class="c1">(&amp;</span><span class="c3">svm</span><span class="c1">-&gt;</span><span class="c3">vcpu</span><span class="c1">);</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; copy_vmcb_control_area</span><span class="c1">(&amp;</span><span class="c3">hsave</span><span class="c1">-&gt;</span><span class="c3">control</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c1">&amp;</span><span class="c3">vmcb</span><span class="c1">-&gt;</span><span class="c3">control</span><span class="c1">);</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; svm</span><span class="c1">-&gt;</span><span class="c3">nested</span><span class="c1">.</span><span class="c3">nested_run_pending </span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c10">1</span><span class="c1">;</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">enter_svm_guest_mode</span><span class="c1">(</span><span class="c3">svm</span><span class="c1">,</span><span class="c3">&nbsp;vmcb12_gpa</span><span class="c1">,</span><span class="c3">&nbsp;vmcb12</span><span class="c1">)) ** </span><span class="c15">4</span><span class="c1">&nbsp;**</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">goto</span><span class="c3">&nbsp;out_exit_err</span><span class="c1">;</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">nested_svm_vmrun_msrpm</span><span class="c1">(</span><span class="c3">svm</span><span class="c1">))</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">goto</span><span class="c3">&nbsp;</span><span class="c0">out</span><span class="c1">;</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">out_exit_err</span><span class="c1">:</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; svm</span><span class="c1">-&gt;</span><span class="c3">nested</span><span class="c1">.</span><span class="c3">nested_run_pending </span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c10">0</span><span class="c1">;</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; svm</span><span class="c1">-&gt;</span><span class="c3">vmcb</span><span class="c1">-&gt;</span><span class="c3">control</span><span class="c1">.</span><span class="c3">exit_code &nbsp; &nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;SVM_EXIT_ERR</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; svm</span><span class="c1">-&gt;</span><span class="c3">vmcb</span><span class="c1">-&gt;</span><span class="c3">control</span><span class="c1">.</span><span class="c3">exit_code_hi </span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c10">0</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; svm</span><span class="c1">-&gt;</span><span class="c3">vmcb</span><span class="c1">-&gt;</span><span class="c3">control</span><span class="c1">.</span><span class="c3">exit_info_1 &nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c10">0</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; svm</span><span class="c1">-&gt;</span><span class="c3">vmcb</span><span class="c1">-&gt;</span><span class="c3">control</span><span class="c1">.</span><span class="c3">exit_info_2 &nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c10">0</span><span class="c1">;</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; nested_svm_vmexit</span><span class="c1">(</span><span class="c3">svm</span><span class="c1">);</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c0">out</span><span class="c1">:</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; kvm_vcpu_unmap</span><span class="c1">(&amp;</span><span class="c3">svm</span><span class="c1">-&gt;</span><span class="c3">vcpu</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c1">&amp;</span><span class="c3">map</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c0">true</span><span class="c1">);</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">return</span><span class="c3">&nbsp;ret</span><span class="c1">;</span></p>
 <p class="c5"><span class="c1">}</span></p></td></tr><tr class="c28"><td class="c17" colspan="1" rowspan="1">
 <p class="c5 c11"><span class="c0 c25"></span></p></td></tr></tbody></table>
 <p class="c5 c9"><span class="c25 c6 c29"></span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span>The function first fetches the value of RAX out of the currently active vmcb (</span><span class="c15">svm-&gt;vcmb</span><span>) in </span><span class="c15">1 </span><span>(numbers are marked in the code samples)</span><span>. For guests using nested paging (which is the only relevant configuration nowadays) RAX contains a guest physical address (GPA), which needs to be translated into a host physical address (HPA) first. </span><span class="c15">kvm_vcpu_map</span><span>&nbsp;(</span><span class="c15">2</span><span class="c8">) takes care of this translation and maps the underlying page to a host virtual address (HVA) that can be directly accessed by KVM. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span>Once the VMCB is mapped, </span><span class="c15">nested_vmcb_checks</span><span>&nbsp;is called for some basic validation in </span><span class="c15">3</span><span>. Afterwards, the L1 guest context which is stored in </span><span class="c15">svm-&gt;vmcb</span><span>&nbsp;is copied into the host save area </span><span class="c15">svm-&gt;nested.hsave</span><span>&nbsp;before KVM enters the nested guest context by calling </span><span class="c15">enter_svm_guest_mode</span><span>&nbsp;(</span><span class="c15">4</span><span>)</span><span class="c27 c25">.</span></p>
 <p class="c5 c9"><span class="c25 c27"></span></p><a id="t.f82e68744812c72d77d4c5e87e16205bdffc71d6"></a><a id="t.1"></a><table class="c30"><tbody><tr class="c28"><td class="c17" colspan="1" rowspan="1">
 <p class="c5"><span class="c0">int</span><span class="c3">&nbsp;enter_svm_guest_mode</span><span class="c1">(</span><span class="c0">struct</span><span class="c3">&nbsp;vcpu_svm </span><span class="c1">*</span><span class="c3">svm</span><span class="c1">,</span><span class="c3">&nbsp;u64 vmcb12_gpa</span><span class="c1">,</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c0">struct</span><span class="c3">&nbsp;vmcb </span><span class="c1">*</span><span class="c3">vmcb12</span><span class="c1">)</span></p>
 <p class="c5"><span class="c1">{</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">int</span><span class="c3">&nbsp;ret</span><span class="c1">;</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; svm</span><span class="c1">-&gt;</span><span class="c3">nested</span><span class="c1">.</span><span class="c3">vmcb12_gpa </span><span class="c1">=</span><span class="c3">&nbsp;vmcb12_gpa</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; load_nested_vmcb_control</span><span class="c1">(</span><span class="c3">svm</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c1">&amp;</span><span class="c3">vmcb12</span><span class="c1">-&gt;</span><span class="c3">control</span><span class="c1">);</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; nested_prepare_vmcb_save</span><span class="c1">(</span><span class="c3">svm</span><span class="c1">,</span><span class="c3">&nbsp;vmcb12</span><span class="c1">);</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; nested_prepare_vmcb_control</span><span class="c1">(</span><span class="c3">svm</span><span class="c1">);</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; ret </span><span class="c1">=</span><span class="c3">&nbsp;nested_svm_load_cr3</span><span class="c1">(&amp;</span><span class="c3">svm</span><span class="c1">-&gt;</span><span class="c3">vcpu</span><span class="c1">,</span><span class="c3">&nbsp;vmcb12</span><span class="c1">-&gt;</span><span class="c3">save</span><span class="c1">.</span><span class="c3">cr3</span><span class="c1">,</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nested_npt_enabled</span><span class="c1">(</span><span class="c3">svm</span><span class="c1">));</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">ret</span><span class="c1">)</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">return</span><span class="c3">&nbsp;ret</span><span class="c1">;</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; svm_set_gif</span><span class="c1">(</span><span class="c3">svm</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c0">true</span><span class="c1">);</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">return</span><span class="c3">&nbsp;</span><span class="c10">0</span><span class="c1">;</span></p>
 <p class="c5"><span class="c1">}</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c0">static</span><span class="c3">&nbsp;</span><span class="c0">void</span><span class="c3">&nbsp;load_nested_vmcb_control</span><span class="c1">(</span><span class="c0">struct</span><span class="c3">&nbsp;vcpu_svm </span><span class="c1">*</span><span class="c3">svm</span><span class="c1">,</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c0">struct</span><span class="c3">&nbsp;vmcb_control_area </span><span class="c1">*</span><span class="c3">control</span><span class="c1">)</span></p>
 <p class="c5"><span class="c1">{</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; copy_vmcb_control_area</span><span class="c1">(&amp;</span><span class="c3">svm</span><span class="c1">-&gt;</span><span class="c3">nested</span><span class="c1">.</span><span class="c3">ctl</span><span class="c1">,</span><span class="c3">&nbsp;control</span><span class="c1">);</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">...</span></p>
 <p class="c5"><span class="c1">}</span></p>
 <p class="c5 c11"><span class="c2"></span></p></td></tr></tbody></table>
 <p class="c5 c9"><span class="c27 c25"></span></p>
 <p class="c5 c13"><span>Looking at </span><span class="c15">enter_svm_guest_mode</span><span class="c8">&nbsp;we can see that KVM copies the vmcb12 control area directly into svm-&gt;nested.ctl and does not perform any further checks on the copied value.</span></p>
 <p class="c5 c13"><span>Readers familiar with double fetch or Time-of-Check-to-Time-of-Use vulnerabilities might already see a potential issue here: The call to </span><span class="c15">nested_vmcb_checks</span><span>&nbsp;at the beginning of </span><span class="c15">nested_svm_vmrun</span><span>&nbsp;performs all of its checks on a copy of the VMCB that is stored in guest memory. This means that a guest with multiple CPU cores can modify fields in the VMCB after they are verified in </span><span class="c15">nested_vmcb_checks</span><span>, but before they are copied to svm-&gt;nested.ctl in </span><span class="c15">load_nested_vmcb_control</span><span class="c8">. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span>Let’s look at </span><span class="c15">nested_vmcb_checks </span><span class="c8">to see what kind of checks we can bypass with this approach: </span></p><a id="t.cbcfaf5d1ce5a2e639eabbdd57ddd415d5776511"></a><a id="t.2"></a><table class="c30"><tbody><tr class="c28"><td class="c17" colspan="1" rowspan="1">
 <p class="c5"><span class="c0">static</span><span class="c3">&nbsp;</span><span class="c0">bool</span><span class="c3">&nbsp;nested_vmcb_check_controls</span><span class="c1">(</span><span class="c0">struct</span><span class="c3">&nbsp;vmcb_control_area </span><span class="c1">*</span><span class="c3">control</span><span class="c1">)</span></p>
 <p class="c5"><span class="c1">{</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">if</span><span class="c3">&nbsp;</span><span class="c1">((</span><span class="c3">vmcb_is_intercept</span><span class="c1">(</span><span class="c3">control</span><span class="c1">,</span><span class="c3">&nbsp;INTERCEPT_VMRUN</span><span class="c1">))</span><span class="c3">&nbsp;</span><span class="c1">==</span><span class="c3">&nbsp;</span><span class="c10">0</span><span class="c1">)</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">return</span><span class="c3">&nbsp;</span><span class="c0">false</span><span class="c1">;</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">control</span><span class="c1">-&gt;</span><span class="c3">asid </span><span class="c1">==</span><span class="c3">&nbsp;</span><span class="c10">0</span><span class="c1">)</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">return</span><span class="c3">&nbsp;</span><span class="c0">false</span><span class="c1">;</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">if</span><span class="c3">&nbsp;</span><span class="c1">((</span><span class="c3">control</span><span class="c1">-&gt;</span><span class="c3">nested_ctl </span><span class="c1">&amp;</span><span class="c3">&nbsp;SVM_NESTED_CTL_NP_ENABLE</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">&amp;&amp;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">!</span><span class="c3">npt_enabled</span><span class="c1">)</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">return</span><span class="c3">&nbsp;</span><span class="c0">false</span><span class="c1">;</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">return</span><span class="c3">&nbsp;</span><span class="c0">true</span><span class="c1">;</span></p>
 <p class="c5"><span class="c1">}</span></p></td></tr></tbody></table>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span>At first glance this looks pretty harmless. </span><span class="c15">control-&gt;asid</span><span class="c8">&nbsp;isn’t used anywhere and the last check is only relevant for systems where nested paging isn’t supported. However, the first check turns out to be very interesting. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span>For reasons unknown to me, SVM VMCBs contain a bit that enables or disables interception of the VMRUN instruction when executed inside a guest. Clearing this bit isn’t actually supported by hardware and results in an immediate VMEXIT, so the check in </span><span class="c15">nested_vmcb_check_controls</span><span class="c8">&nbsp;simply replicates this behavior. &nbsp;When we race and bypass the check by repeatedly flipping the value of the INTERCEPT_VMRUN bit, we can end up in a situation where svm-&gt;nested.ctl contains a 0 in place of the INTERCEPT_VMRUN bit. To understand the impact we first need to see how nested vmexit’s are handled in KVM: </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span>The main SVM exit handler is the function </span><span class="c15">handle_exit</span><span>&nbsp;in </span><span class="c16"><a class="c71" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/svm.c?h=v5.11">arch/x86/kvm/svm.c</a></span><span>, which is called whenever a VMexit occurs. When KVM is running a nested guest, it first has to check if the exit should be handled by itself or the L1 hypervisor. To do this it calls the function </span><span class="c15">nested_svm_exit_handled</span><span>&nbsp;(</span><span class="c15">5</span><span>) whi</span><span>ch will return </span><span class="c6">NESTED_EXIT_DONE if the vmexit will be handled by the L1 hypervisor and no further processing by the L0 hypervisor is needed</span><span>:</span></p>
 <p class="c5 c9"><span class="c8"></span></p><a id="t.dbf1a4595680d452b12d73cacee8ee680ca43081"></a><a id="t.3"></a><table class="c30"><tbody><tr class="c28"><td class="c17" colspan="1" rowspan="1">
 <p class="c5"><span class="c3">&nbsp;</span><span class="c0">static</span><span class="c3">&nbsp;</span><span class="c0">int</span><span class="c3">&nbsp;handle_exit</span><span class="c1">(</span><span class="c0">struct</span><span class="c3">&nbsp;kvm_vcpu </span><span class="c1">*</span><span class="c3">vcpu</span><span class="c1">,</span><span class="c3">&nbsp;fastpath_t exit_fastpath</span><span class="c1">)</span></p>
 <p class="c5"><span class="c1">{</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">struct</span><span class="c3">&nbsp;vcpu_svm </span><span class="c1">*</span><span class="c3">svm </span><span class="c1">=</span><span class="c3">&nbsp;to_svm</span><span class="c1">(</span><span class="c3">vcpu</span><span class="c1">);</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">struct</span><span class="c3">&nbsp;kvm_run </span><span class="c1">*</span><span class="c3">kvm_run </span><span class="c1">=</span><span class="c3">&nbsp;vcpu</span><span class="c1">-&gt;</span><span class="c3">run</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; u32 exit_code </span><span class="c1">=</span><span class="c3">&nbsp;svm</span><span class="c1">-&gt;</span><span class="c3">vmcb</span><span class="c1">-&gt;</span><span class="c3">control</span><span class="c1">.</span><span class="c3">exit_code</span><span class="c1">;</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">…</span><span class="c2">&nbsp;</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">is_guest_mode</span><span class="c1">(</span><span class="c3">vcpu</span><span class="c1">))</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">int</span><span class="c3">&nbsp;vmexit</span><span class="c1">;</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trace_kvm_nested_vmexit</span><span class="c1">(</span><span class="c3">exit_code</span><span class="c1">,</span><span class="c3">&nbsp;vcpu</span><span class="c1">,</span><span class="c3">&nbsp;KVM_ISA_SVM</span><span class="c1">);</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vmexit </span><span class="c1">=</span><span class="c3">&nbsp;nested_svm_exit_special</span><span class="c1">(</span><span class="c3">svm</span><span class="c1">);</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">vmexit </span><span class="c1">==</span><span class="c3">&nbsp;NESTED_EXIT_CONTINUE</span><span class="c1">)</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vmexit </span><span class="c1">=</span><span class="c3">&nbsp;nested_svm_exit_handled</span><span class="c1">(</span><span class="c3">svm</span><span class="c1">);</span><span class="c3">&nbsp;</span><span class="c1">**</span><span class="c3">&nbsp;</span><span class="c10">5</span><span class="c3">&nbsp;</span><span class="c1">**</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">vmexit </span><span class="c1">==</span><span class="c3">&nbsp;NESTED_EXIT_DONE</span><span class="c1">)</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">return</span><span class="c3">&nbsp;</span><span class="c10">1</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c5"><span class="c1">}</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c0">static</span><span class="c3">&nbsp;</span><span class="c0">int</span><span class="c3">&nbsp;nested_svm_intercept</span><span class="c1">(</span><span class="c0">struct</span><span class="c3">&nbsp;vcpu_svm </span><span class="c1">*</span><span class="c3">svm</span><span class="c1">)</span></p>
 <p class="c5"><span class="c1">{</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; // exit_code</span><span class="c23">==INTERCEPT_VMRUN when the L2 guest executes vmrun</span></p>
 <p class="c5"><span class="c23">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c3">u32 exit_code </span><span class="c1">=</span><span class="c3">&nbsp;svm</span><span class="c1">-&gt;</span><span class="c3">vmcb</span><span class="c1">-&gt;</span><span class="c3">control</span><span class="c1">.</span><span class="c3">exit_code</span><span class="c1">; </span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">int</span><span class="c3">&nbsp;vmexit </span><span class="c1">=</span><span class="c3">&nbsp;NESTED_EXIT_HOST</span><span class="c1">;</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">switch</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">exit_code</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">case</span><span class="c3">&nbsp;SVM_EXIT_MSR</span><span class="c1">:</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vmexit </span><span class="c1">=</span><span class="c3">&nbsp;nested_svm_exit_handled_msr</span><span class="c1">(</span><span class="c3">svm</span><span class="c1">);</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">break</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">case</span><span class="c3">&nbsp;SVM_EXIT_IOIO</span><span class="c1">:</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vmexit </span><span class="c1">=</span><span class="c3">&nbsp;nested_svm_intercept_ioio</span><span class="c1">(</span><span class="c3">svm</span><span class="c1">);</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">break</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">…</span><span class="c2">&nbsp;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">default</span><span class="c1">:</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">vmcb_is_intercept</span><span class="c1">(&amp;</span><span class="c3">svm</span><span class="c1">-&gt;</span><span class="c3">nested</span><span class="c1">.</span><span class="c3">ctl</span><span class="c1">,</span><span class="c3">&nbsp;exit_code</span><span class="c1">))</span><span class="c3">&nbsp;</span><span class="c1">**</span><span class="c3">&nbsp;</span><span class="c10">7</span><span class="c3">&nbsp;</span><span class="c1">**</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vmexit </span><span class="c1">=</span><span class="c3">&nbsp;NESTED_EXIT_DONE</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">return</span><span class="c3">&nbsp;vmexit</span><span class="c1">;</span></p>
 <p class="c5"><span class="c1">}</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c0">int</span><span class="c3">&nbsp;nested_svm_exit_handled</span><span class="c1">(</span><span class="c0">struct</span><span class="c3">&nbsp;vcpu_svm </span><span class="c1">*</span><span class="c3">svm</span><span class="c1">)</span></p>
 <p class="c5"><span class="c1">{</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">int</span><span class="c3">&nbsp;vmexit</span><span class="c1">;</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; vmexit </span><span class="c1">=</span><span class="c3">&nbsp;nested_svm_intercept</span><span class="c1">(</span><span class="c3">svm</span><span class="c1">);</span><span class="c3">&nbsp;</span><span class="c1">**</span><span class="c3">&nbsp;</span><span class="c10">6</span><span class="c3">&nbsp;</span><span class="c1">**</span><span class="c3">&nbsp;</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">vmexit </span><span class="c1">==</span><span class="c3">&nbsp;NESTED_EXIT_DONE</span><span class="c1">)</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nested_svm_vmexit</span><span class="c1">(</span><span class="c3">svm</span><span class="c1">);</span><span class="c3">&nbsp;</span><span class="c1">**</span><span class="c3">&nbsp;</span><span class="c10">8</span><span class="c3">&nbsp;</span><span class="c1">**</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">return</span><span class="c3">&nbsp;vmexit</span><span class="c1">;</span></p>
 <p class="c5"><span class="c1">}</span></p></td></tr></tbody></table>
 <p class="c5 c9"><span class="c29 c25 c6"></span></p>
 <p class="c5 c9"><span class="c29 c25 c6"></span></p>
 <p class="c5 c13"><span class="c15 c6">nested_svm_exit_handled</span><span class="c6">&nbsp;first calls </span><span class="c15 c6">nested_svm_intercept (6)</span><span class="c6">&nbsp;to see if the exit should be handled. When we trigger an exit by executing VMRUN in a L2 guest, the default case is executed (</span><span class="c15 c6">7</span><span class="c6">) </span><span class="c6">to see if the INTERCEPT_VMRUN bit in svm-&gt;nested.ctl is set. </span><span class="c6">Normally, this should always be the case and the function returns NESTED_EXIT_DONE to trigger a nested VM exit from L2 to L1 and to let the L1 hypervisor handle the exit (</span><span class="c15 c6">8</span><span class="c8 c6">). (This way KVM supports infinite nesting of hypervisors).</span></p>
 <p class="c5 c9"><span class="c8 c6"></span></p>
 <p class="c5 c13"><span class="c6">However, if the L1 guest exploited the race condition described above svm-&gt;nested.ctl won’t have the INTERCEPT_VMRUN bit set and the VM exit will be handled by KVM itself. This results in a second call to </span><span class="c15 c6">nested_svm_vmrun</span><span class="c6">&nbsp;while still running inside the L2 guest context. </span><span class="c15 c6">nested_svm_vmrun</span><span class="c6">&nbsp;isn’t written to handle this situation and will blindly overwrite the L1 context stored in </span><span class="c15 c6">svm-&gt;nested.hsave</span><span class="c6">&nbsp;with data from the currently active </span><span class="c15 c6">svm-&gt;vmcb</span><span class="c8 c6">&nbsp;which contains data for the L2 guest:</span></p>
 <p class="c5 c9"><span class="c25 c6 c38"></span></p><a id="t.a93b45d970c173b162741ed3aef6ddfd79d4b4d0"></a><a id="t.4"></a><table class="c30"><tbody><tr class="c28"><td class="c17" colspan="1" rowspan="1">
 <p class="c5"><span class="c3 c6">&nbsp;&nbsp; &nbsp; </span><span class="c6 c22">/*</span></p>
 <p class="c5"><span class="c22 c6">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Save the old vmcb, so we don't need to pick what we save, but can</span></p>
 <p class="c5"><span class="c22 c6">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* restore everything when a VMEXIT occurs</span></p>
 <p class="c5"><span class="c22 c6">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</span></p>
 <p class="c5"><span class="c3 c6">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">es &nbsp; &nbsp; </span><span class="c1 c6">=</span><span class="c3 c6">&nbsp;vmcb</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">es</span><span class="c1 c6">;</span></p>
 <p class="c5"><span class="c3 c6">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">cs &nbsp; &nbsp; </span><span class="c1 c6">=</span><span class="c3 c6">&nbsp;vmcb</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">cs</span><span class="c1 c6">;</span></p>
 <p class="c5"><span class="c3 c6">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">ss &nbsp; &nbsp; </span><span class="c1 c6">=</span><span class="c3 c6">&nbsp;vmcb</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">ss</span><span class="c1 c6">;</span></p>
 <p class="c5"><span class="c3 c6">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">ds &nbsp; &nbsp; </span><span class="c1 c6">=</span><span class="c3 c6">&nbsp;vmcb</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">ds</span><span class="c1 c6">;</span></p>
 <p class="c5"><span class="c3 c6">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">gdtr &nbsp; </span><span class="c1 c6">=</span><span class="c3 c6">&nbsp;vmcb</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">gdtr</span><span class="c1 c6">;</span></p>
 <p class="c5"><span class="c3 c6">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">idtr &nbsp; </span><span class="c1 c6">=</span><span class="c3 c6">&nbsp;vmcb</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">idtr</span><span class="c1 c6">;</span></p>
 <p class="c5"><span class="c3 c6">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">efer &nbsp; </span><span class="c1 c6">=</span><span class="c3 c6">&nbsp;svm</span><span class="c1 c6">-&gt;</span><span class="c3 c6">vcpu</span><span class="c1 c6">.</span><span class="c3 c6">arch</span><span class="c1 c6">.</span><span class="c3 c6">efer</span><span class="c1 c6">;</span></p>
 <p class="c5"><span class="c3 c6">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">cr0 &nbsp; &nbsp;</span><span class="c1 c6">=</span><span class="c3 c6">&nbsp;kvm_read_cr0</span><span class="c1 c6">(&amp;</span><span class="c3 c6">svm</span><span class="c1 c6">-&gt;</span><span class="c3 c6">vcpu</span><span class="c1 c6">);</span></p>
 <p class="c5"><span class="c3 c6">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">cr4 &nbsp; &nbsp;</span><span class="c1 c6">=</span><span class="c3 c6">&nbsp;svm</span><span class="c1 c6">-&gt;</span><span class="c3 c6">vcpu</span><span class="c1 c6">.</span><span class="c3 c6">arch</span><span class="c1 c6">.</span><span class="c3 c6">cr4</span><span class="c1 c6">;</span></p>
 <p class="c5"><span class="c3 c6">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">rflags </span><span class="c1 c6">=</span><span class="c3 c6">&nbsp;kvm_get_rflags</span><span class="c1 c6">(&amp;</span><span class="c3 c6">svm</span><span class="c1 c6">-&gt;</span><span class="c3 c6">vcpu</span><span class="c1 c6">);</span></p>
 <p class="c5"><span class="c3 c6">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">rip &nbsp; &nbsp;</span><span class="c1 c6">=</span><span class="c3 c6">&nbsp;kvm_rip_read</span><span class="c1 c6">(&amp;</span><span class="c3 c6">svm</span><span class="c1 c6">-&gt;</span><span class="c3 c6">vcpu</span><span class="c1 c6">);</span></p>
 <p class="c5"><span class="c3 c6">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">rsp &nbsp; &nbsp;</span><span class="c1 c6">=</span><span class="c3 c6">&nbsp;vmcb</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">rsp</span><span class="c1 c6">;</span></p>
 <p class="c5"><span class="c3 c6">&nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">rax &nbsp; &nbsp;</span><span class="c1 c6">=</span><span class="c3 c6">&nbsp;vmcb</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">rax</span><span class="c1 c6">;</span></p>
 <p class="c5"><span class="c3 c6">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0 c6">if</span><span class="c3 c6">&nbsp;</span><span class="c1 c6">(</span><span class="c3 c6">npt_enabled</span><span class="c1 c6">)</span></p>
 <p class="c5"><span class="c3 c6">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">cr3 &nbsp; &nbsp;</span><span class="c1 c6">=</span><span class="c3 c6">&nbsp;vmcb</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">cr3</span><span class="c1 c6">;</span></p>
 <p class="c5"><span class="c3 c6">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0 c6">else</span></p>
 <p class="c5"><span class="c3 c6">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hsave</span><span class="c1 c6">-&gt;</span><span class="c3 c6">save</span><span class="c1 c6">.</span><span class="c3 c6">cr3 &nbsp; &nbsp;</span><span class="c1 c6">=</span><span class="c3 c6">&nbsp;kvm_read_cr3</span><span class="c1 c6">(&amp;</span><span class="c3 c6">svm</span><span class="c1 c6">-&gt;</span><span class="c3 c6">vcpu</span><span class="c1 c6">);</span></p>
 <p class="c5 c11"><span class="c2 c6"></span></p>
 <p class="c5"><span class="c3 c6">&nbsp; &nbsp; &nbsp; &nbsp; copy_vmcb_control_area</span><span class="c1 c6">(&amp;</span><span class="c3 c6">hsave</span><span class="c1 c6">-&gt;</span><span class="c3 c6">control</span><span class="c1 c6">,</span><span class="c3 c6">&nbsp;</span><span class="c1 c6">&amp;</span><span class="c3 c6">vmcb</span><span class="c1 c6">-&gt;</span><span class="c3 c6">control</span><span class="c1 c6">);</span></p></td></tr></tbody></table>
 <p class="c5 c11"><span class="c1 c25"></span></p>
 <p class="c5 c13"><span class="c8">This becomes a security issue due to the way Model Specific Register (MSR) intercepts are handled for nested guests: </span></p>
 <p class="c5 c13"><span class="c8">SVM uses a permission bitmap to control which MSRs can be accessed by a VM. The bitmap is a 8KB data structure with two bits per MSR, one of which controls read access and the other write access. A 1 bit in this position means the access is intercepted and triggers a vm exit, a 0 bit means the VM has direct access to the MSR. The HPA address of the bitmap is stored in the VMCB control area and for normal L1 KVM guests, the pages are allocated and pinned into memory as soon as a vCPU is created. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span>For a nested guest, the MSR permission bitmap is stored in </span><span class="c15">svm-&gt;nested.msrpm</span><span>&nbsp;and its physical address is copied into the active VMCB (in </span><span class="c15">svm-&gt;vmcb-&gt;control.msrpm_base_pa</span><span>) while the nested guest is running. Using the described double invocation of </span><span class="c15">nested_svm_vmrun</span><span>, a malicious guest can copy this value into the </span><span class="c15">svm-&gt;nested.hsave</span><span>&nbsp;VMCB when </span><span class="c15">copy_vmcb_control_area</span><span>&nbsp;is executed. This is interesting because the KVM’s hsave area normally only contains data from the L1 guest context so </span><span class="c15">svm-&gt;nested.hsave.msrpm_base_pa</span><span class="c8">&nbsp;would normally point to the pinned vCPU-specific MSR bitmap pages. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">This edge case becomes exploitable thanks to a relatively recent change in KVM:</span></p>
 <p class="c5 c13"><span>Since commit “</span><span class="c16"><a class="c71" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit?h=v5.11&amp;id=2fcf4876ada8a293d3b92a1033b8b990a7c613d3">2fcf4876: KVM: nSVM: implement on demand allocation of the nested state</a></span><span class="c8">” from last October, svm-&gt;nested.msrpm is dynamically allocated and freed when a guest changes the SVME bit of the MSR_EFER register:</span></p><a id="t.efa5f977707b49310504dc9b5788dd5552d59d85"></a><a id="t.5"></a><table class="c30"><tbody><tr class="c28"><td class="c17" colspan="1" rowspan="1">
 <p class="c5"><span class="c0">int</span><span class="c3">&nbsp;svm_set_efer</span><span class="c1">(</span><span class="c0">struct</span><span class="c3">&nbsp;kvm_vcpu </span><span class="c1">*</span><span class="c3">vcpu</span><span class="c1">,</span><span class="c3">&nbsp;u64 efer</span><span class="c1">)</span></p>
 <p class="c5"><span class="c1">{</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">struct</span><span class="c3">&nbsp;vcpu_svm </span><span class="c1">*</span><span class="c3">svm </span><span class="c1">=</span><span class="c3">&nbsp;to_svm</span><span class="c1">(</span><span class="c3">vcpu</span><span class="c1">);</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; u64 old_efer </span><span class="c1">=</span><span class="c3">&nbsp;vcpu</span><span class="c1">-&gt;</span><span class="c3">arch</span><span class="c1">.</span><span class="c3">efer</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; vcpu</span><span class="c1">-&gt;</span><span class="c3">arch</span><span class="c1">.</span><span class="c3">efer </span><span class="c1">=</span><span class="c3">&nbsp;efer</span><span class="c1">;</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">if</span><span class="c3">&nbsp;</span><span class="c1">((</span><span class="c3">old_efer </span><span class="c1">&amp;</span><span class="c3">&nbsp;EFER_SVME</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">!=</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">efer </span><span class="c1">&amp;</span><span class="c3">&nbsp;EFER_SVME</span><span class="c1">))</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">if</span><span class="c3">&nbsp;</span><span class="c1">(!(</span><span class="c3">efer </span><span class="c1">&amp;</span><span class="c3">&nbsp;EFER_SVME</span><span class="c1">))</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; svm_leave_nested</span><span class="c1">(</span><span class="c3">svm</span><span class="c1">);</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; svm_set_gif</span><span class="c1">(</span><span class="c3">svm</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c0">true</span><span class="c1">);</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">...</span><span class="c3">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c22">/*</span></p>
 <p class="c5"><span class="c22">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Free the nested guest state, unless we are in SMM.</span></p>
 <p class="c5"><span class="c22">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* In this case we will return to the nested guest</span></p>
 <p class="c5"><span class="c22">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* as soon as we leave SMM.</span></p>
 <p class="c5"><span class="c22">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">if</span><span class="c3">&nbsp;</span><span class="c1">(!</span><span class="c3">is_smm</span><span class="c1">(&amp;</span><span class="c3">svm</span><span class="c1">-&gt;</span><span class="c3">vcpu</span><span class="c1">))</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; svm_free_nested</span><span class="c1">(</span><span class="c3">svm</span><span class="c1">);</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">}</span><span class="c3">&nbsp;</span><span class="c1">...</span></p>
 <p class="c5"><span class="c1">}</span></p>
 <p class="c5"><span class="c1">}</span></p></td></tr></tbody></table>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span>For the “disable SVME” case, KVM will first call </span><span class="c15">svm_leave_nested</span><span class="c8">&nbsp;to forcibly leave potential</span></p>
 <p class="c5 c13"><span>nested guests and then free the </span><span class="c15">svm-&gt;nested</span><span>&nbsp;data structures (including the backing pages for the MSR permission bitmap) in </span><span class="c15">svm_free_nested</span><span>. As </span><span class="c15">svm_leave_nested</span><span>&nbsp;believes that </span><span class="c15">svm-&gt;nested.hsave</span><span class="c8">&nbsp;contains the saved context of the L1 guest, it simply copies its control area to the real VMCB:</span></p><a id="t.0a10403251049de5c610583af2a5a4988152b9bf"></a><a id="t.6"></a><table class="c30"><tbody><tr class="c28"><td class="c17" colspan="1" rowspan="1">
 <p class="c5"><span class="c0">void</span><span class="c3">&nbsp;svm_leave_nested</span><span class="c1">(</span><span class="c0">struct</span><span class="c3">&nbsp;vcpu_svm </span><span class="c1">*</span><span class="c3">svm</span><span class="c1">)</span></p>
 <p class="c5"><span class="c1">{</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">is_guest_mode</span><span class="c1">(&amp;</span><span class="c3">svm</span><span class="c1">-&gt;</span><span class="c3">vcpu</span><span class="c1">))</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">struct</span><span class="c3">&nbsp;vmcb </span><span class="c1">*</span><span class="c3">hsave </span><span class="c1">=</span><span class="c3">&nbsp;svm</span><span class="c1">-&gt;</span><span class="c3">nested</span><span class="c1">.</span><span class="c3">hsave</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">struct</span><span class="c3">&nbsp;vmcb </span><span class="c1">*</span><span class="c3">vmcb </span><span class="c1">=</span><span class="c3">&nbsp;svm</span><span class="c1">-&gt;</span><span class="c3">vmcb</span><span class="c1">;</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">...</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; copy_vmcb_control_area</span><span class="c1">(&amp;</span><span class="c3">vmcb</span><span class="c1">-&gt;</span><span class="c3">control</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c1">&amp;</span><span class="c3">hsave</span><span class="c1">-&gt;</span><span class="c3">control</span><span class="c1">);</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">...</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c5"><span class="c1">}</span></p></td></tr></tbody></table>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span>But as mentioned before, </span><span class="c15">svm-&gt;nested.hsave-&gt;control.msrpm_base_pa</span><span class="c8">&nbsp;can still point to</span></p>
 <p class="c5 c13"><span class="c15">svm-&gt;nested-&gt;msrpm</span><span>. Once </span><span class="c15">svm_free_nested</span><span class="c8">&nbsp;is finished and KVM passes control back to the guest, the CPU will use the freed pages for its MSR permission checks. This gives a guest unrestricted access to host MSRs if the pages are reused and partially overwritten with zeros.</span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">To summarize, a malicious guest can gain access to host MSRs using the following approach:</span></p><ol class="c12 lst-kix_44h6gatzfsnw-0 start" start="1"><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">Enable the SVME bit in MSR_EFER to enable nested virtualization</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">Repeatedly try to launch a L2 guest using the VMRUN instruction while flipping the INTERCEPT_VMRUN bit on a second CPU core. </span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>If VMRUN succeeds, try to launch a “L3” guest using another invocation of VMRUN. If this fails, we have lost the race in step 2 and must try again. If VMRUN succeeds we have successfully overwritten </span><span class="c15">svm-&gt;nested.hsave</span><span class="c8">&nbsp;with our L2 context. &nbsp;</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">Clear the SVME bit in MSR_EFER while still running in the “L3” context. This frees the MSR permission bitmap backing pages used by the L2 guest who is now executing again. </span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">Wait until the KVM host reuses the backing pages. This will potentially clear all or some of the bits, giving the guest access to host MSRs.</span></li></ol>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span>When I initially discovered and reported this vulnerability, I was feeling pretty confident that this type of MSR access should be more or less equivalent to full code execution on the host. While my feeling turned out to be correct, getting there still took me multiple weeks of exploit development. In the next section I’ll describe the steps to turn this primitive into a guest-to-host escape.</span></p>
 <p class="c5 c9"><span class="c8"></span></p><h2 class="c13 c20" id="h.j9bji8tg793n"><span>The Exploit</span></h2>
 <p class="c5 c13"><span>Assuming our guest can get full unrestricted access to any MSR (which is only a question of timing thanks to init_on_alloc=1 being the default for most modern distributions), how can we escalate this into running arbitrary code in the context of the KVM host? To answer this question we first need to look at what kind of MSRs are supported on a modern AMD system. Looking at the </span><span class="c16"><a class="c71" href="https://www.amd.com/system/files/TechDocs/52740_16h_Models_30h-3Fh_BKDG.pdf">BIOS and Kernel Developer’s Guide</a></span><span class="c8">&nbsp;for recent AMD processors we can find a wide range of MSRs starting with well known and widely used ones such as EFER (the Extended Feature Enable Register) or LSTAR (the syscall target address) to rarely used ones like SMI_ON_IO_TRAP (can be used to generate a System Management Mode Interrupt when specific IO port ranges are accessed). </span></p>
 <p class="c5 c13"><span>Looking at the list, several registers like LSTAR or KERNEL_GSBASE seem like interesting targets for redirecting the execution of the host kernel. Unrestricted access to these registers is actually </span><span>enabled by default</span><span class="c8">, however they are automatically restored to a valid state by KVM after a vmexit so modifying them does not lead to any changes in host behavior. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">Still, there is one MSR that we previously mentioned and that seems to give us a straightforward way to achieve code execution: The VM_HSAVE_PA that stores the physical address of the host save area, which is used to restore the host context when a vmexit occurs. If we can point this MSR at a memory location under our control we should be able to fake a malicious host context and execute our own code after a vmexit.</span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">While this sounds pretty straightforward in theory, implementing it still has some challenges:</span></p><ul style="padding: 0;" class="c12 lst-kix_qmksthfuerg1-0 start"><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>AMD is pretty clear about the fact that software should not touch the host save area in any way and that the data stored in this area is CPU-dependent: “</span><span class="c26">Processor implementations may store only part or none of host state in the memory area pointed to by VM_HSAVE_PA MSR and may store some or all host state in hidden on-chip memory. Different implementations may choose to save the hidden parts of the host’s segment registers as well as the selectors. For these reasons, software must not rely on the format or contents of the host state save area, nor attempt to change host state by modifying the contents of the host save area.</span><span class="c8">” (AMD64 Architecture Programmer’s Manual, Volume 2: System Programming, Page 477). To strengthen the point, the format of the host save area is undocumented. </span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">Debugging issues involving an invalid host state is very tedious as any issue leads to an immediate processor shutdown. Even worse, I wasn’t sure if rewriting the VM_HSAVE_PA MSR while running inside a VM can even work. It’s not really something that should happen during normal operation so in the worst case scenario, overwriting the MSR would just lead to an immediate crash.</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">Even if we can create a valid (but malicious) host save area in our guest, we still need some way to identify its host physical address (HPA). Because our guest runs with nested paging enabled, physical addresses that we can see in the guest (GPAs) are still one address translation away from their HPA equivalent.</span></li></ul>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">After spending some time scrolling through AMD’s documentation, I still decided that VM_HSAVE_PA seems to be the best way forward and decided to tackle these problems one by one. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">After dumping the host save area of a normal KVM guest running on an AMD EPYC 7351P CPU, the first problem goes away quickly: As it turns out, the host save area has the same layout as a normal VMCB with only a couple of relevant fields initialized. Even better, the initialized fields include all the saved host information documented in the AMD manual so the fear that all interesting host state is stored in on-chip memory seems to be unfounded. </span></p>
 <p class="c5 c9"><span class="c8"></span></p><a id="t.62ceb349a4c2f9332b305830fc836b9fe5914c31"></a><a id="t.7"></a><table class="c30"><tbody><tr class="c28"><td class="c32" colspan="1" rowspan="1">
 <p class="c24"><span class="c18">Saving Host State.</span><span class="c8">&nbsp;To ensure that the host can resume operation after #VMEXIT, VMRUN saves at least the following host state information:</span></p><ul style="padding: 0;" class="c12 lst-kix_fc4hxeeodeag-0 start"><li style="margin-left: 46pt;" class="c14 li-bullet-0"><span class="c8">CS.SEL, NEXT_RIP—The CS selector and rIP of the instruction following the VMRUN. On #VMEXIT the host resumes running at this address.</span></li><li style="margin-left: 46pt;" class="c14 li-bullet-0"><span class="c8">RFLAGS, RAX—Host processor mode and the register used by VMRUN to address the VMCB.</span></li><li style="margin-left: 46pt;" class="c14 li-bullet-0"><span class="c8">SS.SEL, RSP—Stack pointer for host</span></li><li style="margin-left: 46pt;" class="c14 li-bullet-0"><span class="c8">CRO, CR3, CR4, EFER—Paging/operating mode for host</span></li><li style="margin-left: 46pt;" class="c14 li-bullet-0"><span class="c8">IDTR, GDTR—The pseudo-descriptors. VMRUN does not save or restore the host LDTR.</span></li><li style="margin-left: 46pt;" class="c14 li-bullet-0"><span class="c8">ES.SEL and DS.SEL. </span></li></ul></td></tr></tbody></table>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span>Under the mistaken assumption that I solved the problem of creating a fake but valid host save area, I decided to look into building an infoleak that gives me the ability to translate GPAs to HPAs. A couple hours of manual reading led me to an AMD-specific performance monitoring feature called Instruction Based Sampling (</span><span>IBS</span><span>). When IBS is enabled by writing the right magic invocation to a set of MSRs, it samples every Nth instruction that is executed and collects a wide range of information about the instruction. This information is logged in another set of MSRs and can be used to analyze the performance of any piece of code running on the CPU. While most of the documentation for IBS is pretty sparse or hard to follow, the very useful open source project </span><span class="c16"><a class="c71" href="https://github.com/jlgreathouse/AMD_IBS_Toolkit">AMD IBS Toolkit</a></span><span class="c8">&nbsp;contains working code, a readable high level description of IBS and a lot of useful references. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">IBS supports two different modes of operation, one that samples Instruction fetches and one that samples micro-ops (which you can think of as the internal RISC representation of more complex x64 instructions). Depending on the operation mode, different data is collected. Besides a lot of caching and latency information that we don’t care about, fetch sampling also returns the virtual address and physical address of the fetched instruction. Op sampling is even more useful as it returns the virtual address of the underlying instruction as well as virtual and physical addresses accessed by any load or store micro op. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span>Interestingly, </span><span>IBS does not seem to care about the virtualization context of its user and every physical address returned by it is an HPA</span><span class="c8">&nbsp;(of course this is not a problem outside of this exploit as guest accesses to the IBS MSR’s will normally be restricted). The wide range of data returned by IBS and the fact that it’s completely driven by MSR reads and writes make it the perfect tool for building infoleaks for our exploit. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">Building a GPA -&gt; HPA leak boils down to enabling IBS ops sampling, executing a lot of instructions that access a specific memory page in our VM and reading the IBS_DC_PHYS_AD MSR to find out its HPA:</span></p>
 <p class="c5 c9"><span class="c8"></span></p><a id="t.e9f6e96b7d3821fb7bfbf61c54c1f2f034c111dd"></a><a id="t.8"></a><table class="c30"><tbody><tr class="c28"><td class="c17" colspan="1" rowspan="1">
 <p class="c5"><span class="c22">// This function leaks the HPA of a guest page using</span></p>
 <p class="c5"><span class="c22">// AMD's Instruction Based Sampling. We try to sample</span></p>
 <p class="c5"><span class="c22">// one of our memory loads/writes to *p, which will</span></p>
 <p class="c5"><span class="c22">// store the physical memory address in MSR_IBC_DH_PHYS_AD</span></p>
 <p class="c5"><span class="c0">static</span><span class="c3">&nbsp;u64 leak_guest_hpa</span><span class="c1">(</span><span class="c3">u8 </span><span class="c1">*</span><span class="c3">p</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c5"><span class="c3">&nbsp; </span><span class="c0">volatile</span><span class="c3">&nbsp;u8 </span><span class="c1">*</span><span class="c3">ptr </span><span class="c1">=</span><span class="c3">&nbsp;p</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; u64 ibs </span><span class="c1">=</span><span class="c3">&nbsp;scatter_bits</span><span class="c1">(</span><span class="c10">0x2</span><span class="c1">,</span><span class="c3">&nbsp;IBS_OP_CUR_CNT_23</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">|</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scatter_bits</span><span class="c1">(</span><span class="c10">0x10</span><span class="c1">,</span><span class="c3">&nbsp;IBS_OP_MAX_CNT</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">|</span><span class="c3">&nbsp;IBS_OP_EN</span><span class="c1">;</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; </span><span class="c0">while</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c0">true</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; wrmsr</span><span class="c1">(</span><span class="c3">MSR_IBS_OP_CTL</span><span class="c1">,</span><span class="c3">&nbsp;ibs</span><span class="c1">);</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; u64 x </span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c10">0</span><span class="c1">;</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; </span><span class="c0">for</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c0">int</span><span class="c3">&nbsp;i </span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c10">0</span><span class="c1">;</span><span class="c3">&nbsp;i </span><span class="c1">&lt;</span><span class="c3">&nbsp;</span><span class="c10">0x1000</span><span class="c1">;</span><span class="c3">&nbsp;i</span><span class="c1">++)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; x </span><span class="c1">=</span><span class="c3">&nbsp;ptr</span><span class="c1">[</span><span class="c3">i</span><span class="c1">];</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; ptr</span><span class="c1">[</span><span class="c3">i</span><span class="c1">]</span><span class="c3">&nbsp;</span><span class="c1">+=</span><span class="c3">&nbsp;ptr</span><span class="c1">[</span><span class="c3">i </span><span class="c1">-</span><span class="c3">&nbsp;</span><span class="c10">1</span><span class="c1">];</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; ptr</span><span class="c1">[</span><span class="c3">i</span><span class="c1">]</span><span class="c3">&nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;x</span><span class="c1">;</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; </span><span class="c0">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">i </span><span class="c1">%</span><span class="c3">&nbsp;</span><span class="c10">50</span><span class="c3">&nbsp;</span><span class="c1">==</span><span class="c3">&nbsp;</span><span class="c10">0</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; u64 valid </span><span class="c1">=</span><span class="c3">&nbsp;rdmsr</span><span class="c1">(</span><span class="c3">MSR_IBS_OP_CTL</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">&amp;</span><span class="c3">&nbsp;IBS_OP_VAL</span><span class="c1">;</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">valid</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u64 op3 </span><span class="c1">=</span><span class="c3">&nbsp;rdmsr</span><span class="c1">(</span><span class="c3">MSR_IBS_OP_DATA3</span><span class="c1">);</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">if</span><span class="c3">&nbsp;</span><span class="c1">((</span><span class="c3">op3 </span><span class="c1">&amp;</span><span class="c3">&nbsp;IBS_ST_OP</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">||</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">op3 </span><span class="c1">&amp;</span><span class="c3">&nbsp;IBS_LD_OP</span><span class="c1">))</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">op3 </span><span class="c1">&amp;</span><span class="c3">&nbsp;IBS_DC_PHY_ADDR_VALID</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; printf</span><span class="c1">(</span><span class="c23 c34">"[x] leak_guest_hpa: %lx %lx %lx\n"</span><span class="c1">,</span><span class="c3">&nbsp;rdmsr</span><span class="c1">(</span><span class="c3">MSR_IBS_OP_RIP</span><span class="c1">),</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;rdmsr</span><span class="c1">(</span><span class="c3">MSR_IBS_DC_PHYS_AD</span><span class="c1">),</span><span class="c3">&nbsp;rdmsr</span><span class="c1">(</span><span class="c3">MSR_IBS_DC_LIN_AD</span><span class="c1">));</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">return</span><span class="c3">&nbsp;rdmsr</span><span class="c1">(</span><span class="c3">MSR_IBS_DC_PHYS_AD</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">&amp;</span><span class="c3">&nbsp;</span><span class="c1">~(</span><span class="c10">0xFFF</span><span class="c1">);</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wrmsr</span><span class="c1">(</span><span class="c3">MSR_IBS_OP_CTL</span><span class="c1">,</span><span class="c3">&nbsp;ibs</span><span class="c1">);</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c5 c11"><span class="c2"></span></p>
 <p class="c5"><span class="c3">&nbsp; &nbsp; wrmsr</span><span class="c1">(</span><span class="c3">MSR_IBS_OP_CTL</span><span class="c1">,</span><span class="c3">&nbsp;ibs </span><span class="c1">&amp;</span><span class="c3">&nbsp;</span><span class="c1">~</span><span class="c3">IBS_OP_EN</span><span class="c1">);</span></p>
 <p class="c5"><span class="c3">&nbsp; </span><span class="c1">}</span></p>
 <p class="c5"><span class="c1">}</span></p></td></tr></tbody></table>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">Using this infoleak primitive, I started to create a fake host save area by preparing my own page tables (for pointing CR3 at them), interrupt descriptor tables and segment descriptors and pointing RIP to a primitive shellcode that would write to the serial console. Of course, my first tries immediately crashed the whole system and even after spending multiple days to make sure everything was set up correctly, the system would crash immediately once I pointed the hsave MSR at my own location. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">After getting frustrated with the total lack of progress, watching my server reboot for the hundredth time, trying to come up with a different exploitation strategy for two weeks and learning about the surprising regularity of physical page migrations on Linux, I realized that I made an important mistake. Just because the CPU initializes all the expected fields in the host save area, it is not safe to assume that these fields are actually used for restoring the host context. Slow trial and error led to the discovery that my AMD EPYC CPU ignores everything in the host save area besides the values of the RIP, RSP and RAX registers.</span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">While this register control would make a local privilege escalation straightforward, escaping the VM boundary is a bit more complicated. RIP and RSP control make launching a kernel ROP chain the next logical step, but this requires us to first break the host kernel's address randomization and to find a way to store controlled data at a known host virtual address (HVA). </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">Fortunately, we have IBS as a powerful infoleak building primitive and can use it to gather all required information in a single run: </span></p><ul style="padding: 0;" class="c12 lst-kix_p3qtgxnpnwqf-0 start"><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">Leaking the host kernel's (or more specifically kvm-amd.ko’s) base address can be done by enabling IBS sampling with a small sampling interval and immediately triggering a VM exit. When VM execution continues, the IBS result MSRs will contain the HVA of instructions executed by KVM during the exit handling. </span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>The most powerful way to store data at a known HVA is to leak the location of the kernel’s linear mapping (also known as </span><span>physmap</span><span class="c8">), a 1:1 mapping of all physical pages on the system. This gives us a GPA-&gt;HVA translation primitive by first using our GPA-&gt;HPA infoleak from above and then adding the HPA to the physmap base address. Leaking the physmap is possible by sampling micro ops in the host kernel until we find a read or write operation, where the lower ~30 bits of the accessed virtual address and physical address are identical. </span></li></ul>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">Having all these building blocks in place, we could now try to build a kernel ROP chain that executes some interesting payload. However, there is one important caveat. When we take over execution after a vmexit, the system is still in a somewhat unstable state. As mentioned above, SVM’s context switching is very minimal and we are at least one VMLOAD instruction and reenabling of interrupts away from a usable system. While it is surely possible to exploit this bug and to restore the original host context using a sufficiently complex ROP chain, I decided to find a way to run my own code instead.</span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">A couple of years ago, the Linux physmap was still mapped executable and executing our own code would be as simple as jumping to a physmap mapping of one of our guest pages. Of course, that is not possible anymore and the kernel tries hard to not have any memory pages mapped as writable and executable. Still, page protections only apply to virtual memory accesses so why not use an instruction that directly writes controlled data to a physical address? As you might remember from our initial discussion of SVM earlier in this chapter, SVM supports an instruction called VMSAVE to store hidden guest state (or host state) in a VMCB. Similar to VMRUN, VMSAVE takes a physical address to a VMCB stored in the RAX register as an implicit argument. It then writes the following register state to the VMCB:</span></p><ul style="padding: 0;" class="c12 lst-kix_dvq5vbolwb6x-0 start"><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">FS, GS, TR, LDTR </span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">KernelGsBase </span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">STAR, LSTAR, CSTAR, SFMASK </span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">SYSENTER_CS, SYSENTER_ESP, SYSENTER_EIP</span></li></ul>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">For us, VMSAVE is interesting for a couple of reasons:</span></p><ul style="padding: 0;" class="c12 lst-kix_z3dz91t3nune-0 start"><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">It is used as part of KVM’s normal SVM exit handler and can be easily integrated into a minimal ROP chain.</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">It operates on physical addresses, so we can use it to write to an arbitrary memory location including KVM’s own code.</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">All written registers still contain the guest values set by our VM, allowing us to control the written content with some restrictions</span></li></ul>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">VMSAVE’s biggest downside as an exploitation primitive is that RAX needs to be page aligned, reducing our control of the target address. VMSAVE writes to the memory offsets 0x440-0x480 and 0x600-0x638 so we need to be careful about not corrupting any memory that’s in use. </span></p>
 <p class="c5 c13"><span class="c8">In our case this turns out to be a non-issue, as KVM contains a couple of code pages where functions that are rarely or never used (e.g cleanup_module or SEV specific code) are stored at these offsets. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span>While we don’t have full control over the written data and valid register values are somewhat restricted, it is still possible to write a minimal stage0 shellcode to an arbitrary page in the host kernel by filling guest MSRs with the right values. My exploit uses the STAR, LSTAR and CSTAR registers for this which are written to the physical offsets 0x400, 0x408 and 0x410. As all three registers need to contain</span><span class="c16"><a class="c71" href="https://en.wikipedia.org/w/index.php?title=X86-64#Virtual_address_space_details">&nbsp;canonical addresses</a></span><span class="c8">, we can only use parts of the registers for our shellcode and use relative jumps to skip the unusable parts of the STAR and LSTAR MSRs:</span></p>
 <p class="c5 c9"><span class="c8"></span></p><a id="t.42d44951583ac9bd6dae4dc111d7e4042c6fe14e"></a><a id="t.9"></a><table class="c30"><tbody><tr class="c28"><td class="c17" colspan="1" rowspan="1">
 <p class="c5"><span class="c22">&nbsp; // mov cr0, rbx; </span><span class="c22">jmp</span></p>
 <p class="c5"><span class="c3">&nbsp; wrmsr</span><span class="c1">(</span><span class="c3">MSR_STAR</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c10">0x00000003ebc3220f</span><span class="c1">);</span></p>
 <p class="c5"><span class="c3">&nbsp; </span><span class="c22">// pop rdi; pop rsi; pop rcx; jmp</span></p>
 <p class="c5"><span class="c3">&nbsp; wrmsr</span><span class="c1">(</span><span class="c3">MSR_LSTAR</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c10">0x00000003</span><span class="c10">eb595e5fULL</span><span class="c1">);</span></p>
 <p class="c5"><span class="c3">&nbsp; </span><span class="c22">// rep movsb; pop rdi; jmp rdi;</span></p>
 <p class="c5"><span class="c3">&nbsp; wrmsr</span><span class="c1">(</span><span class="c3">MSR_CSTAR</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c10">0xe7ff5fa4f3</span><span class="c1">);</span></p></td></tr></tbody></table>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">The above code makes use of the fact that we control the value of the RBX register and the stack when we return to it as part of our initial ROP chain. First, we copy the value of RBX (0x80040033) into CR0, which disables Write Protection (WP) for kernel memory accesses. This makes all of the kernel code writable on this CPU allowing us to copy a larger stage1 shellcode to an arbitrary unused memory location and jump to it.</span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">Once the WP bit in cr0 is disabled and the stage1 payload executes, we have a wide range of options. For my proof-of-concept exploit I decided on a somewhat boring but easy-to-implement approach to spawn a random user space command: The host is still in a very weird state so our stage1 payload can’t directly call into other kernel functions, but we can easily backdoor a function pointer which will be called at some later point in time. KVM uses the kernel’s global workqueue feature to regularly synchronize a VM’s clock between different vCPUs. The function pointer responsible for this work is stored in the (per VM) kvm-&gt;arch data structure as kvm-&gt;arch.kvmclock_update_work. The stage1 payload overrides this function pointer with the address of a stage2 payload. To put the host into a usable state it then sets the VM_HSAVE_PA MSR back to its original value and restores RSP and RIP to call the original vmexit handler. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">The final stage2 payload executes at some later point in time as part of the kernel global work queue and uses the call_usermodehelper to run an arbitrary command with root privileges. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">Let’s put all of this together and walk through the attacks step-by-step:</span></p><ol class="c12 lst-kix_69oxjbhu0l4-0 start" start="1"><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">Prepare the stage0 payload by splitting it up and setting the right guest MSRs.</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">Trigger the TOCTOU vulnerability in nested_svm_vmrun and free the MSR permission bitmap by disabling the SVME bit in the EFER MSR.</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">Wait for the pages to be reused and initialized to 0 to get unrestricted MSR access.</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">Prepare a fake host save area, a stack for the initial ROP chain and a staging memory area for the stage1 and stage2 payloads. </span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">Leak the HPA of the host save area, the HVA addresses of the stack and staging page and the kvm-amd.ko’s base address using the different IBS infoleaks.</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">Redirect execution to the VMSAVE gadget by setting RIP, RSP and RAX in the fake host save area, pointing the VM_HSAVE_PA MSR at it and triggering a VM exit.</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">VMSAVE writes the stage0 payload to an unused offset in kvm-amd’s code segment, when the gadget returns stage0 gets executed.</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">stage0 disables Write Protection in CR0 and overwrites an unused executable memory location with the stage1 and stage2 payloads, before jumping to stage1.</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">stage1 overwrites kvm-&gt;arch.kvmclock_update_work.work.func with a pointer to stage2 before restoring the original host context.</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">At some later point in time kvm-&gt;arch.kvmclock_update_work.work.func is called as part of the global kernel work_queue and stage2 spawns an arbitrary command using call_usermodehelper. </span></li></ol>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span>Interested readers should take a look at the heavily documented </span><span class="c16"><a class="c71" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2177#c5">proof-of-concept exploit</a></span><span class="c8">&nbsp;for the actual implementation. </span></p><h2 class="c20 c13" id="h.jz5frebdego5"><span class="c21">Conclusion</span></h2>
 <p class="c5 c13"><span>This blog post describes a KVM-only VM escape made possible by a small bug in KVM’s AMD-specific code for supporting nested virtualization. Luckily, the feature that made this bug exploitable was only included in two kernel versions (v5.10, v5.11) before the issue was spotted, reducing the real-life impact of the vulnerability to a minimum. </span><span>The bug and its exploit still serve as a demonstration that highly exploitable security vulnerabilities can still exist in the very core of a virtualization engine, which is almost certainly a small and well audited codebase</span><span class="c8">. While the attack surface of a hypervisor such as KVM is relatively small from a pure LoC perspective, its low level nature, close interaction with hardware and pure complexity makes it very hard to avoid security-critical bugs. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span>While we have not seen any in-the-wild exploits targeting hypervisors outside of competitions like Pwn2Own, these capabilities are clearly achievable for a well-financed adversary. I’ve spent around two months on this research, working as an individual with only remote access to an AMD system. Looking at the potential ROI on an exploit like this, it seems safe to assume that more people are working on similar issues right now and that vulnerabilities in KVM, Hyper-V, Xen or VMware will be exploited in-the-wild sooner or later.</span><span class="c8">&nbsp;</span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">What can we do about this? Security engineers working on Virtualization Security should push for as much attack surface reduction as possible. Moving complex functionality to memory-safe user space components is a big win even if it does not help against bugs like the one described above. Disabling unneeded or unreviewed features and performing regular in-depth code reviews for new changes can further reduce the risk of bugs slipping by. </span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c13"><span class="c8">Hosters, cloud providers and other enterprises that are relying on virtualization for multi-tenancy isolation should design their architecture in way that limits the impact of an attacker with an VM escape exploit:</span></p><ul style="padding: 0;" class="c12 lst-kix_rg61eog4va0o-0 start"><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>Isolation of VM hosts: Machines that host untrusted VMs should be considered at least partially untrusted. While a VM escape can give an attacker full control over a single host, it should not be easily possible to move from one compromised host to another. This requires that the control plane and backend infrastructure is sufficiently hardened and that user resources like disk images or encryption keys are only exposed to hosts that need them. One</span><span>&nbsp;way to limit the impact of a VM escape even further is to only run VMs of a specific customer or of a certain sensitivity on a single machine.</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="c8">Investing in detection capabilities: In most architectures, the behavior of a VM host should be very predictable, making a compromised host stick out quickly once an attacker tries to move to other systems. While it’s very hard to rule out the possibility of a vulnerability in your virtualization stack, good detection capabilities make life for an attacker much harder and increase the risk of quickly burning a high-value vulnerability. Agents running on the VM host can be a first (but bypassable) detection mechanism, but the focus should be on detecting unusual network communication and resource accesses.</span></li></ul>
 <p class="c5 c9 c35"><span class="c8"></span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c9 c35"><span class="c8"></span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c9"><span class="c8"></span></p>
 <p class="c5 c9"><span class="c8"></span></p>
<div style="clear: both;"></div>
</div>
<div class="post-footer">
<div class="post-footer-line post-footer-line-1">
<span class="post-author vcard">
Posted by
<span class="fn" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person">
<meta content="https://www.blogger.com/profile/17011901605865574886" itemprop="url">
<a class="g-profile" href="https://www.blogger.com/profile/17011901605865574886" rel="author" title="author profile" data-gapiscan="true" data-onload="true" data-gapiattached="true">
<span itemprop="name">Ryan</span>
</a>
</span>
</span>
<span class="post-timestamp">
at
<meta content="https://googleprojectzero.blogspot.com/2021/06/an-epyc-escape-case-study-of-kvm.html" itemprop="url">
<a class="timestamp-link" href="https://googleprojectzero.blogspot.com/2021/06/an-epyc-escape-case-study-of-kvm.html" rel="bookmark" title="permanent link"><abbr class="published" itemprop="datePublished" title="2021-06-29T08:58:00-07:00">8:58 AM</abbr></a>
</span>
<span class="post-comment-link">
</span>
<span class="post-icons">
<span class="item-control blog-admin pid-145400864">
<a href="https://www.blogger.com/post-edit.g?blogID=4838136820032157985&amp;postID=8408446653514773445&amp;from=pencil" title="Edit Post">
<img alt="" class="icon-action" height="18" src="./2021 - An EPYC escape Case-study of a KVM breakout_files/icon18_edit_allbkg.gif" width="18">
</a>
</span>
</span>
<div class="post-share-buttons goog-inline-block">
<a class="goog-inline-block share-button sb-email" href="https://www.blogger.com/share-post.g?blogID=4838136820032157985&amp;postID=8408446653514773445&amp;target=email" target="_blank" title="Email This"><span class="share-button-link-text">Email This</span></a><a class="goog-inline-block share-button sb-blog" href="https://www.blogger.com/share-post.g?blogID=4838136820032157985&amp;postID=8408446653514773445&amp;target=blog" onclick="window.open(this.href, &quot;_blank&quot;, &quot;height=270,width=475&quot;); return false;" target="_blank" title="BlogThis!"><span class="share-button-link-text">BlogThis!</span></a><a class="goog-inline-block share-button sb-twitter" href="https://www.blogger.com/share-post.g?blogID=4838136820032157985&amp;postID=8408446653514773445&amp;target=twitter" target="_blank" title="Share to Twitter"><span class="share-button-link-text">Share to Twitter</span></a><a class="goog-inline-block share-button sb-facebook" href="https://www.blogger.com/share-post.g?blogID=4838136820032157985&amp;postID=8408446653514773445&amp;target=facebook" onclick="window.open(this.href, &quot;_blank&quot;, &quot;height=430,width=640&quot;); return false;" target="_blank" title="Share to Facebook"><span class="share-button-link-text">Share to Facebook</span></a><a class="goog-inline-block share-button sb-pinterest" href="https://www.blogger.com/share-post.g?blogID=4838136820032157985&amp;postID=8408446653514773445&amp;target=pinterest" target="_blank" title="Share to Pinterest"><span class="share-button-link-text">Share to Pinterest</span></a>
</div>
</div>
<div class="post-footer-line post-footer-line-2">
<span class="post-labels">
</span>
</div>
<div class="post-footer-line post-footer-line-3">
<span class="post-location">
</span>
</div>
</div>
</div>
<div class="comments" id="comments">
<a name="comments"></a>
<h4>No comments:</h4>
<div id="Blog1_comments-block-wrapper">
<dl class="avatar-comment-indent" id="comments-block">
</dl>
</div>
<p class="comment-footer">
</p><div class="comment-form">
<a name="comment-form"></a>
<h4 id="comment-post-message">Post a Comment</h4>
<p>
</p>
<a href="https://www.blogger.com/comment-iframe.g?blogID=4838136820032157985&amp;postID=8408446653514773445&amp;blogspotRpcToken=1895788" id="comment-editor-src"></a>
<iframe allowtransparency="true" class="blogger-iframe-colorize blogger-comment-from-post" frameborder="0" height="195px" id="comment-editor" name="comment-editor" src="./2021 - An EPYC escape Case-study of a KVM breakout_files/comment-iframe.html" width="100%" data-resized="true"></iframe>
<script src="./2021 - An EPYC escape Case-study of a KVM breakout_files/3261120736-comment_from_post_iframe.js.下載" type="text/javascript"></script>
<script type="text/javascript">
      BLOG_CMT_createIframe('https://www.blogger.com/rpc_relay.html');
    </script>
</div>
<p></p>
</div>
</div>

        </div></div>
      
</div>
<div class="blog-pager" id="blog-pager">
<span id="blog-pager-newer-link">
<a class="blog-pager-newer-link" href="https://googleprojectzero.blogspot.com/2021/08/understanding-network-access-windows-app.html" id="Blog1_blog-pager-newer-link" title="Newer Post">Newer Post</a>
</span>
<span id="blog-pager-older-link">
<a class="blog-pager-older-link" href="https://googleprojectzero.blogspot.com/2021/05/fuzzing-ios-code-on-macos-at-native.html" id="Blog1_blog-pager-older-link" title="Older Post">Older Post</a>
</span>
<a class="home-link" href="https://googleprojectzero.blogspot.com/">Home</a>
</div>
<div class="clear"></div>
<div class="post-feeds">
<div class="feed-links">
Subscribe to:
<a class="feed-link" href="https://googleprojectzero.blogspot.com/feeds/8408446653514773445/comments/default" target="_blank" type="application/atom+xml">Post Comments (Atom)</a>
</div>
</div>
</div></div>
</div>
</div>
<div class="column-left-outer">
<div class="column-left-inner">
<aside>
</aside>
</div>
</div>
<div class="column-right-outer">
<div class="column-right-inner">
<aside>
<div class="sidebar section" id="sidebar-right-1"><div class="widget BlogSearch" data-version="1" id="BlogSearch1">
<h2 class="title">Search This Blog</h2>
<div class="widget-content">
<div id="BlogSearch1_form">
<form action="https://googleprojectzero.blogspot.com/search" class="gsc-search-box" target="_top">
<table cellpadding="0" cellspacing="0" class="gsc-search-box">
<tbody>
<tr>
<td class="gsc-input">
<input autocomplete="off" class="gsc-input" name="q" size="10" title="search" type="text" value="">
</td>
<td class="gsc-search-button">
<input class="gsc-search-button" title="search" type="submit" value="Search">
</td>
</tr>
</tbody>
</table>
</form>
</div>
</div>
<div class="clear"></div>
</div><div class="widget PageList" data-version="1" id="PageList1">
<h2>Pages</h2>
<div class="widget-content">
<ul>
<li>
<a href="https://googleprojectzero.blogspot.com/p/about-project-zero.html">About Project Zero</a>
</li>
<li>
<a href="https://googleprojectzero.blogspot.com/p/working-at-project-zero.html">Working at Project Zero</a>
</li>
<li>
<a href="https://googleprojectzero.blogspot.com/p/0day.html">0day "In the Wild"</a>
</li>
<li>
<a href="https://googleprojectzero.github.io/0days-in-the-wild/rca.html">0day Exploit Root Cause Analyses</a>
</li>
<li>
<a href="https://googleprojectzero.blogspot.com/p/vulnerability-disclosure-faq.html">Vulnerability Disclosure FAQ</a>
</li>
</ul>
<div class="clear"></div>
</div>
</div><div class="widget BlogArchive" data-version="1" id="BlogArchive1">
<h2>Archives</h2>
<div class="widget-content">
<div id="ArchiveList"><hr><div style="font-size: large;">2021</div><ul><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2021/12/this-shouldnt-have-happened.html">This shouldn&amp;#39;t have happened: A vulnerability post...</a><span> (Dec)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2021/10/windows-exploitation-tricks-relaying.html">Windows Exploitation Tricks: Relaying DCOM Authent...</a><span> (Oct)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html">Using Kerberos for Authentication Relay Attacks</a><span> (Oct)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2021/10/how-simple-linux-kernel-memory.html">How a simple Linux kernel memory corruption bug ca...</a><span> (Oct)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2021/09/fuzzing-closed-source-javascript.html">Fuzzing Closed-Source JavaScript Engines with Cove...</a><span> (Sep)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2021/08/understanding-network-access-windows-app.html">Understanding Network Access in Windows AppContainers</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2021/06/an-epyc-escape-case-study-of-kvm.html">An EPYC escape: Case-study of a KVM breakout</a><span> (Jun)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2021/05/fuzzing-ios-code-on-macos-at-native.html">Fuzzing iOS code on macOS at native speed</a><span> (May)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2021/04/designing-sockfuzzer-network-syscall.html">Designing sockfuzzer, a network syscall fuzzer for...</a><span> (Apr)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2021/04/policy-and-disclosure-2021-edition.html">Policy and Disclosure: 2021 Edition</a><span> (Apr)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2021/04/who-contains-containers.html">Who Contains the Containers?</a><span> (Apr)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2021/03/in-wild-series-october-2020-0-day.html">In-the-Wild Series: October 2020 0-day discovery</a><span> (Mar)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2021/02/deja-vu-lnerability.html">Déjà vu-lnerability</a><span> (Feb)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2021/01/a-look-at-imessage-in-ios-14.html">A Look at iMessage in iOS 14</a><span> (Jan)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2021/01/windows-exploitation-tricks-trapping.html">Windows Exploitation Tricks: Trapping Virtual Memo...</a><span> (Jan)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2021/01/the-state-of-state-machines.html">The State of State Machines</a><span> (Jan)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2021/01/hunting-for-bugs-in-windows-mini-filter.html">Hunting for Bugs in Windows Mini-Filter Drivers</a><span> (Jan)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2021/01/in-wild-series-android-post-exploitation.html">In-the-Wild Series: Android Post-Exploitation</a><span> (Jan)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2021/01/in-wild-series-windows-exploits.html">In-the-Wild Series: Windows Exploits</a><span> (Jan)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2021/01/in-wild-series-android-exploits.html">In-the-Wild Series: Android Exploits</a><span> (Jan)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2021/01/in-wild-series-chrome-infinity-bug.html">In-the-Wild Series: Chrome Infinity Bug</a><span> (Jan)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2021/01/in-wild-series-chrome-exploits.html">In-the-Wild Series: Chrome Exploits</a><span> (Jan)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2021/01/introducing-in-wild-series.html">Introducing the In-the-Wild Series</a><span> (Jan)</span></li></ul><hr><div style="font-size: large;">2020</div><ul><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/12/an-ios-hacker-tries-android.html">An iOS hacker tries Android</a><span> (Dec)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/12/an-ios-zero-click-radio-proximity.html">An iOS zero-click radio proximity exploit odyssey</a><span> (Dec)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/11/oops-i-missed-it-again.html">Oops, I missed it again!</a><span> (Nov)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/10/enter-the-vault-auth-issues-hashicorp-vault.html">Enter the Vault: Authentication Issues in HashiCor...</a><span> (Oct)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/10/announcing-fuzzilli-research-grant.html">Announcing the Fuzzilli Research Grant Program</a><span> (Oct)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/09/attacking-qualcomm-adreno-gpu.html">Attacking the Qualcomm Adreno GPU</a><span> (Sep)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/09/jitsploitation-one.html">JITSploitation I: A JIT Bug</a><span> (Sep)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/09/jitsploitation-two.html">JITSploitation II: Getting Read/Write</a><span> (Sep)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/09/jitsploitation-three.html">JITSploitation III: Subverting Control Flow</a><span> (Sep)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/08/mms-exploit-part-5-defeating-aslr-getting-rce.html">MMS Exploit Part 5: Defeating Android ASLR, Gettin...</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/08/exploiting-android-messengers-part-3.html">Exploiting Android Messengers with WebRTC: Part 3</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/08/exploiting-android-messengers-part-2.html">Exploiting Android Messengers with WebRTC: Part 2</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/08/mms-exploit-part-4-completing-aslr-oracle.html">MMS Exploit Part 4: MMS Primer, Completing the ASL...</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/08/exploiting-android-messengers-part-1.html">Exploiting Android Messengers with WebRTC: Part 1</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/07/the-core-of-apple-is-ppl-breaking-xnu.html">The core of Apple is PPL: Breaking the XNU kernel&amp;#39;...</a><span> (Jul)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/07/one-byte-to-rule-them-all.html">One Byte to rule them all</a><span> (Jul)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/07/root-cause-analyses-for-0-day-in-wild.html">Root Cause Analyses for 0-day In-the-Wild Exploits</a><span> (Jul)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/07/detection-deficit-year-in-review-of-0.html">Detection Deficit: A Year in Review of 0-days Used...</a><span> (Jul)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/07/mms-exploit-part-3-constructing-primitives.html">MMS Exploit Part 3: Constructing the Memory Corrup...</a><span> (Jul)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/07/mms-exploit-part-2-effective-fuzzing-qmage.html">MMS Exploit Part 2: Effective Fuzzing of the Qmage...</a><span> (Jul)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/07/mms-exploit-part-1-introduction-to-qmage.html">MMS Exploit Part 1: Introduction to the Samsung Qm...</a><span> (Jul)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/07/how-to-unc0ver-0-day-in-4-hours-or-less.html">How to unc0ver a 0-day in 4 hours or less</a><span> (Jul)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/06/ff-sandbox-escape-cve-2020-12388.html">FF Sandbox Escape (CVE-2020-12388)</a><span> (Jun)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/06/a-survey-of-recent-ios-kernel-exploits.html">A survey of recent iOS kernel exploits</a><span> (Jun)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/04/fuzzing-imageio.html">Fuzzing ImageIO</a><span> (Apr)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/04/you-wont-believe-what-this-one-line.html">You Won&amp;#39;t Believe what this One Line Change Did to...</a><span> (Apr)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/04/tfw-you-get-really-excited-you-patch.html">TFW you-get-really-excited-you-patch-diffed-a-0day...</a><span> (Apr)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/02/escaping-chrome-sandbox-with-ridl.html">Escaping the Chrome Sandbox with RIDL</a><span> (Feb)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/02/mitigations-are-attack-surface-too.html">Mitigations are attack surface, too</a><span> (Feb)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/02/several-months-in-life-of-part2.html">A day^W^W Several months in the life of Project Ze...</a><span> (Feb)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/02/several-months-in-life-of-part1.html">A day^W^W Several months in the life of Project Ze...</a><span> (Feb)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/01/part-ii-returning-to-adobe-reader.html">Part II: Returning to Adobe Reader symbols on macOS</a><span> (Jan)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/01/remote-iphone-exploitation-part-3.html">Remote iPhone Exploitation Part 3: From Memory Cor...</a><span> (Jan)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/01/remote-iphone-exploitation-part-2.html">Remote iPhone Exploitation Part 2: Bringing Light ...</a><span> (Jan)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/01/remote-iphone-exploitation-part-1.html">Remote iPhone Exploitation Part 1: Poking Memory v...</a><span> (Jan)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2020/01/policy-and-disclosure-2020-edition.html">Policy and Disclosure: 2020 Edition</a><span> (Jan)</span></li></ul><hr><div style="font-size: large;">2019</div><ul><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/12/calling-local-windows-rpc-servers-from.html">Calling Local Windows RPC Servers from .NET</a><span> (Dec)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/12/sockpuppet-walkthrough-of-kernel.html">SockPuppet: A Walkthrough of a Kernel Exploit for ...</a><span> (Dec)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/11/bad-binder-android-in-wild-exploit.html">Bad Binder: Android In-The-Wild Exploit</a><span> (Nov)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/10/ktrw-journey-to-build-debuggable-iphone.html">KTRW: The journey to build a debuggable iPhone</a><span> (Oct)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/10/the-story-of-adobe-reader-symbols.html">The story of Adobe Reader symbols</a><span> (Oct)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/09/windows-exploitation-tricks-spoofing.html">Windows‌ ‌Exploitation‌ ‌Tricks:‌ ‌Spoofing‌ ‌Name...</a><span> (Sep)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/08/a-very-deep-dive-into-ios-exploit.html">A very deep dive into iOS Exploit chains found in ...</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/08/in-wild-ios-exploit-chain-1.html">In-the-wild iOS Exploit Chain 1</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/08/in-wild-ios-exploit-chain-2.html">In-the-wild iOS Exploit Chain 2</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/08/in-wild-ios-exploit-chain-3.html">In-the-wild iOS Exploit Chain 3</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/08/in-wild-ios-exploit-chain-4.html">In-the-wild iOS Exploit Chain 4</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/08/in-wild-ios-exploit-chain-5.html">In-the-wild iOS Exploit Chain 5</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/08/implant-teardown.html">Implant Teardown</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/08/jsc-exploits.html">JSC Exploits</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/08/the-many-possibilities-of-cve-2019-8646.html">The Many Possibilities of CVE-2019-8646</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/08/down-rabbit-hole.html">Down the Rabbit-Hole...</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/08/the-fully-remote-attack-surface-of.html">The Fully Remote Attack Surface of the iPhone</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/05/trashing-flow-of-data.html">Trashing the Flow of Data</a><span> (May)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/04/windows-exploitation-tricks-abusing.html">Windows Exploitation Tricks: Abusing the User-Mode...</a><span> (Apr)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/04/virtually-unlimited-memory-escaping.html">Virtually Unlimited Memory: Escaping the Chrome Sa...</a><span> (Apr)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/04/splitting-atoms-in-xnu.html">Splitting atoms in XNU</a><span> (Apr)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/03/windows-kernel-logic-bug-class-access.html">Windows Kernel Logic Bug Class: Access Mode Mismat...</a><span> (Mar)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/03/android-messaging-few-bugs-short-of.html">Android Messaging: A Few Bugs Short of a Chain</a><span> (Mar)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/02/the-curious-case-of-convexity-confusion.html">The Curious Case of Convexity Confusion</a><span> (Feb)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/02/examining-pointer-authentication-on.html">Examining Pointer Authentication on the iPhone XS</a><span> (Feb)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/01/voucherswap-exploiting-mig-reference.html">voucher_swap: Exploiting MIG reference counting in...</a><span> (Jan)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2019/01/taking-page-from-kernels-book-tlb-issue.html">Taking a page from the kernel&amp;#39;s book: A TLB issue ...</a><span> (Jan)</span></li></ul><hr><div style="font-size: large;">2018</div><ul><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2018/12/on-vbscript.html">On VBScript</a><span> (Dec)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2018/12/searching-statically-linked-vulnerable.html">Searching statically-linked vulnerable library fun...</a><span> (Dec)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2018/12/adventures-in-video-conferencing-part-5.html">Adventures in Video Conferencing Part 5: Where Do ...</a><span> (Dec)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2018/12/adventures-in-video-conferencing-part-4.html">Adventures in Video Conferencing Part 4: What Didn...</a><span> (Dec)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2018/12/adventures-in-video-conferencing-part-3.html">Adventures in Video Conferencing Part 3: The Even ...</a><span> (Dec)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2018/12/adventures-in-video-conferencing-part-2.html">Adventures in Video Conferencing Part 2: Fun with ...</a><span> (Dec)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2018/12/adventures-in-video-conferencing-part-1.html">Adventures in Video Conferencing Part 1: The Wild ...</a><span> (Dec)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2018/11/injecting-code-into-windows-protected.html">Injecting Code into Windows Protected Processes us...</a><span> (Nov)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2018/10/heap-feng-shader-exploiting-swiftshader.html">Heap Feng Shader: Exploiting SwiftShader in Chrome</a><span> (Oct)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2018/10/deja-xnu.html">Deja-XNU</a><span> (Oct)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2018/10/injecting-code-into-windows-protected.html">Injecting Code into Windows Protected Processes us...</a><span> (Oct)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2018/10/365-days-later-finding-and-exploiting.html">365 Days Later: Finding and Exploiting Safari Bugs...</a><span> (Oct)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2018/09/a-cache-invalidation-bug-in-linux.html">A cache invalidation bug in Linux memory management</a><span> (Sep)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2018/09/oatmeal-on-universal-cereal-bus.html">OATmeal on the Universal Cereal Bus: Exploiting An...</a><span> (Sep)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2018/08/the-problems-and-promise-of-webassembly.html">The Problems and Promise of WebAssembly</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2018/08/windows-exploitation-tricks-exploiting.html">Windows Exploitation Tricks: Exploiting Arbitrary ...</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2018/08/adventures-in-vulnerability-reporting.html">Adventures in vulnerability reporting</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2018/07/drawing-outside-box-precision-issues-in.html">Drawing Outside the Box: Precision Issues in Graph...</a><span> (Jul)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2018/06/detecting-kernel-memory-disclosure.html">Detecting Kernel Memory Disclosure – Whitepaper</a><span> (Jun)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2018/05/bypassing-mitigations-by-attacking-jit.html">Bypassing Mitigations by Attacking JIT Server in M...</a><span> (May)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2018/04/windows-exploitation-tricks-exploiting.html">Windows Exploitation Tricks: Exploiting Arbitrary ...</a><span> (Apr)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2018/01/reading-privileged-memory-with-side.html">Reading privileged memory with a side-channel</a><span> (Jan)</span></li></ul><hr><div style="font-size: large;">2017</div><ul><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2017/12/apacolypse-now-exploiting-windows-10-in_18.html">aPAColypse now: Exploiting Windows 10 in a Local N...</a><span> (Dec)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2017/10/over-air-vol-2-pt-3-exploiting-wi-fi.html">Over The Air - Vol. 2, Pt. 3: Exploiting The Wi-Fi...</a><span> (Oct)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2017/10/using-binary-diffing-to-discover.html">Using Binary Diffing to Discover Windows Kernel Me...</a><span> (Oct)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2017/10/over-air-vol-2-pt-2-exploiting-wi-fi.html">Over The Air - Vol. 2, Pt. 2: Exploiting The Wi-Fi...</a><span> (Oct)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2017/09/over-air-vol-2-pt-1-exploiting-wi-fi.html">Over The Air - Vol. 2, Pt. 1: Exploiting The Wi-Fi...</a><span> (Sep)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2017/09/the-great-dom-fuzz-off-of-2017.html">The Great DOM Fuzz-off of 2017</a><span> (Sep)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2017/08/bypassing-virtualbox-process-hardening.html">Bypassing VirtualBox Process Hardening on Windows</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2017/08/windows-exploitation-tricks-arbitrary.html">Windows Exploitation Tricks: Arbitrary Directory C...</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2017/07/trust-issues-exploiting-trustzone-tees.html">Trust Issues: Exploiting TrustZone TEEs</a><span> (Jul)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2017/05/exploiting-linux-kernel-via-packet.html">Exploiting the Linux kernel via packet sockets</a><span> (May)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2017/04/exploiting-net-managed-dcom.html">Exploiting .NET Managed DCOM</a><span> (Apr)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2017/04/exception-oriented-exploitation-on-ios.html">Exception-oriented exploitation on iOS</a><span> (Apr)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2017/04/over-air-exploiting-broadcoms-wi-fi_11.html">Over The Air: Exploiting Broadcom’s Wi-Fi Stack (P...</a><span> (Apr)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2017/04/notes-on-windows-uniscribe-fuzzing.html">Notes on Windows Uniscribe Fuzzing</a><span> (Apr)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2017/04/pandavirtualization-exploiting-xen.html">Pandavirtualization: Exploiting the Xen hypervisor</a><span> (Apr)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2017/04/over-air-exploiting-broadcoms-wi-fi_4.html">Over The Air: Exploiting Broadcom’s Wi-Fi Stack (P...</a><span> (Apr)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2017/03/project-zero-prize-conclusion.html">Project Zero Prize Conclusion</a><span> (Mar)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2017/02/attacking-windows-nvidia-driver.html">Attacking the Windows NVIDIA Driver</a><span> (Feb)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2017/02/lifting-hyper-visor-bypassing-samsungs.html">Lifting the (Hyper) Visor: Bypassing Samsung’s Rea...</a><span> (Feb)</span></li></ul><hr><div style="font-size: large;">2016</div><ul><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2016/12/chrome-os-exploit-one-byte-overflow-and.html">Chrome OS exploit: one byte overflow and symlinks</a><span> (Dec)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2016/12/bitunmap-attacking-android-ashmem.html">BitUnmap: Attacking Android Ashmem</a><span> (Dec)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2016/11/breaking-chain.html">Breaking the Chain</a><span> (Nov)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2016/10/taskt-considered-harmful.html">task_t considered harmful</a><span> (Oct)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2016/09/announcing-project-zero-prize.html">Announcing the Project Zero Prize</a><span> (Sep)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2016/09/return-to-libstagefright-exploiting.html">Return to libstagefright: exploiting libutils on A...</a><span> (Sep)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2016/08/a-shadow-of-our-former-self.html">A Shadow of our Former Self</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2016/07/a-year-of-windows-kernel-font-fuzzing-2.html">A year of Windows kernel font fuzzing #2: the tech...</a><span> (Jul)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2016/06/how-to-compromise-enterprise-endpoint.html">How to Compromise the Enterprise Endpoint</a><span> (Jun)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2016/06/a-year-of-windows-kernel-font-fuzzing-1_27.html">A year of Windows kernel font fuzzing #1: the results</a><span> (Jun)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2016/06/exploiting-recursion-in-linux-kernel_20.html">Exploiting Recursion in the Linux Kernel</a><span> (Jun)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2016/03/life-after-isolated-heap.html">Life After the Isolated Heap</a><span> (Mar)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2016/03/race-you-to-kernel.html">Race you to the kernel!</a><span> (Mar)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2016/03/exploiting-leaked-thread-handle.html">Exploiting a Leaked Thread Handle</a><span> (Mar)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2016/02/the-definitive-guide-on-win32-to-nt.html">The Definitive Guide on Win32 to NT Path Conversion</a><span> (Feb)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2016/02/racing-midi-messages-in-chrome.html">Racing MIDI messages in Chrome</a><span> (Feb)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2016/01/raising-dead.html">Raising the Dead</a><span> (Jan)</span></li></ul><hr><div style="font-size: large;">2015</div><ul><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/12/fireeye-exploitation-project-zeros.html">FireEye Exploitation: Project Zero’s Vulnerability...</a><span> (Dec)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/12/between-rock-and-hard-link.html">Between a Rock and a Hard Link</a><span> (Dec)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/11/windows-sandbox-attack-surface-analysis.html">Windows Sandbox Attack Surface Analysis</a><span> (Nov)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/11/hack-galaxy-hunting-bugs-in-samsung.html">Hack The Galaxy: Hunting Bugs in the Samsung Galax...</a><span> (Nov)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/10/windows-drivers-are-truely-tricky.html">Windows Drivers are True’ly Tricky</a><span> (Oct)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/09/revisiting-apple-ipc-1-distributed_28.html">Revisiting Apple IPC: (1) Distributed Objects</a><span> (Sep)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/09/kaspersky-mo-unpackers-mo-problems.html">Kaspersky: Mo Unpackers, Mo Problems.</a><span> (Sep)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/09/stagefrightened.html">Stagefrightened?</a><span> (Sep)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/09/enabling-qr-codes-in-internet-explorer.html">Enabling QR codes in Internet Explorer, or a story...</a><span> (Sep)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/08/windows-10hh-symbolic-link-mitigations.html">Windows 10^H^H Symbolic Link Mitigations</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/08/one-font-vulnerability-to-rule-them-all_21.html">One font vulnerability to rule them all #4: Window...</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/08/three-bypasses-and-fix-for-one-of.html">Three bypasses and a fix for one of Flash&amp;#39;s Vector...</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/08/attacking-ecmascript-engines-with.html">Attacking ECMAScript Engines with Redefinition</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/08/one-font-vulnerability-to-rule-them-all_13.html">One font vulnerability to rule them all #3: Window...</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/08/one-font-vulnerability-to-rule-them-all.html">One font vulnerability to rule them all #2: Adobe ...</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/07/one-font-vulnerability-to-rule-them-all.html">One font vulnerability to rule them all #1: Introd...</a><span> (Jul)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/07/one-perfect-bug-exploiting-type_20.html">One Perfect Bug: Exploiting Type Confusion in Flash</a><span> (Jul)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/07/significant-flash-exploit-mitigations_16.html">Significant Flash exploit mitigations are live in ...</a><span> (Jul)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/07/from-inter-to-intra-gaining-reliability_10.html">From inter to intra: gaining reliability</a><span> (Jul)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/07/when-int-is-new-short.html">When ‘int’ is the new ‘short’</a><span> (Jul)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/06/what-is-good-memory-corruption.html">What is a &amp;quot;good&amp;quot; memory corruption vulnerability?</a><span> (Jun)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/06/analysis-and-exploitation-of-eset.html">Analysis and Exploitation of an ESET Vulnerability</a><span> (Jun)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/06/owning-internet-printing-case-study-in.html">Owning Internet Printing - A Case Study in Modern ...</a><span> (Jun)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/06/dude-wheres-my-heap.html">Dude, where’s my heap?</a><span> (Jun)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/05/in-console-able.html">In-Console-Able</a><span> (May)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/04/a-tale-of-two-exploits.html">A Tale of Two Exploits</a><span> (Apr)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/03/taming-wild-copy-parallel-thread.html">Taming the wild copy: Parallel Thread Corruption</a><span> (Mar)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/03/exploiting-dram-rowhammer-bug-to-gain.html">Exploiting the DRAM rowhammer bug to gain kernel p...</a><span> (Mar)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/02/feedback-and-data-driven-updates-to.html">Feedback and data-driven updates to Google’s discl...</a><span> (Feb)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/02/exploitingscve-2015-0318sinsflash.html">(^Exploiting)\s*(CVE-2015-0318)\s*(in)\s*(Flash$)</a><span> (Feb)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/02/a-tokens-tale_9.html">A Token’s Tale</a><span> (Feb)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/01/exploiting-nvmap-to-escape-chrome.html">Exploiting NVMAP to escape the Chrome sandbox - CV...</a><span> (Jan)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2015/01/finding-and-exploiting-ntpd.html">Finding and exploiting ntpd vulnerabilities</a><span> (Jan)</span></li></ul><hr><div style="font-size: large;">2014</div><ul><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2014/12/internet-explorer-epm-sandbox-escape.html">Internet Explorer EPM Sandbox Escape CVE-2014-6350</a><span> (Dec)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2014/11/pwn4fun-spring-2014-safari-part-ii.html">pwn4fun Spring 2014 - Safari - Part II</a><span> (Nov)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2014/11/project-zero-patch-tuesday-roundup.html">Project Zero Patch Tuesday roundup, November 2014</a><span> (Nov)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2014/10/did-man-with-no-name-feel-insecure.html">Did the “Man With No Name” Feel Insecure?</a><span> (Oct)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2014/10/more-mac-os-x-and-iphone-sandbox.html">More Mac OS X and iPhone sandbox escapes and kerne...</a><span> (Oct)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2014/09/exploiting-cve-2014-0556-in-flash.html">Exploiting CVE-2014-0556 in Flash</a><span> (Sep)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2014/08/the-poisoned-nul-byte-2014-edition.html">The poisoned NUL byte, 2014 edition</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2014/08/what-does-pointer-look-like-anyway.html">What does a pointer look like, anyway?</a><span> (Aug)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2014/07/mac-os-x-and-iphone-sandbox-escapes.html">Mac OS X and iPhone sandbox escapes</a><span> (Jul)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2014/07/pwn4fun-spring-2014-safari-part-i_24.html">pwn4fun Spring 2014 - Safari - Part I</a><span> (Jul)</span></li><li style="list-style-type: square; list-style-position: inside;"><a href="https://googleprojectzero.blogspot.com/2014/07/announcing-project-zero.html">Announcing Project Zero</a><span> (Jul)</span></li></ul></div>
<script type="text/javascript">
//<![CDATA[
(function(){
  let archive_list = document.getElementById('ArchiveList');
  if (archive_list == null) return;
  let cur_year = archive_list.querySelector('.post-count-link').innerText.trim() - 0;
  let last_year = 2014;
  let elements = [];
  const MONTHS = ',Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec'.split(',');

  let parent = document.getElementById('ArchiveList');
  while (parent.childNodes.length) parent.removeChild(parent.childNodes[0]);

  function fetch_next_year() {
    let url = 'https://googleprojectzero.blogspot.com/?action=getTitles&widgetId=BlogArchive1&widgetType=BlogArchive&responseType=js&path=https%3A%2F%2Fgoogleprojectzero.blogspot.com%2F'+cur_year;
    fetch(url).then(resp => {
      if (!resp.ok) {
        console.log('http error');
        return;
      }
      resp.text().then(text => {
        let scope = {
          _WidgetManager: {
            _HandleControllerResult: (name, method, results) => {
              elements.push(document.createElement('hr'));
              let year_header = document.createElement('div');
              year_header.appendChild(document.createTextNode(cur_year));
              year_header.style.fontSize = 'large';
              elements.push(year_header);

              let list = document.createElement('ul');
              elements.push(list);

              for (let obj of results.posts) {
                let link_parts = obj.url.split('/');
                let year = link_parts[3];
                let month = link_parts[4];

                let el = document.createElement(/*'div'*/'li');
                el.style.listStyleType = 'square';
                el.style.listStylePosition = 'inside';
                let link = document.createElement('a');
                el.appendChild(link);
                link.appendChild(document.createTextNode(obj.title));
                link.href = obj.url;
                let date_trailer = document.createElement('span');
                el.appendChild(date_trailer);
                //date_trailer.appendChild(document.createTextNode(' ('+year+'-'+month+')'));
                date_trailer.appendChild(document.createTextNode(' ('+MONTHS[parseInt(month, 10)]+')'));
                //date_trailer.style.textAlign = 'right';
                //elements.push(el);
                list.appendChild(el);
              }
            }
          }
        };
        with (scope) { eval(text); }
        if (cur_year == last_year) {
          finish();
        } else {
          cur_year--;
          fetch_next_year();
        }
      });
    });
  }
  fetch_next_year();
  function finish() {
    for (let obj of elements) {
      parent.appendChild(obj);
    }
    console.log(elements);
  }
})();
//]]>
</script>
<div class="clear"></div>
</div>
</div></div>
<table border="0" cellpadding="0" cellspacing="0" class="section-columns columns-2">
<tbody>
<tr>
<td class="first columns-cell">
<div class="sidebar no-items section" id="sidebar-right-2-1"></div>
</td>
<td class="columns-cell">
<div class="sidebar no-items section" id="sidebar-right-2-2"></div>
</td>
</tr>
</tbody>
</table>
<div class="sidebar no-items section" id="sidebar-right-3"></div>
</aside>
</div>
</div>
</div>
<div style="clear: both"></div>
<!-- columns -->
</div>
<!-- main -->
</div>
</div>
<div class="main-cap-bottom cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
<footer>
<div class="footer-outer">
<div class="footer-cap-top cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left footer-fauxborder-left">
<div class="fauxborder-right footer-fauxborder-right"></div>
<div class="region-inner footer-inner">
<div class="foot no-items section" id="footer-1"></div>
<table border="0" cellpadding="0" cellspacing="0" class="section-columns columns-2">
<tbody>
<tr>
<td class="first columns-cell">
<div class="foot no-items section" id="footer-2-1"></div>
</td>
<td class="columns-cell">
<div class="foot no-items section" id="footer-2-2"></div>
</td>
</tr>
</tbody>
</table>
<!-- outside of the include in order to lock Attribution widget -->
<div class="foot section" id="footer-3" name="Footer"><div class="widget Attribution" data-version="1" id="Attribution1">
<div class="widget-content" style="text-align: center;">
Simple theme. Powered by <a href="https://www.blogger.com/" target="_blank">Blogger</a>.
</div>
<div class="clear"></div>
</div></div>
</div>
</div>
<div class="footer-cap-bottom cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
</footer>
<!-- content -->
</div>
</div>
<div class="content-cap-bottom cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
</div>
<script type="text/javascript">
    window.setTimeout(function() {
        document.body.className = document.body.className.replace('loading', '');
      }, 10);
  </script>

<script type="text/javascript" src="./2021 - An EPYC escape Case-study of a KVM breakout_files/3630122430-widgets.js.下載"></script>
<script type="text/javascript">
window['__wavt'] = 'AOuZoY7oY4DezqzUsSx356IK8d47s6qHLg:1638484927964';_WidgetManager._Init('//www.blogger.com/rearrange?blogID\x3d4838136820032157985','//googleprojectzero.blogspot.com/2021/06/an-epyc-escape-case-study-of-kvm.html','4838136820032157985');
_WidgetManager._SetDataContext([{'name': 'blog', 'data': {'blogId': '4838136820032157985', 'title': 'Project Zero', 'url': 'https://googleprojectzero.blogspot.com/2021/06/an-epyc-escape-case-study-of-kvm.html', 'canonicalUrl': 'https://googleprojectzero.blogspot.com/2021/06/an-epyc-escape-case-study-of-kvm.html', 'homepageUrl': 'https://googleprojectzero.blogspot.com/', 'searchUrl': 'https://googleprojectzero.blogspot.com/search', 'canonicalHomepageUrl': 'https://googleprojectzero.blogspot.com/', 'blogspotFaviconUrl': 'https://googleprojectzero.blogspot.com/favicon.ico', 'bloggerUrl': 'https://www.blogger.com', 'hasCustomDomain': false, 'httpsEnabled': true, 'enabledCommentProfileImages': true, 'gPlusViewType': 'FILTERED_POSTMOD', 'adultContent': false, 'analyticsAccountNumber': '', 'encoding': 'UTF-8', 'locale': 'en', 'localeUnderscoreDelimited': 'en', 'languageDirection': 'ltr', 'isPrivate': false, 'isMobile': false, 'isMobileRequest': false, 'mobileClass': '', 'isPrivateBlog': false, 'isDynamicViewsAvailable': true, 'feedLinks': '\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22Project Zero - Atom\x22 href\x3d\x22https://googleprojectzero.blogspot.com/feeds/posts/default\x22 /\x3e\n\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/rss+xml\x22 title\x3d\x22Project Zero - RSS\x22 href\x3d\x22https://googleprojectzero.blogspot.com/feeds/posts/default?alt\x3drss\x22 /\x3e\n\x3clink rel\x3d\x22service.post\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22Project Zero - Atom\x22 href\x3d\x22https://www.blogger.com/feeds/4838136820032157985/posts/default\x22 /\x3e\n\n\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22Project Zero - Atom\x22 href\x3d\x22https://googleprojectzero.blogspot.com/feeds/8408446653514773445/comments/default\x22 /\x3e\n', 'meTag': '', 'adsenseHostId': 'ca-host-pub-1556223355139109', 'adsenseHasAds': false, 'adsenseAutoAds': false, 'ieCssRetrofitLinks': '\x3c!--[if IE]\x3e\x3cscript type\x3d\x22text/javascript\x22 src\x3d\x22https://www.blogger.com/static/v1/jsbin/1155466832-ieretrofit.js\x22\x3e\x3c/script\x3e\n\x3c![endif]--\x3e', 'view': '', 'dynamicViewsCommentsSrc': '//www.blogblog.com/dynamicviews/4224c15c4e7c9321/js/comments.js', 'dynamicViewsScriptSrc': '//www.blogblog.com/dynamicviews/3f6f2296c2541ccc', 'plusOneApiSrc': 'https://apis.google.com/js/plusone.js', 'disableGComments': true, 'sharing': {'platforms': [{'name': 'Get link', 'key': 'link', 'shareMessage': 'Get link', 'target': ''}, {'name': 'Facebook', 'key': 'facebook', 'shareMessage': 'Share to Facebook', 'target': 'facebook'}, {'name': 'BlogThis!', 'key': 'blogThis', 'shareMessage': 'BlogThis!', 'target': 'blog'}, {'name': 'Twitter', 'key': 'twitter', 'shareMessage': 'Share to Twitter', 'target': 'twitter'}, {'name': 'Pinterest', 'key': 'pinterest', 'shareMessage': 'Share to Pinterest', 'target': 'pinterest'}, {'name': 'Email', 'key': 'email', 'shareMessage': 'Email', 'target': 'email'}], 'disableGooglePlus': true, 'googlePlusShareButtonWidth': 0, 'googlePlusBootstrap': '\x3cscript type\x3d\x22text/javascript\x22\x3ewindow.___gcfg \x3d {\x27lang\x27: \x27en\x27};\x3c/script\x3e'}, 'hasCustomJumpLinkMessage': false, 'jumpLinkMessage': 'Read more', 'pageType': 'item', 'postId': '8408446653514773445', 'pageName': 'An EPYC escape: Case-study of a KVM breakout', 'pageTitle': 'Project Zero: An EPYC escape: Case-study of a KVM breakout'}}, {'name': 'features', 'data': {'sharing_get_link_dialog': 'true', 'sharing_native': 'false'}}, {'name': 'messages', 'data': {'edit': 'Edit', 'linkCopiedToClipboard': 'Link copied to clipboard!', 'ok': 'Ok', 'postLink': 'Post Link'}}, {'name': 'template', 'data': {'name': 'custom', 'localizedName': 'Custom', 'isResponsive': false, 'isAlternateRendering': false, 'isCustom': true, 'variant': 'simplysimple', 'variantId': 'simplysimple'}}, {'name': 'view', 'data': {'classic': {'name': 'classic', 'url': '?view\x3dclassic'}, 'flipcard': {'name': 'flipcard', 'url': '?view\x3dflipcard'}, 'magazine': {'name': 'magazine', 'url': '?view\x3dmagazine'}, 'mosaic': {'name': 'mosaic', 'url': '?view\x3dmosaic'}, 'sidebar': {'name': 'sidebar', 'url': '?view\x3dsidebar'}, 'snapshot': {'name': 'snapshot', 'url': '?view\x3dsnapshot'}, 'timeslide': {'name': 'timeslide', 'url': '?view\x3dtimeslide'}, 'isMobile': false, 'title': 'An EPYC escape: Case-study of a KVM breakout', 'description': '  Posted by Felix Wilhelm, Project Zero Introduction   KVM (for Kernel-based Virtual Machine) is the de-facto standard hypervisor for Linux-...', 'url': 'https://googleprojectzero.blogspot.com/2021/06/an-epyc-escape-case-study-of-kvm.html', 'type': 'item', 'isSingleItem': true, 'isMultipleItems': false, 'isError': false, 'isPage': false, 'isPost': true, 'isHomepage': false, 'isArchive': false, 'isLabelSearch': false, 'postId': 8408446653514773445}}]);
_WidgetManager._RegisterWidget('_NavbarView', new _WidgetInfo('Navbar1', 'navbar', document.getElementById('Navbar1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_HeaderView', new _WidgetInfo('Header1', 'header', document.getElementById('Header1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogView', new _WidgetInfo('Blog1', 'main', document.getElementById('Blog1'), {'cmtInteractionsEnabled': false, 'lightboxEnabled': true, 'lightboxModuleUrl': 'https://www.blogger.com/static/v1/jsbin/2908359363-lbx.js', 'lightboxCssUrl': 'https://www.blogger.com/static/v1/v-css/4076883957-lightbox_bundle.css'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogSearchView', new _WidgetInfo('BlogSearch1', 'sidebar-right-1', document.getElementById('BlogSearch1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_PageListView', new _WidgetInfo('PageList1', 'sidebar-right-1', document.getElementById('PageList1'), {'title': 'Pages', 'links': [{'isCurrentPage': false, 'href': 'https://googleprojectzero.blogspot.com/p/about-project-zero.html', 'id': '4384467920505278144', 'title': 'About Project Zero'}, {'isCurrentPage': false, 'href': 'https://googleprojectzero.blogspot.com/p/working-at-project-zero.html', 'id': '2459334498880008057', 'title': 'Working at Project Zero'}, {'isCurrentPage': false, 'href': 'https://googleprojectzero.blogspot.com/p/0day.html', 'id': '3414239791814532209', 'title': '0day \x22In the Wild\x22'}, {'isCurrentPage': false, 'href': 'https://googleprojectzero.github.io/0days-in-the-wild/rca.html', 'title': '0day Exploit Root Cause Analyses'}, {'isCurrentPage': false, 'href': 'https://googleprojectzero.blogspot.com/p/vulnerability-disclosure-faq.html', 'id': '2935252455704572784', 'title': 'Vulnerability Disclosure FAQ'}], 'mobile': false}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogArchiveView', new _WidgetInfo('BlogArchive1', 'sidebar-right-1', document.getElementById('BlogArchive1'), {'languageDirection': 'ltr', 'loadingMessage': 'Loading\x26hellip;'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_AttributionView', new _WidgetInfo('Attribution1', 'footer-3', document.getElementById('Attribution1'), {}, 'displayModeFull'));
</script>

</body></html>