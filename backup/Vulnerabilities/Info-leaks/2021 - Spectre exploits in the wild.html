<!DOCTYPE html>
<!-- saved from url=(0054)https://dustri.org/b/spectre-exploits-in-the-wild.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#3c78a0">
  <meta name="description" content="Personal blog of Julien (jvoisin) Voisin">
  <meta name="twitter:site" content="@dustriorg">
  <title>Spectre exploits in the "wild"</title>
  <link href="./2021 - Spectre exploits in the wild_files/full.css" type="text/css" rel="stylesheet">
  <link rel="alternate" href="https://dustri.org/b/atom.xml" type="application/atom+xml" title="Atom Feed">
  <link rel="alternate" href="https://dustri.org/b/rss.xml" type="application/rss+xml" title="RSS Feed">
  <link rel="shortcut icon" href="https://dustri.org/static/favicon.jpg">
  <script src="./2021 - Spectre exploits in the wild_files/quotes.js.下載" async="" defer=""></script>
</head>
<body>
  <div class="container">
    <div class="row">
      <header>
        <h1 class="float-left" data-text="Artificial truth">
          <a href="https://dustri.org/b/">Artificial truth</a>
        </h1>
        <h3 class="float-right">
          <a href="https://dustri.org/b/archives.html">archives</a> |
          <a href="https://dustri.org/b/index.html">latest</a> |
          <a href="https://dustri.org/b/">homepage</a> |
          <a href="https://dustri.org/b/atom.xml">atom</a>/<a href="https://dustri.org/b/rss.xml">rss</a>/<a href="https://twitter.com/dustriorg">twitter</a>
        </h3>
        <div class="fix"></div>
        <div id="subtitle">
            <div id="divider"></div>
            <div id="quote">Avoid the darkness, stay away, stay out of sight, until you feel the blast of a shooting star.</div>
        </div>
      </header>
    </div>
    <div class="row">
<section id="content" class="body">
  <article>
    <header>
      <h2 class="title">
        <a href="https://dustri.org/b/spectre-exploits-in-the-wild.html" rel="bookmark" title="Permalink to Spectre exploits in the " wild""="">
            Spectre exploits in the "wild"
        </a>
<div class="date" title="2021-03-01T11:00:00+01:00">
        Mon 01 March 2021 — <a class="source" href="https://dustri.org/b/spectre-exploits-in-the-wild.markdown">download</a><br>
</div>      </h2>
    </header>
    <div class="entry-content">
      <p>Someone was silly enough to upload a
<a href="https://www.virustotal.com/gui/file/6461d0988c835e91eb534757a9fa3ab35afe010bec7d5406d4dfb30ea767a62c">working spectre (CVE-2017-5753) exploit</a>
for Linux (there is also a
<a href="https://www.virustotal.com/gui/file/ecc0f2aa29b102bf8d67b7d7173e8698c0341ddfdf9757be17595460fbf1791a">Windows one</a> with symbols that I didn't look at.)
on VirusTotal last month, so here is my quick Sunday afternoon lazy analysis.</p>
<p>The binary has its <code>-h</code> option stripped, likely behind a <code>#define</code> to avoid
detection, but some of its parameters are obvious, like specifying
what file to leak, or the kernel base address. The authors didn't check (or care)
that the logging function hasn't been entirely optimized out, leaving a bunch
of strings helping in the reversing process.</p>
<p>The exploit works in four stages:</p>
<ol>
<li>Find the <a href="https://www.halolinux.us/kernel-reference/inode-objects.html">superblock</a>,</li>
<li>Find the <a href="https://en.wikipedia.org/wiki/Inode">inode</a> of the file to dump</li>
<li>Find the corresponding page address</li>
<li>Dumps the content of the file.</li>
</ol>
<p>In the case of <code>/etc/shadow</code>, the default option, the content of the
file is shoved in memory by running the following command in the
background: <code>return system("echo \"whatever\n\" | su - 2&gt; /dev/null")</code>.
In my lab, on a vulnerable Fedora, the exploit is successfully dumping <code>/etc/shadow</code> in a couple of minutes.
Interestingly, there are checks to detect <a href="https://en.wikipedia.org/wiki/Supervisor_Mode_Access_Prevention">SMAP</a>
and abort if it's present. I didn't manage to understand why the exploit was
failing in its presence.</p>
<p>edit: <a href="https://github.com/andyhhp">Andrew Cooper</a> from Citrix was kind enough to reach out and solve the riddle:</p>
<blockquote>
<p>The covert channel is presumably a userspace pointer which is accessed
speculatively in kernel context, causing a cacheline fill, and recovered
later by timing the reload.   SMAP prevents supervisor code from
accessing user memory operands outside of explicitly permitted areas.
This is enough to prevent the cacheline fill (of a userspace pointer)
and break the covert channel. A more sophisticated attack could use a
supervisor pointer, e.g. the directmap mapping, or or one of a multitude
of other covert channels to transmit the same data, which is a higher
barrier, but definitely not impossible.</p>
</blockquote>
<p>The crux of the exploit is at <code>0x4092f0</code>, using <code>cpuid</code> as a serializing
instruction, <code>rdtsc</code> for timing, and <code>mfence</code>/<code>lfence</code> as barrier, as
documented in the paper. It's also using some tricks to minimize the amount of
readings, like type-specific functions, for example a kernel address has a
specific <em>format</em>.
Thanks to <a href="https://twitter.com/spendergrsec">spender</a> for confirming that the gadget used is likely <code>get_user()</code> in the <code>FIOASYNC ioctl</code>,
which was <a href="https://patchwork.kernel.org/project/kernel-hardening/patch/20180209133935.811950747@linuxfoundation.org/">fixed in 2018</a></p>
<p><a href="https://en.wikipedia.org/wiki/KASLR">KASLR</a> is bypassed when present either by
looking at <code>/proc/kallsyms</code> when available to unprivileged users like it used
to be the case on Fedora until ~recently, or by using the generic
bypass from the <a href="https://gruss.cc/files/prefetch.pdf">prefetch side-channel</a> by Gruss and al.
originating from a library called <code>libkaslr</code>. Amusingly, this method is still
working on an up to date Linux, proving again that <a href="https://grsecurity.net/kaslr_an_exercise_in_cargo_cult_security">KASLR is useless at
best</a>.
For systems that don't have the <code>/proc/kallsym</code> file accessible, the exploit
relies on hardcoded offsets, and while only Fedora, ArchLinux and Ubuntu are currently
supported, there are functions to check for Debian and CentOS. It's a bit
surprising to see hardcoded offsets in an exploit with arbitrary read in
2021.</p>
<p>Unsurprisingly, it had a 
<a href="https://www.virustotal.com/gui/file/6461d0988c835e91eb534757a9fa3ab35afe010bec7d5406d4dfb30ea767a62c/detection">0 detection</a>
rate before I published this blogpost.</p>
<p>Attribution is trivial and left as an exercise to the reader.</p>
    </div>
  </article>
</section>
    </div>
    <hr>
    <div class="row">
      <footer>
        2011-2021 -
        Julien (<a rel="author" href="https://dustri.org/">jvoisin</a>) Voisin -
        <a href="https://creativecommons.org/licenses/by-sa/4.0" rel="license">CC BY-SA</a> -
        <a href="https://dustri.org/b/archives.html">archives</a> -
        <a href="https://dustri.org/b/atom.xml">atom</a>/<a href="https://dustri.org/b/rss.xml">rss</a>/
        <a href="https://twitter.com/dustriorg">twitter</a> -
        ♥
      </footer>
    </div>
  </div>

</body></html>