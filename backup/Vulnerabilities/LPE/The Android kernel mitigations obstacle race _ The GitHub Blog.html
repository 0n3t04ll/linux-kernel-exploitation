<!DOCTYPE html>
<!-- saved from url=(0076)https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/ -->
<html lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="profile" href="https://gmpg.org/xfn/11">
	<link rel="icon" type="image/x-icon" href="https://github.githubassets.com/favicon.ico">
	<meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">

	<!-- This site is optimized with the Yoast SEO Premium plugin v17.0 (Yoast SEO v19.1) - https://yoast.com/wordpress/plugins/seo/ -->
	<title>The Android kernel mitigations obstacle race | The GitHub Blog</title>
	<meta name="description" content="In this post I’ll exploit CVE-2022-22057, a use-after-free in the Qualcomm gpu kernel driver, to gain root and disable SELinux from the untrusted app sandbox on a Samsung Z flip 3. I’ll look at various mitigations that are implemented on modern Android devices and how they affect the exploit.">
	<link rel="canonical" href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/">
	<meta property="og:locale" content="en_US">
	<meta property="og:type" content="article">
	<meta property="og:title" content="The Android kernel mitigations obstacle race | The GitHub Blog">
	<meta property="og:description" content="In this post I’ll exploit CVE-2022-22057, a use-after-free in the Qualcomm gpu kernel driver, to gain root and disable SELinux from the untrusted app sandbox on a Samsung Z flip 3. I’ll look at various mitigations that are implemented on modern Android devices and how they affect the exploit.">
	<meta property="og:url" content="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/">
	<meta property="og:site_name" content="The GitHub Blog">
	<meta property="article:publisher" content="https://www.facebook.com/GitHub">
	<meta property="article:published_time" content="2022-06-16T16:00:52+00:00">
	<meta property="article:modified_time" content="2022-06-14T16:33:42+00:00">
	<meta property="og:image" content="https://github.blog/wp-content/uploads/2021/12/GitHub-security_teal-banner.png?fit=1200%2C630">
	<meta property="og:image:width" content="1200">
	<meta property="og:image:height" content="630">
	<meta property="og:image:type" content="image/png">
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:description" content="In this post I’ll exploit CVE-2022-22057, a use-after-free in the Qualcomm gpu kernel driver, to gain root and disable SELinux from the untrusted app sandbox on a Samsung Z flip 3. I’ll look at various mitigations that are implemented on modern Android devices and how they affect the exploit.">
	<meta name="twitter:creator" content="@github">
	<meta name="twitter:site" content="@github">
	<meta name="twitter:label1" content="Written by">
	<meta name="twitter:data1" content="Man Yue Mo">
	<meta name="twitter:label2" content="Est. reading time">
	<meta name="twitter:data2" content="59 minutes">
	<script type="application/ld+json" class="yoast-schema-graph">{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://github.blog/#organization","name":"GitHub","url":"https://github.blog/","sameAs":["https://www.instagram.com/github/","https://www.linkedin.com/company/github/","https://www.youtube.com/GitHub","https://en.wikipedia.org/wiki/GitHub","https://www.facebook.com/GitHub","https://twitter.com/github"],"logo":{"@type":"ImageObject","inLanguage":"en-US","@id":"https://github.blog/#/schema/logo/image/","url":"https://github.blog/wp-content/uploads/2019/01/cropped-github-favicon-512.png?fit=512%2C512","contentUrl":"https://github.blog/wp-content/uploads/2019/01/cropped-github-favicon-512.png?fit=512%2C512","width":512,"height":512,"caption":"GitHub"},"image":{"@id":"https://github.blog/#/schema/logo/image/"}},{"@type":"WebSite","@id":"https://github.blog/#website","url":"https://github.blog/","name":"The GitHub Blog","description":"Updates, ideas, and inspiration from GitHub to help developers build and design software.","publisher":{"@id":"https://github.blog/#organization"},"potentialAction":[{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":"https://github.blog/?s={search_term_string}"},"query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"ImageObject","inLanguage":"en-US","@id":"https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#primaryimage","url":"https://github.blog/wp-content/uploads/2021/12/GitHub-security_teal-banner.png?fit=1200%2C630","contentUrl":"https://github.blog/wp-content/uploads/2021/12/GitHub-security_teal-banner.png?fit=1200%2C630","width":1200,"height":630},{"@type":"WebPage","@id":"https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#webpage","url":"https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/","name":"The Android kernel mitigations obstacle race | The GitHub Blog","isPartOf":{"@id":"https://github.blog/#website"},"primaryImageOfPage":{"@id":"https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#primaryimage"},"datePublished":"2022-06-16T16:00:52+00:00","dateModified":"2022-06-14T16:33:42+00:00","description":"In this post I’ll exploit CVE-2022-22057, a use-after-free in the Qualcomm gpu kernel driver, to gain root and disable SELinux from the untrusted app sandbox on a Samsung Z flip 3. I’ll look at various mitigations that are implemented on modern Android devices and how they affect the exploit.","breadcrumb":{"@id":"https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#breadcrumb"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/"]}]},{"@type":"BreadcrumbList","@id":"https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#breadcrumb","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https://github.blog/"},{"@type":"ListItem","position":2,"name":"The Android kernel mitigations obstacle race"}]},{"@type":"Article","@id":"https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#article","isPartOf":{"@id":"https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#webpage"},"author":{"@id":"https://github.blog/#/schema/person/0ac0c5700a6f36214989d4391dbf21b1"},"headline":"The Android kernel mitigations obstacle race","datePublished":"2022-06-16T16:00:52+00:00","dateModified":"2022-06-14T16:33:42+00:00","mainEntityOfPage":{"@id":"https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#webpage"},"wordCount":8851,"publisher":{"@id":"https://github.blog/#organization"},"image":{"@id":"https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#primaryimage"},"thumbnailUrl":"https://github.blog/wp-content/uploads/2021/12/GitHub-security_teal-banner.png?fit=1200%2C630","keywords":["GitHub Security Lab"],"articleSection":["Security"],"inLanguage":"en-US"},{"@type":"Person","@id":"https://github.blog/#/schema/person/0ac0c5700a6f36214989d4391dbf21b1","name":"Man Yue Mo","image":{"@type":"ImageObject","inLanguage":"en-US","@id":"https://github.blog/#/schema/person/image/","url":"https://secure.gravatar.com/avatar/8a8f99ca8890a5763d897493ac1f4918?s=96&d=mm&r=g","contentUrl":"https://secure.gravatar.com/avatar/8a8f99ca8890a5763d897493ac1f4918?s=96&d=mm&r=g","caption":"Man Yue Mo"},"url":"https://github.blog/author/mymo/"}]}</script>
	<!-- / Yoast SEO Premium plugin. -->


<link rel="dns-prefetch" href="https://cdn.parsely.com/">
<link rel="dns-prefetch" href="https://cdnjs.cloudflare.com/">
<link rel="dns-prefetch" href="https://s.w.org/">
<link rel="dns-prefetch" href="https://v0.wordpress.com/">
<link rel="alternate" type="application/rss+xml" title="The GitHub Blog » Feed" href="https://github.blog/feed/">
<link rel="alternate" type="application/rss+xml" title="The GitHub Blog » Comments Feed" href="https://github.blog/comments/feed/">
<script>
window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/14.0.0\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/14.0.0\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/github.blog\/wp-includes\/js\/wp-emoji-release.min.js?ver=6.0"}};
/*! This file is auto-generated */
!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode,e=(p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0),i.toDataURL());return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([129777,127995,8205,129778,127999],[129777,127995,8203,129778,127999])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(e=t.source||{}).concatemoji?c(e.concatemoji):e.wpemoji&&e.twemoji&&(c(e.twemoji),c(e.wpemoji)))}(window,document,window._wpemojiSettings);
</script><script src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/wp-emoji-release.min.js.下載" type="text/javascript" defer=""></script>
<style>
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 0.07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel="stylesheet" id="all-css-0" href="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/saved_resource" type="text/css" media="all">
<style id="wp-block-library-inline-css">
.has-text-align-justify{text-align:justify;}
</style>
<style id="global-styles-inline-css">
body{--wp--preset--color--black: #000000;--wp--preset--color--cyan-bluish-gray: #abb8c3;--wp--preset--color--white: #ffffff;--wp--preset--color--pale-pink: #f78da7;--wp--preset--color--vivid-red: #cf2e2e;--wp--preset--color--luminous-vivid-orange: #ff6900;--wp--preset--color--luminous-vivid-amber: #fcb900;--wp--preset--color--light-green-cyan: #7bdcb5;--wp--preset--color--vivid-green-cyan: #00d084;--wp--preset--color--pale-cyan-blue: #8ed1fc;--wp--preset--color--vivid-cyan-blue: #0693e3;--wp--preset--color--vivid-purple: #9b51e0;--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple: linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%);--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan: linear-gradient(135deg,rgb(122,220,180) 0%,rgb(0,208,130) 100%);--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange: linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%);--wp--preset--gradient--luminous-vivid-orange-to-vivid-red: linear-gradient(135deg,rgba(255,105,0,1) 0%,rgb(207,46,46) 100%);--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray: linear-gradient(135deg,rgb(238,238,238) 0%,rgb(169,184,195) 100%);--wp--preset--gradient--cool-to-warm-spectrum: linear-gradient(135deg,rgb(74,234,220) 0%,rgb(151,120,209) 20%,rgb(207,42,186) 40%,rgb(238,44,130) 60%,rgb(251,105,98) 80%,rgb(254,248,76) 100%);--wp--preset--gradient--blush-light-purple: linear-gradient(135deg,rgb(255,206,236) 0%,rgb(152,150,240) 100%);--wp--preset--gradient--blush-bordeaux: linear-gradient(135deg,rgb(254,205,165) 0%,rgb(254,45,45) 50%,rgb(107,0,62) 100%);--wp--preset--gradient--luminous-dusk: linear-gradient(135deg,rgb(255,203,112) 0%,rgb(199,81,192) 50%,rgb(65,88,208) 100%);--wp--preset--gradient--pale-ocean: linear-gradient(135deg,rgb(255,245,203) 0%,rgb(182,227,212) 50%,rgb(51,167,181) 100%);--wp--preset--gradient--electric-grass: linear-gradient(135deg,rgb(202,248,128) 0%,rgb(113,206,126) 100%);--wp--preset--gradient--midnight: linear-gradient(135deg,rgb(2,3,129) 0%,rgb(40,116,252) 100%);--wp--preset--duotone--dark-grayscale: url('#wp-duotone-dark-grayscale');--wp--preset--duotone--grayscale: url('#wp-duotone-grayscale');--wp--preset--duotone--purple-yellow: url('#wp-duotone-purple-yellow');--wp--preset--duotone--blue-red: url('#wp-duotone-blue-red');--wp--preset--duotone--midnight: url('#wp-duotone-midnight');--wp--preset--duotone--magenta-yellow: url('#wp-duotone-magenta-yellow');--wp--preset--duotone--purple-green: url('#wp-duotone-purple-green');--wp--preset--duotone--blue-orange: url('#wp-duotone-blue-orange');--wp--preset--font-size--small: 13px;--wp--preset--font-size--medium: 20px;--wp--preset--font-size--large: 36px;--wp--preset--font-size--x-large: 42px;}.has-black-color{color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-color{color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-color{color: var(--wp--preset--color--white) !important;}.has-pale-pink-color{color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-color{color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-color{color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-color{color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-color{color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-color{color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-color{color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-color{color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-color{color: var(--wp--preset--color--vivid-purple) !important;}.has-black-background-color{background-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-background-color{background-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}.has-pale-pink-background-color{background-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-background-color{background-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-background-color{background-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-background-color{background-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-background-color{background-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-background-color{background-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-background-color{background-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-background-color{background-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-background-color{background-color: var(--wp--preset--color--vivid-purple) !important;}.has-black-border-color{border-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-border-color{border-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}.has-pale-pink-border-color{border-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-border-color{border-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-border-color{border-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-border-color{border-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-border-color{border-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-border-color{border-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-border-color{border-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-border-color{border-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-border-color{border-color: var(--wp--preset--color--vivid-purple) !important;}.has-vivid-cyan-blue-to-vivid-purple-gradient-background{background: var(--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple) !important;}.has-light-green-cyan-to-vivid-green-cyan-gradient-background{background: var(--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan) !important;}.has-luminous-vivid-amber-to-luminous-vivid-orange-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange) !important;}.has-luminous-vivid-orange-to-vivid-red-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-orange-to-vivid-red) !important;}.has-very-light-gray-to-cyan-bluish-gray-gradient-background{background: var(--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray) !important;}.has-cool-to-warm-spectrum-gradient-background{background: var(--wp--preset--gradient--cool-to-warm-spectrum) !important;}.has-blush-light-purple-gradient-background{background: var(--wp--preset--gradient--blush-light-purple) !important;}.has-blush-bordeaux-gradient-background{background: var(--wp--preset--gradient--blush-bordeaux) !important;}.has-luminous-dusk-gradient-background{background: var(--wp--preset--gradient--luminous-dusk) !important;}.has-pale-ocean-gradient-background{background: var(--wp--preset--gradient--pale-ocean) !important;}.has-electric-grass-gradient-background{background: var(--wp--preset--gradient--electric-grass) !important;}.has-midnight-gradient-background{background: var(--wp--preset--gradient--midnight) !important;}.has-small-font-size{font-size: var(--wp--preset--font-size--small) !important;}.has-medium-font-size{font-size: var(--wp--preset--font-size--medium) !important;}.has-large-font-size{font-size: var(--wp--preset--font-size--large) !important;}.has-x-large-font-size{font-size: var(--wp--preset--font-size--x-large) !important;}
</style>
<link rel="stylesheet" id="all-css-2" href="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/site.min.css" type="text/css" media="all">
<link rel="stylesheet" id="highlightjs-css-css" href="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/default.min.css" media="all">
<link rel="stylesheet" id="all-css-4" href="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/jetpack.css" type="text/css" media="all">
<link rel="https://api.w.org/" href="https://github.blog/wp-json/"><link rel="alternate" type="application/json" href="https://github.blog/wp-json/wp/v2/posts/65495"><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://github.blog/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://github.blog/wp-includes/wlwmanifest.xml"> 
<meta name="generator" content="WordPress 6.0">
<link rel="shortlink" href="https://wp.me/pamS32-h2n">
<link rel="alternate" type="application/json+oembed" href="https://github.blog/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fgithub.blog%2F2022-06-16-the-android-kernel-mitigations-obstacle-race%2F">
<link rel="alternate" type="text/xml+oembed" href="https://github.blog/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fgithub.blog%2F2022-06-16-the-android-kernel-mitigations-obstacle-race%2F&amp;format=xml">
<meta name="parsely-title" content="The Android kernel mitigations obstacle race">
<meta name="parsely-link" content="http://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/">
<meta name="parsely-type" content="post">
<meta name="parsely-image-url" content="https://github.blog/wp-content/uploads/2021/12/GitHub-security_teal-banner.png?resize=150%2C150">
<meta name="parsely-pub-date" content="2022-06-16T16:00:52Z">
<meta name="parsely-section" content="Security">
<meta name="parsely-tags" content="github security lab">
<meta name="parsely-author" content="Man Yue Mo">
<style>img#wpstats{display:none}</style>
	<meta name="ha-url" content="https://collector.githubapp.com/github-blog/collect"><link rel="preload" href="https://github.blog/wp-content/themes/github-2021/assets/fonts/alliance/Alliance-No-1-ExtraBold.woff2" as="font" type="font/woff2" crossorigin="anonymous"><link rel="preload" href="https://github.blog/wp-content/themes/github-2021/assets/fonts/alliance/Alliance-No-1-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous"><link rel="preload" href="https://github.blog/wp-content/themes/github-2021/assets/fonts/alliance/Alliance-No-1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous"><link rel="icon" href="https://github.blog/wp-content/uploads/2019/01/cropped-github-favicon-512.png?fit=32%2C32" sizes="32x32">
<link rel="icon" href="https://github.blog/wp-content/uploads/2019/01/cropped-github-favicon-512.png?fit=192%2C192" sizes="192x192">
<link rel="apple-touch-icon" href="https://github.blog/wp-content/uploads/2019/01/cropped-github-favicon-512.png?fit=180%2C180">
<meta name="msapplication-TileImage" content="https://github.blog/wp-content/uploads/2019/01/cropped-github-favicon-512.png?fit=270%2C270">
</head>

<body class="post-template-default single single-post postid-65495 single-format-standard font-mktg no-sidebar">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;"><defs><filter id="wp-duotone-dark-grayscale"><fecolormatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></fecolormatrix><fecomponenttransfer color-interpolation-filters="sRGB"><fefuncr type="table" tableValues="0 0.49803921568627"></fefuncr><fefuncg type="table" tableValues="0 0.49803921568627"></fefuncg><fefuncb type="table" tableValues="0 0.49803921568627"></fefuncb><fefunca type="table" tableValues="1 1"></fefunca></fecomponenttransfer><fecomposite in2="SourceGraphic" operator="in"></fecomposite></filter></defs></svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;"><defs><filter id="wp-duotone-grayscale"><fecolormatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></fecolormatrix><fecomponenttransfer color-interpolation-filters="sRGB"><fefuncr type="table" tableValues="0 1"></fefuncr><fefuncg type="table" tableValues="0 1"></fefuncg><fefuncb type="table" tableValues="0 1"></fefuncb><fefunca type="table" tableValues="1 1"></fefunca></fecomponenttransfer><fecomposite in2="SourceGraphic" operator="in"></fecomposite></filter></defs></svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;"><defs><filter id="wp-duotone-purple-yellow"><fecolormatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></fecolormatrix><fecomponenttransfer color-interpolation-filters="sRGB"><fefuncr type="table" tableValues="0.54901960784314 0.98823529411765"></fefuncr><fefuncg type="table" tableValues="0 1"></fefuncg><fefuncb type="table" tableValues="0.71764705882353 0.25490196078431"></fefuncb><fefunca type="table" tableValues="1 1"></fefunca></fecomponenttransfer><fecomposite in2="SourceGraphic" operator="in"></fecomposite></filter></defs></svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;"><defs><filter id="wp-duotone-blue-red"><fecolormatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></fecolormatrix><fecomponenttransfer color-interpolation-filters="sRGB"><fefuncr type="table" tableValues="0 1"></fefuncr><fefuncg type="table" tableValues="0 0.27843137254902"></fefuncg><fefuncb type="table" tableValues="0.5921568627451 0.27843137254902"></fefuncb><fefunca type="table" tableValues="1 1"></fefunca></fecomponenttransfer><fecomposite in2="SourceGraphic" operator="in"></fecomposite></filter></defs></svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;"><defs><filter id="wp-duotone-midnight"><fecolormatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></fecolormatrix><fecomponenttransfer color-interpolation-filters="sRGB"><fefuncr type="table" tableValues="0 0"></fefuncr><fefuncg type="table" tableValues="0 0.64705882352941"></fefuncg><fefuncb type="table" tableValues="0 1"></fefuncb><fefunca type="table" tableValues="1 1"></fefunca></fecomponenttransfer><fecomposite in2="SourceGraphic" operator="in"></fecomposite></filter></defs></svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;"><defs><filter id="wp-duotone-magenta-yellow"><fecolormatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></fecolormatrix><fecomponenttransfer color-interpolation-filters="sRGB"><fefuncr type="table" tableValues="0.78039215686275 1"></fefuncr><fefuncg type="table" tableValues="0 0.94901960784314"></fefuncg><fefuncb type="table" tableValues="0.35294117647059 0.47058823529412"></fefuncb><fefunca type="table" tableValues="1 1"></fefunca></fecomponenttransfer><fecomposite in2="SourceGraphic" operator="in"></fecomposite></filter></defs></svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;"><defs><filter id="wp-duotone-purple-green"><fecolormatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></fecolormatrix><fecomponenttransfer color-interpolation-filters="sRGB"><fefuncr type="table" tableValues="0.65098039215686 0.40392156862745"></fefuncr><fefuncg type="table" tableValues="0 1"></fefuncg><fefuncb type="table" tableValues="0.44705882352941 0.4"></fefuncb><fefunca type="table" tableValues="1 1"></fefunca></fecomponenttransfer><fecomposite in2="SourceGraphic" operator="in"></fecomposite></filter></defs></svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;"><defs><filter id="wp-duotone-blue-orange"><fecolormatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></fecolormatrix><fecomponenttransfer color-interpolation-filters="sRGB"><fefuncr type="table" tableValues="0.098039215686275 1"></fefuncr><fefuncg type="table" tableValues="0 0.66274509803922"></fefuncg><fefuncb type="table" tableValues="0.84705882352941 0.41960784313725"></fefuncb><fefunca type="table" tableValues="1 1"></fefunca></fecomponenttransfer><fecomposite in2="SourceGraphic" operator="in"></fecomposite></filter></defs></svg>
<header class="position-relative z-3">

		<div data-color-mode="dark" data-light-theme="light" data-dark-theme="dark_dimmed" class="border-bottom color-border-muted">
	<nav class="nav-header-with-logo nav-bar-include-search container-xl mx-auto p-responsive-blog position-relative">
		<div class="d-flex flex-justify-between flex-items-center pt-3 pb-3 color-fg-default">
      <div class="d-flex flex-items-center">
        <a href="https://github.com/" target="_blank" rel="noreferrer" title="Visit GitHub" class="Header-link color-fg-default">
          <svg aria-hidden="true" role="img" class="octicon octicon-mark-github d-block" viewBox="0 0 16 16" width="32" height="32" fill="currentColor" style="display:inline-block;user-select:none;vertical-align:text-bottom;overflow:visible"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
        </a>
        <span class="d-inline-block ml-2 f1-mktg f2-md-mktg" style="opacity: 0.3;">/</span>
        <a class="d-inline-block Header-link font-weight-semibold ml-2 f2 color-fg-default" href="https://github.blog/">Blog</a>
      </div>

			<div class="p-plus-container" data-container="true">
      <div data-main="" class="p-plus p-plus--is-showing-toggle">
        <div class="p-plus__primary-wrapper" data-primary-nav-wrapper=""><ul class="d-flex flex-row flex-nowrap overflow-hidden flex-grow-0 list-style-none js-p-target p-plus__primary" style="margin-left: auto;" data-primary-nav="" aria-hidden="false"><li class="ml-4 p-plus__primary-nav-item" data-nav-item=""><a href="https://github.blog/category/engineering/" class="d-block no-wrap f4-mktg color-fg-default text-medium">Engineering</a></li><li class="ml-4 p-plus__primary-nav-item" data-nav-item=""><a href="https://github.blog/category/community/" class="d-block no-wrap f4-mktg color-fg-default text-medium">Community</a></li><li class="ml-4 p-plus__primary-nav-item" data-nav-item=""><a href="https://github.blog/category/product/" class="d-block no-wrap f4-mktg color-fg-default text-medium">Product</a></li><li class="ml-4 p-plus__primary-nav-item" data-nav-item=""><a href="https://github.blog/category/security/" class="d-block no-wrap f4-mktg color-fg-default text-medium">Security</a></li><li class="ml-4 p-plus__primary-nav-item" data-nav-item=""><a href="https://github.blog/category/open-source/" class="d-block no-wrap f4-mktg color-fg-default text-medium">Open Source</a></li><li class="ml-4 p-plus__primary-nav-item" data-nav-item=""><a href="https://github.blog/category/enterprise/" class="d-block no-wrap f4-mktg color-fg-default text-medium">Enterprise</a></li><li class="ml-4 p-plus__primary-nav-item" data-nav-item=""><a href="https://github.blog/changelog/" class="d-block no-wrap f4-mktg color-fg-default text-medium">Changelog</a></li></ul></div>
        <button data-toggle-btn="" class="p-plus__toggle-btn btn-invisible f4-mktg text-medium btn-link no-underline ml-4 color-fg-default flex-shrink-0 text-right no-wrap" aria-expanded="false"> More<svg xmlns="http://www.w3.org/2000/svg" class="octicon octicon-chevron-down ml-1" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M12.78 6.22a.75.75 0 010 1.06l-4.25 4.25a.75.75 0 01-1.06 0L3.22 7.28a.75.75 0 011.06-1.06L8 9.94l3.72-3.72a.75.75 0 011.06 0z"></path></svg></button>
        <ul data-overflow-nav="" class="p-plus__overflow" aria-hidden="true"><li class="ml-4 p-plus__primary-nav-item" data-nav-item=""><a href="https://github.blog/category/education/" class="d-block no-wrap f4-mktg color-fg-default text-medium">Education</a></li><li class="ml-4 p-plus__primary-nav-item" data-nav-item=""><a href="https://github.blog/category/company/" class="d-block no-wrap f4-mktg color-fg-default text-medium">Company</a></li></ul>
      </div>
    
      <div data-main="" class="p-plus p-plus--clone p-plus--is-showing-toggle" aria-hidden="true" data-clone="true">
        <div class="p-plus__primary-wrapper" data-primary-nav-wrapper=""><ul class="d-flex flex-row flex-nowrap overflow-hidden flex-grow-0 list-style-none js-p-target p-plus__primary" style="margin-left: auto;" data-primary-nav="">
			<li class="ml-4 p-plus__primary-nav-item" data-nav-item=""><a href="https://github.blog/category/engineering/" class="d-block no-wrap f4-mktg color-fg-default text-medium">Engineering</a></li><li class="ml-4 p-plus__primary-nav-item" data-nav-item=""><a href="https://github.blog/category/community/" class="d-block no-wrap f4-mktg color-fg-default text-medium">Community</a></li><li class="ml-4 p-plus__primary-nav-item" data-nav-item=""><a href="https://github.blog/category/product/" class="d-block no-wrap f4-mktg color-fg-default text-medium">Product</a></li><li class="ml-4 p-plus__primary-nav-item" data-nav-item=""><a href="https://github.blog/category/security/" class="d-block no-wrap f4-mktg color-fg-default text-medium">Security</a></li><li class="ml-4 p-plus__primary-nav-item" data-nav-item=""><a href="https://github.blog/category/open-source/" class="d-block no-wrap f4-mktg color-fg-default text-medium">Open Source</a></li><li class="ml-4 p-plus__primary-nav-item" data-nav-item=""><a href="https://github.blog/category/enterprise/" class="d-block no-wrap f4-mktg color-fg-default text-medium">Enterprise</a></li><li class="ml-4 p-plus__primary-nav-item" data-nav-item=""><a href="https://github.blog/changelog/" class="d-block no-wrap f4-mktg color-fg-default text-medium">Changelog</a></li><li class="ml-4 p-plus__primary-nav-item" data-nav-item=""><a href="https://github.blog/category/education/" class="d-block no-wrap f4-mktg color-fg-default text-medium">Education</a></li><li class="ml-4 p-plus__primary-nav-item" data-nav-item=""><a href="https://github.blog/category/company/" class="d-block no-wrap f4-mktg color-fg-default text-medium">Company</a></li>			</ul></div>
        <button data-toggle-btn="" class="p-plus__toggle-btn btn-invisible f4-mktg text-medium btn-link no-underline ml-4 color-fg-default flex-shrink-0 text-right no-wrap" aria-expanded="false"> More<svg xmlns="http://www.w3.org/2000/svg" class="octicon octicon-chevron-down ml-1" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M12.78 6.22a.75.75 0 010 1.06l-4.25 4.25a.75.75 0 01-1.06 0L3.22 7.28a.75.75 0 011.06-1.06L8 9.94l3.72-3.72a.75.75 0 011.06 0z"></path></svg></button>
        <ul data-overflow-nav="" class="p-plus__overflow" aria-hidden="true">
        </ul>
      </div>
    </div>
      <a class="btn-mktg btn-muted-mktg font-weight-semibold ml-5 mr-2 js-newsletter-subscribe newsletter-subscribe" href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#newsletter">Subscribe</a>
			<a role="button" aria-label="Search toggle" href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#" class="ml-4 color-fg-default search-field-icon-toggle js-search-toggle" aria-expanded="false" aria-controls="js-header-search">
				<svg height="20" class="octicon octicon-search d-block mt-1" aria-hidden="true" viewBox="0 0 16 16" version="1.1" width="20" role="img"><path fill-rule="evenodd" d="M11.5 7a4.499 4.499 0 11-8.998 0A4.499 4.499 0 0111.5 7zm-.82 4.74a6 6 0 111.06-1.06l3.04 3.04a.75.75 0 11-1.06 1.06l-3.04-3.04z"></path></svg>
			</a>
			<div class="header-search box-shadow-large p-3 js-header-search" hidden="">
	<form role="search" method="get" class="header-search__form col-12" action="https://github.blog/">
		<label class="search-form__label screen-reader-text" for="search-input">Search by Keyword</label>

		<div class="header-search__form-fields d-flex flex-row flex-items-center">
			<input type="search" class="search-field form-control flex-auto p-2 mr-2" placeholder="Search …" value="" name="s" id="search-input">

			<div class="site-search__submit ml-2">
				<button type="submit" class="btn btn-outline px-4 py-2 search-submit">
					Search				</button>
			</div>
		</div>
	</form>
</div>
		</div>
	</nav>
</div>

</header>
<section class="position-relative" data-color-mode="dark" data-light-theme="light" data-dark-theme="dark_dimmed">
  <div class="container-xl p-responsive-blog">
    <div class="gutter-spacious pt-1 ">
      <div class="col-12 offset-lg-1 col-lg-10 col-xl-7 mt-5 mt-lg-10 mb-6 mb-lg-8">
      <ul class="d-inline-block list-style-none mb-12px post-hero__categories"><li class="d-inline-block mr-3"><a href="https://github.blog/category/security/" class="f4-mktg text-gradient-purple-coral text-bold">Security</a></li></ul><h1 class="h3-mktg lh-condensed mb-3 color-fg-default">The Android kernel mitigations obstacle race</h1><p class="f4-mktg">In this post I’ll exploit CVE-2022-22057, a use-after-free in the Qualcomm gpu kernel driver, to gain root and disable SELinux from the untrusted app sandbox on a Samsung Z flip 3. I’ll look at various mitigations that are implemented on modern Android devices and how they affect the exploit.</p>      </div>
              <div class="offset-lg-1 col-lg-10">
          <div class="position-relative z-1">
            <svg aria-hidden="true" width="1032" height="548" class="width-full height-auto d-block" style="visibility: hidden; pointer-events: none;"></svg>
            <img srcset="https://github.blog/wp-content/uploads/2021/12/GitHub-security_teal-banner.png?resize=800%2C425 800w,https://github.blog/wp-content/uploads/2021/12/GitHub-security_teal-banner.png?resize=1200%2C630 1600w" src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/GitHub-security_teal-banner.png" width="1600" height="850" alt="The Android kernel mitigations obstacle race" class="cover-image rounded-2">          </div>
        </div>
          </div>
  </div>
      <div class="position-absolute bottom-0 width-full" style="background:#fff; height:80px;"></div>
  </section>

<section class="container-xl mx-auto p-responsive-blog" style="margin-top: 20px;">
  <div class="gutter-spacious">
    <div class="col-12 offset-lg-1 col-lg-10">
            <div class="text-mono f5-mktg color-fg-muted mb-12px">Author</div>
            <div class="d-flex flex-nowrap pb-1 flex-items-start">
                <div class="d-flex flex-wrap">
                      <a href="https://github.blog/author/mymo/" class="d-flex flex-nowrap flex-items-center Link--primary f4-mktg text-bold mb-3 mr-4 mr-lg-5" style="line-height: 1.25 !important;">
              <img src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/15773368" class="d-block height-auto circle byline__photo--recirc mr-14px" alt="Man Yue Mo" width="40" height="40">Man Yue Mo            </a>
                  </div>
                <time datetime="2022-06-16" class="d-block border-left flex-shrink-0 text-mono f5-mktg color-fg-muted mb-3" style="margin-left: auto; padding-left: 28px; min-height: 28px; line-height: 28px !important; margin-top: 8px;">
          June 16, 2022        </time>
      </div>
      <div class="indigo-separator"></div>
    </div>
  </div>
</section>
<div class="container-xl mx-auto p-responsive-blog mt-4 mt-md-7 mb-7 mb-md-9">
  <div class="d-flex flex-wrap gutter-spacious">
    
<div class="col-12 offset-lg-1 col-lg-1 post__social">
	<ul class="list-style-none d-flex flex-lg-column">

		<li class="mr-4 mr-lg-0 mb-4">
			<a href="https://twitter.com/share?text=The%20Android%20kernel%20mitigations%20obstacle%20race&amp;url=https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/" target="_blank" rel="noopener noreferrer" class="d-flex flex-justify-center flex-items-center border circle gh-social-aside" aria-label="Share on Twitter">
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 273.5 222.3" height="18">
					<path d="M273.5 26.3a109.77 109.77 0 0 1-32.2 8.8 56.07 56.07 0 0 0 24.7-31 113.39 113.39 0 0 1-35.7 13.6 56.1 56.1 0 0 0-97 38.4 54 54 0 0 0 1.5 12.8A159.68 159.68 0 0 1 19.1 10.3a56.12 56.12 0 0 0 17.4 74.9 56.06 56.06 0 0 1-25.4-7v.7a56.11 56.11 0 0 0 45 55 55.65 55.65 0 0 1-14.8 2 62.39 62.39 0 0 1-10.6-1 56.24 56.24 0 0 0 52.4 39 112.87 112.87 0 0 1-69.7 24 119 119 0 0 1-13.4-.8 158.83 158.83 0 0 0 86 25.2c103.2 0 159.6-85.5 159.6-159.6 0-2.4-.1-4.9-.2-7.3a114.25 114.25 0 0 0 28.1-29.1" fill="currentColor"></path>
				</svg>
			</a>
		</li>
		<li class="mr-4 mr-lg-0 mb-4">
			<a href="https://www.facebook.com/sharer/sharer.php?u=https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/&amp;t=The%20Android%20kernel%20mitigations%20obstacle%20race" target="_blank" rel="noopener noreferrer" class="d-flex flex-justify-center flex-items-center border circle gh-social-aside" aria-label="Share on Facebook">
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.3 15.4" height="18">
					<path d="M14.5 0H.8a.88.88 0 0 0-.8.9v13.6a.88.88 0 0 0 .8.9h7.3v-6h-2V7.1h2V5.4a2.87 2.87 0 0 1 2.5-3.1h.5a10.87 10.87 0 0 1 1.8.1v2.1h-1.3c-1 0-1.1.5-1.1 1.1v1.5h2.3l-.3 2.3h-2v5.9h3.9a.88.88 0 0 0 .9-.8V.8a.86.86 0 0 0-.8-.8z" fill="currentColor"></path>
				</svg>
			</a>
		</li>
		<li class="mr-4 mr-lg-0 mb-4">
			<a href="https://www.linkedin.com/shareArticle?url=https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/&amp;title=The%20Android%20kernel%20mitigations%20obstacle%20race" target="_blank" rel="noopener noreferrer" class="d-flex flex-justify-center flex-items-center border circle gh-social-aside" aria-label="Share on LinkedIn">
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19 18" height="18">
					<path d="M3.94 2A2 2 0 1 1 2 0a2 2 0 0 1 1.94 2zM4 5.48H0V18h4zm6.32 0H6.34V18h3.94v-6.57c0-3.66 4.77-4 4.77 0V18H19v-7.93c0-6.17-7.06-5.94-8.72-2.91z" fill="currentColor"></path>
				</svg>
			</a>
		</li>

	</ul>
</div>

<main role="main" id="post-65495" class="col-12 col-lg-7 post__content col-md-8 post-65495 post type-post status-publish format-standard has-post-thumbnail hentry category-security tag-github-security-lab">
  
<p>In this post, I’ll exploit a use-after-free (UAF) bug, CVE-2022-22057 in the Qualcomm GPU driver, which affected the kernel branch 5.4 or above, and is mostly used by flagship models running the Snapdragon 888 chipset or above (for example, the Snapdragon version of S21—used in the U.S. and a number of Asian countries, such as China and Korea— and all versions of the Galaxy Z Flip3, and many others). The device tested here is the Samsung Galaxy Z Flip3 and I was able to use this bug alone to gain arbitrary kernel memory read and write, and from there, disable SELinux and run arbitrary commands as root. The bug itself was publicly disclosed in the <a href="https://docs.qualcomm.com/product/publicresources/securitybulletin/may-2022-bulletin.html">Qualcomm security bulletin in May 2022</a> and the fix was applied to devices in the May 2022 Android security patch.</p>
<h2 id="why-android-gpu-drivers">Why Android GPU drivers<a href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#why-android-gpu-drivers" class="heading-link pl-2 text-italic text-bold" aria-label="Why Android GPU drivers"></a></h2>
<p>While the bug itself is a fairly standard use-after-free bug that involves a tight race condition in the GPU driver, and this post focuses mostly on bypassing the many mitigations that are in place on the device rather on the GPU, it is, nevertheless, worth giving some motivations as to why the Android GPU makes an attractive target for attackers.</p>
<p>As was mentioned in the article “<a href="https://googleprojectzero.blogspot.com/2022/04/the-more-you-know-more-you-know-you.html">The More You Know, The More You Know You Don’t Know</a>” by Maddie Stone, out of seven Android 0-days that were detected as exploited in the wild in 2021, five of them targeted GPU drivers. As of the date of writing, another bug that was exploited in the wild, <a href="https://source.android.com/security/bulletin/pixel/2022-03-01">CVE-2021-39793</a> disclosed in March 2022 also targeted the GPU driver.</p>
<p>Apart from the fact that most Android devices use either the Qualcomm Adreno or the ARM Mali GPU, making it possible to obtain universal coverage with relatively few bugs (this was mentioned in Maddie Stone’s article), the GPU drivers are also reachable from the untrusted app sandbox in all Android devices, further reducing the number of bugs that are required in a full chain. Another reason GPU drivers are attractive is that most GPU drivers also handle rather complex memory sharing logic between the GPU device and the CPU. These often involve fairly elaborate memory management code that is prone to bugs that can be abused to achieve arbitrary read and write of physical memory or to bypass memory protection. As these bugs enable an attacker to abuse the functionality of the GPU memory management code, many of them are also undetectable as memory corruptions and immune to existing mitigations, which mostly aim at preventing control flow hijacking. Some examples are the work of <a href="https://github.com/secmob/TiYunZong-An-Exploit-Chain-to-Remotely-Root-Modern-Android-Devices/blob/master/us-20-Gong-TiYunZong-An-Exploit-Chain-to-Remotely-Root-Modern-Android-Devices-wp.pdf">Guang Gong</a> and <a href="https://googleprojectzero.blogspot.com/2020/09/attacking-qualcomm-adreno-gpu.html">Ben Hawkes</a>, who exploited logic errors in the handling of GPU opcode to gain arbitrary memory read and write.</p>
<h2 id="the-vulnerability">The vulnerability<a href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#the-vulnerability" class="heading-link pl-2 text-italic text-bold" aria-label="The vulnerability"></a></h2>
<p>The vulnerability was introduced in the 5.4 branch of the Qualcomm <a href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/tree/msm-5.4.r2">msm 5.4 kernel</a> when the new <a href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c">kgsl timeline</a> feature, together with some new ioctl associated with it, was introduced. The msm 5.4 kernel carried out some rather major refactoring of the kernel graphics support layer (kgsl) driver (under <a href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/tree/msm-5.4.r2/drivers/gpu/msm">drivers/gpu/msm</a>, which is Qualcomm’s GPU driver) and introduced some new features. Both these new features and refactoring resulted in a number of regressions and new security issues, most of which were found and fixed internally and then disclosed publicly as security issues in the bulletins (kudos to Qualcomm for not silently patching security issues), including some that look <a href="https://source.codeaurora.org/quic/la/kernel/msm-5.4/commit/?id=6c58829f4428f2564833743de7135f4451077e75">fairly exploitable</a>.</p>
<p>The <code>kgsl_timeline</code> object can be created and destroyed via the ioctl <code><a href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c#L323">IOCTL_KGSL_TIMELINE_CREATE</a></code> and <code><a href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c#L96">IOCTL_KGSL_TIMELINE_DESTROY</a></code>. The <code>kgsl_timeline</code> object stores a list of <code><a href="https://www.kernel.org/doc/html/v5.9/driver-api/dma-buf.html">dma_fence</a></code> objects in the field <code><a href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.h#L26">fences</a></code>. The ioctl <code><a href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c#L427">IOCTL_KGSL_TIMELINE_FENCE_GET</a></code> and <code><a href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/e0952b5cce5bcccbe04a18a9673869e6924ccac0/drivers/gpu/msm/kgsl_timeline.c#L358">IOCTL_KGSL_TIMELINE_WAIT</a></code> can be used to add <code>dma_fence</code> objects to this list. The <code>dma_fence</code> objects added are refcounted objects and their refcounts are decreased using the standard <code>dma_fence_put</code> method.</p>
<p>What is interesting about <code>timeline-&gt;fences</code> is that it does not actually hold an extra refcount to the fences. Instead, to avoid a <code>dma_fence</code> in <code>timeline-&gt;fences</code> from being freed, a customized <code><a href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L231">release</a></code> function, <code><a href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L165">timeline_fence_release</a></code> is used to remove the <code>dma_fence</code> from <code>timeline-&gt;fences</code> before it gets freed.</p>
<p>When the refcount of a <code>dma_fence</code> stored in <code>kgsl_timeline::fences</code> is decreased to zero, the method <code><a href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L165">timeline_fence_release</a></code> will be called to remove the <code>dma_fence</code> from <code>kgsl_timeline::fences</code> so that it can no longer be referenced from the <code>kgsl_timeline</code>, and then <code>dma_fence_free</code> is called to free the object itself:</p>
<pre><code class="hljs language-scss">static void <span class="hljs-built_in">timeline_fence_release</span>(struct dma_fence *fence)
{
    ...
    <span class="hljs-built_in">spin_lock_irqsave</span>(&amp;timeline-&gt;fence_lock, flags);

    <span class="hljs-comment">/* If the fence is still on the active list, remove it */</span>
    <span class="hljs-built_in">list_for_each_entry_safe</span>(cur, temp, &amp;timeline-&gt;fences, node) {
        if (f != cur)
            continue;

        <span class="hljs-built_in">list_del_init</span>(&amp;f-&gt;node);    <span class="hljs-comment">//&lt;----- 1. Remove fence</span>
        break;
    }
    <span class="hljs-built_in">spin_unlock_irqrestore</span>(&amp;timeline-&gt;fence_lock, flags);
    ...
    <span class="hljs-built_in">kgsl_timeline_put</span>(f-&gt;timeline);
    <span class="hljs-built_in">dma_fence_free</span>(fence);     <span class="hljs-comment">//&lt;-------    2.  frees the fence</span>
}
</code></pre>
<p>Although the removal of <code>fence</code> from <code>timeline-&gt;fences</code> is correctly protected by the <code>timeline-&gt;fence_lock</code>, <code><a href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L515">IOCTL_KGSL_TIMELINE_DESTROY</a></code> makes it possible to acquire a reference to a <code>dma_fence</code> in <code>fences</code> after its refcount has reached zero but before it gets removed from <code>fences</code> in <code>timeline_fence_release</code>:</p>
<pre><code class="hljs language-scss">long <span class="hljs-built_in">kgsl_ioctl_timeline_destroy</span>(struct kgsl_device_private *dev_priv,
        unsigned int cmd, void *data)
{
    ...
    <span class="hljs-built_in">spin_lock</span>(&amp;timeline-&gt;fence_lock);  <span class="hljs-comment">//&lt;------------- a.</span>
    <span class="hljs-built_in">list_for_each_entry_safe</span>(fence, tmp, &amp;timeline-&gt;fences, node)
        <span class="hljs-built_in">dma_fence_get</span>(&amp;fence-&gt;base);
    <span class="hljs-built_in">list_replace_init</span>(&amp;timeline-&gt;fences, &amp;temp);
    <span class="hljs-built_in">spin_unlock</span>(&amp;timeline-&gt;fence_lock);


    <span class="hljs-built_in">spin_lock_irq</span>(&amp;timeline-&gt;lock);
    <span class="hljs-built_in">list_for_each_entry_safe</span>(fence, tmp, &amp;temp, node) { <span class="hljs-comment">//&lt;----- b.</span>
        <span class="hljs-built_in">dma_fence_set_error</span>(&amp;fence-&gt;base, -ENOENT);
        <span class="hljs-built_in">dma_fence_signal_locked</span>(&amp;fence-&gt;base);
        <span class="hljs-built_in">dma_fence_put</span>(&amp;fence-&gt;base);
    }
    <span class="hljs-built_in">spin_unlock_irq</span>(&amp;timeline-&gt;lock);
    ...
}
</code></pre>
<p>In <code>kgsl_ioctl_timeline_destroy</code>, when destroying the timeline, the fences in <code>timeline-&gt;fences</code> are first copied to another list, <code>temp</code> and then removed from <code>timeline-&gt;fences</code> (point a.). As <code>timeline-&gt;fences</code> does not hold an extra reference of the fence, refcount is increased to stop them from being free’d in <code>temp</code>. Again, the manipulation of <code>timeline-&gt;fences</code> is protected by <code>timeline-&gt;fence_lock</code> here. However, if the refcount of a fence is already zero when <code>a</code> in the above is reached, but <code>timeline_fence_release</code> has not yet been able to remove it from <code>timeline-&gt;fences</code>, (it has not reached point 1. In the snippet included in <code>timeline_fence_release</code>), then the <code>dma_fence</code> would be moved to <code>temp</code>, and although its reference is increased, it is already too late, because <code>timeline_fence_release</code> will free the <code>dma_fence</code> when it reaches point 2., regardless of the refcount. So if the events happens in the following order, then a use-after-free could be triggered at point b.:</p>
<div class="image-frame image-frame-full border rounded-2 overflow-hidden d-flex flex-row flex-justify-center" style="background: #EAEEF2"><img src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/Kernel-1.png" alt="" width="960" height="540" class="alignnone size-full wp-image-65548 width-fit" srcset="https://github.blog/wp-content/uploads/2022/06/Kernel-1.png?resize=960%2C540?w=960 960w, https://github.blog/wp-content/uploads/2022/06/Kernel-1.png?resize=960%2C540?w=300 300w, https://github.blog/wp-content/uploads/2022/06/Kernel-1.png?resize=960%2C540?w=768 768w" sizes="(max-width: 960px) 100vw, 960px" loading="lazy" data-recalc-dims="1"></div>
<p>In the above, the red blocks indicate code that are holding the same lock, meaning that the execution of these blocks are mutually exclusive. While the order of events may look rather contrived (as it always is when you try to illustrate a race condition), the actual timing is not too hard to achieve. As the code in <code>timeline_fence_release</code> that removes a <code>dma_fence</code> from <code>timeline-&gt;fences</code> cannot run while the code in <code>kgsl_ioctl_timeline_destroy</code> is accessing <code>timeline-&gt;fence</code> (both are holding <code>timeline-&gt;fence_lock</code>), by adding a large number of <code>dma_fence</code> to <code>timeline-&gt;fence</code>, I can increase the time required to run the red code block in <code>kgsl_ioctl_timeline_destroy</code>. If I decrease the refcount of the last <code>dma_fence</code> in <code>timeline-&gt;fences</code> in thread two to zero while the red code block in thread one is running, I can trigger <code>timeline_fence_release</code> before <code>dma_fence_get</code> increases the refcount of this <code>dma_fence</code> in thread one. As the red code block in thread two also needs to acquire the <code>timeline-&gt;fence_lock</code>, it can not remove the <code>dma_fence</code> from <code>timeline-&gt;fences</code> until after the red code block in thread one finished. By that time, all the <code>dma_fence</code> in <code>timeline-&gt;fences</code> have been moved to the list <code>temp</code>. This also means that by the time the red code block in thread two runs, <code>timeline-&gt;fences</code> is an empty list and the loop finishes quickly and proceeds to <code>dma_fence_free</code>. In short, as long as I add a large enough number of <code>dma_fences</code> to <code>timeline-&gt;fences</code>, I can create a large race window when <code>kgsl_ioctl_timeline_destroy</code> is moving the <code>dma_fences</code> in <code>timeline-&gt;fences</code> to <code>temp</code>. As long as I reduce the last refcount of the last <code>dma_fence</code> in <code>timeline-&gt;fences</code> within this window, I’m able to trigger the UAF bug.</p>
<h2 id="mitigations">Mitigations<a href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#mitigations" class="heading-link pl-2 text-italic text-bold" aria-label="Mitigations"></a></h2>
<p>While triggering the bug is not too difficult, exploiting it, on the other hand, is a completely different matter. The device that I used for testing this bug and for developing the exploit is a Samsung Galaxy Z Flip3. The latest Samsung devices running kernel version 5.x probably have the most mitigations in place, even more so than the Google Pixels. While older devices running kernel 4.x often have mitigations such as the <a href="https://source.android.com/devices/tech/debug/kcfi">kCFI</a> (Kernel Control Flow Integrity) and <a href="https://android-developers.googleblog.com/2020/06/system-hardening-in-android-11.html">variable initialization</a> switched off, all those features are switched on in the 5.x kernel branch, and on top of that, there is also the <a href="https://www.samsungknox.com/en">Samsung RKP (Realtime Kernel Protection)</a> that protects various memory area, such as kernel code and process credentials, making it difficult to execute arbitrary code even when arbitrary memory read and write is achieved. In this section, I’ll briefly explain how those mitigations affect the exploit.</p>
<h3 id="kcfi">kCFI<a href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#kcfi" class="heading-link pl-2 text-italic text-bold" aria-label="kCFI"></a></h3>
<p>The kCFI is arguably the mitigation that takes the most effort to bypass, especially when used in conjunction with the Samsung hypervisor which protects many important memory areas in the kernel. The kCFI prevents hijacking of control flow by limiting the locations where a dynamic callsite can jump to using function signatures. For example, in the current vulnerability, after the <code>dma_fence</code> is freed, the function <code>dma_fence_signal_locked</code> is called:</p>
<pre><code class="hljs language-scss">long <span class="hljs-built_in">kgsl_ioctl_timeline_destroy</span>(struct kgsl_device_private *dev_priv,
        unsigned int cmd, void *data)
{
    ...
    <span class="hljs-built_in">spin_lock_irq</span>(&amp;timeline-&gt;lock);
    <span class="hljs-built_in">list_for_each_entry_safe</span>(fence, tmp, &amp;temp, node) {
        <span class="hljs-built_in">dma_fence_set_error</span>(&amp;fence-&gt;base, -ENOENT);
        <span class="hljs-built_in">dma_fence_signal_locked</span>(&amp;fence-&gt;base);       <span class="hljs-comment">//&lt;---- free'd fence is used</span>
        <span class="hljs-built_in">dma_fence_put</span>(&amp;fence-&gt;base);
    }
    <span class="hljs-built_in">spin_unlock_irq</span>(&amp;timeline-&gt;lock);
    ...
}
</code></pre>
<p>The function <code>dma_fence_signal_locked</code> then invokes a function <code>cur-&gt;func</code> that is an element inside the <code>fence-&gt;cb_list</code> list.</p>
<pre><code class="hljs language-scss">int <span class="hljs-built_in">dma_fence_signal_locked</span>(struct dma_fence *fence)
{
    ...
    <span class="hljs-built_in">list_for_each_entry_safe</span>(cur, tmp, &amp;cb_list, node) {
        <span class="hljs-built_in">INIT_LIST_HEAD</span>(&amp;cur-&gt;node);
        cur-&gt;<span class="hljs-built_in">func</span>(fence, cur);
    }
    ...
}
</code></pre>
<p>Without kCFI, the now free’d <code>fence</code> object can be replaced with a fake object, meaning that <code>cb_list</code> and its elements, hence <code>func</code>, can all be faked, giving a ready to use primitive to call an arbitrary function with both its first and second arguments pointing to controlled data (<code>fence</code> and <code>cur</code> can both be faked). The exploit would have been very easy once KASLR was defeated (for example, with a separate bug to leak kernel addresses like in <a href="https://securitylab.github.com/research/qualcomm_npu/">this exploit</a>). However, because of kCFI, <code>func</code> can now only be replaced by functions that have the type <code><a href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/include/linux/dma-fence.h#L118">dma_fence_func_t</a></code>, which greatly limits the use of this primitive.</p>
<p>While in the past, I’ve written about how easy it is to <a href="https://securitylab.github.com/research/qualcomm_npu/">bypass</a> Samsung’s control flow integrity checks (JOPP, jump-oriented programming prevention), there is no easy way round kCFI. One common way to bypass kCFI is to use a double free to hijack the freelist and then apply the <a href="https://i.blackhat.com/briefings/asia/2018/asia-18-WANG-KSMA-Breaking-Android-kernel-isolation-and-Rooting-with-ARM-MMU-features.pdf">Kernel Space Mirroring Attack (KSMA)</a>. This was used a number of times, for example, in <a href="https://github.com/2freeman/Slides/blob/main/PoC-2020-Three%20Dark%20clouds%20over%20the%20Android%20kernel.pdf">Three dark clouds over the Android kernel</a> of Jun Yao, <a href="https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Typhoon-Mangkhut-One-Click-Remote-Universal-Root-Formed-With-Two-Vulnerabilities.pdf">Typhoon Mangkhut: One-click remote universal root formed with two vulnerabilities</a> of Hongli Han, Rong Jian, Xiaodong Wang and Peng Zhou.</p>
<p>While the current bug also gives me a double free primitive when <code>dma_fence_put</code> is called after <code>fence</code> is freed:</p>
<pre><code class="hljs language-scss">long <span class="hljs-built_in">kgsl_ioctl_timeline_destroy</span>(struct kgsl_device_private *dev_priv,
        unsigned int cmd, void *data)
{
    ...
    <span class="hljs-built_in">spin_lock_irq</span>(&amp;timeline-&gt;lock);
    <span class="hljs-built_in">list_for_each_entry_safe</span>(fence, tmp, &amp;temp, node) {
        <span class="hljs-built_in">dma_fence_set_error</span>(&amp;fence-&gt;base, -ENOENT);
        <span class="hljs-built_in">dma_fence_signal_locked</span>(&amp;fence-&gt;base); 
        <span class="hljs-built_in">dma_fence_put</span>(&amp;fence-&gt;base);       <span class="hljs-comment">//&lt;----- free'd fence can be freed again</span>
    }
    <span class="hljs-built_in">spin_unlock_irq</span>(&amp;timeline-&gt;lock);
    ...
}
</code></pre>
<p>The above decreases the refcount of the fake <code>fence</code> object, which I can control to make it one, so that the fake fence gets freed again. This, however, does not allow me to apply KSMA as it would require overwriting of the <code><a href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/arch/arm64/include/asm/pgtable.h#L465">swapper_pg_dir</a></code> data structure, which is protected by the Samsung hypervisor.</p>
<h3 id="variable-initialization">Variable initialization<a href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#variable-initialization" class="heading-link pl-2 text-italic text-bold" aria-label="Variable initialization"></a></h3>
<p>From Android 11 onwards, the kernel can enable automatic variable initialization by enabling various kernel build flags. The following, for example, is taken from the build configuration of the Z Flip3:</p>
<pre><code class="hljs language-ini"><span class="hljs-comment"># Memory initialization</span>
<span class="hljs-comment">#</span>
<span class="hljs-attr">CONFIG_CC_HAS_AUTO_VAR_INIT_PATTERN</span>=y
<span class="hljs-attr">CONFIG_CC_HAS_AUTO_VAR_INIT_ZERO</span>=y
<span class="hljs-comment"># CONFIG_INIT_STACK_NONE is not set</span>
<span class="hljs-comment"># CONFIG_INIT_STACK_ALL_PATTERN is not set</span>
<span class="hljs-attr">CONFIG_INIT_STACK_ALL_ZERO</span>=y
<span class="hljs-attr">CONFIG_INIT_ON_ALLOC_DEFAULT_ON</span>=y
<span class="hljs-comment"># CONFIG_INIT_ON_FREE_DEFAULT_ON is not set</span>
<span class="hljs-comment"># end of Memory initialization</span>
</code></pre>
<p>While the feature is available since Android 11, many devices running kernel branch 4.x do not have these enabled. On the other hand, devices running kernel 5.x seem to have these enabled. Apart from the obvious uninitialized variables vulnerabilities that this feature prevents, it also makes it harder for object replacement. In particular, it is no longer possible to perform partial object replacement, in which only the first bytes of the object are replaced, while the rest of the object remains valid. So for example, the type of heap spray technique under the section, “Spraying the heap” in “<a href="https://googleprojectzero.blogspot.com/2020/02/mitigations-are-attack-surface-too.html">Mitigations are attack surface, too</a>” by Jann Horn is no longer possible with automatic variable initialization. In the context of the current bug, this mitigation limits the heap spray options that I have, and I’ll explain more as we go through the exploit.</p>
<h3 id="kfree_rcu">kfree_rcu<a href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#kfree_rcu" class="heading-link pl-2 text-italic text-bold" aria-label="kfree_rcu"></a></h3>
<p>This isn’t a security mitigation at all, but it is nevertheless interesting to mention it here, because it has a similar effect to some UAF mitigations that had been proposed. The UAF <code>fence</code> object in this bug is freed when <code><a href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/dma-buf/dma-fence.c#L270">dma_fence_free</a></code> is called, which, instead of the normal <code>kfree</code>, uses <code>kfree_rcu</code>. In short, <code>kfree_rcu</code> does not free an object immediately, but rather schedules it to be freed when certain criteria are met. This acts somewhat like a delayed free that introduces an uncertainty in the time when the object is freed. Interestingly, this effect is quite similar to the UAF mitigation that is used in the <a href="https://source.android.com/devices/tech/debug/scudo">Scudo</a> allocator (default allocator of Android user space processes), which quarantines the free’d objects before actually freeing them to introduce uncertainty. A similar proposal has been suggested for the <a href="https://www.openwall.com/lists/kernel-hardening/2020/08/13/7">linux kernel</a> (but was rejected later). Apart from introducing uncertainty in the object replacement, a delayed free may also cause problems for UAF with tight race windows. So, on the face of it, the use of <code>kfree_rcu</code> would be rather problematic for exploiting the current bug. However, with many primitives to manipulate the size of a race window, such as the ones detailed in <a href="https://googleprojectzero.blogspot.com/2022/03/racing-against-clock-hitting-tiny.html">Racing against the clock—hitting a tiny kernel race window</a> and an older technique in <a href="https://static.sched.com/hosted_files/lsseu2019/04/LSSEU2019%20-%20Exploiting%20race%20conditions%20on%20Linux.pdf">Exploiting race conditions on [ancient] Linux</a>, (both by Jann Horn, the older technique is used for exploiting the current bug) any tight race window can be made large enough to allow for the delay caused by <code>kfree_rcu</code>, and the subsequent object replacement. As for the uncertainty, that does not seem to cause a very big problem either. In exploiting this bug, I actually had to perform object replacement with <code>kfree_rcu</code> twice, the second time without even knowing on which CPU core the free is going to happen, and yet even with this and all the other moving parts, a rather unoptimized exploit still runs at a reasonable reliability (~70%) on the device tested. While I believe that the second object replacement with <code>kfree_rcu</code> (where the CPU that frees the object is uncertain) is probably the main source of unreliability, I’d attribute that reliability loss more to the lack of CPU knowledge rather than to the delayed free. In my opinion, a delayed free may not be a very effective UAF mitigation when there are primitives that allow the scheduler to be manipulated.</p>
<h3 id="samsung-rkp-realtime-kernel-protection">Samsung RKP (Realtime Kernel Protection)<a href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#samsung-rkp-realtime-kernel-protection" class="heading-link pl-2 text-italic text-bold" aria-label="Samsung RKP (Realtime Kernel Protection)"></a></h3>
<p>The Samsung RKP protects various parts of the memory from being written to. This prevents processes from overwriting their own credentials to become root, as well as protecting SELinux settings from being overwritten. It also prevents kernel code regions and other important objects, such as kernel page tables, from being overwritten. In practice, though, once arbitrary kernel memory read and write (subject to RKP restrictions) is achieved, there are ways to bypass these restrictions. For example, SELinux rules can be modified by overwriting the avc cache (see, for example, this <a href="https://github.com/chompie1337/s8_2019_2215_poc/blob/master/poc/selinux_bypass.c">exploit</a> by Valentina Palmiotti), while gaining root can be done by <a href="https://securitylab.github.com/research/qualcomm_npu/">hijacking other processes that run as root</a>. In the context of the current bug, the Samsung RKP mostly works with kCFI to prevent arbitrary functions from being called.</p>
<p>In this post, I’ll exploit the bug with all these mitigations enabled.</p>
<h2 id="exploiting-the-bug">Exploiting the bug<a href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#exploiting-the-bug" class="heading-link pl-2 text-italic text-bold" aria-label="Exploiting the bug"></a></h2>
<p>I’ll now start going through the exploit of the bug. It is a fairly typical use-after-free bug that involves a race condition and perhaps reasonably strong primitives with both the possibility of arbitrary function call and double free, which is not that uncommon. Apart from that, this is a typical bug, just like many other UAF found in the kernel. So, it seems fitting to use this bug to gauge how these mitigations affect the development of a standard UAF exploit.</p>
<h3 id="adding-dma_fence-to-timeline-fences">Adding <code>dma_fence</code> to <code>timeline-&gt;fences</code><a href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#adding-dma_fence-to-timeline-fences" class="heading-link pl-2 text-italic text-bold" aria-label="Adding &lt;code&gt;dma_fence&lt;/code&gt; to &lt;code&gt;timeline-&gt;fences&lt;/code&gt;"></a></h3>
<p>In the section, “The vulnerability,” I explained that the bug relies on having <code>dma_fence</code> objects added to the <code>fences</code> list in a <code>kgsl_timeline</code> object, which then have their refcount decreased to zero while the <code>kgsl_timeline</code> is being destroyed. There are two options to add <code>dma_fence</code> objects to a <code>kgsl_timeline</code>, the first is to use <code>IOCTL_KGSL_TIMELINE_FENCE_GET</code>:</p>
<pre><code class="hljs language-cpp"><span class="hljs-function"><span class="hljs-type">long</span> <span class="hljs-title">kgsl_ioctl_timeline_fence_get</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kgsl_device_private *dev_priv,
        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">void</span> *data)</span>
</span>{
    ...
    timeline = <span class="hljs-built_in">kgsl_timeline_by_id</span>(device, param-&gt;timeline);
    ...
    fence = <span class="hljs-built_in">kgsl_timeline_fence_alloc</span>(timeline, param-&gt;seqno); <span class="hljs-comment">//&lt;----- dma_fence created and added to timeline</span>
    ...
    sync_file = <span class="hljs-built_in">sync_file_create</span>(fence);
    <span class="hljs-keyword">if</span> (sync_file) {
        <span class="hljs-built_in">fd_install</span>(fd, sync_file-&gt;file);
        param-&gt;handle = fd;
    }
    ...
}
</code></pre>
<p>This will create a <code>dma_fence</code> with <code>kgsl_timeline_fence_alloc</code> and add it to the <code>timeline</code>. The caller then gets a file descriptor for a <code>sync_file</code> that corresponds to the <code>dma_fence</code>. When the <code>sync_file</code> is closed, the refcount of <code>dma_fence</code> is decreased to zero.</p>
<p>The second option is to use <code>IOCTL_KGSL_TIMELINE_WAIT</code>:</p>
<pre><code class="hljs language-cpp"><span class="hljs-function"><span class="hljs-type">long</span> <span class="hljs-title">kgsl_ioctl_timeline_wait</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kgsl_device_private *dev_priv,
        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">void</span> *data)</span>
</span>{
    ...
    fence = <span class="hljs-built_in">kgsl_timelines_to_fence_array</span>(device, param-&gt;timelines,
        param-&gt;count, param-&gt;timelines_size,
        (param-&gt;flags == KGSL_TIMELINE_WAIT_ANY));     <span class="hljs-comment">//&lt;------ dma_fence created and added to timeline</span>
    ...
    <span class="hljs-keyword">if</span> (!timeout)
        ret = <span class="hljs-built_in">dma_fence_is_signaled</span>(fence) ? <span class="hljs-number">0</span> : -EBUSY;
    <span class="hljs-keyword">else</span> {
        ret = <span class="hljs-built_in">dma_fence_wait_timeout</span>(fence, <span class="hljs-literal">true</span>, timeout);   <span class="hljs-comment">//&lt;----- 1.</span>
        ...
    }

    <span class="hljs-built_in">dma_fence_put</span>(fence);
    ...
}
</code></pre>
<p>This will create <code>dma_fence</code> objects using <code>kgsl_timelines_to_fence_array</code> and add them to the <code>timeline</code>. If a <code>timeout</code> value is specified, then the call will enter <code>dma_fence_wait_timeout</code> (path labeled 1), which will wait until either the timeout expires or when the thread receives an interrupt. After <code>dma_fence_wait_timeout</code> finishes, <code>dma_fence_put</code> is called to reduce the refcount of the <code>dma_fence</code> to zero. So, by specifying a large timeout, <code>dma_fence_wait_timeout</code> will block until it receives an interrupt, which will then free the <code>dma_fence</code> that was added to the <code>timeline</code>.</p>
<p>While <code>IOCTL_KGSL_TIMELINE_FENCE_GET</code> may seem easier to use and control at first glance, in practice, the overhead incurred by closing the <code>sync_file</code> makes the timing for destruction of the <code>dma_fence</code> less reliable. So, for the exploit, I use <code>IOCTL_KGSL_TIMELINE_FENCE_GET</code> to create and add persistent <code>dma_fence</code> objects to fill the <code>timeline-&gt;fences</code> list to enlarge the race window, while the last <code>dma_fence</code> object that is used for the UAF bug is added using <code>IOCTL_KGSL_TIMELINE_WAIT</code> and which gets freed when I send an interrupt signal to the thread that calls <code>IOCTL_KGSL_TIMELINE_WAIT</code>.</p>
<h3 id="widening-the-tiny-race-window">Widening the tiny race window<a href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#widening-the-tiny-race-window" class="heading-link pl-2 text-italic text-bold" aria-label="Widening the tiny race window"></a></h3>
<p>To recap, in order to exploit the vulnerability, I need to remove the refcount of a <code>dma_fence</code> in the <code>fences</code> list of a <code>kgsl_timeline</code> within the first race window labeled in the following code block:</p>
<pre><code class="hljs language-scss">long <span class="hljs-built_in">kgsl_ioctl_timeline_destroy</span>(struct kgsl_device_private *dev_priv,
        unsigned int cmd, void *data)
{
    <span class="hljs-comment">//BEGIN OF FIRST RACE WINDOW</span>
    <span class="hljs-built_in">spin_lock</span>(&amp;timeline-&gt;fence_lock);
    <span class="hljs-built_in">list_for_each_entry_safe</span>(fence, tmp, &amp;timeline-&gt;fences, node)
        <span class="hljs-built_in">dma_fence_get</span>(&amp;fence-&gt;base);
    <span class="hljs-built_in">list_replace_init</span>(&amp;timeline-&gt;fences, &amp;temp);
    <span class="hljs-built_in">spin_unlock</span>(&amp;timeline-&gt;fence_lock);
    <span class="hljs-comment">//END OF FIRST RACE WINDOW</span>
    <span class="hljs-comment">//BEGIN OF SECOND RACE WINDOW</span>
    <span class="hljs-built_in">spin_lock_irq</span>(&amp;timeline-&gt;lock);
    <span class="hljs-built_in">list_for_each_entry_safe</span>(fence, tmp, &amp;temp, node) {
        <span class="hljs-built_in">dma_fence_set_error</span>(&amp;fence-&gt;base, -ENOENT);
        <span class="hljs-built_in">dma_fence_signal_locked</span>(&amp;fence-&gt;base);
        <span class="hljs-built_in">dma_fence_put</span>(&amp;fence-&gt;base);
    }
    <span class="hljs-built_in">spin_unlock_irq</span>(&amp;timeline-&gt;lock);
    <span class="hljs-comment">//END OF SECOND RACE WINDOW</span>
    ...
}
</code></pre>
<p>As explained before, the first race window can be enlarged by adding a large number of <code>dma_fence</code> objects to <code>timeline-&gt;fences</code>, which makes it easy to trigger the decrease of refcount within this window. However, to exploit the bug, the following <a href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/drivers/gpu/msm/kgsl_timeline.c#L172">code</a>, as well as the object replacement, must be completed before the end of the second race window:</p>
<pre><code class="hljs language-scss">    <span class="hljs-built_in">spin_lock_irqsave</span>(&amp;timeline-&gt;fence_lock, flags);
    <span class="hljs-built_in">list_for_each_entry_safe</span>(cur, temp, &amp;timeline-&gt;fences, node) {
        if (f != cur)
            continue;
        <span class="hljs-built_in">list_del_init</span>(&amp;f-&gt;node);
        break;
    }
    <span class="hljs-built_in">spin_unlock_irqrestore</span>(&amp;timeline-&gt;fence_lock, flags);
    <span class="hljs-built_in">trace_kgsl_timeline_fence_release</span>(f-&gt;timeline-&gt;id, fence-&gt;seqno);
    <span class="hljs-built_in">kgsl_timeline_put</span>(f-&gt;timeline);
    <span class="hljs-built_in">dma_fence_free</span>(fence);
</code></pre>
<p>As explained before, because of the <code>spin_lock</code>, the above cannot start until the first race window ends, but by the time this code is run, <code>timeline-&gt;fences</code> has been emptied, so the loop will be quick to run. However, since <code>dma_fence_free</code> uses <code>kfree_rcu</code>, the actual freeing of <code>fence</code> is delayed. This makes it impossible to replace the free’d fence before the second race window finishes, unless we manipulate the scheduler. To do so, I’ll use a technique in “<a href="https://static.sched.com/hosted_files/lsseu2019/04/LSSEU2019%20-%20Exploiting%20race%20conditions%20on%20Linux.pdf">Exploiting race conditions on [ancient] Linux</a>” that I also used in another <a href="https://securitylab.github.com/research/one_day_short_of_a_fullchain_android/">Android exploit</a> to widen this race window.</p>
<p>I’ll recap the essence of the technique here for readers who are not familiar with it.</p>
<p>To ensure that each task (thread or process) has a fair share of the CPU time, the linux kernel scheduler can interrupt a running task and put it on hold, so that another task can be run. This kind of interruption and stopping of a task is called preemption (where the interrupted task is preempted). A task can also put itself on hold to allow another task to run, such as when it is waiting for some I/O input, or when it calls <code>sched_yield()</code>. In this case, we say that the task is voluntarily preempted. Preemption can happen inside syscalls such as ioctl calls as well, and on Android, tasks can be preempted except in some critical regions (e.g. holding a spinlock). This behavior can be manipulated by using CPU affinity and task priorities.</p>
<p>By default, a task is run with the priority <code>SCHED_NORMAL</code>, but a lower priority <code>SCHED_IDLE</code> can also be set using the <code>sched_setscheduler</code> call (or <code>pthread_setschedparam</code> for threads). Furthermore, it can also be pinned to a CPU with <code>sched_setaffinity</code>, which would only allow it to run on a specific CPU. By pinning two tasks, one with <code>SCHED_NORMAL</code> priority and the other with <code>SCHED_IDLE</code> priority to the same CPU, it is possible to control the timing of the preemption as follows.</p>
<ol>
<li>First have the <code>SCHED_NORMAL</code> task perform a syscall that would cause it to pause and wait. For example, it can read from a pipe with no data coming in from the other end, then it would wait for more data and voluntarily preempt itself, so that the <code>SCHED_IDLE</code> task can run.</li>
<li>As the <code>SCHED_IDLE</code> task is running, send some data to the pipe that the <code>SCHED_NORMAL</code> task had been waiting on. This will wake up the <code>SCHED_NORMAL</code> task and cause it to preempt the <code>SCHED_IDLE</code> task, and because of the task priority, the <code>SCHED_IDLE</code> task will be preempted and put on hold.</li>
<li>The <code>SCHED_NORMAL</code> task can then run a busy loop to keep the <code>SCHED_IDLE</code> task from waking up.</li>
</ol>
<p>In our case, the object replacement sequence goes as follows:</p>
<ol>
<li>Run <code>IOCTL_KGSL_TIMELINE_WAIT</code> on a thread to add <code>dma_fence</code> objects to a <code>kgsl_timeline</code>. Set the timeout to a large value and use <code>sched_setaffinity</code> to pin this task to a CPU, call it <code>SPRAY_CPU</code>. Once the <code>dma_fence</code> object is added, the task will then become idle until it receives an interrupt.</li>
<li>Set up a <code>SCHED_NORMAL</code> task and pin it to another CPU (<code>DESTROY_CPU</code>) that listens to an empty pipe. This will cause this task to become idle initially and allow <code>DESTROY_CPU</code> to run a lower priority task. Once the empty pipe receives some data, this task then will run a busy loop.</li>
<li>Set up a <code>SCHED_IDLE</code> task on <code>DESTROY_CPU</code> which will run <code>IOCTL_KGSL_TIMELINE_DESTROY</code> to destroy the timeline where the <code>dma_fence</code> is added in step one. As the task set up in step two is waiting for a response to an empty pipe, <code>DESTROY_CPU</code> will run this task first.</li>
<li>Send an interrupt to the task running <code>IOCTL_KGSL_TIMELINE_WAIT</code>. The task will then unblock and free the <code>dma_fence</code> while <code>IOCTL_KGSL_TIMELINE_DESTROY</code> is running within the first race window.</li>
<li>Write to the empty pipe that the <code>SCHED_NORMAL</code> task is listening to. This will cause the <code>SCHED_NORMAL</code> task to preempt the <code>SCHED_IDLE</code> task. Once it has successfully preempted the task, <code>DESTROY_CPU</code> will run the busy loop, causing the <code>SCHED_IDLE</code> task to be put on hold.</li>
<li>As the <code>SCHED_IDLE</code> task running <code>IOCTL_KGSL_TIMELINE_DESTROY</code> is put on hold, there is now enough time to overcome the delay introduced by <code>kfree_rcu</code> and allow the <code>dma_fence</code> in step four to be freed and replaced. After that, I can resume <code>IOCTL_KGSL_TIMELINE_DESTROY</code> so that the subsequent operations will be performed on the now free’d and replaced <code>dma_fence</code> object.</li>
</ol>
<p>One caveat here is that, because preemption cannot happen while a thread is holding a <code>spinlock</code>, so <code>IOCTL_KGSL_TIMELINE_DESTROY</code> can only be preempted during the window between spinlocks (marked by the comment below):</p>
<pre><code class="hljs language-scss">long <span class="hljs-built_in">kgsl_ioctl_timeline_destroy</span>(struct kgsl_device_private *dev_priv,
        unsigned int cmd, void *data)
{
    <span class="hljs-built_in">spin_lock</span>(&amp;timeline-&gt;fence_lock);
    <span class="hljs-built_in">list_for_each_entry_safe</span>(fence, tmp, &amp;timeline-&gt;fences, node)
      ...
    <span class="hljs-built_in">spin_unlock</span>(&amp;timeline-&gt;fence_lock);
    <span class="hljs-comment">//Preemption window</span>
    <span class="hljs-built_in">spin_lock_irq</span>(&amp;timeline-&gt;lock);
    <span class="hljs-built_in">list_for_each_entry_safe</span>(fence, tmp, &amp;temp, node) {
    ...
    }
    <span class="hljs-built_in">spin_unlock_irq</span>(&amp;timeline-&gt;lock);
    ...
}
</code></pre>
<p>Although the preemption window in the above appears to be very small, in practice, as long as the <code>SCHED_NORMAL</code> task tries to preempt the <code>SCHED_IDLE</code> task running <code>IOCTL_KGSL_TIMELINE_DESTROY</code> while the first <code>spinlock</code> is held, preemption will happen as soon as the <code>spinlock</code> is released, making it much easier to succeed in preempting <code>IOCTL_KGSL_TIMELINE_DESTROY</code> at the right time.</p>
<p>The following figure illustrates what happens in an ideal world, with red blocks indicating regions that hold a <code>spinlock</code> and are therefore not possible to preempt, and dotted lines indicating tasks that are idle.</p>
<div class="image-frame image-frame-full border rounded-2 overflow-hidden d-flex flex-row flex-justify-center" style="background: #EAEEF2"><img loading="lazy" src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/Kernel-2.png" alt="" width="875" height="536" class="alignnone size-full wp-image-65549 width-fit" srcset="https://github.blog/wp-content/uploads/2022/06/Kernel-2.png?resize=875%2C536?w=875 875w, https://github.blog/wp-content/uploads/2022/06/Kernel-2.png?resize=875%2C536?w=300 300w, https://github.blog/wp-content/uploads/2022/06/Kernel-2.png?resize=875%2C536?w=768 768w" sizes="(max-width: 875px) 100vw, 875px" data-recalc-dims="1"></div>
<p>The following figure illustrates what happens in the real world:</p>
<div class="image-frame image-frame-full border rounded-2 overflow-hidden d-flex flex-row flex-justify-center" style="background: #EAEEF2"><img loading="lazy" src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/Kernel-3.png" alt="" width="1024" height="775" class="alignnone size-full wp-image-65550 width-fit" srcset="https://github.blog/wp-content/uploads/2022/06/Kernel-3.png?resize=1024%2C775?w=1186 1186w, https://github.blog/wp-content/uploads/2022/06/Kernel-3.png?resize=1024%2C775?w=300 300w, https://github.blog/wp-content/uploads/2022/06/Kernel-3.png?resize=1024%2C775?w=768 768w, https://github.blog/wp-content/uploads/2022/06/Kernel-3.png?resize=1024%2C775?w=1024 1024w" sizes="(max-width: 1000px) 100vw, 1000px" data-recalc-dims="1"></div>
<p>For object replacement, I’ll use <code><a href="https://blog.lexfo.fr/cve-2017-11176-linux-kernel-exploitation-part3.html">sendmsg</a></code>, which is a standard way to replace free’d objects in the linux kernel with controlled data. As the method is fairly standard, I won’t give the details here, but refer readers to the link above. From now on, I’ll assume that the free’d <code>dma_fence</code> object is replaced by arbitrary data. (There are some restrictions in the first 12 bytes using this method, but that does not affect our exploit.)</p>
<p>Assuming that the free’d <code>dma_fence</code> object can be replaced with arbitrary data, let’s take a look at how this fake object is used. After the <code>dma_fence</code> is replaced, it is then used in <code>kgsl_ioctl_timeline_destroy</code> as follows:</p>
<pre><code class="hljs language-scss">    <span class="hljs-built_in">spin_lock_irq</span>(&amp;timeline-&gt;lock);
    <span class="hljs-built_in">list_for_each_entry_safe</span>(fence, tmp, &amp;temp, node) {
        <span class="hljs-built_in">dma_fence_set_error</span>(&amp;fence-&gt;base, -ENOENT);
        <span class="hljs-built_in">dma_fence_signal_locked</span>(&amp;fence-&gt;base);
        <span class="hljs-built_in">dma_fence_put</span>(&amp;fence-&gt;base);
    }
    <span class="hljs-built_in">spin_unlock_irq</span>(&amp;timeline-&gt;lock);
</code></pre>
<p>Three different functions, <code>dma_fence_set_error</code>, <code>dma_fence_signal_locked</code> and <code>dma_fence_put</code> will be called with the argument <code>fence</code>. The function <code>dma_fence_set_error</code> will write an error code to the <code>fence</code> object, which may be useful with a suitable object replacement, but not for <code>sendmsg</code> object replacements and I’ll not be investigating this possibility here. The function <code>dma_fence_signal_locked</code> does the following:</p>
<pre><code class="hljs language-scss">int <span class="hljs-built_in">dma_fence_signal_locked</span>(struct dma_fence *fence)
{
    ...
    if (unlikely(test_and_set_bit(DMA_FENCE_FLAG_SIGNALED_BIT,   //&lt;-- <span class="hljs-number">1</span>.
                      &amp;fence-&gt;flags)))
        return -EINVAL;

    <span class="hljs-comment">/* Stash the cb_list before replacing it with the timestamp */</span>
    <span class="hljs-built_in">list_replace</span>(&amp;fence-&gt;cb_list, &amp;cb_list);                    <span class="hljs-comment">//&lt;-- 2.</span>
    ...
    <span class="hljs-built_in">list_for_each_entry_safe</span>(cur, tmp, &amp;cb_list, node) {        <span class="hljs-comment">//&lt;-- 3.</span>
        <span class="hljs-built_in">INIT_LIST_HEAD</span>(&amp;cur-&gt;node);
        cur-&gt;<span class="hljs-built_in">func</span>(fence, cur);
    }

    return <span class="hljs-number">0</span>;
}
</code></pre>
<p>It first checks <code>fence-&gt;flags</code> (1. in the above): if the <code>DMA_FENCE_FLAG_SIGNALED_BIT</code> flag is set, then the <code>fence</code> has been signaled, and the function exits early. If the <code>fence</code> has not been signaled, then <code>list_replace</code> is called to remove objects in <code>fence-&gt;cb_list</code> and place them in a temporary <code>cb_list</code> (2. in the above). After that, functions stored in <code>cb_list</code> are called (3. above). As explained in the section, “kCFI” because of the CFI mitigation, this will only allow me to call functions of a certain type; besides, at this stage I have no knowledge of function addresses, so I’m most likely just going to crash the kernel if I reach this path. So, at this stage, I have little choice but to set the <code>DMA_FENCE_FLAG_SIGNALED_BIT</code>flag in my fake object so that <code>dma_fence_signal_locked</code> exits early.</p>
<p>This leaves me the <code>dma_fence_put</code> function, which decreases the refcount of <code>fence</code> and calls <code>dma_fence_release</code> if the refcount reaches zero:</p>
<pre><code class="hljs language-scss">void <span class="hljs-built_in">dma_fence_release</span>(struct kref *kref)
{
    ...
    if (fence-&gt;ops-&gt;release)
        fence-&gt;ops-&gt;<span class="hljs-built_in">release</span>(fence);
    else
        <span class="hljs-built_in">dma_fence_free</span>(fence);
}
</code></pre>
<p>If <code>dma_fence_release</code> is called, then eventually it’ll check the <code>fence-&gt;ops</code> and call <code>fence-&gt;ops-&gt;release</code>. This gives me two problems: First, <code>fence-&gt;ops</code> needs to point to valid memory, otherwise the dereference will fail, and even if the dereference succeeds, <code>fence-&gt;ops-&gt;release</code> either needs to be zero, or it has to be the address of a function of an appropriate type.</p>
<p>All these present me with two choices. I can either follow the standard path: try to replace the <code>fence</code> object with another object or try to make use of the limited write primitives that <code>dma_fence_put</code> and <code>dma_fence_set_error</code> offer me, while hoping that I can still control the <code>flags</code> and <code>refcount</code> fields to avoid <code>dma_fence_signal_locked</code> or <code>dma_fence_release</code> crashing the kernel.</p>
<p>Or, I can try something else.</p>
<h2 id="the-ultimate-fake-object-store">The ultimate fake object store<a href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#the-ultimate-fake-object-store" class="heading-link pl-2 text-italic text-bold" aria-label="The ultimate fake object store"></a></h2>
<p>While exploiting <a href="https://securitylab.github.com/research/one_day_short_of_a_fullchain_android/">another bug</a>, I came across the Software Input Output Translation Lookaside Buffer (SWIOTLB), which is a memory region that is allocated at a very early stage during boot time. As such, the physical address of the SWIOTLB is very much fixed and depends only on the hardware configuration. Moreover, as this memory is in the “low memory” region (Android devices do not seem to have a “high memory” region) and not in the kernel image, the virtual address is simply the physical address with a fixed offset (readers who are interested in the details can, for example, follow the implementation of the <code>kmap</code> function):</p>
<pre><code class="hljs language-scss"><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">__virt_to_phys_nodebug</span>(x) ({                   \
    phys_addr_t __x = (phys_addr_t)(__tag_reset(x));        \
    <span class="hljs-built_in">__is_lm_address</span>(__x) ? <span class="hljs-built_in">__lm_to_phys</span>(__x) : __kimg_to_phys(__x); \
})
<span class="hljs-selector-id">#define</span> <span class="hljs-built_in">__is_lm_address</span>(addr)  (!(((u64)addr) &amp; <span class="hljs-built_in">BIT</span>(vabits_actual - <span class="hljs-number">1</span>)))

<span class="hljs-selector-id">#define</span> <span class="hljs-built_in">__lm_to_phys</span>(addr) (((addr) + physvirt_offset))
</code></pre>
<p>The above definitions are from <code><a href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/arch/arm64/include/asm/memory.h">arch/arm64/include/asm/memory.h</a></code>, which is the relevant implementation for Android. The variable <code>physvirt_offset</code> used for translating the address is a fixed constant set in <code><a href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/arch/arm64/mm/init.c#L517">arm64_memblock_init</a></code>:</p>
<pre><code class="hljs language-csharp"><span class="hljs-keyword">void</span> __<span class="hljs-function"><span class="hljs-keyword">init</span> <span class="hljs-title">arm64_memblock_init</span>(<span class="hljs-params"><span class="hljs-keyword">void</span></span>)</span>
{...
    memstart_addr = round_down(memblock_start_of_DRAM(),
                   ARM64_MEMSTART_ALIGN);
    physvirt_offset = PHYS_OFFSET - PAGE_OFFSET;

 ...
}
</code></pre>
<p>On top of that, the memory in the SWIOTLB can be accessed via the <code>adsp</code> driver that is reachable from an untrusted app, so this seems to be a good place to store fake objects and redirect fake pointers to. However, in the 5.x version of the kernel, the SWIOTLB is only allocated when the kernel is compiled with the <code>CONFIG_DMA_ZONE32</code> flag, which is not the case for our device.</p>
<p>There is, however, something better. The fact that the early allocation of SWIOTLB gives it a predictable address prompted me to inspect the boot log to see if there are other regions of memory that are allocated early during the boot, and it turns out that there are indeed other memory regions that are allocated very early during the boot.</p>
<pre><code class="hljs language-yaml"><span class="hljs-string">&lt;6&gt;[</span>    <span class="hljs-number">0.000000</span><span class="hljs-string">]</span> [<span class="hljs-attr">0:        swapper:</span>    <span class="hljs-number">0</span>]  <span class="hljs-attr">Reserved memory:</span> <span class="hljs-string">created</span> <span class="hljs-string">CMA</span> <span class="hljs-string">memory</span> <span class="hljs-string">pool</span> <span class="hljs-string">at</span> <span class="hljs-number">0x00000000f2800000</span><span class="hljs-string">,</span> <span class="hljs-string">size</span> <span class="hljs-number">212</span> <span class="hljs-string">MiB</span>
<span class="hljs-string">&lt;6&gt;[</span>    <span class="hljs-number">0.000000</span><span class="hljs-string">]</span> [<span class="hljs-attr">0:        swapper:</span>    <span class="hljs-number">0</span>]  <span class="hljs-attr">OF: reserved mem:</span> <span class="hljs-string">initialized</span> <span class="hljs-string">node</span> <span class="hljs-string">secure_display_region,</span> <span class="hljs-string">compatible</span> <span class="hljs-string">id</span> <span class="hljs-string">shared-dma-pool</span>
<span class="hljs-string">...</span>
<span class="hljs-string">&lt;6&gt;[</span>    <span class="hljs-number">0.000000</span><span class="hljs-string">]</span> [<span class="hljs-attr">0:        swapper:</span>    <span class="hljs-number">0</span>]  <span class="hljs-attr">OF: reserved mem:</span> <span class="hljs-string">initialized</span> <span class="hljs-string">node</span> <span class="hljs-string">user_contig_region,</span> <span class="hljs-string">compatible</span> <span class="hljs-string">id</span> <span class="hljs-string">shared-dma-pool</span>
<span class="hljs-string">&lt;6&gt;[</span>    <span class="hljs-number">0.000000</span><span class="hljs-string">]</span> [<span class="hljs-attr">0:        swapper:</span>    <span class="hljs-number">0</span>]  <span class="hljs-attr">Reserved memory:</span> <span class="hljs-string">created</span> <span class="hljs-string">CMA</span> <span class="hljs-string">memory</span> <span class="hljs-string">pool</span> <span class="hljs-string">at</span> <span class="hljs-number">0x00000000f0c00000</span><span class="hljs-string">,</span> <span class="hljs-string">size</span> <span class="hljs-number">12</span> <span class="hljs-string">MiB</span>

<span class="hljs-string">&lt;6&gt;[</span>    <span class="hljs-number">0.578613</span><span class="hljs-string">]</span> [<span class="hljs-attr">7:      swapper/0:</span>    <span class="hljs-number">1</span>]  <span class="hljs-string">platform</span> <span class="hljs-string">soc:qcom,ion:qcom,ion-heap@22:</span> <span class="hljs-string">assigned</span> <span class="hljs-string">reserved</span> <span class="hljs-string">memory</span> <span class="hljs-string">node</span> <span class="hljs-string">sdsp_region</span>
<span class="hljs-string">...</span>
<span class="hljs-string">&lt;6&gt;[</span>    <span class="hljs-number">0.578829</span><span class="hljs-string">]</span> [<span class="hljs-attr">7:      swapper/0:</span>    <span class="hljs-number">1</span>]  <span class="hljs-string">platform</span> <span class="hljs-string">soc:qcom,ion:qcom,ion-heap@26:</span> <span class="hljs-string">assigned</span> <span class="hljs-string">reserved</span> <span class="hljs-string">memory</span> <span class="hljs-string">node</span> <span class="hljs-string">user_contig_region</span>
<span class="hljs-string">...</span>
</code></pre>
<p>The <code>Reserved memory</code> regions in the above seem to be the memory pools that are used for allocating ion buffers.</p>
<p>On Android, the <code><a href="https://lwn.net/Articles/480055/">ion_allocator</a></code> is used to allocate memory regions used for DMA (direct memory access) that allows kernel drivers and userspace processes to share the same underlying memory. The ion allocator is accessible by an untrusted app via the <code>/dev/ion</code> file, and the <code>ION_IOC_ALLOC</code> ioctl can be used to allocate an ion buffer. The ioctl returns a new file descriptor to the user, which can then be used in the <code>mmap</code> syscall to map the backing store of the ion buffer to userspace.</p>
<p>One particular reason for using the ion buffers is that the user can request memory that has contiguous physical addresses. This is particularly important as some devices (as in devices on the hardware, not the phone itself) access physical memory directly and having contiguous memory addresses can greatly improve the performance of such memory accesses, while some devices cannot handle non contiguous physical memory.</p>
<p>Similar to SWIOTLB, in order to ensure a region of contiguous physical memory with the requested size is available, the ion driver allocates these memory regions very early in the boot and uses them as memory pools (“carved out regions”), which are then used to allocate ion buffers later on when requested. Not all memory pools in the ion device are contiguous memory (for example, the general purpose “system heap” may not be a physically contiguous region), but the user can specify the <code>heap_id_mask</code> when using <code>ION_IOC_ALLOC</code> to specify the ion heap with specific properties (for example, contiguous physical memory).</p>
<p>The fact that these memory pools are allocated at such an early stage means that their addresses are predictable and depend only on the configuration of the hardware (device tree, available memory, start of memory address, various boot parameters, etc.). This, in particular, means that if I allocate an ion buffer from a rarely used memory pool using <code>ION_IOC_ALLOC</code>, the buffer will most likely be allocated at a predictable address. If I then use <code>mmap</code> to map the buffer to userspace, I’ll be able to access the memory at this predictable address at any time!</p>
<p>After some experimentation, it seems that the <code>user_contig_region</code> is almost never used and I was able to map the entire region to userspace everytime. So in the exploit, I used this memory pool and assumed that I can allocate the entire region to keep it simple. (It would be easy to modify the exploit to accommodate the case where part of the region is not available without compromising reliability.)</p>
<p>Now that I am able to put controlled data at a predictable address, I can resolve the problem I encountered previously in the exploit. Recall that, when <code>dma_fence_release</code> is called on my fake <code>fence</code> object:</p>
<pre><code class="hljs language-scss">void <span class="hljs-built_in">dma_fence_release</span>(struct kref *kref)
{
    ...
    if (fence-&gt;ops-&gt;release)
        fence-&gt;ops-&gt;<span class="hljs-built_in">release</span>(fence);
    else
        <span class="hljs-built_in">dma_fence_free</span>(fence);
}
</code></pre>
<p>I had a problem where I needed <code>fence-&gt;ops</code> to point to a valid address that contains all zeros, so that <code>fence-&gt;ops-&gt;release</code> will not be called (as I do not have a valid function address that matches the signature of <code>fence-&gt;ops-&gt;release</code> at this stage and taking this path would crash the kernel)</p>
<p>With the ion buffer at a predictable address, I can simply fill it with zero and have <code>fence-&gt;ops</code> point there. This will ensure the path <code>dma_fence_free</code> is taken, which will then free my fake object, giving me a double free primitive while preventing a kernel crash. Before proceeding to exploit this double free primitive, there is, however, another issue that needs resolving first.</p>
<h2 id="escaping-an-infinite-loop">Escaping an infinite loop<a href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#escaping-an-infinite-loop" class="heading-link pl-2 text-italic text-bold" aria-label="Escaping an infinite loop"></a></h2>
<p>Recall that, in the <code>kgsl_ioctl_timeline_destroy</code> function, after the <code>fence</code> object is destroyed and replaced, the following loop is executed:</p>
<pre><code class="hljs language-scss">    <span class="hljs-built_in">spin_lock_irq</span>(&amp;timeline-&gt;lock);
    <span class="hljs-built_in">list_for_each_entry_safe</span>(fence, tmp, &amp;temp, node) {
        <span class="hljs-built_in">dma_fence_set_error</span>(&amp;fence-&gt;base, -ENOENT);
        <span class="hljs-built_in">dma_fence_signal_locked</span>(&amp;fence-&gt;base);
        <span class="hljs-built_in">dma_fence_put</span>(&amp;fence-&gt;base);
    }
    <span class="hljs-built_in">spin_unlock_irq</span>(&amp;timeline-&gt;lock);
</code></pre>
<p>The <code>list_for_each_entry_safe</code> will first take the <code>next</code> pointer from the <code>list_head</code> <code>temp</code> to find the first <code>fence</code> entry in the list, and then iterate by following the <code>next</code> pointer in <code>fence-&gt;node</code> until the <code>next</code> entry points back to <code>temp</code> again. If the <code>next</code> entry does not point back to <code>temp</code>, then the loop will just carry on following the <code>next</code> pointer indefinitely. This is a place where variable initialization makes life more difficult. Look at the layout of <code>kgsl_timeline_fence</code>, which embeds a <code>dma_fence</code> object that is added to the <code>kgsl_timeline</code>:</p>
<pre><code class="hljs language-csharp"><span class="hljs-keyword">struct</span> kgsl_timeline_fence {
    <span class="hljs-keyword">struct</span> dma_fence <span class="hljs-keyword">base</span>;
    <span class="hljs-keyword">struct</span> kgsl_timeline *timeline;
    <span class="hljs-keyword">struct</span> list_head node;
};
</code></pre>
<p>I can see that the <code>node</code> field is the last field in <code>kgsl_timeline_fence</code>, while to construct the exploit, I only need to replace <code>base</code> with controlled data. The above problem would have been solved easily with partial object replacement. Without automatic variable initialization, if I only replace the free’d <code>kgsl_timeline_fence</code> with an object that is of the size of a <code>dma_fence</code>, then the fields <code>timeline</code> and <code>node</code> would remain intact and contain valid data. This would both cause the <code>next</code> pointer in <code>node</code> to be valid and allow the loop in <code>kgsl_ioctl_timeline_destroy</code> to exit normally. However, with automatic variable initialization, even if I replace the free’d <code>kgsl_timeline_fence</code> object with a smaller object, the entire memory chunk would be set to zero first, erasing both <code>kgsl_timeline</code> and <code>node</code>, meaning that I now have to fake the <code>node</code> field so that:</p>
<ol>
<li>The <code>next</code> pointer points to a valid address to avoid an immediate crash, in fact, more than that, it needs to point to an object that is another fake <code>kgsl_timeline_fence</code> that can be operated by the functions in the loop (<code>dma_fence_set_error</code>, <code>dma_fence_signal_locked</code> and <code>dma_fence_put</code>) without crashing. That means more fake objects need to be crafted.</li>
<li>One of the <code>next</code> pointers in these fake <code>kgsl_timeline_fence</code> objects points back to the <code>temp</code> list to exit the loop, which is a stack allocated variable.</li>
</ol>
<p>The first requirement is not too hard, as I can now use the ion buffer to create these fake <code>kgsl_timeline_fence</code> objects. The second requirement, however, is much harder.</p>
<p>On the face of it, this obstacle may seem more like an aesthetic issue rather than a real problem. After all, I can create the fake objects so that the list becomes circular within the fake <code>kgsl_timeline_fence</code> objects:</p>
<div class="image-frame image-frame-full border rounded-2 overflow-hidden d-flex flex-row flex-justify-center" style="background: #EAEEF2"><img loading="lazy" src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/Kernel-4.png" alt="" width="623" height="525" class="alignnone size-full wp-image-65551 width-fit" srcset="https://github.blog/wp-content/uploads/2022/06/Kernel-4.png?resize=623%2C525?w=623 623w, https://github.blog/wp-content/uploads/2022/06/Kernel-4.png?resize=623%2C525?w=300 300w" sizes="(max-width: 623px) 100vw, 623px" data-recalc-dims="1"></div>
<p>This would cause an infinite loop and hold up a CPU. While it is ugly, the fake objects should take care of the dereferencing issues and avoid crashes, so it may not be a fatal issue after all. Unfortunately, as the loop runs inside a <code>spinlock</code>, after running for a short while, it seems that the watchdog will flag it as a CPU hogging issue and trigger a kernel panic. So, I do need to find a way to exit the loop, and exit it quickly.</p>
<p>Let’s take a step back and take a look at the function <code>dma_fence_signal_locked</code>:</p>
<pre><code class="hljs language-scss">int <span class="hljs-built_in">dma_fence_signal_locked</span>(struct dma_fence *fence)
{
    ...
    struct list_head cb_list;
    ...
    <span class="hljs-comment">/* Stash the cb_list before replacing it with the timestamp */</span>
    <span class="hljs-built_in">list_replace</span>(&amp;fence-&gt;cb_list, &amp;cb_list);             <span class="hljs-comment">//&lt;-- 1.</span>
    ...
    <span class="hljs-built_in">list_for_each_entry_safe</span>(cur, tmp, &amp;cb_list, node) { <span class="hljs-comment">//&lt;-- 2.</span>
        <span class="hljs-built_in">INIT_LIST_HEAD</span>(&amp;cur-&gt;node);
        cur-&gt;<span class="hljs-built_in">func</span>(fence, cur);
    }

    return <span class="hljs-number">0</span>;
}
</code></pre>
<p>This function will be run for each of the fake <code>dma_fence</code> in the list <code>temp</code> (the original free’d and replaced <code>dma_fence</code>, plus the ones that it links to in the ion buffer). As mentioned before, if the code at 2. in the above is run, then the kernel will probably crash because I cannot provide a valid <code>func</code>, so I still would like to avoid running that path.</p>
<p>In order to be able to run this code but not the loop code in 2. above, I need to initialize <code>fence.cb_list</code> to be an empty list, so that its <code>next</code> and <code>prev</code> both point to itself. This is not possible with the initial fake <code>dma_fence</code> that was free’d by the vulnerability, because the address of <code>fence</code> and hence <code>fence.cb_list</code> is unknown, so I had to avoid the <code>list_replace</code> code altogether for this first fake object. However, because the subsequent fake <code>dma_fence</code> objects that are linked to it are in an ion buffer with a known address, I can now create an empty <code>cb_list</code> for these objects, setting both the <code>next</code> and <code>prev</code> pointers to the addresses of the <code>fence.cb_list</code> field. The function <code>list_replace</code> will then do the following:</p>
<pre><code class="hljs language-cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">list_replace</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> list_head *old,
                <span class="hljs-keyword">struct</span> list_head *<span class="hljs-keyword">new</span>)</span>
</span>{
    <span class="hljs-comment">//old-&gt;next = &amp;(fence-&gt;cb_list)</span>
    <span class="hljs-keyword">new</span>-&gt;next = old-&gt;next;
    <span class="hljs-comment">//new-&gt;next = &amp;(fence-&gt;cb_list) =&gt; fence-&gt;cb_list.prev = &amp;cb_list</span>
    <span class="hljs-keyword">new</span>-&gt;next-&gt;prev = <span class="hljs-keyword">new</span>;
    <span class="hljs-comment">//new-&gt;prev = fence-&gt;cb_list.prev =&gt; &amp;cb_list</span>
    <span class="hljs-keyword">new</span>-&gt;prev = old-&gt;prev;
    <span class="hljs-comment">//&amp;cb_list-&gt;next = &amp;cb_list</span>
    <span class="hljs-keyword">new</span>-&gt;prev-&gt;next = <span class="hljs-keyword">new</span>;
}
</code></pre>
<p>As we can see, after <code>list_replace</code>, the address of the stack variable <code>cb_list</code> has been written to <code>fence-&gt;cb_list.prev</code>, which is somewhere in the ion buffer. As the ion buffer is mapped to user space, I can simply read this address by polling the ion buffer. As <code>dma_fence_signal_locked</code> is run inside <code>kgsl_ioctl_timeline_destroy</code> after the stack variable <code>temp</code> is allocated:</p>
<pre><code class="hljs language-scss">long <span class="hljs-built_in">kgsl_ioctl_timeline_destroy</span>(struct kgsl_device_private *dev_priv,
        unsigned int cmd, void *data)
{
    ...
    struct list_head temp;
    ...


    <span class="hljs-built_in">spin_lock_irq</span>(&amp;timeline-&gt;lock);
    <span class="hljs-built_in">list_for_each_entry_safe</span>(fence, tmp, &amp;temp, node) {
        <span class="hljs-built_in">dma_fence_set_error</span>(&amp;fence-&gt;base, -ENOENT);
        <span class="hljs-comment">//cb_list, is a stack variable allocated inside `dma_fence_signal_locked`</span>
        <span class="hljs-built_in">dma_fence_signal_locked</span>(&amp;fence-&gt;base);
        <span class="hljs-built_in">dma_fence_put</span>(&amp;fence-&gt;base);
    }
    <span class="hljs-built_in">spin_unlock_irq</span>(&amp;timeline-&gt;lock);
    ...
}
</code></pre>
<p>Having the address of <code>cb_list</code> allows me to compute the address of <code>temp</code>, (which will be at a fixed offset from the address of <code>cb_list</code>), so by polling for the address of <code>cb_list</code> and then using this to compute the address of <code>temp</code> and write it back into the <code>next</code> pointer of one of the fake <code>kgsl_timeline_fence</code> objects in the ion buffer, I can exit the loop before the watch dog bites.</p>
<div class="image-frame image-frame-full border rounded-2 overflow-hidden d-flex flex-row flex-justify-center" style="background: #EAEEF2"><img loading="lazy" src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/Kernel-5.png" alt="" width="960" height="540" class="alignnone size-full wp-image-65552 width-fit" srcset="https://github.blog/wp-content/uploads/2022/06/Kernel-5.png?resize=960%2C540?w=960 960w, https://github.blog/wp-content/uploads/2022/06/Kernel-5.png?resize=960%2C540?w=300 300w, https://github.blog/wp-content/uploads/2022/06/Kernel-5.png?resize=960%2C540?w=768 768w" sizes="(max-width: 960px) 100vw, 960px" data-recalc-dims="1"></div>
<h2 id="hijacking-the-freelist">Hijacking the freelist<a href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#hijacking-the-freelist" class="heading-link pl-2 text-italic text-bold" aria-label="Hijacking the freelist"></a></h2>
<p>Now that I am able to avoid kernel crashes, I can continue to exploit the double free primitive mentioned earlier. To recap, once the initial use-after-free vulnerability is triggered and the free’d object is successfully replaced with controlled data using <code>sendmsg</code>, the replaced object will be used in the following loop as <code>fence</code>:</p>
<pre><code class="hljs language-scss">    <span class="hljs-built_in">spin_lock_irq</span>(&amp;timeline-&gt;lock);
    <span class="hljs-built_in">list_for_each_entry_safe</span>(fence, tmp, &amp;temp, node) {
        <span class="hljs-built_in">dma_fence_set_error</span>(&amp;fence-&gt;base, -ENOENT);
        <span class="hljs-built_in">dma_fence_signal_locked</span>(&amp;fence-&gt;base);
        <span class="hljs-built_in">dma_fence_put</span>(&amp;fence-&gt;base);
    }
    <span class="hljs-built_in">spin_unlock_irq</span>(&amp;timeline-&gt;lock);
</code></pre>
<p>In particular, <code>dma_fence_put</code> will reduce the refcount of the fake object and if the refcount reaches zero, it’ll call <code>dma_fence_free</code>, which will then free the object with <code>kfree_rcu</code>. Since the fake object is in complete control and I was able to resolve various issues that may lead to kernel crashes, I will now assume that this is the code path that is taken and that the fake object will be freed by <code>kfree_rcu</code>. By replacing the fake object again with another object, I can then obtain two references to the same object, which I will be able to free at any time using either of these object handles. The general idea is that, when a memory chunk is freed, the freelist pointer, which points to the next free chunk, will be written to the first 8 bytes of the memory chunk. If I free the object from one handle, and then modify the first 8 bytes of this free’d object using another handle, then I can hijack the freelist pointer and have it point to an address of my choice, which is where the next allocation will happen. (This is an overly simplified version of what happens as this is only true when the free and allocation are from the same slab, pages used by the memory allocator—SLUB allocator in this case—to allocate memory chunks, with allocation done via the fast path, but this scenario is not difficult to achieve.)</p>
<p>In order to be able to modify the first 8 bytes of the object after it was allocated, I’ll use the <code>signalfd</code> object used in “<a href="https://googleprojectzero.blogspot.com/2020/02/mitigations-are-attack-surface-too.html">Mitigations are attack surface too</a>”. The <code>signalfd</code> syscall allocates an 8 byte object to store a mask for the <code>signalfd</code> file, which can be specified by the user with some minor restrictions. The lifetime of the allocated object is tied to the <code>signalfd</code> file that is returned to the user and can be controlled easily by closing the file. Moreover, the first 8 bytes in this object can be changed by calling <code>signalfd</code> again with a different mask. This makes <code>signalfd</code> ideal for my purpose.</p>
<p>To hijack the freelist pointer, I have to do the following:</p>
<ol>
<li>Trigger the UAF bug and replaced the free’d <code>dma_fence</code> object with a fake <code>dma_fence</code> object allocated via <code>sendmsg</code> such that <code>dma_fence_free</code> will be called to free this fake object with <code>kfree_rcu</code>.</li>
<li>Spray the heap with <code>signalfd</code> to allocate another object at the same address as the <code>sendmsg</code> object after it was freed. </li>
<li>Free the <code>sendmsg</code> object so that the freelist pointer is written to the mask of the <code>signalfd</code> object in step two. </li>
<li>Modify the mask of the <code>signalfd</code> object so that the freelist pointer now points to an address of my choice, then spray the heap again to allocate objects at that address.</li>
</ol>
<p>If I set the address of the freelist pointer to the address of an ion buffer that I control, then subsequent allocations will place objects in the ion buffer, which I can then access and modify at any time. This gives me a very strong primitive in that I can read and modify any object that I allocate. Essentially, I can fake my own kernel heap in a region where I have both read and write access.</p>
<div class="image-frame image-frame-full border rounded-2 overflow-hidden d-flex flex-row flex-justify-center" style="background: #EAEEF2"><img loading="lazy" src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/Kernel-6.png" alt="" width="960" height="540" class="alignnone size-full wp-image-65553 width-fit" srcset="https://github.blog/wp-content/uploads/2022/06/Kernel-6.png?resize=960%2C540?w=960 960w, https://github.blog/wp-content/uploads/2022/06/Kernel-6.png?resize=960%2C540?w=300 300w, https://github.blog/wp-content/uploads/2022/06/Kernel-6.png?resize=960%2C540?w=768 768w" sizes="(max-width: 960px) 100vw, 960px" data-recalc-dims="1"></div>
<p>The main hurdle to this plan comes from the combination of <code>kfree_rcu</code> and the fact that the CPU running <code>dma_fence_put</code> will be temporarily trapped in a busy loop after <code>kfree_rcu</code> is called. Recall from the previous section that, until I am able to exit the loop by writing the address of the <code>temp</code> list to the <code>next</code> pointer of one of the fake <code>kgsl_timeline_fence::node</code> objects, the loop will be running. This, in particular, means that once <code>kfree_rcu</code> is called and <code>dma_fence_put</code> is exited, the loop will continue to process the other fake <code>dma_fence</code> objects on the CPU that is running <code>kfree_rcu</code>. As explained earlier, <code>kfree_rcu</code> does not immediately free an object, but rather schedules its removal. Most of the time, the free will actually happen on the same CPU that calls <code>kfree_rcu</code>. However, in this case, because the CPU running <code>kfree_rcu</code> is kept busy inside a <code>spinlock</code> by running the loop, the object will almost certainly not be free’d on that same CPU. Instead, a different CPU will be used to free the object. This causes a problem because the reliability of object replacement depends on the CPU that is used for freeing the object. When an object is freed on a CPU, the memory allocator will place it in a per CPU cache. An allocation that follows immediately on the same CPU will first look for free space in the CPU cache and is most likely going to replace that newly freed object. However, if the allocation happens on a different CPU, then it’ll most likely replace an object in the cache of a different CPU, rather than the newly freed object. Not knowing which CPU is responsible for freeing the object, together with the uncertainty of when the object is freed (because of the delay introduced by <code>kfree_rcu</code>) means that it may be difficult to replace the object. In practice, however, I was able to achieve reasonable results on the testing device (&gt;70% success rate) with a rather simple scheme: Simply run a loop that spray objects on each CPU and repeat the spraying in intervals to account for the uncertainty in the timing. There is probably room for improvement here to make the exploit more reliable.</p>
<p>Another slight modification used in the exploit was to also replace the <code>sendmsg</code> objects after they are freed with another round of <code>signalfd</code> heap spray. This is to ensure that those <code>sendmsg</code> objects don’t accidentally get replaced by objects that I don’t control which may interfere with the exploit, as well as to make it easier to identify the actual corrupted object.</p>
<p>Now that I can hijack the freelist and redirect new object allocations to the ion buffer that I can freely access at any time, I need to turn this into an arbitrary memory read and write primitive.</p>
<h2 id="the-device-memory-mirroring-attack">The Device Memory Mirroring Attack<a href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#the-device-memory-mirroring-attack" class="heading-link pl-2 text-italic text-bold" aria-label="The Device Memory Mirroring Attack"></a></h2>
<p>Kernel drivers often need to map memory to the user space, and as such, there are often structures that contain pointers to the <code>page</code> struct or the <code>sg_table</code> struct. These structures often hold pointers to pages that would be mapped to user space when, for example, <code>mmap</code> is called. This makes them very good corruption targets. For example, the <code>ion_buffer</code> object that I have already used is available on all Android devices. It has a <code>sg_table</code> struct that contains information about the pages that will get mapped to user space when <code>mmap</code> is used.</p>
<p>Apart from being widely available and accessible from untrusted apps, <code>ion_buffer</code> objects also solve a few other problems, so in what follows, I’ll use the freelist hijacking primitive above to allocate an <code>ion_buffer</code> struct in an ion buffer backing store that I have arbitrary read and write access to. By doing so, I can freely corrupt the data in all of the <code>ion_buffer</code> structs that are allocated. To avoid confusion, from now on, I’ll use the term “fake kernel heap” to indicate the ion buffer backing store that I use as the fake kernel heap and <code>ion_buffer</code> struct as the structures that I allocate in the fake heap for use as corruption targets.</p>
<p>The general idea here is that, by allocating <code>ion_buffer</code> structs in the fake kernel heap, I’ll be able to modify the <code>ion_buffer</code> struct and replace its <code>sg_table</code> with controlled data. The <code>sg_table</code> structure contains a <code>scatterlist</code> structure that represents a collection of pages that back the <code>ion_buffer</code> structure:</p>
<pre><code class="hljs language-cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">sg_table</span> {
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">scatterlist</span> *sgl;    <span class="hljs-comment">/* the list */</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nents;     <span class="hljs-comment">/* number of mapped entries */</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> orig_nents;    <span class="hljs-comment">/* original size of list */</span>
};

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">scatterlist</span> {
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>   page_link;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>    offset;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>    length;
    <span class="hljs-type">dma_addr_t</span>  dma_address;
<span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_NEED_SG_DMA_LENGTH</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>    dma_length;
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
};
</code></pre>
<p>The <code>page_link</code> field in the <code>scatterlist</code> is an encoded form of a <code>page</code> pointer, indicating the actual <code>page</code> where the backing store of the <code>ion_buffer</code> structure is:</p>
<pre><code class="hljs language-cpp"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">page</span> *<span class="hljs-built_in">sg_page</span>(<span class="hljs-keyword">struct</span> scatterlist *sg)
{
<span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DEBUG_SG</span>
    <span class="hljs-built_in">BUG_ON</span>(<span class="hljs-built_in">sg_is_chain</span>(sg));
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">struct</span> page *)((sg)-&gt;page_link &amp; ~(SG_CHAIN | SG_END));
}
</code></pre>
<p>When <code>mmap</code> is called, the page encoded by <code>page_link</code> will be mapped to user space:</p>
<pre><code class="hljs language-rust">int <span class="hljs-title function_ invoke__">ion_heap_map_user</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ion_heap</span> *heap, <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ion_buffer</span> *buffer,
              <span class="hljs-keyword">struct</span> <span class="hljs-title class_">vm_area_struct</span> *vma)
{
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">sg_table</span> *table = buffer<span class="hljs-punctuation">-&gt;</span>sg_table;
    ...
    <span class="hljs-title function_ invoke__">for_each_sg</span>(table<span class="hljs-punctuation">-&gt;</span>sgl, sg, table<span class="hljs-punctuation">-&gt;</span>nents, i) {
        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">page</span> *page = <span class="hljs-title function_ invoke__">sg_page</span>(sg);
        ...
        <span class="hljs-comment">//Maps pages to user space</span>
        ret = <span class="hljs-title function_ invoke__">remap_pfn_range</span>(vma, addr, <span class="hljs-title function_ invoke__">page_to_pfn</span>(page), len,
                      vma<span class="hljs-punctuation">-&gt;</span>vm_page_prot);
        ...
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>As the <code>page</code> pointer is simply a logical shift of the physical address of the page followed by a constant linear offset (see the definition of <a href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/arch/arm64/include/asm/memory.h#L285">phys_to_page</a>), being able to control <code>page_link</code> allows me to map an arbitrary page to user space. For many devices, this would be sufficient to achieve arbitrary kernel memory read and write because the kernel image is mapped at a fixed physical address (KASLR randomizes the <em>virtual</em> address offset from this fixed physical address), so there is no need to worry about KASLR when working with physical addresses.</p>
<div class="image-frame image-frame-full border rounded-2 overflow-hidden d-flex flex-row flex-justify-center" style="background: #EAEEF2"><img loading="lazy" src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/Kernel-7.png" alt="" width="960" height="540" class="alignnone size-full wp-image-65554 width-fit" srcset="https://github.blog/wp-content/uploads/2022/06/Kernel-7.png?resize=960%2C540?w=960 960w, https://github.blog/wp-content/uploads/2022/06/Kernel-7.png?resize=960%2C540?w=300 300w, https://github.blog/wp-content/uploads/2022/06/Kernel-7.png?resize=960%2C540?w=768 768w" sizes="(max-width: 960px) 100vw, 960px" data-recalc-dims="1"></div>
<p>Samsung devices, however, do KASLR differently. Instead of mapping the kernel image to a fixed physical address, the physical address of the kernel image is randomized (strictly speaking, the intermediate physical address as perceived by the kernel, which is not the real physical address but rather a virtual address given by the hypervisor) instead. So in our case, I still need to leak an address to defeat KASLR. With the fake kernel heap, however, this is fairly easy to achieve. An <code>ion_buffer</code> object contains a pointer to an <code>ion_heap</code>, which is responsible for allocating the backing stores for the <code>ion_buffer</code>:</p>
<pre><code class="hljs language-cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ion_buffer</span> {
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">list_head</span> list;
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ion_heap</span> *heap;
    ...
};
</code></pre>
<p>While the <code>ion_heap</code> is not an global object in the kernel image, each <code>ion_heap</code> contains an <code>ion_heap_ops</code> field, which points to the corresponding “vtable” of the specific <code>ion_heap</code> object:</p>
<pre><code class="hljs language-rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ion_heap</span> {
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">plist_node</span> node;
    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ion_heap_type</span> <span class="hljs-keyword">type</span>;
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ion_heap_ops</span> *ops;
    ...
}
</code></pre>
<p>The <code>ops</code> field in the above is a global object in the kernel image. If I can read <code>ion_buffer-&gt;heap-&gt;ops</code>, then I’m also able to get an address to defeat KASLR and translate addresses in the kernel image to physical addresses. This can be done as follows:</p>
<p>1) First locate the <code>ion_buffer</code> struct in the fake kernel heap. This can be done using the <code>flags</code> field in the <code>ion_buffer</code>:</p>
<pre><code class="hljs language-cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ion_buffer</span> {
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">list_head</span> list;
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ion_heap</span> *heap;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;
    ...
</code></pre>
<p>which is a 4 byte value passed from the parameters of the <code>ION_IOC_ALLOC</code> ioctl when the <code>ion_buffer</code> is created. I can set these to specific “magic” values and search for them in the fake kernel heap.</p>
<p>2) Once the <code>ion_buffer</code> struct is located, read its <code>heap</code> pointer. This will be a virtual address in the low memory area outside of the kernel image, and as such, its physical address can be obtained by applying a constant offset.</p>
<p>3) Once the physical address of the corresponding <code>ion_heap</code> object is obtained, modify the <code>sg_table</code> of the <code>ion_buffer</code> so that its backing store points to the page containing the <code>ion_heap</code>. 4. Call <code>mmap</code> on the <code>ion_buffer</code> file descriptor, this will map the page containing the <code>ion_heap</code> to user space. This page can then be read directly from user space to obtain the <code>ops</code> pointer, which will give the KASLR offset.</p>
<p>The use of the <code>ion_buffer</code> struct also solves another problem. While the fake kernel heap is convenient, it is not perfect. Whenever an object in the fake kernel heap is freed, <code>kfree</code> will check whether the page containing the object is a single page slab from the SLUB allocator by using the <code>PageSlab</code> check. If the check fails, then the <code>PageCompound</code> check will be performed to check whether the page is part of a bigger slab.</p>
<pre><code class="hljs language-cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">kfree</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *x)</span>
</span>{
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">page</span> *page;
    <span class="hljs-type">void</span> *object = (<span class="hljs-type">void</span> *)x;

    <span class="hljs-built_in">trace_kfree</span>(_RET_IP_, x);

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">unlikely</span>(<span class="hljs-built_in">ZERO_OR_NULL_PTR</span>(x)))
        <span class="hljs-keyword">return</span>;

    page = <span class="hljs-built_in">virt_to_head_page</span>(x);
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">unlikely</span>(!<span class="hljs-built_in">PageSlab</span>(page))) {     <span class="hljs-comment">//&lt;-------- check if the page allocated is a single page slab</span>
        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order = <span class="hljs-built_in">compound_order</span>(page);

        <span class="hljs-built_in">BUG_ON</span>(!<span class="hljs-built_in">PageCompound</span>(page));     <span class="hljs-comment">//&lt;-------- check if the page is allocated as part of a multipage slab</span>
        ...
    }
    ...
}
</code></pre>
<p>As these checks are performed on the <code>page</code> struct itself, which contains metadata to the page, they will fail and cause the kernel to crash whenever an object is freed. This can be fixed by using the arbitrary read and write primitives that I now have to overwrite the respective metadata in the <code>page</code> struct (the address of a <code>page</code> struct that corresponds to a physical address is simply a logical shift of the physical address followed by a translation of a fixed offset, so I can map the <code>page</code> containing the <code>page</code> struct to user space and modify its content). It would, however, be simpler if I can ensure that the objects that occupy the fake kernel heap never get freed. Before an <code>ion_buffer</code> struct is freed, <code>ion_buffer_destroy</code> is called:</p>
<pre><code class="hljs language-cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">ion_buffer_destroy</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> ion_device *dev, <span class="hljs-keyword">struct</span> ion_buffer *buffer)</span>
</span>{
    ...
    heap = buffer-&gt;heap;
    ...
    <span class="hljs-keyword">if</span> (heap-&gt;flags &amp; ION_HEAP_FLAG_DEFER_FREE)
        <span class="hljs-built_in">ion_heap_freelist_add</span>(heap, buffer);    <span class="hljs-comment">//&lt;--------- does not free immediately</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">ion_buffer_release</span>(buffer);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>If the <code>ion_heap</code> contains the flag <code>ION_HEAP_FLAG_DEFER_FREE</code>, then the <code>ion_buffer</code> will not be freed immediately, but instead gets added to the <code>free_list</code> of the <code>ion_heap</code> using <code>ion_heap_freelist_add</code>. The <code>ion_buffer</code> objects added to this list will only be freed at a later stage when needed and only if the <code>ION_HEAP_FLAG_DEFER_FREE</code> flag is set. Normally, of course, the <code>ION_HEAP_FLAG_DEFER_FREE</code> does not change over the lifetime of the <code>ion_heap</code>, but with our arbitrary memory write primitive, I can simply add <code>ION_HEAP_FLAG_DEFER_FREE</code> to the <code>ion_heap-&gt;flags</code>, free the <code>ion_buffer</code>, and then remove <code>ION_HEAP_FLAG_DEFER_FREE</code> again and the <code>ion_buffer</code> will just get stuck in the freelist of the <code>ion_heap</code> and never get freed. Moreover, the page containing the <code>ion_heap</code> object is already mapped for the purpose of defeating KASLR, so toggling the flag is fairly trivial. By spraying the fake kernel heap so that it is filled with <code>ion_buffer</code> objects and their dependents, I can ensure that those objects are never freed and avoid the kernel crash.</p>
<h2 id="bypassing-selinux">Bypassing SELinux<a href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#bypassing-selinux" class="heading-link pl-2 text-italic text-bold" aria-label="Bypassing SELinux"></a></h2>
<p>When SELinux is enabled, it can be run in either the <code>permissive</code> mode or the <code>enforcing</code> mode. When in <code>permissive</code> mode, it will only audit and log unauthorized accesses but will not block them. The mode in which SELinux is run is controlled by the <code>selinux_enforcing</code> variable. If this variable is zero, then SELinux is run in <code>permissive</code> mode. Normally, variables that are critical to the security of the system are protected by Samsung’s Kernel Data Protection (KDP), by marking them as read-only using the <code>__kdp_ro</code> or the <code>__rkp_ro</code> attribute. This attribute indicates that the variable is in a read-only page and its modification is guarded by hypervisor calls. However, to my surprise, it seems that Samsung has forgotten to protect this variable (<a href="https://securitylab.github.com/research/qualcomm_npu/">again?!</a>) in the 5.x branch Qualcomm kernel:</p>
<pre><code class="hljs language-cpp"><span class="hljs-comment">//In security/selinux/hooks.c</span>
<span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SECURITY_SELINUX_DEVELOP</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> selinux_enforcing_boot;
<span class="hljs-type">int</span> selinux_enforcing;
</code></pre>
<p>So, I can just overwrite <code>selinux_enforcing</code> to zero and set SELinux to the <code>permissive</code> mode. While there are other means to bypass SELinux (such as the one used in this <a href="https://github.com/chompie1337/s8_2019_2215_poc/blob/master/poc/selinux_bypass.c">exploit</a> by Valentina Palmiotti) that work more universally, a shortcut at this point is more than welcome, so I’ll just set the <code>selinux_enforcing</code> variable.</p>
<h2 id="running-arbitrary-root-commands-using-ret2kworkertm">Running arbitrary root commands using ret2kworker(TM)<a href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#running-arbitrary-root-commands-using-ret2kworkertm" class="heading-link pl-2 text-italic text-bold" aria-label="Running arbitrary root commands using ret2kworker(TM)"></a></h2>
<p>A well-known problem with getting root on Samsung devices is the protection imposed by the Samsung’s RKP (Realtime Kernel Protection). A common way to gain root on Android devices is to overwrite the credentials of our own process with the root credentials. However, Samsung’s RKP write protects the credentials of each process, so that is not possible here. In my <a href="https://securitylab.github.com/research/qualcomm_npu/">last exploit</a>, I was able to execute arbitrary code as root because the particular UAF exploited led to a controlled function pointer being executed in code run by a <code>kworker</code>, which is run as root. In that exploit, I was able to corrupt objects that are then added to a work queue, which was then consumed by a <code>kworker</code> and executed by running a function supplied as a function pointer. This made it relatively easy to run arbitrary functions as root.</p>
<p>Of course, with arbitrary memory read and write primitives, it is possible to simply add objects to one of these work queues (which are basically linked lists containing <code>work</code> structs) and wait for a <code>kworker</code> to pick up the work. As it turns out, many of these work queues are indeed static global objects, with fixed addresses in the kernel image:</p>
<pre><code class="hljs language-undefined">ffffffc012c8f7e0 D system_wq
ffffffc012c8f7e8 D system_highpri_wq
ffffffc012c8f7f0 D system_long_wq
ffffffc012c8f7f8 D system_unbound_wq
ffffffc012c8f800 D system_freezable_wq
ffffffc012c8f808 D system_power_efficient_wq
ffffffc012c8f810 D system_freezable_power_efficient_wq
</code></pre>
<p>So, it is relatively straightforward to add entries to these work queues and have a <code>kworker</code> pick up the work. However, because of <code>kCFI</code>, I would only be able to call functions with the following signatures:</p>
<pre><code class="hljs language-go">void (<span class="hljs-function"><span class="hljs-keyword">func</span>*)<span class="hljs-params">(<span class="hljs-keyword">struct</span> work_struct *work)</span></span>
</code></pre>
<p>The problem is whether I can find a powerful enough function to run. It turns out to be fairly simple. The function <code><a href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/blob/5e3cf80f1b6a12fcf54b007f3c9f235f35b9b7f1/kernel/umh.c#L190">call_usermodehelper_exec_work</a></code>, which is commonly used in kernel exploits to run shell commands, fits the bill and will run a shell command supplied by me. So by modifying, say, the <code>system_unbound_wq</code> and adding an entry to it that holds a pointer to <code>call_usermodehelper_exec_work</code>, I can bypass both Samsung’s RKP and kCFI to run arbitrary commands as root.</p>
<p>The exploit can be found <a href="https://github.com/github/securitylab/tree/main/SecurityExploits/Android/Qualcomm/CVE-2022-22057">here</a> with some setup notes.</p>
<h2 id="conclusions">Conclusions<a href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#conclusions" class="heading-link pl-2 text-italic text-bold" aria-label="Conclusions"></a></h2>
<p>In this post, I exploited a UAF with fairly typical primitives and examined how various mitigations affected the exploit. While in the end, I was able to bypass all the mitigations and develop an exploit that is no less reliable than another one that I did <a href="https://securitylab.github.com/research/one_day_short_of_a_fullchain_android/">last year</a>, the mitigations did force the exploit to take a very different, and longer path.</p>
<p>The biggest hurdle was the kCFI, which turned a relatively straightforward exploit into a rather complex one. As explained in the post, the UAF bug offers many primitives to execute an arbitrary function pointer. Combined with a separate information leak (which I happen to have, and is pending disclosure) the bug would have been trivial to exploit as in the case of the <a href="https://securitylab.github.com/research/qualcomm_npu/">NPU bugs</a> I wrote about last year. Instead, the combination of Samsung’s RKP and kCFI made this impossible and forced me to look into an alternative path, which is far less straightforward.</p>
<p>On the other hand, many of the techniques introduced here, such as the ones in “The ultimate fake object store” and “The device memory mirroring attack” can be readily standardized to turn common primitives into arbitrary memory read and write. As we’ve seen, having arbitrary memory read and write, even with the restrictions imposed by Samsung’s RKP, is already powerful enough for many purposes. In this regard, it seems to me that the effect of kCFI may be to shift exploitation techniques in favor of certain primitives over others rather than rendering many bugs unexploitable. It is, after all, as many have said, a mitigation that happens fairly late in the process.</p>
<p>A rather underrated mitigation, perhaps, is automatic variable initialization. While this mitigation mainly targets vulnerabilities that exploit uninitialized variables, we’ve seen that it also prevents partial object replacement, which is a common exploitation technique. In fact, it nearly broke the exploit if it hadn’t been for a piece of luck where I was able to leak the address of a stack variable (see “Escaping an infinite loop”). Not only does this mitigation kill a whole class of bugs, but it also breaks some useful exploit primitives.</p>
<p>We’ve also seen how primitives in manipulating the kernel scheduler enabled us to widen many race windows to allow time for object replacements. This allowed me to overcome the problem posed by the delayed free caused by <code>kfree_rcu</code> (not a mitigation), without significantly compromising the reliability. It seems that, in the context of the kernel, mitigating a UAF with a quarantine and delayed free of objects (an approach adopted by the Scudo allocator for Android user processes) may not be that effective after all.</p>
<h2 id="disclosure-practices-patching-time-and-patch-gapping">Disclosure practices, patching time, and patch gapping<a href="https://github.blog/2022-06-16-the-android-kernel-mitigations-obstacle-race/#disclosure-practices-patching-time-and-patch-gapping" class="heading-link pl-2 text-italic text-bold" aria-label="Disclosure practices, patching time, and patch gapping"></a></h2>
<p>I reported this vulnerability to Qualcomm on November 16 2021 and they publicly disclosed it in early May 2022. It took about six months, which seems to be the standard time Qualcomm takes between receiving a report and publicly disclosing it. In the past, the long disclosure times have led to some researchers disclosing full exploits before vulnerabilities were patched in public (see, for example, <a href="https://googleprojectzero.blogspot.com/2020/09/attacking-qualcomm-adreno-gpu.html">this</a>). Qualcomm employs a rather “special” disclosure process, in which it normally discloses the patch of a vulnerability privately to its customers within 90 days (this is indicated by the “Customer Notified Date” in <a href="https://docs.qualcomm.com/product/publicresources/securitybulletin/may-2022-bulletin.html">Qualcomm’s advisories</a>), but the patch may only be fully integrated and publicly disclosed several months after that.</p>
<p>While this practice gives customers (OEM) time to patch the vulnerabilities before they become public, it creates an opportunity for what is known as “patch gapping.” As patches are first disclosed privately to customers, it means that some customers may decide to apply the patch before it is publicly disclosed, while others may wait until the patch is fully integrated and disclosed publicly and then apply the monthly patch. For example, <a href="https://source.codeaurora.org/quic/la/kernel/msm-5.4/commit/?id=6c58829f4428f2564833743de7135f4451077e75">this patch</a> was applied to the Samsung S21 in July 2021 (by inspecting the <a href="https://opensource.samsung.com/">Samsung open source</a> code), but only publicly disclosed as CVE-2021-30305 in October 2021. By comparing firmware between different vendors, it may be possible to discover vulnerabilities that are privately patched by one vendor, but not the other. As the private disclosure time and public disclosure time are often a few months apart, this leaves ample time to develop an exploit. Moreover, the <a href="https://source.codeaurora.org/quic/la/kernel/msm-5.4/commit/?id=339824df70a0e9e08f2a7151b776d72421050f04">patch</a> for the vulnerability described in this post was publicly visible sometime in December 2021 with a very clear commit message, leaving a five‐month (or two‐month for private disclosure) gap in between. While the exploit is complex, a skilled hacking team could easily have developed and deployed it within that time window. I hope that Qualcomm will improve their patching time or reduce the gap between their private and public disclosure time.</p>

      <div class="post-tags text-mono f4-mktg mt-8">
      <div class="d-flex flex-nowrap flex-items-start">
        <span class="post-tags-label flex-shrink-0 d-inline-block mt-2">Tags:</span> <ul class="d-inline-block list-style-none color-text-link mb-0"><li class="d-inline-block mt-2 mb-0"><a href="https://github.blog/tag/github-security-lab/" rel="tag">GitHub Security Lab</a></li></ul>      </div>
    </div>
  </main>

<div class="col-12 col-md-4 col-lg-3 post__sidebar">

	<aside class="mb-7 mb-md-8 mt-7 mt-md-0"><h2 class="pt-1 table-of-contents-heading color-fg-muted mb-0">More on <a href="https://github.blog/tag/github-security-lab/" class="Link--primary text-bold">GitHub Security Lab</a></h2><article class="py-4 d-flex flex-column"><a href="https://github.blog/2022-06-29-the-chromium-super-inline-cache-type-confusion/" class="d-block col-12 position-relative rounded-2 mb-3 overflow-hidden tease-thumbnail"><svg aria-hidden="true" width="395" height="210" class="width-full height-auto d-block" style="visibility: hidden; pointer-events: none;"></svg><img srcset="https://github.blog/wp-content/uploads/2021/12/GitHub-security_teal-banner.png?resize=288%2C179 288w,https://github.blog/wp-content/uploads/2021/12/GitHub-security_teal-banner.png?resize=512%2C318 512w,https://github.blog/wp-content/uploads/2021/12/GitHub-security_teal-banner.png?resize=708%2C440 708w" src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/GitHub-security_teal-banner(1).png" width="512" height="318" alt="The Chromium super (inline cache) type confusion" class="d-block width-full height-auto rounded-2 tease-thumbnail__img cover-image" loading="lazy" decoding="async"></a><div class="col-12  tease-text"><h3 class="h6-mktg mb-12px"><a href="https://github.blog/2022-06-29-the-chromium-super-inline-cache-type-confusion/" class="Link--primary">The Chromium super (inline cache) type confusion</a></h3><p class="f4-mktg color-fg-muted mb-0">In this post I'll exploit CVE-2022-1134, a type confusion in Chrome that I reported in March 2022, which allows remote code execution (RCE) in the renderer sandbox of Chrome by a single visit to a malicious site. I'll also look at some past vulnerabilities of this type and some implementation details of inline cache in V8, the JavaScript engine of Chrome.</p><div class="mt-14px">
 		<div class="d-flex flex-items-center">
 			
 			<div class="d-flex flex-items-end flex-wrap" style="margin-top: -4px;">
 				<span class="authors-wrap mr-12px mt-1 f5-mktg text-bold"><a class="d-inline-block Link--primary color-fg-default" href="https://github.blog/author/mymo/" title="Man Yue Mo">Man Yue Mo</a></span>
 				
 			</div>
 		</div></div></div></article><article class="py-4 d-flex flex-column border-top"><div class="col-12  tease-text"><h3 class="h6-mktg mb-12px"><a href="https://github.blog/2022-06-10-implementing-a-robust-digital-identity/" class="Link--primary">Implementing a robust digital identity</a></h3><p class="f4-mktg color-fg-muted mb-0"> How can you robustly assert and identify a user’s identity?

</p><div class="mt-14px">
 		<div class="d-flex flex-items-center">
 			
 			<div class="d-flex flex-items-end flex-wrap" style="margin-top: -4px;">
 				<span class="authors-wrap mr-12px mt-1 f5-mktg text-bold"><a class="d-inline-block Link--primary color-fg-default" href="https://github.blog/author/rzhade3/" title="Rahul Zhade">Rahul Zhade</a></span>
 				
 			</div>
 		</div></div></div></article><article class="py-4 d-flex flex-column border-top"><div class="col-12  tease-text"><h3 class="h6-mktg mb-12px"><a href="https://github.blog/2022-05-06-todays-most-common-security-vulnerabilities-explained/" class="Link--primary">Today’s most common security vulnerabilities explained</a></h3><p class="f4-mktg color-fg-muted mb-0">We're taking a look at some of the most common security vulnerabilities and detailing how developers can best protect themselves. </p><div class="mt-14px">
 		<div class="d-flex flex-items-center">
 			
 			<div class="d-flex flex-items-end flex-wrap" style="margin-top: -4px;">
 				<span class="authors-wrap mr-12px mt-1 f5-mktg text-bold"><a class="d-inline-block Link--primary color-fg-default" href="https://github.blog/author/jkcso/" title="Joseph Katsioloudes">Joseph Katsioloudes</a></span>
 				
 			</div>
 		</div></div></div></article></aside>
</div>
  </div>
</div>

  <section class="related-posts container-xl mx-auto p-responsive-blog">
    <h2 class="h5-mktg border-bottom pb-3 mb-lg-3" style="border-bottom-width: 2px !important;">
      Related posts    </h2>
    <div class="d-flex flex-wrap gutter-spacious">
      <article id="term-post-66076" class="col-12 col-lg-4 post-66076 post type-post status-publish format-standard has-post-thumbnail hentry category-security tag-github-actions">
  <div class="py-4 d-flex flex-column border-top">
  	<a href="https://github.blog/2022-07-01-extend-your-dependency-information-in-the-github-dependency-graph-with-new-github-actions/" class="d-block col-12 position-relative rounded-2 mb-3 overflow-hidden tease-thumbnail">
      <svg aria-hidden="true" width="395" height="210" class="width-full height-auto d-block" style="visibility: hidden; pointer-events: none;"></svg>
      <img srcset="https://github.blog/wp-content/uploads/2021/12/GitHub-security_teal-banner.png?resize=288%2C179 288w,https://github.blog/wp-content/uploads/2021/12/GitHub-security_teal-banner.png?resize=512%2C318 512w,https://github.blog/wp-content/uploads/2021/12/GitHub-security_teal-banner.png?resize=708%2C440 708w,https://github.blog/wp-content/uploads/2021/12/GitHub-security_teal-banner.png?resize=932%2C579 932w,https://github.blog/wp-content/uploads/2021/12/GitHub-security_teal-banner.png?resize=1024%2C630 1024w" src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/GitHub-security_teal-banner(1).png" width="512" height="318" alt="Extend your dependency information in the GitHub Dependency Graph with new GitHub Actions" class="d-block width-full height-auto rounded-2 tease-thumbnail__img cover-image" loading="lazy" decoding="async">  	</a>

    
		<div class="mb-1">
			<a href="https://github.blog/category/security/" class="f5-mktg text-gradient-purple-coral text-bold pb-1">Security</a>
		</div><h3 class="h6-mktg mb-12px"><a class="Link--primary" href="https://github.blog/2022-07-01-extend-your-dependency-information-in-the-github-dependency-graph-with-new-github-actions/">Extend your dependency information in the GitHub Dependency Graph with new GitHub Actions</a></h3><p class="f4-mktg color-fg-muted mb-0">New Actions from Anchore, NowSecure, SBT, and Trivy are now available to create a more comprehensive GitHub Dependency Graph.</p>
    <div class="mt-14px">
      
 		<div class="d-flex flex-items-center">
 			
 			<div class="d-flex flex-items-end flex-wrap" style="margin-top: -4px;">
 				<span class="authors-wrap mr-12px mt-1 f5-mktg text-bold"><a class="d-inline-block Link--primary color-fg-default" href="https://github.blog/author/josepalafox/" title="Jose Palafox">Jose Palafox</a> &amp; <a class="d-inline-block Link--primary color-fg-default" href="https://github.blog/author/bkoshea/" title="Brittany O&#39;Shea">Brittany O'Shea</a></span>
 				
 			</div>
 		</div>    </div>
  </div>
</article>
<article id="term-post-66063" class="col-12 col-lg-4 post-66063 post type-post status-publish format-standard has-post-thumbnail hentry category-company category-product category-security tag-github-actions tag-github-issues tag-security">
  <div class="py-4 d-flex flex-column border-top">
  	<a href="https://github.blog/2022-07-01-how-the-github-security-team-uses-projects-and-github-actions-for-planning-tracking-and-more/" class="d-block col-12 position-relative rounded-2 mb-3 overflow-hidden tease-thumbnail">
      <svg aria-hidden="true" width="395" height="210" class="width-full height-auto d-block" style="visibility: hidden; pointer-events: none;"></svg>
      <img srcset="https://github.blog/wp-content/uploads/2022/06/Security-Product@2x.png?resize=288%2C179 288w,https://github.blog/wp-content/uploads/2022/06/Security-Product@2x.png?resize=512%2C318 512w,https://github.blog/wp-content/uploads/2022/06/Security-Product@2x.png?resize=708%2C440 708w,https://github.blog/wp-content/uploads/2022/06/Security-Product@2x.png?resize=932%2C579 932w,https://github.blog/wp-content/uploads/2022/06/Security-Product@2x.png?resize=1024%2C636 1024w" src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/Security-Product@2x.png" width="512" height="318" alt="How the GitHub Security Team uses projects and GitHub Actions for planning, tracking, and more" class="d-block width-full height-auto rounded-2 tease-thumbnail__img cover-image" loading="lazy" decoding="async">  	</a>

    
		<div class="mb-1">
			<a href="https://github.blog/category/company/" class="f5-mktg text-gradient-purple-coral text-bold pb-1">Company</a>
		</div><h3 class="h6-mktg mb-12px"><a class="Link--primary" href="https://github.blog/2022-07-01-how-the-github-security-team-uses-projects-and-github-actions-for-planning-tracking-and-more/">How the GitHub Security Team uses projects and GitHub Actions for planning, tracking, and more</a></h3><p class="f4-mktg color-fg-muted mb-0">Can projects and GitHub Actions be used by your non-developer teams? They absolutely can. Check out how our Security Team uses GitHub to run the department effortlessly. </p>
    <div class="mt-14px">
      
 		<div class="d-flex flex-items-center">
 			
 			<div class="d-flex flex-items-end flex-wrap" style="margin-top: -4px;">
 				<span class="authors-wrap mr-12px mt-1 f5-mktg text-bold"><a class="d-inline-block Link--primary color-fg-default" href="https://github.blog/author/benbalter/" title="Ben Balter">Ben Balter</a></span>
 				
 			</div>
 		</div>    </div>
  </div>
</article>
<article id="term-post-65766" class="col-12 col-lg-4 post-65766 post type-post status-publish format-standard has-post-thumbnail hentry category-security tag-github-security-lab">
  <div class="py-4 d-flex flex-column border-top">
  	<a href="https://github.blog/2022-06-29-the-chromium-super-inline-cache-type-confusion/" class="d-block col-12 position-relative rounded-2 mb-3 overflow-hidden tease-thumbnail">
      <svg aria-hidden="true" width="395" height="210" class="width-full height-auto d-block" style="visibility: hidden; pointer-events: none;"></svg>
      <img srcset="https://github.blog/wp-content/uploads/2021/12/GitHub-security_teal-banner.png?resize=288%2C179 288w,https://github.blog/wp-content/uploads/2021/12/GitHub-security_teal-banner.png?resize=512%2C318 512w,https://github.blog/wp-content/uploads/2021/12/GitHub-security_teal-banner.png?resize=708%2C440 708w,https://github.blog/wp-content/uploads/2021/12/GitHub-security_teal-banner.png?resize=932%2C579 932w,https://github.blog/wp-content/uploads/2021/12/GitHub-security_teal-banner.png?resize=1024%2C630 1024w" src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/GitHub-security_teal-banner(1).png" width="512" height="318" alt="The Chromium super (inline cache) type confusion" class="d-block width-full height-auto rounded-2 tease-thumbnail__img cover-image" loading="lazy" decoding="async">  	</a>

    
		<div class="mb-1">
			<a href="https://github.blog/category/security/" class="f5-mktg text-gradient-purple-coral text-bold pb-1">Security</a>
		</div><h3 class="h6-mktg mb-12px"><a class="Link--primary" href="https://github.blog/2022-06-29-the-chromium-super-inline-cache-type-confusion/">The Chromium super (inline cache) type confusion</a></h3><p class="f4-mktg color-fg-muted mb-0">In this post I'll exploit CVE-2022-1134, a type confusion in Chrome that I reported in March 2022, which allows remote code execution (RCE) in the renderer sandbox of Chrome by a single visit to a malicious site. I'll also look at some past vulnerabilities of this type and some implementation details of inline cache in V8, the JavaScript engine of Chrome.</p>
    <div class="mt-14px">
      
 		<div class="d-flex flex-items-center">
 			
 			<div class="d-flex flex-items-end flex-wrap" style="margin-top: -4px;">
 				<span class="authors-wrap mr-12px mt-1 f5-mktg text-bold"><a class="d-inline-block Link--primary color-fg-default" href="https://github.blog/author/mymo/" title="Man Yue Mo">Man Yue Mo</a></span>
 				
 			</div>
 		</div>    </div>
  </div>
</article>
    </div>
  </section>
  <section class="recirculation-modules container-xl mx-auto p-responsive-blog">
    <h2 class="h5-mktg border-bottom pb-3 mb-lg-1" style="border-bottom-width: 2px !important;">
      Explore more from GitHub    </h2>
    <div class="d-flex flex-wrap gutter-condensed">
      <div class="col-12 col-md-6 col-lg-3 d-flex mt-4 mt-lg-6">
  <div class="rounded-2 color-bg-subtle d-flex flex-column flex-items-start width-full f4-mktg color-fg-muted" style="padding: 36px;">
          <img src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/security.svg" width="44" height="44" class="width-auto d-block mb-3" loading="lazy" alt="Security">
        <h3 class="color-fg-default mb-3">Security</h3>
    <div class="mb-auto">
      Secure platform, secure data. Everything you need to make security your #1.    </div>

          <div class="mt-7">
        <a href="https://github.blog/category/security/" class="text-semibold color-fg-default arrow-target-mktg">
          Learn more<svg xmlns="http://www.w3.org/2000/svg" class="octicon arrow-symbol-mktg" width="16" height="16" viewBox="0 0 16 16" fill="none"><path fill="currentColor" d="M7.28033 3.21967C6.98744 2.92678 6.51256 2.92678 6.21967 3.21967C5.92678 3.51256 5.92678 3.98744 6.21967 4.28033L7.28033 3.21967ZM11 8L11.5303 8.53033C11.8232 8.23744 11.8232 7.76256 11.5303 7.46967L11 8ZM6.21967 11.7197C5.92678 12.0126 5.92678 12.4874 6.21967 12.7803C6.51256 13.0732 6.98744 13.0732 7.28033 12.7803L6.21967 11.7197ZM6.21967 4.28033L10.4697 8.53033L11.5303 7.46967L7.28033 3.21967L6.21967 4.28033ZM10.4697 7.46967L6.21967 11.7197L7.28033 12.7803L11.5303 8.53033L10.4697 7.46967Z"></path><path class="octicon-chevrow-stem" stroke="currentColor" d="M1.75 8H11" stroke-width="1.5" stroke-linecap="round"></path></svg>
                  </a>
      </div>
      </div>
</div>
<div class="col-12 col-md-6 col-lg-3 d-flex mt-4 mt-lg-6">
  <div class="rounded-2 color-bg-subtle d-flex flex-column flex-items-start width-full f4-mktg color-fg-muted" style="padding: 36px;">
          <img src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/readme.svg" width="44" height="44" class="width-auto d-block mb-3" loading="lazy" alt="The ReadME Project">
        <h3 class="color-fg-default mb-3">The ReadME Project</h3>
    <div class="mb-auto">
      Stories and voices from the developer community.    </div>

          <div class="mt-7">
        <a href="https://github.com/readme" class="text-semibold color-fg-default arrow-target-mktg" target="_blank">
          Learn more<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="octicon octicon-link-external ml-1"><path fill-rule="evenodd" d="M10.604 1h4.146a.25.25 0 01.25.25v4.146a.25.25 0 01-.427.177L13.03 4.03 9.28 7.78a.75.75 0 01-1.06-1.06l3.75-3.75-1.543-1.543A.25.25 0 0110.604 1zM3.75 2A1.75 1.75 0 002 3.75v8.5c0 .966.784 1.75 1.75 1.75h8.5A1.75 1.75 0 0014 12.25v-3.5a.75.75 0 00-1.5 0v3.5a.25.25 0 01-.25.25h-8.5a.25.25 0 01-.25-.25v-8.5a.25.25 0 01.25-.25h3.5a.75.75 0 000-1.5h-3.5z"></path></svg>
                  </a>
      </div>
      </div>
</div>
<div class="col-12 col-md-6 col-lg-3 d-flex mt-4 mt-lg-6">
  <div class="rounded-2 color-bg-subtle d-flex flex-column flex-items-start width-full f4-mktg color-fg-muted" style="padding: 36px;">
          <img src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/actions.svg" width="44" height="44" class="width-auto d-block mb-3" loading="lazy" alt="GitHub Actions">
        <h3 class="color-fg-default mb-3">GitHub Actions</h3>
    <div class="mb-auto">
      Native CI/CD alongside code hosted in GitHub.    </div>

          <div class="mt-7">
        <a href="https://github.com/features/actions" class="text-semibold color-fg-default arrow-target-mktg" target="_blank">
          Learn more<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="octicon octicon-link-external ml-1"><path fill-rule="evenodd" d="M10.604 1h4.146a.25.25 0 01.25.25v4.146a.25.25 0 01-.427.177L13.03 4.03 9.28 7.78a.75.75 0 01-1.06-1.06l3.75-3.75-1.543-1.543A.25.25 0 0110.604 1zM3.75 2A1.75 1.75 0 002 3.75v8.5c0 .966.784 1.75 1.75 1.75h8.5A1.75 1.75 0 0014 12.25v-3.5a.75.75 0 00-1.5 0v3.5a.25.25 0 01-.25.25h-8.5a.25.25 0 01-.25-.25v-8.5a.25.25 0 01.25-.25h3.5a.75.75 0 000-1.5h-3.5z"></path></svg>
                  </a>
      </div>
      </div>
</div>
<div class="col-12 col-md-6 col-lg-3 d-flex mt-4 mt-lg-6">
  <div class="rounded-2 color-bg-subtle d-flex flex-column flex-items-start width-full f4-mktg color-fg-muted" style="padding: 36px;">
          <img src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/careers.svg" width="44" height="44" class="width-auto d-block mb-3" loading="lazy" alt="Work at GitHub!">
        <h3 class="color-fg-default mb-3">Work at GitHub!</h3>
    <div class="mb-auto">
      <span style="font-weight: 400">Check out our current job openings.</span>    </div>

          <div class="mt-7">
        <a href="https://github.com/about/careers" class="text-semibold color-fg-default arrow-target-mktg" target="_blank">
          Learn more<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="octicon octicon-link-external ml-1"><path fill-rule="evenodd" d="M10.604 1h4.146a.25.25 0 01.25.25v4.146a.25.25 0 01-.427.177L13.03 4.03 9.28 7.78a.75.75 0 01-1.06-1.06l3.75-3.75-1.543-1.543A.25.25 0 0110.604 1zM3.75 2A1.75 1.75 0 002 3.75v8.5c0 .966.784 1.75 1.75 1.75h8.5A1.75 1.75 0 0014 12.25v-3.5a.75.75 0 00-1.5 0v3.5a.25.25 0 01-.25.25h-8.5a.25.25 0 01-.25-.25v-8.5a.25.25 0 01.25-.25h3.5a.75.75 0 000-1.5h-3.5z"></path></svg>
                  </a>
      </div>
      </div>
</div>
    </div>
  </section>
<div data-color-mode="dark" data-light-theme="light" data-dark-theme="dark">
  <div id="newsletter" class="container-xl p-responsive-blog py-6 py-lg-8">
  <div class="newsletter">
    <div class="d-flex flex-row flex-wrap color-bg-default flex-items-center" data-color-mode="dark" data-light-theme="light" data-dark-theme="dark" style="border-radius: 6px;">
      <div class="pl-6 pr-6 pl-lg-7 pr-lg-7 py-6 py-lg-7 col-12 col-lg-6 col-xl-7">
        <h2 class="h4-mktg color-fg-default">Subscribe to The GitHub Insider</h2>
        <p class="f3-mktg color-fg-muted mt-2 mb-0">A newsletter for developers covering techniques, technical guides, and the latest product innovations coming from GitHub.</p>
      </div>
      <div class="pl-3 pl-lg-5 pr-3 pr-lg-5 pt-3 pt-lg-7 pb-3 pb-lg-7 col-12 col-lg-6 col-xl-5">
        <form method="post" action="https://s88570519.t.eloqua.com/e/f2?elqFormName=copynewsletter-signup-form-637872624660309567&amp;elqSiteID=88570519" class="d-md-flex flex-row newsletter-form">
          <input type="email" id="newsletter_emailAddress" name="emailAddress" placeholder="Your email address" class="d-block width-full height-md-full mb-2 mb-md-0 f4-mktg newsletter-field">
          <input type="hidden" id="newsletter_classification" name="classification" value="Practitioner">

                                        <button type="submit" class="newsletter-submit flex-shrink-0 arrow-target-mktg d-flex flex-row f3-mktg flex-items-center text-semibold"><span>Subscribe</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="octicon arrow-symbol-mktg" width="24" height="24" viewBox="0 0 16 16" fill="none"><path fill="currentColor" d="M7.28033 3.21967C6.98744 2.92678 6.51256 2.92678 6.21967 3.21967C5.92678 3.51256 5.92678 3.98744 6.21967 4.28033L7.28033 3.21967ZM11 8L11.5303 8.53033C11.8232 8.23744 11.8232 7.76256 11.5303 7.46967L11 8ZM6.21967 11.7197C5.92678 12.0126 5.92678 12.4874 6.21967 12.7803C6.51256 13.0732 6.98744 13.0732 7.28033 12.7803L6.21967 11.7197ZM6.21967 4.28033L10.4697 8.53033L11.5303 7.46967L7.28033 3.21967L6.21967 4.28033ZM10.4697 7.46967L6.21967 11.7197L7.28033 12.7803L11.5303 8.53033L10.4697 7.46967Z"></path><path class="octicon-chevrow-stem" stroke="currentColor" d="M1.75 8H11" stroke-width="1.5" stroke-linecap="round"></path></svg>
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
	<footer class="footer mt-6">
		
<div class="container-xl p-responsive-blog">
	<div class="d-flex flex-wrap py-5 mb-5">

		<div class="col-12 col-lg-4 mb-5">
			<a href="https://github.com/" data-ga-click="Resources, go to home, resources footer" class="color-fg-default" aria-label="Go to GitHub homepage">
				<svg height="30" class="octicon octicon-logo-github" viewBox="0 0 45 16" version="1.1" width="84" aria-hidden="true">
					<path fill-rule="evenodd" d="M18.53 12.03h-.02c.009 0 .015.01.024.011h.006l-.01-.01zm.004.011c-.093.001-.327.05-.574.05-.78 0-1.05-.36-1.05-.83V8.13h1.59c.09 0 .16-.08.16-.19v-1.7c0-.09-.08-.17-.16-.17h-1.59V3.96c0-.08-.05-.13-.14-.13h-2.16c-.09 0-.14.05-.14.13v2.17s-1.09.27-1.16.28c-.08.02-.13.09-.13.17v1.36c0 .11.08.19.17.19h1.11v3.28c0 2.44 1.7 2.69 2.86 2.69.53 0 1.17-.17 1.27-.22.06-.02.09-.09.09-.16v-1.5a.177.177 0 00-.146-.18zM42.23 9.84c0-1.81-.73-2.05-1.5-1.97-.6.04-1.08.34-1.08.34v3.52s.49.34 1.22.36c1.03.03 1.36-.34 1.36-2.25zm2.43-.16c0 3.43-1.11 4.41-3.05 4.41-1.64 0-2.52-.83-2.52-.83s-.04.46-.09.52c-.03.06-.08.08-.14.08h-1.48c-.1 0-.19-.08-.19-.17l.02-11.11c0-.09.08-.17.17-.17h2.13c.09 0 .17.08.17.17v3.77s.82-.53 2.02-.53l-.01-.02c1.2 0 2.97.45 2.97 3.88zm-8.72-3.61h-2.1c-.11 0-.17.08-.17.19v5.44s-.55.39-1.3.39-.97-.34-.97-1.09V6.25c0-.09-.08-.17-.17-.17h-2.14c-.09 0-.17.08-.17.17v5.11c0 2.2 1.23 2.75 2.92 2.75 1.39 0 2.52-.77 2.52-.77s.05.39.08.45c.02.05.09.09.16.09h1.34c.11 0 .17-.08.17-.17l.02-7.47c0-.09-.08-.17-.19-.17zm-23.7-.01h-2.13c-.09 0-.17.09-.17.2v7.34c0 .2.13.27.3.27h1.92c.2 0 .25-.09.25-.27V6.23c0-.09-.08-.17-.17-.17zm-1.05-3.38c-.77 0-1.38.61-1.38 1.38 0 .77.61 1.38 1.38 1.38.75 0 1.36-.61 1.36-1.38 0-.77-.61-1.38-1.36-1.38zm16.49-.25h-2.11c-.09 0-.17.08-.17.17v4.09h-3.31V2.6c0-.09-.08-.17-.17-.17h-2.13c-.09 0-.17.08-.17.17v11.11c0 .09.09.17.17.17h2.13c.09 0 .17-.08.17-.17V8.96h3.31l-.02 4.75c0 .09.08.17.17.17h2.13c.09 0 .17-.08.17-.17V2.6c0-.09-.08-.17-.17-.17zM8.81 7.35v5.74c0 .04-.01.11-.06.13 0 0-1.25.89-3.31.89-2.49 0-5.44-.78-5.44-5.92S2.58 1.99 5.1 2c2.18 0 3.06.49 3.2.58.04.05.06.09.06.14L7.94 4.5c0 .09-.09.2-.2.17-.36-.11-.9-.33-2.17-.33-1.47 0-3.05.42-3.05 3.73s1.5 3.7 2.58 3.7c.92 0 1.25-.11 1.25-.11v-2.3H4.88c-.11 0-.19-.08-.19-.17V7.35c0-.09.08-.17.19-.17h3.74c.11 0 .19.08.19.17z"></path>
				</svg>
			</a>
		</div>

		<div class="col-6 col-sm-3 col-lg-2 mb-6 mb-md-2 pr-3 pr-lg-0 pl-lg-4"><h2 class="h5 mb-3 text-mono color-text-tertiary text-normal">Product</h2><ul class="list-style-none text-gray f5"><li class="lh-condensed mb-3"><a href="https://github.com/features" data-ga-click="Site Foundation Components, go to Features, site foundation components footer" class="Link--secondary">Features</a></li><li class="lh-condensed mb-3"><a href="https://github.com/security" data-ga-click="Site Foundation Components, go to Security, site foundation components footer" class="Link--secondary">Security</a></li><li class="lh-condensed mb-3"><a href="https://github.com/enterprise" data-ga-click="Site Foundation Components, go to Enterprise, site foundation components footer" class="Link--secondary">Enterprise</a></li><li class="lh-condensed mb-3"><a href="https://github.com/customer-stories?type=enterprise" data-ga-click="Site Foundation Components, go to Customer Stories, site foundation components footer" class="Link--secondary">Customer Stories</a></li><li class="lh-condensed mb-3"><a href="https://github.com/pricing" data-ga-click="Site Foundation Components, go to Pricing, site foundation components footer" class="Link--secondary">Pricing</a></li><li class="lh-condensed mb-3"><a href="https://resources.github.com/" data-ga-click="Site Foundation Components, go to Resources, site foundation components footer" class="Link--secondary">Resources</a></li></ul></div><div class="col-6 col-sm-3 col-lg-2 mb-6 mb-md-2 pr-3 pr-lg-0 pl-lg-4"><h2 class="h5 mb-3 text-mono color-text-tertiary text-normal">Platform</h2><ul class="list-style-none text-gray f5"><li class="lh-condensed mb-3"><a href="https://developer.github.com/" data-ga-click="Site Foundation Components, go to Developer API, site foundation components footer" class="Link--secondary">Developer API</a></li><li class="lh-condensed mb-3"><a href="https://partner.github.com/" data-ga-click="Site Foundation Components, go to Partners, site foundation components footer" class="Link--secondary">Partners</a></li><li class="lh-condensed mb-3"><a href="https://atom.io/" data-ga-click="Site Foundation Components, go to Atom, site foundation components footer" class="Link--secondary">Atom</a></li><li class="lh-condensed mb-3"><a href="https://www.electronjs.org/" data-ga-click="Site Foundation Components, go to Electron, site foundation components footer" class="Link--secondary">Electron</a></li><li class="lh-condensed mb-3"><a href="https://desktop.github.com/" data-ga-click="Site Foundation Components, go to GitHub Desktop, site foundation components footer" class="Link--secondary">GitHub Desktop</a></li></ul></div><div class="col-6 col-sm-3 col-lg-2 mb-6 mb-md-2 pr-3 pr-lg-0 pl-lg-4"><h2 class="h5 mb-3 text-mono color-text-tertiary text-normal">Support</h2><ul class="list-style-none text-gray f5"><li class="lh-condensed mb-3"><a href="https://docs.github.com/" data-ga-click="Site Foundation Components, go to Docs, site foundation components footer" class="Link--secondary">Docs</a></li><li class="lh-condensed mb-3"><a href="https://github.community/" data-ga-click="Site Foundation Components, go to Community Forum, site foundation components footer" class="Link--secondary">Community Forum</a></li><li class="lh-condensed mb-3"><a href="https://services.github.com/" data-ga-click="Site Foundation Components, go to Training, site foundation components footer" class="Link--secondary">Training</a></li><li class="lh-condensed mb-3"><a href="https://www.githubstatus.com/" data-ga-click="Site Foundation Components, go to Status, site foundation components footer" class="Link--secondary">Status</a></li><li class="lh-condensed mb-3"><a href="https://support.github.com/" data-ga-click="Site Foundation Components, go to Contact, site foundation components footer" class="Link--secondary">Contact</a></li></ul></div><div class="col-6 col-sm-3 col-lg-2 mb-6 mb-md-2 pr-3 pr-lg-0 pl-lg-4"><h2 class="h5 mb-3 text-mono color-text-tertiary text-normal">Company</h2><ul class="list-style-none text-gray f5"><li class="lh-condensed mb-3"><a href="https://github.com/about" data-ga-click="Site Foundation Components, go to About, site foundation components footer" class="Link--secondary">About</a></li><li class="lh-condensed mb-3"><a href="https://github.blog/" data-ga-click="Site Foundation Components, go to Blog, site foundation components footer" class="Link--secondary">Blog</a></li><li class="lh-condensed mb-3"><a href="https://github.com/about/careers" data-ga-click="Site Foundation Components, go to Careers, site foundation components footer" class="Link--secondary">Careers</a></li><li class="lh-condensed mb-3"><a href="https://github.com/about/press" data-ga-click="Site Foundation Components, go to Press, site foundation components footer" class="Link--secondary">Press</a></li><li class="lh-condensed mb-3"><a href="https://shop.github.com/" data-ga-click="Site Foundation Components, go to Shop, site foundation components footer" class="Link--secondary">Shop</a></li></ul></div>
	</div>
</div>

		
<div class="color-bg-subtle">
	<div class="container-xl p-responsive-blog f6 py-4 d-sm-flex flex-justify-between flex-row-reverse flex-items-center">

		<ul class="list-style-none d-flex flex-items-center mb-3 mb-sm-0 lh-condensed-ultra">
			<li class="mr-3">
				<a href="https://twitter.com/github" data-ga-click="Blog, go to Twitter, resources footer" style="color: #959da5;">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 273.5 222.3" class="d-block" height="18">
						<path d="M273.5 26.3a109.77 109.77 0 0 1-32.2 8.8 56.07 56.07 0 0 0 24.7-31 113.39 113.39 0 0 1-35.7 13.6 56.1 56.1 0 0 0-97 38.4 54 54 0 0 0 1.5 12.8A159.68 159.68 0 0 1 19.1 10.3a56.12 56.12 0 0 0 17.4 74.9 56.06 56.06 0 0 1-25.4-7v.7a56.11 56.11 0 0 0 45 55 55.65 55.65 0 0 1-14.8 2 62.39 62.39 0 0 1-10.6-1 56.24 56.24 0 0 0 52.4 39 112.87 112.87 0 0 1-69.7 24 119 119 0 0 1-13.4-.8 158.83 158.83 0 0 0 86 25.2c103.2 0 159.6-85.5 159.6-159.6 0-2.4-.1-4.9-.2-7.3a114.25 114.25 0 0 0 28.1-29.1" fill="currentColor"></path>
					</svg>

					<span class="sr-only">GitHub on Twitter</span>
				</a>
			</li>
			<li class="mr-3">
				<a href="https://www.facebook.com/GitHub" data-ga-click="Blog, go to Facebook, resources footer" style="color: #959da5;">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.3 15.4" class="d-block" height="18">
						<path d="M14.5 0H.8a.88.88 0 0 0-.8.9v13.6a.88.88 0 0 0 .8.9h7.3v-6h-2V7.1h2V5.4a2.87 2.87 0 0 1 2.5-3.1h.5a10.87 10.87 0 0 1 1.8.1v2.1h-1.3c-1 0-1.1.5-1.1 1.1v1.5h2.3l-.3 2.3h-2v5.9h3.9a.88.88 0 0 0 .9-.8V.8a.86.86 0 0 0-.8-.8z" fill="currentColor"></path>
					</svg>

					<span class="sr-only">GitHub on Facebook</span>
				</a>
			</li>
			<li class="mr-3">
				<a href="https://www.youtube.com/github" data-ga-click="Blog, go to YouTube, resources footer" style="color: #959da5;">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.17 13.6" class="d-block" height="16">
						<path d="M18.77 2.13A2.4 2.4 0 0 0 17.09.42C15.59 0 9.58 0 9.58 0a57.55 57.55 0 0 0-7.5.4A2.49 2.49 0 0 0 .39 2.13 26.27 26.27 0 0 0 0 6.8a26.15 26.15 0 0 0 .39 4.67 2.43 2.43 0 0 0 1.69 1.71c1.52.42 7.5.42 7.5.42a57.69 57.69 0 0 0 7.51-.4 2.4 2.4 0 0 0 1.68-1.71 25.63 25.63 0 0 0 .4-4.67 24 24 0 0 0-.4-4.69zM7.67 9.71V3.89l5 2.91z" fill="currentColor"></path>
					</svg>

					<span class="sr-only">GitHub on YouTube</span>
				</a>
			</li>
			<li class="mr-3 flex-self-start">
				<a href="https://www.twitch.tv/github" data-ga-click="Blog, go to Twitch, resources footer" style="color: #959da5;">
					<svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="d-block" height="18">
					  <path d="M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714Z" fill="currentColor"></path>
					</svg>
					<span class="sr-only">GitHub on Twitch</span>
				</a>
			</li>
			<li class="mr-3 flex-self-start">
				<a href="https://www.tiktok.com/@github" data-ga-click="Blog, go to TikTok, resources footer" style="color: #959da5;">
					<svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="d-block" height="18">
						<path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.4-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z" fill="currentColor"></path>
					</svg>

					<span class="sr-only">GitHub on TikTok</span>
				</a>
			</li>
			<li class="mr-3 flex-self-start">
				<a href="https://www.linkedin.com/company/github" data-ga-click="Blog, go to Linkedin, resources footer" style="color: #959da5;">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19 18" class="d-block" height="18">
						<path d="M3.94 2A2 2 0 1 1 2 0a2 2 0 0 1 1.94 2zM4 5.48H0V18h4zm6.32 0H6.34V18h3.94v-6.57c0-3.66 4.77-4 4.77 0V18H19v-7.93c0-6.17-7.06-5.94-8.72-2.91z" fill="currentColor"></path>
					</svg>

					<span class="sr-only">GitHub on LinkedIn</span>
				</a>
			</li>
			<li>
				<a href="https://github.com/github" data-ga-click="Blog, go to github&#39;s org, resources footer" style="color: #959da5;">
					<svg height="20" class="octicon octicon-mark-github d-block" alt="" viewBox="0 0 16 16" version="1.1" width="20" aria-hidden="true">
						<path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
					</svg>
					<span class="sr-only">GitHub’s organization on GitHub</span>
				</a>
			</li>
		</ul>

		<ul class="list-style-none d-flex flex-wrap text-gray">
			<li class="mr-3">© 2022 GitHub, Inc.</li>

			<li class="mr-3">
				<a href="https://docs.github.com/en/github/site-policy/github-terms-of-service" data-ga-click="Site Foundation Components, go to terms, site foundation components footer" class="Link--secondary">Terms</a>
			</li>

			<li class="mr-3">
				<a href="https://docs.github.com/en/github/site-policy/github-privacy-statement" data-ga-click="Site Foundation Components, go to privacy, site foundation components footer" class="Link--secondary">Privacy</a>
			</li>

		</ul>

	</div>
</div>
	</footer>
</div>

<script type="text/javascript" src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/saved_resource(1)"></script><script data-parsely-site="github.blog" src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/p.js.下載" id="parsely-cfg"></script>
<script type="text/javascript" src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/site.min.js.下載"></script><script src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/highlight.min.js.下載" id="highlightjs-js"></script>
<script type="text/javascript" src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/highlight.init.js.下載"></script><script src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/hydro-analytics-instrumentation.min.js.下載" id="hydro-analytics-js"></script>
	<script>
		window._ha.sendPageView();

		document.addEventListener('click', ({ target }) => {
			if (target && target.matches('a')) {
				const hasUrl = target?.href !== undefined;

				window._ha.sendEvent('analytics.click', {
					text: target?.innerText || target?.ariaLabel,
					...(hasUrl && { target: target.href })
				});
			}
		});
	</script>
	<script src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/e-202227.js.下載" defer=""></script>
<script>
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:11.1',blog:'153214340',post:'65495',tz:'-7',srv:'github.blog',hp:'vip'} ]);
	_stq.push([ 'clickTrackerInit', '153214340', '65495' ]);
</script>



<img src="./The Android kernel mitigations obstacle race _ The GitHub Blog_files/g.gif" alt="" width="6" height="5" id="wpstats"></body></html>