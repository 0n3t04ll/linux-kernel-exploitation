var isGlitching = false;
var scriptsLoaded = false;
var oldBody = null;
var isDarkmode = false;

function load_script(url, cb) {
  var newScript = document.createElement("script");
  newScript.onerror = function() { cb(null); };
  newScript.onload = cb;
  document.head.appendChild(newScript);
  newScript.src = url;
}

function setup_glitch() {
  console.log("Window", window.scrollY);
  console.log(document.body.getBoundingClientRect());
  let bounds = document.body.getBoundingClientRect();
  html2canvas(document.body, {y : window.scrollY, height : window.innerHeight}).then(canvas => {
    var b2 = document.createElement("body");
    b2.style.margin = "0px";
    b2.style.padding = "0px";

    b2.appendChild(canvas);
    oldBody = document.body;
    document.body = b2;

    let sketch = start_glitch(canvas);

    setTimeout(function() {
      console.log("Whoa, we're back");
      sketch.remove();
      document.body = oldBody;
      isGlitching = false;
    }, 10000);
  });
}

function do_it() {
  if (isGlitching)
    return;

  isGlitching = true;

  let loaded = 0;
  let cb = function(err) {
    if (!event)
      return;

    loaded += 1;

    if (loaded === 3) {
      scriptsLoaded = true;
      setup_glitch();
    }
  };

  if (!scriptsLoaded) {
    /* Avoid loading these all the time */
    load_script("/js/html2canvas.min.js", cb);
    load_script("https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.7/p5.min.js", cb);
    load_script("/js/glitch.js?v=3", cb);
  } else {
    setup_glitch();
  }
}

function darkmode() {
  if (!isDarkmode) {
	  /* massive thanks to https://medium.com/@mwichary/dark-theme-in-a-day-3518dde2955a */
	  document.documentElement.classList.add('color-theme-in-transition');
	  document.documentElement.setAttribute('data-theme', 'dark');
	  window.setTimeout(function() {
		   document.documentElement.classList.remove('color-theme-in-transition');
		  isDarkmode = true;
	  }, 1000);
  } else {
	  document.documentElement.classList.add('color-theme-in-transition');
	  document.documentElement.setAttribute('data-theme', '');
	  window.setTimeout(function() {
		   document.documentElement.classList.remove('color-theme-in-transition');
		  isDarkmode = false;
	  }, 1000);
  }
}

(function() {
	/* preload for darkmode */
	new Image().src = '/img/ascii-me.jpg';
})();
