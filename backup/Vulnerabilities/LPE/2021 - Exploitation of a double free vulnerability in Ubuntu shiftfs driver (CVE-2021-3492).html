<!DOCTYPE html>
<!-- saved from url=(0126)https://www.synacktiv.com/publications/exploitation-of-a-double-free-vulnerability-in-ubuntu-shiftfs-driver-cve-2021-3492.html -->
<html dir="ltr" lang="fr" prefix="content: http://purl.org/rss/1.0/modules/content/  dc: http://purl.org/dc/terms/  foaf: http://xmlns.com/foaf/0.1/  og: http://ogp.me/ns#  rdfs: http://www.w3.org/2000/01/rdf-schema#  schema: http://schema.org/  sioc: http://rdfs.org/sioc/ns#  sioct: http://rdfs.org/sioc/types#  skos: http://www.w3.org/2004/02/skos/core#  xsd: http://www.w3.org/2001/XMLSchema# " class=" js"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta content="Synacktiv" property="og:site_name">
<meta content="summary" name="twitter:card">
<link href="https://www.synacktiv.com/publications/exploitation-of-a-double-free-vulnerability-in-ubuntu-shiftfs-driver-cve-2021-3492.html" rel="canonical">
<meta content="Exploitation of a double free vulnerability in Ubuntu shiftfs driver (CVE-2021-3492)" name="twitter:title">
<meta content="@Synacktiv" name="twitter:site">
<meta content="This year again, the international contest Pwn2Own Vancouver took place in the beginning of April." name="twitter:description">
<meta content="This year again, the international contest Pwn2Own Vancouver took place in the beginning of April." name="description">
<meta content="https://synacktiv.com/publications/exploitation-of-a-double-free-vulnerability-in-ubuntu-shiftfs-driver-cve-2021-3492" property="og:url">
<meta content="This year again, the international contest Pwn2Own Vancouver took place in the beginning of April." name="abstract">
<meta content="Exploitation of a double free vulnerability in Ubuntu shiftfs driver (CVE-2021-3492)" property="og:title">
<meta content="https://synacktiv.com/publications/exploitation-of-a-double-free-vulnerability-in-ubuntu-shiftfs-driver-cve-2021-3492" name="twitter:url">
<meta content="This year again, the international contest Pwn2Own Vancouver took place in the beginning of April." property="og:description">
<meta content="https://synacktiv.com/sites/default/files/styles/blog_grid_view/public/2021-07/groovy.jpg" name="twitter:image">
<meta content="https://synacktiv.com/sites/default/files/styles/blog_grid_view/public/2021-07/groovy.jpg" property="og:image">
<meta content="width" name="MobileOptimized">
<meta content="true" name="HandheldFriendly">
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<link href="https://www.synacktiv.com/sites/default/files/favicon.ico" rel="shortcut icon" type="image/vnd.microsoft.icon">
<link href="https://www.synacktiv.com/publications/exploitation-of-a-double-free-vulnerability-in-ubuntu-shiftfs-driver-cve-2021-3492.html" hreflang="fr" rel="alternate">
<link href="https://www.synacktiv.com/en/publications/exploitation-of-a-double-free-vulnerability-in-ubuntu-shiftfs-driver-cve-2021-3492.html" hreflang="en" rel="alternate">
<link href="https://www.synacktiv.com/publications/exploitation-of-a-double-free-vulnerability-in-ubuntu-shiftfs-driver-cve-2021-3492.html" rel="revision">
<title>Exploitation of a double free vulnerability in Ubuntu shiftfs driver</title>
<link href="./2021 - Exploitation of a double free vulnerability in Ubuntu shiftfs driver (CVE-2021-3492)_files/css_cdrGS_B9PyjHsXrOzsLk3RX3ouvAQnR_CFdR2uSCwnQ.css" media="all" rel="stylesheet">
<link href="./2021 - Exploitation of a double free vulnerability in Ubuntu shiftfs driver (CVE-2021-3492)_files/css_gnzwgdWk06tn-HOdVy9psLLUY3j9WunevMaKreUT-xc.css" media="all" rel="stylesheet">
<link href="./2021 - Exploitation of a double free vulnerability in Ubuntu shiftfs driver (CVE-2021-3492)_files/print.css%3Fr2o51j.css" media="all" rel="stylesheet">
<!--[if lte IE 8]>
<script src="/sites/default/files/js/js_VtafjXmRvoUgAzqzYTA3Wrjkx9wcWhjP0G4ZnnqRamA.js"></script>
<![endif]-->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script type="text/javascript" async="" src="./2021 - Exploitation of a double free vulnerability in Ubuntu shiftfs driver (CVE-2021-3492)_files/analytics.js.下載"></script><script async="" src="./2021 - Exploitation of a double free vulnerability in Ubuntu shiftfs driver (CVE-2021-3492)_files/js"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'UA-179971223-1');
</script>
</head>
<body class="page-node-510 path-node page-node-type-article">
<a class="visually-hidden focusable skip-link" href="https://www.synacktiv.com/publications/exploitation-of-a-double-free-vulnerability-in-ubuntu-shiftfs-driver-cve-2021-3492.html#main-content">
      Aller au contenu principal
    </a>
<div class="dialog-off-canvas-main-canvas" data-off-canvas-main-canvas="">
<div class="header-outer">
<div class="header-inner">
<div class="container">
<div class="top-bar">
<div class="region region-top-bar">
<section class="block block-dropdown-language block-dropdown-languagelanguage-interface clearfix" id="block-dropdownlanguage">
<div class="search-link"><a href="https://www.synacktiv.com/search.html"><i aria-hidden="true" class="fa fa-search"></i> Rechercher</a></div>
<div class="form-item js-form-item form-wrapper js-form-wrapper panel panel-default" id="bootstrap-panel">
<div class="container">
<div class="panel-heading">
<div class="panel-title">Switch Language</div>
</div>
<div class="panel-body">
<div class="dropdown-language-item btn-group dropdown">
<button class="language-link active-language button js-form-submit form-submit btn-default btn" data-dropdown-target="#dropdown-item-1638262956" formnovalidate="formnovalidate" hreflang="fr" name="op" type="submit" value="FR">FR</button><button aria-expanded="false" aria-haspopup="true" class="btn-default btn dropdown-toggle" data-toggle="dropdown" type="button"><span class="caret"></span><span class="sr-only">Toggle Dropdown</span></button>
<ul class="dropdown-menu" role="menu"><li hreflang="fr"><span class="language-link active-language hidden" formnovalidate="formnovalidate" hreflang="fr" id="dropdown-item-1638262956">FR</span></li><li hreflang="en"><a class="language-link" formnovalidate="formnovalidate" href="https://www.synacktiv.com/en/publications/exploitation-of-a-double-free-vulnerability-in-ubuntu-shiftfs-driver-cve-2021-3492.html" hreflang="en" id="ajax-link-1638262956">EN</a></li></ul>
</div>
</div>
</div>
</div>
</section>
<section class="block block-block-content block-block-contente1d0bd6e-e175-4e9b-9fb8-a6322c75441a clearfix" id="block-socialmedia">
<div class="item-list item-list--linkicon"><ul class="linkicon linkicon--inline linkicon--no-text" id="linkicon-block-content-social-media-field-social-media-3"><li><a class="linkicon__item" href="https://github.com/Synacktiv" target="_blank"><span aria-hidden="true" class="linkicon__icon icon fa fa-github"></span><span class="linkicon__text">Github</span></a></li><li><a class="linkicon__item" href="https://twitter.com/synacktiv" target="_blank"><span aria-hidden="true" class="linkicon__icon icon fa fa-twitter"></span><span class="linkicon__text">Twitter</span></a></li><li><a class="linkicon__item" href="https://fr.linkedin.com/company/synacktiv" target="_blank"><span aria-hidden="true" class="linkicon__icon icon fa fa-linkedin"></span><span class="linkicon__text">Linkedin</span></a></li></ul></div>
</section>
</div>
</div>
<div class="main-header">
<div class="region region-header">
<a class="logo navbar-btn pull-left" href="https://www.synacktiv.com/index.html" rel="home" title="Accueil">
<img alt="Accueil" src="./2021 - Exploitation of a double free vulnerability in Ubuntu shiftfs driver (CVE-2021-3492)_files/logo_synacktiv_blanc.png">
</a>
<section class="block block-superfish block-superfishmain clearfix" id="block-mainnavigation">
<ul class="menu sf-menu sf-main sf-horizontal sf-style-none" id="superfish-main">
<li class="sf-depth-1 sf-no-children" id="main-menu-link-contentbb3e5f45-fa45-42b0-a2fe-1a89e07c4059"><a class="sf-depth-1" href="https://www.synacktiv.com/la-societe.html">La société</a></li><li class="sf-depth-1 sf-no-children" id="main-menu-link-contentb10afe23-47a0-4481-a5bb-a0d6c39224f3"><a class="sf-depth-1" href="https://www.synacktiv.com/notre-equipe/lequipe-support.html">Notre équipe</a></li><li class="sf-depth-1 sf-no-children" id="main-menu-link-contentb1f6692b-12b2-4613-aa64-67af9be15b81"><a class="sf-depth-1" href="https://www.synacktiv.com/notre-offre.html">Notre Offre</a></li><li class="sf-depth-1 sf-no-children" id="main-menu-link-content7b941be1-6abc-4440-908b-f1231838b656"><a class="sf-depth-1" href="https://www.synacktiv.com/nous-rejoindre.html">Nous rejoindre</a></li><li class="sf-depth-1 sf-no-children" id="main-menu-link-contentd5edd642-8078-459a-9b1f-a6b2d4f65aa2"><a class="sf-depth-1" href="https://www.synacktiv.com/contact.html">Contact</a></li><li class="sf-depth-1 sf-no-children" id="main-menu-link-contentf866857b-07db-40e0-baaa-8636a2bba724"><a class="sf-depth-1" href="https://www.synacktiv.com/le-lab.html">Le Lab</a></li><li class="sf-depth-1 sf-no-children" id="main-menu-link-content23c47262-3e64-4507-8ad4-7019b5fe572a"><a class="sf-depth-1" href="https://www.synacktiv.com/publications.html">Publications</a></li><li class="sf-depth-1 sf-no-children" id="main-menu-link-contentdc984d98-8791-42d3-88a2-3dffa6db478c"><a class="sf-depth-1" href="https://www.synacktiv.com/ressources.html">Ressources</a></li>
</ul>
</section>
</div>
</div>
</div>
</div>
</div>
<div class="banner">
<div class="region region-banner">
<section class="block page-header block-block-content block-block-contentb084ab8a-3baf-4a93-b927-57e3efdc0802 clearfix" id="block-publicationsdetailheader">
<div class="background-image" style="background-image: url(../sites/default/files/styles/page_header/public/2019-11/header-background_1.jpg)">
</div>
</section>
</div>
</div>
<div class="main-page-content">
<div class="page-content-left sidebar-content">
<div class="item-wrapper">
<div class="social-icons-item">
<div class="item-list item-list--linkicon"><ul class="linkicon linkicon--inline linkicon--no-text" id="linkicon-block-content-social-media-field-social-media-25"><li><a class="linkicon__item" href="https://github.com/Synacktiv" target="_blank"><span aria-hidden="true" class="linkicon__icon icon fa fa-github"></span><span class="linkicon__text">Github</span></a></li><li><a class="linkicon__item" href="https://twitter.com/synacktiv" target="_blank"><span aria-hidden="true" class="linkicon__icon icon fa fa-twitter"></span><span class="linkicon__text">Twitter</span></a></li><li><a class="linkicon__item" href="https://fr.linkedin.com/company/synacktiv" target="_blank"><span aria-hidden="true" class="linkicon__icon icon fa fa-linkedin"></span><span class="linkicon__text">Linkedin</span></a></li></ul></div>
</div>
</div>
</div>
<div class="page-content-right">
<div class="banner-bottom">
<div class="container">
<div class="region region-banner-bottom">
<div class="hidden" data-drupal-messages-fallback=""></div>
</div>
</div>
</div>
<div class="content">
<div class="container">
<div class="region region-content">
<article about="/publications/exploitation-of-a-double-free-vulnerability-in-ubuntu-shiftfs-driver-cve-2021-3492" class="article full clearfix" role="article" typeof="schema:Article">
<div class="content">
<div class="title-wrapper">
<h1><span property="schema:name">Exploitation of a double free vulnerability in Ubuntu shiftfs driver (CVE-2021-3492)</span>
</h1>
<div class="short-info">
        Rédigé par
   <span class="author-name">Vincent Dehors</span>
           - 13/07/2021 - dans 
   <span class="category">Exploit</span>
<span class="publication-download">
 - <a href="https://www.synacktiv.com/publications/exploitation-of-a-double-free-vulnerability-in-ubuntu-shiftfs-driver-cve-2021-3492.html#" onclick="window.print()">Téléchargement</a>
<i aria-hidden="true" class="fa fa-download fa-lg"></i>
</span>
</div>
</div>
<div class="introduction">
<div class="field field--name-field-introduction-text field--type-string-long field--label-hidden field--item">This year again, the international contest Pwn2Own Vancouver took place in the beginning of April. Among the different categories, two major operating systems were suggested for the Local Escalation of Privilege category (LPE): Linux (Ubuntu) and Windows 10. This article describes how a Ubuntu kernel vulnerability was found and exploited during this contest allowing to gain root access from an unprivileged user.</div>
</div>
<div class="field field--name-body field--type-text-with-summary field--label-hidden field--item" property="schema:text"><h1>Introduction</h1>
<p>Announced in the <a href="https://www.zerodayinitiative.com/blog/2021/1/25/announcing-pwn2own-vancouver-2021" rel="nofollow">Zero Day Initiative blog</a>, the 2021 edition of Pwn2Own Vancouver encouraged to search for vulnerabilities in different targets. I chose to try the Ubuntu Local Escalation of Privilege entry looking for a Linux kernel vulnerability. This blogpost relates this adventure starting from the vulnerability research to its exploitation bypassing the kernel protections (KASLR, SMAP).</p>
<p>The vulnerability presented here was used during the contest and disclosed to the Ubuntu team who quickly patched it. CVE-2021-3492 has been assigned to this bug. As the patch concerns the Linux kernel, don’t forget to <strong>reboot</strong> after updating.</p>
<h2 id="affected-versions">Affected versions</h2>
<p>Shiftfs driver is only present on Ubuntu kernels as it is not upstreamed into the kernel.org kernel yet.</p>
<p>This vulnerability has been checked on Ubuntu Groovy (20.10) and Ubuntu Focal (20.04) in Desktop and Server versions. Previous versions of Ubuntu have not been checked. The code adding this vulnerability has been committed in April 2019.</p>
<p>To check if your kernel is not vulnerable, here are the patched version for the generic kernel (x86) :</p>
<ul><li>Groovy version is corrected since kernel version : 5.8.0-50.56</li>
<li>Focal version is corrected since kernel version : 5.4.0-72.80</li>
</ul><h2 id="exploit-code">Exploit code</h2>
<p>The source code of the full exploit is available in the <a href="https://github.com/synacktiv/CVE-2021-3492/blob/master/exploit/main.c" rel="nofollow">Synacktiv Github</a>. This PoC is developped for Ubuntu 20.10 (5.8.0-xx-generic) x86 64-bits.</p>
<h1>Kernel attack surface from unprivileged users</h1>
<p>The <a href="https://www.zerodayinitiative.com/Pwn2OwnVancouver2021Rules.html" rel="nofollow">rules of Pwn2Own</a> stated the accepted vulnerabilities must be <em>kernel</em> ones. Although the userland itself can contain a lot of surface for a Local Escalation of Privilege, I only targeted the Linux kernel of Ubuntu distributions. The source code of the kernel used to build current kernels packages can be <a href="https://wiki.ubuntu.com/Kernel/SourceCode" rel="nofollow">downloaded</a> and there is a <a href="http://kernel.ubuntu.com/ubuntu/ubuntu-groovy" rel="nofollow">Git repository</a>.</p>
<p>The goal is to obtain root rights (UID 0) from a standard user. On most Linux distributions, there is no boundary between the root user and kernel code execution as root can load kernel modules, write on blocks devices, etc.</p>
<p>Before wondering what an unprivileged user can do, let’s enumerate how a process can interact with the kernel. A process spawned by a user executes instructions in <em>ring 3</em> on x86 (EL0 on ARM). It can only access its own virtual memory or need to perform a syscall to interact with the OS. A good starting point to list the kernel attack surface would be to list all available syscalls.</p>
<p>Syscalls are identified by a number stored in a register. Depending on the syscall, the userland process can provide parameters by settings other registers. There are various ways to list available syscalls :</p>
<ul><li><code>grep -R "SYSCALL.*_DEFINE"</code> in the source code and check if they are compiled</li>
<li>Search for symbol <code>__x64_sys_*</code> in the vmlinux or in /proc/kallsyms</li>
<li>Look at the syscall table in the compiled binary</li>
<li>Use the kernel tracer (ftrace) from userland to check if there is something behind a syscall</li>
</ul><p>If you try to use a syscall with every possible number without parameters, you may not be able to tell the difference between a unimplemented syscall and a normal error. So I created a <a href="https://github.com/synacktiv/CVE-2021-3492/blob/master/attack_surface/check_syscalls.sh" rel="nofollow">small shell script</a> which uses ftrace to locate the kernel handler for each possible number of syscall. Here is the <a href="https://github.com/synacktiv/CVE-2021-3492/blob/master/attack_surface/result.txt" rel="nofollow">resulting list</a> of available syscalls. Note that for 64-bit machines, the 32-bit syscall can also be done and is managed by another handler using 32-bit parameters.</p>
<figure><img alt="Kernel Attack Surface" class="align-center" data-entity-type="file" data-entity-uuid="501b775e-574c-49be-ac54-ca252b04a8a7" height="550" src="./2021 - Exploitation of a double free vulnerability in Ubuntu shiftfs driver (CVE-2021-3492)_files/syscall_meme.png" width="475"><p>&nbsp;</p>
</figure><p>The list of syscalls is only the first entry point to talk to the kernel. But instead of using a new number, a lot of syscalls lead to <strong>multiple functions</strong>. The most common example are the ones related to <strong>file descriptors</strong>, like <code>open</code>, <code>read</code>, <code>write</code>, <code>ioctl</code>, etc. Indeed a file descriptor can be a lot of different things on Linux systems :</p>
<ul><li>An inode (file or directory) managed by a <strong>filesystem</strong>. The kernel handler of the syscall depends on the filesystem, so there is a whole new surface for each supported/mounted filesystems. There are also special kernel filesystems : procfs, sysfs, debugfs, cgroup, etc.</li>
<li>A <em>special</em> file provided by a kernel driver (block or character devices) allowing to communicate with the driver. Generally, special files are located in /dev. Each device offers an interesting attack surface.</li>
<li>An handle from the <code>socket</code> syscall for network communication. The underlying kernel handlers depend on the kind of network protocol used and there are a lot of twisted usages.</li>
<li>Several other API based on file descriptors : shared memory, pipes, pidfd, io_uring, …</li>
</ul><p>So from this small number of syscalls, there is a huge kernel surface. However, a lot of kernel reachable code is only available from an already-privileged user. To restrict features for unprivileged user, the kernel generally uses <strong>capabilities</strong> (See <code>man 7 capabilities</code>). Another way to restrict features is by setting the file permissions for all the surface which comes from the VFS (from a filepath). For example, Ubuntu only allows <code>root</code> to read/write the block device /dev/mem (which may be <a href="https://lwn.net/Articles/851531/" rel="nofollow">dropped</a>).</p>
<p>Moreover, there are a lot of corner cases and special behaviors added gradually to support new features while keeping the compatibility with previous userland code. Several of these new features have been added for <strong>containers</strong>. For example, the <strong>namespaces</strong> are used to add more isolation on kernel objects (process, VFS, IPC, …). There are two approaches with containers :</p>
<ul><li>The container is launched from a root process and have isolated namespaces except for the <strong>user</strong> namespace. This means the UIDs inside a container are the same as on the host (from the kernel perspective). In this case, there are several new restrictions to prevent from a root process inside the container to impact the host. For example, a lot of capabilities are dropped.</li>
<li>The container is launched from a privileged user using a new user namespace. When this new namespace is created, the UIDs are mapped. So a process can be UID 0 inside its own user namespace. It can also gain all the <strong>capabilities</strong> but they are only meaningful inside this user namespace. To support this behavior, for privileged actions, the kernel doesn't check if a process has a capability but if it has <strong>a capability inside the root namespace</strong>.</li>
</ul><p>This can sound weird as these two approaches are completely different. A lot of distributions forbid the ability to create a new user namespace from an unprivileged user. As the feature is mainline in the Linux kernel, this feature can be disabled/enabled by a systctl option (which is system-wide) :</p>
<pre><code>$ sudo sysctl kernel.unprivileged_userns_clone
kernel.unprivileged_userns_clone = 1</code></pre>
<p>Unprivileged users can reach a little more kernel code on Ubuntu distribution because unprivileged user namespaces are enabled by default. Using <code>unshare</code> or <code>clone</code> syscalls, one can create a new user namespace and then gain all capabilities. Of course these capabilities only apply on resources owned by the user, but some actions, normally forbidden for normal users, are now allowed. Among these actions, users can create others kinds of namespaces (mount, networks, …) and mount several filesystems inside their mount namespace.</p>
<pre><code>$ unshare -U -r # create a userns where uid 0 is mapped on current user
$ unshare -m    # create a mount namespace
$ mount -t tmpfs none [dir]</code></pre>
<p>Not all filesystems can be mounted as a normal user. In kernel code, the flag <code>FS_USERNS_MOUNT</code> is used to define if a given filesystem can be mounted by a non-root user. This flag is set for a few filesystems :</p>
<ul><li>android/binderfs</li>
<li>mqueue</li>
<li>shmem</li>
<li>sysfs</li>
<li>ramfs (tmpfs)</li>
<li>overlayfs</li>
<li>proc</li>
<li>aufs</li>
<li>fuse</li>
<li><strong>shiftfs</strong></li>
<li>devpts</li>
<li>cgroup</li>
</ul><p>Moreover, even if the filesystem driver is a kernel module (.ko), it is auto-loaded when the mount syscall is issued.</p>
<p>In vulnerability research, if there has been a lot of previous audit, interesting targets are :</p>
<ul><li>Surfaces which are not too much common. Here the surface with a user namespace can be a good choice because a lot of other distributions prevent it.</li>
<li>Code added recently or specific to the target. For example, the modifications from Ubuntu which are not mainline (thus not present in other distributions).</li>
</ul><p>So one of the first drivers I reviewed was <strong>shiftfs</strong> because this driver is only present in Ubuntu kernels, not much known and is mountable by an unprivileged user. Luckily, I found a vulnerability inside this driver powerful enough to perform a Local Privilege Escalation with this single bug.</p>
<h1>ShiftFS double free vulnerability (CVE-2021-3492)</h1>
<p>The vulnerability presented here lies in the filesystem driver <strong>shiftfs</strong>. This is an <em>overlay kind</em> filesystem allowing to bind-mount a directory and shift UIDs and GIDs with the map of the user namespace owner (the one which have performed the mount). This seems to be useful to bootstrap efficiently unprivileged containers. I found only two resources describing the feature :</p>
<ul><li><a href="https://discuss.linuxcontainers.org/t/trying-out-shiftfs/5155" rel="nofollow">https://discuss.linuxcontainers.org/t/trying-out-shiftfs/5155</a></li>
<li><a href="https://lwn.net/Articles/687354/" rel="nofollow">https://lwn.net/Articles/687354/</a></li>
</ul><p>To reach the filesystem code, we need to call the "mount" function specific to this filesystem. As described previously, one can create a user namespace and mount it :</p>
<div class="sourceCode" id="cb3">
<pre><code class="language-bash">$ mkdir d1 d2
$ unshare -U -r
$ unshare -m
$ mount -t tmpfs none d1
$ mount -t shiftfs -o mark,passthrough=2 d1 d2</code></pre>
</div>
<p>All file operations inside the directory <code>d2</code> will be handled first by the shiftfs driver.</p>
<p>When mounted with options “mark” and “passthrough=2”, the shiftfs filesystem handles special ioctls, mainly to forward them to the filesystem below.</p>
<figure><img alt="Mounts" class="align-center" data-entity-type="file" data-entity-uuid="95a16f5c-c347-4316-8292-fe8a524cffb7" height="181" src="./2021 - Exploitation of a double free vulnerability in Ubuntu shiftfs driver (CVE-2021-3492)_files/mounts_1.png" width="512"><p>&nbsp;</p>
</figure><p>If the ioctl number is in a whitelist, the function <code>shiftfs_real_ioctl</code> is called.</p>
<pre><code class="language-c-like">static long shiftfs_real_ioctl(struct file *file, unsigned int cmd, unsigned long arg)
{
    int newfd = -EBADF;
    long err = 0, ret = 0;
    void __user *argp = (void __user *)arg;
    struct btrfs_ioctl_vol_args *btrfs_v1 = NULL;
    struct btrfs_ioctl_vol_args_v2 *btrfs_v2 = NULL;

    ret = shiftfs_btrfs_ioctl_fd_replace(cmd, argp, &amp;btrfs_v1, &amp;btrfs_v2, &amp;newfd);
    if (ret &lt; 0)
        return ret;

    // here wrapper to vfs_ioctl()
    // ...

    err = shiftfs_btrfs_ioctl_fd_restore(cmd, newfd, argp, btrfs_v1, btrfs_v2);
    if (!ret)
        ret = err;

    return ret;
}</code></pre>
<p>When <code>BTRFS_IOC_SNAP_CREATE</code> ioctl is used, the function <code>shiftfs_btrfs_ioctl_fd_replace</code> is used to copy a structure from userspace to kernel space. The goal of this code is to wrap the legacy btrfs ioctl by replacing the file descriptor contained in the structure btrfs_ioctl_vol_args by a new one linked to the inode in the bottom filesystem. The structure is 4096 bytes long as defined in the user API header:</p>
<pre><code class="language-c-like">#define BTRFS_PATH_NAME_MAX 4087
struct btrfs_ioctl_vol_args {
    __s64 fd;
    char name[BTRFS_PATH_NAME_MAX + 1];
};</code></pre>
<p>If this ioctl is performed on a file managed by shiftfs, the handling code copies a structure btrfs_ioctl_vol_args from user space to kernel space. After replacing the fd field in this structure, it is copied back to userspace:</p>
<pre><code class="language-c-like">static int shiftfs_btrfs_ioctl_fd_replace(int cmd, void __user *arg,
                                          struct btrfs_ioctl_vol_args **b1,
                                          struct btrfs_ioctl_vol_args_v2 **b2,
                                          int *newfd)
{
    // ...

    if (cmd == BTRFS_IOC_SNAP_CREATE) {
        v1-&gt;fd = *newfd;
        ret = copy_to_user(arg, v1, sizeof(*v1));
        v1-&gt;fd = oldfd;
    } else {
        // ...
    }

    if (ret)
        shiftfs_btrfs_ioctl_fd_restore(cmd, *newfd, arg, v1, v2);

    return ret;

}</code></pre>
<p>The function <code>copy_to_user</code> returns <strong>the number of remaining bytes</strong>. If a fault happens during the copy, a positive value is returned. In the calling function <code>shiftfs_real_ioctl</code>, an error is detected by checking if the return value is negative. So even when an error occurs, the nominal path is executed leading to call <code>shiftfs_btrfs_ioctl_fd_restore</code> a second time. This function performs another <code>copy_to_user</code> to send again the structure <code>btrfs_ioctl_vol_args</code> to userspace and then free it.</p>
<pre><code class="language-c-like">static int shiftfs_btrfs_ioctl_fd_restore(int cmd, int fd, void __user *arg,
                                          struct btrfs_ioctl_vol_args *v1,
                                          struct btrfs_ioctl_vol_args_v2 *v2)
{
    int ret;

    if (!is_btrfs_snap_ioctl(cmd))
        return 0;

    if (cmd == BTRFS_IOC_SNAP_CREATE)
        ret = copy_to_user(arg, v1, sizeof(*v1));
    else
        ret = copy_to_user(arg, v2, sizeof(*v2));

    __close_fd(current-&gt;files, fd);
    kfree(v1);
    kfree(v2);

    return ret;
}</code></pre>
<p>Only one of <code>v1</code> or <code>v2</code> can be set at the same time. Both structures lead to the same vulnerability and have the same size. Calling twice <code>shiftfs_btrfs_ioctl_fd_restore</code> leads to :</p>
<ol type="1"><li>Closing two times the same fd</li>
<li>Freeing two times the same structure</li>
</ol><p>This structure has been allocated in <code>shiftfs_btrfs_ioctl_fd_replace</code> during the copy from userspace:</p>
<pre><code class="language-c-like">v1 = memdup_user(arg, sizeof(*v1));</code></pre>
<p>The kernel function <code>memdup_user</code> performs a <code>copy_from_user</code> and an allocation at the same time. This allocation uses <strong>kmalloc</strong> with flags GFP_USER which is using the same slabs as GFP_KERNEL.</p>
<p>To sum up, when faulting one <code>copy_to_user</code> :</p>
<figure><img alt="Vulnerability Overview" class="align-center" data-entity-type="file" data-entity-uuid="f43e5f4a-d455-4773-871f-5823a6551424" height="324" src="./2021 - Exploitation of a double free vulnerability in Ubuntu shiftfs driver (CVE-2021-3492)_files/vuln_0.png" width="1085"><p>&nbsp;</p>
</figure><p>While it is possible to trigger a double free on this allocation, it is also possible to <strong>forget the allocation</strong>, losing this memory for ever. Indeed, if the value of <code>v1-&gt;fd</code> targets an invalid file descriptor in the current process, the function returns a negative error and the <code>kfree</code> is never performed. This bug allows any user to fill the whole kernel memory until the system becomes out of memory.</p>
<h1>Synchronizing userspace and kernelspace</h1>
<p>Double free allows to take over a kernel memory chunk of the same kind by allocating it between the two free operations and spraying a controlled object after the second free. So the following elements are needed :</p>
<ol type="1"><li>A way to block the kernel between the first free and the second one.</li>
<li>A victim : a memory chunk of the same kind (kmalloc-4096) which can provide exploitation primitives, like kernel memory read/write.</li>
<li>A spraying technique allowing to create memory chunks of the same kind and fill their content with controlled data.</li>
</ol><p>Ubuntu kernel configurations have <code>CONFIG_PREEMPT_VOLUNTARY</code> set. This means that the kernel is not preempted by the scheduler when it is executing kernel code unless the code asks for it voluntary. However, there are several known techniques allowing to block the kernel when doing some operations. In our case, several functions called between the first free and the second one can be blocked:</p>
<ul><li><strong>vfs_ioctl</strong> is performed on the lower inode. Using a user-controlled filesystem with FUSE allows to block any operation on the file.</li>
<li><strong>copy_to_user</strong> is performed before each call to kfree. Using userfaultfd allows to block the operation.</li>
<li><strong>close_fd</strong> is performed before each call to kfree. This action could make the kernel sleep under special conditions.</li>
</ul><p>The <a href="https://www.kernel.org/doc/html/latest/admin-guide/mm/userfaultfd.html" rel="nofollow">userfaultfd</a> method has been used in the exploit. The kernel of Ubuntu groovy (20.10) introduces a new feature which allows userspace programs to manage their pages based on write faults. While it was possible to manage pages based on page fault, it is now possible to define write-protected pages and to be called by the kernel when a write is performed.</p>
<p>Its usage is simple, the exploit creates two threads : one triggers a write fault during the <code>copy_to_user</code> (in kernel mode) while the other handles this fault. During this handling (which is not limited in time), the first thread is in the shiftfs kernel code and blocked until the second thread chooses to unblock the situation.</p>
<figure><img alt="Userfaultfd" class="align-center" data-entity-type="file" data-entity-uuid="1f9e6ffe-d1d8-4d9b-be96-fe92d8443ab4" height="304" src="./2021 - Exploitation of a double free vulnerability in Ubuntu shiftfs driver (CVE-2021-3492)_files/userfaultfd.png" width="628"><p>&nbsp;</p>
</figure><p>The exploit allocates two pages of userspace memory. The vulnerable ioctl is called using a structure which uses bytes in both these pages. By setting the first page as write-protected, a userspace callback is called during the beginning of a <code>copy_to_user</code>. In the fault handling, the second page is marked as write-protected while the first one is set as writable.</p>
<p>This method allows to block several <code>copy_to_user</code> performed by the kernel on the same structure. The fact that <code>copy_to_user</code> is made after the first free means that <strong>the victim content is copied to userspace memory</strong> if the userfaultfd callback unblocks the kernel after the victim is allocated (for the first page).</p>
<p>The following diagram shows the sequence of memory mappings and protections used by the exploit :</p>
<figure><img alt="Faults handling" class="align-center" data-entity-type="file" data-entity-uuid="8b7cc900-007d-426e-a371-5f072276230b" height="678" src="./2021 - Exploitation of a double free vulnerability in Ubuntu shiftfs driver (CVE-2021-3492)_files/faults_0.png" width="891"><p>&nbsp;</p>
</figure><h1>Finding a victim in the same SLAB</h1>
<p>The Linux kernel has several ways to allocate memory. Most is allocated using <code>kmalloc</code> managed by the SLUB allocator. When a driver wants a chunk of memory, a corresponding <em>cache</em> is used depending on the size requested. For example, the memory used in this bug has a size of 4096 : the SLUB allocator will use the cache <code>kmalloc-4096</code>. As there are caches for sizes aligned on power of two, this cache contains chunks for allocation size between 2097 to 4096. A cache contains a list of <em>slabs</em> composed of several contiguous chunks of memory. When <code>kfree</code> is called, the chunk is added to a <code>free_list</code> in its slab.</p>
<p>To take over a chunk with a double free, we just need to make sure of the following :</p>
<ol type="1"><li>The first normal <code>kfree</code> is made on a known CPU</li>
<li>The victim is allocated on the same CPU using <code>kmalloc</code> with a compatible size to use the same slab. Because each CPU has a dedicated <em>slab</em> which always corresponds to the lattest <code>kfree</code>, the returned chunk is the same as in the 1.</li>
<li>The second buggy <code>kfree</code> is made.</li>
<li>Another allocation on the same CPU, with the same size, is made in order to control the new content of the victim.</li>
</ol><p>The exploit does all these actions on the same CPU using <code>sched_setaffinity</code>, which is allowed for an unprivileged user. To prevent from races of other kernel allocations, they must be made in a small time window.</p>
<p>But how to find a suitable victim? We need to make the kernel allocate a chunk between 2097 and 4096 bytes which can be useful to know the KASLR offset and/or get some kind of powerful primitive like an arbitrary write or a way to temper the execution flow.</p>
<p>I used two approaches to locate the victim :</p>
<ol type="1"><li>I constructed a database of suitable objects. Using the same source code and the same config, a <em>vmlinux</em> with debugging data was built. Then, using <strong>pahole</strong>, all the kernel structures names and sizes have been extracted. As the kernel usually allocates chunks of the size of a structure, it is a good way to find victims.</li>
<li>In runtime, one can use the kernel tracer to display all allocations made by the kernel. By filtering on the allocation size, a potential victim can be found by generating system activity (for example, launching a browser, …).</li>
</ol><p>It turns out that there is not much potential victims. Hopefully I found an interesting one which also can be triggered from an unprivileged user : <code>devinet_sysctl_table</code>.</p>
<pre><code class="language-c-like">static struct devinet_sysctl_table {
    struct ctl_table_header *sysctl_header;
    struct ctl_table devinet_vars[__IPV4_DEVCONF_MAX];
} devinet_sysctl= {
    .devinet_vars = {
        DEVINET_SYSCTL_COMPLEX_ENTRY(FORWARDING, "forwarding",devinet_sysctl_forward),
        DEVINET_SYSCTL_RO_ENTRY(MC_FORWARDING, "mc_forwarding"),
        DEVINET_SYSCTL_RW_ENTRY(BC_FORWARDING, "bc_forwarding"),
        // ...
    }
}</code></pre>
<p>The victim used by the exploit is one of the network sysctl tables. These tables are created at boot time for the main network stack. However, network namespaces use dedicated sysctl tables. Those configuration values can be read and written using the procfs filesystem in path /proc/sys/net/.</p>
<p>When creating a new network namespace, the first kmalloc-4096 chunk allocated stores the IPv4 generic sysctl table of the stack. This table is managed by the file net/ipv4/devinet.c. The allocation is a copy of the global table devinet_sysctl_table. This can be checked using the kernel tracer after a <code>unshare -n</code> :</p>
<pre><code>bash-1912    [002] ....  5515.306551: kmalloc: call_site=__devinet_sysctl_register+0x47/0x110 ptr=00000000552c19f5 bytes_req=2120 bytes_alloc=4096 gfp_flags=GFP_KERNEL
bash-1912    [002] ....  5515.306595: kmalloc: call_site=__devinet_sysctl_register+0x47/0x110 ptr=000000007dd47f0d bytes_req=2120 bytes_alloc=4096 gfp_flags=GFP_KERNEL
bash-1912    [002] ....  5515.306742: kmalloc: call_site=mr_table_alloc+0x42/0x100 ptr=00000000598ab799 bytes_req=3608 bytes_alloc=4096 gfp_flags=GFP_KERNEL|__GFP_ZERO
bash-1912    [002] ....  5515.306766: kmalloc: call_site=ipv4_mib_init_net+0xf4/0x1a0 ptr=00000000d0d71277 bytes_req=4096 bytes_alloc=4096 gfp_flags=GFP_KERNEL|__GFP_ZERO
bash-1912    [002] ....  5515.306811: kmalloc: call_site=__register_sysctl_table+0x50/0x1e0 ptr=000000001ae330cc bytes_req=3216 bytes_alloc=4096 gfp_flags=GFP_KERNEL|__GFP_ZERO
bash-1912    [002] ....  5515.306922: kmalloc: call_site=ipv6_init_mibs+0xb2/0x110 ptr=00000000dd7d83c1 bytes_req=4096 bytes_alloc=4096 gfp_flags=GFP_KERNEL|__GFP_ZERO</code></pre>
<p>Creating a network namespace allocates other chunks matching the same slab size. When several allocations are made, the CPU slab may be replaced by a new one, loosing the victim slab which is inserted in the global partial list (slabs containing free chunks not binded to a CPU). To get back this slab, the exploit allocates more chunks than the number of chunks in one slab. In our case, one slab contains 8 chunks, to get back the victim slab, more than 8 chunks are allocated at the end.</p>
<p>The chosen victim is very interesting because it contains a <code>ctl_table</code> structure defined as below :</p>
<pre><code class="language-c-like">struct ctl_table {
        const char  *              procname;             /*     0   0x8 */
        void *                     data;                 /*   0x8   0x8 */
        int                        maxlen;               /*  0x10   0x4 */
        umode_t                    mode;                 /*  0x14   0x2 */
        struct ctl_table *         child;                /*  0x18   0x8 */
        proc_handler *             proc_handler;         /*  0x20   0x8 */
        struct ctl_table_poll *    poll;                 /*  0x28   0x8 */
        void *                     extra1;               /*  0x30   0x8 */
        void *                     extra2;               /*  0x38   0x8 */
};</code></pre>
<p>The <code>proc_handler</code> field is a function pointer! By leaking its original value, the KASLR offset can be retrieved. For network sysctl, this first pointer is <code>devinet_sysctl_forward</code> and is used to compute KASLR offset by subtracting its base address from the kernel symbols file.</p>
<p>Moreover, the sysctl header address is leaked at the begining of the structure. This is a distinct allocation and dumping its content allows to retrieve the address of the victim.</p>
<p>The spraying technique used is simple: it uses several times the same ioctl of the vulnerability (BTRFS_IOC_SNAP_CREATE). Indeed, the syscall performs an allocation of 4096 bytes. By setting an invalid file descriptor in the <code>fd</code> field, the allocation is never freed which is very useful to repair a double free. The only constraint on sprayed content is on the first bytes because the field <code>fd</code> is patched by shiftfs code. When R/W primitive is installed, the first bytes of the victim’s initial content are restored.</p>
<h1>Primitives stabilization using sysctl tables</h1>
<p>An entry in the sysctl table is defined by the structure <code>ctl_table</code> and is overwritten by the chunk reuse and the spray technique.</p>
<p>A kernel read/write can be obtained by setting the pointer data to a given destination and using the function <code>proc_doulongvec_minmax</code> as the <code>proc_handler</code>. This function will read and write any number of 64-bits values in kernel memory pointed by data when a userspace process read and write the files in /proc/sys/net/ipv4/conf/all.</p>
<p>The exploit takes over several sysctl:</p>
<ul><li><strong>sysctl0</strong>: /proc/sys/net/ipv4/conf/all/forwarding: Used to dump the sysctl_header and get the address of the victim</li>
<li><strong>sysctl1</strong>: /proc/sys/net/ipv4/conf/all/mc_forwarding: This sysctl is set to overwrite a global sysctl in the main namespace (sys.debug.exception-trace) to get a reusable R/W primitive. The global sysctl table is restored after the victim address has been leaked and the content of sysctl2 has been written.</li>
<li><strong>sysctl2</strong>: /proc/sys/net/ipv4/conf/all/bc_forwarding: Target sysctl3 and allow to change the destination of reads/writes (data field).</li>
<li><strong>sysctl3</strong>: /proc/sys/net/ipv4/conf/all/accept_redirects: Use to R/W kernel memory, this table is patched by sysctl2.</li>
<li><strong>sysctl4</strong>: /proc/sys/net/ipv4/conf/all/secure_redirects: Use to call functions, this table is patched by the R/W primitive.</li>
</ul><figure><img alt="Sysctl table replaced" class="align-center" data-entity-type="file" data-entity-uuid="b475d779-b878-4348-aa1a-db7e5e93ced3" src="./2021 - Exploitation of a double free vulnerability in Ubuntu shiftfs driver (CVE-2021-3492)_files/sysctl.png"><p>&nbsp;</p>
</figure><p>After the primitives stabilization, the exploit program can read and write kernel memory by reading and writing files in the /proc.</p>
<h1>Kernel code execution and root rights</h1>
<p>Note that stable kernel read/write is enough to get userland root access. But as we already have a <strong>call</strong> primitive, I decided to do it by kernel code execution. The main kernel protection preventing userland code execution from the kernel is SMAP. The protection prevents the kernel itself from accessing or executing user memory outside dedicated functions like <code>copy_{from|to}_user</code>.</p>
<p>There should not be a mapping with write and execute permissions at the same time. However, legacy kernel code calls the function <code>set_memory_x</code> which remaps the victim’s page as executable.</p>
<p>To call this function, the sysctl4 is used with a patched <code>proc_handler</code>. When it is called, the first argument is the address of the <code>ctl_table</code>. When writing data into a sysctl file (in /proc), the second argument is set to 1. So when calling <code>set_memory_x</code>, the second argument will be 1 which is the number of pages to remap as executable. As it is 4096 bytes long, the victim is composed of only one page but the addresses of the tables are not aligned on a page start. When using <code>set_memory_x</code> with an address which is not aligned, its page is still remapped but a warning is displayed in the dmesg by the <code>WARN_ON</code> macro.</p>
<p>With this technique, the victim memory is set executable. A shellcode is written inside this memory and then the sysctl4 is patched to call this payload. The shellcode executes the usual code to get root credentials for the current process:</p>
<pre><code class="language-c-like">commit_cred(prepare_kernel_cred(0));</code></pre>
<p>At the end, the exploit spawns a new shell.</p>
<h1>Conclusion</h1>
<p>When searching vulnerability for a Local Escalation of Privilege, I discovered a lot of features I did not know about and learnt several exploitation techniques (userfaultfd, spray techniques, chunk reuse, …). I was lucky to find something in one of the first drivers I audited.</p>
<p>The double free vulnerabilities are very dangerous because they are often exploitable only using one bug. As seen with the presented bug, it offers an infoleak at the same time as a chunk reuse. Even without this infoleak, hijacking a known kernel object could be enough.</p>
<p>The <code>sysctl</code> tables are very interesting targets for exploitation. A single <em>write</em> on a global structure (which address is known if KALSR offset is resolved) allows to get reusable R/W primitives. With such primitives, root rights can be acquired in various ways.</p>
<p>If you don’t use unprivileged containers, I would recommend setting <code>kernel.unprivileged_userns_clone</code> to 0 to reduce the attack surface.</p>
<p>This was my first participation to Pwn2Own. I would like to thanks ZDI for organizing Pwn2Own and Ubuntu kernel team for participating and for their reactivity to fix the bug.</p>
<h1>Resources</h1>
<p>Ubuntu fixes :</p>
<ul><li><a href="https://ubuntu.com/security/CVE-2021-3492" rel="nofollow">https://ubuntu.com/security/CVE-2021-3492</a></li>
<li><a href="https://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/focal/commit/?id=8fee52ab9da87d82bc6de9ebb3480fff9b4d53e6" rel="nofollow">Commit 1</a></li>
<li><a href="https://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/focal/commit/?id=25c891a949bf918b59cbc6e4932015ba4c35c333" rel="nofollow">Commit 2</a></li>
</ul><p>Other blogposts on kernel exploitation :</p>
<ul><li>CVE-2017-11176 :
	<ul><li><a href="https://blog.lexfo.fr/cve-2017-11176-linux-kernel-exploitation-part1.html" rel="nofollow">https://blog.lexfo.fr/cve-2017-11176-linux-kernel-exploitation-part1.html</a></li>
<li><a href="https://blog.lexfo.fr/cve-2017-11176-linux-kernel-exploitation-part2.html" rel="nofollow">https://blog.lexfo.fr/cve-2017-11176-linux-kernel-exploitation-part2.html</a></li>
<li><a href="https://blog.lexfo.fr/cve-2017-11176-linux-kernel-exploitation-part3.html" rel="nofollow">https://blog.lexfo.fr/cve-2017-11176-linux-kernel-exploitation-part3.html</a></li>
</ul></li>
<li>About Userfaultfd : <a href="https://blog.lizzie.io/using-userfaultfd.html" rel="nofollow">https://blog.lizzie.io/using-userfaultfd.html</a></li>
<li>About Userfaultfd and sprays : <a href="https://duasynt.com/blog/linux-kernel-heap-spray" rel="nofollow">https://duasynt.com/blog/linux-kernel-heap-spray</a></li>
<li>CVE-2017-7308 :
	<ul><li><a href="https://googleprojectzero.blogspot.com/2017/05/exploiting-linux-kernel-via-packet.html" rel="nofollow">https://googleprojectzero.blogspot.com/2017/05/exploiting-linux-kernel-via-packet.html</a></li>
<li><a href="https://github.com/xairy/kernel-exploits/tree/master/CVE-2017-7308" rel="nofollow">https://github.com/xairy/kernel-exploits/tree/master/CVE-2017-7308</a></li>
</ul></li>
<li>Alexander Popov great blog : <a href="https://a13xp0p0v.github.io/" rel="nofollow">https://a13xp0p0v.github.io/</a></li>
</ul><p>&nbsp;</p>
</div>
<div class="share-links">
<span>Partagez cet article</span>
<div class="link-wrapper">
<div class="a2a_kit a2a_kit_size_32 a2a_default_style">
<a class="a2a_button_facebook"></a>
<a class="a2a_button_twitter"></a>
</div>
</div>
<!--<script async src="https://static.addtoany.com/menu/page.js"></script>-->
</div>
</div>
</article>
</div>
</div>
</div>
<div class="page-contact-section">
<div class="container">
<div class="region region-footer">
<section class="contact-service-wrapper block block-block-content block-block-content60a6be42-565a-42b6-88e3-35ff45dab357 clearfix" id="block-autrespublications">
<div class="inner-wrapper">
<h2 class="block-title">Autres publications</h2>
</div>
</section>
<section class="views-element-container other-publications block block-views block-views-blockpublications-with-same-tag-block-1 clearfix" id="block-views-block-publications-with-same-tag-block-1">
<div class="form-group"><div class="view view-publications-with-same-tag view-id-publications_with_same_tag view-display-id-block_1 js-view-dom-id-332d82b8aea205f69be6133be3a3289ba1c543d7ec398b4b07ab2029ee15d3c2">
<div class="view-content">
<div class="col-sm-4 views-row">
<article about="/publications/yet-another-bec-investigation-on-m365" class="article teaser-view clearfix" role="article" typeof="schema:Article">
<div class="content">
<a href="https://www.synacktiv.com/publications/yet-another-bec-investigation-on-m365.html"><h3><span property="schema:name">Yet another BEC investigation on M365</span>
</h3></a>
<div class="wrapper-content">
<div class="text-summary">Several materials already describe this type of attack, this document is an operational feedback from the CSIRT Synacktiv on several BEC incidents based on Microsoft 365 service. This is the part one ...</div>
<div class="short-info">
<span class="author-name">Arnaud Pilon</span>
   ,   <span class="author-name">Jean-Christophe Delaunay</span>
   ,   <span class="author-name">Rémi Jullian</span>
   
 - 22/11/2021 - 
   <span class="category">CSIRT</span>
</div>
</div>
</div>
</article>
</div>
<div class="col-sm-4 views-row">
<article about="/publications/how-to-exploit-cve-2021-40539-on-manageengine-adselfservice-plus" class="article teaser-view clearfix" role="article" typeof="schema:Article">
<div class="content">
<a href="https://www.synacktiv.com/publications/how-to-exploit-cve-2021-40539-on-manageengine-adselfservice-plus.html"><h3><span property="schema:name">How to exploit CVE-2021-40539 on ManageEngine ADSelfService Plus</span>
</h3></a>
<div class="wrapper-content">
<div class="text-summary">During a penetration test we encountered the ManageEngine ADSelfService Plus (ADSS) solution. ADSS offers multiple functionalities such as managing password policies for administrators or self passwor...</div>
<div class="short-info">
<span class="author-name">Antoine Cervoise</span>
   ,   <span class="author-name">Wilfried Bécard</span>
   
 - 04/11/2021 - 
   <span class="category">Exploit</span>
   ,   <span class="category">Pentest</span>
</div>
</div>
</div>
</article>
</div>
<div class="col-sm-4 views-row">
<article about="/publications/finding-gadgets-like-its-2015-part-2" class="article teaser-view clearfix" role="article" typeof="schema:Article">
<div class="content">
<a href="https://www.synacktiv.com/publications/finding-gadgets-like-its-2015-part-2.html"><h3><span property="schema:name">Finding gadgets like it's 2015: part 2</span>
</h3></a>
<div class="wrapper-content">
<div class="text-summary">We found a new Java gadget chain in the Mojarra library, one of the most used implementation of the JSF specification. It uses a known entry point to start the chain and ends with arbitrary code execu...</div>
<div class="short-info">
<span class="author-name">Hugo Vincent</span>
   
 - 28/10/2021 - 

      </div>
</div>
</div>
</article>
</div>
</div>
</div>
</div>
</section>
</div>
</div>
</div>
</div>
</div>
<div class="footer">
<div class="footer-top">
<div class="container">
<div class="footer-inner">
<div class="left-items col-sm-6">
<div class="footer-left col-sm-6"> <div class="region region-footer-left">
<a class="logo navbar-btn pull-left" href="https://www.synacktiv.com/index.html" rel="home" title="Accueil">
<img alt="Accueil" src="./2021 - Exploitation of a double free vulnerability in Ubuntu shiftfs driver (CVE-2021-3492)_files/logo_synacktiv_blanc.png">
</a>
<nav aria-labelledby="block-lasocieteanchormenu-2-menu" id="block-lasocieteanchormenu-2" role="navigation">
<ul class="menu menu--la-societe-anchor-menu nav">
<li class="first">
<a data-drupal-link-system-path="node/1" href="https://www.synacktiv.com/la-societe.html#who-we-are">Qui sommes-nous ?</a>
</li>
<li>
<a data-drupal-link-system-path="node/1" href="https://www.synacktiv.com/la-societe.html#our-values">Nos valeurs</a>
</li>
<li>
<a data-drupal-link-system-path="node/1" href="https://www.synacktiv.com/la-societe.html#aggrement">Agréments et accréditations</a>
</li>
<li class="last">
<a data-drupal-link-system-path="node/1" href="https://www.synacktiv.com/la-societe.html#our-clients">Nos clients</a>
</li>
</ul>
</nav>
<nav aria-labelledby="block-notreequipeanchormenu-menu" id="block-notreequipeanchormenu" role="navigation">
<ul class="menu menu--notre-equipe-anchor-menu nav">
<li class="first">
<a data-drupal-link-system-path="node/6" href="https://www.synacktiv.com/notre-equipe/lequipe-support.html">L’équipe support</a>
</li>
<li>
<a data-drupal-link-system-path="node/7" href="https://www.synacktiv.com/notre-equipe/pentest.html">Pentest</a>
</li>
<li>
<a data-drupal-link-system-path="node/8" href="https://www.synacktiv.com/notre-equipe/reverse.html">Reverse</a>
</li>
<li>
<a data-drupal-link-system-path="node/9" href="https://www.synacktiv.com/notre-equipe/developpement.html">Développement</a>
</li>
<li class="last">
<a data-drupal-link-system-path="node/573" href="https://www.synacktiv.com/our-team/reponse-aux-incidents.html">Réponse aux incidents (CSIRT)</a>
</li>
</ul>
</nav>
<nav aria-labelledby="block-nousrejoindreanchormenu-2-menu" id="block-nousrejoindreanchormenu-2" role="navigation">
<ul class="menu menu--nous-rejoindre-anchor-menu nav">
<li class="first">
<a data-drupal-link-system-path="node/19" href="https://www.synacktiv.com/nous-rejoindre.html#philosophie">Philosophie</a>
</li>
<li>
<a data-drupal-link-system-path="node/19" href="https://www.synacktiv.com/nous-rejoindre.html#recrutement">Processus de recrutement</a>
</li>
<li class="last">
<a data-drupal-link-system-path="node/19" href="https://www.synacktiv.com/nous-rejoindre.html#block-views-block-job-offer-list-view-block-1">Offres emploi/stage</a>
</li>
</ul>
</nav>
</div>
</div>
<div class="footer-right col-sm-6"> <div class="region region-footer-right">
<nav aria-labelledby="block-produitsanchormenu-menu" id="block-produitsanchormenu" role="navigation">
<ul class="menu menu--produits-anchor-menu nav">
<li class="first">
<a data-drupal-link-system-path="node/31" href="https://www.synacktiv.com/produits/kraqozorus.html">Kraqozorus</a>
</li>
<li>
<a data-drupal-link-system-path="node/3" href="https://www.synacktiv.com/produits/houdini.html">Houdini</a>
</li>
<li>
<a data-drupal-link-system-path="node/30" href="https://www.synacktiv.com/produits/disconet.html">Disconet</a>
</li>
<li>
<a data-drupal-link-system-path="node/32" href="https://www.synacktiv.com/produits/oursin.html">Oursin</a>
</li>
<li class="last">
<a data-drupal-link-system-path="node/33" href="https://www.synacktiv.com/produits/leakozorus.html">Leakozorus</a>
</li>
</ul>
</nav>
<nav aria-labelledby="block-prestationsanchormenu-menu" id="block-prestationsanchormenu" role="navigation">
<ul class="menu menu--prestations-anchor-menu nav">
<li class="first">
<a data-drupal-link-system-path="node/2" href="https://www.synacktiv.com/prestations/test-dintrusionred-team.html">Test d’intrusion/red team</a>
</li>
<li>
<a data-drupal-link-system-path="node/34" href="https://www.synacktiv.com/prestations/audit-de-securite.html">Audit de sécurité</a>
</li>
<li>
<a data-drupal-link-system-path="node/35" href="https://www.synacktiv.com/prestations/reverse-engineering.html">Reverse-engineering</a>
</li>
<li>
<a data-drupal-link-system-path="node/9" href="https://www.synacktiv.com/notre-equipe/developpement.html">Développement</a>
</li>
<li class="last">
<a data-drupal-link-system-path="node/572" href="https://www.synacktiv.com/prestations/reponse-aux-incidents.html">Réponse aux incidents</a>
</li>
</ul>
</nav>
<nav aria-labelledby="block-csirtanchormenu-menu" id="block-csirtanchormenu" role="navigation">
<ul class="menu menu--reponse-aux-incidents-anchor-men nav">
<li class="first last">
<a data-drupal-link-system-path="node/576" href="https://www.synacktiv.com/offres/csirt.html">CSIRT Synacktiv </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="right-items col-sm-6">
<div class="block-title"><h2>Nous contacter</h2></div>
<div class="contact-teaser"><div class="views-element-container form-group"><div class="view view-ou-nous-trouver- view-id-ou_nous_trouver_ view-display-id-block_1 js-view-dom-id-abb1cea8e27525f791f31f70fd3a1a1095da4500b31ed75f234ce1056286fac8">
<div class="view-content">
<div class="views-row">
<div class="field field--name-field-phone field--type-string field--label-hidden field--item">
<a class="phone-icon" href="tel:01 45 79 74 75">01 45 79 74 75</a>
</div>
<div class="field field--name-field-email field--type-email field--label-hidden field--item">
<a class="mail-icon" href="mailto:contact@synacktiv.com">contact@synacktiv.com</a>
</div>
<div class="field field--name-field-gpg-key field--type-link field--label-hidden field--item">
<a class="key-icon" href="https://www.synacktiv.com/ressources/contact_synacktiv.asc">Clé GPG</a>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="locations"><div class="views-element-container form-group"><div class="view view-ou-nous-trouver- view-id-ou_nous_trouver_ view-display-id-block_2 js-view-dom-id-85580f9ca4f2ad4e0e99aa83af0336b818af05a883498b7a0de59a6b2e976203">
<div class="view-content">
<div class="col-sm-6 views-row"><div class="views-field views-field-field-address"><div class="field-content"> <div class="paragraph paragraph--type--locations paragraph--view-mode--default">
<div class="field-address-items">
<h2 class="marker-icon">PARIS</h2>
<div class="address">
<div class="field field--name-field-address field--type-string-long field--label-hidden field--item">5 boulevard Montmartre<br>
75002 Paris</div>
</div>
</div>
</div>
</div></div></div>
<div class="col-sm-6 views-row"><div class="views-field views-field-field-address"><div class="field-content"> <div class="paragraph paragraph--type--locations paragraph--view-mode--default">
<div class="field-address-items">
<h2 class="marker-icon">TOULOUSE</h2>
<div class="address">
<div class="field field--name-field-address field--type-string-long field--label-hidden field--item">11 rue des Abeilles<br>
31000 Toulouse</div>
</div>
</div>
</div>
</div></div></div>
<div class="col-sm-6 views-row"><div class="views-field views-field-field-address"><div class="field-content"> <div class="paragraph paragraph--type--locations paragraph--view-mode--default">
<div class="field-address-items">
<h2 class="marker-icon">LYON</h2>
<div class="address">
<div class="field field--name-field-address field--type-string-long field--label-hidden field--item">56 rue Smith<br>
69002 Lyon</div>
</div>
</div>
</div>
</div></div></div>
<div class="col-sm-6 views-row"><div class="views-field views-field-field-address"><div class="field-content"> <div class="paragraph paragraph--type--locations paragraph--view-mode--default">
<div class="field-address-items">
<h2 class="marker-icon">RENNES</h2>
<div class="address">
<div class="field field--name-field-address field--type-string-long field--label-hidden field--item">38 avenue Andrée Viollis<br>
35000 Rennes</div>
</div>
</div>
</div>
</div></div></div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="footer-bottom">
<div class="container">
<div class="copyright">Copyright © Synacktiv 2021</div>
<div class="region region-footer-bottom">
<nav aria-labelledby="block-footermenu-menu" id="block-footermenu" role="navigation">
<ul class="menu menu--footer-menu nav">
<li class="first">
<a data-drupal-link-system-path="node/4" href="https://www.synacktiv.com/mentions-legales.html">Mentions légales</a>
</li>
<li class="last">
<a data-drupal-link-system-path="contact" href="https://www.synacktiv.com/contact.html">Contactez-nous</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
</div>
</div>
<script data-drupal-selector="drupal-settings-json" type="application/json">{"path": {"baseUrl": "/", "scriptPath": null, "pathPrefix": "", "currentPath": "node/510", "currentLanguage": "fr"}, "pluralDelimiter": "\u0003", "suppressDeprecationErrors": true, "back_to_top": {"back_to_top_button_trigger": "100", "back_to_top_prevent_on_mobile": 0, "back_to_top_prevent_in_admin": 0, "back_to_top_button_type": "image", "back_to_top_button_text": "Back to top"}, "bootstrap": {"forms_has_error_value_toggle": 1}, "superfish": {"superfish-main": {"id": "superfish-main", "sf": {"animation": {"opacity": "show", "height": "show"}, "speed": "fast"}, "plugins": {"smallscreen": {"mode": "window_width", "breakpoint": 992, "expandText": "D\u00e9plier", "collapseText": "Replier", "title": "Main navigation"}, "supposition": true, "supersubs": true}}}}</script>
<script src="./2021 - Exploitation of a double free vulnerability in Ubuntu shiftfs driver (CVE-2021-3492)_files/js_rusY0UQGpgUgVePYPv62RpyTqKUL_GdQs27OT6RdhmA.js.下載"></script>
<script src="./2021 - Exploitation of a double free vulnerability in Ubuntu shiftfs driver (CVE-2021-3492)_files/bootstrap.min.js.下載"></script>
<script defer="" src="./2021 - Exploitation of a double free vulnerability in Ubuntu shiftfs driver (CVE-2021-3492)_files/custom.js.下載"></script>
<script defer="" src="./2021 - Exploitation of a double free vulnerability in Ubuntu shiftfs driver (CVE-2021-3492)_files/swiper.js.下載"></script>
<script src="./2021 - Exploitation of a double free vulnerability in Ubuntu shiftfs driver (CVE-2021-3492)_files/js_JP_x-sbRzkzG4QidGa5FeaACScdu33oppQ2UimueYro.js.下載"></script>
<script defer="" src="./2021 - Exploitation of a double free vulnerability in Ubuntu shiftfs driver (CVE-2021-3492)_files/addtoany.js.下載"></script>
<script src="./2021 - Exploitation of a double free vulnerability in Ubuntu shiftfs driver (CVE-2021-3492)_files/js_hvZg4ZkPPn3ZvCG4eIn7BMQEgJY_TWjinzKB0RZ1qWs.js.下載"></script>


</body></html>