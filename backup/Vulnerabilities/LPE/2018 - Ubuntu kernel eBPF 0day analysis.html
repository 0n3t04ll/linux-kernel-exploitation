<!DOCTYPE html>
<!-- saved from url=(0051)https://security.tencent.com/index.php/blog/msg/124 -->
<html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <!--<base href="https://security.tencent.com/">--><base href=".">
        <!--[if lte IE 6]></base><![endif]-->
        
        
        <title>
            四两拨千斤 —— Ubuntu kernel eBPF 0day分析 - 博客 - 腾讯安全应急响应中心        </title>
        <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
        <meta name="description" content="腾讯安全应急响应中心,Tencent Security Response Center,TSRC">
        <meta name="keywords" content="腾讯,Tencent,安全团队,应急响应,腾讯安全应急响应中心,Tencent Security Response Center,TSRC">
        <meta name="renderer" content="webkit">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <link rel="icon shortcut" href="https://security.tencent.com/static/v2.0/images/favicon.ico">
        <link rel="stylesheet" href="./2018 - Ubuntu kernel eBPF 0day analysis_files/main.min.css">
        <!--[if (gte IE 6)&(lte IE 8)]>
        <script type="text/javascript" src="static/plugins/selectivizr.min.js"></script>
        <script type="text/javascript" src="static/plugins/respond.min.js"></script>
        <![endif]-->
        <script type="text/javascript" src="./2018 - Ubuntu kernel eBPF 0day analysis_files/jquery.js.下載"></script>
    
        <style type="text/css">
            .header>div .userpanel .userpanel_login .login-btn-1 {
                width: 80px;
                margin: 0 2px;
                -webkit-transition: color .2s,border-color .2s,width .5s,height .5s,line-height .5s;
                transition: color .2s,border-color .2s,width .5s,height .5s,line-height .5s;
            }
            .header>div .userpanel .userpanel_login .login-btn-2 {
                width: 80px;
                margin: 0 2px;
                -webkit-transition: color .2s,border-color .2s,width .5s,height .5s,line-height .5s;
                transition: color .2s,border-color .2s,width .5s,height .5s,line-height .5s;
            }

            .header>div .userpanel .userpanel_login .login-qq {margin-left:10px;}

            .header>div .logo>a .logo_pic {
                background-image: -webkit-image-set(url(static/v2.0/images/logo@1x.png?t=20180424) 1x,url(static/v2.0/images/logo@2x.png?t=20180424) 2x);
                background-position: 0px -8.5px;
            }
            .header-scroll>div .logo>a .logo_pic {
                background-position: 0px -6px;
            }

            .header>div .userpanel .userpanel_user .user_username { max-width: 80px; }

            .header>div .nav {
                float: left;
                margin-left: 10px;
            }

            .header>div .header-separator {
                content: '';
                position: absolute;
                width: 1px;
                height: 28px;
                margin-left: 3px;
                margin-top: 31px;
                background-color: #d9d9d9;
                -webkit-transition: height .5s,margin-top .5s;
                transition: height .5s,margin-top .5s;
            }

            .header-scroll>div .header-separator {
                height: 17px;
                margin-top: 18px;
                margin-left: 3px;
                content: '';
                position: absolute;
                width: 1px;
                background-color: #d9d9d9;
                transition: height .5s,margin-top .5s;
            }

            .header-change {
                height:90px;
                line-height:90px;
                float:right;
            }

            .header-change a {
                position: absolute;
                margin-left: 10px;
                text-decoration:none;
            }

            .header-change a:hover{
                color: #4183c4;
            }

            .header-scroll>div .header-change {
                height:50px;
                line-height:50px;
                float:right;
            }

            .header>div .userpanel .userpanel_user .user_menu {width: 185px;}

            .header>div .nav>ul {margin-right:0px;}

            .header>div .nav>ul>li {margin: 0 8px;}

        </style>
    
    <script type="text/javascript">
        $(function(){
            
            // 选择导航栏
            var top_tab = 'blog';
            $('.header .nav li[name='+ top_tab +']').attr('class', 'nav_item-active');

            // 登录处理
            seajs.use('modules/utils', function(m) {

                // 设置登录url
                var cur_url = encodeURIComponent(location.href);
                $('.login-qq').attr('href', 'index.php/login/in?type=qq&redirect_uri='+cur_url);
                $('.login-wx').attr('href', 'index.php/login/in?type=wx&redirect_uri='+cur_url);

                // 如果是在微信上访问，则使用授权登录
                if (m.iswechat()) {
                    $('.login-wx').attr('href', 'index.php/login/in?type=wxgz&redirect_uri='+cur_url);
                }
                
                // 绑定退出登录事件
                m.logout_bind('logout');
            });

            // 导航栏效果
            $(window).scroll(function () {
                if($(this).scrollTop() > 80) {
                    $('.header').addClass('header-scroll');
                } else {
                    $('.header').removeClass('header-scroll');
                }
            });
        });
    </script></head>
    
    <body>

        <div class="header header-scroll">
            <div>
                <div class="logo">
                    <a href="https://security.tencent.com/index.php">
                        <div class="logo_pic">
                        </div>
                        <div class="logo_name">
                            <p>腾讯安全应急响应中心</p>
                            <p>Tencent Security Response Center</p>
                        </div>
                    </a>
                </div>

                <div class="nav">
                    <ul>
                        <li name="index"><a href="https://security.tencent.com/index.php">首页</a></li>
                        <li name="report_add"><a href="https://security.tencent.com/index.php/report/add">提交漏洞</a></li>
                        <li name="thanks"><a href="https://security.tencent.com/index.php/thanks">英雄榜</a></li>
                        <li name="shop"><a href="https://security.tencent.com/index.php/shop">礼品</a></li>
                        <li name="blog" class="nav_item-active"><a href="https://security.tencent.com/index.php/blog">博客</a></li>
                        <li name="ti"><a href="https://security.tencent.com/index.php/ti">情报</a></li>
                        <li name="opensource"><a href="https://security.tencent.com/index.php/opensource">实验室</a></li>
                        <li name="aixin"><a href="https://security.tencent.com/index.php/aixin">公益</a></li>
                        <li name="xsrc"><a href="https://security.tencent.com/index.php/xsrc">xSRC</a></li>
                        <li name="about"><a href="https://security.tencent.com/index.php/about">关于我们</a></li>
                        <li style="display: none;" name="news">
                            <a href="https://security.tencent.com/index.php/news">预警
                                                            </a>
                        </li>
                    </ul>
                </div>

                <div style="float:right;">

                    <div class="userpanel" style="float:left;">
                        <div class="userpanel_login" style="display:block">
                            <a class="mod-btn mod-btn-black login-btn-1 login-qq" href="https://security.tencent.com/index.php/login/in?type=qq&amp;redirect_uri=https%3A%2F%2Fsecurity.tencent.com%2Findex.php%2Fblog%2Fmsg%2F124">QQ 登录</a>
                            <a class="mod-btn mod-btn-black login-btn-2 login-wx" href="https://security.tencent.com/index.php/login/in?type=wx&amp;redirect_uri=https%3A%2F%2Fsecurity.tencent.com%2Findex.php%2Fblog%2Fmsg%2F124">微信登录</a>
                        </div>
                        <div class="userpanel_user" style="display:none">
                            <img class="user_avatar mod-avatar-30" src="https://security.tencent.com/" alt="">
                            <span class="user_username"><i class="i-header-message" style="display:none"></i></span>
                            <i class="user_arrow"></i>
                            <div class="user_menu">
                                <ul class="menu_list">
                                    <li class="list_item list_item-user">
                                        <a href="https://security.tencent.com/index.php/user">
                                            <i class="item_icon"></i>
                                            <span class="item_text">个人主页</span>
                                        </a>
                                    </li>
                                    <li class="list_item list_item-message">
                                        <a href="https://security.tencent.com/index.php/user/message">
                                            <i class="item_icon"></i>
                                            <span class="item_text">消息中心</span>
                                            <i class="item_icon-message" style="display:none"></i>
                                        </a>
                                    </li>
                                    <li class="list_item list_item-account">
                                        <a href="https://security.tencent.com/index.php/user/info">
                                            <i class="item_icon"></i>
                                            <span class="item_text">账户设置</span>
                                        </a>
                                    </li>
                                    <li class="list_item list_item-logout">
                                        <a id="logout" href="javascript:void(0)">
                                            <i class="item_icon"></i>
                                            <span class="item_text">退出</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>



                    <div class="header-change">
                        <span class="header-separator"></span>
                        <a href="https://en.security.tencent.com/">En</a>
                    </div>

                </div>

                
            </div>
        </div>
<link rel="stylesheet" type="text/css" href="./2018 - Ubuntu kernel eBPF 0day analysis_files/editormd.preview.min.css">
<style type="text/css">
#blog-text a {text-decoration: underline; color:#0000ff;}
#blog-text strong {font-weight:bold;}
#blog-text b {font-weight:bold;}
#blog-text i {font-style:italic;}
#blog-text table {}

.mod-share-dropdown .share_dropdownpanel {z-index: 10000}

/**
 * markdown css
 */
.markdown-body a, abbr, acronym, address, applet, article, aside, audio, b, big, blockquote, body, canvas, caption, center, cite, code, dd, del, details, dfn, div, dl, dt, em, embed, fieldset, figcaption, figure, footer, form, h1, h2, h3, h4, h5, h6, header, hgroup, html, i, iframe, img, ins, kbd, label, legend, li, mark, menu, nav, object, ol, output, p, pre, q, ruby, s, samp, section, small, span, strike, strong, sub, summary, sup, table, tbody, td, tfoot, th, thead, time, tr, tt, u, ul, var, video {
    font-size: 15;
}

</style>

<div class="container container-blogdetail">
    <div>

        <!-- section-subnav 标题-->
        <div class="section section-subnav">
            <div class="section_subnav">
                <p class="subnav_title"><a href="https://security.tencent.com/index.php/blog">博客</a><span> / 四两拨千斤 —— Ubuntu kernel eBPF 0day分析</span></p>
            </div>
        </div>

        <div class="section section-article">
            <div class="section_article">
                <div class="article_header">
                    <div class="header_title">
                        <h1 class="title_content">四两拨千斤 —— Ubuntu kernel eBPF 0day分析</h1>
                        <p class="title_info">作者：<span class="info_author">[ Tencent Blade Team ] Cradmin</span>公布时间：<span class="info_date">2018-04-08</span>阅读次数：<span class="info_times">108592</span>评论：<span class="info_commments">6</span></p>
                    </div>

                    <div class="mod-share-dropdown">
                        <div class="mod-btn mod-btn-shop-black"><i class="i-share"></i>分享</div>
                        <div class="share_dropdownpanel">
                            <div>
                                <div class="dropdownpanel_links">
                                    <ul class="links_list">
                                        <li class="list_item list_item-weixin mod-qrcode">
                                            <a href="javascript:void(0)"><i class="i-weixin"></i></a>
                                            <div class="qrcode">
                                                <div class="qrcode_pic">
                                                    <img src="./2018 - Ubuntu kernel eBPF 0day analysis_files/blogmsg-124.png" alt="">
                                                </div>
                                                <span class="qrcode_text">扫一扫分享到微信朋友圈</span>
                                            </div>
                                        </li>
                                        <li class="list_item">
                                            <a href="javascript:void(0)" onclick="shareto(&#39;sinawb&#39;)"><i class="i-weibo-sina"></i></a>
                                        </li>
                                        <li class="list_item">
                                            <a href="javascript:void(0)" onclick="shareto(&#39;qqwb&#39;)"><i class="i-weibo-tencent"></i></a>
                                        </li>
                                    </ul>
                                </div>
                                <div class="dropdownpanel_copyright">版权所有，转载请注明出处!</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="markdown-body editormd-html-preview" style="display:block;"><h2 id="h2-0x01-"><a name="0x01 背景" class="reference-link"></a><span class="header-link octicon octicon-link"></span>0x01 背景</h2><p>中国武术博大精深，其中太极作为不以拙力胜人的功夫备受推崇。同样如果从攻击的角度窥视漏洞领域，也不难看出攻防之间的博弈不乏“太极”的身影，轻巧稳定易利用的漏洞与工具往往更吸引黑客，今天笔者要着墨分析的就是这样一个擅长“四两拨千斤”的0day漏洞。&nbsp;</p><p>0day漏洞的攻击威力想必大家都听说过，内核0day更因为其影响范围广，修复周期长而备受攻击者的青睐。近期，国外安全研究者Vitaly Nikolenko在twitter<font color="#000080">[1]</font>上公布了一个Ubuntu 16.04的内核0day利用代码<font color="#000080">[2]</font>，攻击者可以无门槛的直接利用该代码拿到Ubuntu的最高权限(root)；虽然只影响特定版本，但鉴于Ubuntu在全球拥有大量用户，尤其是公有云用户，所以该漏洞对企业和个人用户还是有不小的风险。&nbsp;</p><p>笔者对该漏洞进行了技术分析，不管从漏洞原因还是利用技术看，都相当有代表性，是Data-Oriented Attacks在linux内核上的一个典型应用。仅利用传入的精心构造的数据即可控制程序流程，达到攻击目的，完全绕过现有的一些内存防护措施，有着“四两拨千斤”的效果 。<br></p>
<h1 id="h1-0x02-"><a name="0x02 漏洞原因" class="reference-link"></a><span class="header-link octicon octicon-link"></span>0x02 漏洞原因</h1><p>这个漏洞存在于Linux内核的eBPF模块，我们先来简单了解下eBPF。</p>
<p>eBPF(extended Berkeley Packet Filter)是内核源自于BPF的一套包过滤机制，严格来说，eBPF的功能已经不仅仅局限于网络包过滤，利用它可以实现kernel tracing，tracfic control，应用性能监控等强大功能。为了实现如此强大的功能，eBPF提供了一套类RISC指令集，并实现了该指令集的虚拟机，使用者通过内核API向eBPF提交指令代码来完成特定的功能。</p>
<p>看到这里，有经验的安全研究者可能会想到，能向内核提交可控的指令代码去执行，很可能会带来安全问题。事实也确实如此，历史上BPF存在大量漏洞<font color="#000080">[3]</font>。关于eBPF的更多细节，可以参考这里<font color="#000080">[4][5]</font>。</p>
<p>eBPF在设计时当然也考虑了安全问题，它在内核中实现了一套verifier机制，过滤不合规的eBPF代码。然而这次的漏洞就出在eBPF的verifier机制。</p>
<p>从最初Vitaly Nikolenko公布的补丁截图，我们初步判断该漏洞很有可能和CVE-2017-16995是同一个漏洞洞<font color="#000080">[6]</font>，但随后有2个疑问：</p><p><b><font color="#000080">1.CVE-2017-16995在去年12月份，内核4.9和4.14及后续版本已经修复，为何Ubuntu使用的4.4版本没有修复？</font></b></p><p><b><font color="#000080">2.CVE-2017-16995是Google Project Zero团队的Jann Horn发现的eBPF漏洞，存在于内核4.9和4.14版本[7]，作者在漏洞报告中对漏洞原因只有简短的描述，跟本次的漏洞是否完全相同？</font></b></p>
<p><font color="#808080">注：笔者所有的代码分析及调试均基于Ubuntu 14.04，内核版本为4.4.0-31-generic #50~14.04.1-Ubuntu</font><font color="#000080" style="">[8]</font>。</p>
<p>先来回答第二个问题，中间的调试分析过程在此不表。</p>
<p>参考以下代码，eBPF的verifer代码(kernel/bpf/verifier.c)中会对ALU指令进行检查(check_alu_op)，该段代码最后一个else分支检查的指令是：</p><p><i><font color="#000080">1.BPF_ALU64|BPF_MOV|BPF_K，把64位立即数赋值给目的寄存器；</font></i></p><p><i><font color="#000080">2.BPF_ALU|BPF_MOV|BPF_K，把32位立即数赋值给目的寄存器；</font></i></p><p>但这里并没有对2条指令进行区分，直接把用户指令中的立即数insn-&gt;imm赋值给了目的寄存器，insn-&gt;imm和目的寄存器的类型是integer，这个操作会有什么影响呢？</p><p><img src="./2018 - Ubuntu kernel eBPF 0day analysis_files/2f4eed9dd2a16d1d9d34187ac75c110d.png" alt="" wangeditor_img_max_width_mark="1" style="max-width: 100%;"></p>
<p>我们再来看下，eBPF运行时代码(kernel/bpf/core.c)，对这2条指令的解释是怎样的(__bpf_prog_run)。<br>参考以下代码，上面2条ALU指令分别对应ALU_MOV_K和ALU64_MOV_K，可以看出verifier和eBPF运行时代码对于2条指令的语义解释并不一样，DST是64bit寄存器，因此ALU_MOV_K得到的是一个32bit unsigned integer，而ALU64_MOV_K会对imm进行sign extension，得到一个signed 64bit integer。<br><img src="./2018 - Ubuntu kernel eBPF 0day analysis_files/d6aad8666c62681c8aee92b8e0fae455.png" alt="" wangeditor_img_max_width_mark="1" style="max-width: 100%;">
</p><p>至此，我们大概知道漏洞的原因，这个逻辑与CVE-2017-16995基本一致，虽然代码细节上有些不同(内核4.9和4.14对verifier进行了较大调整)。但这里的语义不一致又会造成什么影响？</p>
<p>我们再来看下vefier中以下代码(check_cond_jmp_op)，这段代码是对BPF_JMP|BPF_JNE|BPF_IMM指令进行检查，这条指令的语义是：如果目的寄存器立即数==指令的立即数(insn-&gt;imm)，程序继续执行，否则执行pc+off处的指令；注意判断立即数相等的条件，因为前面ALU指令对32bit和64bit integer不加区分，不论imm是否有符号，在这里都是相等的。<br><img src="./2018 - Ubuntu kernel eBPF 0day analysis_files/a741fa97cc7dcd14b3586c98fc76fd28.png" alt="" wangeditor_img_max_width_mark="1" style="max-width: 100%;">
</p><p>再看下eBPF运行时对BPF_JMP|BPF_JNE|BPF_IMM指令的解释(__bpf_prog_run)，显然当imm为有符合和无符号时，因为sign extension，DST!=IMM结果是不一样的。<br><img src="./2018 - Ubuntu kernel eBPF 0day analysis_files/c80fc680e4c6fca3748c022f7346e551.png" alt="" wangeditor_img_max_width_mark="1" style="max-width: 100%;"><br>注意这是条跳转指令，这里的语义不一致后果就比较直观了，相当于我们可以通过ALU指令的立即数，控制跳转指令的逻辑。这个想象空间就比较大了，也是后面漏洞利用的基础，比如可以控制eBPF程序完全绕过verifier机制的检查，直接在运行时执行恶意代码。
</p><p>值得一提的是，虽然这个漏洞的原因和CVE-2017-16995基本一样，但但控制跳转指令的思路和CVE-2017-16995中Jann Horn给的POC思路并不一样。感兴趣的读者可以分析下，CVE-2017-16995中POC，因为ALU sign extension的缺陷，导致eBPF中对指针的操作会计算不正确，从而绕过verifier的指针检查，最终读写任意kernel内存。但这种利用方法，在4.4的内核中是行不通的，因为4.4内核的eBPF不允许对指针类型进行ALU运算。</p>
<p>到这里，我们回过头来看下第一个问题，既然漏洞原因一致，为什么Ubuntu 4.4的内核没有修复该漏洞呢？<br><b>和Linux kernel的开发模式有关。
</b></p><p>Linux kernel分mainline，stable，longterm 3种版本<font color="#000080">[9]</font>，一般安全问题都会在mainline中修复，但对于longterm，仅会选择重要的安全补丁进行backport，因此可能会出现，对某个漏洞不重视或判断有误，导致该漏洞仍然存在于longterm版本中，比如本次的4.4 longterm，最初Jann Horn并没有在报告中提到影响4.9以下的版本。</p>
<p>关于Linux kernel对longterm版本的维护，争论由来已久<font color="#000080">[10]</font>，社区主流意见是建议用户使用最新版本。但各个发行版(比如Ubuntu)出于稳定性及开发成本考虑，一般选择longterm版本作为base，自行维护一套kernel。</p>
<p>对于嵌入式系统，这个问题更严重，大量厂商代码导致内核升级的风险及成本都远高于backport安全补丁，因此大部分嵌入式系统至今也都在使用比较老的longterm版本。比如Google Android在去年Pixel /Pixel XL 2发布时，内核版本才从3.18升级到4.4，原因也许是3.18已经进入EOL了(End of Life)，也就是社区要宣布3.18进入死亡期了，后续不会在backport安全补丁到3.18，而最新的mainline版本已经到了4.16。笔者去年也在Android kernel中发现了一个未修复的历史漏洞(已报告给google并修复)，但upstream在2年前就修复了。</p>
<p>而Vitaly Nikolenko可能是基于CVE-2017-16995的报告，在4.4版本中发现存在类似漏洞，并找到了一个种更通用的利用方法(控制跳转指令)。</p>
<h1 id="h1-0x03-"><a name="0x03 漏洞利用" class="reference-link"></a><span class="header-link octicon octicon-link"></span>0x03 漏洞利用</h1><p>根据上一节对漏洞原因的分析，我们利用漏洞绕过eBPF verifier机制后，就可以执行任意eBPF支持的指令，当然最直接的就是读写任意内存。漏洞利用步骤如下：</p><p><i><font color="#000080">1.构造eBPF指令，利用ALU指令缺陷，绕过eBPF verifier机制；</font></i></p><p><i><font color="#000080">2.构造eBPF指令，读取内核栈基址；</font></i></p><p><i><font color="#000080">3.根据泄漏的SP地址，继续构造eBPF指令，读取task_struct地址，进而得到task_struct-&gt;cred地址；</font></i></p><p><i><font color="#000080">4.构造eBPF指令，覆写cred-&gt;uid, cred-&gt;gid为0，完成提权。</font></i></p>
<p>漏洞利用的核心，在于精心构造的恶意eBPF指令，这段指令在Vitaly Nikolenko的exp中是16机制字符串(char *__prog)，并不直观，笔者为了方便，写了个小工具，把这些指令还原成比较友好的形式，当然也可以利用eBPF的调试机制，在内核log中打印出eBPF指令的可读形式。</p>
<p>我们来看下这段eBPF程序，共41条指令(笔者写的小工具的输出)：</p>
<p><font color="#808080">parsing eBPF prog, size 328, len 41<br>ins    0: code(b4)                alu | = | imm, dst_reg 9, src_reg 0, off 0, imm ffffffff<br>ins    1: code(55)               jmp | != | imm, dst_reg 9, src_reg 0, off 2, imm ffffffff<br>ins    2: code(b7)              alu64 | = | imm, dst_reg 0, src_reg 0, off 0, imm 0<br>ins    3: code(95)             jmp | exit | imm, dst_reg 0, src_reg 0, off 0, imm 0<br>ins    4: code(18)           ld | BPF_IMM | u64, dst_reg 9, src_reg 1, off 0, imm 3<br>ins    5: code(00)           ld | BPF_IMM | u32, dst_reg 0, src_reg 0, off 0, imm 0<br>ins    6: code(bf)          alu64 | = | src_reg, dst_reg 1, src_reg 9, off 0, imm 0<br>ins    7: code(bf)          alu64 | = | src_reg, dst_reg 2, src_reg a, off 0, imm 0<br>ins    8: code(07)             alu64 | += | imm, dst_reg 2, src_reg 0, off 0, imm fffffffc<br>ins    9: code(62)           st | BPF_MEM | u32, dst_reg a, src_reg 0, off fffffffc, imm 0<br>ins   10: code(85)             jmp | call | imm, dst_reg 0, src_reg 0, off 0, imm 1<br>ins   11: code(55)               jmp | != | imm, dst_reg 0, src_reg 0, off 1, imm 0<br>ins   12: code(95)             jmp | exit | imm, dst_reg 0, src_reg 0, off 0, imm 0<br>ins   13: code(79)          ldx | BPF_MEM | u64, dst_reg 6, src_reg 0, off 0, imm 0<br>ins   14: code(bf)          alu64 | = | src_reg, dst_reg 1, src_reg 9, off 0, imm 0<br>ins   15: code(bf)          alu64 | = | src_reg, dst_reg 2, src_reg a, off 0, imm 0<br>ins   16: code(07)             alu64 | += | imm, dst_reg 2, src_reg 0, off 0, imm fffffffc<br>ins   17: code(62)           st | BPF_MEM | u32, dst_reg a, src_reg 0, off fffffffc, imm 1<br>ins   18: code(85)             jmp | call | imm, dst_reg 0, src_reg 0, off 0, imm 1<br>ins   19: code(55)               jmp | != | imm, dst_reg 0, src_reg 0, off 1, imm 0<br>ins   20: code(95)             jmp | exit | imm, dst_reg 0, src_reg 0, off 0, imm 0<br>ins   21: code(79)          ldx | BPF_MEM | u64, dst_reg 7, src_reg 0, off 0, imm 0<br>ins   22: code(bf)          alu64 | = | src_reg, dst_reg 1, src_reg 9, off 0, imm 0<br>ins   23: code(bf)          alu64 | = | src_reg, dst_reg 2, src_reg a, off 0, imm 0<br>ins   24: code(07)             alu64 | += | imm, dst_reg 2, src_reg 0, off 0, imm fffffffc<br>ins   25: code(62)           st | BPF_MEM | u32, dst_reg a, src_reg 0, off fffffffc, imm 2<br>ins   26: code(85)             jmp | call | imm, dst_reg 0, src_reg 0, off 0, imm 1<br>ins   27: code(55)               jmp | != | imm, dst_reg 0, src_reg 0, off 1, imm 0<br>ins   28: code(95)             jmp | exit | imm, dst_reg 0, src_reg 0, off 0, imm 0<br>ins   29: code(79)          ldx | BPF_MEM | u64, dst_reg 8, src_reg 0, off 0, imm 0<br>ins   30: code(bf)          alu64 | = | src_reg, dst_reg 2, src_reg 0, off 0, imm 0<br>ins   31: code(b7)              alu64 | = | imm, dst_reg 0, src_reg 0, off 0, imm 0<br>ins   32: code(55)               jmp | != | imm, dst_reg 6, src_reg 0, off 3, imm 0<br>ins   33: code(79)          ldx | BPF_MEM | u64, dst_reg 3, src_reg 7, off 0, imm 0<br>ins   34: code(7b)          stx | BPF_MEM | u64, dst_reg 2, src_reg 3, off 0, imm 0<br>ins   35: code(95)             jmp | exit | imm, dst_reg 0, src_reg 0, off 0, imm 0<br>ins   36: code(55)               jmp | != | imm, dst_reg 6, src_reg 0, off 2, imm 1<br>ins   37: code(7b)          stx | BPF_MEM | u64, dst_reg 2, src_reg a, off 0, imm 0<br>ins   38: code(95)             jmp | exit | imm, dst_reg 0, src_reg 0, off 0, imm 0<br>ins   39: code(7b)          stx | BPF_MEM | u64, dst_reg 7, src_reg 8, off 0, imm 0<br>ins   40: code(95)             jmp | exit | imm, dst_reg 0, src_reg 0, off 0, imm 0<br>parsed 41 ins, total 41
</font></p><p>稍微解释下，ins 0 和 ins 1 一起完成了绕过eBPF verifier机制。ins 0指令后，regs[9] = 0xffffffff，但在verifier中，regs[9].imm = -1，当执行ins 1时，jmp指令判断regs[9] == 0xffffffff，注意regs[9]是64bit integer，因为sign extension，regs[9] == 0xffffffff结果为false，eBPF跳过2(off)条指令，继续往下执行；而在verifier中，jmp指令的regs[9].imm == insn-&gt;imm结果为true，程序走另一个分支，会执行ins 3 jmp|exit指令，导致verifier认为程序已结束，不会去检查其余的dead code。</p>
<p>这样因为eBPF的检测逻辑和运行时逻辑不一致，我们就绕过了verifier。后续的指令就是配合用户态exp完成对kernel内存的读写。</p>
<p>这里还需要知道下eBPF的map机制，eBPF为了用户态更高效的与内核态交互，设计了一套map机制，用户态程序和eBPF程序都可以对map区域的内存进行读写，交换数据。利用代码中，就是利用map机制，完成用户态程序与eBPF程序的交互。</p>
<p>ins4-ins5: regs[9] = struct bpf_map *map，得到用户态程序申请的map的地址，注意这2条指令，笔者的静态解析并不准确，获取map指针的指令，在eBPF verifier中，会对指令内容进行修改，替换map指针的值。</p>
<p><font color="#808080">ins6-ins12: 调用bpf_map_lookup_elem(map, &amp;key)，返回值为regs[0] = &amp;map-&gt;value[0]</font></p>
<p><font color="#808080">ins13: regs[6] = *regs[0]， regs[6]得到map中key=0的value值</font></p>
<p><font color="#808080">ins14-ins20: 继续调用bpf_map_lookup_elem(map, &amp;key)，regs[0] = &amp;map-&gt;value[1]</font></p>
<p><font color="#808080">ins21: regs[7] = *regs[0]，regs[7]得到map中key=1的value值</font></p>
<p><font color="#808080">ins22-ins28: 继续调用bpf_map_lookup_elem(map, &amp;key)，regs[0] = &amp;map-&gt;value[2]</font></p>
<p><font color="#808080">ins29: regs[8] = *regs[0]，regs[8]得到map中key=2的value值</font></p>
<p><font color="#808080">ins30: regs[2] = regs[0]</font></p>
<p><font color="#808080">ins32: if(regs[6] != 0) jmp ins32 + 3，根据用户态传入的key值不同，做不同的操作</font></p>
<p><font color="#808080">ins33: regs[3] = *regs[7]，读取regs[7]中地址的内容，用户态的read原语，就在这里完成，regs[7]中的地址为用户态传入的任意内核地址</font></p>
<p><font color="#808080">ins34: *regs[2] = regs[3]，把上调指令读取的值返回给用户态</font></p>
<p><font color="#808080">ins36: if(regs[6] != 1) jmp ins36 + 2</font></p>
<p><font color="#808080">ins37: *regs[2] = regs[FP], 读取eBPF的运行时栈指针，返回给用户态，注意这个eBPF的栈指针实际上指向bpf_prog_run函数中的一个局部uint64数组，在内核栈上，从这个值可以得到内核栈的基址，这段指令对应用户态的get_fp</font></p>
<p><font color="#808080">ins39: *regs[7] = regs[8]，向regs[7]中的地址写入regs[8]，对应用户态的write原语，regs[7]中的地址为用户态传入的任意内核地址</font></p>
<p>理解了这段eBPF程序，再看用户态exp就很容易理解了。需要注意的是，eBPF指令中的3个关键点：泄漏FP，读任意kernel地址，写任意kernel地址，在verifier中都是有检查的，但因为开始的2条指令完全绕过了verifier，导致后续的指令长驱直入。</p>
<p>笔者在Ubuntu 14.04上提权成功：<br><img src="./2018 - Ubuntu kernel eBPF 0day analysis_files/df9c8fe2095cce7c81e63400edbeb1ff.png" alt="" wangeditor_img_max_width_mark="1" style="max-width: 100%;">
</p><p>这种攻击方式和传统的内存破坏型漏洞不同，不需要做复杂的内存布局，只需要修改用户态传入的数据，就可以达到控制程序指令流的目的，利用的是原有程序的正常功能，会完全绕过现有的各种内存防御机制(SMEP/SMAP等)，有一种四两拨千斤的效果。这也是这两年流行的Data-Oriented Attacks，在linux kernel中似乎并不多见。</p>
<h1 id="h1-0x04-amp-"><a name="0x04 漏洞影响范围&amp;修复" class="reference-link"></a><span class="header-link octicon octicon-link"></span>0x04 漏洞影响范围&amp;修复</h1><p>因为linux kernel的内核版本众多，对于安全漏洞的影响范围往往并不容易确认，最准确的方式是搞清楚漏洞根因后，从代码层面判断，但这也带来了高成本的问题，快速应急时，我们往往需要尽快确认漏洞影响范围。</p>
<p>从前面的漏洞原理来看，笔者大致给一个全面的linux kernel受影响版本：</p>
<p><b><i><font color="#000080">3.18-4.4所有版本(包括longterm 3.18，4.1，4.4)；</font></i></b></p>
<p><b><i><font color="#000080">&lt;3.18，因内核eBPF还未引入verifier机制，不受影响。</font></i></b></p>
<p>对于大量用户使用的各个发行版，还需要具体确认，因为该漏洞的触发，还需要2个条件</p><p><i><font color="#000080">1.Kernel编译选项CONFIG_BPF_SYSCALL打开，启用了bpf syscall；</font></i></p><p><i><font color="#000080">2./proc/sys/kernel/unprivileged_bpf_disabled设置为0，允许非特权用户调用bpf syscall</font></i></p>
<p><b>而Ubuntu正好满足以上3个条件。</b></p>
<p>关于修复，upstream kernel在3月22日发布的4.4.123版已经修复该漏洞<font color="#000080">[11][12]</font>， Ubuntu官方4月5日也正式发布了安全公告和修复版本<font color="#000080">[13][14]</font>，没有修复的同学可以尽快升级了。</p>
<p>但现在距漏洞Exp公开已经过去20多天了，在漏洞应急时，我们显然等不了这么久，回过头看看当初的临时修复方案：</p><p><font color="#000080">1.设置/proc/sys/kernel/unprivileged_bpf_disabled为1，也是最简单有效的方式，虽然漏洞仍然存在，但会让exp失效；</font></p><p><font color="#000080">2.使用Ubuntu的预发布源，更新Ubuntu 4.4的内核版本，因为是非正式版，其稳定性无法确认。</font></p><p>Vitaly Nikolenko在twitter上公布的Ubuntu预发布源：all 4.4 ubuntu aws instances are vulnerable: echo “deb <a href="http://archive.ubuntu.com/ubuntu/" style="">http://archive.ubuntu.com/ubuntu/</a>xenial-proposed restricted main multiverse universe” &gt; /etc/apt/sources.list &amp;&amp; apt update &amp;&amp; apt install linux-image-4.4.0-117-generic</p>
<p>Ubuntu的非正式内核版本，做了哪些修复，我们可以看下补丁的关键内容(注意这是Ubuntu的kernel版本，非upstream)：</p>
<p>git diff Ubuntu-lts-4.4.0-116.140_14.04.1 Ubuntu-lts-4.4.0-117.141_14.04.1</p>
<p>ALU指令区分了32bit和64bit立即数，同时regs[].imm改为了64bit integer<br><img src="./2018 - Ubuntu kernel eBPF 0day analysis_files/62f4a3ce35ba5c90064b686ef832d0de.png" alt="" wangeditor_img_max_width_mark="1" style="max-width: 100%;">
</p><p>还增加了一项有意思的检查，把所有的dead_code替换为nop指令，这个明显是针对exp来的，有点类似于exp的mitigation，upstream kernel可能并不一定喜欢这样的修复风格：）<br><img src="./2018 - Ubuntu kernel eBPF 0day analysis_files/ff0215562404cc9a9f5e08ec1428a9f9.png" alt="" wangeditor_img_max_width_mark="1" style="max-width: 100%;">
</p><p>关于这个漏洞，Ubuntu还有一些相关的修复代码，感兴趣的读者，可以自行发掘。</p>
<p>我们再看下upstream kernel 4.4.123的修复，相比之下，要简洁的多，仅有3行代码改动<font color="#000080">[12]</font>：<br>当处理32bit ALU指令时，如果imm为负数，直接忽略，认为是UNKNOWN_VALUE，这样也就避免了前面提到的verifer和运行时语义不一致的问题。<br><img src="./2018 - Ubuntu kernel eBPF 0day analysis_files/49a831925ff49bbfb88ea9c6004e198d.png" alt="" wangeditor_img_max_width_mark="1" style="max-width: 100%;">
</p><p>另外Android kernel上，bpf sycall是没有启用的，所以不受该漏洞影响。</p>
<h1 id="h1-0x05-"><a name="0x05 引发的思考" class="reference-link"></a><span class="header-link octicon octicon-link"></span>0x05 引发的思考</h1><p>我们回顾以下整个漏洞分析过程，有几点值得注意和思考：</p><p>1.eBPF作为内核提供的一种强大机制，因为其复杂的过滤机制，稍有不慎，将会引入致命的安全问题，笔者推测后续eBPF可能还会有类似安全漏洞。</p><p>2.受限于linux kernel的开发模式及众多版本，安全漏洞的确认和修复可能存在被忽视的情况，出现N day变0 day的场景。</p><p>3.Vitaly Nikolenko公布漏洞exp后，有网友就提出了批评，在厂商发布正式补丁前，不应该公布细节。我们暂且不讨论Vitaly Nikolenko的动机，作为一名安全从业者，负责任的披露漏洞是基本守则。</p><p>4.笔者所在公司使用的OS是经过专门的团队量身定制，进行了不少的安全加固和冗余组件裁剪，故不受到此次漏洞影响。可见维护一个安全可靠的OS不失为保障大型企业的安全方案之一。</p>
<p>感谢阅读，行文匆忙，如有不正之处，敬请指出。</p>
<h1 id="h1-0x06-"><a name="0x06 参考文档" class="reference-link"></a><span class="header-link octicon octicon-link"></span>0x06 参考文档</h1><p>[1] <a href="https://twitter.com/vnik5287/status/974439706896187392">https://twitter.com/vnik5287/status/974439706896187392</a><br>[2] <a href="http://cyseclabs.com/exploits/upstream44.c">http://cyseclabs.com/exploits/upstream44.c</a><br>[3] <a href="https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=BPF">https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=BPF</a><br>[4] <a href="https://www.ibm.com/developerworks/cn/linux/l-lo-eBPF-history/index.html">https://www.ibm.com/developerworks/cn/linux/l-lo-eBPF-history/index.html</a><br>[5] <a href="https://www.kernel.org/doc/Documentation/networking/filter.txt">https://www.kernel.org/doc/Documentation/networking/filter.txt</a><br>[6] <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-16995">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-16995</a><br>[7] <a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1454&amp;desc=3">https://bugs.chromium.org/p/project-zero/issues/detail?id=1454&amp;desc=3</a><br>[8] <a href="http://kernel.ubuntu.com/git/ubuntu/ubuntu-trusty.git/tree/?h=Ubuntu-lts-4.4.0-31.50_14.04.1">http://kernel.ubuntu.com/git/ubuntu/ubuntu-trusty.git/tree/?h=Ubuntu-lts-4.4.0-31.50_14.04.1</a><br>[9] <a href="https://www.kernel.org/">https://www.kernel.org/</a><br>[10] <a href="https://lwn.net/Articles/700530/">https://lwn.net/Articles/700530/</a><br>[11] <a href="https://lwn.net/Articles/749963/">https://lwn.net/Articles/749963/</a><br>[12] <a href="https://lkml.org/lkml/2018/3/19/1499">https://lkml.org/lkml/2018/3/19/1499</a><br>[13] <a href="https://usn.ubuntu.com/3619-1/">https://usn.ubuntu.com/3619-1/</a><br>[14] <a href="https://usn.ubuntu.com/3619-2/">https://usn.ubuntu.com/3619-2/</a></p></div>                <div class="article_footer">
                    <div class="mod-share-normal">
                        <div class="share_links">
                            <span>分享到</span>
                            <ul class="links_list">
                                <li class="list_item list_item-weixin mod-qrcode">
                                    <a href="javascript:void(0)"><i class="i-weixin"></i></a>
                                    <div class="qrcode">
                                        <div class="qrcode_pic">
                                            <img src="./2018 - Ubuntu kernel eBPF 0day analysis_files/blogmsg-124.png" alt="">
                                        </div>
                                        <span class="qrcode_text">扫一扫分享到微信朋友圈</span>
                                    </div>
                                </li>
                                <li class="list_item">
                                    <a href="javascript:void(0)" onclick="shareto(&#39;sinawb&#39;)"><i class="i-weibo-sina"></i></a>
                                </li>
                                <li class="list_item">
                                    <a href="javascript:void(0)" onclick="shareto(&#39;qqwb&#39;)"><i class="i-weibo-tencent"></i></a>
                                </li>
                            </ul>
                        </div>
                        <div class="share_copyright">版权所有，转载请注明出处!</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section section-comment">
            <div class="mod-form-comment">
                <div class="comment_title">
                    <p>评论留言</p>
                </div>
                <div class="comment_list">
                    <ul id="comment-list">
                        <!-- <li class="list_item">
                            <div class="item_avatar">
                                <a href="user.html"><img src="../dist/images-test/blog/test-blog-user-1.png" alt=""></a>
                            </div>
                            <div class="item_user">
                                <a class="user_name" href="user.html">test</a>
                                <p class="user_comment">不错的内容，感谢分享!</p>
                            </div>
                            <span class="item_time">
                                2015-08-29 20:15:10
                            </span>
                        </li> -->
                    </ul>
                </div>
                <div class="comment_textarea">
                    <textarea name="" id="comment-input" cols="30" rows="10" placeholder="您可以在此输入您的评论内容，点击按钮或按Ctrl+Enter键提交"></textarea>
                </div>
                <div class="comment_submit">
                    <a id="comment-btn" class="mod-btn mod-btn-blue">提交评论</a>
                    <span id="error-tip" class="formtips-error">您输入的漏洞名称有误，请重新输入</span>
                </div>
            </div>
        </div>
    </div>
</div>


<link rel="stylesheet" href="./2018 - Ubuntu kernel eBPF 0day analysis_files/rainbow.css">
<script type="text/javascript" src="./2018 - Ubuntu kernel eBPF 0day analysis_files/highlight.pack.js.下載"></script>
<script type="text/javascript" src="./2018 - Ubuntu kernel eBPF 0day analysis_files/jQuery.autoIMG.min.js.下載"></script>
<script type="text/javascript">

jQuery(document).ready(function($) {

    // 准备传入模块的数据
    var data = {
        blog_id : 124    };
    
    // 页面初始化
    seajs.use('modules/blog', function(m) {
        m.init('detail', data);
    });

});

</script>

        <!-- 确认弹窗 -->
        <div id="base-confirm" class="mod-popup mod-popup-report">
            <div class="popup_mask">
            </div>
            <div class="popup_body">
                <div class="body_content">
                    <p class="content_title"></p>
                    <p class="content_text"></p>
                </div>
                <div class="body_btns">
                    <a class="mod-btn mod-btn-blue" href="javascript:void(0)">确定</a>
                    <a class="mod-btn mod-btn-black" href="javascript:void(0)">取消</a>
                </div>
                <i class="i-close"></i>
            </div>
        </div>

        <!-- 提示弹窗 -->
        <div id="base-alert" class="mod-popup mod-popup-success">
            <div class="popup_mask">
            </div>
            <div class="popup_body">
                <div class="body_content">
                    <p class="content_pic"></p>
                    <p class="content_text">捐款成功，感谢您的无私奉献</p>
                </div>
                <div class="i-close"></div>
            </div>
        </div>

        <!-- 登录弹窗 -->
        <div id="base-login-box" class="mod-popup mod-popup-report">
            <div class="popup_mask">
            </div>
            <div class="popup_body">
                <div class="body_content">
                    <p class="content_title">登录提醒</p>
                    <p class="content_text" style="text-align:center;">
                        系统检测到您还未登录或登录态已失效，请先登录
                    </p>
                    <div class="body_btns">
                        <a href="https://security.tencent.com/index.php/login/in?type=qq&amp;redirect_uri=https%3A%2F%2Fsecurity.tencent.com%2Findex.php%2Fblog%2Fmsg%2F124" class="mod-btn mod-btn-black login-qq" style="border-color:#007cfa;color:#007cfa">QQ 登录</a>
                        <a href="https://security.tencent.com/index.php/login/in?type=wx&amp;redirect_uri=https%3A%2F%2Fsecurity.tencent.com%2Findex.php%2Fblog%2Fmsg%2F124" class="mod-btn mod-btn-black login-wx" style="border-color:#007cfa;color:#007cfa">微信 登录</a>
                    </div>
                </div>
                <i class="i-close"></i>
            </div>
        </div>


        <style type="text/css">
            #base-tip-box .popup_body {
                width: 500px;
                height: 300px;
                margin-left: -250px;
                margin-top: -150px;
            }
            #base-tip-box .content_text {
                text-align:left;
                margin-left:2px;
            }
            #base-tip-box .tip-btn-confirm {
                color: #fff;
            }
            #base-tip-box .tip-btn-close {
                color: #fff;
                background-color: #cce5fe;
                cursor: pointer;
            }
            #base-tip-box .tip-btn-close:hover{
                border-bottom-color: #fff !important;
            }
            #base-tip-box .body_btns {
                margin: 0px auto 0;
            }
        </style>

        <!-- tip弹窗 -->
        <div id="base-tip-box" class="mod-popup mod-popup-report">
            <div class="popup_mask">
            </div>
            <div class="popup_body">
                <div class="body_content">
                    <p class="content_title">TSRC调查问卷</p>
                    <div class="content_text">
                        
                        <div style="font-size:15px;color: #333;">
                            为了更好和大家互动，TSRC诚邀您填写问卷，我们将在提交联系方式的参与者中随机抽取部分幸运儿，赠送精美礼品！
                        </div>

                        <div class="body_btns" style="margin-top:15px;margin-bottom:15px;">
                            <a class="mod-btn mod-btn-blue tip-btn-confirm" target="_blank" href="https://wj.qq.com/s2/5474852/6011/">马上填写</a>
                            <a class="mod-btn mod-btn-disabled-blue tip-btn-close tip-close" href="javascript:void(0)">下次再填</a>
                        </div>

                        <div style="">
                            如您已在其他渠道填写过问卷，请勾选：
                            <input class="input-checkbox" type="checkbox">
                            忽略，不再弹出
                        </div>

                        <div style="margin-top:25px;float:right;">
                            如有疑问，请点击咨询：<a href="https://security.tencent.com/#">QQ</a>
                        </div>
                        
                    </div>
                </div>
                <i class="i-close tip-close"></i>
            </div>
        </div>


        <!-- footer -->
        <div class="footer">
            <div>
                <div class="footer_about">
                    <p class="about_link">
                        <a href="http://www.tencent.com/" target="_blank">关于腾讯</a>
                        |
                        <a href="http://www.tencent.com/index_e.shtml" target="_blank">About Tencent</a>
                        |
                        <a href="http://www.qq.com/contract.shtml" target="_blank">服务条款</a>
                        |
                        <a href="https://security.tencent.com/index.php/about#joinus">加入我们</a>
                        |
                        <a href="https://security.tencent.com/index.php/report/add">报告漏洞</a>
                        |
                        <a href="https://security.tencent.com/index.php/about#friends">合作伙伴</a>
                        |
                        <a href="http://service.qq.com/" target="_blank">腾讯客服</a>
                    </p>
                    <p class="about_copyright">
                        <span>Copyright © 1998 - 2021 Tencent. All Rights Reserved</span>
                        <span>腾讯公司版权所有</span>
                    </p>
                </div>

                <div class="footer_contact">
                    <a class="contact_icon-email" href="mailto:security@tencent.com"><i></i><span>专用邮箱</span>|</a>
                    <a class="contact_icon-weibo-sina" href="http://weibo.com/u/1363173330" target="_blank"><i></i><span>新浪微博</span>|</a>
                    <!-- <a class="contact_weibo-tencent" href="javascript:void(0)" target="_blank"><i></i><span>腾讯微博</span>|</a> -->
                    <a class="contact_icon-weixin mod-qrcode" href="javascript:void(0)">
                        <i></i><span>微信公众号</span>
                        <div class="qrcode">
                            <div class="qrcode_pic">
                                <img src="./2018 - Ubuntu kernel eBPF 0day analysis_files/tsrc-qrcode.jpg" alt="">
                            </div>
                            <span class="qrcode_text">扫一扫关注 TSRC 公众号</span>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    

    <!-- csrc_token -->
    <div id="csrf_div">
                <form action="https://security.tencent.com/index.php/blog/msg/124" method="post" accept-charset="utf-8" class="form_horizontal"><div style="display:none">
<input type="hidden" name="csrf_token" value="504be6bff5fbc4d0a3dc58789b0c8a38">
</div>        </form>    </div>

    <!-- sea -->
    <script type="text/javascript" src="./2018 - Ubuntu kernel eBPF 0day analysis_files/sea.js.下載"></script>
    <script type="text/javascript" src="./2018 - Ubuntu kernel eBPF 0day analysis_files/config.js.下載"></script>
    
    <!-- stat -->
    <script type="text/javascript">
        $(function() {
            $.getScript("https://pingjs.qq.com/tcss.fixedcgi.https.js", function() {
                var pgvInterv = window.setInterval(function() {
                    window.clearInterval(pgvInterv);
                    if (typeof(pgvMain) == 'function') {
                        pgvMain();
                    }
                });
            });
        });
    </script>

    <!-- common -->
    <script type="text/javascript">
        jQuery(document).ready(function($) {
            seajs.use('modules/common', function(m) {
                m.init();
            });
        });
    </script>



</body></html>