<!DOCTYPE html>
<!-- saved from url=(0086)https://web.archive.org/web/20190709110421/http://c0reteam.org/2015/11/18/cve-20150568 -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script src="./2015 - CVE-2015-0568 Use-After-Free Vulnerability in the Camera Driver of Qualcomm MSM 7x30_files/analytics.js.下載" type="text/javascript"></script>
<script type="text/javascript">window.addEventListener('DOMContentLoaded',function(){var v=archive_analytics.values;v.service='wb';v.server_name='wwwb-app202.us.archive.org';v.server_ms=478;archive_analytics.send_pageview({});});</script>
<script type="text/javascript" src="./2015 - CVE-2015-0568 Use-After-Free Vulnerability in the Camera Driver of Qualcomm MSM 7x30_files/bundle-playback.js.下載" charset="utf-8"></script>
<script type="text/javascript" src="./2015 - CVE-2015-0568 Use-After-Free Vulnerability in the Camera Driver of Qualcomm MSM 7x30_files/wombat.js.下載" charset="utf-8"></script>
<script type="text/javascript">
  __wm.init("https://web.archive.org/web");
  __wm.wombat("http://c0reteam.org/2015/11/18/cve-20150568","20190709110421","https://web.archive.org/","web","/_static/",
	      "1562670261");
</script>
<link rel="stylesheet" type="text/css" href="./2015 - CVE-2015-0568 Use-After-Free Vulnerability in the Camera Driver of Qualcomm MSM 7x30_files/banner-styles.css">
<link rel="stylesheet" type="text/css" href="./2015 - CVE-2015-0568 Use-After-Free Vulnerability in the Camera Driver of Qualcomm MSM 7x30_files/iconochive.css">
<!-- End Wayback Rewrite JS Include -->

    
    
    <meta name="author" content="c0reTeam c0reTeam">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="./2015 - CVE-2015-0568 Use-After-Free Vulnerability in the Camera Driver of Qualcomm MSM 7x30_files/bootstrap.css" rel="stylesheet">
    <link href="./2015 - CVE-2015-0568 Use-After-Free Vulnerability in the Camera Driver of Qualcomm MSM 7x30_files/style.css" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  <title>C0RE Team - CVE-2015-0568: Use-After-Free Vulnerability in the Camera Driver of Qualcomm MSM 7x30</title></head>

  <body><!-- BEGIN WAYBACK TOOLBAR INSERT -->
<style type="text/css">
body {
  margin-top:0 !important;
  padding-top:0 !important;
  /*min-width:800px !important;*/
}
</style>
<script>__wm.rw(0);</script>
<div id="wm-ipp-base" lang="en" style="display: block; direction: ltr;">
</div><div id="wm-ipp-print">The Wayback Machine - https://web.archive.org/web/20190709110421/http://c0reteam.org/2015/11/18/cve-20150568</div>
<div id="donato" style="position: relative; width: 100%; height: 265px;">
  <div id="donato-base" style="height: 265px;">
    <iframe id="donato-if" src="./2015 - CVE-2015-0568 Use-After-Free Vulnerability in the Camera Driver of Qualcomm MSM 7x30_files/donate.html" scrolling="no" frameborder="0" style="width:100%; height:100%">
    </iframe>
  </div>
</div><script type="text/javascript">
__wm.bt(650,27,25,2,"web","http://c0reteam.org/2015/11/18/cve-20150568","20190709110421",1996,"/_static/",["/_static/css/banner-styles.css?v=omkqRugM","/_static/css/iconochive.css?v=qtvMKcIJ"], false);
  __wm.rw(1);
</script>
<!-- END WAYBACK TOOLBAR INSERT -->
    <div id="wx_logo" style="margin:0 auto;display:none;">
      <img src="./2015 - CVE-2015-0568 Use-After-Free Vulnerability in the Camera Driver of Qualcomm MSM 7x30_files/logo300.jpg">
    </div>
    <div class="topbar">
      <div class="fill_logo">
        <div class="container"> 
		  <a href="https://web.archive.org/web/20190709110421/http://c0reteam.org/"><img src="./2015 - CVE-2015-0568 Use-After-Free Vulnerability in the Camera Driver of Qualcomm MSM 7x30_files/logo.png"></a>
		</div>
      </div>

      <div class="fill">
        <div class="container"> 

		  	<ul class="nav pull-right">
		  	
		  	
		  	
		  	 

		   
			<li> 
				<a href="https://web.archive.org/web/20190709110421/http://c0reteam.org/blog.html">
					<div style="font-size:16pt;text-align:center">Blog</div>
				</a></li>
    		<li> 
				<a href="https://web.archive.org/web/20190709110421/http://c0reteam.org/research.html">
					<div style="font-size:16pt;text-align:center">Research</div>
				</a></li>
    		<li>
				<a href="https://web.archive.org/web/20190709110421/http://c0reteam.org/advisories.html">
					<div style="font-size:16pt;text-align:center">Advisories</div>
				</a></li>
   			<li>
				<a href="https://web.archive.org/web/20190709110421/http://c0reteam.org/about.html">
					<div style="font-size:16pt;text-align:center">About</div>
				</a></li>

          </ul>
  

        </div>
      </div>
    </div>
    
    
    

    <div class="container">

      <div class="content">
        

<div class="page-header">

	
	<h3>CVE-2015-0568: Use-After-Free Vulnerability in the Camera Driver of Qualcomm MSM 7x30  </h3>

  
</div>

<div class="row">
  <div class="span10">


    

<h4 id="vulnerability-description">Vulnerability Description</h4>

<p>We came across a use-after-free (UAF) vulnerability in the camera driver of 
Qualcomm MSM 7x30 SoCs.
The vulnerable camera driver provides a standard <em>ioctl</em> interface for user 
space programs to communicate.
However, when processing the <em>ioctl</em> communication, the handler function might 
be triggered to reference a previously freed memory block, leading to a 
typical <em>use-after-free</em> scenario and making it possible for arbitrary code 
execution at the kernel level.</p>

<p>Specifically, the <em>ioctl</em> handler function, <em>msm_set_crop()</em>, located at 
drivers/media/video/msm/msm_camera.c uses <em>copy_from_user()</em> to collect the 
<em>crop</em> data structure provided by the user-level program 
(see Figure 1: line 1532).</p>

<div align="center">
	<br>
	<img src="./2015 - CVE-2015-0568 Use-After-Free Vulnerability in the Camera Driver of Qualcomm MSM 7x30_files/msm_set_crop_figure1.png">
	<div style="text-align:center">Figure 1: msm_set_crop()</div>
	<br>
</div>

<p>When the global variable <em>sync-&gt;croplen</em> is 0, <em>crop.len</em> sized memory block 
is <em>kmalloc()</em>ed.
The global pointer <em>sync-&gt;cropinfo</em> is used for bookkeeping the newly 
allocated buffer (see Figure 1: line 1540).
After preparing the memory buffer, another <em>copy_from_user()</em> is invoked to 
copy <em>crop.len</em> bytes of user-provided data into kernel space 
(see Figure 1: line 1546).
If this operation fails, the memory buffer is <em>kfree()</em> 
(see Figure 1: line 1550).
Otherwise, <em>sync-&gt;croplen</em> is set to get rid of the second <em>kmalloc()</em> call in 
line 1540.
Also, the <em>sync-&gt;croplen</em> can be used to prevent buffer overflow when 
<em>crop.len</em> is larger than the size of the memory buffer 
(see Figure 1: line 1543).</p>

<p>Everything looks fine so far.
The memory block is properly allocated, filled in with user-provided data, and 
released when something goes wrong in the data transfer operation.
However, one thing is missed here.
The bookkeeping variable <em>sync-&gt;croplen</em> is not reset when <em>sync-&gt;cropinfo</em> is 
<em>kfree()</em>ed (see Figure 1:line 1550) such that the next entry of 
<em>msm_set_crop()</em> could copy arbitrary content into the already released memory 
buffer.
If a victim user allocates a buffer between the <em>kfree()</em> call and the second 
entry of <em>msm_set_crop()</em>, she could use an unreliable memory buffer which is 
manipulated by the caller of <em>msm_set_crop()</em>.</p>

<h4 id="exploiting-the-vulnerability">Exploiting the Vulnerability</h4>

<p>It is possible to execute the shellcode at the kernel level by exploiting this 
vulnerability.
Here’s how it works.
First, you need to choose a good victim slab which contains a function pointer.
Besides, the <em>kmalloc()</em> path of that slab should be reachable from user space 
and the function pointer should be easily invoked from user space.
For example, the <em>open()</em> handler of certain sysfs entry allocates a slab 
containing a pointer that points to a function table while the function 
pointers stored in the table can be invoked by reading the sysfs entry. 
This makes it a good target to attack.</p>

<p>Second, you need to put the victim slab into the <em>kfree()</em>ed area pointed by 
<em>sync-&gt;cropinfo</em> such that the <em>msm_set_crop()</em> would modify the content of 
the victim slab.
The best way to achieve that is to allocate a bunch of victim slabs (e.g., 
<em>open()</em> the sysfs entry 100 times) right after the crafted <em>msm_set_crop()</em> 
ioctl call which <em>kfree()</em> the <em>sync-&gt;cropinfo</em>.
This way, we can fill in one of the victim slab into the memory slot that 
will be <em>USE</em> after <em>FREE</em>.
In Figure 2, we use an invalid address to let the GPU driver <em>kfee()</em> the slab 
which is <em>kmalloc()</em>ed in our first trip to <em>msm_set_crop()</em> (line 56-57).
Right after that, we <em>open()</em> lots of sysfs entries and keep the file 
descriptors in the <em>sys_fd[]</em> array for later usage.
This allows us to setup one of the victim slabs which is reachable from one of 
the sysfs file descriptors.</p>

<div align="center">
	<br>
	<img src="./2015 - CVE-2015-0568 Use-After-Free Vulnerability in the Camera Driver of Qualcomm MSM 7x30_files/msm_set_crop_figure2.png" width="500">
	<div style="text-align:center">Figure 2: Setup the Victim Slab</div>
	<br>
</div>

<p>Third, you need to prepare the shellcode and drop it into victim slab by 
another <em>msm_set_crop()</em> ioctl.
As illustrated in Figure 3, we prepare the <em>crop.info</em> and trick the driver 
to write <em>crop.len</em> bytes into the victim slab (Figure 1: line 1546-1548).</p>

<div align="center">
	<br>
	<img src="./2015 - CVE-2015-0568 Use-After-Free Vulnerability in the Camera Driver of Qualcomm MSM 7x30_files/msm_set_crop_figure3.png" width="600">
	<div style="text-align:center">Figure 3: Drop the Shellcode</div>
	<br>
</div>

<p>Finally, you can trigger the shellcode by reading the sysfs entry (Figure 4).</p>

<div align="center">
	<br>
	<img src="./2015 - CVE-2015-0568 Use-After-Free Vulnerability in the Camera Driver of Qualcomm MSM 7x30_files/msm_set_crop_figure4.png" width="450">
	<div style="text-align:center">Figure 4: Trigger the Shellcode</div>
	<br>
</div>

<h4 id="acknowledgement">Acknowledgement</h4>

<p>The finding was mainly credited to Chiachih Wu and Yanfeng Wang from Qihoo 360.</p>

<h4 id="disclosure-timeline">Disclosure Timeline</h4>

<ul>
  <li>June 5, 2015: We reported the vulnerability to the corresponding vendor – Qualcomm Inc.</li>
  <li>June 26, 2015: Qualcomm confirmed the presence of the reported vulnerability</li>
  <li>August 13, 2015: Qualcomm notified us with the assigned CVE-2015-0568</li>
  <li>August 21, 2015: Qualcomm disclosed the details of CVE-2015-0568 on Code Aurora Forum</li>
</ul>



    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev disabled"><a>← Previous</a></li>
      
        <li><a href="https://web.archive.org/web/20190709110421/http://c0reteam.org/archive.html">Archive</a></li>
      
        <li class="next"><a href="https://web.archive.org/web/20190709110421/http://c0reteam.org/2016/01/06/cve-20153865" title="CVE-2015-3865: Elevation of Privilege Vulnerability in Android Runtime">Next →</a></li>
      
      </ul>
    </div>
    <hr>
    
  </div>
  
  <div class="span4">


    <h4>Published</h4>
    <div class="date"><span>18 November 2015</span></div>

  
    <h4>Tags</h4>
    <ul class="tag_box">
    
    


  
     
    	<li><a href="https://web.archive.org/web/20190709110421/http://c0reteam.org/tags.html#Vulnerability-ref">Vulnerability <span>2</span></a></li>
     
    	<li><a href="https://web.archive.org/web/20190709110421/http://c0reteam.org/tags.html#UAF-ref">UAF <span>1</span></a></li>
     
    	<li><a href="https://web.archive.org/web/20190709110421/http://c0reteam.org/tags.html#Linux-ref">Linux <span>3</span></a></li>
     
    	<li><a href="https://web.archive.org/web/20190709110421/http://c0reteam.org/tags.html#Qualcomm-ref">Qualcomm <span>1</span></a></li>
    
  



    </ul>
    
  </div>
</div>


      </div>

      <footer>
        <p> Copyright © 2015 - C0RE Team (contact@c0reteam.org)


        </p>
      </footer>

    </div> <!-- /container -->

    



  


<script>
	function isWeixinBrowser() {
		var ua = navigator.userAgent.toLowerCase();
		return (/micromessenger/.test(ua)) ? true : false;
	}

	if (isWeixinBrowser()) {
		document.title = 'C0RE Team - 安全研究团队';
	}
	else {
		document.title = 'C0RE Team - CVE-2015-0568: Use-After-Free Vulnerability in the Camera Driver of Qualcomm MSM 7x30';
	}
</script>

<!--
     FILE ARCHIVED ON 11:04:21 Jul 09, 2019 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 17:33:12 Dec 02, 2021.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 248.832
  exclusion.robots: 0.187
  exclusion.robots.policy: 0.18
  cdx.remote: 0.059
  esindex: 0.01
  LoadShardBlock: 224.004 (3)
  PetaboxLoader3.datanode: 86.246 (4)
  CDXLines.iter: 14.5 (3)
  load_resource: 223.706
  PetaboxLoader3.resolve: 166.243
--></body></html>