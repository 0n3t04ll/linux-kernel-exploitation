<!DOCTYPE html>
<!-- saved from url=(0139)https://flattsecurity.medium.com/cve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a -->
<html lang="en" data-rh="lang"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script async="" src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/branch-latest.min.js.下載"></script><script async="" src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/analytics.js.下載"></script><script defer="" src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/16180790160.js.下載"></script><title>CVE-2021–20226 a reference counting bug which leads to local privilege escalation in io_uring. | by Flatt Security Inc. | Medium</title><meta data-rh="true" name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1,maximum-scale=1"><meta data-rh="true" name="theme-color" content="#000000"><meta data-rh="true" name="twitter:app:name:iphone" content="Medium"><meta data-rh="true" name="twitter:app:id:iphone" content="828256236"><meta data-rh="true" property="al:ios:app_name" content="Medium"><meta data-rh="true" property="al:ios:app_store_id" content="828256236"><meta data-rh="true" property="al:android:package" content="com.medium.reader"><meta data-rh="true" property="fb:app_id" content="542599432471018"><meta data-rh="true" property="og:site_name" content="Medium"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2021-06-23T13:51:03.455Z"><meta data-rh="true" name="title" content="CVE-2021–20226 a reference counting bug which leads to local privilege escalation in io_uring. | by Flatt Security Inc. | Medium"><meta data-rh="true" property="og:title" content="CVE-2021–20226 a reference counting bug which leads to local privilege escalation in io_uring."><meta data-rh="true" property="twitter:title" content="CVE-2021–20226 a reference counting bug which leads to local privilege escalation in io_uring."><meta data-rh="true" name="twitter:site" content="@Medium"><meta data-rh="true" name="twitter:app:url:iphone" content="medium://p/e946bd69177a"><meta data-rh="true" property="al:android:url" content="medium://p/e946bd69177a"><meta data-rh="true" property="al:ios:url" content="medium://p/e946bd69177a"><meta data-rh="true" property="al:android:app_name" content="Medium"><meta data-rh="true" name="description" content="In this article, I would like to give you a technical description of CVE-2021–20226( ZDI-2021–001 ) which is published before. I discovered this vulnerability and reported it to the vendor via the…"><meta data-rh="true" property="og:description" content="Hello, I’m Shiga( @Ga_ryo_ ), a security engineer at Flatt Security Inc."><meta data-rh="true" property="twitter:description" content="Hello, I’m Shiga( @Ga_ryo_ ), a security engineer at Flatt Security Inc."><meta data-rh="true" property="og:url" content="https://flattsecurity.medium.com/cve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a"><meta data-rh="true" property="al:web:url" content="https://flattsecurity.medium.com/cve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a"><meta data-rh="true" property="og:image" content="https://miro.medium.com/max/1200/1*xTPZ_N__RtSfTA7J7kTSBA.png"><meta data-rh="true" name="twitter:image:src" content="https://miro.medium.com/max/1200/1*xTPZ_N__RtSfTA7J7kTSBA.png"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="article:author" content="https://flattsecurity.medium.com"><meta data-rh="true" name="author" content="Flatt Security Inc."><meta data-rh="true" name="robots" content="index,follow,max-image-preview:large"><meta data-rh="true" name="referrer" content="unsafe-url"><meta data-rh="true" name="twitter:label1" content="Reading time"><meta data-rh="true" name="twitter:data1" content="20 min read"><link data-rh="true" rel="search" type="application/opensearchdescription+xml" title="Medium" href="https://flattsecurity.medium.com/osd.xml"><link data-rh="true" rel="apple-touch-icon" sizes="152x152" href="https://miro.medium.com/fit/c/152/152/1*sHhtYhaCe2Uc3IU0IgKwIQ.png"><link data-rh="true" rel="apple-touch-icon" sizes="120x120" href="https://miro.medium.com/fit/c/120/120/1*sHhtYhaCe2Uc3IU0IgKwIQ.png"><link data-rh="true" rel="apple-touch-icon" sizes="76x76" href="https://miro.medium.com/fit/c/76/76/1*sHhtYhaCe2Uc3IU0IgKwIQ.png"><link data-rh="true" rel="apple-touch-icon" sizes="60x60" href="https://miro.medium.com/fit/c/60/60/1*sHhtYhaCe2Uc3IU0IgKwIQ.png"><link data-rh="true" rel="mask-icon" href="https://cdn-static-1.medium.com/_/fp/icons/Medium-Avatar-500x500.svg" color="#171717"><link data-rh="true" rel="preconnect" href="https://glyph.medium.com/" crossorigin=""><link data-rh="true" rel="preconnect" href="https://logx.optimizely.com/"><link data-rh="true" id="glyph_preload_link" rel="preload" as="style" type="text/css" href="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/unbound.css"><link data-rh="true" id="glyph_link" rel="stylesheet" type="text/css" href="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/unbound.css"><link data-rh="true" rel="author" href="https://flattsecurity.medium.com/"><link data-rh="true" rel="canonical" href="https://flattsecurity.medium.com/cve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a"><link data-rh="true" rel="alternate" href="android-app://com.medium.reader/https/medium.com/p/e946bd69177a"><link rel="preload" href="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/16180790160.js.下載" as="script"><style type="text/css" data-fela-rehydration="487" data-fela-type="STATIC">html{box-sizing:border-box}*, *:before, *:after{box-sizing:inherit}body{margin:0;padding:0;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;color:rgba(0,0,0,0.8);position:relative;min-height:100vh}h1, h2, h3, h4, h5, h6, dl, dd, ol, ul, menu, figure, blockquote, p, pre, form{margin:0}menu, ol, ul{padding:0;list-style:none;list-style-image:none}main{display:block}a{color:inherit;text-decoration:none}a, button, input{-webkit-tap-highlight-color:transparent}img, svg{vertical-align:middle}button{background:transparent;overflow:visible}button, input, optgroup, select, textarea{margin:0}:root{--reach-tabs:1;--reach-menu-button:1}</style><style type="text/css" data-fela-rehydration="487" data-fela-type="KEYFRAME">@-webkit-keyframes k1{from{filter:hue-rotate(0deg)}to{filter:hue-rotate(360deg)}}@-moz-keyframes k1{from{filter:hue-rotate(0deg)}to{filter:hue-rotate(360deg)}}@keyframes k1{from{filter:hue-rotate(0deg)}to{filter:hue-rotate(360deg)}}@-webkit-keyframes k2{0%{opacity:0;transform:translateY(-60px)}100%{opacity:1;transform:translateY(0px)}}@-moz-keyframes k2{0%{opacity:0;transform:translateY(-60px)}100%{opacity:1;transform:translateY(0px)}}@keyframes k2{0%{opacity:0;transform:translateY(-60px)}100%{opacity:1;transform:translateY(0px)}}@-webkit-keyframes k3{0%{opacity:1;transform:translateY(0px)}100%{opacity:0;transform:translateY(-60px)}}@-moz-keyframes k3{0%{opacity:1;transform:translateY(0px)}100%{opacity:0;transform:translateY(-60px)}}@keyframes k3{0%{opacity:1;transform:translateY(0px)}100%{opacity:0;transform:translateY(-60px)}}</style><style type="text/css" data-fela-rehydration="487" data-fela-type="RULE">.a{font-family:medium-content-sans-serif-font, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif}.b{font-weight:400}.c{background-color:rgba(255, 255, 255, 1)}.l{height:100vh}.m{width:100vw}.n{display:flex}.o{align-items:center}.p{justify-content:center}.q{height:25px}.r{fill:rgba(41, 41, 41, 1)}.s{display:block}.t{background-color:rgba(250, 250, 250, 1)}.u{margin-bottom:36px}.w{padding-top:8px}.x{width:100%}.ac{flex:0 0 auto}.ae{justify-self:flex-end}.af{z-index:500}.ag{visibility:hidden}.ah{box-shadow:inset 0 -1px 0 rgba(213, 213, 213, 1)}.ai{min-height:115px}.al{flex-direction:column}.am{display:none}.ao{white-space:nowrap}.ap{border-bottom:1px solid rgba(213, 213, 213, 1)}.aq{position:relative}.aw{max-width:1192px}.ax{min-width:0}.ay{height:62px}.az{flex-direction:row}.ba{flex:1 0 auto}.bb{margin-right:16px}.bc{font-family:sohne, "Helvetica Neue", Helvetica, Arial, sans-serif}.bd{font-size:14px}.be{line-height:20px}.bf{color:rgba(210, 37, 80, 1)}.bg{padding:7px 16px 9px}.bh{background:0}.bi{fill:rgba(210, 37, 80, 1)}.bj{border-color:rgba(210, 37, 80, 1)}.bo:disabled{cursor:inherit}.bp:disabled{opacity:0.3}.bq:disabled:hover{color:rgba(210, 37, 80, 1)}.br:disabled:hover{fill:rgba(210, 37, 80, 1)}.bs:disabled:hover{border-color:rgba(210, 37, 80, 1)}.bt{border-radius:99em}.bu{border-width:1px}.bv{border-style:solid}.bw{box-sizing:border-box}.bx{display:inline-block}.by{text-decoration:none}.bz{margin-left:0px}.ca{color:rgba(109, 111, 111, 1)}.cb{font-size:inherit}.cc{border:inherit}.cd{font-family:inherit}.ce{letter-spacing:inherit}.cf{font-weight:inherit}.cg{padding:0}.ch{margin:0}.ci:disabled{cursor:default}.cj:disabled{color:rgba(163, 208, 162, 0.5)}.ck:disabled{fill:rgba(163, 208, 162, 0.5)}.cl{fill:rgba(61, 62, 62, 1)}.cm{justify-content:space-between}.cs{align-items:flex-start}.ct{margin-bottom:0px}.cu{margin-top:-32px}.cv{align-items:flex-end}.cw{flex-wrap:wrap}.cz{margin-top:32px}.da{margin-right:24px}.dc{font-weight:500}.dd{font-size:27px}.de{line-height:34px}.df:before{margin-bottom:-14px}.dg:before{content:""}.dh:before{display:table}.di:before{border-collapse:collapse}.dj:after{margin-top:-6px}.dk:after{content:""}.dl:after{display:table}.dm:after{border-collapse:collapse}.dn{letter-spacing:0}.do{color:rgba(46, 47, 48, 1)}.dp{word-break:break-word}.dq{margin-bottom:-3px}.dr{margin-left:14px}.ds{margin-top:-3px}.dt{padding-top:1px}.du{height:70px}.dv{font-size:16px}.dw{line-height:24px}.dx:before{margin-bottom:-10px}.dy{margin-right:12px}.dz{display:inline-flex}.ea{color:inherit}.eb{fill:inherit}.ee:disabled{color:rgba(109, 111, 111, 1)}.ef:disabled{fill:rgba(109, 111, 111, 1)}.eg{margin-left:12px}.eh{position:absolute}.ei{right:24px}.ej{margin:0px}.ek{border:0px}.el{padding:0px}.em{cursor:pointer}.en{stroke:rgba(109, 111, 111, 1)}.eq{left:0}.er{opacity:0}.es{position:fixed}.et{right:0}.eu{top:0}.ew{height:60px}.ez{height:100%}.fc{margin-left:16px}.fi{margin-left:auto}.fj{margin-right:auto}.fk{max-width:728px}.fl{background:rgba(250, 250, 250, 1)}.fm{border:1px solid rgba(213, 213, 213, 1)}.fn{border-radius:4px}.fo{box-shadow:0 1px 4px rgba(213, 213, 213, 1)}.fp{max-height:100vh}.fq{overflow-y:auto}.fr{top:calc(100vh + 100px)}.fs{bottom:calc(100vh + 100px)}.ft{width:10px}.fu{pointer-events:none}.fv{word-wrap:break-word}.fw:after{display:block}.fx:after{clear:both}.fy{max-width:680px}.fz{line-height:1.23}.ga{font-style:normal}.gb{font-weight:700}.gw{margin-bottom:-0.27em}.gx{color:rgba(61, 62, 62, 1)}.hb{border-radius:50%}.hc{height:28px}.hd{width:28px}.he{margin-left:8px}.hf{margin:0 4px}.hg{margin:0 7px}.hp{margin:0 6px 0 7px}.hq{max-width:1800px}.hr{margin-top:33px}.hs{clear:both}.hu{cursor:zoom-in}.hv{z-index:auto}.hx{max-width:100%}.hy{height:auto}.hz{line-height:1.58}.ia{letter-spacing:-0.004em}.ib{font-family:charter, Georgia, Cambria, "Times New Roman", Times, serif}.iw{margin-bottom:-0.46em}.ix{text-decoration:underline}.iy{list-style-type:disc}.iz{margin-left:30px}.ja{padding-left:0px}.jb{margin-bottom:14px}.jc{padding-top:24px}.jd{padding-bottom:10px}.je{background-color:rgba(32, 33, 34, 1)}.jf{height:3px}.jg{width:3px}.jh{margin-right:20px}.ji{line-height:1.18}.jj{letter-spacing:-0.022em}.ke{margin-bottom:-0.31em}.kk{background-color:rgba(232, 232, 232, 1)}.kl{padding:2px 4px}.km{font-size:75%}.kn> strong{font-family:inherit}.ko{font-family:Menlo, Monaco, "Courier New", Courier, monospace}.kp{max-width:1306px}.kv{padding:20px}.kw{background:rgba(232, 232, 232, 1)}.kx{overflow-x:auto}.ky{margin-top:-0.09em}.kz{margin-bottom:-0.09em}.la{white-space:pre-wrap}.lg{max-width:1100px}.lh{transition:opacity 100ms 400ms}.li{overflow:hidden}.lj{will-change:transform}.lk{transform:translateZ(0)}.ll{margin:auto}.lm{padding-bottom:98%}.ln{height:0}.lo{filter:blur(20px)}.lp{transform:scale(1.1)}.lq{visibility:visible}.lr{box-shadow:inset 3px 0 0 0 rgba(32, 33, 34, 1)}.ls{padding-left:23px}.lt{margin-left:-20px}.lu{font-style:italic}.lv{max-width:1460px}.lw{padding-bottom:103%}.lx{max-width:1278px}.ly{padding-bottom:71.71428571428571%}.lz{line-height:1.12}.mn{margin-bottom:-0.28em}.mo{max-width:1160px}.mp{padding-bottom:51.42857142857143%}.mv{list-style-type:decimal}.mw{max-width:1230px}.mx{padding-bottom:94.71428571428571%}.nd{max-width:1550px}.ne{padding-bottom:91.71428571428572%}.nf{max-width:1582px}.ng{padding-bottom:45.85714285714286%}.nh{max-width:1560px}.ni{padding-bottom:90.14285714285714%}.nj{max-width:1706px}.nk{padding-bottom:93.85714285714286%}.nl{will-change:opacity}.nm{width:188px}.nn{left:50%}.no{transform:translateX(406px)}.np{top:calc(65px + 54px + 14px)}.ns{will-change:opacity, transform}.nt{transform:translateY(159px)}.nv{width:197px}.nw{margin-bottom:20px}.nx{padding-bottom:5px}.ny{padding-top:2px}.nz{padding-top:20px}.oa{color:rgba(255, 238, 243, 1)}.ob{fill:rgba(255, 238, 243, 1)}.oc{background:rgba(210, 37, 80, 1)}.oe:disabled:hover{background:rgba(210, 37, 80, 1)}.of{stroke:rgba(232, 232, 232, 1)}.og{height:36px}.oh{width:36px}.oi{color:rgba(232, 232, 232, 1)}.oj{fill:rgba(232, 232, 232, 1)}.ok{border-color:rgba(232, 232, 232, 1)}.oq{padding-top:32px}.or{border-top:1px solid rgba(213, 213, 213, 1)}.os{justify-content:space-evenly}.oy{-webkit-user-select:none}.oz{outline:0}.pa{border:0}.pb{user-select:none}.pc> svg{pointer-events:none}.pn button{text-align:left}.po{margin-top:2px}.pp{fill:rgba(86, 87, 87, 1)}.pq{opacity:1}.pr{margin-top:1px}.ps{margin-top:40px}.pt{padding-bottom:25px}.pu{margin-top:25px}.pv{max-width:155px}.qc{top:1px}.qf{margin-left:24px}.qg{margin-top:4px}.qh{padding-bottom:40px}.qi{list-style-type:none}.qj{margin-right:8px}.qk{margin-bottom:8px}.ql{font-size:13px}.qm{line-height:22px}.qn{border-radius:3px}.qo{padding:5px 10px}.qp{padding-top:40px}.qq{padding-bottom:4px}.qr{background-color:rgba(241, 241, 241, 1)}.rh{text-overflow:ellipsis}.ri{display:-webkit-box}.rj{-webkit-line-clamp:2}.rk{-webkit-box-orient:vertical}.rm{padding-top:5px}.rn{padding-top:25px}.rt{background:rgba(255, 255, 255, 1)}.bk:hover{color:rgba(239, 87, 113, 1)}.bl:hover{fill:rgba(239, 87, 113, 1)}.bm:hover{border-color:rgba(239, 87, 113, 1)}.bn:hover{cursor:pointer}.ec:hover{color:rgba(46, 47, 48, 1)}.ed:hover{fill:rgba(46, 47, 48, 1)}.od:hover{background:rgba(239, 87, 113, 1)}.ol:hover{background:rgba(232, 232, 232, 1)}.om:hover{border-color:rgba(232, 232, 232, 1)}.on:hover{cursor:wait}.oo:hover{color:rgba(232, 232, 232, 1)}.op:hover{fill:rgba(232, 232, 232, 1)}.pf:hover{fill:rgba(109, 111, 111, 1)}.hw:focus{transform:scale(1.01)}.pe:focus{fill:rgba(109, 111, 111, 1)}.pd:active{border-style:none}</style><style type="text/css" data-fela-rehydration="487" data-fela-type="RULE" media="all and (min-width: 1080px)">.d{display:none}.y{display:flex}.av{margin:0 64px}.fh{padding:0 16px}.gs{font-size:46px}.gt{margin-top:0.6em}.gu{line-height:56px}.gv{letter-spacing:-0.011em}.hn{margin-left:30px}.is{font-size:21px}.it{margin-top:2em}.iu{line-height:32px}.iv{letter-spacing:-0.003em}.ka{font-size:22px}.kb{margin-top:1.72em}.kc{line-height:28px}.kd{letter-spacing:0}.kj{margin-top:0.86em}.ku{margin-top:56px}.lf{margin-top:1.91em}.mk{font-size:30px}.ml{margin-top:1.25em}.mm{line-height:36px}.mu{margin-top:1.05em}.nc{margin-top:1.95em}.ox{margin-right:5px}.pm{margin-top:0px}.qb{margin-top:5px}.qe{display:inline-block}.re{font-size:20px}.rf{line-height:24px}.rg{max-height:48px}.rs{margin:0}</style><style type="text/css" data-fela-rehydration="487" data-fela-type="RULE" media="all and (max-width: 1079.98px)">.e{display:none}.hm{margin-left:30px}.pl{margin-top:0px}.qa{margin-top:5px}.qd{display:inline-block}</style><style type="text/css" data-fela-rehydration="487" data-fela-type="RULE" media="all and (max-width: 903.98px)">.f{display:none}.hl{margin-left:30px}.pk{margin-top:0px}.py{display:inline-block}.pz{margin-top:5px}</style><style type="text/css" data-fela-rehydration="487" data-fela-type="RULE" media="all and (max-width: 727.98px)">.g{display:none}.v{margin-bottom:20px}.aj{box-shadow:inset 0 -1px 0 rgba(213, 213, 213, 1)}.ak{min-height:230px}.an{display:block}.cn{min-height:98px}.co{display:flex}.cp{align-items:flex-start}.cq{flex-direction:column}.cr{justify-content:flex-end}.cx{margin-bottom:28px}.cy{margin-top:0px}.db{margin-top:28px}.eo{border-top:1px solid rgba(213, 213, 213, 1)}.ep{border-bottom:1px solid rgba(213, 213, 213, 1)}.fa{align-items:center}.fb{flex:1 0 auto}.gz{margin-top:32px}.ha{flex-direction:column-reverse}.hj{margin-bottom:30px}.hk{margin-left:0px}.pi{margin-top:2px}.pj{margin-right:16px}.px{display:inline-block}</style><style type="text/css" data-fela-rehydration="487" data-fela-type="RULE" media="all and (max-width: 551.98px)">.h{display:none}.ar{margin:0 24px}.ex{display:block}.fd{padding:0 8px 24px 8px}.gc{font-size:32px}.gd{margin-top:0.64em}.ge{line-height:40px}.gf{letter-spacing:-0.016em}.gy{margin-top:32px}.hh{margin-bottom:30px}.hi{margin-left:0px}.ic{font-size:18px}.id{margin-top:1.56em}.ie{line-height:28px}.if{letter-spacing:-0.003em}.jk{font-size:20px}.jl{margin-top:1.23em}.jm{line-height:24px}.jn{letter-spacing:0}.kf{margin-top:0.67em}.kq{margin-top:40px}.lb{margin-top:1.41em}.ma{font-size:22px}.mb{margin-top:0.93em}.mq{margin-top:1.34em}.my{margin-top:1.2em}.ot{margin-left:8px}.pg{margin-top:2px}.ph{margin-right:16px}.pw{display:inline-block}.qs{font-size:16px}.qt{line-height:20px}.qu{max-height:40px}.ro{margin:0}</style><style type="text/css" data-fela-rehydration="487" data-fela-type="RULE" media="all and (min-width: 904px) and (max-width: 1079.98px)">.i{display:none}.z{display:flex}.au{margin:0 64px}.fg{padding:0 16px}.go{font-size:46px}.gp{margin-top:0.6em}.gq{line-height:56px}.gr{letter-spacing:-0.011em}.io{font-size:21px}.ip{margin-top:2em}.iq{line-height:32px}.ir{letter-spacing:-0.003em}.jw{font-size:22px}.jx{margin-top:1.72em}.jy{line-height:28px}.jz{letter-spacing:0}.ki{margin-top:0.86em}.kt{margin-top:56px}.le{margin-top:1.91em}.mh{font-size:30px}.mi{margin-top:1.25em}.mj{line-height:36px}.mt{margin-top:1.05em}.nb{margin-top:1.95em}.ow{margin-right:5px}.rb{font-size:20px}.rc{line-height:24px}.rd{max-height:48px}.rr{margin:0}</style><style type="text/css" data-fela-rehydration="487" data-fela-type="RULE" media="all and (min-width: 728px) and (max-width: 903.98px)">.j{display:none}.ab{display:flex}.at{margin:0 48px}.ff{padding:0 16px}.gk{font-size:46px}.gl{margin-top:0.6em}.gm{line-height:56px}.gn{letter-spacing:-0.011em}.ik{font-size:21px}.il{margin-top:2em}.im{line-height:32px}.in{letter-spacing:-0.003em}.js{font-size:22px}.jt{margin-top:1.72em}.ju{line-height:28px}.jv{letter-spacing:0}.kh{margin-top:0.86em}.ks{margin-top:56px}.ld{margin-top:1.91em}.me{font-size:30px}.mf{margin-top:1.25em}.mg{line-height:36px}.ms{margin-top:1.05em}.na{margin-top:1.95em}.ov{margin-right:5px}.qy{font-size:20px}.qz{line-height:24px}.ra{max-height:48px}.rq{margin:0}</style><style type="text/css" data-fela-rehydration="487" data-fela-type="RULE" media="all and (min-width: 552px) and (max-width: 727.98px)">.k{display:none}.as{margin:0 24px}.ey{display:block}.fe{padding:0 8px 24px 8px}.gg{font-size:32px}.gh{margin-top:0.64em}.gi{line-height:40px}.gj{letter-spacing:-0.016em}.ig{font-size:18px}.ih{margin-top:1.56em}.ii{line-height:28px}.ij{letter-spacing:-0.003em}.jo{font-size:20px}.jp{margin-top:1.23em}.jq{line-height:24px}.jr{letter-spacing:0}.kg{margin-top:0.67em}.kr{margin-top:40px}.lc{margin-top:1.41em}.mc{font-size:22px}.md{margin-top:0.93em}.mr{margin-top:1.34em}.mz{margin-top:1.2em}.ou{margin-left:8px}.qv{font-size:16px}.qw{line-height:20px}.qx{max-height:40px}.rp{margin:0}</style><style type="text/css" data-fela-rehydration="487" data-fela-type="RULE" media="print">.ho{display:none}</style><style type="text/css" data-fela-rehydration="487" data-fela-type="RULE" media="(prefers-reduced-motion: no-preference)">.ev{animation:k3 .2s ease-in-out both}.ht{transition:transform 300ms cubic-bezier(0.2, 0, 0.2, 1)}.nq{transition:opacity 200ms}</style><style type="text/css" data-fela-rehydration="487" data-fela-type="RULE" media="all and (max-width: 1230px)">.nr{display:none}</style><style type="text/css" data-fela-rehydration="487" data-fela-type="RULE" media="all and (max-width: 1240px)">.nu{display:none}</style><style type="text/css" data-fela-rehydration="487" data-fela-type="RULE" media="(orientation: landscape) and (max-width: 903.98px)">.rl{max-height:none}</style><script type="application/ld+json" data-rh="true">{"@context":"http:\u002F\u002Fschema.org","@type":"NewsArticle","image":["https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F1200\u002F1*xTPZ_N__RtSfTA7J7kTSBA.png"],"url":"https:\u002F\u002Fflattsecurity.medium.com\u002Fcve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a","dateCreated":"2021-06-21T14:55:57.678Z","datePublished":"2021-06-21T14:55:57.678Z","dateModified":"2021-06-23T13:51:12.479Z","headline":"CVE-2021–20226 a reference counting bug which leads to local privilege escalation in io_uring.","name":"CVE-2021–20226 a reference counting bug which leads to local privilege escalation in io_uring.","description":"In this article, I would like to give you a technical description of CVE-2021–20226( ZDI-2021–001 ) which is published before. I discovered this vulnerability and reported it to the vendor via the…","identifier":"e946bd69177a","author":{"@type":"Person","name":"Flatt Security Inc.","url":"https:\u002F\u002Fflattsecurity.medium.com"},"creator":["Flatt Security Inc."],"publisher":{"@type":"Organization","name":"Medium","url":"https:\u002F\u002Fflattsecurity.medium.com\u002F","logo":{"@type":"ImageObject","width":308,"height":60,"url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F385\u002F1*OMF3fSqH8t4xBJ9-6oZDZw.png"}},"mainEntityOfPage":"https:\u002F\u002Fflattsecurity.medium.com\u002Fcve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a"}</script><script data-rh="true">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-24232453-2', 'auto');
ga('send', 'pageview');</script><script type="text/javascript" data-rh="true">(function(b,r,a,n,c,h,_,s,d,k){if(!b[n]||!b[n]._q){for(;s<_.length;)c(h,_[s++]);d=r.createElement(a);d.async=1;d.src="https://cdn.branch.io/branch-latest.min.js";k=r.getElementsByTagName(a)[0];k.parentNode.insertBefore(d,k);b[n]=h}})(window,document,"script","branch",function(b,r){b[r]=function(){b._q.push([r,arguments])}},{_q:[],_v:1},"addListener applyCode autoAppIndex banner closeBanner closeJourney creditHistory credits data deepview deepviewCta first getCode init link logout redeem referrals removeListener sendSMS setBranchViewData setIdentity track validateCode trackCommerceEvent logEvent".split(" "), 0);
branch.init('key_live_ofxXr2qTrrU9NqURK8ZwEhknBxiI6KBm', {metadata: {}, 'no_journeys': true, 'disable_exit_animation': true, 'disable_entry_animation': true, 'tracking_disabled': null}, function(err, data) {});</script></head><body><div id="root"><div class="a b c"><div class="d e f g h i j k"></div><script>document.domain = document.domain;</script><div><script>if (window.self !== window.top) window.location = "about:blank"</script></div><div class="s t"><div class="u s v"><div class="ah ai s aj ak"><div class="n al"><div class="am an"><div class="ap s aq af"><div class="n p"><div class="ar as at au av aw ax x"><div class="ay n o"><div class="n o az ba"><div class="lq" id="lo-meta-header-sign-up-button"><div class="bb s"><span><button class="bc b bd be bf bg bh bi bj bk bl bm bn bo bp bq br bs bt bu bv bw bx by">Get started</button></span></div></div><div class="ao"><div class="lq" id="lo-ShowPostUnderUser-navbar-open-in-app-button"><div class="bz am an"><span class="bc b bd be ca"><a href="https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fe946bd69177a&amp;%7Efeature=LoOpenInAppButton&amp;%7Echannel=ShowPostUnderUser&amp;%7Estage=mobileNavBar&amp;source=post_page-----e946bd69177a-----------------------------------" class="bf bi cb cc cd ce cf cg ch bn bk bl ci ru rv" rel="noopener follow">Open in app</a></span></div></div></div></div><a href="https://medium.com/?source=post_page-----e946bd69177a-----------------------------------" rel="noopener follow" aria-label="Homepage"><svg viewBox="0 0 1043.63 592.71" class="q cl"><g data-name="Layer 2"><g data-name="Layer 1"><path d="M588.67 296.36c0 163.67-131.78 296.35-294.33 296.35S0 460 0 296.36 131.78 0 294.34 0s294.33 132.69 294.33 296.36M911.56 296.36c0 154.06-65.89 279-147.17 279s-147.17-124.94-147.17-279 65.88-279 147.16-279 147.17 124.9 147.17 279M1043.63 296.36c0 138-23.17 249.94-51.76 249.94s-51.75-111.91-51.75-249.94 23.17-249.94 51.75-249.94 51.76 111.9 51.76 249.94"></path></g></g></svg></a></div></div></div></div></div><div class="n p"><div class="ar as at au av aw ax x"><div class="ai n o az cm cn co cp cq cr"><div class="x n cs cm"><div class="w n x"><div class="ct cu x n cv az cw cx cy co cp cq"><div class="cz da s db"><a rel="noopener follow" aria-label="Author Homepage" href="https://flattsecurity.medium.com/?source=post_page-----e946bd69177a-----------------------------------"><span class="bc dc dd de df dg dh di dj dk dl dm dn do dp">Flatt Security Inc.</span></a></div><div class="cz s"><span class="bc b dv dw dx dg dh di dj dk dl dm ca"><div class="n o"><div class="dy dz al"><span class="bc b dv dw ca"><a class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef" rel="noopener follow" href="https://flattsecurity.medium.com/followers?source=post_page-----e946bd69177a-----------------------------------">16 Followers</a></span></div><div class="s h"></div><div class="s h"></div><div class="eg n al"><a class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef" rel="noopener follow" href="https://flattsecurity.medium.com/about?source=post_page-----e946bd69177a-----------------------------------">About</a></div><div class="qf s ts"><div class="tt tu s"><div class="n"><span><button class="bc b bd be oa bg ob oc bj od bm bn bo bp oe bs bt bu bv bw bx by">Follow</button></span><div class="he s"><div><div><div class="bx" role="tooltip" aria-hidden="false" aria-describedby="198" aria-labelledby="198"><div class="s"><span><a href="https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fusers%2Fb10b5c7f48a%2Flazily-enable-writer-subscription&amp;operation=register&amp;redirect=https%3A%2F%2Fflattsecurity.medium.com%2Fcve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a&amp;user=Flatt+Security+Inc.&amp;userId=b10b5c7f48a&amp;source=post_page-----e946bd69177a---------------------subscribe_user--------------" class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef" rel="noopener follow"><button class="bc b bd be oa cg ob oc bj od bm bn bo bp oe bs bt bu bv bw bx by" aria-label="Subscribe"><svg width="38" height="38" viewBox="0 0 38 38" fill="none" class="tw og oh"><rect x="26.25" y="9.25" width="0.5" height="6.5" rx="0.25" stroke-width="0.5"></rect><rect x="29.75" y="12.25" width="0.5" height="6.5" rx="0.25" transform="rotate(90 29.75 12.25)" stroke-width="0.5"></rect><path d="M19.5 12.5h-7a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h13a1 1 0 0 0 1-1v-5" stroke-linecap="round"></path><path d="M11.5 14.5L19 20l4-3" stroke-linecap="round"></path></svg></button></a></span></div></div></div></div></div></div></div></div></div></span></div></div></div><div class="y z ab k h ac ae o af lq"><div class="lq" id="lo-meta-header-sign-in-link"><p class="bc b bd be ca"><span><a href="https://medium.com/m/signin?operation=login&amp;redirect=https%3A%2F%2Fflattsecurity.medium.com%2Fcve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a&amp;source=post_page-----e946bd69177a---------------------nav_reg--------------" class="bf bi cb cc cd ce cf cg ch bn bk bl ci ru rv" rel="noopener follow">Sign in</a></span></p></div><div class="lq" id="lo-meta-header-sign-up-button"><div class="dq dr ds da s"><span><button class="bc b bd be bf bg bh bi bj bk bl bm bn bo bp bq br bs bt bu bv bw bx by">Get started</button></span></div></div><a href="https://medium.com/?source=post_page-----e946bd69177a-----------------------------------" rel="noopener follow" aria-label="Homepage"><svg viewBox="0 0 1043.63 592.71" class="q cl"><g data-name="Layer 2"><g data-name="Layer 1"><path d="M588.67 296.36c0 163.67-131.78 296.35-294.33 296.35S0 460 0 296.36 131.78 0 294.34 0s294.33 132.69 294.33 296.36M911.56 296.36c0 154.06-65.89 279-147.17 279s-147.17-124.94-147.17-279 65.88-279 147.16-279 147.17 124.9 147.17 279M1043.63 296.36c0 138-23.17 249.94-51.76 249.94s-51.75-111.91-51.75-249.94 23.17-249.94 51.75-249.94 51.76 111.9 51.76 249.94"></path></g></g></svg></a></div></div></div></div></div></div></div><div class="eo ep t eq er es et eu ag af ev"><div class="n p"><div class="ar as at au av aw ax x"><div class="ew x ex ey j i d eu af"><div class="ez n o"><div class="am co fa fb"><div class="lq" id="lo-sticky-header-sign-up-button"><span><button class="bc b bd be bf bg bh bi bj bk bl bm bn bo bp bq br bs bt bu bv bw bx by">Get started</button></span></div><div class="lq" id="lo-ShowPostUnderUser-navbar-open-in-app-button"><div class="fc am an"><span class="bc b bd be ca"><a href="https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fe946bd69177a&amp;%7Efeature=LoOpenInAppButton&amp;%7Echannel=ShowPostUnderUser&amp;%7Estage=mobileNavBar&amp;source=post_page-----e946bd69177a-----------------------------------" class="bf bi cb cc cd ce cf cg ch bn bk bl ci ru rv" rel="noopener follow">Open in app</a></span></div></div></div><a href="https://medium.com/?source=post_page-----e946bd69177a-----------------------------------" rel="noopener follow" aria-label="Homepage"><svg viewBox="0 0 1043.63 592.71" class="q cl"><g data-name="Layer 2"><g data-name="Layer 1"><path d="M588.67 296.36c0 163.67-131.78 296.35-294.33 296.35S0 460 0 296.36 131.78 0 294.34 0s294.33 132.69 294.33 296.36M911.56 296.36c0 154.06-65.89 279-147.17 279s-147.17-124.94-147.17-279 65.88-279 147.16-279 147.17 124.9 147.17 279M1043.63 296.36c0 138-23.17 249.94-51.76 249.94s-51.75-111.91-51.75-249.94 23.17-249.94 51.75-249.94 51.76 111.9 51.76 249.94"></path></g></g></svg></a></div></div></div></div></div></div><div class="ho" role="dialog" aria-modal="true" tabindex="-1"><div class="si sj x ez es sk sl em er fu sm" aria-hidden="true" role="presentation"></div><div class="sn es so sp sq si ez bw sr ss st pq su sv sw sx sy sz ta tb ag" aria-hidden="true"><div class="tc td n o az cm"><div class="n az"><h2 class="bc dc te dw dn tf">Responses</h2></div><div class="n az"><div><div class="bx" role="tooltip" aria-hidden="false" aria-describedby="15" aria-labelledby="15"><a href="https://policy.medium.com/medium-rules-30e5502c4eb4?source=responses-----e946bd69177a-----------------------------------" class="tg th" target="_blank" rel="noopener follow"><svg width="25" height="25" viewBox="0 0 25 25"><path fill-rule="evenodd" clip-rule="evenodd" d="M11.99 5.04c.26-.21.64-.22.91-.01.97.72 1.77 1.21 2.6 1.54.83.32 1.72.48 2.89.5.41.01.74.35.74.76-.02 3.62-.43 6.26-1.45 8.21-1.03 1.98-2.66 3.21-4.97 4.08a.75.75 0 0 1-.53 0c-2.25-.87-3.86-2.1-4.9-4.07-1.02-1.95-1.46-4.59-1.48-8.22 0-.41.33-.75.75-.76 1.19-.02 2.1-.18 2.92-.5.82-.32 1.6-.81 2.52-1.53zm.46.9c-.9.69-1.71 1.21-2.62 1.56a8.9 8.9 0 0 1-3.02.57c.03 3.45.46 5.82 1.36 7.51.88 1.69 2.25 2.77 4.28 3.57 2.1-.8 3.47-1.89 4.34-3.57.89-1.7 1.3-4.07 1.34-7.51a8.8 8.8 0 0 1-3-.57 11.8 11.8 0 0 1-2.68-1.56zm0 9.15a2.67 2.67 0 1 0 0-5.34 2.67 2.67 0 0 0 0 5.34zm0 1a3.67 3.67 0 1 0 0-7.34 3.67 3.67 0 0 0 0 7.34zm-1.82-3.77l.53-.53.91.92 1.63-1.63.52.53-2.15 2.15-1.44-1.44z"></path></svg></a></div></div><div class="s aq tl"><div class="s aq eu et"><button class="ea eb cb cc cd ce cf cg ch bn ti th ci tj tk" data-testid="close-button" aria-label="close"><svg width="25" height="25" viewBox="0 0 25 25" class="tm"><path d="M18.13 6.11l-5.61 5.61-5.6-5.61-.81.8 5.61 5.61-5.61 5.61.8.8 5.61-5.6 5.61 5.6.8-.8-5.6-5.6 5.6-5.62"></path></svg></button></div></div></div></div><div class="tn to n al p o lu tp"><p class="bc b dv dw tq">There are currently no responses for this story.</p><p class="bc b dv dw tq">Be the first to respond.</p></div></div></div><article><section class="fd fe ff fg fh fi fj x fk bw s"></section><span class="s"></span><div><div><div class="eh eq sf fs ft fu"></div><section class="dp fv fw dk fx"><div class="n p"><div class="ar as at au av fy ax x"><div class=""><h1 id="f6e0" class="fz dn ga bc gb gc gd ge gf gg gh gi gj gk gl gm gn go gp gq gr gs gt gu gv gw gx" data-selectable-paragraph="">CVE-2021–20226 a reference counting bug which leads to local privilege escalation in io_uring.</h1><div class="cz"><div class="n cm gy gz ha"><div class="o n"><div><a rel="noopener follow" href="https://flattsecurity.medium.com/?source=post_page-----e946bd69177a-----------------------------------"><img alt="Flatt Security Inc." class="s hb hc hd" src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/1_Z0fxHngDdlFrMJQlA4GESw.png" width="28" height="28"></a></div><div class="he x n cw"><div class="n"><div style="flex:1"><span class="bc b bd be gx"><div><div class="bx" role="tooltip" aria-hidden="false" aria-describedby="5" aria-labelledby="5"><a class="" rel="noopener follow" href="https://flattsecurity.medium.com/?source=post_page-----e946bd69177a-----------------------------------"><p class="bc b bd be bf">Flatt Security Inc.</p></a></div></div></span></div></div><span class="bc b bd be ca"><a class="" rel="noopener follow" href="https://flattsecurity.medium.com/cve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a?source=post_page-----e946bd69177a-----------------------------------"><p class="bc b bd be ca"><span class="hf"></span><span>Jun 21</span><span class="hg">·</span>20 min read</p></a></span></div></div><div class="n cv hh hi hj hk hl hm hn ho"><div class="n o"><div class="ve s ac"><button class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef" aria-label="Share on twitter"><svg width="30" height="30" viewBox="0 0 30 30" fill="none" class="vf tr"><path fill-rule="evenodd" clip-rule="evenodd" d="M15 27a12 12 0 1 0 0-24 12 12 0 0 0 0 24zm4.95-16.17a2.67 2.67 0 0 0-4.6 1.84c0 .2.03.41.05.62a7.6 7.6 0 0 1-5.49-2.82 3 3 0 0 0-.38 1.34c.02.94.49 1.76 1.2 2.23a2.53 2.53 0 0 1-1.2-.33v.04c0 1.28.92 2.36 2.14 2.62-.23.05-.46.08-.71.1l-.21-.02-.27-.03a2.68 2.68 0 0 0 2.48 1.86A5.64 5.64 0 0 1 9 19.38a7.62 7.62 0 0 0 4.1 1.19c4.9 0 7.58-4.07 7.57-7.58v-.39c.52-.36.97-.83 1.33-1.38-.48.23-1 .37-1.53.43.56-.33.96-.86 1.15-1.48-.5.31-1.07.53-1.67.66z" fill="#292929"></path></svg></button></div><div class="ve s ac"><button class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef" aria-label="Share on facebook"><svg width="30" height="30" viewBox="0 0 30 30" fill="none" class="vf tr"><path fill-rule="evenodd" clip-rule="evenodd" d="M15 27a12 12 0 1 0 0-24 12 12 0 0 0 0 24zm-1.23-6.03V15.6H12v-2.15h1.77v-1.6C13.77 10 14.85 9 16.42 9c.75 0 1.4.06 1.58.08v1.93h-1.09c-.85 0-1.02.43-1.02 1.05v1.38h2.04l-.27 2.15H15.9V21l-2.13-.03z" fill="#292929"></path></svg></button></div><div class="ve s ac"><button class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef" aria-label="Share on linkedin"><svg width="30" height="30" viewBox="0 0 30 30" fill="none" class="vf tr"><path fill-rule="evenodd" clip-rule="evenodd" d="M27 15a12 12 0 1 1-24 0 12 12 0 0 1 24 0zm-14.61 5v-7.42h-2.26V20h2.26zm-1.13-8.44c.79 0 1.28-.57 1.28-1.28-.02-.73-.5-1.28-1.26-1.28-.78 0-1.28.55-1.28 1.28 0 .71.49 1.28 1.25 1.28h.01zM15.88 20h-2.5s.04-6.5 0-7.17h2.5v1.02l-.02.02h.02v-.02a2.5 2.5 0 0 1 2.25-1.18c1.64 0 2.87 1.02 2.87 3.22V20h-2.5v-3.83c0-.97-.36-1.62-1.26-1.62-.69 0-1.1.44-1.28.87-.06.15-.08.36-.08.58v4z" fill="#292929"></path></svg></button></div><div class="s ac"><button class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef"><svg width="30" height="30" viewBox="0 0 30 30" fill="none" class="vf tr"><path fill-rule="evenodd" clip-rule="evenodd" d="M15 27a12 12 0 1 0 0-24 12 12 0 0 0 0 24zM9.29 16.28c-.2.36-.29.75-.29 1.17a2.57 2.57 0 0 0 .78 1.84l1.01.96c.53.5 1.17.75 1.92.75s1.38-.25 1.9-.75l1.2-1.15.75-.71.51-.5a2.51 2.51 0 0 0 .72-2.34.7.7 0 0 0-.03-.18 2.74 2.74 0 0 0-.23-.5v-.02l-.08-.14-.02-.03-.02-.01a.33.33 0 0 0-.07-.1c0-.02-.01-.03-.03-.05a.2.2 0 0 0-.03-.03l-.03-.04v-.01l-.02-.03-.04-.03a.85.85 0 0 1-.13-.13l-.43-.42-.06.06-.9.84-.05.09a.26.26 0 0 0-.03.1l.37.38c.04.03.08.07.1.11l.01.01.01.03.02.01.04.1.03.04.06.1v.02l.01.02c.03.1.05.2.05.33a1 1 0 0 1-.12.49c-.07.13-.15.22-.22.29l-.88.85-.61.57-.95.92c-.22.2-.5.3-.82.3-.31 0-.58-.1-.8-.3l-.98-.96a1.15 1.15 0 0 1-.3-.42 1.4 1.4 0 0 1-.04-.35c0-.1.01-.2.04-.3a1 1 0 0 1 .3-.49l1.5-1.46v-.24c0-.21 0-.42.04-.6a3.5 3.5 0 0 1 .92-1.72c-.41.1-.78.32-1.11.62l-.01.02-.01.01-2.46 2.33c-.2.21-.35.4-.44.6h-.02c0 .02 0 .02-.02.02v.02l-.01.01zm3.92-1.8a1.83 1.83 0 0 0 .02.97c0 .06 0 .13.02.19.06.17.14.34.22.5v.02l.06.12.02.03.01.02.08.1c0 .02.02.03.04.05l.08.1h.01c0 .01 0 .03.02.03l.14.14.43.41.08-.06.88-.84.05-.09.03-.1-.36-.37a.4.4 0 0 1-.12-.13v-.02l-.02-.02-.05-.09-.04-.04-.04-.1v-.02l-.02-.02a1.16 1.16 0 0 1 .06-.82c.09-.14.16-.24.23-.3l.9-.85.6-.58.93-.92c.23-.2.5-.3.82-.3a1.2 1.2 0 0 1 .82.3l1 .96c.13.15.23.29.28.42a1.43 1.43 0 0 1 0 .66c-.03.17-.12.33-.26.48l-1.54 1.45.02.25a3.28 3.28 0 0 1-.96 2.32 2.5 2.5 0 0 0 1.1-.62l.01-.01 2.46-2.34c.19-.2.35-.4.46-.6l.02-.02v-.02h.01a2.45 2.45 0 0 0 .21-1.82 2.53 2.53 0 0 0-.7-1.19l-1-.96a2.68 2.68 0 0 0-1.91-.75c-.75 0-1.38.25-1.9.76l-1.2 1.14-.76.72-.5.49c-.4.37-.64.83-.74 1.37z" fill="#292929"></path></svg></button></div><div class="hp s"><span><a href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fe946bd69177a&amp;operation=register&amp;redirect=https%3A%2F%2Fflattsecurity.medium.com%2Fcve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a&amp;source=post_actions_header--------------------------bookmark_preview--------------" class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef" rel="noopener follow"><svg width="25" height="25" viewBox="0 0 25 25" fill="none" class="tr"><path d="M18 2.5a.5.5 0 0 1 1 0V5h2.5a.5.5 0 0 1 0 1H19v2.5a.5.5 0 1 1-1 0V6h-2.5a.5.5 0 0 1 0-1H18V2.5zM7 7a1 1 0 0 1 1-1h3.5a.5.5 0 0 0 0-1H8a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4V7z" fill="#292929"></path></svg></a></span></div><div class="s"><div class="bx" aria-hidden="false"><button class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef" aria-label="More options"><svg class="overflow-dots-filled-25px_svg__svgIcon-use" width="25" height="25"><path d="M5 12.5c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59.55 0 1.02-.2 1.41-.59.4-.39.59-.86.59-1.41 0-.55-.2-1.02-.59-1.41A1.93 1.93 0 0 0 7 10.5c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41zm5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59.55 0 1.02-.2 1.41-.59.4-.39.59-.86.59-1.41 0-.55-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59-.39.39-.58.86-.58 1.41zm5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59.56 0 1.03-.2 1.42-.59.39-.39.58-.86.58-1.41 0-.55-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59-.39.39-.58.86-.58 1.41z" fill-rule="evenodd"></path></svg></button></div></div></div></div></div></div></div><figure class="hr hs fi fj paragraph-image"><div role="button" tabindex="0" class="ht hu aq hv x hw"><div class="fi fj hq"><img alt="" class="x hx hy" src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/1_xTPZ_N__RtSfTA7J7kTSBA.png" width="700" height="368" role="presentation"></div></div></figure><p id="f098" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Hello, I’m Shiga( <a href="https://twitter.com/Ga_ryo_" class="ea ix" target="_blank" rel="noopener ugc nofollow">@Ga_ryo_</a> ), a security engineer at Flatt Security Inc.</p><p id="dc51" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">In this article, I would like to give you a technical description of CVE-2021–20226( <a href="https://www.zerodayinitiative.com/advisories/ZDI-21-001/" class="ea ix" target="_blank" rel="noopener ugc nofollow">ZDI-2021–001</a> ) which is published before. I discovered this vulnerability and reported it to the vendor via the Zero Day Initiative. This article is not intended to inform you of the dangers of vulnerabilities, but to share tips from a technical point of view.</p><p id="ae50" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">An overview of the vulnerabilities and attack methods can be found at the links below. This blog will explain in a little more detail.</p><ul class=""><li id="6ded" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw iy iz ja gx" data-selectable-paragraph=""><a href="https://www.zerodayinitiative.com/blog/2021/4/22/cve-2021-20226-a-reference-counting-bug-in-the-linux-kernel-iouring-%20subsystem" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://www.zerodayinitiative.com/blog/2021/4/22/cve-2021-20226-a-reference-counting-bug-in-the-linux-kernel-iouring- subsystem</a></li></ul></div></div></section><div class="n p cz jb jc jd" role="separator"><span class="je hb bx jf jg jh"></span><span class="je hb bx jf jg jh"></span><span class="je hb bx jf jg"></span></div><section class="dp fv fw dk fx"><div class="n p"><div class="ar as at au av fy ax x"><h2 id="4ef0" class="ji jj ga bc dc jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke gx" data-selectable-paragraph="">Notes</h2><p id="db88" class="hz ia ga ib b ic kf ie if ig kg ii ij ik kh im in io ki iq ir is kj iu iv iw dp gx" data-selectable-paragraph="">If you<span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"><span id="rmm"> </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>have any questions or found any mistakes, I’d appreciate it if you could contact me individually. And, the code in this article basically refers to the Linux Kernel source code at <a href="https://elixir.bootlin.com/linux/v5.6.19/source" class="ea ix" target="_blank" rel="noopener ugc nofollow">Linux kernel 5.6.19</a>.</p><p id="5ad9" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">io_uring is one of the actively updated features as of 2021, and the information changes as the version changes (many changes have been made since the time I discovered it). Therefore, please note that the information is not up-to-date even at the time of writing the blog.</p><p id="eeb8" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">General terms/knowledge in the Linux Kernel are not explained in this blog.</p><p id="f1d7" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">I will explain the outline of the PoC I wrote, but I will not post the actual code.</p></div></div></section><div class="n p cz jb jc jd" role="separator"><span class="je hb bx jf jg jh"></span><span class="je hb bx jf jg jh"></span><span class="je hb bx jf jg"></span></div><section class="dp fv fw dk fx"><div class="n p"><div class="ar as at au av fy ax x"><h2 id="2575" class="ji jj ga bc dc jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke gx" data-selectable-paragraph=""><strong class="cf">Overview</strong></h2><p id="3f12" class="hz ia ga ib b ic kf ie if ig kg ii ij ik kh im in io ki iq ir is kj iu iv iw dp gx" data-selectable-paragraph=""><strong class="ib gb">Preconditions</strong></p><p id="285b" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Arbitrary code(command) execution in the system.</p><p id="7c5f" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><strong class="ib gb">Impact</strong></p><p id="dd6d" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Privilege escalation to root.</p></div></div></section><div class="n p cz jb jc jd" role="separator"><span class="je hb bx jf jg jh"></span><span class="je hb bx jf jg jh"></span><span class="je hb bx jf jg"></span></div><section class="dp fv fw dk fx"><div class="n p"><div class="ar as at au av fy ax x"><h2 id="11c3" class="ji jj ga bc dc jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke gx" data-selectable-paragraph=""><strong class="cf">What is io_uring</strong></h2><p id="2cf3" class="hz ia ga ib b ic kf ie if ig kg ii ij ik kh im in io ki iq ir is kj iu iv iw dp gx" data-selectable-paragraph=""><strong class="ib gb">Rough explanation</strong></p><p id="1eb1" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Roughly speaking, io_uring is the latest asynchronous I/O(Network/Filesystem) mechanism.</p><p id="0256" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Please refer to some blogs/slides posted on the Internet for specs and detailed descriptions from the user’s perspective. <br>From here, I will continue to explain the outline of io_uring on the assumption that you understand it.</p><p id="ad4a" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">In io_uring, a file descriptor is first generated by a dedicated system call (<code class="kk kl km kn ko b">io_uring_setup</code>), and by issuing <code class="kk kl km kn ko b">mmap()</code> system call to it, Submission Queue(SQ) and Completion Queue(CQ) are mapped/shared in userspace memory.<br>This is used as ring buffer by both sides(Kernel/Userspace).<br>Entries for each system call such as read/write/send/recv are registered by writing SQE(Submission Queue Entry) to the shared memory.<br>And then execution is started by calling <code class="kk kl km kn ko b">io_uring_enter()</code>.</p><figure class="kq kr ks kt ku hs fi fj paragraph-image"><div role="button" tabindex="0" class="ht hu aq hv x hw"><div class="fi fj kp"><img alt="" class="x hx hy" src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/1_RBvfw3fmI2rxgBBUb6Yifw.png" width="700" height="798" role="presentation"></div></div></figure><p id="4d3b" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><strong class="ib gb">Asynchronous execution</strong></p><p id="4033" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">By the way, the important part this time is the implementation of asynchronous execution, so I will focus on that.<br>To explain it first, io_uring is not always executed asynchronously, but it is <strong class="ib gb">executed asynchronously as needed</strong>.<br>Please refer to the code below first.(After this, the Kernel v5.8 will be used to explain the behavior. The behavior may be slightly different from your environment.)</p><pre class="kq kr ks kt ku kv kw kx"><span id="21c5" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">#define _GNU_SOURCE<br>#include &lt;sched.h&gt;<br>#include &lt;stdio.h&gt;<br>#include &lt;string.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include &lt;signal.h&gt;<br>#include &lt;sys/syscall.h&gt;<br>#include &lt;sys/fcntl.h&gt;<br>#include &lt;err.h&gt;<br>#include &lt;unistd.h&gt;<br>#include &lt;sys/mman.h&gt;<br>#include &lt;linux/io_uring.h&gt;</span><span id="cba2" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">#define SYSCHK(x) ({          \<br>  typeof(x) __res = (x);      \<br>  if (__res == (typeof(x))-1) \<br>    err(1, "SYSCHK(" #x ")"); \<br>  __res;                      \<br>})</span><span id="9cfc" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">static int uring_fd;</span><span id="f4cf" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">struct iovec *io;<br>#define SIZE 32<br>char _buf[SIZE];</span><span id="25d1" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">int main(void) {<br>  // initialize uring<br>  struct io_uring_params params = { };<br>  uring_fd = SYSCHK(syscall(__NR_io_uring_setup, /*entries=*/10, &amp;params));<br>  unsigned char *sq_ring = SYSCHK(mmap(NULL, 0x1000, PROT_READ|PROT_WRITE,<br>                                       MAP_SHARED, uring_fd,<br>                                       IORING_OFF_SQ_RING));<br>  unsigned char *cq_ring = SYSCHK(mmap(NULL, 0x1000, PROT_READ|PROT_WRITE,<br>                                       MAP_SHARED, uring_fd,<br>                                       IORING_OFF_CQ_RING));<br>  struct io_uring_sqe *sqes = SYSCHK(mmap(NULL, 0x1000, PROT_READ|PROT_WRITE,<br>                                          MAP_SHARED, uring_fd,<br>                                          IORING_OFF_SQES));</span><span id="942f" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">io = malloc(sizeof(struct iovec)*1);<br>  io[0].iov_base = _buf;<br>  io[0].iov_len = SIZE;</span><span id="79c3" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">struct timespec ts = { .tv_sec = 1 };<br>  sqes[0] = (struct io_uring_sqe) {<br>    .opcode = IORING_OP_TIMEOUT,<br>    //.flags = IOSQE_IO_HARDLINK,<br>    .len = 1,<br>    .addr = (unsigned long)&amp;ts<br>  };<br>  sqes[1] = (struct io_uring_sqe) {<br>    .opcode = IORING_OP_READV,<br>    .addr = io,<br>    .flags = 0,<br>    .len = 1,<br>    .off = 0,<br>    .fd = SYSCHK(open("/etc/passwd", O_RDONLY))<br>  };<br>  ((int*)(sq_ring + params.sq_off.array))[0] = 0;<br>  ((int*)(sq_ring + params.sq_off.array))[1] = 1;<br>  (*(int*)(sq_ring + params.sq_off.tail)) += 2;</span><span id="2df3" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">int submitted = SYSCHK(syscall(__NR_io_uring_enter, uring_fd,<br>                                 /*to_submit=*/2, /*min_complete=*/0,<br>                                 /*flags=*/0, /*sig=*/NULL, /*sigsz=*/0));<br>  while(1){<br>    usleep(100000);<br>    if(*_buf){<br>      puts("READV executed.");<br>      break;<br>    }<br>    puts("Waiting.");<br>  }<br>}</span></pre><p id="4ecc" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">In this code, after performing the necessary setup for the operations <code class="kk kl km kn ko b">IORING_OP_TIMEOUT</code> and <code class="kk kl km kn ko b">IORING_OP_READV</code>, it starts execution and then checks every 0.1 seconds to see if <code class="kk kl km kn ko b">readv()</code> is complete.<br>It seems that <code class="kk kl km kn ko b">readv()</code> will be completed after 1 second, considering that it is executed in the order of ring buffer. However, when I actually run it, the result was as follows.</p><pre class="kq kr ks kt ku kv kw kx"><span id="496b" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">$ ./sample<br>READV executed.</span></pre><p id="e93c" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">That is, execution of <code class="kk kl km kn ko b">readv()</code> was completed immediately.<br>This is because, as I said earlier, it is <strong class="ib gb">executed asynchronously as needed</strong>, but in this case an execution of <code class="kk kl km kn ko b">readv()</code> can be completed immediately (because it is known that its execution does not stop). So subsequent operation was compeleted first (<code class="kk kl km kn ko b">IORING_OP_TIMEOUT</code> was ignored for the time being).<br>As a test, check that <code class="kk kl km kn ko b">readv()</code> is executed synchronously (= in the handler of the system call) with the following systemtap[¹] script.</p><p id="ae37" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">[¹]: A tool that allows you to flexibly execute scripts, such as tracing Kernel (but not only) functions and outputting variables at the traced points. I love this tool because Kernel debugging is a hassle.</p><pre class="kq kr ks kt ku kv kw kx"><span id="8a5d" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">#!/usr/bin/stap</span><span id="c6fb" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">probe kernel.function("io_read@/build/linux-b4NE0x/linux-5.8.0/fs/io_uring.c:2710"){<br>  printf("%s\n",task_execname(task_current()))<br>}</span></pre><p id="96cc" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">↓ This is the output when the previous program (name of the file is <code class="kk kl km kn ko b">sample</code>) is executed while above systemtap script is being executed. If it is asynchronous, it is easy to imagine that the execution task is registered in some worker, but since it is executed synchronously here, the name of the executable file which called the system call is printed.</p><pre class="kq kr ks kt ku kv kw kx"><span id="a26c" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">$ sudo stap -g ./<strong class="ko gb">sample</strong>.stp<br><strong class="ko gb">sample</strong></span></pre><figure class="kq kr ks kt ku hs fi fj paragraph-image"><div role="button" tabindex="0" class="ht hu aq hv x hw"><div class="fi fj lg"><div class="ll s aq kk"><div class="lm ln s"><div class="pq sh eh eu eq ez x li lj lk"><img alt="" class="eh eu eq ez x lo lp lq" src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/1_eDQhEUjvJmCxETqhzH_vgQ.png" width="700" height="686" role="presentation"></div><img alt="" class="er lh eh eu eq ez x t" width="700" height="686" role="presentation"><noscript><img alt="" class="eh eu eq ez x" src="https://miro.medium.com/max/1400/1*eDQhEUjvJmCxETqhzH_vgQ.png" width="700" height="686" srcSet="https://miro.medium.com/max/552/1*eDQhEUjvJmCxETqhzH_vgQ.png 276w, https://miro.medium.com/max/1104/1*eDQhEUjvJmCxETqhzH_vgQ.png 552w, https://miro.medium.com/max/1280/1*eDQhEUjvJmCxETqhzH_vgQ.png 640w, https://miro.medium.com/max/1400/1*eDQhEUjvJmCxETqhzH_vgQ.png 700w" sizes="700px" role="presentation"/></noscript></div></div></div></div></figure><p id="7d01" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">So where did <code class="kk kl km kn ko b">IORING_OP_TIMEOUT</code> go? The answer is “<strong class="ib gb">passed to the Kernel Thread because it was determined that asynchronous execution was needed</strong>”. There are several criteria for this, and if they meet, they will be enqueued into the Queue for asynchronous execution. Here are some examples.</p><p id="1830" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">1. When the force async flag is enabled</p><pre class="kq kr ks kt ku kv kw kx"><span id="ac66" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">} else if (req-&gt;flags &amp; REQ_F_FORCE_ASYNC) {<br>  ......<br>  /*<br>   * Never try inline submit of IOSQE_ASYNC is set, go straight<br>   * to async execution.<br>   */<br>  req-&gt;work.flags |= IO_WQ_WORK_CONCURRENT;<br>  io_queue_async_work(req);</span></pre><p id="ea51" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><a href="https://elixir.bootlin.com/linux/v5.6.19/source/fs/io_uring.c#L4825" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://elixir.bootlin.com/linux/v5.6.19/source/fs/io_uring.c#L4825</a></p><p id="d3d0" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">2. Decisions by the logic prepared for each operation. (e.g. Add IOCB_NOWAIT flag when calling <code class="kk kl km kn ko b">readv()</code> and return EAGAIN if execution is expected to stop)</p><pre class="kq kr ks kt ku kv kw kx"><span id="044e" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">static int io_read(struct io_kiocb *req, struct io_kiocb **nxt,<br>     bool force_nonblock)<br>{<br> ......<br> ret = rw_verify_area(READ, req-&gt;file, &amp;kiocb-&gt;ki_pos, iov_count);<br> if (!ret) {<br>  ssize_t ret2;</span><span id="e200" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">if (req-&gt;file-&gt;f_op-&gt;read_iter)<br>   ret2 = call_read_iter(req-&gt;file, kiocb, &amp;iter);<br>  else<br>   ret2 = loop_rw_iter(READ, req-&gt;file, kiocb, &amp;iter);</span><span id="2eee" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">/* Catch -EAGAIN return for forced non-blocking submission */<br>  if (!force_nonblock || ret2 != -EAGAIN) {<br>   kiocb_done(kiocb, ret2, nxt, req-&gt;in_async);<br>  } else {<br>copy_iov:<br>   ret = io_setup_async_rw(req, io_size, iovec,<br>      inline_vecs, &amp;iter);<br>   if (ret)<br>    goto out_free;<br>   return -EAGAIN;<br>  }<br> }<br>    ......<br>}</span></pre><p id="181a" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><a href="https://elixir.bootlin.com/linux/v5.6.19/source/fs/io_uring.c#L2224" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://elixir.bootlin.com/linux/v5.6.19/source/fs/io_uring.c#L2224</a></p><p id="647f" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">When EAGAIN is returned, it is enqueued into the Queue for asynchronous execution (if it is a type of operation that uses file descriptors, it gets references to the <code class="kk kl km kn ko b">file</code> structure here).</p><pre class="kq kr ks kt ku kv kw kx"><span id="b0a0" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">static void __io_queue_sqe(struct io_kiocb *req, const struct io_uring_sqe *sqe)<br>{<br> ......</span><span id="f59c" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">ret = io_issue_sqe(req, sqe, &amp;nxt, true);</span><span id="eba2" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">/*<br>  * We async punt it if the file wasn't marked NOWAIT, or if the file<br>  * doesn't support non-blocking read/write attempts<br>  */<br> if (ret == -EAGAIN &amp;&amp; (!(req-&gt;flags &amp; REQ_F_NOWAIT) ||<br>     (req-&gt;flags &amp; REQ_F_MUST_PUNT))) {<br>punt:<br>  if (io_op_defs[req-&gt;opcode].file_table) {<br>   ret = io_grab_files(req);<br>   if (ret)<br>    goto err;<br>  }</span><span id="4232" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">/*<br>   * Queued up for async execution, worker will release<br>   * submit reference when the iocb is actually submitted.<br>   */<br>  io_queue_async_work(req);<br>  goto done_req;<br> }<br> ......<br>}</span></pre><p id="ee2e" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><a href="https://elixir.bootlin.com/linux/v5.6.19/source/fs/io_uring.c#L4741" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://elixir.bootlin.com/linux/v5.6.19/source/fs/io_uring.c#L4741</a></p><pre class="kq kr ks kt ku kv kw kx"><span id="cc5c" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">static int io_issue_sqe(struct io_kiocb *req, const struct io_uring_sqe *sqe,<br>   struct io_kiocb **nxt, bool force_nonblock)<br>{<br> struct io_ring_ctx *ctx = req-&gt;ctx;<br> int ret;</span><span id="c0fa" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">switch (req-&gt;opcode) {<br> case IORING_OP_NOP:<br>  ret = io_nop(req);<br>  break;<br> case IORING_OP_READV:<br> case IORING_OP_READ_FIXED:<br> case IORING_OP_READ:<br>  if (sqe) {<br>   ret = io_read_prep(req, sqe, force_nonblock);<br>   if (ret &lt; 0)<br>    break;<br>  }<br>  ret = io_read(req, nxt, force_nonblock);<br>  break;</span></pre><p id="8a42" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><a href="https://elixir.bootlin.com/linux/v5.6.19/source/fs/io_uring.c#L4314" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://elixir.bootlin.com/linux/v5.6.19/source/fs/io_uring.c#L4314</a></p><p id="bafb" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">3. When the <code class="kk kl km kn ko b">IOSQE_IO_LINK|IOSQE_IO_HARDLINK</code> flag is used(the execution order is specified) and the operation whose execution order is earlier is determined to require asynchronous execution.</p><p id="d676" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">(Connect as a link as described in the code below, execute in order, and if condition 2 is met in the middle, whole link will be enqueued into the asynchronous execution queue)</p><pre class="kq kr ks kt ku kv kw kx"><span id="e80f" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">static bool io_submit_sqe(struct io_kiocb *req, const struct io_uring_sqe *sqe,<br>     struct io_submit_state *state, struct io_kiocb **link)<br>{<br> ......<br> /*<br>  * If we already have a head request, queue this one for async<br>  * submittal once the head completes. If we don't have a head but<br>  * IOSQE_IO_LINK is set in the sqe, start a new head. This one will be<br>  * submitted sync once the chain is complete. If none of those<br>  * conditions are true (normal request), then just queue it.<br>  */<br> if (*link) {<br>  ......<br>  list_add_tail(&amp;req-&gt;link_list, &amp;head-&gt;link_list);</span><span id="d817" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">/* last request of a link, enqueue the link */<br>  if (!(sqe_flags &amp; (IOSQE_IO_LINK|IOSQE_IO_HARDLINK))) {<br>   io_queue_link_head(head);<br>   *link = NULL;<br>  }<br> } else {<br>  ......<br>  if (sqe_flags &amp; (IOSQE_IO_LINK|IOSQE_IO_HARDLINK)) {<br>   req-&gt;flags |= REQ_F_LINK;<br>   INIT_LIST_HEAD(&amp;req-&gt;link_list);</span><span id="866a" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">if (io_alloc_async_ctx(req)) {<br>    ret = -EAGAIN;<br>    goto err_req;<br>   }<br>   ret = io_req_defer_prep(req, sqe);<br>   if (ret)<br>    req-&gt;flags |= REQ_F_FAIL_LINK;<br>   *link = req;<br>  } else {<br>   io_queue_sqe(req, sqe);<br>  }<br> }</span><span id="3352" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">return true;<br>}</span></pre><p id="4b99" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><a href="https://elixir.bootlin.com/linux/v5.6.19/source/fs/io_uring.c#L4858" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://elixir.bootlin.com/linux/v5.6.19/source/fs/io_uring.c#L4858</a></p><p id="9bc9" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Strictly speaking, <code class="kk kl km kn ko b">IORING_OP_TIMEOUT</code> is a little special and does not return EAGAIN like shown in 2. But (I think) it is easy to understand, so I use it as a sample.<br>As shown below, by linking an operation that requires asynchronous execution (<code class="kk kl km kn ko b">IORING_OP_TIMEOUT</code>) with another operation, you can see that the previous <code class="kk kl km kn ko b">IORING_OP_READV</code> is certainly executed after waiting for 1 second.</p><p id="10dd" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Add <code class="kk kl km kn ko b">IOSQE_IO_HARDLINK</code> flag to the <code class="kk kl km kn ko b">IORING_OP_TIMEOUT</code> operation in the sample code above to clarify that it is linked to the subsequent operation.</p><pre class="kq kr ks kt ku kv kw kx"><span id="7821" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">48c48<br>&lt;     //.flags = IOSQE_IO_HARDLINK,<br>---<br>&gt;     .flags = IOSQE_IO_HARDLINK,</span></pre><p id="1067" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Execution result</p><pre class="kq kr ks kt ku kv kw kx"><span id="d5f9" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">$ ./sample<br>Waiting.<br>Waiting.<br>Waiting.<br>Waiting.<br>Waiting.<br>Waiting.<br>Waiting.<br>Waiting.<br>Waiting.<br>READV executed.</span></pre><p id="fa30" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">At this time, if you display the name of the process that is executing <code class="kk kl km kn ko b">io_read()</code> in the same way as before, you will get the following output.</p><pre class="kq kr ks kt ku kv kw kx"><span id="7ce9" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">$ sudo stap -g ./sample.stp<br>io_wqe_worker-0</span></pre><p id="3695" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">As you can see by looking at the process list, this is a Kernel Thread.</p><pre class="kq kr ks kt ku kv kw kx"><span id="6625" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">$ ps aux | grep -A 2 -m 1 sample<br>garyo     131388  0.0  0.0   2492  1412 pts/1    S+   19:03   0:00 ./sample<br>root      131389  0.0  0.0      0     0 ?        S    19:03   0:00 [io_wq_manager]<br>root      131390  0.0  0.0      0     0 ?        S    19:03   0:00 [io_wqe_worker-0]</span></pre><p id="5ab2" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Hereafter, this Kernel Thread will be referred to as a “worker”. This worker is generated by the following code and then, dequeues and executes the asynchronous execution tasks from Queue.</p><pre class="kq kr ks kt ku kv kw kx"><span id="377c" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">static bool create_io_worker(struct io_wq *wq, struct io_wqe *wqe, int index)<br>{<br> ......</span><span id="91ac" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">worker-&gt;task = kthread_create_on_node(io_wqe_worker, worker, wqe-&gt;node,<br>    "io_wqe_worker-%d/%d", index, wqe-&gt;node);<br> ......<br>}</span></pre><p id="64a9" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><a href="https://elixir.bootlin.com/linux/v5.6.19/source/fs/io-wq.c#L621" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://elixir.bootlin.com/linux/v5.6.19/source/fs/io-wq.c#L621</a></p><blockquote class="lr ls lt"><p id="27e5" class="hz ia lu ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><em class="ga">Aside: As explained earlier, </em><code class="kk kl km kn ko b"><em class="ga">IORING_OP_TIMEOUT</em></code><em class="ga"> behaves slightly differently from the figure below, but it is described as such for simplicity. Strictly speaking, when </em><code class="kk kl km kn ko b"><em class="ga">io_timeout()</em></code><em class="ga"> is called, it sets </em><code class="kk kl km kn ko b"><em class="ga">io_timeout_fn()</em></code><em class="ga"> in the handler and starts the timer. After the time set by the timer has elapsed, </em><code class="kk kl km kn ko b"><em class="ga">io_timeout_fn()</em></code><em class="ga"> is called to load the operations connected to the link in the asynchronous execution queue. In other words, </em><code class="kk kl km kn ko b"><em class="ga">IORING_OP_TIMEOUT</em></code><em class="ga"> itself is not enqueued in the asynchronous execution queue. TIMEOUT is used in the explanation so that it is easy to imagine that execution will stop.</em></p></blockquote><figure class="kq kr ks kt ku hs fi fj paragraph-image"><div role="button" tabindex="0" class="ht hu aq hv x hw"><div class="fi fj lv"><div class="ll s aq kk"><div class="lw ln s"><div class="pq sh eh eu eq ez x li lj lk"><img alt="" class="eh eu eq ez x lo lp lq" src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/1_r97ABC6g0FPqn1sSyg17cA.png" width="700" height="721" role="presentation"></div><img alt="" class="er lh eh eu eq ez x t" width="700" height="721" role="presentation"><noscript><img alt="" class="eh eu eq ez x" src="https://miro.medium.com/max/1400/1*r97ABC6g0FPqn1sSyg17cA.png" width="700" height="721" srcSet="https://miro.medium.com/max/552/1*r97ABC6g0FPqn1sSyg17cA.png 276w, https://miro.medium.com/max/1104/1*r97ABC6g0FPqn1sSyg17cA.png 552w, https://miro.medium.com/max/1280/1*r97ABC6g0FPqn1sSyg17cA.png 640w, https://miro.medium.com/max/1400/1*r97ABC6g0FPqn1sSyg17cA.png 700w" sizes="700px" role="presentation"/></noscript></div></div></div></div></figure><p id="c24b" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><strong class="ib gb">Precautions when offloading I/O operations to the Kernel</strong></p><p id="5518" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">It was found out that asynchronous processing is performed by a worker running as a Kernel Thread. However, there is a precaution here. Since worker is runninng as a Kernel Thread, the execution context is different from the thread which calls io_uring related system calls.<br>Here, the “execution context” means the <code class="kk kl km kn ko b">task_struct</code> structure associated with the process and various information associated with it.<br>For example, <a href="https://elixir.bootlin.com/linux/v5.6.19/source/include/linux/sched.h#L732" class="ea ix" target="_blank" rel="noopener ugc nofollow">mm</a> (Manage the virtual memory space of the process) , <a href="https://elixir.bootlin.com/linux/v5.6.19/source/include/linux/sched.h#L883" class="ea ix" target="_blank" rel="noopener ugc nofollow">cred</a> (holds UID/GID/Capability),<a href="https://elixir.bootlin.com/linux/v5.6.19/source/include/linux/sched.h#L913" class="ea ix" target="_blank" rel="noopener ugc nofollow">files_struct</a> (holds a table for file descriptors. There’s an array of <code class="kk kl km kn ko b">file</code> structure in <code class="kk kl km kn ko b">files_struct</code> structure, and file descriptor is its index) and so on.</p><p id="6ef0" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Of course, if it doesn’t refer to these structures in the thread that calls the system call, it may refer to the wrong virtual memory or file descriptor table, or issue I/O operations with Kernel Thread privileges (≒ root) [²].</p><p id="eafe" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">[²]: By the way, this was an actual vulnerability, and at that time it forgot to switch cred, and operations were able to be executed with root privileges. Although the operation equivalent to open <code class="kk kl km kn ko b">open()</code> was not implemented at that time, it was possible to notify the privilege in sendmsg’s SCM_CREDENTIALS option that notifies the sender’s authority. It is a problem around D-Bus because the authority is confirmed by it. <a href="https://www.exploit-db.com/exploits/47779" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://www.exploit-db.com/exploits/47779</a></p><p id="f8da" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Therefore, in io_uring, those references are passed to the worker so that the worker shares the execution context by switching its own context before execution. For example, you can see that then references to <code class="kk kl km kn ko b">mm</code> and <code class="kk kl km kn ko b">cred</code> are passed to the <code class="kk kl km kn ko b">req-&gt;work</code> in the following code.</p><pre class="kq kr ks kt ku kv kw kx"><span id="2428" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">static inline void io_req_work_grab_env(struct io_kiocb *req,<br>     const struct io_op_def *def)<br>{<br> if (!req-&gt;work.mm &amp;&amp; def-&gt;needs_mm) {<br>  mmgrab(current-&gt;mm);<br>  req-&gt;work.mm = current-&gt;mm;<br> }<br> if (!req-&gt;work.creds)<br>  req-&gt;work.creds = get_current_cred();<br> if (!req-&gt;work.fs &amp;&amp; def-&gt;needs_fs) {<br>  spin_lock(&amp;current-&gt;fs-&gt;lock);<br>  if (!current-&gt;fs-&gt;in_exec) {<br>   req-&gt;work.fs = current-&gt;fs;<br>   req-&gt;work.fs-&gt;users++;<br>  } else {<br>   req-&gt;work.flags |= IO_WQ_WORK_CANCEL;<br>  }<br>  spin_unlock(&amp;current-&gt;fs-&gt;lock);<br> }<br> if (!req-&gt;work.task_pid)<br>  req-&gt;work.task_pid = task_pid_vnr(current);<br>}</span></pre><p id="71ff" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><a href="https://elixir.bootlin.com/linux/v5.6.19/source/fs/io_uring.c#L910" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://elixir.bootlin.com/linux/v5.6.19/source/fs/io_uring.c#L910</a></p><p id="b575" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">You can see that the reference to <code class="kk kl km kn ko b">files_struct</code> is passed to the <code class="kk kl km kn ko b">req-&gt;work</code> in the following code.</p><pre class="kq kr ks kt ku kv kw kx"><span id="00f0" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">static int io_grab_files(struct io_kiocb *req)<br>{<br> ......<br> if (fcheck(ctx-&gt;ring_fd) == ctx-&gt;ring_file) {<br>  list_add(&amp;req-&gt;inflight_entry, &amp;ctx-&gt;inflight_list);<br>  req-&gt;flags |= REQ_F_INFLIGHT;<br>  req-&gt;work.files = current-&gt;files;<br>  ret = 0;<br> }<br> ......<br>}</span></pre><p id="98a1" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><a href="https://elixir.bootlin.com/linux/v5.6.19/source/fs/io_uring.c#L4634" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://elixir.bootlin.com/linux/v5.6.19/source/fs/io_uring.c#L4634</a></p><p id="a567" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Then, before execution, these are replaced with the contents of the worker’s <code class="kk kl km kn ko b">current</code> (a macro that gets the <code class="kk kl km kn ko b">task_struct</code> currently running thread).</p><pre class="kq kr ks kt ku kv kw kx"><span id="227c" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">static void io_worker_handle_work(struct io_worker *worker)<br> __releases(wqe-&gt;lock)<br>{<br> struct io_wq_work *work, *old_work = NULL, *put_work = NULL;<br> struct io_wqe *wqe = worker-&gt;wqe;<br> struct io_wq *wq = wqe-&gt;wq;</span><span id="7715" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">do {<br>  ......</span><span id="a3d1" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">if (work-&gt;files &amp;&amp; current-&gt;files != work-&gt;files) {<br>   task_lock(current);<br>   current-&gt;files = work-&gt;files;<br>   task_unlock(current);<br>  }<br>  if (work-&gt;fs &amp;&amp; current-&gt;fs != work-&gt;fs)<br>   current-&gt;fs = work-&gt;fs;<br>  if (work-&gt;mm != worker-&gt;mm)<br>   io_wq_switch_mm(worker, work);<br>  if (worker-&gt;cur_creds != work-&gt;creds)<br>   io_wq_switch_creds(worker, work);<br>  ......<br>  work-&gt;func(&amp;work);<br>  ......<br> } while (1);<br>}</span></pre><p id="3b72" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><a href="https://elixir.bootlin.com/linux/v5.6.19/source/fs/io-wq.c#L443" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://elixir.bootlin.com/linux/v5.6.19/source/fs/io-wq.c#L443</a></p><figure class="kq kr ks kt ku hs fi fj paragraph-image"><div role="button" tabindex="0" class="ht hu aq hv x hw"><div class="fi fj lx"><div class="ll s aq kk"><div class="ly ln s"><div class="pq sh eh eu eq ez x li lj lk"><img alt="" class="eh eu eq ez x lo lp lq" src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/1_QWqIM-GZDKXEn_OTofMx3A.png" width="700" height="502" role="presentation"></div><img alt="" class="er lh eh eu eq ez x t" width="700" height="502" role="presentation"><noscript><img alt="" class="eh eu eq ez x" src="https://miro.medium.com/max/1400/1*QWqIM-GZDKXEn_OTofMx3A.png" width="700" height="502" srcSet="https://miro.medium.com/max/552/1*QWqIM-GZDKXEn_OTofMx3A.png 276w, https://miro.medium.com/max/1104/1*QWqIM-GZDKXEn_OTofMx3A.png 552w, https://miro.medium.com/max/1280/1*QWqIM-GZDKXEn_OTofMx3A.png 640w, https://miro.medium.com/max/1400/1*QWqIM-GZDKXEn_OTofMx3A.png 700w" sizes="700px" role="presentation"/></noscript></div></div></div></div></figure></div></div></section><div class="n p cz jb jc jd" role="separator"><span class="je hb bx jf jg jh"></span><span class="je hb bx jf jg jh"></span><span class="je hb bx jf jg"></span></div><section class="dp fv fw dk fx"><div class="n p"><div class="ar as at au av fy ax x"><h1 id="0284" class="lz jj ga bc dc ma mb ie jn mc md ii jr me mf mg jv mh mi mj jz mk ml mm kd mn gx" data-selectable-paragraph=""><strong class="cf">Vulnerability explanation</strong></h1><h2 id="3c98" class="ji jj ga bc dc jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke gx" data-selectable-paragraph=""><strong class="cf">Reference counter in files_struct structure when sharing with the worker</strong></h2><p id="d25b" class="hz ia ga ib b ic kf ie if ig kg ii ij ik kh im in io ki iq ir is kj iu iv iw dp gx" data-selectable-paragraph="">Now, let’s move on to the explanation of the vulnerabilities. In the code below (I posted earlier), you can see that the worker is passing a reference to the <code class="kk kl km kn ko b">files_struct</code> structure of the thread executing the system call to the structure that the worker will refer later <strong class="ib gb">without incrementing the reference counter</strong>.</p><pre class="kq kr ks kt ku kv kw kx"><span id="e704" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">static int io_grab_files(struct io_kiocb *req)<br>{<br> ......<br> if (fcheck(ctx-&gt;ring_fd) == ctx-&gt;ring_file) {<br>  list_add(&amp;req-&gt;inflight_entry, &amp;ctx-&gt;inflight_list);<br>  req-&gt;flags |= REQ_F_INFLIGHT;<br>  req-&gt;work.files = current-&gt;files;<br>  ret = 0;<br> }<br> ......<br>}</span></pre><p id="8d74" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><a href="https://elixir.bootlin.com/linux/v5.6.19/source/fs/io_uring.c#L4634" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://elixir.bootlin.com/linux/v5.6.19/source/fs/io_uring.c#L4634</a></p><p id="a6d3" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">By the way, as explained briefly earlier, when enqueueing a task in the Queue for asynchronous execution, the reference to the <code class="kk kl km kn ko b">file</code> structure is retained first from the specified file descriptor (passed to the <code class="kk kl km kn ko b">io_kiocb</code> structure).</p><pre class="kq kr ks kt ku kv kw kx"><span id="7b59" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">static int io_req_set_file(struct io_submit_state *state, struct io_kiocb *req,<br>      const struct io_uring_sqe *sqe)<br>{<br> struct io_ring_ctx *ctx = req-&gt;ctx;<br> unsigned flags;<br> int fd;</span><span id="5455" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">flags = READ_ONCE(sqe-&gt;flags);<br> fd = READ_ONCE(sqe-&gt;fd);</span><span id="a76c" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">if (!io_req_needs_file(req, fd))<br>  return 0;</span><span id="c93b" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">if (flags &amp; IOSQE_FIXED_FILE) {<br>  if (unlikely(!ctx-&gt;file_data ||<br>      (unsigned) fd &gt;= ctx-&gt;nr_user_files))<br>   return -EBADF;<br>  fd = array_index_nospec(fd, ctx-&gt;nr_user_files);<br>  req-&gt;file = io_file_from_index(ctx, fd);<br>  if (!req-&gt;file)<br>   return -EBADF;<br>  req-&gt;flags |= REQ_F_FIXED_FILE;<br>  percpu_ref_get(&amp;ctx-&gt;file_data-&gt;refs);<br> } else {<br>  if (req-&gt;needs_fixed_file)<br>   return -EBADF;<br>  trace_io_uring_file_get(ctx, fd);<br>  req-&gt;file = io_file_get(state, fd);<br>  if (unlikely(!req-&gt;file))<br>   return -EBADF;<br> }</span><span id="1916" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">return 0;<br>}</span></pre><p id="7ca9" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><a href="https://elixir.bootlin.com/linux/v5.6.19/source/fs/io_uring.c#L4599" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://elixir.bootlin.com/linux/v5.6.19/source/fs/io_uring.c#L4599</a></p><figure class="kq kr ks kt ku hs fi fj paragraph-image"><div role="button" tabindex="0" class="ht hu aq hv x hw"><div class="fi fj mo"><div class="ll s aq kk"><div class="mp ln s"><div class="pq sh eh eu eq ez x li lj lk"><img alt="" class="eh eu eq ez x lo lp lq" src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/1_65Fa3NkAmqj_iQ82kxigqw.png" width="700" height="360" role="presentation"></div><img alt="" class="er lh eh eu eq ez x t" width="700" height="360" role="presentation"><noscript><img alt="" class="eh eu eq ez x" src="https://miro.medium.com/max/1400/1*65Fa3NkAmqj_iQ82kxigqw.png" width="700" height="360" srcSet="https://miro.medium.com/max/552/1*65Fa3NkAmqj_iQ82kxigqw.png 276w, https://miro.medium.com/max/1104/1*65Fa3NkAmqj_iQ82kxigqw.png 552w, https://miro.medium.com/max/1280/1*65Fa3NkAmqj_iQ82kxigqw.png 640w, https://miro.medium.com/max/1400/1*65Fa3NkAmqj_iQ82kxigqw.png 700w" sizes="700px" role="presentation"/></noscript></div></div></div></div></figure><p id="4fdb" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">So the worker does not have to retrieve it from the file descriptor again and does not need to refer to the <code class="kk kl km kn ko b">files_struct</code> structure. If so, it seems that there is no problem that the reference counter of the <code class="kk kl km kn ko b">files_struct</code> structure is not incremented(because it is not used). <br>But this assumption is not true in Linux Kernel 5.5 and later. This is because system calls that affect file descriptor tables, such as <code class="kk kl km kn ko b">open</code>/<code class="kk kl km kn ko b">close</code>/<code class="kk kl km kn ko b">accept</code> , are now available via io_uring. Obviously, these system calls affect the file descriptor table, so it looks like something can be used for exploitation However,</p><ul class=""><li id="17b3" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw iy iz ja gx" data-selectable-paragraph="">Even if you simply calls <code class="kk kl km kn ko b">open</code>/<code class="kk kl km kn ko b">close</code>/<code class="kk kl km kn ko b">accept</code> etc., nothing can happen if the <code class="kk kl km kn ko b">files_struct</code> structure is available. <br> — Of course, system calls have <strong class="ib gb">countermeasures when handling the same file by multiple threads</strong>, so it is not possible to simply cause a race condition between the calling thread and the worker.</li><li id="7df4" class="hz ia ga ib b ic mq ie if ig mr ii ij ik ms im in io mt iq ir is mu iu iv iw iy iz ja gx" data-selectable-paragraph="">By freeing the <code class="kk kl km kn ko b">files_struct</code> with setting reference counter to 0, a new process may reuse it as a <code class="kk kl km kn ko b">files_struct</code> for that process. The worker will get a reference to the new process’s <code class="kk kl km kn ko b">files_struct</code> when reused.<br> — But <code class="kk kl km kn ko b">file</code> structure is already obtained from the file descriptor, ̶s̶o̶ ̶i̶t̶ ̶c̶a̶n̶n̶o̶t̶ ̶g̶e̶t̶ ̶a̶ ̶r̶e̶f̶e̶r̶e̶n̶c̶e̶ ̶t̶o̶ ̶t̶h̶e̶ ̶f̶i̶l̶e̶ ̶s̶t̶r̶u̶c̶t̶u̶r̶e̶ ̶o̶f̶ ̶t̶h̶e̶ ̶n̶e̶w̶ ̶p̶r̶o̶c̶e̶s̶s̶ (This was a lie. I’ll describe in “aside” part.)<br> — It’s possible to insert a <code class="kk kl km kn ko b">file</code> structure into the file descriptor table of a new process by opening a file. But it will not be referenced. (Because people don’t use fixed file descriptor number while programming.)</li></ul><p id="74b4" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Here, I will explain the mechanism around the reference counter of the <code class="kk kl km kn ko b">file</code> structure in <strong class="ib gb">countermeasures when handling the same file by multiple threads</strong>. Yes, it’s a spoiler. The conclusion will be that it can actually be abused.</p><p id="8979" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><strong class="ib gb">Mechanism of reference counter in open/close system call</strong></p><p id="0405" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">To understand how the reference counters in the <code class="kk kl km kn ko b">file</code> structure work, we first need to understand what open/close actually does. Of course, the behavior changes depending on the actual file to be opened, but the following can be said in common.</p><p id="bcd5" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">open:</p><ol class=""><li id="49af" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw mv iz ja gx" data-selectable-paragraph="">Create a file structure and set the reference counter to 1</li><li id="2750" class="hz ia ga ib b ic mq ie if ig mr ii ij ik ms im in io mt iq ir is mu iu iv iw mv iz ja gx" data-selectable-paragraph="">Regesiter it to the file descriptor table</li></ol><p id="3166" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Create a <code class="kk kl km kn ko b">file</code> structure and set the reference counter to 1</p><pre class="kq kr ks kt ku kv kw kx"><span id="7380" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">static struct file *__alloc_file(int flags, const struct cred *cred)<br>{<br> struct file *f;<br> int error;</span><span id="5015" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">f = kmem_cache_zalloc(filp_cachep, GFP_KERNEL);<br> ......<br> atomic_long_set(&amp;f-&gt;f_count, 1);<br> ......<br> return f;<br>}</span></pre><p id="0d83" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><a href="https://elixir.bootlin.com/linux/v5.6.19/source/fs/file_table.c#L96" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://elixir.bootlin.com/linux/v5.6.19/source/fs/file_table.c#L96</a></p><p id="a3b5" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Regesiter it to the file descriptor table(fd_install)</p><pre class="kq kr ks kt ku kv kw kx"><span id="0677" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">static long do_sys_openat2(int dfd, const char __user *filename,<br>      struct open_how *how)<br>{<br> ......<br> fd = get_unused_fd_flags(how-&gt;flags);<br> if (fd &gt;= 0) {<br>  struct file *f = do_filp_open(dfd, tmp, &amp;op);<br>  if (IS_ERR(f)) {<br>   put_unused_fd(fd);<br>   fd = PTR_ERR(f);<br>  } else {<br>   fsnotify_open(f);<br>   fd_install(fd, f);<br>  }<br> }<br> putname(tmp);<br> return fd;<br>}</span></pre><p id="2a59" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><a href="https://elixir.bootlin.com/linux/v5.6.19/source/fs/open.c#L1130" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://elixir.bootlin.com/linux/v5.6.19/source/fs/open.c#L1130</a></p><p id="dbef" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">close:</p><ol class=""><li id="65fa" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw mv iz ja gx" data-selectable-paragraph="">Delete from file descriptor table</li><li id="e4e5" class="hz ia ga ib b ic mq ie if ig mr ii ij ik ms im in io mt iq ir is mu iu iv iw mv iz ja gx" data-selectable-paragraph="">Decrement the reference counter of the file structure.(fput)</li></ol><p id="072b" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Delete from file descriptor table</p><pre class="kq kr ks kt ku kv kw kx"><span id="3f26" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">int __close_fd(struct files_struct *files, unsigned fd)<br>{<br> struct file *file;<br> struct fdtable *fdt;</span><span id="fd05" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">spin_lock(&amp;files-&gt;file_lock);<br> fdt = files_fdtable(files);<br> if (fd &gt;= fdt-&gt;max_fds)<br>  goto out_unlock;<br> file = fdt-&gt;fd[fd];<br> if (!file)<br>  goto out_unlock;<br> rcu_assign_pointer(fdt-&gt;fd[fd], NULL);<br> __put_unused_fd(files, fd);<br> spin_unlock(&amp;files-&gt;file_lock);<br> return filp_close(file, files);</span><span id="cbf5" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">out_unlock:<br> spin_unlock(&amp;files-&gt;file_lock);<br> return -EBADF;<br>}</span></pre><p id="2ab4" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><a href="https://elixir.bootlin.com/linux/v5.6.19/source/fs/file.c#L626" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://elixir.bootlin.com/linux/v5.6.19/source/fs/file.c#L626</a></p><p id="5553" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Decrement the reference counter of the <code class="kk kl km kn ko b">file</code>file structure.(fput)</p><pre class="kq kr ks kt ku kv kw kx"><span id="7778" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">int filp_close(struct file *filp, fl_owner_t id)<br>{<br> ......<br> fput(filp);<br> return retval;<br>}</span></pre><p id="b72b" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><a href="https://elixir.bootlin.com/linux/v5.6.19/source/fs/open.c#L1239" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://elixir.bootlin.com/linux/v5.6.19/source/fs/open.c#L1239</a></p><p id="e685" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">The important thing here is the <code class="kk kl km kn ko b">fget()</code>/<code class="kk kl km kn ko b">fput()</code> function (although <code class="kk kl km kn ko b">fget()</code> is not used in <code class="kk kl km kn ko b">open</code>). These increment/decrement the reference counter of the <code class="kk kl km kn ko b">file</code> structure, and <code class="kk kl km kn ko b">fput()</code> frees the memory of the <code class="kk kl km kn ko b">file</code> structure when the reference reaches 0. Thanks to this mechanism, if it gets the <code class="kk kl km kn ko b">file</code> structure by <code class="kk kl km kn ko b">fget()</code>, the reference counter will not be 0 even if it is closed before <code class="kk kl km kn ko b">fput()</code> (counter should be 1 at the time of <code class="kk kl km kn ko b">open</code>, 2 after calling <code class="kk kl km kn ko b">fget()</code>, and even if it’s <code class="kk kl km kn ko b">close</code>-ed at this time, it will be 1.). Therefore, it means that there is no problem even if it is <code class="kk kl km kn ko b">closed</code> during use.</p><p id="b1d0" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">For example, when mapping a file to memory with <code class="kk kl km kn ko b">mmap</code> , it would be a problem if the memory was released before calling <code class="kk kl km kn ko b">munmap</code> even after <code class="kk kl km kn ko b">close</code>. Therefore, <code class="kk kl km kn ko b">fget()</code> is used in <code class="kk kl km kn ko b">mmap</code> to prevent the memory from being released.</p><pre class="kq kr ks kt ku kv kw kx"><span id="28a0" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">unsigned long ksys_mmap_pgoff(unsigned long addr, unsigned long len,<br>         unsigned long prot, unsigned long flags,<br>         unsigned long fd, unsigned long pgoff)<br>{<br> struct file *file = NULL;<br> unsigned long retval;</span><span id="6ba4" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">if (!(flags &amp; MAP_ANONYMOUS)) {<br>  audit_mmap_fd(fd, flags);<br>  file = fget(fd);<br> ......<br>}</span></pre><p id="12aa" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><a href="https://elixir.bootlin.com/linux/v5.6.19/source/mm/mmap.c#L1551" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://elixir.bootlin.com/linux/v5.6.19/source/mm/mmap.c#L1551</a></p><p id="25fb" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><strong class="ib gb">fdget() which doesn’t change reference counter</strong></p><p id="0441" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">There is also a function called <code class="kk kl km kn ko b">fdget()</code>/<code class="kk kl km kn ko b">fdput()</code> that is frequently used to get a reference to a <code class="kk kl km kn ko b">file</code> structure (which is rather frequently used inside system call handlers).</p><p id="59a7" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">For example, in the <code class="kk kl km kn ko b">read</code> system call, the <code class="kk kl km kn ko b">file</code> structure is used between <code class="kk kl km kn ko b">fdget()</code>(<code class="kk kl km kn ko b">fdget_pos()</code>) and <code class="kk kl km kn ko b">fdput()</code>(<code class="kk kl km kn ko b">fdput_pos()</code>) as shown below.</p><pre class="kq kr ks kt ku kv kw kx"><span id="726d" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">ssize_t ksys_read(unsigned int fd, char __user *buf, size_t count)<br>{<br> struct fd f = fdget_pos(fd);<br> ssize_t ret = -EBADF;</span><span id="f353" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">if (f.file) {<br>  loff_t pos, *ppos = file_ppos(f.file);<br>  if (ppos) {<br>   pos = *ppos;<br>   ppos = &amp;pos;<br>  }<br>  ret = vfs_read(f.file, buf, count, ppos);<br>  if (ret &gt;= 0 &amp;&amp; ppos)<br>   f.file-&gt;f_pos = pos;<br>  fdput_pos(f);<br> }<br> return ret;<br>}</span><span id="f336" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">SYSCALL_DEFINE3(read, unsigned int, fd, char __user *, buf, size_t, count)<br>{<br> return ksys_read(fd, buf, count);<br>}</span></pre><p id="b6ce" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><a href="https://elixir.bootlin.com/linux/v5.6.19/source/fs/read_write.c#L576" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://elixir.bootlin.com/linux/v5.6.19/source/fs/read_write.c#L576</a></p><p id="b468" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">It seems that there is a motivation to not increase or decrease the reference counter of the <code class="kk kl km kn ko b">file</code> structure too often, probably due to the influence of the cacheline. Therefore, <code class="kk kl km kn ko b">fdget()</code> does not increase the reference counter of the <code class="kk kl km kn ko b">file</code> structure under certain conditions. As you can see by tracing the function, <code class="kk kl km kn ko b">fdget()</code> finally calls <code class="kk kl km kn ko b">__fget_light()</code> function. Let’s take a look at the implementation.</p><pre class="kq kr ks kt ku kv kw kx"><span id="c449" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">/*<br> * Lightweight file lookup - no refcnt increment if fd table isn't shared.<br> *<br> * You can use this instead of fget if you satisfy all of the following<br> * conditions:<br> * 1) You must call fput_light before exiting the syscall and returning control<br> *    to userspace (i.e. you cannot remember the returned struct file * after<br> *    returning to userspace).<br> * 2) You must not call filp_close on the returned struct file * in between<br> *    calls to fget_light and fput_light.<br> * 3) You must not clone the current task in between the calls to fget_light<br> *    and fput_light.<br> *<br> * The fput_needed flag returned by fget_light should be passed to the<br> * corresponding fput_light.<br> */<br>static unsigned long __fget_light(unsigned int fd, fmode_t mask)<br>{<br> struct files_struct *files = current-&gt;files;<br> struct file *file;</span><span id="ed7d" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">if (atomic_read(&amp;files-&gt;count) == 1) {<br>  file = __fcheck_files(files, fd);<br>  if (!file || unlikely(file-&gt;f_mode &amp; mask))<br>   return 0;<br>  return (unsigned long)file;<br> } else {<br>  file = __fget(fd, mask, 1);<br>  if (!file)<br>   return 0;<br>  return FDPUT_FPUT | (unsigned long)file;<br> }<br>}</span></pre><p id="e14f" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><a href="https://elixir.bootlin.com/linux/v5.6.19/source/fs/file.c#L807" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://elixir.bootlin.com/linux/v5.6.19/source/fs/file.c#L807</a></p><p id="8ebe" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">As commented, this function can only be used if the conditions are met. It also says, “no refcnt increment if fd table isn’t shared”. What does this mean?</p><p id="e001" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Generally, in multithreaded programs, the file descriptor table is shared(<code class="kk kl km kn ko b">&amp;files-&gt;count</code> &gt;=2), and the same file descriptor points to the same file. In this case, for example, the other thread can call the <code class="kk kl km kn ko b">close</code> system call while the <code class="kk kl km kn ko b">read</code> system call is being executed. Therefore, the <code class="kk kl km kn ko b">fdget()</code> of the <code class="kk kl km kn ko b">read</code> system call should increment the reference counter.</p><figure class="kq kr ks kt ku hs fi fj paragraph-image"><div role="button" tabindex="0" class="ht hu aq hv x hw"><div class="fi fj mw"><div class="ll s aq kk"><div class="mx ln s"><div class="pq sh eh eu eq ez x li lj lk"><img alt="" class="eh eu eq ez x lo lp lq" src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/1_rbhptpwTtm45PTAMi1c0qw.png" width="700" height="663" role="presentation"></div><img alt="" class="er lh eh eu eq ez x t" width="700" height="663" role="presentation"><noscript><img alt="" class="eh eu eq ez x" src="https://miro.medium.com/max/1400/1*rbhptpwTtm45PTAMi1c0qw.png" width="700" height="663" srcSet="https://miro.medium.com/max/552/1*rbhptpwTtm45PTAMi1c0qw.png 276w, https://miro.medium.com/max/1104/1*rbhptpwTtm45PTAMi1c0qw.png 552w, https://miro.medium.com/max/1280/1*rbhptpwTtm45PTAMi1c0qw.png 640w, https://miro.medium.com/max/1400/1*rbhptpwTtm45PTAMi1c0qw.png 700w" sizes="700px" role="presentation"/></noscript></div></div></div></div></figure><p id="2532" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">But what if this was a regular single-threaded program? In this case, another system call cannot be interrupted while the <code class="kk kl km kn ko b">read</code> system call is being executed. Therefore, nothing happens even if the reference counter is not increased.<br>For this reason, <strong class="ib gb">it does not increase the reference counter of the file structure unless the file descriptor table is shared</strong>.</p><h1 id="2768" class="lz jj ga bc dc ma my ie jn mc mz ii jr me na mg jv mh nb mj jz mk nc mm kd mn gx" data-selectable-paragraph=""><strong class="cf">Combining vulnerabilities with the fdget() spec</strong></h1><p id="c15a" class="hz ia ga ib b ic kf ie if ig kg ii ij ik kh im in io ki iq ir is kj iu iv iw dp gx" data-selectable-paragraph="">The vulnerability was passing a reference to the <code class="kk kl km kn ko b">files_struct</code> structure to a structure that the worker would later refer to <strong class="ib gb">without increasing the reference counter</strong>. As you may have noticed, this means that if the original program is single- threaded, <strong class="ib gb">although the file descriptor table is shared (with worker), </strong><code class="kk kl km kn ko b"><strong class="ib gb">&amp;files-&gt;count</strong></code><strong class="ib gb"> is 1</strong>. <br>That <code class="kk kl km kn ko b">&amp;files-&gt;count</code> equals to 1 means <code class="kk kl km kn ko b"><strong class="ib gb">fdget()</strong></code><strong class="ib gb"> does not increment the reference counter for the </strong><code class="kk kl km kn ko b"><strong class="ib gb">file</strong></code><strong class="ib gb"> structure</strong>. But, actually the worker can <code class="kk kl km kn ko b">close</code>c the file descriptor associated with the <code class="kk kl km kn ko b">file</code> structure, so <strong class="ib gb">the memory of the </strong><code class="kk kl km kn ko b"><strong class="ib gb">file</strong></code><strong class="ib gb"> structure obtained by </strong><code class="kk kl km kn ko b"><strong class="ib gb">fdget()</strong></code><strong class="ib gb"> may have been freed at some point</strong>.</p><figure class="kq kr ks kt ku hs fi fj paragraph-image"><div role="button" tabindex="0" class="ht hu aq hv x hw"><div class="fi fj nd"><div class="ll s aq kk"><div class="ne ln s"><div class="pq sh eh eu eq ez x li lj lk"><img alt="" class="eh eu eq ez x lo lp lq" src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/0_e-PoInH_R05yW-pz" width="700" height="642" role="presentation"></div><img alt="" class="er lh eh eu eq ez x t" width="700" height="642" role="presentation"><noscript><img alt="" class="eh eu eq ez x" src="https://miro.medium.com/max/1400/0*e-PoInH_R05yW-pz" width="700" height="642" srcSet="https://miro.medium.com/max/552/0*e-PoInH_R05yW-pz 276w, https://miro.medium.com/max/1104/0*e-PoInH_R05yW-pz 552w, https://miro.medium.com/max/1280/0*e-PoInH_R05yW-pz 640w, https://miro.medium.com/max/1400/0*e-PoInH_R05yW-pz 700w" sizes="700px" role="presentation"/></noscript></div></div></div></div></figure><p id="58c7" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">In summary, this vulnerability is as follows.</p><ul class=""><li id="3cb3" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw iy iz ja gx" data-selectable-paragraph="">The aio worker shares the <code class="kk kl km kn ko b">files_struct</code> structure with the calling thread. At this time, the reference counter of the <code class="kk kl km kn ko b">files_struct</code> structure is not incremented.</li><li id="ef01" class="hz ia ga ib b ic mq ie if ig mr ii ij ik ms im in io mt iq ir is mu iu iv iw iy iz ja gx" data-selectable-paragraph="">Since fdget does not increment the reference counter of the <code class="kk kl km kn ko b">file</code> structure when the reference counter of the <code class="kk kl km kn ko b">files_struct</code> structure is 1, the file obtained by <code class="kk kl km kn ko b">fdget()</code> may be closed and freed in the worker (or calling thread).</li><li id="05e9" class="hz ia ga ib b ic mq ie if ig mr ii ij ik ms im in io mt iq ir is mu iu iv iw iy iz ja gx" data-selectable-paragraph="">Since the <code class="kk kl km kn ko b">file</code> structure is freed, UAF occurs where it is handled(e.g. in file-related system call).</li></ul></div></div></section><div class="n p cz jb jc jd" role="separator"><span class="je hb bx jf jg jh"></span><span class="je hb bx jf jg jh"></span><span class="je hb bx jf jg"></span></div><section class="dp fv fw dk fx"><div class="n p"><div class="ar as at au av fy ax x"><h2 id="c351" class="ji jj ga bc dc jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke gx" data-selectable-paragraph=""><strong class="cf">Overview of the PoC</strong></h2><p id="8068" class="hz ia ga ib b ic kf ie if ig kg ii ij ik kh im in io ki iq ir is kj iu iv iw dp gx" data-selectable-paragraph="">The rest thing is just doing a kernel exploit, so there’s not much to explain.</p><p id="54f5" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">If there’s a code block like below, you can use <code class="kk kl km kn ko b">close</code> on the worker side to trigger Use After Free of the <code class="kk kl km kn ko b">file</code> structure (it’s even better if you put a userfaultfd between them).</p><pre class="kq kr ks kt ku kv kw kx"><span id="9487" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">void func(){<br>  struct fd f;<br>  f = fdget();//refcount is not incremented.<br>  /*<br>  Play with f.file :)<br>  */<br>  fdput(f);<br>}</span></pre><p id="d1ca" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Or it’s also possible to exploit by using the memory region of <code class="kk kl km kn ko b">private_data</code> member associated with the <code class="kk kl km kn ko b">file</code> structure (the location to save its own data structure. it contains many kinds of data structure), because it will also be freed. I exploited by overwriting the memory of the <code class="kk kl km kn ko b">map</code> structure used in eBPF which is allocated(overlapped) by calling kmalloc with the same size as <code class="kk kl km kn ko b">map</code> structure.</p><figure class="kq kr ks kt ku hs fi fj paragraph-image"><div role="button" tabindex="0" class="ht hu aq hv x hw"><div class="fi fj nf"><div class="ll s aq kk"><div class="ng ln s"><div class="pq sh eh eu eq ez x li lj lk"><img alt="" class="eh eu eq ez x lo lp lq" src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/1_HVpY7cqdBulyKQRGXkYV5w.png" width="700" height="321" role="presentation"></div><img alt="" class="er lh eh eu eq ez x t" width="700" height="321" role="presentation"><noscript><img alt="" class="eh eu eq ez x" src="https://miro.medium.com/max/1400/1*HVpY7cqdBulyKQRGXkYV5w.png" width="700" height="321" srcSet="https://miro.medium.com/max/552/1*HVpY7cqdBulyKQRGXkYV5w.png 276w, https://miro.medium.com/max/1104/1*HVpY7cqdBulyKQRGXkYV5w.png 552w, https://miro.medium.com/max/1280/1*HVpY7cqdBulyKQRGXkYV5w.png 640w, https://miro.medium.com/max/1400/1*HVpY7cqdBulyKQRGXkYV5w.png 700w" sizes="700px" role="presentation"/></noscript></div></div></div></div></figure></div></div></section><div class="n p cz jb jc jd" role="separator"><span class="je hb bx jf jg jh"></span><span class="je hb bx jf jg jh"></span><span class="je hb bx jf jg"></span></div><section class="dp fv fw dk fx"><div class="n p"><div class="ar as at au av fy ax x"><h2 id="242e" class="ji jj ga bc dc jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke gx" data-selectable-paragraph=""><strong class="cf">Summary</strong></h2><p id="ff14" class="hz ia ga ib b ic kf ie if ig kg ii ij ik kh im in io ki iq ir is kj iu iv iw dp gx" data-selectable-paragraph="">It seems that it was fixed by changing the reference counter of the <code class="kk kl km kn ko b">files_struct</code> structure to increment in the following commit.<br><a href="https://github.com/torvalds/linux/commit/0f2122045b946241a9e549c2a76cea54fa58a7ff" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://github.com/torvalds/linux/commit/0f2122045b946241a9e549c2a76cea54fa58a7ff</a></p></div></div></section><div class="n p cz jb jc jd" role="separator"><span class="je hb bx jf jg jh"></span><span class="je hb bx jf jg jh"></span><span class="je hb bx jf jg"></span></div><section class="dp fv fw dk fx"><div class="n p"><div class="ar as at au av fy ax x"><h2 id="278e" class="ji jj ga bc dc jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke gx" data-selectable-paragraph=""><strong class="cf">As an aside</strong></h2><p id="dbf6" class="hz ia ga ib b ic kf ie if ig kg ii ij ik kh im in io ki iq ir is kj iu iv iw dp gx" data-selectable-paragraph="">While writing this blog, I noticed an important thing. After my report, the following issue was raised, and CVE was assigned there.<br><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2089" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://bugs.chromium.org/p/project-zero/issues/detail?id=2089</a></p><p id="b355" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Apparently, there was another report while the response is delayed because the issue cannot be reproduced well. And it seems that previous one was corrected first. And that seems to have been fixed first.<br>Basically, I am reporting the problematic code with the file name and the number of lines specified, but there seems to be room for improvement in the report content or PoC.</p><p id="b698" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Also, after reading the report on the above URL, I realized that there is a simpler and more interesting Exploit method, so I would like to introduce it briefly.</p><p id="625e" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Even if the worker is running, the reference counter of the <code class="kk kl km kn ko b">files_struct</code> structure is not incremented, so the <code class="kk kl km kn ko b">current-&gt;files-&gt;count</code> of the thread which calls the io_uring-related system call is 1 due to the vulnerability.<br>Also, when updating the executable file with execve as shown in the code below, there is a specification that the <code class="kk kl km kn ko b">files_struct</code> structure is reused under the condition of <code class="kk kl km kn ko b">current-&gt; files-&gt; count == 1</code>.</p><p id="4d32" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><code class="kk kl km kn ko b">load_elf_binary()-&gt;begin_new_exec()-&gt;unshare_files()-&gt;unshare_fd()</code></p><pre class="kq kr ks kt ku kv kw kx"><span id="af22" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">static int unshare_fd(unsigned long unshare_flags, struct files_struct **new_fdp)<br>{<br> struct files_struct *fd = current-&gt;files;<br> int error = 0;</span><span id="ae89" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">if ((unshare_flags &amp; CLONE_FILES) &amp;&amp;<br>     (fd &amp;&amp; atomic_read(&amp;fd-&gt;count) &gt; 1)) {<br>  *new_fdp = dup_fd(fd, &amp;error);<br>  if (!*new_fdp)<br>   return error;<br> }</span><span id="b0d4" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">return 0;<br>}</span></pre><p id="6988" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><a href="https://elixir.bootlin.com/linux/v5.6.19/source/kernel/fork.c#L2883" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://elixir.bootlin.com/linux/v5.6.19/source/kernel/fork.c#L2883</a></p><p id="97d1" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">In other words, if execve is called while the worker is running, the worker will always refer to the <code class="kk kl km kn ko b">files_struct</code> structure of the process after the execve.<br> (Actually I think it’s easy to duplicate an address even if kmem_cache_free&amp;kmem_cache_alloc is called…)</p><p id="10db" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">The process after execve does not always have the same authority as the process before it. For example, if setuid-ed binaries(sudo/su/etc…) are executed, it will become a privileged process after execve. Therefore, by suspending the execution of the worker and then executing sudo or things like that, <strong class="ib gb">the worker can refer to the file descriptor table (in </strong><code class="kk kl km kn ko b"><strong class="ib gb">files_struct</strong></code><strong class="ib gb">) of the privileged process</strong>.</p><figure class="kq kr ks kt ku hs fi fj paragraph-image"><div role="button" tabindex="0" class="ht hu aq hv x hw"><div class="fi fj nh"><div class="ll s aq kk"><div class="ni ln s"><div class="pq sh eh eu eq ez x li lj lk"><img alt="" class="eh eu eq ez x lo lp lq" src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/1_KWE_pxAcrj2KgY7nNoAtVQ.png" width="700" height="631" role="presentation"></div><img alt="" class="er lh eh eu eq ez x t" width="700" height="631" role="presentation"><noscript><img alt="" class="eh eu eq ez x" src="https://miro.medium.com/max/1400/1*KWE_pxAcrj2KgY7nNoAtVQ.png" width="700" height="631" srcSet="https://miro.medium.com/max/552/1*KWE_pxAcrj2KgY7nNoAtVQ.png 276w, https://miro.medium.com/max/1104/1*KWE_pxAcrj2KgY7nNoAtVQ.png 552w, https://miro.medium.com/max/1280/1*KWE_pxAcrj2KgY7nNoAtVQ.png 640w, https://miro.medium.com/max/1400/1*KWE_pxAcrj2KgY7nNoAtVQ.png 700w" sizes="700px" role="presentation"/></noscript></div></div></div></div></figure><p id="8cb3" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Since the cred(process authority) structure and things like that are inherited from the state before execve()(it is also held on the worker side as needed when queueing the task), it cannot be newly opened with the authority of the privileged process. But the files opened by the privileged process itself can be referenced from the worker side.</p><pre class="kq kr ks kt ku kv kw kx"><span id="868c" class="gx ji jj ga ko b dv ky kz s la" data-selectable-paragraph="">static void io_wq_switch_creds(struct io_worker *worker,<br>          struct io_wq_work *work)<br>{<br> const struct cred *old_creds = override_creds(work-&gt;creds);</span><span id="5b47" class="gx ji jj ga ko b dv lb lc ld le lf kz s la" data-selectable-paragraph="">worker-&gt;cur_creds = work-&gt;creds;<br> if (worker-&gt;saved_creds)<br>  put_cred(old_creds); /* creds set by previous switch */<br> else<br>  worker-&gt;saved_creds = old_creds;<br>}</span></pre><p id="e42d" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph=""><a href="https://elixir.bootlin.com/linux/v5.6.19/source/fs/io-wq.c#L431" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://elixir.bootlin.com/linux/v5.6.19/source/fs/io-wq.c#L431</a></p><p id="7242" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">This means that there’s a possibility of LPE by reading/writing file descriptors opened by privileged processes. (For example, if a shell script that will be executed as root is opened as writable, it can be used for privilege escalation.)</p><p id="6e0b" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">By the way, strictly speaking, as mentioned above, the <code class="kk kl km kn ko b">file</code> structure to read/write is obtained based on the file descriptor before offloading, so the <code class="kk kl km kn ko b">file</code> structure of the privileged process cannot be used. However, in fact, io_uring has a feature that allows you to define file descriptors on the side of execution context, and it can dynamically updates them by the operation <code class="kk kl km kn ko b">IORING_OP_FILES_UPDATE</code>. This obtains file descriptors again from the <code class="kk kl km kn ko b">files_struct</code> structure held on the <strong class="ib gb">execution context side</strong>, which means that there is room for stealing the file descriptor of the privileged process.</p><figure class="kq kr ks kt ku hs fi fj paragraph-image"><div role="button" tabindex="0" class="ht hu aq hv x hw"><div class="fi fj nj"><div class="ll s aq kk"><div class="nk ln s"><div class="pq sh eh eu eq ez x li lj lk"><img alt="" class="eh eu eq ez x lo lp lq" src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/1_s_qqPn9N6K63kE9FUz-MeA.png" width="700" height="657" role="presentation"></div><img alt="" class="er lh eh eu eq ez x t" width="700" height="657" role="presentation"><noscript><img alt="" class="eh eu eq ez x" src="https://miro.medium.com/max/1400/1*s_qqPn9N6K63kE9FUz-MeA.png" width="700" height="657" srcSet="https://miro.medium.com/max/552/1*s_qqPn9N6K63kE9FUz-MeA.png 276w, https://miro.medium.com/max/1104/1*s_qqPn9N6K63kE9FUz-MeA.png 552w, https://miro.medium.com/max/1280/1*s_qqPn9N6K63kE9FUz-MeA.png 640w, https://miro.medium.com/max/1400/1*s_qqPn9N6K63kE9FUz-MeA.png 700w" sizes="700px" role="presentation"/></noscript></div></div></div></div></figure><p id="b1a6" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">I haven’t confirmed whether there is a convenient executable file that can actually be used for exploitation. At least, sudo temporarily opens <code class="kk kl km kn ko b">/etc/shadow</code> with <code class="kk kl km kn ko b">O_RDONLY</code> , so it seems that you can get the contents if the timing is right.</p><p id="d795" class="hz ia ga ib b ic id ie if ig ih ii ij ik il im in io ip iq ir is it iu iv iw dp gx" data-selectable-paragraph="">Also, depending on the version, the <code class="kk kl km kn ko b">file</code> structure is updated by referring to the memory on the privileged process (it means, it is necessary to specify the address of the privileged process as the address of the file descriptor table when updating). So I felt like it was affected by ASLR (A suid binary is required to immediately stabilize the memory reuse of the <code class="kk kl km kn ko b">files_struct</code> structure, but of course su/sudo binaries are built as PIE). ( I justify my blog with that excuse. :) )</p></div></div></section><div class="n p cz jb jc jd" role="separator"><span class="je hb bx jf jg jh"></span><span class="je hb bx jf jg jh"></span><span class="je hb bx jf jg"></span></div><section class="dp fv fw dk fx"><div class="n p"><div class="ar as at au av fy ax x"><h2 id="76bb" class="ji jj ga bc dc jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke gx" data-selectable-paragraph="">About us</h2><p id="db8e" class="hz ia ga ib b ic kf ie if ig kg ii ij ik kh im in io ki iq ir is kj iu iv iw dp gx" data-selectable-paragraph="">Flatt Security Inc. provides security assessment services. We are willing to have offers from overseas. If you have any question, please contact us by <a href="https://flatt.tech/en/" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://flatt.tech/en/</a>. Thank you for reading this article.</p></div></div></section><div class="n p cz jb jc jd" role="separator"><span class="je hb bx jf jg jh"></span><span class="je hb bx jf jg jh"></span><span class="je hb bx jf jg"></span></div><section class="dp fv fw dk fx"><div class="n p"><div class="ar as at au av fy ax x"><h2 id="2c9d" class="ji jj ga bc dc jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke gx" data-selectable-paragraph=""><strong class="cf">Reference</strong></h2><p id="fb3e" class="hz ia ga ib b ic kf ie if ig kg ii ij ik kh im in io ki iq ir is kj iu iv iw dp gx" data-selectable-paragraph=""><a href="https://www.zerodayinitiative.com/advisories/ZDI-21-001/" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://www.zerodayinitiative.com/advisories/ZDI-21-001/</a> <a href="https://github.com/torvalds/linux/commit/0f2122045b946241a9e549c2a76cea54fa58a7ff" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://github.com/torvalds/linux/commit/0f2122045b946241a9e549c2a76cea54fa58a7ff</a> <a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2089" class="ea ix" target="_blank" rel="noopener ugc nofollow">https://bugs.chromium.org/p/project-zero/issues/detail?id=2089</a></p></div></div></section></div></div></article><div class="er fu es ns x sg eu nq nu" data-test-id="post-sidebar"><div class="n p"><div class="ar as at au av aw ax x"><div class="nv n al"><div class="fu"><div><div class="nw s"><div class="nx s"><a class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef" rel="noopener follow" href="https://flattsecurity.medium.com/?source=post_sidebar--------------------------post_sidebar--------------"><h2 class="bc dc dv be dn gx dp">Flatt Security Inc.</h2></a></div><div class="ny s"><p class="bc b bd be ca">We are a cyber security company based in Tokyo, Japan. We provide security assessment services. HP: <a href="https://flatt.tech/en" class="ea eb cb cc cd ce cf cg ch bn ci ee ef ix fv" rel="noopener follow">https://flatt.tech/en</a> CVE: <a href="https://flatt.tech/cve" class="ea eb cb cc cd ce cf cg ch bn ci ee ef ix fv" rel="noopener follow">https://flatt.tech/cve</a></p></div><div class="nz n"><span><button class="bc b bd be oa bg ob oc bj od bm bn bo bp oe bs bt bu bv bw bx by">Follow</button></span><div class="he s"><div><div><div class="bx" role="tooltip" aria-hidden="false" aria-describedby="191" aria-labelledby="191"><div class="s"><span><a href="https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fusers%2Fb10b5c7f48a%2Flazily-enable-writer-subscription&amp;operation=register&amp;redirect=https%3A%2F%2Fflattsecurity.medium.com%2Fcve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a&amp;user=Flatt+Security+Inc.&amp;userId=b10b5c7f48a&amp;source=post_sidebar-----e946bd69177a---------------------subscribe_user--------------" class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef" rel="noopener follow"><button class="bc b bd be oa cg ob oc bj od bm bn bo bp oe bs bt bu bv bw bx by" aria-label="Subscribe"><svg width="38" height="38" viewBox="0 0 38 38" fill="none" class="tw og oh"><rect x="26.25" y="9.25" width="0.5" height="6.5" rx="0.25" stroke-width="0.5"></rect><rect x="29.75" y="12.25" width="0.5" height="6.5" rx="0.25" transform="rotate(90 29.75 12.25)" stroke-width="0.5"></rect><path d="M19.5 12.5h-7a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h13a1 1 0 0 0 1-1v-5" stroke-linecap="round"></path><path d="M11.5 14.5L19 20l4-3" stroke-linecap="round"></path></svg></button></a></span></div></div></div></div></div></div></div><div class="oq or x n o az os"><div class="jh n"><div class="n o az"><div class="aq ot ou ov ow ox oy"><span><a href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fp%2Fe946bd69177a&amp;operation=register&amp;redirect=https%3A%2F%2Fflattsecurity.medium.com%2Fcve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a&amp;user=Flatt+Security+Inc.&amp;userId=b10b5c7f48a&amp;source=post_sidebar-----e946bd69177a---------------------clap_sidebar--------------" class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef" rel="noopener follow"><div class="cg oz pa pb em pc pd oy cl pe pf"><svg width="29" height="29" aria-label="clap"><g fill-rule="evenodd"><path d="M13.74 1l.76 2.97.76-2.97zM16.82 4.78l1.84-2.56-1.43-.47zM10.38 2.22l1.84 2.56-.41-3.03zM22.38 22.62a5.11 5.11 0 0 1-3.16 1.61l.49-.45c2.88-2.89 3.45-5.98 1.69-9.21l-1.1-1.94-.96-2.02c-.31-.67-.23-1.18.25-1.55a.84.84 0 0 1 .66-.16c.34.05.66.28.88.6l2.85 5.02c1.18 1.97 1.38 5.12-1.6 8.1M9.1 22.1l-5.02-5.02a1 1 0 0 1 .7-1.7 1 1 0 0 1 .72.3l2.6 2.6a.44.44 0 0 0 .63-.62L6.1 15.04l-1.75-1.75a1 1 0 1 1 1.41-1.41l4.15 4.15a.44.44 0 0 0 .63 0 .44.44 0 0 0 0-.62L6.4 11.26l-1.18-1.18a1 1 0 0 1 0-1.4 1.02 1.02 0 0 1 1.41 0l1.18 1.16L11.96 14a.44.44 0 0 0 .62 0 .44.44 0 0 0 0-.63L8.43 9.22a.99.99 0 0 1-.3-.7.99.99 0 0 1 .3-.7 1 1 0 0 1 1.41 0l7 6.98a.44.44 0 0 0 .7-.5l-1.35-2.85c-.31-.68-.23-1.19.25-1.56a.85.85 0 0 1 .66-.16c.34.06.66.28.88.6L20.63 15c1.57 2.88 1.07 5.54-1.55 8.16a5.62 5.62 0 0 1-5.06 1.65 9.35 9.35 0 0 1-4.93-2.72zM13 6.98l2.56 2.56c-.5.6-.56 1.41-.15 2.28l.26.56-4.25-4.25a.98.98 0 0 1-.12-.45 1 1 0 0 1 .29-.7 1.02 1.02 0 0 1 1.41 0zm8.89 2.06c-.38-.56-.9-.92-1.49-1.01a1.74 1.74 0 0 0-1.34.33c-.38.29-.61.65-.71 1.06a2.1 2.1 0 0 0-1.1-.56 1.78 1.78 0 0 0-.99.13l-2.64-2.64a1.88 1.88 0 0 0-2.65 0 1.86 1.86 0 0 0-.48.85 1.89 1.89 0 0 0-2.67-.01 1.87 1.87 0 0 0-.5.9c-.76-.75-2-.75-2.7-.04a1.88 1.88 0 0 0 0 2.66c-.3.12-.61.29-.87.55a1.88 1.88 0 0 0 0 2.66l.62.62a1.88 1.88 0 0 0-.9 3.16l5.01 5.02c1.6 1.6 3.52 2.64 5.4 2.96a7.16 7.16 0 0 0 1.18.1c1.03 0 2-.25 2.9-.7A5.9 5.9 0 0 0 23 23.24c3.34-3.34 3.08-6.93 1.74-9.17l-2.87-5.04z"></path></g></svg></div></a></span></div><div class="s pg ph pi pj pk pl pm"><div class="pn"><p class="bc b bd be ca"><button class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef">16 </button></p></div></div></div></div><div class="po jh s"><div class="n"><button class="em pa cg"><div class="n o az"><div class="n o"><svg width="25" height="25" aria-label="responses" class="pp pq em pf"><path d="M19.07 21.12a6.33 6.33 0 0 1-3.53-1.1 7.8 7.8 0 0 1-.7-.52c-.77.21-1.57.32-2.38.32-4.67 0-8.46-3.5-8.46-7.8C4 7.7 7.79 4.2 12.46 4.2c4.66 0 8.46 3.5 8.46 7.8 0 2.06-.85 3.99-2.4 5.45a6.28 6.28 0 0 0 1.14 2.59c.15.21.17.48.06.7a.69.69 0 0 1-.62.38h-.03zm0-1v.5l.03-.5h-.03zm-3.92-1.64l.21.2a6.09 6.09 0 0 0 3.24 1.54 7.14 7.14 0 0 1-.83-1.84 5.15 5.15 0 0 1-.16-.75 2.4 2.4 0 0 1-.02-.29v-.23l.18-.15a6.6 6.6 0 0 0 2.3-4.96c0-3.82-3.4-6.93-7.6-6.93-4.19 0-7.6 3.11-7.6 6.93 0 3.83 3.41 6.94 7.6 6.94.83 0 1.64-.12 2.41-.35l.28-.08z" fill-rule="evenodd"></path></svg></div></div></button></div></div><div class="pr s"><span><a href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fe946bd69177a&amp;operation=register&amp;redirect=https%3A%2F%2Fflattsecurity.medium.com%2Fcve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a&amp;source=post_sidebar-----e946bd69177a---------------------bookmark_sidebar--------------" class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef" rel="noopener follow"><svg width="25" height="25" viewBox="0 0 25 25" fill="none" class="tr"><path d="M18 2.5a.5.5 0 0 1 1 0V5h2.5a.5.5 0 0 1 0 1H19v2.5a.5.5 0 1 1-1 0V6h-2.5a.5.5 0 0 1 0-1H18V2.5zM7 7a1 1 0 0 1 1-1h3.5a.5.5 0 0 0 0-1H8a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4V7z" fill="#292929"></path></svg></a></span></div></div></div></div></div></div></div></div><div class="er fu nl es nm nn no np nq nr"></div><div><div class="ps hs n al p"><div class="n p"><div class="ar as at au av fy ax x"><div class="n cw"></div><div class="n o cw"></div><div class="pu s"><ul class="cg ch"><li class="bx qi qj qk"><a href="https://medium.com/tag/cybersecurity" class="bc b ql qm ca qn qo by s kw">Cybersecurity</a></li><li class="bx qi qj qk"><a href="https://medium.com/tag/linux" class="bc b ql qm ca qn qo by s kw">Linux</a></li><li class="bx qi qj qk"><a href="https://medium.com/tag/security" class="bc b ql qm ca qn qo by s kw">Security</a></li><li class="bx qi qj qk"><a href="https://medium.com/tag/vulnerability" class="bc b ql qm ca qn qo by s kw">Vulnerability</a></li></ul></div><div class="pu s"><div class="n cm ho"><div class="n o az"><div class="pv s"><span class="s pw px py e d"><div class="n o az"><div class="aq ot ou ov ow ox oy"><span><a href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fp%2Fe946bd69177a&amp;operation=register&amp;redirect=https%3A%2F%2Fflattsecurity.medium.com%2Fcve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a&amp;user=Flatt+Security+Inc.&amp;userId=b10b5c7f48a&amp;source=post_actions_footer-----e946bd69177a---------------------clap_footer--------------" class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef" rel="noopener follow"><div class="cg oz pa pb em pc pd oy cl pe pf"><svg width="25" height="25" viewBox="0 0 25 25" aria-label="clap"><g fill-rule="evenodd"><path d="M11.74 0l.76 2.97.76-2.97zM14.81 3.78l1.84-2.56-1.42-.47zM8.38 1.22l1.84 2.56L9.8.75zM20.38 21.62a5.11 5.11 0 0 1-3.16 1.61l.49-.45c2.88-2.89 3.45-5.98 1.69-9.21l-1.1-1.94-.96-2.02c-.31-.67-.23-1.18.25-1.55a.84.84 0 0 1 .66-.16c.34.05.66.28.88.6l2.85 5.02c1.18 1.97 1.38 5.12-1.6 8.1M7.1 21.1l-5.02-5.02a1 1 0 0 1 .7-1.7 1 1 0 0 1 .72.3l2.6 2.6a.44.44 0 0 0 .63-.62L4.1 14.04l-1.75-1.75a1 1 0 1 1 1.41-1.41l4.15 4.15a.44.44 0 0 0 .63 0 .44.44 0 0 0 0-.62L4.4 10.26 3.22 9.08a1 1 0 0 1 0-1.4 1.02 1.02 0 0 1 1.41 0l1.18 1.16L9.96 13a.44.44 0 0 0 .62 0 .44.44 0 0 0 0-.63L6.43 8.22a.99.99 0 0 1-.3-.7.99.99 0 0 1 .3-.7 1 1 0 0 1 1.41 0l7 6.98a.44.44 0 0 0 .7-.5l-1.35-2.85c-.31-.68-.23-1.19.25-1.56a.85.85 0 0 1 .66-.16c.34.06.66.28.88.6L18.63 14c1.57 2.88 1.07 5.54-1.55 8.16a5.62 5.62 0 0 1-5.06 1.65 9.35 9.35 0 0 1-4.93-2.72zM11 5.98l2.56 2.56c-.5.6-.56 1.41-.15 2.28l.26.56-4.25-4.25a.98.98 0 0 1-.12-.45 1 1 0 0 1 .29-.7 1.02 1.02 0 0 1 1.41 0zm8.89 2.06c-.38-.56-.9-.92-1.49-1.01a1.74 1.74 0 0 0-1.34.33c-.38.29-.61.65-.71 1.06a2.1 2.1 0 0 0-1.1-.56 1.78 1.78 0 0 0-.99.13l-2.64-2.64a1.88 1.88 0 0 0-2.65 0 1.86 1.86 0 0 0-.48.85 1.89 1.89 0 0 0-2.67-.01 1.87 1.87 0 0 0-.5.9c-.76-.75-2-.75-2.7-.04a1.88 1.88 0 0 0 0 2.66c-.3.12-.61.29-.87.55a1.88 1.88 0 0 0 0 2.66l.62.62a1.88 1.88 0 0 0-.9 3.16l5.01 5.02c1.6 1.6 3.52 2.64 5.4 2.96a7.16 7.16 0 0 0 1.18.1c1.03 0 2-.25 2.9-.7A5.9 5.9 0 0 0 21 22.24c3.34-3.34 3.08-6.93 1.74-9.17l-2.87-5.04z"></path></g></svg></div></a></span></div><div class="s pg ph pi pj pz qa qb"><div class="aq qc pn"><p class="bc b bd be gx"><button class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef">16<span class="s h g f qd qe">&nbsp;claps</span></button><span class="s h g f qd qe"></span></p></div></div></div></span><span class="s h g f qd qe"><div class="n o az"><div class="aq ot ou ov ow ox oy"><span><a href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fp%2Fe946bd69177a&amp;operation=register&amp;redirect=https%3A%2F%2Fflattsecurity.medium.com%2Fcve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a&amp;user=Flatt+Security+Inc.&amp;userId=b10b5c7f48a&amp;source=post_actions_footer-----e946bd69177a---------------------clap_footer--------------" class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef" rel="noopener follow"><div class="cg oz pa pb em pc pd oy cl pe pf"><svg width="25" height="25" viewBox="0 0 25 25" aria-label="clap"><g fill-rule="evenodd"><path d="M11.74 0l.76 2.97.76-2.97zM14.81 3.78l1.84-2.56-1.42-.47zM8.38 1.22l1.84 2.56L9.8.75zM20.38 21.62a5.11 5.11 0 0 1-3.16 1.61l.49-.45c2.88-2.89 3.45-5.98 1.69-9.21l-1.1-1.94-.96-2.02c-.31-.67-.23-1.18.25-1.55a.84.84 0 0 1 .66-.16c.34.05.66.28.88.6l2.85 5.02c1.18 1.97 1.38 5.12-1.6 8.1M7.1 21.1l-5.02-5.02a1 1 0 0 1 .7-1.7 1 1 0 0 1 .72.3l2.6 2.6a.44.44 0 0 0 .63-.62L4.1 14.04l-1.75-1.75a1 1 0 1 1 1.41-1.41l4.15 4.15a.44.44 0 0 0 .63 0 .44.44 0 0 0 0-.62L4.4 10.26 3.22 9.08a1 1 0 0 1 0-1.4 1.02 1.02 0 0 1 1.41 0l1.18 1.16L9.96 13a.44.44 0 0 0 .62 0 .44.44 0 0 0 0-.63L6.43 8.22a.99.99 0 0 1-.3-.7.99.99 0 0 1 .3-.7 1 1 0 0 1 1.41 0l7 6.98a.44.44 0 0 0 .7-.5l-1.35-2.85c-.31-.68-.23-1.19.25-1.56a.85.85 0 0 1 .66-.16c.34.06.66.28.88.6L18.63 14c1.57 2.88 1.07 5.54-1.55 8.16a5.62 5.62 0 0 1-5.06 1.65 9.35 9.35 0 0 1-4.93-2.72zM11 5.98l2.56 2.56c-.5.6-.56 1.41-.15 2.28l.26.56-4.25-4.25a.98.98 0 0 1-.12-.45 1 1 0 0 1 .29-.7 1.02 1.02 0 0 1 1.41 0zm8.89 2.06c-.38-.56-.9-.92-1.49-1.01a1.74 1.74 0 0 0-1.34.33c-.38.29-.61.65-.71 1.06a2.1 2.1 0 0 0-1.1-.56 1.78 1.78 0 0 0-.99.13l-2.64-2.64a1.88 1.88 0 0 0-2.65 0 1.86 1.86 0 0 0-.48.85 1.89 1.89 0 0 0-2.67-.01 1.87 1.87 0 0 0-.5.9c-.76-.75-2-.75-2.7-.04a1.88 1.88 0 0 0 0 2.66c-.3.12-.61.29-.87.55a1.88 1.88 0 0 0 0 2.66l.62.62a1.88 1.88 0 0 0-.9 3.16l5.01 5.02c1.6 1.6 3.52 2.64 5.4 2.96a7.16 7.16 0 0 0 1.18.1c1.03 0 2-.25 2.9-.7A5.9 5.9 0 0 0 21 22.24c3.34-3.34 3.08-6.93 1.74-9.17l-2.87-5.04z"></path></g></svg></div></a></span></div><div class="s pg ph pi pj pz qa qb"><div class="pn"><p class="bc b bd be ca"><button class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef">16 </button></p></div></div></div></span></div><div class="qf n"><div class="n"><button class="em pa cg"><div class="n o az"><div class="n o"><svg width="29" height="29" aria-label="responses" class="pp pq em pf qg"><path d="M21.27 20.06a9.04 9.04 0 0 0 2.75-6.68C24.02 8.21 19.67 4 14.1 4S4 8.21 4 13.38c0 5.18 4.53 9.39 10.1 9.39 1 0 2-.14 2.95-.41.28.25.6.49.92.7a7.46 7.46 0 0 0 4.19 1.3c.27 0 .5-.13.6-.35a.63.63 0 0 0-.05-.65 8.08 8.08 0 0 1-1.29-2.58 5.42 5.42 0 0 1-.15-.75zm-3.85 1.32l-.08-.28-.4.12a9.72 9.72 0 0 1-2.84.43c-4.96 0-9-3.71-9-8.27 0-4.55 4.04-8.26 9-8.26 4.95 0 8.77 3.71 8.77 8.27 0 2.25-.75 4.35-2.5 5.92l-.24.21v.32a5.59 5.59 0 0 0 .21 1.29c.19.7.49 1.4.89 2.08a6.43 6.43 0 0 1-2.67-1.06c-.34-.22-.88-.48-1.16-.74z"></path></svg></div></div></button></div></div></div><div class="n o"><div class="ve s ac"><button class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef" aria-label="Share on twitter"><svg width="30" height="30" viewBox="0 0 30 30" fill="none" class="vf tr"><path fill-rule="evenodd" clip-rule="evenodd" d="M15 27a12 12 0 1 0 0-24 12 12 0 0 0 0 24zm4.95-16.17a2.67 2.67 0 0 0-4.6 1.84c0 .2.03.41.05.62a7.6 7.6 0 0 1-5.49-2.82 3 3 0 0 0-.38 1.34c.02.94.49 1.76 1.2 2.23a2.53 2.53 0 0 1-1.2-.33v.04c0 1.28.92 2.36 2.14 2.62-.23.05-.46.08-.71.1l-.21-.02-.27-.03a2.68 2.68 0 0 0 2.48 1.86A5.64 5.64 0 0 1 9 19.38a7.62 7.62 0 0 0 4.1 1.19c4.9 0 7.58-4.07 7.57-7.58v-.39c.52-.36.97-.83 1.33-1.38-.48.23-1 .37-1.53.43.56-.33.96-.86 1.15-1.48-.5.31-1.07.53-1.67.66z" fill="#292929"></path></svg></button></div><div class="ve s ac"><button class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef" aria-label="Share on facebook"><svg width="30" height="30" viewBox="0 0 30 30" fill="none" class="vf tr"><path fill-rule="evenodd" clip-rule="evenodd" d="M15 27a12 12 0 1 0 0-24 12 12 0 0 0 0 24zm-1.23-6.03V15.6H12v-2.15h1.77v-1.6C13.77 10 14.85 9 16.42 9c.75 0 1.4.06 1.58.08v1.93h-1.09c-.85 0-1.02.43-1.02 1.05v1.38h2.04l-.27 2.15H15.9V21l-2.13-.03z" fill="#292929"></path></svg></button></div><div class="ve s ac"><button class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef" aria-label="Share on linkedin"><svg width="30" height="30" viewBox="0 0 30 30" fill="none" class="vf tr"><path fill-rule="evenodd" clip-rule="evenodd" d="M27 15a12 12 0 1 1-24 0 12 12 0 0 1 24 0zm-14.61 5v-7.42h-2.26V20h2.26zm-1.13-8.44c.79 0 1.28-.57 1.28-1.28-.02-.73-.5-1.28-1.26-1.28-.78 0-1.28.55-1.28 1.28 0 .71.49 1.28 1.25 1.28h.01zM15.88 20h-2.5s.04-6.5 0-7.17h2.5v1.02l-.02.02h.02v-.02a2.5 2.5 0 0 1 2.25-1.18c1.64 0 2.87 1.02 2.87 3.22V20h-2.5v-3.83c0-.97-.36-1.62-1.26-1.62-.69 0-1.1.44-1.28.87-.06.15-.08.36-.08.58v4z" fill="#292929"></path></svg></button></div><div class="s ac"><button class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef"><svg width="30" height="30" viewBox="0 0 30 30" fill="none" class="vf tr"><path fill-rule="evenodd" clip-rule="evenodd" d="M15 27a12 12 0 1 0 0-24 12 12 0 0 0 0 24zM9.29 16.28c-.2.36-.29.75-.29 1.17a2.57 2.57 0 0 0 .78 1.84l1.01.96c.53.5 1.17.75 1.92.75s1.38-.25 1.9-.75l1.2-1.15.75-.71.51-.5a2.51 2.51 0 0 0 .72-2.34.7.7 0 0 0-.03-.18 2.74 2.74 0 0 0-.23-.5v-.02l-.08-.14-.02-.03-.02-.01a.33.33 0 0 0-.07-.1c0-.02-.01-.03-.03-.05a.2.2 0 0 0-.03-.03l-.03-.04v-.01l-.02-.03-.04-.03a.85.85 0 0 1-.13-.13l-.43-.42-.06.06-.9.84-.05.09a.26.26 0 0 0-.03.1l.37.38c.04.03.08.07.1.11l.01.01.01.03.02.01.04.1.03.04.06.1v.02l.01.02c.03.1.05.2.05.33a1 1 0 0 1-.12.49c-.07.13-.15.22-.22.29l-.88.85-.61.57-.95.92c-.22.2-.5.3-.82.3-.31 0-.58-.1-.8-.3l-.98-.96a1.15 1.15 0 0 1-.3-.42 1.4 1.4 0 0 1-.04-.35c0-.1.01-.2.04-.3a1 1 0 0 1 .3-.49l1.5-1.46v-.24c0-.21 0-.42.04-.6a3.5 3.5 0 0 1 .92-1.72c-.41.1-.78.32-1.11.62l-.01.02-.01.01-2.46 2.33c-.2.21-.35.4-.44.6h-.02c0 .02 0 .02-.02.02v.02l-.01.01zm3.92-1.8a1.83 1.83 0 0 0 .02.97c0 .06 0 .13.02.19.06.17.14.34.22.5v.02l.06.12.02.03.01.02.08.1c0 .02.02.03.04.05l.08.1h.01c0 .01 0 .03.02.03l.14.14.43.41.08-.06.88-.84.05-.09.03-.1-.36-.37a.4.4 0 0 1-.12-.13v-.02l-.02-.02-.05-.09-.04-.04-.04-.1v-.02l-.02-.02a1.16 1.16 0 0 1 .06-.82c.09-.14.16-.24.23-.3l.9-.85.6-.58.93-.92c.23-.2.5-.3.82-.3a1.2 1.2 0 0 1 .82.3l1 .96c.13.15.23.29.28.42a1.43 1.43 0 0 1 0 .66c-.03.17-.12.33-.26.48l-1.54 1.45.02.25a3.28 3.28 0 0 1-.96 2.32 2.5 2.5 0 0 0 1.1-.62l.01-.01 2.46-2.34c.19-.2.35-.4.46-.6l.02-.02v-.02h.01a2.45 2.45 0 0 0 .21-1.82 2.53 2.53 0 0 0-.7-1.19l-1-.96a2.68 2.68 0 0 0-1.91-.75c-.75 0-1.38.25-1.9.76l-1.2 1.14-.76.72-.5.49c-.4.37-.64.83-.74 1.37z" fill="#292929"></path></svg></button></div><div class="hp s ac"><span><a href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fe946bd69177a&amp;operation=register&amp;redirect=https%3A%2F%2Fflattsecurity.medium.com%2Fcve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a&amp;source=post_actions_footer--------------------------bookmark_footer--------------" class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef" rel="noopener follow"><svg width="25" height="25" viewBox="0 0 25 25" fill="none" class="tr"><path d="M18 2.5a.5.5 0 0 1 1 0V5h2.5a.5.5 0 0 1 0 1H19v2.5a.5.5 0 1 1-1 0V6h-2.5a.5.5 0 0 1 0-1H18V2.5zM7 7a1 1 0 0 1 1-1h3.5a.5.5 0 0 0 0-1H8a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4V7z" fill="#292929"></path></svg></a></span></div><div class="s"><div class="bx" aria-hidden="false"><button class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef" aria-label="More options"><svg class="overflow-dots-filled-25px_svg__svgIcon-use" width="25" height="25"><path d="M5 12.5c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59.55 0 1.02-.2 1.41-.59.4-.39.59-.86.59-1.41 0-.55-.2-1.02-.59-1.41A1.93 1.93 0 0 0 7 10.5c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41zm5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59.55 0 1.02-.2 1.41-.59.4-.39.59-.86.59-1.41 0-.55-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59-.39.39-.58.86-.58 1.41zm5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59.56 0 1.03-.2 1.42-.59.39-.39.58-.86.58-1.41 0-.55-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59-.39.39-.58.86-.58 1.41z" fill-rule="evenodd"></path></svg></button></div></div></div></div></div><div class="qp s"></div></div></div><div><div class="n p"><div class="ar as at au av fy ax x"></div></div><div class="s ho"><div class="qq oq s qr"><div class="n p"><div class="ar as at au av fy ax x"><div class="n o cm"><h2 class="bc dc qs qt ry jn qv qw rz jr qy qz sa jv rb rc sb jz re rf sc kd li rh ri sd rk rl gx"><a class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef" rel="noopener follow" href="https://flattsecurity.medium.com/?source=follow_footer-----e946bd69177a-----------------------------------">More from Flatt Security Inc.</a></h2><div class="he n"><span><button class="bc b bd be oa bg ob oc bj od bm bn bo bp oe bs bt bu bv bw bx by">Follow</button></span><div class="he s"><div><div><div class="bx" role="tooltip" aria-hidden="false" aria-describedby="195" aria-labelledby="195"><div class="s"><span><a href="https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fusers%2Fb10b5c7f48a%2Flazily-enable-writer-subscription&amp;operation=register&amp;redirect=https%3A%2F%2Fflattsecurity.medium.com%2Fcve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a&amp;user=Flatt+Security+Inc.&amp;userId=b10b5c7f48a&amp;source=follow_footer-----e946bd69177a---------------------subscribe_user--------------" class="ea eb cb cc cd ce cf cg ch bn ec ed ci ee ef" rel="noopener follow"><button class="bc b bd be oa cg ob oc bj od bm bn bo bp oe bs bt bu bv bw bx by" aria-label="Subscribe"><svg width="38" height="38" viewBox="0 0 38 38" fill="none" class="tw og oh"><rect x="26.25" y="9.25" width="0.5" height="6.5" rx="0.25" stroke-width="0.5"></rect><rect x="29.75" y="12.25" width="0.5" height="6.5" rx="0.25" transform="rotate(90 29.75 12.25)" stroke-width="0.5"></rect><path d="M19.5 12.5h-7a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h13a1 1 0 0 0 1-1v-5" stroke-linecap="round"></path><path d="M11.5 14.5L19 20l4-3" stroke-linecap="round"></path></svg></button></a></span></div></div></div></div></div></div></div><div class="rm se s"><p class="bc b bd be ca">We are a cyber security company based in Tokyo, Japan. We provide security assessment services. HP: https://flatt.tech/en CVE: https://flatt.tech/cve</p></div></div></div></div></div><div class="rn s qr ho"><div class="n p"><div class="ro rp rq rr rs hx ax x"></div></div></div><div class="s rt ho"><div class="n p"><div class="ar as at au av aw ax x"></div></div></div></div></div></div><div class="tx s ty tz"><div class="n p"><div class="ar as at au av aw ax x"><div class="n al"><div class="n ua ub uc ud ue uf ug uh ui uj cm"><a href="https://medium.com/?source=post_page-----e946bd69177a-----------------------------------" class="ea eb cb cc cd ce cf cg ch bn uk ul ci um un" rel="noopener follow" aria-label="Go to homepage"><svg viewBox="0 0 3940 610" class="uo up"><path d="M594.79 308.2c0 163.76-131.85 296.52-294.5 296.52S5.8 472 5.8 308.2 137.65 11.69 300.29 11.69s294.5 132.75 294.5 296.51M917.86 308.2c0 154.16-65.93 279.12-147.25 279.12s-147.25-125-147.25-279.12S689.29 29.08 770.61 29.08s147.25 125 147.25 279.12M1050 308.2c0 138.12-23.19 250.08-51.79 250.08s-51.79-112-51.79-250.08 23.19-250.08 51.8-250.08S1050 170.09 1050 308.2M1862.77 37.4l.82-.18v-6.35h-167.48l-155.51 365.5-155.51-365.5h-180.48v6.35l.81.18c30.57 6.9 46.09 17.19 46.09 54.3v434.45c0 37.11-15.58 47.4-46.15 54.3l-.81.18V587H1327v-6.35l-.81-.18c-30.57-6.9-46.09-17.19-46.09-54.3V116.9L1479.87 587h11.33l205.59-483.21V536.9c-2.62 29.31-18 38.36-45.68 44.61l-.82.19v6.3h213.3v-6.3l-.82-.19c-27.71-6.25-43.46-15.3-46.08-44.61l-.14-445.2h.14c0-37.11 15.52-47.4 46.08-54.3m97.43 287.8c3.49-78.06 31.52-134.4 78.56-135.37 14.51.24 26.68 5 36.14 14.16 20.1 19.51 29.55 60.28 28.09 121.21zm-2.11 22h250v-1.05c-.71-59.69-18-106.12-51.34-138-28.82-27.55-71.49-42.71-116.31-42.71h-1c-23.26 0-51.79 5.64-72.09 15.86-23.11 10.7-43.49 26.7-60.45 47.7-27.3 33.83-43.84 79.55-47.86 130.93-.13 1.54-.24 3.08-.35 4.62s-.18 2.92-.25 4.39a332.64 332.64 0 0 0-.36 21.69C1860.79 507 1923.65 600 2035.3 600c98 0 155.07-71.64 169.3-167.8l-7.19-2.53c-25 51.68-69.9 83-121 79.18-69.76-5.22-123.2-75.95-118.35-161.63m532.69 157.68c-8.2 19.45-25.31 30.15-48.24 30.15s-43.89-15.74-58.78-44.34c-16-30.7-24.42-74.1-24.42-125.51 0-107 33.28-176.21 84.79-176.21 21.57 0 38.55 10.7 46.65 29.37zm165.84 76.28c-30.57-7.23-46.09-18-46.09-57V5.28L2424.77 60v6.7l1.14-.09c25.62-2.07 43 1.47 53.09 10.79 7.9 7.3 11.75 18.5 11.75 34.26v71.14c-18.31-11.69-40.09-17.38-66.52-17.38-53.6 0-102.59 22.57-137.92 63.56-36.83 42.72-56.3 101.1-56.3 168.81C2230 518.72 2289.53 600 2378.13 600c51.83 0 93.53-28.4 112.62-76.3V588h166.65v-6.66zm159.29-505.33c0-37.76-28.47-66.24-66.24-66.24-37.59 0-67 29.1-67 66.24s29.44 66.24 67 66.24c37.77 0 66.24-28.48 66.24-66.24m43.84 505.33c-30.57-7.23-46.09-18-46.09-57h-.13V166.65l-166.66 47.85v6.5l1 .09c36.06 3.21 45.93 15.63 45.93 57.77V588h166.8v-6.66zm427.05 0c-30.57-7.23-46.09-18-46.09-57V166.65L3082 212.92v6.52l.94.1c29.48 3.1 38 16.23 38 58.56v226c-9.83 19.45-28.27 31-50.61 31.78-36.23 0-56.18-24.47-56.18-68.9V166.66l-166.66 47.85V221l1 .09c36.06 3.2 45.94 15.62 45.94 57.77v191.27a214.48 214.48 0 0 0 3.47 39.82l3 13.05c14.11 50.56 51.08 77 109 77 49.06 0 92.06-30.37 111-77.89v66h166.66v-6.66zM3934.2 588v-6.67l-.81-.19c-33.17-7.65-46.09-22.07-46.09-51.43v-243.2c0-75.83-42.59-121.09-113.93-121.09-52 0-95.85 30.05-112.73 76.86-13.41-49.6-52-76.86-109.06-76.86-50.12 0-89.4 26.45-106.25 71.13v-69.87l-166.66 45.89v6.54l1 .09c35.63 3.16 45.93 15.94 45.93 57V588h155.5v-6.66l-.82-.2c-26.46-6.22-35-17.56-35-46.66V255.72c7-16.35 21.11-35.72 49-35.72 34.64 0 52.2 24 52.2 71.28V588h155.54v-6.66l-.82-.2c-26.46-6.22-35-17.56-35-46.66v-248a160.45 160.45 0 0 0-2.2-27.68c7.42-17.77 22.34-38.8 51.37-38.8 35.13 0 52.2 23.31 52.2 71.28V588z"></path></svg></a><div class="uq ur us ut uu uv n cm"><p class="bc b dv dw uw"><a href="https://medium.com/about?autoplay=1&amp;source=post_page-----e946bd69177a-----------------------------------" class="ea eb cb cc cd ce cf cg ch bn ux ci um un" rel="noopener follow">About</a></p><p class="bc b dv dw uw"><a href="https://medium.com/new-story?source=post_page-----e946bd69177a-----------------------------------" class="ea eb cb cc cd ce cf cg ch bn ux ci um un" rel="noopener follow">Write</a></p><p class="bc b dv dw uw"><a href="https://help.medium.com/hc/en-us?source=post_page-----e946bd69177a-----------------------------------" class="ea eb cb cc cd ce cf cg ch bn ux ci um un" rel="noopener follow">Help</a></p><p class="bc b dv dw uw"><a href="https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----e946bd69177a-----------------------------------" class="ea eb cb cc cd ce cf cg ch bn ux ci um un" rel="noopener follow">Legal</a></p></div></div><div class="am uy uz va co"><p class="bc b dv dw vb">Get the Medium app</p></div><div class="am vc sx co vd"><div class="bb s"><a href="https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&amp;mt=8&amp;ct=post_page&amp;source=post_page-----e946bd69177a-----------------------------------" class="ea eb cb cc cd ce cf cg ch bn uk ul ci um un" rel="noopener follow"><img alt="A button that says &#39;Download on the App Store&#39;, and if clicked it will lead you to the iOS App store" class="" src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/1_Crl55Tm6yDNMoucPo1tvDg.png" width="135" height="41"></a></div><div class="s"><a href="https://play.google.com/store/apps/details?id=com.medium.reader&amp;source=post_page-----e946bd69177a-----------------------------------" class="ea eb cb cc cd ce cf cg ch bn uk ul ci um un" rel="noopener follow"><img alt="A button that says &#39;Get it on, Google Play&#39;, and if clicked it will lead you to the Google Play store" class="" src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/1_W_RAPQ62h0em559zluJLdQ.png" width="135" height="41"></a></div></div></div></div></div></div></div></div></div><script>window.__BUILD_ID__="main-20211202-173400-48bc838b82"</script><script>window.__GRAPHQL_URI__ = "https://flattsecurity.medium.com/_/graphql"</script><script>window.__PRELOADED_STATE__ = {"algolia":{"queries":{}},"auroraPage":{"isAuroraPageEnabled":true},"bookReader":{"assets":{},"reader":{"currentAsset":null,"currentGFI":null,"settingsPanelIsOpen":false,"settings":{"fontFamily":"CHARTER","fontScale":"M","publisherStyling":false,"textAlignment":"start","theme":"White","lineSpacing":0,"wordSpacing":0,"letterSpacing":0},"internalNavCounter":0,"currentSelection":null}},"cache":{"experimentGroupSet":true,"reason":"","group":"enabled","tags":["group-edgeCachePosts","post-e946bd69177a","user-b10b5c7f48a"],"serverVariantState":"44136fa355b3678a1146ad16f7e8649e94fb4fc21fe77e8310c060f61caaff8a","middlewareEnabled":true,"cacheStatus":"DYNAMIC","shouldUseCache":true,"vary":[]},"client":{"hydrated":false,"isUs":false,"isNativeMedium":false,"isSafariMobile":false,"isSafari":false,"routingEntity":{"type":"USER","id":"b10b5c7f48a","explicit":true},"viewerIsBot":false},"debug":{"requestId":"a839a404-f5a0-43b8-b050-6dda9fcbc55b","hybridDevServices":[],"showBookReaderDebugger":false,"originalSpanCarrier":{"ot-tracer-spanid":"0a182d8d3670e2aa","ot-tracer-traceid":"7fdb99c369bc1aa7","ot-tracer-sampled":"true"}},"multiVote":{"clapsPerPost":{}},"navigation":{"branch":{"show":null,"hasRendered":null,"blockedByCTA":false},"hideGoogleOneTap":false,"hasRenderedGoogleOneTap":null,"hasRenderedAlternateUserBanner":null,"currentLocation":"https:\u002F\u002Fflattsecurity.medium.com\u002Fcve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a","host":"flattsecurity.medium.com","hostname":"flattsecurity.medium.com","referrer":"","hasSetReferrer":false,"susiModal":{"step":null,"operation":"register"},"postRead":false,"queryString":"","currentHash":""},"tracing":{},"userOnboarding":{"showFirstBookPurchaseTooltip":false},"config":{"nodeEnv":"production","version":"main-20211202-173400-48bc838b82","isTaggedVersion":false,"isMediumDotApp":false,"isMediumDotAppVariant":false,"target":"production","productName":"Medium","publicUrl":"https:\u002F\u002Fcdn-client.medium.com\u002Flite","authDomain":"medium.com","authGoogleClientId":"216296035834-k1k6qe060s2tp2a2jam4ljdcms00sttg.apps.googleusercontent.com","favicon":"production","glyphUrl":"https:\u002F\u002Fglyph.medium.com","branchKey":"key_live_ofxXr2qTrrU9NqURK8ZwEhknBxiI6KBm","lightStep":{"name":"lite-web","host":"lightstep.medium.systems","token":"ce5be895bef60919541332990ac9fef2","appVersion":"main-20211202-173400-48bc838b82","disableClientReporting":true},"algolia":{"appId":"MQ57UUUQZ2","apiKeySearch":"394474ced050e3911ae2249ecc774921","indexPrefix":"medium_","host":"-dsn.algolia.net"},"recaptchaKey":"6Lfc37IUAAAAAKGGtC6rLS13R1Hrw_BqADfS1LRk","recaptcha3Key":"6Lf8R9wUAAAAABMI_85Wb8melS7Zj6ziuf99Yot5","datadog":{"applicationId":"6702d87d-a7e0-42fe-bbcb-95b469547ea0","clientToken":"pub853ea8d17ad6821d9f8f11861d23dfed","rumToken":"pubf9cc52896502b9413b68ba36fc0c7162","context":{"deployment":{"target":"production","tag":"main-20211202-173400-48bc838b82","commit":"48bc838b82f251098929276cb1a97bedf4dd8245"}},"datacenter":"us"},"googleAnalyticsCode":"UA-24232453-2","googlePay":{"apiVersion":"2","apiVersionMinor":"0","merchantId":"BCR2DN6TV7EMTGBM","merchantName":"Medium","instanceMerchantId":"13685562959212738550"},"applePay":{"version":3},"signInWallCustomDomainCollectionIds":["3a8144eabfe3","336d898217ee","61061eb0c96b","138adf9c44c","819cc2aaeee0"],"mediumOwnedAndOperatedCollectionIds":["8a9336e5bb4","b7e45b22fec3","193b68bd4fba","8d6b8a439e32","54c98c43354d","3f6ecf56618","d944778ce714","92d2092dc598","ae2a65f35510","1285ba81cada","544c7006046e","fc8964313712","40187e704f1c","88d9857e584e","7b6769f2748b","bcc38c8f6edf","cef6983b292","cb8577c9149e","444d13b52878","713d7dbc99b0","ef8e90590e66","191186aaafa0","55760f21cdc5","9dc80918cc93","bdc4052bbdba","8ccfed20cbb2"],"tierOneDomains":["medium.com","thebolditalic.com","arcdigital.media","towardsdatascience.com","uxdesign.cc","codeburst.io","psiloveyou.xyz","writingcooperative.com","entrepreneurshandbook.co","prototypr.io","betterhumans.coach.me","theascent.pub"],"topicsToFollow":["d61cf867d93f","8a146bc21b28","1eca0103fff3","4d562ee63426","aef1078a3ef5","e15e46793f8d","6158eb913466","55f1c20aba7a","3d18b94f6858","4861fee224fd","63c6f1f93ee","1d98b3a9a871","decb52b64abf","ae5d4995e225","830cded25262"],"topicToTagMappings":{"accessibility":"accessibility","addiction":"addiction","android-development":"android-development","art":"art","artificial-intelligence":"artificial-intelligence","astrology":"astrology","basic-income":"basic-income","beauty":"beauty","biotech":"biotech","blockchain":"blockchain","books":"books","business":"business","cannabis":"cannabis","cities":"cities","climate-change":"climate-change","comics":"comics","coronavirus":"coronavirus","creativity":"creativity","cryptocurrency":"cryptocurrency","culture":"culture","cybersecurity":"cybersecurity","data-science":"data-science","design":"design","digital-life":"digital-life","disability":"disability","economy":"economy","education":"education","equality":"equality","family":"family","feminism":"feminism","fiction":"fiction","film":"film","fitness":"fitness","food":"food","freelancing":"freelancing","future":"future","gadgets":"gadgets","gaming":"gaming","gun-control":"gun-control","health":"health","history":"history","humor":"humor","immigration":"immigration","ios-development":"ios-development","javascript":"javascript","justice":"justice","language":"language","leadership":"leadership","lgbtqia":"lgbtqia","lifestyle":"lifestyle","machine-learning":"machine-learning","makers":"makers","marketing":"marketing","math":"math","media":"media","mental-health":"mental-health","mindfulness":"mindfulness","money":"money","music":"music","neuroscience":"neuroscience","nonfiction":"nonfiction","outdoors":"outdoors","parenting":"parenting","pets":"pets","philosophy":"philosophy","photography":"photography","podcasts":"podcast","poetry":"poetry","politics":"politics","privacy":"privacy","product-management":"product-management","productivity":"productivity","programming":"programming","psychedelics":"psychedelics","psychology":"psychology","race":"race","relationships":"relationships","religion":"religion","remote-work":"remote-work","san-francisco":"san-francisco","science":"science","self":"self","self-driving-cars":"self-driving-cars","sexuality":"sexuality","social-media":"social-media","society":"society","software-engineering":"software-engineering","space":"space","spirituality":"spirituality","sports":"sports","startups":"startup","style":"style","technology":"technology","transportation":"transportation","travel":"travel","true-crime":"true-crime","tv":"tv","ux":"ux","venture-capital":"venture-capital","visual-design":"visual-design","work":"work","world":"world","writing":"writing"},"defaultImages":{"avatar":{"imageId":"1*dmbNkD5D-u45r44go_cf0g.png","height":150,"width":150},"orgLogo":{"imageId":"1*OMF3fSqH8t4xBJ9-6oZDZw.png","height":106,"width":545},"postLogo":{"imageId":"1*kFrc4tBFM_tCis-2Ic87WA.png","height":810,"width":1440},"postPreviewImage":{"imageId":"1*hn4v1tCaJy7cWMyb0bpNpQ.png","height":386,"width":579}},"collectionStructuredData":{"8d6b8a439e32":{"name":"Elemental","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F980\u002F1*9ygdqoKprhwuTVKUM0DLPA@2x.png","width":980,"height":159}}},"3f6ecf56618":{"name":"Forge","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F596\u002F1*uULpIlImcO5TDuBZ6lm7Lg@2x.png","width":596,"height":183}}},"ae2a65f35510":{"name":"GEN","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F264\u002F1*RdVZMdvfV3YiZTw6mX7yWA.png","width":264,"height":140}}},"88d9857e584e":{"name":"LEVEL","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F540\u002F1*JqYMhNX6KNNb2UlqGqO2WQ.png","width":540,"height":108}}},"7b6769f2748b":{"name":"Marker","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F383\u002F1*haCUs0wF6TgOOvfoY-jEoQ@2x.png","width":383,"height":92}}},"444d13b52878":{"name":"OneZero","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F540\u002F1*cw32fIqCbRWzwJaoQw6BUg.png","width":540,"height":123}}},"8ccfed20cbb2":{"name":"Zora","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F540\u002F1*tZUQqRcCCZDXjjiZ4bDvgQ.png","width":540,"height":106}}}},"embeddedPostIds":{"coronavirus":"cd3010f9d81f"},"sharedCdcMessaging":{"COVID_APPLICABLE_TAG_SLUGS":[],"COVID_APPLICABLE_TOPIC_NAMES":[],"COVID_APPLICABLE_TOPIC_NAMES_FOR_TOPIC_PAGE":[],"COVID_MESSAGES":{"tierA":{"text":"For more information on the novel coronavirus and Covid-19, visit cdc.gov.","markups":[{"start":66,"end":73,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]},"tierB":{"text":"Anyone can publish on Medium per our Policies, but we don’t fact-check every story. For more info about the coronavirus, see cdc.gov.","markups":[{"start":37,"end":45,"href":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Fcategories\u002F201931128-Policies-Safety"},{"start":125,"end":132,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]},"paywall":{"text":"This article has been made free for everyone, thanks to Medium Members. For more information on the novel coronavirus and Covid-19, visit cdc.gov.","markups":[{"start":56,"end":70,"href":"https:\u002F\u002Fmedium.com\u002Fmembership"},{"start":138,"end":145,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]},"unbound":{"text":"This article is free for everyone, thanks to Medium Members. For more information on the novel coronavirus and Covid-19, visit cdc.gov.","markups":[{"start":45,"end":59,"href":"https:\u002F\u002Fmedium.com\u002Fmembership"},{"start":127,"end":134,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]}},"COVID_BANNER_POST_ID_OVERRIDE_WHITELIST":["3b31a67bff4a"]},"sharedVoteMessaging":{"TAGS":["politics","election-2020","government","us-politics","election","2020-presidential-race","trump","donald-trump","democrats","republicans","congress","republican-party","democratic-party","biden","joe-biden","maga"],"TOPICS":["politics","election"],"MESSAGE":{"text":"Find out more about the U.S. election results here.","markups":[{"start":46,"end":50,"href":"https:\u002F\u002Fcookpolitical.com\u002F2020-national-popular-vote-tracker"}]},"EXCLUDE_POSTS":["397ef29e3ca5"]},"embedPostRules":[],"recircOptions":{"v1":{"limit":3},"v2":{"limit":8}},"braintreeClientKey":"production_zjkj96jm_m56f8fqpf7ngnrd4","braintree":{"enabled":true,"merchantId":"m56f8fqpf7ngnrd4","merchantAccountId":{"usd":"medium","eur":"amediumcorporation_EUR"},"publicKey":"cwr8xtycwgjryv82","braintreeEnvironment":"production","dashboardUrl":"https:\u002F\u002Fwww.braintreegateway.com\u002Fmerchants","gracePeriodDurationInDays":14,"mediumMembershipPlanId":{"monthly":"ce105f8c57a3","monthlyWithTrial":"d5ee3dbe3db8","yearly":"a40ad4a43185","yearlyStaff":"d74fb811198a","yearlyWithTrial":"b3bc7350e5c7"},"braintreeDiscountId":{"oneMonthFree":"MONTHS_FREE_01","threeMonthsFree":"MONTHS_FREE_03","sixMonthsFree":"MONTHS_FREE_06"}},"paypalClientId":"AXj1G4fotC2GE8KzWX9mSxCH1wmPE3nJglf4Z2ig_amnhvlMVX87otaq58niAg9iuLktVNF_1WCMnN7v","paypal":{"host":"https:\u002F\u002Fapi.paypal.com:443","clientMode":"production","serverMode":"live","webhookId":"4G466076A0294510S","monthlyPlan":{"planId":"P-9WR0658853113943TMU5FDQA","name":"Medium Membership (Monthly) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"yearlyPlan":{"planId":"P-7N8963881P8875835MU5JOPQ","name":"Medium Membership (Annual) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"oneYearGift":{"name":"Medium Membership (1 Year, Digital Gift Code)","description":"Unlimited access to the best and brightest stories on Medium. Gift codes can be redeemed at medium.com\u002Fredeem.","price":"50.00","currency":"USD","sku":"membership-gift-1-yr"},"oldMonthlyPlan":{"planId":"P-96U02458LM656772MJZUVH2Y","name":"Medium Membership (Monthly)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"oldYearlyPlan":{"planId":"P-59P80963JF186412JJZU3SMI","name":"Medium Membership (Annual)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"monthlyPlanWithTrial":{"planId":"P-66C21969LR178604GJPVKUKY","name":"Medium Membership (Monthly) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"yearlyPlanWithTrial":{"planId":"P-6XW32684EX226940VKCT2MFA","name":"Medium Membership (Annual) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"oldMonthlyPlanNoSetupFee":{"planId":"P-4N046520HR188054PCJC7LJI","name":"Medium Membership (Monthly)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"oldYearlyPlanNoSetupFee":{"planId":"P-7A4913502Y5181304CJEJMXQ","name":"Medium Membership (Annual)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"sdkUrl":"https:\u002F\u002Fwww.paypal.com\u002Fsdk\u002Fjs"},"stripePublishableKey":"pk_live_7FReX44VnNIInZwrIIx6ghjl"},"session":{"xsrf":""}}</script><script>window.__APOLLO_STATE__ = {"ROOT_QUERY":{"__typename":"Query","meterPost({\"postId\":\"e946bd69177a\",\"postMeteringOptions\":{\"referrer\":\"https:\u002F\u002Fgithub.com\u002F0n3t04ll\u002Flinux-kernel-exploitation\",\"sk\":null,\"source\":null}})":{"__ref":"MeteringInfo:{}"},"postResult({\"id\":\"e946bd69177a\"})":{"__ref":"Post:e946bd69177a"}},"MeteringInfo:{}":{"__typename":"MeteringInfo","postIds":[],"maxUnlockCount":3,"unlocksRemaining":0},"User:b10b5c7f48a":{"id":"b10b5c7f48a","__typename":"User","customStyleSheet":{"__ref":"CustomStyleSheet:cdcf7ac4751a"},"isSuspended":false,"name":"Flatt Security Inc.","bio":"We are a cyber security company based in Tokyo, Japan. We provide security assessment services. HP: https:\u002F\u002Fflatt.tech\u002Fen CVE: https:\u002F\u002Fflatt.tech\u002Fcve","imageId":"1*Z0fxHngDdlFrMJQlA4GESw.png","hasCompletedProfile":false,"username":"flattsecurity","isAuroraVisible":true,"mediumMemberAt":0,"socialStats":{"__typename":"SocialStats","followerCount":16,"followingCount":1,"collectionFollowingCount":0},"customDomainState":{"__typename":"CustomDomainState","live":{"__typename":"CustomDomain","domain":"flattsecurity.medium.com","status":"ACTIVE","isSubdomain":true}},"hasSubdomain":true,"bookAuthor":null,"isPartnerProgramEnrolled":false,"viewerEdge":{"__ref":"UserViewerEdge:userId:b10b5c7f48a-viewerId:lo_39fe79c88e42"},"viewerIsUser":false,"newsletterV3":null,"homepagePostsConnection({\"paging\":{\"limit\":1}})":{"__typename":"PostConnection","posts":[{"__ref":"Post:e946bd69177a"}]},"postSubscribeMembershipUpsellShownAt":0,"allowNotes":true,"replyToEmailBannerShownCount":0,"twitterScreenName":"","followedCollections":0,"referredMembershipCustomHeadline":"","referredMembershipCustomBody":"","atsQualifiedAt":0},"CustomStyleSheet:cdcf7ac4751a":{"id":"cdcf7ac4751a","__typename":"CustomStyleSheet","blogroll":{"__typename":"BlogrollConfiguration","visibility":"BLOGROLL_VISIBILITY_SIDEBAR"},"global":{"__typename":"GlobalStyles","colorPalette":{"__typename":"StyleSheetColorPalette","primary":{"__typename":"ColorValue","colorPalette":{"__typename":"ColorPalette","tintBackgroundSpectrum":{"__typename":"ColorSpectrum","backgroundColor":"#FFd22550","colorPoints":[{"__typename":"ColorPoint","color":"#FFD22550","point":0},{"__typename":"ColorPoint","color":"#FFE14060","point":0.1},{"__typename":"ColorPoint","color":"#FFEF5771","point":0.2},{"__typename":"ColorPoint","color":"#FFFB6C81","point":0.3},{"__typename":"ColorPoint","color":"#FFFF8092","point":0.4},{"__typename":"ColorPoint","color":"#FFFF93A2","point":0.5},{"__typename":"ColorPoint","color":"#FFFFA6B2","point":0.6},{"__typename":"ColorPoint","color":"#FFFFB9C2","point":0.7},{"__typename":"ColorPoint","color":"#FFFFCBD3","point":0.8},{"__typename":"ColorPoint","color":"#FFFFDDE3","point":0.9},{"__typename":"ColorPoint","color":"#FFFFEEF3","point":1}]},"highlightSpectrum":{"__typename":"ColorSpectrum","backgroundColor":"#FFFFFFFF","colorPoints":[{"__typename":"ColorPoint","color":"#FFFFDFE4","point":0},{"__typename":"ColorPoint","color":"#FFFFD9E0","point":0.1},{"__typename":"ColorPoint","color":"#FFFFD4DB","point":0.2},{"__typename":"ColorPoint","color":"#FFFFCED7","point":0.3},{"__typename":"ColorPoint","color":"#FFFFC8D3","point":0.4},{"__typename":"ColorPoint","color":"#FFFFC2CF","point":0.5},{"__typename":"ColorPoint","color":"#FFFFBCCA","point":0.6},{"__typename":"ColorPoint","color":"#FFFFB6C6","point":0.7},{"__typename":"ColorPoint","color":"#FFFFB0C2","point":0.8},{"__typename":"ColorPoint","color":"#FFFFAABE","point":0.9},{"__typename":"ColorPoint","color":"#FFFFA3B9","point":1}]},"defaultBackgroundSpectrum":{"__typename":"ColorSpectrum","backgroundColor":"#FFFFFFFF","colorPoints":[{"__typename":"ColorPoint","color":"#FFE5355C","point":0},{"__typename":"ColorPoint","color":"#FFD33557","point":0.1},{"__typename":"ColorPoint","color":"#FFC23451","point":0.2},{"__typename":"ColorPoint","color":"#FFB0334B","point":0.3},{"__typename":"ColorPoint","color":"#FF9E3145","point":0.4},{"__typename":"ColorPoint","color":"#FF8C2D3E","point":0.5},{"__typename":"ColorPoint","color":"#FF792937","point":0.6},{"__typename":"ColorPoint","color":"#FF67252F","point":0.7},{"__typename":"ColorPoint","color":"#FF541F27","point":0.8},{"__typename":"ColorPoint","color":"#FF40181E","point":0.9},{"__typename":"ColorPoint","color":"#FF2C0F13","point":1}]}}},"background":{"__typename":"ColorValue","colorPalette":{"__typename":"ColorPalette","highlightSpectrum":{"__typename":"ColorSpectrum","backgroundColor":"#FFFFFFFF","colorPoints":[{"__typename":"ColorPoint","color":"#FFF4F2F2","point":0},{"__typename":"ColorPoint","color":"#FFF2F0F0","point":0.1},{"__typename":"ColorPoint","color":"#FFF0EEEE","point":0.2},{"__typename":"ColorPoint","color":"#FFEEECEC","point":0.3},{"__typename":"ColorPoint","color":"#FFECEBEA","point":0.4},{"__typename":"ColorPoint","color":"#FFEAE9E8","point":0.5},{"__typename":"ColorPoint","color":"#FFE8E7E7","point":0.6},{"__typename":"ColorPoint","color":"#FFE6E5E5","point":0.7},{"__typename":"ColorPoint","color":"#FFE4E3E3","point":0.8},{"__typename":"ColorPoint","color":"#FFE2E1E1","point":0.9},{"__typename":"ColorPoint","color":"#FFE0DFDF","point":1}]},"defaultBackgroundSpectrum":{"__typename":"ColorSpectrum","backgroundColor":"#FFFFFFFF","colorPoints":[{"__typename":"ColorPoint","color":"#FF848585","point":0},{"__typename":"ColorPoint","color":"#FF7B7B7B","point":0.1},{"__typename":"ColorPoint","color":"#FF717272","point":0.2},{"__typename":"ColorPoint","color":"#FF686868","point":0.3},{"__typename":"ColorPoint","color":"#FF5E5E5E","point":0.4},{"__typename":"ColorPoint","color":"#FF545454","point":0.5},{"__typename":"ColorPoint","color":"#FF494A4A","point":0.6},{"__typename":"ColorPoint","color":"#FF3F3F3F","point":0.7},{"__typename":"ColorPoint","color":"#FF333333","point":0.8},{"__typename":"ColorPoint","color":"#FF272727","point":0.9},{"__typename":"ColorPoint","color":"#FF1A1A1A","point":1}]},"tintBackgroundSpectrum":{"__typename":"ColorSpectrum","backgroundColor":"#FFfafafa","colorPoints":[{"__typename":"ColorPoint","color":"#FFFAFAFA","point":0},{"__typename":"ColorPoint","color":"#FFE8E8E8","point":0.1},{"__typename":"ColorPoint","color":"#FFD5D5D5","point":0.2},{"__typename":"ColorPoint","color":"#FFC1C2C2","point":0.3},{"__typename":"ColorPoint","color":"#FFADAEAE","point":0.4},{"__typename":"ColorPoint","color":"#FF999A9A","point":0.5},{"__typename":"ColorPoint","color":"#FF848585","point":0.6},{"__typename":"ColorPoint","color":"#FF6D6F6F","point":0.7},{"__typename":"ColorPoint","color":"#FF565757","point":0.8},{"__typename":"ColorPoint","color":"#FF3D3E3E","point":0.9},{"__typename":"ColorPoint","color":"#FF202122","point":1}]}},"rgb":"fafafa","alpha":"ff"}},"fonts":{"__typename":"StyleSheetFonts","font1":{"__typename":"StyleSheetFont","name":"SANS_SERIF_1"},"font2":{"__typename":"StyleSheetFont","name":"SANS_SERIF_1"},"font3":{"__typename":"StyleSheetFont","name":"SERIF_2"}}},"header":{"__typename":"HeaderStyles","backgroundColor":null,"postBackgroundColor":null,"backgroundImage":null,"headerScale":"HEADER_SCALE_SMALL","horizontalAlignment":"START","backgroundImageDisplayMode":"IMAGE_DISPLAY_MODE_FILL","backgroundImageVerticalAlignment":"START","backgroundColorDisplayMode":"COLOR_DISPLAY_MODE_SOLID","secondaryBackgroundColor":null,"nameColor":null,"nameTreatment":"NAME_TREATMENT_TEXT","postNameTreatment":"NAME_TREATMENT_LOGO","logoImage":null,"logoScale":"HEADER_SCALE_MEDIUM","taglineColor":null,"taglineTreatment":"TAGLINE_TREATMENT_SIDEBAR"},"postBody":null,"navigation":null},"UserViewerEdge:userId:b10b5c7f48a-viewerId:lo_39fe79c88e42":{"id":"userId:b10b5c7f48a-viewerId:lo_39fe79c88e42","__typename":"UserViewerEdge","isFollowing":false,"isUser":false},"Post:e946bd69177a":{"id":"e946bd69177a","__typename":"Post","creator":{"__ref":"User:b10b5c7f48a"},"canonicalUrl":"","collection":null,"content({\"postMeteringOptions\":{\"referrer\":\"https:\u002F\u002Fgithub.com\u002F0n3t04ll\u002Flinux-kernel-exploitation\",\"sk\":null,\"source\":null}})":{"__typename":"PostContent","isLockedPreviewOnly":false,"validatedShareKey":"","bodyModel":{"__typename":"RichText","paragraphs":[{"__ref":"Paragraph:179db53d15aa_0"},{"__ref":"Paragraph:179db53d15aa_1"},{"__ref":"Paragraph:179db53d15aa_2"},{"__ref":"Paragraph:179db53d15aa_3"},{"__ref":"Paragraph:179db53d15aa_4"},{"__ref":"Paragraph:179db53d15aa_5"},{"__ref":"Paragraph:179db53d15aa_6"},{"__ref":"Paragraph:179db53d15aa_7"},{"__ref":"Paragraph:179db53d15aa_8"},{"__ref":"Paragraph:179db53d15aa_9"},{"__ref":"Paragraph:179db53d15aa_10"},{"__ref":"Paragraph:179db53d15aa_11"},{"__ref":"Paragraph:179db53d15aa_12"},{"__ref":"Paragraph:179db53d15aa_13"},{"__ref":"Paragraph:179db53d15aa_14"},{"__ref":"Paragraph:179db53d15aa_15"},{"__ref":"Paragraph:179db53d15aa_16"},{"__ref":"Paragraph:179db53d15aa_17"},{"__ref":"Paragraph:179db53d15aa_18"},{"__ref":"Paragraph:179db53d15aa_19"},{"__ref":"Paragraph:179db53d15aa_20"},{"__ref":"Paragraph:179db53d15aa_21"},{"__ref":"Paragraph:179db53d15aa_22"},{"__ref":"Paragraph:179db53d15aa_23"},{"__ref":"Paragraph:179db53d15aa_24"},{"__ref":"Paragraph:179db53d15aa_25"},{"__ref":"Paragraph:179db53d15aa_26"},{"__ref":"Paragraph:179db53d15aa_27"},{"__ref":"Paragraph:179db53d15aa_28"},{"__ref":"Paragraph:179db53d15aa_29"},{"__ref":"Paragraph:179db53d15aa_30"},{"__ref":"Paragraph:179db53d15aa_31"},{"__ref":"Paragraph:179db53d15aa_32"},{"__ref":"Paragraph:179db53d15aa_33"},{"__ref":"Paragraph:179db53d15aa_34"},{"__ref":"Paragraph:179db53d15aa_35"},{"__ref":"Paragraph:179db53d15aa_36"},{"__ref":"Paragraph:179db53d15aa_37"},{"__ref":"Paragraph:179db53d15aa_38"},{"__ref":"Paragraph:179db53d15aa_39"},{"__ref":"Paragraph:179db53d15aa_40"},{"__ref":"Paragraph:179db53d15aa_41"},{"__ref":"Paragraph:179db53d15aa_42"},{"__ref":"Paragraph:179db53d15aa_43"},{"__ref":"Paragraph:179db53d15aa_44"},{"__ref":"Paragraph:179db53d15aa_45"},{"__ref":"Paragraph:179db53d15aa_46"},{"__ref":"Paragraph:179db53d15aa_47"},{"__ref":"Paragraph:179db53d15aa_48"},{"__ref":"Paragraph:179db53d15aa_49"},{"__ref":"Paragraph:179db53d15aa_50"},{"__ref":"Paragraph:179db53d15aa_51"},{"__ref":"Paragraph:179db53d15aa_52"},{"__ref":"Paragraph:179db53d15aa_53"},{"__ref":"Paragraph:179db53d15aa_54"},{"__ref":"Paragraph:179db53d15aa_55"},{"__ref":"Paragraph:179db53d15aa_56"},{"__ref":"Paragraph:179db53d15aa_57"},{"__ref":"Paragraph:179db53d15aa_58"},{"__ref":"Paragraph:179db53d15aa_59"},{"__ref":"Paragraph:179db53d15aa_60"},{"__ref":"Paragraph:179db53d15aa_61"},{"__ref":"Paragraph:179db53d15aa_62"},{"__ref":"Paragraph:179db53d15aa_63"},{"__ref":"Paragraph:179db53d15aa_64"},{"__ref":"Paragraph:179db53d15aa_65"},{"__ref":"Paragraph:179db53d15aa_66"},{"__ref":"Paragraph:179db53d15aa_67"},{"__ref":"Paragraph:179db53d15aa_68"},{"__ref":"Paragraph:179db53d15aa_69"},{"__ref":"Paragraph:179db53d15aa_70"},{"__ref":"Paragraph:179db53d15aa_71"},{"__ref":"Paragraph:179db53d15aa_72"},{"__ref":"Paragraph:179db53d15aa_73"},{"__ref":"Paragraph:179db53d15aa_74"},{"__ref":"Paragraph:179db53d15aa_75"},{"__ref":"Paragraph:179db53d15aa_76"},{"__ref":"Paragraph:179db53d15aa_77"},{"__ref":"Paragraph:179db53d15aa_78"},{"__ref":"Paragraph:179db53d15aa_79"},{"__ref":"Paragraph:179db53d15aa_80"},{"__ref":"Paragraph:179db53d15aa_81"},{"__ref":"Paragraph:179db53d15aa_82"},{"__ref":"Paragraph:179db53d15aa_83"},{"__ref":"Paragraph:179db53d15aa_84"},{"__ref":"Paragraph:179db53d15aa_85"},{"__ref":"Paragraph:179db53d15aa_86"},{"__ref":"Paragraph:179db53d15aa_87"},{"__ref":"Paragraph:179db53d15aa_88"},{"__ref":"Paragraph:179db53d15aa_89"},{"__ref":"Paragraph:179db53d15aa_90"},{"__ref":"Paragraph:179db53d15aa_91"},{"__ref":"Paragraph:179db53d15aa_92"},{"__ref":"Paragraph:179db53d15aa_93"},{"__ref":"Paragraph:179db53d15aa_94"},{"__ref":"Paragraph:179db53d15aa_95"},{"__ref":"Paragraph:179db53d15aa_96"},{"__ref":"Paragraph:179db53d15aa_97"},{"__ref":"Paragraph:179db53d15aa_98"},{"__ref":"Paragraph:179db53d15aa_99"},{"__ref":"Paragraph:179db53d15aa_100"},{"__ref":"Paragraph:179db53d15aa_101"},{"__ref":"Paragraph:179db53d15aa_102"},{"__ref":"Paragraph:179db53d15aa_103"},{"__ref":"Paragraph:179db53d15aa_104"},{"__ref":"Paragraph:179db53d15aa_105"},{"__ref":"Paragraph:179db53d15aa_106"},{"__ref":"Paragraph:179db53d15aa_107"},{"__ref":"Paragraph:179db53d15aa_108"},{"__ref":"Paragraph:179db53d15aa_109"},{"__ref":"Paragraph:179db53d15aa_110"},{"__ref":"Paragraph:179db53d15aa_111"},{"__ref":"Paragraph:179db53d15aa_112"},{"__ref":"Paragraph:179db53d15aa_113"},{"__ref":"Paragraph:179db53d15aa_114"},{"__ref":"Paragraph:179db53d15aa_115"},{"__ref":"Paragraph:179db53d15aa_116"},{"__ref":"Paragraph:179db53d15aa_117"},{"__ref":"Paragraph:179db53d15aa_118"},{"__ref":"Paragraph:179db53d15aa_119"},{"__ref":"Paragraph:179db53d15aa_120"},{"__ref":"Paragraph:179db53d15aa_121"},{"__ref":"Paragraph:179db53d15aa_122"},{"__ref":"Paragraph:179db53d15aa_123"},{"__ref":"Paragraph:179db53d15aa_124"},{"__ref":"Paragraph:179db53d15aa_125"},{"__ref":"Paragraph:179db53d15aa_126"},{"__ref":"Paragraph:179db53d15aa_127"},{"__ref":"Paragraph:179db53d15aa_128"},{"__ref":"Paragraph:179db53d15aa_129"},{"__ref":"Paragraph:179db53d15aa_130"},{"__ref":"Paragraph:179db53d15aa_131"},{"__ref":"Paragraph:179db53d15aa_132"},{"__ref":"Paragraph:179db53d15aa_133"},{"__ref":"Paragraph:179db53d15aa_134"},{"__ref":"Paragraph:179db53d15aa_135"},{"__ref":"Paragraph:179db53d15aa_136"},{"__ref":"Paragraph:179db53d15aa_137"},{"__ref":"Paragraph:179db53d15aa_138"},{"__ref":"Paragraph:179db53d15aa_139"},{"__ref":"Paragraph:179db53d15aa_140"},{"__ref":"Paragraph:179db53d15aa_141"},{"__ref":"Paragraph:179db53d15aa_142"},{"__ref":"Paragraph:179db53d15aa_143"},{"__ref":"Paragraph:179db53d15aa_144"},{"__ref":"Paragraph:179db53d15aa_145"},{"__ref":"Paragraph:179db53d15aa_146"},{"__ref":"Paragraph:179db53d15aa_147"},{"__ref":"Paragraph:179db53d15aa_148"},{"__ref":"Paragraph:179db53d15aa_149"},{"__ref":"Paragraph:179db53d15aa_150"},{"__ref":"Paragraph:179db53d15aa_151"},{"__ref":"Paragraph:179db53d15aa_152"},{"__ref":"Paragraph:179db53d15aa_153"},{"__ref":"Paragraph:179db53d15aa_154"},{"__ref":"Paragraph:179db53d15aa_155"},{"__ref":"Paragraph:179db53d15aa_156"},{"__ref":"Paragraph:179db53d15aa_157"},{"__ref":"Paragraph:179db53d15aa_158"},{"__ref":"Paragraph:179db53d15aa_159"},{"__ref":"Paragraph:179db53d15aa_160"},{"__ref":"Paragraph:179db53d15aa_161"},{"__ref":"Paragraph:179db53d15aa_162"},{"__ref":"Paragraph:179db53d15aa_163"},{"__ref":"Paragraph:179db53d15aa_164"},{"__ref":"Paragraph:179db53d15aa_165"},{"__ref":"Paragraph:179db53d15aa_166"},{"__ref":"Paragraph:179db53d15aa_167"},{"__ref":"Paragraph:179db53d15aa_168"},{"__ref":"Paragraph:179db53d15aa_169"},{"__ref":"Paragraph:179db53d15aa_170"},{"__ref":"Paragraph:179db53d15aa_171"},{"__ref":"Paragraph:179db53d15aa_172"},{"__ref":"Paragraph:179db53d15aa_173"},{"__ref":"Paragraph:179db53d15aa_174"},{"__ref":"Paragraph:179db53d15aa_175"},{"__ref":"Paragraph:179db53d15aa_176"},{"__ref":"Paragraph:179db53d15aa_177"},{"__ref":"Paragraph:179db53d15aa_178"},{"__ref":"Paragraph:179db53d15aa_179"},{"__ref":"Paragraph:179db53d15aa_180"},{"__ref":"Paragraph:179db53d15aa_181"},{"__ref":"Paragraph:179db53d15aa_182"},{"__ref":"Paragraph:179db53d15aa_183"},{"__ref":"Paragraph:179db53d15aa_184"},{"__ref":"Paragraph:179db53d15aa_185"},{"__ref":"Paragraph:179db53d15aa_186"},{"__ref":"Paragraph:179db53d15aa_187"},{"__ref":"Paragraph:179db53d15aa_188"},{"__ref":"Paragraph:179db53d15aa_189"},{"__ref":"Paragraph:179db53d15aa_190"},{"__ref":"Paragraph:179db53d15aa_191"},{"__ref":"Paragraph:179db53d15aa_192"},{"__ref":"Paragraph:179db53d15aa_193"},{"__ref":"Paragraph:179db53d15aa_194"},{"__ref":"Paragraph:179db53d15aa_195"},{"__ref":"Paragraph:179db53d15aa_196"},{"__ref":"Paragraph:179db53d15aa_197"}],"sections":[{"__typename":"Section","name":"13a6","startIndex":0,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"77fd","startIndex":6,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"1490","startIndex":11,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"d594","startIndex":16,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"d55d","startIndex":97,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"38b3","startIndex":164,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"a5f9","startIndex":170,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"00e5","startIndex":172,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"4a25","startIndex":194,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"598f","startIndex":196,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null}]}},"customStyleSheet":{"__ref":"CustomStyleSheet:cdcf7ac4751a"},"firstPublishedAt":1624287357678,"isIndexable":true,"isLocked":false,"isPublished":true,"isShortform":false,"layerCake":0,"primaryTopic":null,"title":"CVE-2021–20226 a reference counting bug which leads to local privilege escalation in io_uring.","isMarkedPaywallOnly":false,"mediumUrl":"https:\u002F\u002Fflattsecurity.medium.com\u002Fcve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a","isLimitedState":false,"inResponseToPostResult":null,"inResponseToCatalogResult":null,"visibility":"PUBLIC","license":"ALL_RIGHTS_RESERVED","allowResponses":true,"newsletterId":"","sequence":null,"tags":[{"__ref":"Tag:cybersecurity"},{"__ref":"Tag:linux"},{"__ref":"Tag:security"},{"__ref":"Tag:vulnerability"}],"topics":[],"isNewsletter":false,"isPublishToEmail":false,"socialTitle":"","socialDek":"","noIndex":null,"curationStatus":null,"metaDescription":"","latestPublishedAt":1624456263455,"readingTime":19.88867924528302,"previewContent":{"__typename":"PreviewContent","subtitle":"Hello, I’m Shiga( @Ga_ryo_ ), a security engineer at Flatt Security Inc."},"previewImage":{"__ref":"ImageMetadata:1*xTPZ_N__RtSfTA7J7kTSBA.png"},"clapCount":16,"postResponses":{"__typename":"PostResponses","count":0},"isSuspended":false,"pendingCollection":null,"statusForCollection":null,"lockedSource":"LOCKED_POST_SOURCE_NONE","pinnedAt":0,"pinnedByCreatorAt":1624287475430,"curationEligibleAt":0,"responseDistribution":"NOT_DISTRIBUTED","internalLinks({\"paging\":{\"limit\":8}})":{"__typename":"InternalLinksConnection","items":[]},"viewerEdge":{"__ref":"PostViewerEdge:postId:e946bd69177a-viewerId:lo_39fe79c88e42"},"collaborators":[],"translationSourcePost":null,"inResponseToMediaResource":null,"audioVersionUrl":"","seoTitle":"","updatedAt":1624456272479,"shortformType":"SHORTFORM_TYPE_LINK","structuredData":"","seoDescription":"In this article, I would like to give you a technical description of CVE-2021–20226( ZDI-2021–001 ) which is published before. I discovered this vulnerability and reported it to the vendor via the…","latestPublishedVersion":"179db53d15aa","voterCount":11,"recommenders":[],"content({})":{"__typename":"PostContent","isLockedPreviewOnly":false,"validatedShareKey":"","bodyModel":{"__typename":"RichText","paragraphs":[{"__ref":"Paragraph:179db53d15aa_0"},{"__ref":"Paragraph:179db53d15aa_1"},{"__ref":"Paragraph:179db53d15aa_2"},{"__ref":"Paragraph:179db53d15aa_3"},{"__ref":"Paragraph:179db53d15aa_4"},{"__ref":"Paragraph:179db53d15aa_5"},{"__ref":"Paragraph:179db53d15aa_6"},{"__ref":"Paragraph:179db53d15aa_7"},{"__ref":"Paragraph:179db53d15aa_8"},{"__ref":"Paragraph:179db53d15aa_9"},{"__ref":"Paragraph:179db53d15aa_10"},{"__ref":"Paragraph:179db53d15aa_11"},{"__ref":"Paragraph:179db53d15aa_12"},{"__ref":"Paragraph:179db53d15aa_13"},{"__ref":"Paragraph:179db53d15aa_14"},{"__ref":"Paragraph:179db53d15aa_15"},{"__ref":"Paragraph:179db53d15aa_16"},{"__ref":"Paragraph:179db53d15aa_17"},{"__ref":"Paragraph:179db53d15aa_18"},{"__ref":"Paragraph:179db53d15aa_19"},{"__ref":"Paragraph:179db53d15aa_20"},{"__ref":"Paragraph:179db53d15aa_21"},{"__ref":"Paragraph:179db53d15aa_22"},{"__ref":"Paragraph:179db53d15aa_23"},{"__ref":"Paragraph:179db53d15aa_24"},{"__ref":"Paragraph:179db53d15aa_25"},{"__ref":"Paragraph:179db53d15aa_26"},{"__ref":"Paragraph:179db53d15aa_27"},{"__ref":"Paragraph:179db53d15aa_28"},{"__ref":"Paragraph:179db53d15aa_29"},{"__ref":"Paragraph:179db53d15aa_30"},{"__ref":"Paragraph:179db53d15aa_31"},{"__ref":"Paragraph:179db53d15aa_32"},{"__ref":"Paragraph:179db53d15aa_33"},{"__ref":"Paragraph:179db53d15aa_34"},{"__ref":"Paragraph:179db53d15aa_35"},{"__ref":"Paragraph:179db53d15aa_36"},{"__ref":"Paragraph:179db53d15aa_37"},{"__ref":"Paragraph:179db53d15aa_38"},{"__ref":"Paragraph:179db53d15aa_39"},{"__ref":"Paragraph:179db53d15aa_40"},{"__ref":"Paragraph:179db53d15aa_41"},{"__ref":"Paragraph:179db53d15aa_42"},{"__ref":"Paragraph:179db53d15aa_43"},{"__ref":"Paragraph:179db53d15aa_44"},{"__ref":"Paragraph:179db53d15aa_45"},{"__ref":"Paragraph:179db53d15aa_46"},{"__ref":"Paragraph:179db53d15aa_47"},{"__ref":"Paragraph:179db53d15aa_48"},{"__ref":"Paragraph:179db53d15aa_49"},{"__ref":"Paragraph:179db53d15aa_50"},{"__ref":"Paragraph:179db53d15aa_51"},{"__ref":"Paragraph:179db53d15aa_52"},{"__ref":"Paragraph:179db53d15aa_53"},{"__ref":"Paragraph:179db53d15aa_54"},{"__ref":"Paragraph:179db53d15aa_55"},{"__ref":"Paragraph:179db53d15aa_56"},{"__ref":"Paragraph:179db53d15aa_57"},{"__ref":"Paragraph:179db53d15aa_58"},{"__ref":"Paragraph:179db53d15aa_59"},{"__ref":"Paragraph:179db53d15aa_60"},{"__ref":"Paragraph:179db53d15aa_61"},{"__ref":"Paragraph:179db53d15aa_62"},{"__ref":"Paragraph:179db53d15aa_63"},{"__ref":"Paragraph:179db53d15aa_64"},{"__ref":"Paragraph:179db53d15aa_65"},{"__ref":"Paragraph:179db53d15aa_66"},{"__ref":"Paragraph:179db53d15aa_67"},{"__ref":"Paragraph:179db53d15aa_68"},{"__ref":"Paragraph:179db53d15aa_69"},{"__ref":"Paragraph:179db53d15aa_70"},{"__ref":"Paragraph:179db53d15aa_71"},{"__ref":"Paragraph:179db53d15aa_72"},{"__ref":"Paragraph:179db53d15aa_73"},{"__ref":"Paragraph:179db53d15aa_74"},{"__ref":"Paragraph:179db53d15aa_75"},{"__ref":"Paragraph:179db53d15aa_76"},{"__ref":"Paragraph:179db53d15aa_77"},{"__ref":"Paragraph:179db53d15aa_78"},{"__ref":"Paragraph:179db53d15aa_79"},{"__ref":"Paragraph:179db53d15aa_80"},{"__ref":"Paragraph:179db53d15aa_81"},{"__ref":"Paragraph:179db53d15aa_82"},{"__ref":"Paragraph:179db53d15aa_83"},{"__ref":"Paragraph:179db53d15aa_84"},{"__ref":"Paragraph:179db53d15aa_85"},{"__ref":"Paragraph:179db53d15aa_86"},{"__ref":"Paragraph:179db53d15aa_87"},{"__ref":"Paragraph:179db53d15aa_88"},{"__ref":"Paragraph:179db53d15aa_89"},{"__ref":"Paragraph:179db53d15aa_90"},{"__ref":"Paragraph:179db53d15aa_91"},{"__ref":"Paragraph:179db53d15aa_92"},{"__ref":"Paragraph:179db53d15aa_93"},{"__ref":"Paragraph:179db53d15aa_94"},{"__ref":"Paragraph:179db53d15aa_95"},{"__ref":"Paragraph:179db53d15aa_96"},{"__ref":"Paragraph:179db53d15aa_97"},{"__ref":"Paragraph:179db53d15aa_98"},{"__ref":"Paragraph:179db53d15aa_99"},{"__ref":"Paragraph:179db53d15aa_100"},{"__ref":"Paragraph:179db53d15aa_101"},{"__ref":"Paragraph:179db53d15aa_102"},{"__ref":"Paragraph:179db53d15aa_103"},{"__ref":"Paragraph:179db53d15aa_104"},{"__ref":"Paragraph:179db53d15aa_105"},{"__ref":"Paragraph:179db53d15aa_106"},{"__ref":"Paragraph:179db53d15aa_107"},{"__ref":"Paragraph:179db53d15aa_108"},{"__ref":"Paragraph:179db53d15aa_109"},{"__ref":"Paragraph:179db53d15aa_110"},{"__ref":"Paragraph:179db53d15aa_111"},{"__ref":"Paragraph:179db53d15aa_112"},{"__ref":"Paragraph:179db53d15aa_113"},{"__ref":"Paragraph:179db53d15aa_114"},{"__ref":"Paragraph:179db53d15aa_115"},{"__ref":"Paragraph:179db53d15aa_116"},{"__ref":"Paragraph:179db53d15aa_117"},{"__ref":"Paragraph:179db53d15aa_118"},{"__ref":"Paragraph:179db53d15aa_119"},{"__ref":"Paragraph:179db53d15aa_120"},{"__ref":"Paragraph:179db53d15aa_121"},{"__ref":"Paragraph:179db53d15aa_122"},{"__ref":"Paragraph:179db53d15aa_123"},{"__ref":"Paragraph:179db53d15aa_124"},{"__ref":"Paragraph:179db53d15aa_125"},{"__ref":"Paragraph:179db53d15aa_126"},{"__ref":"Paragraph:179db53d15aa_127"},{"__ref":"Paragraph:179db53d15aa_128"},{"__ref":"Paragraph:179db53d15aa_129"},{"__ref":"Paragraph:179db53d15aa_130"},{"__ref":"Paragraph:179db53d15aa_131"},{"__ref":"Paragraph:179db53d15aa_132"},{"__ref":"Paragraph:179db53d15aa_133"},{"__ref":"Paragraph:179db53d15aa_134"},{"__ref":"Paragraph:179db53d15aa_135"},{"__ref":"Paragraph:179db53d15aa_136"},{"__ref":"Paragraph:179db53d15aa_137"},{"__ref":"Paragraph:179db53d15aa_138"},{"__ref":"Paragraph:179db53d15aa_139"},{"__ref":"Paragraph:179db53d15aa_140"},{"__ref":"Paragraph:179db53d15aa_141"},{"__ref":"Paragraph:179db53d15aa_142"},{"__ref":"Paragraph:179db53d15aa_143"},{"__ref":"Paragraph:179db53d15aa_144"},{"__ref":"Paragraph:179db53d15aa_145"},{"__ref":"Paragraph:179db53d15aa_146"},{"__ref":"Paragraph:179db53d15aa_147"},{"__ref":"Paragraph:179db53d15aa_148"},{"__ref":"Paragraph:179db53d15aa_149"},{"__ref":"Paragraph:179db53d15aa_150"},{"__ref":"Paragraph:179db53d15aa_151"},{"__ref":"Paragraph:179db53d15aa_152"},{"__ref":"Paragraph:179db53d15aa_153"},{"__ref":"Paragraph:179db53d15aa_154"},{"__ref":"Paragraph:179db53d15aa_155"},{"__ref":"Paragraph:179db53d15aa_156"},{"__ref":"Paragraph:179db53d15aa_157"},{"__ref":"Paragraph:179db53d15aa_158"},{"__ref":"Paragraph:179db53d15aa_159"},{"__ref":"Paragraph:179db53d15aa_160"},{"__ref":"Paragraph:179db53d15aa_161"},{"__ref":"Paragraph:179db53d15aa_162"},{"__ref":"Paragraph:179db53d15aa_163"},{"__ref":"Paragraph:179db53d15aa_164"},{"__ref":"Paragraph:179db53d15aa_165"},{"__ref":"Paragraph:179db53d15aa_166"},{"__ref":"Paragraph:179db53d15aa_167"},{"__ref":"Paragraph:179db53d15aa_168"},{"__ref":"Paragraph:179db53d15aa_169"},{"__ref":"Paragraph:179db53d15aa_170"},{"__ref":"Paragraph:179db53d15aa_171"},{"__ref":"Paragraph:179db53d15aa_172"},{"__ref":"Paragraph:179db53d15aa_173"},{"__ref":"Paragraph:179db53d15aa_174"},{"__ref":"Paragraph:179db53d15aa_175"},{"__ref":"Paragraph:179db53d15aa_176"},{"__ref":"Paragraph:179db53d15aa_177"},{"__ref":"Paragraph:179db53d15aa_178"},{"__ref":"Paragraph:179db53d15aa_179"},{"__ref":"Paragraph:179db53d15aa_180"},{"__ref":"Paragraph:179db53d15aa_181"},{"__ref":"Paragraph:179db53d15aa_182"},{"__ref":"Paragraph:179db53d15aa_183"},{"__ref":"Paragraph:179db53d15aa_184"},{"__ref":"Paragraph:179db53d15aa_185"},{"__ref":"Paragraph:179db53d15aa_186"},{"__ref":"Paragraph:179db53d15aa_187"},{"__ref":"Paragraph:179db53d15aa_188"},{"__ref":"Paragraph:179db53d15aa_189"},{"__ref":"Paragraph:179db53d15aa_190"},{"__ref":"Paragraph:179db53d15aa_191"},{"__ref":"Paragraph:179db53d15aa_192"},{"__ref":"Paragraph:179db53d15aa_193"},{"__ref":"Paragraph:179db53d15aa_194"},{"__ref":"Paragraph:179db53d15aa_195"},{"__ref":"Paragraph:179db53d15aa_196"},{"__ref":"Paragraph:179db53d15aa_197"}],"sections":[{"__typename":"Section","name":"13a6","startIndex":0,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"77fd","startIndex":6,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"1490","startIndex":11,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"d594","startIndex":16,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"d55d","startIndex":97,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"38b3","startIndex":164,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"a5f9","startIndex":170,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"00e5","startIndex":172,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"4a25","startIndex":194,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"598f","startIndex":196,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null}]}}},"Paragraph:179db53d15aa_0":{"id":"179db53d15aa_0","__typename":"Paragraph","name":"f6e0","text":"CVE-2021–20226 a reference counting bug which leads to local privilege escalation in io_uring.","type":"H3","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_1":{"id":"179db53d15aa_1","__typename":"Paragraph","name":"8d92","text":"","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*xTPZ_N__RtSfTA7J7kTSBA.png"},"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_2":{"id":"179db53d15aa_2","__typename":"Paragraph","name":"f098","text":"Hello, I’m Shiga( @Ga_ryo_ ), a security engineer at Flatt Security Inc.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":18,"end":26,"type":"A","href":"https:\u002F\u002Ftwitter.com\u002FGa_ryo_","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_3":{"id":"179db53d15aa_3","__typename":"Paragraph","name":"dc51","text":"In this article, I would like to give you a technical description of CVE-2021–20226( ZDI-2021–001 ) which is published before. I discovered this vulnerability and reported it to the vendor via the Zero Day Initiative. This article is not intended to inform you of the dangers of vulnerabilities, but to share tips from a technical point of view.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":85,"end":97,"type":"A","href":"https:\u002F\u002Fwww.zerodayinitiative.com\u002Fadvisories\u002FZDI-21-001\u002F","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_4":{"id":"179db53d15aa_4","__typename":"Paragraph","name":"ae50","text":"An overview of the vulnerabilities and attack methods can be found at the links below. This blog will explain in a little more detail.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_5":{"id":"179db53d15aa_5","__typename":"Paragraph","name":"6ded","text":"https:\u002F\u002Fwww.zerodayinitiative.com\u002Fblog\u002F2021\u002F4\u002F22\u002Fcve-2021-20226-a-reference-counting-bug-in-the-linux-kernel-iouring- subsystem","type":"ULI","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":127,"type":"A","href":"https:\u002F\u002Fwww.zerodayinitiative.com\u002Fblog\u002F2021\u002F4\u002F22\u002Fcve-2021-20226-a-reference-counting-bug-in-the-linux-kernel-iouring- subsystem","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_6":{"id":"179db53d15aa_6","__typename":"Paragraph","name":"4ef0","text":"Notes","type":"H4","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_7":{"id":"179db53d15aa_7","__typename":"Paragraph","name":"db88","text":"If you have any questions or found any mistakes, I’d appreciate it if you could contact me individually. And, the code in this article basically refers to the Linux Kernel source code at Linux kernel 5.6.19.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":187,"end":206,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_8":{"id":"179db53d15aa_8","__typename":"Paragraph","name":"5ad9","text":"io_uring is one of the actively updated features as of 2021, and the information changes as the version changes (many changes have been made since the time I discovered it). Therefore, please note that the information is not up-to-date even at the time of writing the blog.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_9":{"id":"179db53d15aa_9","__typename":"Paragraph","name":"eeb8","text":"General terms\u002Fknowledge in the Linux Kernel are not explained in this blog.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_10":{"id":"179db53d15aa_10","__typename":"Paragraph","name":"f1d7","text":"I will explain the outline of the PoC I wrote, but I will not post the actual code.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_11":{"id":"179db53d15aa_11","__typename":"Paragraph","name":"2575","text":"Overview","type":"H4","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":8,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_12":{"id":"179db53d15aa_12","__typename":"Paragraph","name":"3f12","text":"Preconditions","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":13,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_13":{"id":"179db53d15aa_13","__typename":"Paragraph","name":"285b","text":"Arbitrary code(command) execution in the system.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_14":{"id":"179db53d15aa_14","__typename":"Paragraph","name":"7c5f","text":"Impact","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":6,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_15":{"id":"179db53d15aa_15","__typename":"Paragraph","name":"dd6d","text":"Privilege escalation to root.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_16":{"id":"179db53d15aa_16","__typename":"Paragraph","name":"11c3","text":"What is io_uring","type":"H4","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":16,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_17":{"id":"179db53d15aa_17","__typename":"Paragraph","name":"2cf3","text":"Rough explanation","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":17,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_18":{"id":"179db53d15aa_18","__typename":"Paragraph","name":"1eb1","text":"Roughly speaking, io_uring is the latest asynchronous I\u002FO(Network\u002FFilesystem) mechanism.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_19":{"id":"179db53d15aa_19","__typename":"Paragraph","name":"0256","text":"Please refer to some blogs\u002Fslides posted on the Internet for specs and detailed descriptions from the user’s perspective. \nFrom here, I will continue to explain the outline of io_uring on the assumption that you understand it.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_20":{"id":"179db53d15aa_20","__typename":"Paragraph","name":"ad4a","text":"In io_uring, a file descriptor is first generated by a dedicated system call (io_uring_setup), and by issuing mmap() system call to it, Submission Queue(SQ) and Completion Queue(CQ) are mapped\u002Fshared in userspace memory.\nThis is used as ring buffer by both sides(Kernel\u002FUserspace).\nEntries for each system call such as read\u002Fwrite\u002Fsend\u002Frecv are registered by writing SQE(Submission Queue Entry) to the shared memory.\nAnd then execution is started by calling io_uring_enter().","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":78,"end":92,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":110,"end":116,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":457,"end":473,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_21":{"id":"179db53d15aa_21","__typename":"Paragraph","name":"54b3","text":"","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*RBvfw3fmI2rxgBBUb6Yifw.png"},"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_22":{"id":"179db53d15aa_22","__typename":"Paragraph","name":"4d3b","text":"Asynchronous execution","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":22,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_23":{"id":"179db53d15aa_23","__typename":"Paragraph","name":"4033","text":"By the way, the important part this time is the implementation of asynchronous execution, so I will focus on that.\nTo explain it first, io_uring is not always executed asynchronously, but it is executed asynchronously as needed.\nPlease refer to the code below first.(After this, the Kernel v5.8 will be used to explain the behavior. The behavior may be slightly different from your environment.)","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":194,"end":227,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_24":{"id":"179db53d15aa_24","__typename":"Paragraph","name":"21c5","text":"#define _GNU_SOURCE\n#include \u003Csched.h\u003E\n#include \u003Cstdio.h\u003E\n#include \u003Cstring.h\u003E\n#include \u003Cstdlib.h\u003E\n#include \u003Csignal.h\u003E\n#include \u003Csys\u002Fsyscall.h\u003E\n#include \u003Csys\u002Ffcntl.h\u003E\n#include \u003Cerr.h\u003E\n#include \u003Cunistd.h\u003E\n#include \u003Csys\u002Fmman.h\u003E\n#include \u003Clinux\u002Fio_uring.h\u003E","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_25":{"id":"179db53d15aa_25","__typename":"Paragraph","name":"cba2","text":"#define SYSCHK(x) ({          \\\n  typeof(x) __res = (x);      \\\n  if (__res == (typeof(x))-1) \\\n    err(1, \"SYSCHK(\" #x \")\"); \\\n  __res;                      \\\n})","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_26":{"id":"179db53d15aa_26","__typename":"Paragraph","name":"9cfc","text":"static int uring_fd;","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_27":{"id":"179db53d15aa_27","__typename":"Paragraph","name":"f4cf","text":"struct iovec *io;\n#define SIZE 32\nchar _buf[SIZE];","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_28":{"id":"179db53d15aa_28","__typename":"Paragraph","name":"25d1","text":"int main(void) {\n  \u002F\u002F initialize uring\n  struct io_uring_params params = { };\n  uring_fd = SYSCHK(syscall(__NR_io_uring_setup, \u002F*entries=*\u002F10, &params));\n  unsigned char *sq_ring = SYSCHK(mmap(NULL, 0x1000, PROT_READ|PROT_WRITE,\n                                       MAP_SHARED, uring_fd,\n                                       IORING_OFF_SQ_RING));\n  unsigned char *cq_ring = SYSCHK(mmap(NULL, 0x1000, PROT_READ|PROT_WRITE,\n                                       MAP_SHARED, uring_fd,\n                                       IORING_OFF_CQ_RING));\n  struct io_uring_sqe *sqes = SYSCHK(mmap(NULL, 0x1000, PROT_READ|PROT_WRITE,\n                                          MAP_SHARED, uring_fd,\n                                          IORING_OFF_SQES));","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_29":{"id":"179db53d15aa_29","__typename":"Paragraph","name":"942f","text":"io = malloc(sizeof(struct iovec)*1);\n  io[0].iov_base = _buf;\n  io[0].iov_len = SIZE;","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_30":{"id":"179db53d15aa_30","__typename":"Paragraph","name":"79c3","text":"struct timespec ts = { .tv_sec = 1 };\n  sqes[0] = (struct io_uring_sqe) {\n    .opcode = IORING_OP_TIMEOUT,\n    \u002F\u002F.flags = IOSQE_IO_HARDLINK,\n    .len = 1,\n    .addr = (unsigned long)&ts\n  };\n  sqes[1] = (struct io_uring_sqe) {\n    .opcode = IORING_OP_READV,\n    .addr = io,\n    .flags = 0,\n    .len = 1,\n    .off = 0,\n    .fd = SYSCHK(open(\"\u002Fetc\u002Fpasswd\", O_RDONLY))\n  };\n  ((int*)(sq_ring + params.sq_off.array))[0] = 0;\n  ((int*)(sq_ring + params.sq_off.array))[1] = 1;\n  (*(int*)(sq_ring + params.sq_off.tail)) += 2;","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_31":{"id":"179db53d15aa_31","__typename":"Paragraph","name":"2df3","text":"int submitted = SYSCHK(syscall(__NR_io_uring_enter, uring_fd,\n                                 \u002F*to_submit=*\u002F2, \u002F*min_complete=*\u002F0,\n                                 \u002F*flags=*\u002F0, \u002F*sig=*\u002FNULL, \u002F*sigsz=*\u002F0));\n  while(1){\n    usleep(100000);\n    if(*_buf){\n      puts(\"READV executed.\");\n      break;\n    }\n    puts(\"Waiting.\");\n  }\n}","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_32":{"id":"179db53d15aa_32","__typename":"Paragraph","name":"4ecc","text":"In this code, after performing the necessary setup for the operations IORING_OP_TIMEOUT and IORING_OP_READV, it starts execution and then checks every 0.1 seconds to see if readv() is complete.\nIt seems that readv() will be completed after 1 second, considering that it is executed in the order of ring buffer. However, when I actually run it, the result was as follows.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":70,"end":87,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":92,"end":107,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":173,"end":180,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":208,"end":215,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_33":{"id":"179db53d15aa_33","__typename":"Paragraph","name":"496b","text":"$ .\u002Fsample\nREADV executed.","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_34":{"id":"179db53d15aa_34","__typename":"Paragraph","name":"e93c","text":"That is, execution of readv() was completed immediately.\nThis is because, as I said earlier, it is executed asynchronously as needed, but in this case an execution of readv() can be completed immediately (because it is known that its execution does not stop). So subsequent operation was compeleted first (IORING_OP_TIMEOUT was ignored for the time being).\nAs a test, check that readv() is executed synchronously (= in the handler of the system call) with the following systemtap[¹] script.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":22,"end":29,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":167,"end":174,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":306,"end":323,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":379,"end":386,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":99,"end":132,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_35":{"id":"179db53d15aa_35","__typename":"Paragraph","name":"ae37","text":"[¹]: A tool that allows you to flexibly execute scripts, such as tracing Kernel (but not only) functions and outputting variables at the traced points. I love this tool because Kernel debugging is a hassle.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_36":{"id":"179db53d15aa_36","__typename":"Paragraph","name":"8a5d","text":"#!\u002Fusr\u002Fbin\u002Fstap","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_37":{"id":"179db53d15aa_37","__typename":"Paragraph","name":"c6fb","text":"probe kernel.function(\"io_read@\u002Fbuild\u002Flinux-b4NE0x\u002Flinux-5.8.0\u002Ffs\u002Fio_uring.c:2710\"){\n  printf(\"%s\\n\",task_execname(task_current()))\n}","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_38":{"id":"179db53d15aa_38","__typename":"Paragraph","name":"96cc","text":"↓ This is the output when the previous program (name of the file is sample) is executed while above systemtap script is being executed. If it is asynchronous, it is easy to imagine that the execution task is registered in some worker, but since it is executed synchronously here, the name of the executable file which called the system call is printed.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":68,"end":74,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_39":{"id":"179db53d15aa_39","__typename":"Paragraph","name":"a26c","text":"$ sudo stap -g .\u002Fsample.stp\nsample","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":17,"end":23,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":28,"end":34,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_40":{"id":"179db53d15aa_40","__typename":"Paragraph","name":"71f9","text":"","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*eDQhEUjvJmCxETqhzH_vgQ.png"},"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_41":{"id":"179db53d15aa_41","__typename":"Paragraph","name":"7d01","text":"So where did IORING_OP_TIMEOUT go? The answer is “passed to the Kernel Thread because it was determined that asynchronous execution was needed”. There are several criteria for this, and if they meet, they will be enqueued into the Queue for asynchronous execution. Here are some examples.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":13,"end":30,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":50,"end":142,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_42":{"id":"179db53d15aa_42","__typename":"Paragraph","name":"1830","text":"1. When the force async flag is enabled","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_43":{"id":"179db53d15aa_43","__typename":"Paragraph","name":"ac66","text":"} else if (req-\u003Eflags & REQ_F_FORCE_ASYNC) {\n  ......\n  \u002F*\n   * Never try inline submit of IOSQE_ASYNC is set, go straight\n   * to async execution.\n   *\u002F\n  req-\u003Ework.flags |= IO_WQ_WORK_CONCURRENT;\n  io_queue_async_work(req);","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_44":{"id":"179db53d15aa_44","__typename":"Paragraph","name":"ea51","text":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio_uring.c#L4825","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":67,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio_uring.c#L4825","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_45":{"id":"179db53d15aa_45","__typename":"Paragraph","name":"d3d0","text":"2. Decisions by the logic prepared for each operation. (e.g. Add IOCB_NOWAIT flag when calling readv() and return EAGAIN if execution is expected to stop)","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":95,"end":102,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_46":{"id":"179db53d15aa_46","__typename":"Paragraph","name":"044e","text":"static int io_read(struct io_kiocb *req, struct io_kiocb **nxt,\n     bool force_nonblock)\n{\n ......\n ret = rw_verify_area(READ, req-\u003Efile, &kiocb-\u003Eki_pos, iov_count);\n if (!ret) {\n  ssize_t ret2;","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_47":{"id":"179db53d15aa_47","__typename":"Paragraph","name":"e200","text":"if (req-\u003Efile-\u003Ef_op-\u003Eread_iter)\n   ret2 = call_read_iter(req-\u003Efile, kiocb, &iter);\n  else\n   ret2 = loop_rw_iter(READ, req-\u003Efile, kiocb, &iter);","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_48":{"id":"179db53d15aa_48","__typename":"Paragraph","name":"2eee","text":"\u002F* Catch -EAGAIN return for forced non-blocking submission *\u002F\n  if (!force_nonblock || ret2 != -EAGAIN) {\n   kiocb_done(kiocb, ret2, nxt, req-\u003Ein_async);\n  } else {\ncopy_iov:\n   ret = io_setup_async_rw(req, io_size, iovec,\n      inline_vecs, &iter);\n   if (ret)\n    goto out_free;\n   return -EAGAIN;\n  }\n }\n    ......\n}","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_49":{"id":"179db53d15aa_49","__typename":"Paragraph","name":"181a","text":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio_uring.c#L2224","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":67,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio_uring.c#L2224","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_50":{"id":"179db53d15aa_50","__typename":"Paragraph","name":"647f","text":"When EAGAIN is returned, it is enqueued into the Queue for asynchronous execution (if it is a type of operation that uses file descriptors, it gets references to the file structure here).","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":166,"end":170,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_51":{"id":"179db53d15aa_51","__typename":"Paragraph","name":"b0a0","text":"static void __io_queue_sqe(struct io_kiocb *req, const struct io_uring_sqe *sqe)\n{\n ......","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_52":{"id":"179db53d15aa_52","__typename":"Paragraph","name":"f59c","text":"ret = io_issue_sqe(req, sqe, &nxt, true);","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_53":{"id":"179db53d15aa_53","__typename":"Paragraph","name":"eba2","text":"\u002F*\n  * We async punt it if the file wasn't marked NOWAIT, or if the file\n  * doesn't support non-blocking read\u002Fwrite attempts\n  *\u002F\n if (ret == -EAGAIN && (!(req-\u003Eflags & REQ_F_NOWAIT) ||\n     (req-\u003Eflags & REQ_F_MUST_PUNT))) {\npunt:\n  if (io_op_defs[req-\u003Eopcode].file_table) {\n   ret = io_grab_files(req);\n   if (ret)\n    goto err;\n  }","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_54":{"id":"179db53d15aa_54","__typename":"Paragraph","name":"4232","text":"\u002F*\n   * Queued up for async execution, worker will release\n   * submit reference when the iocb is actually submitted.\n   *\u002F\n  io_queue_async_work(req);\n  goto done_req;\n }\n ......\n}","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_55":{"id":"179db53d15aa_55","__typename":"Paragraph","name":"ee2e","text":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio_uring.c#L4741","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":67,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio_uring.c#L4741","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_56":{"id":"179db53d15aa_56","__typename":"Paragraph","name":"cc5c","text":"static int io_issue_sqe(struct io_kiocb *req, const struct io_uring_sqe *sqe,\n   struct io_kiocb **nxt, bool force_nonblock)\n{\n struct io_ring_ctx *ctx = req-\u003Ectx;\n int ret;","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_57":{"id":"179db53d15aa_57","__typename":"Paragraph","name":"c0fa","text":"switch (req-\u003Eopcode) {\n case IORING_OP_NOP:\n  ret = io_nop(req);\n  break;\n case IORING_OP_READV:\n case IORING_OP_READ_FIXED:\n case IORING_OP_READ:\n  if (sqe) {\n   ret = io_read_prep(req, sqe, force_nonblock);\n   if (ret \u003C 0)\n    break;\n  }\n  ret = io_read(req, nxt, force_nonblock);\n  break;","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_58":{"id":"179db53d15aa_58","__typename":"Paragraph","name":"8a42","text":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio_uring.c#L4314","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":67,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio_uring.c#L4314","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_59":{"id":"179db53d15aa_59","__typename":"Paragraph","name":"bafb","text":"3. When the IOSQE_IO_LINK|IOSQE_IO_HARDLINK flag is used(the execution order is specified) and the operation whose execution order is earlier is determined to require asynchronous execution.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":12,"end":43,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_60":{"id":"179db53d15aa_60","__typename":"Paragraph","name":"d676","text":"(Connect as a link as described in the code below, execute in order, and if condition 2 is met in the middle, whole link will be enqueued into the asynchronous execution queue)","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_61":{"id":"179db53d15aa_61","__typename":"Paragraph","name":"e80f","text":"static bool io_submit_sqe(struct io_kiocb *req, const struct io_uring_sqe *sqe,\n     struct io_submit_state *state, struct io_kiocb **link)\n{\n ......\n \u002F*\n  * If we already have a head request, queue this one for async\n  * submittal once the head completes. If we don't have a head but\n  * IOSQE_IO_LINK is set in the sqe, start a new head. This one will be\n  * submitted sync once the chain is complete. If none of those\n  * conditions are true (normal request), then just queue it.\n  *\u002F\n if (*link) {\n  ......\n  list_add_tail(&req-\u003Elink_list, &head-\u003Elink_list);","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_62":{"id":"179db53d15aa_62","__typename":"Paragraph","name":"d817","text":"\u002F* last request of a link, enqueue the link *\u002F\n  if (!(sqe_flags & (IOSQE_IO_LINK|IOSQE_IO_HARDLINK))) {\n   io_queue_link_head(head);\n   *link = NULL;\n  }\n } else {\n  ......\n  if (sqe_flags & (IOSQE_IO_LINK|IOSQE_IO_HARDLINK)) {\n   req-\u003Eflags |= REQ_F_LINK;\n   INIT_LIST_HEAD(&req-\u003Elink_list);","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_63":{"id":"179db53d15aa_63","__typename":"Paragraph","name":"866a","text":"if (io_alloc_async_ctx(req)) {\n    ret = -EAGAIN;\n    goto err_req;\n   }\n   ret = io_req_defer_prep(req, sqe);\n   if (ret)\n    req-\u003Eflags |= REQ_F_FAIL_LINK;\n   *link = req;\n  } else {\n   io_queue_sqe(req, sqe);\n  }\n }","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_64":{"id":"179db53d15aa_64","__typename":"Paragraph","name":"3352","text":"return true;\n}","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_65":{"id":"179db53d15aa_65","__typename":"Paragraph","name":"4b99","text":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio_uring.c#L4858","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":67,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio_uring.c#L4858","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_66":{"id":"179db53d15aa_66","__typename":"Paragraph","name":"9bc9","text":"Strictly speaking, IORING_OP_TIMEOUT is a little special and does not return EAGAIN like shown in 2. But (I think) it is easy to understand, so I use it as a sample.\nAs shown below, by linking an operation that requires asynchronous execution (IORING_OP_TIMEOUT) with another operation, you can see that the previous IORING_OP_READV is certainly executed after waiting for 1 second.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":19,"end":36,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":244,"end":261,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":317,"end":332,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_67":{"id":"179db53d15aa_67","__typename":"Paragraph","name":"10dd","text":"Add IOSQE_IO_HARDLINK flag to the IORING_OP_TIMEOUT operation in the sample code above to clarify that it is linked to the subsequent operation.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":4,"end":21,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":34,"end":51,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_68":{"id":"179db53d15aa_68","__typename":"Paragraph","name":"7821","text":"48c48\n\u003C     \u002F\u002F.flags = IOSQE_IO_HARDLINK,\n---\n\u003E     .flags = IOSQE_IO_HARDLINK,","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_69":{"id":"179db53d15aa_69","__typename":"Paragraph","name":"1067","text":"Execution result","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_70":{"id":"179db53d15aa_70","__typename":"Paragraph","name":"d5f9","text":"$ .\u002Fsample\nWaiting.\nWaiting.\nWaiting.\nWaiting.\nWaiting.\nWaiting.\nWaiting.\nWaiting.\nWaiting.\nREADV executed.","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_71":{"id":"179db53d15aa_71","__typename":"Paragraph","name":"fa30","text":"At this time, if you display the name of the process that is executing io_read() in the same way as before, you will get the following output.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":71,"end":80,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_72":{"id":"179db53d15aa_72","__typename":"Paragraph","name":"7ce9","text":"$ sudo stap -g .\u002Fsample.stp\nio_wqe_worker-0","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_73":{"id":"179db53d15aa_73","__typename":"Paragraph","name":"3695","text":"As you can see by looking at the process list, this is a Kernel Thread.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_74":{"id":"179db53d15aa_74","__typename":"Paragraph","name":"6625","text":"$ ps aux | grep -A 2 -m 1 sample\ngaryo     131388  0.0  0.0   2492  1412 pts\u002F1    S+   19:03   0:00 .\u002Fsample\nroot      131389  0.0  0.0      0     0 ?        S    19:03   0:00 [io_wq_manager]\nroot      131390  0.0  0.0      0     0 ?        S    19:03   0:00 [io_wqe_worker-0]","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_75":{"id":"179db53d15aa_75","__typename":"Paragraph","name":"5ab2","text":"Hereafter, this Kernel Thread will be referred to as a “worker”. This worker is generated by the following code and then, dequeues and executes the asynchronous execution tasks from Queue.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_76":{"id":"179db53d15aa_76","__typename":"Paragraph","name":"377c","text":"static bool create_io_worker(struct io_wq *wq, struct io_wqe *wqe, int index)\n{\n ......","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_77":{"id":"179db53d15aa_77","__typename":"Paragraph","name":"91ac","text":"worker-\u003Etask = kthread_create_on_node(io_wqe_worker, worker, wqe-\u003Enode,\n    \"io_wqe_worker-%d\u002F%d\", index, wqe-\u003Enode);\n ......\n}","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_78":{"id":"179db53d15aa_78","__typename":"Paragraph","name":"64a9","text":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio-wq.c#L621","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":63,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio-wq.c#L621","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_79":{"id":"179db53d15aa_79","__typename":"Paragraph","name":"27e5","text":"Aside: As explained earlier, IORING_OP_TIMEOUT behaves slightly differently from the figure below, but it is described as such for simplicity. Strictly speaking, when io_timeout() is called, it sets io_timeout_fn() in the handler and starts the timer. After the time set by the timer has elapsed, io_timeout_fn() is called to load the operations connected to the link in the asynchronous execution queue. In other words, IORING_OP_TIMEOUT itself is not enqueued in the asynchronous execution queue. TIMEOUT is used in the explanation so that it is easy to imagine that execution will stop.","type":"BQ","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":29,"end":46,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":167,"end":179,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":199,"end":214,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":297,"end":312,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":421,"end":438,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":0,"end":589,"type":"EM","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_80":{"id":"179db53d15aa_80","__typename":"Paragraph","name":"c5b5","text":"","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*r97ABC6g0FPqn1sSyg17cA.png"},"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_81":{"id":"179db53d15aa_81","__typename":"Paragraph","name":"c24b","text":"Precautions when offloading I\u002FO operations to the Kernel","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":56,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_82":{"id":"179db53d15aa_82","__typename":"Paragraph","name":"5518","text":"It was found out that asynchronous processing is performed by a worker running as a Kernel Thread. However, there is a precaution here. Since worker is runninng as a Kernel Thread, the execution context is different from the thread which calls io_uring related system calls.\nHere, the “execution context” means the task_struct structure associated with the process and various information associated with it.\nFor example, mm (Manage the virtual memory space of the process) , cred (holds UID\u002FGID\u002FCapability),files_struct (holds a table for file descriptors. There’s an array of file structure in files_struct structure, and file descriptor is its index) and so on.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":315,"end":326,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":578,"end":582,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":596,"end":608,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":422,"end":424,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Finclude\u002Flinux\u002Fsched.h#L732","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","start":476,"end":480,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Finclude\u002Flinux\u002Fsched.h#L883","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","start":508,"end":520,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Finclude\u002Flinux\u002Fsched.h#L913","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_83":{"id":"179db53d15aa_83","__typename":"Paragraph","name":"6ef0","text":"Of course, if it doesn’t refer to these structures in the thread that calls the system call, it may refer to the wrong virtual memory or file descriptor table, or issue I\u002FO operations with Kernel Thread privileges (≒ root) [²].","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_84":{"id":"179db53d15aa_84","__typename":"Paragraph","name":"eafe","text":"[²]: By the way, this was an actual vulnerability, and at that time it forgot to switch cred, and operations were able to be executed with root privileges. Although the operation equivalent to open open() was not implemented at that time, it was possible to notify the privilege in sendmsg’s SCM_CREDENTIALS option that notifies the sender’s authority. It is a problem around D-Bus because the authority is confirmed by it. https:\u002F\u002Fwww.exploit-db.com\u002Fexploits\u002F47779","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":198,"end":204,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":424,"end":465,"type":"A","href":"https:\u002F\u002Fwww.exploit-db.com\u002Fexploits\u002F47779","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_85":{"id":"179db53d15aa_85","__typename":"Paragraph","name":"f8da","text":"Therefore, in io_uring, those references are passed to the worker so that the worker shares the execution context by switching its own context before execution. For example, you can see that then references to mm and cred are passed to the req-\u003Ework in the following code.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":210,"end":212,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":217,"end":221,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":240,"end":249,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_86":{"id":"179db53d15aa_86","__typename":"Paragraph","name":"2428","text":"static inline void io_req_work_grab_env(struct io_kiocb *req,\n     const struct io_op_def *def)\n{\n if (!req-\u003Ework.mm && def-\u003Eneeds_mm) {\n  mmgrab(current-\u003Emm);\n  req-\u003Ework.mm = current-\u003Emm;\n }\n if (!req-\u003Ework.creds)\n  req-\u003Ework.creds = get_current_cred();\n if (!req-\u003Ework.fs && def-\u003Eneeds_fs) {\n  spin_lock(&current-\u003Efs-\u003Elock);\n  if (!current-\u003Efs-\u003Ein_exec) {\n   req-\u003Ework.fs = current-\u003Efs;\n   req-\u003Ework.fs-\u003Eusers++;\n  } else {\n   req-\u003Ework.flags |= IO_WQ_WORK_CANCEL;\n  }\n  spin_unlock(&current-\u003Efs-\u003Elock);\n }\n if (!req-\u003Ework.task_pid)\n  req-\u003Ework.task_pid = task_pid_vnr(current);\n}","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_87":{"id":"179db53d15aa_87","__typename":"Paragraph","name":"71ff","text":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio_uring.c#L910","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":66,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio_uring.c#L910","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_88":{"id":"179db53d15aa_88","__typename":"Paragraph","name":"b575","text":"You can see that the reference to files_struct is passed to the req-\u003Ework in the following code.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":34,"end":46,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":64,"end":73,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_89":{"id":"179db53d15aa_89","__typename":"Paragraph","name":"00f0","text":"static int io_grab_files(struct io_kiocb *req)\n{\n ......\n if (fcheck(ctx-\u003Ering_fd) == ctx-\u003Ering_file) {\n  list_add(&req-\u003Einflight_entry, &ctx-\u003Einflight_list);\n  req-\u003Eflags |= REQ_F_INFLIGHT;\n  req-\u003Ework.files = current-\u003Efiles;\n  ret = 0;\n }\n ......\n}","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_90":{"id":"179db53d15aa_90","__typename":"Paragraph","name":"98a1","text":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio_uring.c#L4634","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":67,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio_uring.c#L4634","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_91":{"id":"179db53d15aa_91","__typename":"Paragraph","name":"a567","text":"Then, before execution, these are replaced with the contents of the worker’s current (a macro that gets the task_struct currently running thread).","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":77,"end":84,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":108,"end":119,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_92":{"id":"179db53d15aa_92","__typename":"Paragraph","name":"227c","text":"static void io_worker_handle_work(struct io_worker *worker)\n __releases(wqe-\u003Elock)\n{\n struct io_wq_work *work, *old_work = NULL, *put_work = NULL;\n struct io_wqe *wqe = worker-\u003Ewqe;\n struct io_wq *wq = wqe-\u003Ewq;","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_93":{"id":"179db53d15aa_93","__typename":"Paragraph","name":"7715","text":"do {\n  ......","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_94":{"id":"179db53d15aa_94","__typename":"Paragraph","name":"a3d1","text":"if (work-\u003Efiles && current-\u003Efiles != work-\u003Efiles) {\n   task_lock(current);\n   current-\u003Efiles = work-\u003Efiles;\n   task_unlock(current);\n  }\n  if (work-\u003Efs && current-\u003Efs != work-\u003Efs)\n   current-\u003Efs = work-\u003Efs;\n  if (work-\u003Emm != worker-\u003Emm)\n   io_wq_switch_mm(worker, work);\n  if (worker-\u003Ecur_creds != work-\u003Ecreds)\n   io_wq_switch_creds(worker, work);\n  ......\n  work-\u003Efunc(&work);\n  ......\n } while (1);\n}","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_95":{"id":"179db53d15aa_95","__typename":"Paragraph","name":"3b72","text":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio-wq.c#L443","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":63,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio-wq.c#L443","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_96":{"id":"179db53d15aa_96","__typename":"Paragraph","name":"efde","text":"","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*QWqIM-GZDKXEn_OTofMx3A.png"},"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_97":{"id":"179db53d15aa_97","__typename":"Paragraph","name":"0284","text":"Vulnerability explanation","type":"H3","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":25,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_98":{"id":"179db53d15aa_98","__typename":"Paragraph","name":"3c98","text":"Reference counter in files_struct structure when sharing with the worker","type":"H4","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":72,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_99":{"id":"179db53d15aa_99","__typename":"Paragraph","name":"d25b","text":"Now, let’s move on to the explanation of the vulnerabilities. In the code below (I posted earlier), you can see that the worker is passing a reference to the files_struct structure of the thread executing the system call to the structure that the worker will refer later without incrementing the reference counter.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":158,"end":170,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":271,"end":313,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_100":{"id":"179db53d15aa_100","__typename":"Paragraph","name":"e704","text":"static int io_grab_files(struct io_kiocb *req)\n{\n ......\n if (fcheck(ctx-\u003Ering_fd) == ctx-\u003Ering_file) {\n  list_add(&req-\u003Einflight_entry, &ctx-\u003Einflight_list);\n  req-\u003Eflags |= REQ_F_INFLIGHT;\n  req-\u003Ework.files = current-\u003Efiles;\n  ret = 0;\n }\n ......\n}","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_101":{"id":"179db53d15aa_101","__typename":"Paragraph","name":"8d74","text":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio_uring.c#L4634","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":67,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio_uring.c#L4634","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_102":{"id":"179db53d15aa_102","__typename":"Paragraph","name":"a6d3","text":"By the way, as explained briefly earlier, when enqueueing a task in the Queue for asynchronous execution, the reference to the file structure is retained first from the specified file descriptor (passed to the io_kiocb structure).","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":127,"end":131,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":210,"end":218,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_103":{"id":"179db53d15aa_103","__typename":"Paragraph","name":"7b59","text":"static int io_req_set_file(struct io_submit_state *state, struct io_kiocb *req,\n      const struct io_uring_sqe *sqe)\n{\n struct io_ring_ctx *ctx = req-\u003Ectx;\n unsigned flags;\n int fd;","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_104":{"id":"179db53d15aa_104","__typename":"Paragraph","name":"5455","text":"flags = READ_ONCE(sqe-\u003Eflags);\n fd = READ_ONCE(sqe-\u003Efd);","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_105":{"id":"179db53d15aa_105","__typename":"Paragraph","name":"a76c","text":"if (!io_req_needs_file(req, fd))\n  return 0;","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_106":{"id":"179db53d15aa_106","__typename":"Paragraph","name":"c93b","text":"if (flags & IOSQE_FIXED_FILE) {\n  if (unlikely(!ctx-\u003Efile_data ||\n      (unsigned) fd \u003E= ctx-\u003Enr_user_files))\n   return -EBADF;\n  fd = array_index_nospec(fd, ctx-\u003Enr_user_files);\n  req-\u003Efile = io_file_from_index(ctx, fd);\n  if (!req-\u003Efile)\n   return -EBADF;\n  req-\u003Eflags |= REQ_F_FIXED_FILE;\n  percpu_ref_get(&ctx-\u003Efile_data-\u003Erefs);\n } else {\n  if (req-\u003Eneeds_fixed_file)\n   return -EBADF;\n  trace_io_uring_file_get(ctx, fd);\n  req-\u003Efile = io_file_get(state, fd);\n  if (unlikely(!req-\u003Efile))\n   return -EBADF;\n }","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_107":{"id":"179db53d15aa_107","__typename":"Paragraph","name":"1916","text":"return 0;\n}","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_108":{"id":"179db53d15aa_108","__typename":"Paragraph","name":"7ca9","text":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio_uring.c#L4599","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":67,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio_uring.c#L4599","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_109":{"id":"179db53d15aa_109","__typename":"Paragraph","name":"0cf9","text":"","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*65Fa3NkAmqj_iQ82kxigqw.png"},"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_110":{"id":"179db53d15aa_110","__typename":"Paragraph","name":"4fdb","text":"So the worker does not have to retrieve it from the file descriptor again and does not need to refer to the files_struct structure. If so, it seems that there is no problem that the reference counter of the files_struct structure is not incremented(because it is not used). \nBut this assumption is not true in Linux Kernel 5.5 and later. This is because system calls that affect file descriptor tables, such as open\u002Fclose\u002Faccept , are now available via io_uring. Obviously, these system calls affect the file descriptor table, so it looks like something can be used for exploitation However,","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":108,"end":120,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":207,"end":219,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":411,"end":415,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":416,"end":421,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":422,"end":428,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_111":{"id":"179db53d15aa_111","__typename":"Paragraph","name":"17b3","text":"Even if you simply calls open\u002Fclose\u002Faccept etc., nothing can happen if the files_struct structure is available. \n — Of course, system calls have countermeasures when handling the same file by multiple threads, so it is not possible to simply cause a race condition between the calling thread and the worker.","type":"ULI","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":25,"end":29,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":30,"end":35,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":36,"end":42,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":75,"end":87,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":145,"end":208,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_112":{"id":"179db53d15aa_112","__typename":"Paragraph","name":"7df4","text":"By freeing the files_struct with setting reference counter to 0, a new process may reuse it as a files_struct for that process. The worker will get a reference to the new process’s files_struct when reused.\n — But file structure is already obtained from the file descriptor, ̶s̶o̶ ̶i̶t̶ ̶c̶a̶n̶n̶o̶t̶ ̶g̶e̶t̶ ̶a̶ ̶r̶e̶f̶e̶r̶e̶n̶c̶e̶ ̶t̶o̶ ̶t̶h̶e̶ ̶f̶i̶l̶e̶ ̶s̶t̶r̶u̶c̶t̶u̶r̶e̶ ̶o̶f̶ ̶t̶h̶e̶ ̶n̶e̶w̶ ̶p̶r̶o̶c̶e̶s̶s̶ (This was a lie. I’ll describe in “aside” part.)\n — It’s possible to insert a file structure into the file descriptor table of a new process by opening a file. But it will not be referenced. (Because people don’t use fixed file descriptor number while programming.)","type":"ULI","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":15,"end":27,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":97,"end":109,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":181,"end":193,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":214,"end":218,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":493,"end":497,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_113":{"id":"179db53d15aa_113","__typename":"Paragraph","name":"74b4","text":"Here, I will explain the mechanism around the reference counter of the file structure in countermeasures when handling the same file by multiple threads. Yes, it’s a spoiler. The conclusion will be that it can actually be abused.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":71,"end":75,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":89,"end":152,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_114":{"id":"179db53d15aa_114","__typename":"Paragraph","name":"8979","text":"Mechanism of reference counter in open\u002Fclose system call","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":56,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_115":{"id":"179db53d15aa_115","__typename":"Paragraph","name":"0405","text":"To understand how the reference counters in the file structure work, we first need to understand what open\u002Fclose actually does. Of course, the behavior changes depending on the actual file to be opened, but the following can be said in common.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":48,"end":52,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_116":{"id":"179db53d15aa_116","__typename":"Paragraph","name":"bcd5","text":"open:","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_117":{"id":"179db53d15aa_117","__typename":"Paragraph","name":"49af","text":"Create a file structure and set the reference counter to 1","type":"OLI","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_118":{"id":"179db53d15aa_118","__typename":"Paragraph","name":"2750","text":"Regesiter it to the file descriptor table","type":"OLI","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_119":{"id":"179db53d15aa_119","__typename":"Paragraph","name":"3166","text":"Create a file structure and set the reference counter to 1","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":9,"end":13,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_120":{"id":"179db53d15aa_120","__typename":"Paragraph","name":"7380","text":"static struct file *__alloc_file(int flags, const struct cred *cred)\n{\n struct file *f;\n int error;","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_121":{"id":"179db53d15aa_121","__typename":"Paragraph","name":"5015","text":"f = kmem_cache_zalloc(filp_cachep, GFP_KERNEL);\n ......\n atomic_long_set(&f-\u003Ef_count, 1);\n ......\n return f;\n}","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_122":{"id":"179db53d15aa_122","__typename":"Paragraph","name":"0d83","text":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Ffile_table.c#L96","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":67,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Ffile_table.c#L96","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_123":{"id":"179db53d15aa_123","__typename":"Paragraph","name":"a3b5","text":"Regesiter it to the file descriptor table(fd_install)","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_124":{"id":"179db53d15aa_124","__typename":"Paragraph","name":"0677","text":"static long do_sys_openat2(int dfd, const char __user *filename,\n      struct open_how *how)\n{\n ......\n fd = get_unused_fd_flags(how-\u003Eflags);\n if (fd \u003E= 0) {\n  struct file *f = do_filp_open(dfd, tmp, &op);\n  if (IS_ERR(f)) {\n   put_unused_fd(fd);\n   fd = PTR_ERR(f);\n  } else {\n   fsnotify_open(f);\n   fd_install(fd, f);\n  }\n }\n putname(tmp);\n return fd;\n}","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_125":{"id":"179db53d15aa_125","__typename":"Paragraph","name":"2a59","text":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fopen.c#L1130","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":63,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fopen.c#L1130","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_126":{"id":"179db53d15aa_126","__typename":"Paragraph","name":"dbef","text":"close:","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_127":{"id":"179db53d15aa_127","__typename":"Paragraph","name":"65fa","text":"Delete from file descriptor table","type":"OLI","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_128":{"id":"179db53d15aa_128","__typename":"Paragraph","name":"e4e5","text":"Decrement the reference counter of the file structure.(fput)","type":"OLI","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_129":{"id":"179db53d15aa_129","__typename":"Paragraph","name":"072b","text":"Delete from file descriptor table","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_130":{"id":"179db53d15aa_130","__typename":"Paragraph","name":"3f26","text":"int __close_fd(struct files_struct *files, unsigned fd)\n{\n struct file *file;\n struct fdtable *fdt;","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_131":{"id":"179db53d15aa_131","__typename":"Paragraph","name":"fd05","text":"spin_lock(&files-\u003Efile_lock);\n fdt = files_fdtable(files);\n if (fd \u003E= fdt-\u003Emax_fds)\n  goto out_unlock;\n file = fdt-\u003Efd[fd];\n if (!file)\n  goto out_unlock;\n rcu_assign_pointer(fdt-\u003Efd[fd], NULL);\n __put_unused_fd(files, fd);\n spin_unlock(&files-\u003Efile_lock);\n return filp_close(file, files);","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_132":{"id":"179db53d15aa_132","__typename":"Paragraph","name":"cbf5","text":"out_unlock:\n spin_unlock(&files-\u003Efile_lock);\n return -EBADF;\n}","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_133":{"id":"179db53d15aa_133","__typename":"Paragraph","name":"2ab4","text":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Ffile.c#L626","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":62,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Ffile.c#L626","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_134":{"id":"179db53d15aa_134","__typename":"Paragraph","name":"5553","text":"Decrement the reference counter of the filefile structure.(fput)","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":39,"end":43,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_135":{"id":"179db53d15aa_135","__typename":"Paragraph","name":"7778","text":"int filp_close(struct file *filp, fl_owner_t id)\n{\n ......\n fput(filp);\n return retval;\n}","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_136":{"id":"179db53d15aa_136","__typename":"Paragraph","name":"b72b","text":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fopen.c#L1239","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":63,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fopen.c#L1239","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_137":{"id":"179db53d15aa_137","__typename":"Paragraph","name":"e685","text":"The important thing here is the fget()\u002Ffput() function (although fget() is not used in open). These increment\u002Fdecrement the reference counter of the file structure, and fput() frees the memory of the file structure when the reference reaches 0. Thanks to this mechanism, if it gets the file structure by fget(), the reference counter will not be 0 even if it is closed before fput() (counter should be 1 at the time of open, 2 after calling fget(), and even if it’s close-ed at this time, it will be 1.). Therefore, it means that there is no problem even if it is closed during use.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":32,"end":38,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":39,"end":45,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":65,"end":71,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":87,"end":91,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":149,"end":153,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":169,"end":175,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":200,"end":204,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":286,"end":290,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":304,"end":310,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":376,"end":382,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":419,"end":423,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":441,"end":447,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":466,"end":471,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":564,"end":570,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_138":{"id":"179db53d15aa_138","__typename":"Paragraph","name":"b1d0","text":"For example, when mapping a file to memory with mmap , it would be a problem if the memory was released before calling munmap even after close. Therefore, fget() is used in mmap to prevent the memory from being released.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":48,"end":52,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":119,"end":125,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":137,"end":142,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":155,"end":161,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":173,"end":177,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_139":{"id":"179db53d15aa_139","__typename":"Paragraph","name":"28a0","text":"unsigned long ksys_mmap_pgoff(unsigned long addr, unsigned long len,\n         unsigned long prot, unsigned long flags,\n         unsigned long fd, unsigned long pgoff)\n{\n struct file *file = NULL;\n unsigned long retval;","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_140":{"id":"179db53d15aa_140","__typename":"Paragraph","name":"6ba4","text":"if (!(flags & MAP_ANONYMOUS)) {\n  audit_mmap_fd(fd, flags);\n  file = fget(fd);\n ......\n}","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_141":{"id":"179db53d15aa_141","__typename":"Paragraph","name":"12aa","text":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Fmm\u002Fmmap.c#L1551","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":63,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Fmm\u002Fmmap.c#L1551","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_142":{"id":"179db53d15aa_142","__typename":"Paragraph","name":"25fb","text":"fdget() which doesn’t change reference counter","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":46,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_143":{"id":"179db53d15aa_143","__typename":"Paragraph","name":"0441","text":"There is also a function called fdget()\u002Ffdput() that is frequently used to get a reference to a file structure (which is rather frequently used inside system call handlers).","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":32,"end":39,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":40,"end":47,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":96,"end":100,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_144":{"id":"179db53d15aa_144","__typename":"Paragraph","name":"59a7","text":"For example, in the read system call, the file structure is used between fdget()(fdget_pos()) and fdput()(fdput_pos()) as shown below.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":20,"end":24,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":42,"end":46,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":73,"end":80,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":81,"end":92,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":98,"end":105,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":106,"end":117,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_145":{"id":"179db53d15aa_145","__typename":"Paragraph","name":"726d","text":"ssize_t ksys_read(unsigned int fd, char __user *buf, size_t count)\n{\n struct fd f = fdget_pos(fd);\n ssize_t ret = -EBADF;","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_146":{"id":"179db53d15aa_146","__typename":"Paragraph","name":"f353","text":"if (f.file) {\n  loff_t pos, *ppos = file_ppos(f.file);\n  if (ppos) {\n   pos = *ppos;\n   ppos = &pos;\n  }\n  ret = vfs_read(f.file, buf, count, ppos);\n  if (ret \u003E= 0 && ppos)\n   f.file-\u003Ef_pos = pos;\n  fdput_pos(f);\n }\n return ret;\n}","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_147":{"id":"179db53d15aa_147","__typename":"Paragraph","name":"f336","text":"SYSCALL_DEFINE3(read, unsigned int, fd, char __user *, buf, size_t, count)\n{\n return ksys_read(fd, buf, count);\n}","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_148":{"id":"179db53d15aa_148","__typename":"Paragraph","name":"b6ce","text":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fread_write.c#L576","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":68,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fread_write.c#L576","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_149":{"id":"179db53d15aa_149","__typename":"Paragraph","name":"b468","text":"It seems that there is a motivation to not increase or decrease the reference counter of the file structure too often, probably due to the influence of the cacheline. Therefore, fdget() does not increase the reference counter of the file structure under certain conditions. As you can see by tracing the function, fdget() finally calls __fget_light() function. Let’s take a look at the implementation.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":93,"end":97,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":178,"end":185,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":233,"end":237,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":314,"end":321,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":336,"end":350,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_150":{"id":"179db53d15aa_150","__typename":"Paragraph","name":"c449","text":"\u002F*\n * Lightweight file lookup - no refcnt increment if fd table isn't shared.\n *\n * You can use this instead of fget if you satisfy all of the following\n * conditions:\n * 1) You must call fput_light before exiting the syscall and returning control\n *    to userspace (i.e. you cannot remember the returned struct file * after\n *    returning to userspace).\n * 2) You must not call filp_close on the returned struct file * in between\n *    calls to fget_light and fput_light.\n * 3) You must not clone the current task in between the calls to fget_light\n *    and fput_light.\n *\n * The fput_needed flag returned by fget_light should be passed to the\n * corresponding fput_light.\n *\u002F\nstatic unsigned long __fget_light(unsigned int fd, fmode_t mask)\n{\n struct files_struct *files = current-\u003Efiles;\n struct file *file;","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_151":{"id":"179db53d15aa_151","__typename":"Paragraph","name":"ed7d","text":"if (atomic_read(&files-\u003Ecount) == 1) {\n  file = __fcheck_files(files, fd);\n  if (!file || unlikely(file-\u003Ef_mode & mask))\n   return 0;\n  return (unsigned long)file;\n } else {\n  file = __fget(fd, mask, 1);\n  if (!file)\n   return 0;\n  return FDPUT_FPUT | (unsigned long)file;\n }\n}","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_152":{"id":"179db53d15aa_152","__typename":"Paragraph","name":"e14f","text":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Ffile.c#L807","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":62,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Ffile.c#L807","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_153":{"id":"179db53d15aa_153","__typename":"Paragraph","name":"8ebe","text":"As commented, this function can only be used if the conditions are met. It also says, “no refcnt increment if fd table isn’t shared”. What does this mean?","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_154":{"id":"179db53d15aa_154","__typename":"Paragraph","name":"e001","text":"Generally, in multithreaded programs, the file descriptor table is shared(&files-\u003Ecount \u003E=2), and the same file descriptor points to the same file. In this case, for example, the other thread can call the close system call while the read system call is being executed. Therefore, the fdget() of the read system call should increment the reference counter.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":74,"end":87,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":205,"end":210,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":233,"end":237,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":284,"end":291,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":299,"end":303,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_155":{"id":"179db53d15aa_155","__typename":"Paragraph","name":"3ce9","text":"","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*rbhptpwTtm45PTAMi1c0qw.png"},"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_156":{"id":"179db53d15aa_156","__typename":"Paragraph","name":"2532","text":"But what if this was a regular single-threaded program? In this case, another system call cannot be interrupted while the read system call is being executed. Therefore, nothing happens even if the reference counter is not increased.\nFor this reason, it does not increase the reference counter of the file structure unless the file descriptor table is shared.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":122,"end":126,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":250,"end":357,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_157":{"id":"179db53d15aa_157","__typename":"Paragraph","name":"2768","text":"Combining vulnerabilities with the fdget() spec","type":"H3","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":47,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_158":{"id":"179db53d15aa_158","__typename":"Paragraph","name":"c15a","text":"The vulnerability was passing a reference to the files_struct structure to a structure that the worker would later refer to without increasing the reference counter. As you may have noticed, this means that if the original program is single- threaded, although the file descriptor table is shared (with worker), &files-\u003Ecount is 1. \nThat &files-\u003Ecount equals to 1 means fdget() does not increment the reference counter for the file structure. But, actually the worker can closec the file descriptor associated with the file structure, so the memory of the file structure obtained by fdget() may have been freed at some point.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":49,"end":61,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":312,"end":325,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":338,"end":351,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":370,"end":377,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":427,"end":431,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":472,"end":477,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":519,"end":523,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":556,"end":560,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":583,"end":590,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":124,"end":164,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":252,"end":330,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":370,"end":441,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":538,"end":624,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_159":{"id":"179db53d15aa_159","__typename":"Paragraph","name":"0ebe","text":"","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*e-PoInH_R05yW-pz"},"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_160":{"id":"179db53d15aa_160","__typename":"Paragraph","name":"58c7","text":"In summary, this vulnerability is as follows.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_161":{"id":"179db53d15aa_161","__typename":"Paragraph","name":"3cb3","text":"The aio worker shares the files_struct structure with the calling thread. At this time, the reference counter of the files_struct structure is not incremented.","type":"ULI","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":26,"end":38,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":117,"end":129,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_162":{"id":"179db53d15aa_162","__typename":"Paragraph","name":"ef01","text":"Since fdget does not increment the reference counter of the file structure when the reference counter of the files_struct structure is 1, the file obtained by fdget() may be closed and freed in the worker (or calling thread).","type":"ULI","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":60,"end":64,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":109,"end":121,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":159,"end":166,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_163":{"id":"179db53d15aa_163","__typename":"Paragraph","name":"05e9","text":"Since the file structure is freed, UAF occurs where it is handled(e.g. in file-related system call).","type":"ULI","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":10,"end":14,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_164":{"id":"179db53d15aa_164","__typename":"Paragraph","name":"c351","text":"Overview of the PoC","type":"H4","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":19,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_165":{"id":"179db53d15aa_165","__typename":"Paragraph","name":"8068","text":"The rest thing is just doing a kernel exploit, so there’s not much to explain.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_166":{"id":"179db53d15aa_166","__typename":"Paragraph","name":"54f5","text":"If there’s a code block like below, you can use close on the worker side to trigger Use After Free of the file structure (it’s even better if you put a userfaultfd between them).","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":48,"end":53,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":106,"end":110,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_167":{"id":"179db53d15aa_167","__typename":"Paragraph","name":"9487","text":"void func(){\n  struct fd f;\n  f = fdget();\u002F\u002Frefcount is not incremented.\n  \u002F*\n  Play with f.file :)\n  *\u002F\n  fdput(f);\n}","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_168":{"id":"179db53d15aa_168","__typename":"Paragraph","name":"d1ca","text":"Or it’s also possible to exploit by using the memory region of private_data member associated with the file structure (the location to save its own data structure. it contains many kinds of data structure), because it will also be freed. I exploited by overwriting the memory of the map structure used in eBPF which is allocated(overlapped) by calling kmalloc with the same size as map structure.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":63,"end":75,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":103,"end":107,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":283,"end":286,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":382,"end":385,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_169":{"id":"179db53d15aa_169","__typename":"Paragraph","name":"41f6","text":"","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*HVpY7cqdBulyKQRGXkYV5w.png"},"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_170":{"id":"179db53d15aa_170","__typename":"Paragraph","name":"242e","text":"Summary","type":"H4","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":7,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_171":{"id":"179db53d15aa_171","__typename":"Paragraph","name":"ff14","text":"It seems that it was fixed by changing the reference counter of the files_struct structure to increment in the following commit.\nhttps:\u002F\u002Fgithub.com\u002Ftorvalds\u002Flinux\u002Fcommit\u002F0f2122045b946241a9e549c2a76cea54fa58a7ff","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":68,"end":80,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":129,"end":210,"type":"A","href":"https:\u002F\u002Fgithub.com\u002Ftorvalds\u002Flinux\u002Fcommit\u002F0f2122045b946241a9e549c2a76cea54fa58a7ff","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_172":{"id":"179db53d15aa_172","__typename":"Paragraph","name":"278e","text":"As an aside","type":"H4","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":11,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_173":{"id":"179db53d15aa_173","__typename":"Paragraph","name":"dbf6","text":"While writing this blog, I noticed an important thing. After my report, the following issue was raised, and CVE was assigned there.\nhttps:\u002F\u002Fbugs.chromium.org\u002Fp\u002Fproject-zero\u002Fissues\u002Fdetail?id=2089","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":132,"end":194,"type":"A","href":"https:\u002F\u002Fbugs.chromium.org\u002Fp\u002Fproject-zero\u002Fissues\u002Fdetail?id=2089","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_174":{"id":"179db53d15aa_174","__typename":"Paragraph","name":"b355","text":"Apparently, there was another report while the response is delayed because the issue cannot be reproduced well. And it seems that previous one was corrected first. And that seems to have been fixed first.\nBasically, I am reporting the problematic code with the file name and the number of lines specified, but there seems to be room for improvement in the report content or PoC.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_175":{"id":"179db53d15aa_175","__typename":"Paragraph","name":"b698","text":"Also, after reading the report on the above URL, I realized that there is a simpler and more interesting Exploit method, so I would like to introduce it briefly.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_176":{"id":"179db53d15aa_176","__typename":"Paragraph","name":"625e","text":"Even if the worker is running, the reference counter of the files_struct structure is not incremented, so the current-\u003Efiles-\u003Ecount of the thread which calls the io_uring-related system call is 1 due to the vulnerability.\nAlso, when updating the executable file with execve as shown in the code below, there is a specification that the files_struct structure is reused under the condition of current-\u003E files-\u003E count == 1.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":60,"end":72,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":110,"end":131,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":336,"end":348,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":392,"end":420,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_177":{"id":"179db53d15aa_177","__typename":"Paragraph","name":"4d32","text":"load_elf_binary()-\u003Ebegin_new_exec()-\u003Eunshare_files()-\u003Eunshare_fd()","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":66,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_178":{"id":"179db53d15aa_178","__typename":"Paragraph","name":"af22","text":"static int unshare_fd(unsigned long unshare_flags, struct files_struct **new_fdp)\n{\n struct files_struct *fd = current-\u003Efiles;\n int error = 0;","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_179":{"id":"179db53d15aa_179","__typename":"Paragraph","name":"ae89","text":"if ((unshare_flags & CLONE_FILES) &&\n     (fd && atomic_read(&fd-\u003Ecount) \u003E 1)) {\n  *new_fdp = dup_fd(fd, &error);\n  if (!*new_fdp)\n   return error;\n }","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_180":{"id":"179db53d15aa_180","__typename":"Paragraph","name":"b0d4","text":"return 0;\n}","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_181":{"id":"179db53d15aa_181","__typename":"Paragraph","name":"6988","text":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Fkernel\u002Ffork.c#L2883","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":67,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Fkernel\u002Ffork.c#L2883","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_182":{"id":"179db53d15aa_182","__typename":"Paragraph","name":"97d1","text":"In other words, if execve is called while the worker is running, the worker will always refer to the files_struct structure of the process after the execve.\n (Actually I think it’s easy to duplicate an address even if kmem_cache_free&kmem_cache_alloc is called…)","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":101,"end":113,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_183":{"id":"179db53d15aa_183","__typename":"Paragraph","name":"10db","text":"The process after execve does not always have the same authority as the process before it. For example, if setuid-ed binaries(sudo\u002Fsu\u002Fetc…) are executed, it will become a privileged process after execve. Therefore, by suspending the execution of the worker and then executing sudo or things like that, the worker can refer to the file descriptor table (in files_struct) of the privileged process.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":356,"end":368,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":302,"end":395,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_184":{"id":"179db53d15aa_184","__typename":"Paragraph","name":"066c","text":"","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*KWE_pxAcrj2KgY7nNoAtVQ.png"},"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_185":{"id":"179db53d15aa_185","__typename":"Paragraph","name":"8cb3","text":"Since the cred(process authority) structure and things like that are inherited from the state before execve()(it is also held on the worker side as needed when queueing the task), it cannot be newly opened with the authority of the privileged process. But the files opened by the privileged process itself can be referenced from the worker side.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_186":{"id":"179db53d15aa_186","__typename":"Paragraph","name":"868c","text":"static void io_wq_switch_creds(struct io_worker *worker,\n          struct io_wq_work *work)\n{\n const struct cred *old_creds = override_creds(work-\u003Ecreds);","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_187":{"id":"179db53d15aa_187","__typename":"Paragraph","name":"5b47","text":"worker-\u003Ecur_creds = work-\u003Ecreds;\n if (worker-\u003Esaved_creds)\n  put_cred(old_creds); \u002F* creds set by previous switch *\u002F\n else\n  worker-\u003Esaved_creds = old_creds;\n}","type":"PRE","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_188":{"id":"179db53d15aa_188","__typename":"Paragraph","name":"e42d","text":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio-wq.c#L431","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":63,"type":"A","href":"https:\u002F\u002Felixir.bootlin.com\u002Flinux\u002Fv5.6.19\u002Fsource\u002Ffs\u002Fio-wq.c#L431","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_189":{"id":"179db53d15aa_189","__typename":"Paragraph","name":"7242","text":"This means that there’s a possibility of LPE by reading\u002Fwriting file descriptors opened by privileged processes. (For example, if a shell script that will be executed as root is opened as writable, it can be used for privilege escalation.)","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_190":{"id":"179db53d15aa_190","__typename":"Paragraph","name":"6e0b","text":"By the way, strictly speaking, as mentioned above, the file structure to read\u002Fwrite is obtained based on the file descriptor before offloading, so the file structure of the privileged process cannot be used. However, in fact, io_uring has a feature that allows you to define file descriptors on the side of execution context, and it can dynamically updates them by the operation IORING_OP_FILES_UPDATE. This obtains file descriptors again from the files_struct structure held on the execution context side, which means that there is room for stealing the file descriptor of the privileged process.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":55,"end":59,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":151,"end":155,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":379,"end":401,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":448,"end":460,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":483,"end":505,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_191":{"id":"179db53d15aa_191","__typename":"Paragraph","name":"e9ed","text":"","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*s_qqPn9N6K63kE9FUz-MeA.png"},"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_192":{"id":"179db53d15aa_192","__typename":"Paragraph","name":"b1a6","text":"I haven’t confirmed whether there is a convenient executable file that can actually be used for exploitation. At least, sudo temporarily opens \u002Fetc\u002Fshadow with O_RDONLY , so it seems that you can get the contents if the timing is right.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":143,"end":154,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":160,"end":168,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_193":{"id":"179db53d15aa_193","__typename":"Paragraph","name":"d795","text":"Also, depending on the version, the file structure is updated by referring to the memory on the privileged process (it means, it is necessary to specify the address of the privileged process as the address of the file descriptor table when updating). So I felt like it was affected by ASLR (A suid binary is required to immediately stabilize the memory reuse of the files_struct structure, but of course su\u002Fsudo binaries are built as PIE). ( I justify my blog with that excuse. :) )","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":36,"end":40,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","start":366,"end":378,"type":"CODE","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_194":{"id":"179db53d15aa_194","__typename":"Paragraph","name":"76bb","text":"About us","type":"H4","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[],"dropCapImage":null},"Paragraph:179db53d15aa_195":{"id":"179db53d15aa_195","__typename":"Paragraph","name":"db8e","text":"Flatt Security Inc. provides security assessment services. We are willing to have offers from overseas. If you have any question, please contact us by https:\u002F\u002Fflatt.tech\u002Fen\u002F. Thank you for reading this article.","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":151,"end":173,"type":"A","href":"https:\u002F\u002Fflatt.tech\u002Fen\u002F","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_196":{"id":"179db53d15aa_196","__typename":"Paragraph","name":"2c9d","text":"Reference","type":"H4","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":9,"type":"STRONG","href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"dropCapImage":null},"Paragraph:179db53d15aa_197":{"id":"179db53d15aa_197","__typename":"Paragraph","name":"fb3e","text":"https:\u002F\u002Fwww.zerodayinitiative.com\u002Fadvisories\u002FZDI-21-001\u002F https:\u002F\u002Fgithub.com\u002Ftorvalds\u002Flinux\u002Fcommit\u002F0f2122045b946241a9e549c2a76cea54fa58a7ff https:\u002F\u002Fbugs.chromium.org\u002Fp\u002Fproject-zero\u002Fissues\u002Fdetail?id=2089","type":"P","href":null,"layout":null,"metadata":null,"hasDropCap":null,"iframe":null,"mixtapeMetadata":null,"markups":[{"__typename":"Markup","start":0,"end":56,"type":"A","href":"https:\u002F\u002Fwww.zerodayinitiative.com\u002Fadvisories\u002FZDI-21-001\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","start":57,"end":138,"type":"A","href":"https:\u002F\u002Fgithub.com\u002Ftorvalds\u002Flinux\u002Fcommit\u002F0f2122045b946241a9e549c2a76cea54fa58a7ff","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","start":139,"end":201,"type":"A","href":"https:\u002F\u002Fbugs.chromium.org\u002Fp\u002Fproject-zero\u002Fissues\u002Fdetail?id=2089","anchorType":"LINK","userId":null,"linkMetadata":null}],"dropCapImage":null},"ImageMetadata:1*xTPZ_N__RtSfTA7J7kTSBA.png":{"id":"1*xTPZ_N__RtSfTA7J7kTSBA.png","__typename":"ImageMetadata","originalHeight":945,"originalWidth":1800,"focusPercentX":null,"focusPercentY":null,"alt":null},"ImageMetadata:1*RBvfw3fmI2rxgBBUb6Yifw.png":{"id":"1*RBvfw3fmI2rxgBBUb6Yifw.png","__typename":"ImageMetadata","originalHeight":1488,"originalWidth":1306,"focusPercentX":null,"focusPercentY":null,"alt":null},"ImageMetadata:1*eDQhEUjvJmCxETqhzH_vgQ.png":{"id":"1*eDQhEUjvJmCxETqhzH_vgQ.png","__typename":"ImageMetadata","originalHeight":1078,"originalWidth":1100,"focusPercentX":null,"focusPercentY":null,"alt":null},"ImageMetadata:1*r97ABC6g0FPqn1sSyg17cA.png":{"id":"1*r97ABC6g0FPqn1sSyg17cA.png","__typename":"ImageMetadata","originalHeight":1502,"originalWidth":1460,"focusPercentX":null,"focusPercentY":null,"alt":null},"ImageMetadata:1*QWqIM-GZDKXEn_OTofMx3A.png":{"id":"1*QWqIM-GZDKXEn_OTofMx3A.png","__typename":"ImageMetadata","originalHeight":916,"originalWidth":1278,"focusPercentX":null,"focusPercentY":null,"alt":null},"ImageMetadata:1*65Fa3NkAmqj_iQ82kxigqw.png":{"id":"1*65Fa3NkAmqj_iQ82kxigqw.png","__typename":"ImageMetadata","originalHeight":596,"originalWidth":1160,"focusPercentX":null,"focusPercentY":null,"alt":null},"ImageMetadata:1*rbhptpwTtm45PTAMi1c0qw.png":{"id":"1*rbhptpwTtm45PTAMi1c0qw.png","__typename":"ImageMetadata","originalHeight":1164,"originalWidth":1230,"focusPercentX":null,"focusPercentY":null,"alt":null},"ImageMetadata:0*e-PoInH_R05yW-pz":{"id":"0*e-PoInH_R05yW-pz","__typename":"ImageMetadata","originalHeight":1420,"originalWidth":1550,"focusPercentX":null,"focusPercentY":null,"alt":null},"ImageMetadata:1*HVpY7cqdBulyKQRGXkYV5w.png":{"id":"1*HVpY7cqdBulyKQRGXkYV5w.png","__typename":"ImageMetadata","originalHeight":724,"originalWidth":1582,"focusPercentX":null,"focusPercentY":null,"alt":null},"ImageMetadata:1*KWE_pxAcrj2KgY7nNoAtVQ.png":{"id":"1*KWE_pxAcrj2KgY7nNoAtVQ.png","__typename":"ImageMetadata","originalHeight":1406,"originalWidth":1560,"focusPercentX":null,"focusPercentY":null,"alt":null},"ImageMetadata:1*s_qqPn9N6K63kE9FUz-MeA.png":{"id":"1*s_qqPn9N6K63kE9FUz-MeA.png","__typename":"ImageMetadata","originalHeight":1600,"originalWidth":1706,"focusPercentX":null,"focusPercentY":null,"alt":null},"Tag:cybersecurity":{"id":"cybersecurity","__typename":"Tag","displayTitle":"Cybersecurity","normalizedTagSlug":"cybersecurity"},"Tag:linux":{"id":"linux","__typename":"Tag","displayTitle":"Linux","normalizedTagSlug":"linux"},"Tag:security":{"id":"security","__typename":"Tag","displayTitle":"Security","normalizedTagSlug":"security"},"Tag:vulnerability":{"id":"vulnerability","__typename":"Tag","displayTitle":"Vulnerability","normalizedTagSlug":"vulnerability"},"PostViewerEdge:postId:e946bd69177a-viewerId:lo_39fe79c88e42":{"id":"postId:e946bd69177a-viewerId:lo_39fe79c88e42","__typename":"PostViewerEdge","catalogsConnection":null}}</script><script>window.__MIDDLEWARE_STATE__={"session":{"xsrf":""},"cache":{"cacheStatus":"MISS","shouldUseCache":true}}</script><script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/manifest.9aff14a5.js.下載"></script><script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/2913.f1a1187c.js.下載"></script><script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/main.c9f1e204.js.下載"></script><script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/45573.4354ed57.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/instrumentation.8487d597.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/reporting.284ee462.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/45279.c447ce9d.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/32847.fcf840bf.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/80685.2f5217b8.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/11034.8b48db35.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/90192.5d31e609.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/79088.e4863540.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/81645.b955b7c8.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/70832.444ac173.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/63303.da52dbf3.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/50006.f237604f.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/26022.d3d05be7.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/5850.ddb64a39.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/11615.9b046158.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/92397.6c801126.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/72776.6bc7d662.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/5055.78455feb.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/81957.4180e5d4.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/61781.8135fc03.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/37801.b6b08077.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/46670.2c0779de.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/22026.6d1fc7a4.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/20435.38e56e4d.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/33673.952ffdce.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/95972.996c4300.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/11366.63777188.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/62182.7c280158.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/35285.dc03faaf.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/46736.3cc1fb75.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/43642.700b1345.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/1762.025292a0.chunk.js.下載"></script>
<script src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/Post.3d44e340.chunk.js.下載"></script><script>window.main();</script><script defer="" src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/v64f9daad31f64f81be21cbef6184a5e31634941392597" integrity="sha512-gV/bogrUTVP2N3IzTDKzgP0Js1gg4fbwtYB6ftgLbKQu/V8yH2+lrKCfKHelh4SO3DPzKj4/glTO+tNJGDnb0A==" data-cf-beacon="{&quot;rayId&quot;:&quot;6b76b0b55e0d6b72&quot;,&quot;token&quot;:&quot;0b5f665943484354a59c39c6833f7078&quot;,&quot;version&quot;:&quot;2021.11.0&quot;,&quot;si&quot;:100}" crossorigin="anonymous"></script>
<iframe src="./2021 - CVE-2021-20226 a reference counting bug which leads to local privilege escalation in io_uring_files/a16180790160.html" hidden="" tabindex="-1" title="Optimizely Internal Frame" height="0" width="0" style="display: none;"></iframe></body></html>