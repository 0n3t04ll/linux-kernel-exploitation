<!DOCTYPE html>
<!-- saved from url=(0044)https://alephsecurity.com/2021/10/20/sudump/ -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<script type="text/javascript" async="" src="./2021 - SuDump Exploiting suid binaries through the kernel_files/analytics.js.下載"></script><script async="" src="./2021 - SuDump Exploiting suid binaries through the kernel_files/js"></script>
<script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        
        gtag('config', 'UA-92665328-1');
    </script>

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>SuDump: Exploiting suid binaries through the kernel</title>
<meta name="name" content="SuDump: Exploiting suid binaries through the kernel">
<meta name="description" content="SuDump: Exploiting suid binaries through the kernel">
<meta name="image" content="https://alephsecurity.com/assets/img/logo-black.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@alephsecurity">
<meta name="twitter:creator" content="@alephsecurity">
<meta name="twitter:title" content="SuDump: Exploiting suid binaries through the kernel">
<meta name="twitter:url" content="https://alephsecurity.com/2021/10/20/sudump/">
<meta name="twitter:description" content="SuDump: Exploiting suid binaries through the kernel">
<meta name="twitter:image:src" content="https://alephsecurity.com/assets/img/logo-black.png">
<meta property="og:site_name" content="">
<meta property="og:title" content="SuDump: Exploiting suid binaries through the kernel">
<meta property="og:type" content="article">
<meta property="og:description" content="SuDump: Exploiting suid binaries through the kernel">
<meta property="og:url" content="https://alephsecurity.com/2021/10/20/sudump/">
<meta property="article:published_time" content="2021-10-20T00:00:00+00:00">
<meta property="article:author" content="https://alephsecurity.com">
<meta property="og:image" content="https://alephsecurity.com/assets/img/logo-black.png">
<link rel="icon" href="https://alephsecurity.com/favicon.png">
<link rel="stylesheet" href="./2021 - SuDump Exploiting suid binaries through the kernel_files/css">
<link rel="stylesheet" type="text/css" href="./2021 - SuDump Exploiting suid binaries through the kernel_files/main.css">
<link rel="stylesheet" href="./2021 - SuDump Exploiting suid binaries through the kernel_files/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
<script src="./2021 - SuDump Exploiting suid binaries through the kernel_files/katex.min.js.下載" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
<script type="text/x-mathjax-config;executed=true">
    MathJax.Hub.Config({
      messageStyle: "none",
      tex2jax: {preview: "none"},
      CommonHTML: { linebreaks: { automatic: true } },
      "HTML-CSS": { linebreaks: { automatic: true } },
      SVG: { linebreaks: { automatic: true } }
    });
    </script>
<script src="./2021 - SuDump Exploiting suid binaries through the kernel_files/MathJax.js.下載" id="">
    </script>
<script src="./2021 - SuDump Exploiting suid binaries through the kernel_files/embed.js.下載" data-timestamp="1638470773622"></script><script src="./2021 - SuDump Exploiting suid binaries through the kernel_files/count-data.js.下載"></script><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 2px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 2px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: 1em}
.MathJax_MenuRadioCheck.RTL {right: 1em; left: auto}
.MathJax_MenuLabel {padding: 2px 2em 4px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #CCCCCC; margin: 4px 1px 0px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: Highlight; color: HighlightText}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><link rel="prefetch" as="style" href="https://c.disquscdn.com/next/embed/styles/lounge.3e33cc45b553fa4f7fd3dfc49dc03ed0.css"><link rel="prefetch" as="script" href="https://c.disquscdn.com/next/embed/common.bundle.2f2f40d40785c9541a90e9086c8770a3.js"><link rel="prefetch" as="script" href="https://c.disquscdn.com/next/embed/lounge.bundle.2737369a2131ed319d0273590d7dc69d.js"><link rel="prefetch" as="script" href="https://disqus.com/next/config.js"><script src="./2021 - SuDump Exploiting suid binaries through the kernel_files/alfie_v4.63f1ab6d6b9d5807dc0c94ef3fe0b851.js.下載" async="" charset="UTF-8"></script></head>
<body><div id="MathJax_Message" style="display: none;"></div>
<div class="wrapper">
<div class="page__back">
<a href="https://alephsecurity.com/">&lt;-- <span class="smallogo">א</span></a>
</div>
<div class="page">
<div class="page__post">
<div class="page__title">
<h1>SuDump: Exploiting suid binaries through the kernel</h1>
</div>
By <a href="https://alephsecurity.com/authors/itaig">Itai Greenhut</a> (<a href="https://twitter.com/Gr33nh4t">@Gr33nh4t</a>)
<br>
<div class="page__date"><span>October 20, 2021</span></div>
<br>
* <div class="page__commentcount"><span><a href="https://alephsecurity.com/2021/10/20/sudump/#disqus_thread">1 Comment</a></span></div>
<div class="page__content" ?="">
<h1 id="introduction">Introduction:</h1>
<p>During our Apport <a href="https://alephsecurity.com/2021/02/16/apport-lpe/">research</a> we exploited Ubuntu’s crash handler, and following that, we decided to once again audit the coredump creation code. But this time, we chose to focus on a more general different target, rather than a specific crash handler. In this post, we will explore how the Linux kernel itself behaves when a process crash happens.</p>
<p>We will show bugs we found in the Linux kernel that allow unprivileged users to create root-owned core files, and how we were able to use them to get an LPE through the sudo program on machines that have been configured by administrators to allow running a single innocent command.</p>
<h1 id="coredump-creation">Coredump Creation:</h1>
<p>On Linux, a coredump will be generated for a process upon receiving several signals.
The signals that result in a core dump are listed here (taken from “man signal”):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Signal      Standard   Action   Comment
────────────────────────────────────────────────────────────────────────
SIGABRT      P1990      Core    Abort signal from abort(3)
SIGBUS       P2001      Core    Bus error (bad memory access)
SIGFPE       P1990      Core    Floating-point exception
SIGILL       P1990      Core    Illegal Instruction
SIGIOT         -        Core    IOT trap. A synonym for SIGABRT
SIGQUIT      P1990      Core    Quit from keyboard
SIGSEGV      P1990      Core    Invalid memory reference
SIGSYS       P2001      Core    Bad system call (SVr4);
                               see also seccomp(2)
SIGTRAP      P2001      Core    Trace/breakpoint trap
SIGUNUSED      -        Core    Synonymous with SIGSYS
SIGXCPU      P2001      Core    CPU time limit exceeded (4.2BSD);
                               see setrlimit(2)
SIGXFSZ      P2001      Core    File size limit exceeded (4.2BSD);
                               see setrlimit(2)
</code></pre></div></div>
<p>When a process receives one of these signals, it will terminate and a coredump will be created. The coredump can be used to explore the memory of the process at the time of a crash.</p>
<h1 id="dumpable-attribute">Dumpable attribute:</h1>
<p>Every process in Linux has an attribute called “dumpable”, this attribute is used to determine whether to generate a core file for a crashing process.</p>
<p>There are several possible dumpable values:</p>
<ul>
<li>0 - Process is not dumpable, and core file won’t be created.</li>
<li>1 - Process is dumpable.</li>
<li>2 (suidsafe) - Dump created only if core_pattern is an absolute path or a pipe to a program.</li>
</ul>
<p>Usually, a process initial dumpable value is set to 1, but in specific cases (described <a href="https://man7.org/linux/man-pages/man2/prctl.2.html">here</a>) a dumpable value may change.
One of these cases is when the binary that is being executed is a suid program, suid programs have permissions of another user thus they can access files and resources that the original user can’t. We don’t want to allow suid programs to create coredump, to prevent leakage of such valuable information.</p>
<p>When a suid program is executed the dumpable attribute is reset to the dumpable value defined in <code class="language-plaintext highlighter-rouge">/proc/sys/fs/suid_dumpable</code>.</p>
<p>But where does this decision occur? We noticed that the dumpable value is determined when a new process is executed.</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Code taken from /fs/exec.c (kernel 5.13.12)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">bprm</span><span class="o">-&gt;</span><span class="n">interp_flags</span> <span class="o">&amp;</span> <span class="n">BINPRM_FLAGS_ENFORCE_NONDUMP</span> <span class="o">||</span>
      <span class="o">!</span><span class="p">(</span><span class="n">uid_eq</span><span class="p">(</span><span class="n">current_euid</span><span class="p">(),</span> <span class="n">current_uid</span><span class="p">())</span> <span class="o">&amp;&amp;</span>
        <span class="n">gid_eq</span><span class="p">(</span><span class="n">current_egid</span><span class="p">(),</span> <span class="n">current_gid</span><span class="p">())))</span>
    <span class="n">set_dumpable</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span> <span class="n">suid_dumpable</span><span class="p">);</span> <span class="c1">// suid_dumpable from /proc</span>
  <span class="k">else</span>
    <span class="nf">set_dumpable</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span> <span class="n">SUID_DUMP_USER</span><span class="p">);</span> <span class="c1">// SUID_DUMP_USER == 1</span>
</code></pre></div></div>
<p>If the process has (ruid != euid) or (rgid != egid) then the process dumpable value will be taken from <code class="language-plaintext highlighter-rouge">/proc/sys/fs/suid_dumpable</code>.</p>
<p>It’s now clear that a suid program that has a real uid that differs from the effective uid would have its dumpable value changed. But it made us wonder “What would be the dumpable value of a child of a suid process?”.</p>
<p>The answer to this question is that the child process would have a dumpable value of SUID_DUMP_USER (1) only if the suid process dropped its privileges so ruid == euid and guid == egid.</p>
<p>If we find a suid binary that creates a child which is not suid, and we find a way to crash that child - a core dump will be generated on behalf of the user of the crashed process. To get extra privileges we want this user to be root.</p>
<h1 id="exploit">Exploit:</h1>
<p>To exploit this behavior we had to find a suid binary that meets the following requirements:</p>
<ul>
<li>A root suid binary</li>
<li>Calls <code class="language-plaintext highlighter-rouge">setuid(0)</code> and <code class="language-plaintext highlighter-rouge">setgid(0)</code> so our coredump will be created with root privileges.</li>
<li>Uses the <code class="language-plaintext highlighter-rouge">execve</code> syscall.</li>
</ul>
<p>After investigating a few binaries we found that we can use sudo to exploit this issue.
Although this vulnerability can’t be exploited in the default configuration of sudo that comes in popular distros such as Ubuntu or Debian, we will show how we are able to exploit sudo configurations that allow a user to run a single command as root. These setups are very common, for example an administator may permit users to restart a daemon.</p>
<p>To demonstrate the impact of this issue, our setup will allow a user only to run <code class="language-plaintext highlighter-rouge">/usr/bin/true</code> binary as root. This binary has almost no logic in it, and we are able to use the same method to exploit any other innocent “safe” binary.</p>
<h2 id="sudo">Sudo:</h2>
<p>Sudo is a suid binary that allows users to execute commands as root or any other user.
Before executing the command, sudo will drop its privileges to the privileges of the user who was specified to run the command through sudo (root by default).</p>
<p>Sudo can be configured through <code class="language-plaintext highlighter-rouge">/etc/sudoers</code> file, in this file administrators can specify which command a specific user can run as root.</p>
<p>As we said before we will allow only execution of <code class="language-plaintext highlighter-rouge">/usr/bin/true</code>, we added the following line to sudoers file (‘user’ is unprivileged user):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user ALL= /usr/bin/true
</code></pre></div></div>
<p>Now, ‘user’ can only run ‘true’ via sudo, when executed through sudo, true’s ruid and euid are 0.
The dumpable value of true with sudo is 1, that’s means that the only thing left for us to do is to make ‘true’ crash and generate a coredump.</p>
<h1 id="crashing-child-processes">Crashing child processes:</h1>
<p>As we saw before, a process capable of creating a coredump will create one if it receives one of the signals listed above.
Most of the signals are generated by a misbehavior of the executing program, such as referencing invalid memory (<code class="language-plaintext highlighter-rouge">SIGSEGV</code>) or executing illegal instructions (<code class="language-plaintext highlighter-rouge">SIGILL</code>). We can’t rely on the logic of the executed program because we want to be able to generate a core dump for any program executed through sudo.</p>
<p>We found two methods for causing children of a suid process to terminate and create a core file.</p>
<h2 id="rlimit_cpu">RLIMIT_CPU</h2>
<p>One of the signals listed above is <code class="language-plaintext highlighter-rouge">SIGXCPU</code>. This signal is unique compared to the rest - a process receives this signal if it exceeds the CPU time limit configured through <code class="language-plaintext highlighter-rouge">setrlimit</code>.</p>
<p>Resource limits (rlimit) can be set for a process by the program. One of them is <code class="language-plaintext highlighter-rouge">RLIMIT_CPU</code>, which specifies the seconds of CPU time a process is allowed to use. When a process reaches this limit, it will receive the <code class="language-plaintext highlighter-rouge">SIGXCPU</code> signal, resulting in a core dump.</p>
<p>Child processes inherit rlimit values from their parents, therefore we need to set <code class="language-plaintext highlighter-rouge">RLIMIT_CPU</code> before executing the suid binary (sudo in our case). To crash a child process of a suid binary, we need the limit not to reach the suid binary before the child process is executed.</p>
<p>Until commit <a href="https://github.com/torvalds/linux/commit/2bbdbdae05167c688b6d3499a7dab74208b80a22">2bbdbdae05167c688b6d3499a7dab74208b80a22</a> in the Linux kernel, it was not possible to provide 0 as <code class="language-plaintext highlighter-rouge">RLIMIT_CPU</code>. Instead, the kernel would treat it as 1, but since then it’s possible to provide 0 which will terminate the process almost immediately even for very fast child processes.</p>
<p>Another rlimit is <code class="language-plaintext highlighter-rouge">RLIMIT_CORE</code> which specifies the maximum size of a core file, child of suid also inherits this limit from their parent.</p>
<h2 id="ctrl--">CTRL + \</h2>
<p>The first method introduced has its own downsides, it can only receive integer seconds in the limit, and on older kernels it cannot crash immediately.
We wanted to find another method to create coredump in the child which is more flexible and to be able to control more precisely when we terminate the child process.</p>
<p>We found <code class="language-plaintext highlighter-rouge">SIGQUIT</code>, which is another signal that causes a core dump. This signal can be sent to a program directly or by pressing “CTRL + \” in the terminal the program runs in.</p>
<p>You might wonder how we are able to send <code class="language-plaintext highlighter-rouge">SIGQUIT</code> from our unprivileged user to a process with real uid of root.
The answer to that question resides in the code of the tty driver, the <code class="language-plaintext highlighter-rouge">SIGQUIT</code> character in the tty driver will send <code class="language-plaintext highlighter-rouge">SIGQUIT</code> signal to the process group of the parent results in a coredump of the child of suid process (the kernel sends the signal, therefore we bypass the fact that we cannot send signals from our user directly to the child of suid).</p>
<p>This behavior works as expected, when you run a program via sudo you want to be able to send several signals to the child process (this driver also sends <code class="language-plaintext highlighter-rouge">SIGINT</code> on CTRL+C press).</p>
<p>We can fork a new process and execute the suid binary. Meanwhile, at the parent process we will “insert” “CTRL + \” (<code class="language-plaintext highlighter-rouge">SIGQUIT</code>) character programmatically to the terminal.</p>
<p>Now that we have several ways to crash the child of sudo, we are able to generate core dumps with root permissions in arbitrary directories.</p>
<p>As we’ve done in the previous post, our LPE relies on using logrotate to execute arbitrary code. We can achieve this by writing our core file to <code class="language-plaintext highlighter-rouge">/etc/logrotate.d/</code> directory.
Logrotate has a permissive parsing configuration, which ignores all binary content in our core file, and only processes valid string data.</p>
<h2 id="logrotate-configuration">Logrotate configuration:</h2>
<p>To be able to use logrotate for our needs, we had to find a way to include a logrotate configuration string in the memory of the child process (that will appear in the core dump).
We know that environment variables are inherited by children from their parent processes.</p>
<p>After some trial and error, we noticed that not all environment variables from the parent exist in the child of sudo. We looked at the source code of sudo, and it turned out that sudo filters environment variables and only passes a limited number of variables to the child process.</p>
<p>One variable that is included in the child without any modifications is XAUTHORITY. We indeed were able to include our logrotate configuration in this variable!</p>
<h2 id="strategy">Strategy:</h2>
<p>Our final exploit strategy is as follows (tested on Ubuntu 21.04 and Debian 11):</p>
<ol>
<li>set XAUTHORITY to our logrotate configuration so it will be in child’s memory.</li>
<li>chdir into <code class="language-plaintext highlighter-rouge">/etc/logrotate</code>, the core file will be generated there.</li>
<li>set <code class="language-plaintext highlighter-rouge">RLIMIT_CORE</code> to unlimited.</li>
<li>set <code class="language-plaintext highlighter-rouge">RLIMIT_CPU</code> to 0 / send <code class="language-plaintext highlighter-rouge">SIGQUIT</code> to the parent which will terminate children with coredump.</li>
<li>execve our privileged sudo command (true binary in our example).</li>
</ol>
<p>Our program will sometimes crash before sudo has time to execute the privileged child. We can solve this by running our exploit several times in a loop. A core file will be generated in <code class="language-plaintext highlighter-rouge">/etc/logrotate.d/</code> after several attempts.</p>
<p>We included a reverse shell payload in the coredump, which connects to our server, and we should see a root shell on the next execution of logrotate.</p>
<h1 id="pam">PAM</h1>
<p>Another approach was to find another suid binary that executes predefined child processes.
We downloaded several distros and tested them to see if a binary that meets our requirements from above exists.</p>
<p>We found <code class="language-plaintext highlighter-rouge">su</code>, which is a suid binary.
For authentication <code class="language-plaintext highlighter-rouge">su</code> uses <a href="https://linux.die.net/man/8/pam">PAM</a>, which is a collection of libraries that handle the authentication task for applications.
Each program can specify an authentication “stack” which specifies what modules to use from a predefined set of modules.</p>
<p><code class="language-plaintext highlighter-rouge">su</code> uses several modules to authenticate, one of them is <code class="language-plaintext highlighter-rouge">pam_unix.so</code>.
In this module, the module will run an external binary, <code class="language-plaintext highlighter-rouge">/usr/sbin/unix_chkpwd</code>, in one of the code paths to assist with authentication. In an older version (which is included in up-to-date Ubuntu and CentOS) we can reach the code path if the system has SELinux supported.</p>
<p><img src="./2021 - SuDump Exploiting suid binaries through the kernel_files/su.png" alt=""></p>
<p>We experimented with crashing <code class="language-plaintext highlighter-rouge">su</code>’s children as an unauthenticated user without the same restrictions as before - and we are able to crash the program on default configuration without any changes by an administrator.</p>
<p>We have decided to focus on CentOS which has SELinux enforced by default. CentOS 8 is not exploitable, since it uses <code class="language-plaintext highlighter-rouge">systemd-coredump</code> which only saves core dumps in a specific directory. We have decided to test the issue on CentOS 7 (still receives security updates), which uses <code class="language-plaintext highlighter-rouge">abrt</code> as a core dump handler.</p>
<p>CentOS 7 runs an older kernel that doesn’t support providing zero to RLIMIT_CPU, therefore we used the second method of sending CTRL + \ to stdin to crash the helper program.
The helper program runs very quickly and we don’t know how much time it takes from the execution of <code class="language-plaintext highlighter-rouge">su</code> until the helper executes. Therefore, we just ran our exploit several times in a loop with incremental sleep intervals prior to sending the SIGQUIT signal, until one of them succeed.</p>
<p>Using this method, we were able to generate core dump files in <code class="language-plaintext highlighter-rouge">/etc/logrotate.d/</code>.
But before executing the child, <code class="language-plaintext highlighter-rouge">pam_unix</code> wipes all the previous environment variables.
As for now, we haven’t found a way yet to include a logrotate configuration in the memory of the child before the coredump. Therefore, execution of commands is not possible without these strings in the memory.</p>
<h1 id="conclusions">Conclusions:</h1>
<p>In this research we dug deeper into how core dump handling happens inside the Linux kernel. We explored several different mechanisms which are all individually valid, but combined together can create dangerous unwanted behavior.</p>
<p>There are a few workarounds that can meanwhile be implemented to protect against this exploit.</p>
<ol>
<li>
<p>Change <code class="language-plaintext highlighter-rouge">/proc/sys/kernel/core_pattern</code> to an absolute, safe directory (this way, logrotate cannot be triggered).</p>
</li>
<li>
<p>Apparently, at some point in time, <code class="language-plaintext highlighter-rouge">pam_limits.so</code> was removed from the PAM configuration of sudo (in Debian and Ubuntu). Adding this module back to sudo’s PAM configuration and setting RLIMIT_CORE to 0 makes sudo immune to this vulnerability.</p>
</li>
</ol>
<p>Even without abusing logrotate this issue can still allow unauthorized user to create core dumps as root, even in directories where the user doesn’t have write permissions. This can lead to DoS by filling all of the storage quota of another user. Abusing like that should be simpler for an attacker as it doesn’t require injecting clear text commands in the process’ memory and doesn’t rely on logrotate being used.</p>
<h1 id="references">References:</h1>
<p><a href="https://www.openwall.com/lists/oss-security/2021/10/20/2">https://www.openwall.com/lists/oss-security/2021/10/20/2</a></p>
</div>
</div>
<br>
<div id="disqus_thread"><iframe id="dsq-app1897" name="dsq-app1897" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="./2021 - SuDump Exploiting suid binaries through the kernel_files/saved_resource.html" style="width: 1px !important; min-width: 100% !important; border: none !important; overflow: hidden !important; height: 397px !important;" horizontalscrolling="no" verticalscrolling="no"></iframe></div>
<script>
/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/

var disqus_config = function () {
this.page.url = 'https://alephsecurity.com/2021/10/20/sudump/';  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = '/2021/10/20/sudump'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//alephsecurity.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<script id="dsq-count-scr" src="./2021 - SuDump Exploiting suid binaries through the kernel_files/count.js.下載" async=""></script>
</div>
</div>


<iframe style="display: none;" src="./2021 - SuDump Exploiting suid binaries through the kernel_files/saved_resource(1).html"></iframe></body></html>