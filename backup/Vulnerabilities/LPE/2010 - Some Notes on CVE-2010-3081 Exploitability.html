<!DOCTYPE html>
<!-- saved from url=(0058)https://blog.nelhage.com/2010/11/exploiting-cve-2010-3081/ -->
<html class="js video maskImage placeholder" lang="en"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <title>Some notes on CVE-2010-3081 exploitability - Made of Bugs</title>
  <meta name="author" content="Nelson Elhage">

  
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">
  <meta name="generator" content="Hugo 0.72.0">

  <link rel="canonical" href="https://blog.nelhage.com/2010/11/exploiting-cve-2010-3081/">
  <link href="https://blog.nelhage.com/favicon.png" rel="icon">
  <link href="./2010 - Some Notes on CVE-2010-3081 Exploitability_files/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="https://blog.nelhage.com/atom.xml" rel="alternate" title="Made of Bugs" type="application/atom+xml">
  <script src="./2010 - Some Notes on CVE-2010-3081 Exploitability_files/modernizr-2.0.js.‰∏ãËºâ"></script>
  <script src="./2010 - Some Notes on CVE-2010-3081 Exploitability_files/jquery.min.js.‰∏ãËºâ"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="./2010 - Some Notes on CVE-2010-3081 Exploitability_files/octopress.js.‰∏ãËºâ" type="text/javascript"></script>
<link href="./2010 - Some Notes on CVE-2010-3081 Exploitability_files/css" rel="stylesheet" type="text/css">
  <link href="./2010 - Some Notes on CVE-2010-3081 Exploitability_files/css(1)" rel="stylesheet" type="text/css">



</head>
<body class="collapse-sidebar sidebar-footer">
  <header role="banner">
    <hgroup>
      <h1><a href="https://blog.nelhage.com/">Made of Bugs</a></h1>
      <h3>It's software. It's made of bugs.</h3>
    </hgroup>
  </header>
  <div class="navi">
<ul>
  <li><a href="https://blog.nelhage.com/post/">Archives</a></li>
  <li><a href="https://blog.nelhage.com/subscribe">Subscribe</a></li>
  <li><a href="https://nelhage.com/">Author</a></li>
</ul>
</div>

  <div id="main">
    <div id="content">


<div>
  <article class="hentry" role="article">
    <header>
  <h1 class="entry-title">Some notes on CVE-2010-3081 exploitability</h1>
  <p class="meta">
    
    <time datetime="2010-11-30T12:58:01Z" pubdate="">
      Nov 30, 2010
    </time>
    
  </p>
</header>

<div class="entry-content">
  <p>Most of you reading this blog probably remember
<a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2010-3081">CVE-2010-3081</a>. The bug got an awful lot of publicity when it
was discovered an announced, due to allowing local privilege
escalation against virtually all 64-bit Linux kernels in common use at
the time.</p>
<p>While investigating CVE-2010-3081, I discovered that several of the
commonly-believed facts about the CVE were wrong, and it was even more
broadly exploitable than was publically documented. I‚Äôd like to share
those observations here.</p>
<h2 id="a-brief-review-of-the-bug">A brief review of the bug&nbsp;<a class="anchor" href="https://blog.nelhage.com/2010/11/exploiting-cve-2010-3081/#a-brief-review-of-the-bug"><i class="small linkify icon">	üîóÔ∏é</i></a> </h2>
<p>The bug arose from the <code>compat_alloc_user_space</code> function in Linux‚Äôs
32-bit compatibility support on 64-bit
systems. <code>compat_alloc_user_space</code> allocates and returns space on the
userspace kernel stack for the kernel to use:</p>
<pre><code>static inline void __user *compat_alloc_user_space(long len)
{
    struct pt_regs *regs = task_pt_regs(current);
    return (void __user *)regs-&gt;sp - len;
}
</code></pre>
<p>This function is only called by compat-mode syscalls, so <code>current</code> is assumed to
be a 32-bit process, in which case <code>regs-&gt;sp</code>, the user stack pointer, will be a
32-bit quantity. This, if we subtract a small <code>len</code>, the result should still fit
in 32 bits, which, on a 64-bit system means it is guaranteed to fall within the
user address space.</p>
<p>Because of this, some callers of <code>compat_alloc_user_space</code> were lazy, and did
not call <code>access_ok</code> (or a function which called <code>access_ok</code>) to check that the
result of <code>compat_alloc_user_space</code> fell within the user address space.</p>
<p>However, it turned out that some call sites in the kernel called
<code>compat_alloc_user_space</code> with a user-controlled <code>len</code> value, allowing the
subtraction to wrap around. On a 64-bit system, the kernel lives in the top four
gigabytes of memory, and so this wraparound is enough for a user to cause
<code>compat_alloc_user_space</code> to return a pointer into the kernel‚Äôs address space.</p>
<p>Moreover, it turned out that the functions that used a user-controlled <code>len</code>
also did not check <code>access_ok</code> on the result of the allocation. In particular,
Linux 2.6.26 introduced the <code>compat_mc_getsockopt</code> function, which called
<code>compat_alloc_user_space</code> with a user-controlled length and then copied
user-controlled data to this pointer. It is this function which the public
exploit targetted.</p>
<h2 id="disabling-32-bit-binaries-doesnt-help">Disabling 32-bit binaries doesn‚Äôt help&nbsp;<a class="anchor" href="https://blog.nelhage.com/2010/11/exploiting-cve-2010-3081/#disabling-32-bit-binaries-doesnt-help"><i class="small linkify icon">	üîóÔ∏é</i></a> </h2>
<p>When an <a href="http://www.seclists.org/fulldisclosure/2010/Sep/268">exploit</a> was released for this bug, many sources
circulated a <a href="https://access.redhat.com/kb/docs/DOC-40265">mitigation</a>: Disable 32-bit binaries on a
system. Prevent compat-mode processes from running, the logic goes,
and you prevent anyone from making a compat-mode syscall that triggers
the vulnerable path.</p>
<p>This mitigation indeed prevented the public exploit from working (it
included 32-bit inline assembly, and so couldn‚Äôt even easily be
recompiled as a 64-bit binary), and many observers seemed to believe
it closed the bug entirely.</p>
<p>However, this was not the case! It turns out, on an <code>amd64</code> system, a
64-bit process can still make a compat-mode system call using the <code>int $0x80</code> instruction, which is the traditional 32-bit syscall mechanism!
Even though the process is running in 64-bit mode, <code>int $0x80</code>
redirects to the compat-mode syscall table.</p>
<p>After realizing this, modifying the public exploit to work when
compiled in 64-bit mode was a simple matter of porting the inline
assembly, and changing a small handful of types. I‚Äôve posted the
modified <a href="http://nelhage.com/files/abftw_64.c">exploit</a> and the <a href="http://nelhage.com/files/abftw.diff">diff</a> against the original
for the curious.</p>
<h2 id="the-integer-overflow-is-totally-irrelevant">The integer overflow is totally irrelevant&nbsp;<a class="anchor" href="https://blog.nelhage.com/2010/11/exploiting-cve-2010-3081/#the-integer-overflow-is-totally-irrelevant"><i class="small linkify icon">	üîóÔ∏é</i></a> </h2>
<p>Once you‚Äôve realized that you can make compat-mode system calls from a 64-bit
process, a little bit of thought reveals something else
interesting. <code>compat_alloc_user_space</code> subtracts the <code>len</code> value off of the
userspace stack pointer. Previously, we relied on subtracting a large value from
a 32-bit stack pointer in order to end up with a kernel pointer. However, while
a 32-bit is limited to a 32-bit stack pointer, a 64-bit process can write a full
64-bit value into <code>%rsp</code>, and thus <code>regs-&gt;sp</code>! There‚Äôs no need for underflow at
all ‚Äì you can just write a 64-bit value into <code>%rsp</code> and do an <code>int $0x80</code>, and
make <code>compat_alloc_user_space</code> return any value you please!</p>
<p>The condition for exploitability thus drops from ‚Äúuser-controlled
<code>len</code> and no <code>access_ok</code>‚Äù to simply ‚Äúno <code>access_ok</code>‚Äù.</p>
<p>This is interesting, because it turns out that some very old kernels, before
2.6.11, including RHEL 4, have the following function:</p>
<pre><code>int siocdevprivate_ioctl(unsigned int fd, unsigned int cmd, unsigned long arg)
{
        struct ifreq __user *u_ifreq64;

        ...
        u_ifreq64 = compat_alloc_user_space(sizeof(*u_ifreq64));

        /* Don't check these user accesses, just let that get trapped
         * in the ioctl handler instead.
         */
        copy_to_user(&amp;u_ifreq64-&gt;ifr_ifrn.ifrn_name[0], &amp;tmp_buf[0], IFNAMSIZ);
        __put_user(data64, &amp;u_ifreq64-&gt;ifr_ifru.ifru_data);

        return sys_ioctl(fd, cmd, (unsigned long) u_ifreq64);
}
</code></pre>
<p>Remember, we can make <code>compat_alloc_user_space</code> return an arbitrary
value. The <code>copy_to_user</code> will call <code>access_ok</code> and fail, but that
return value will be discarded, and the <code>__put_user</code> will scribble 32
bits of user-controlled data at a user-controlled address. Bingo,
local root.</p>
<p>It turns out this function was present in Linux 2.4.x, too, meaning
that this exploit even affected RHEL3 and anyone else still running a
2.4-based system!</p>
<p>Based on this exploit, I‚Äôve produced a working proof-of-concept
exploit for RHEL4, based on the released exploit for RHEL5. Contact me
if you‚Äôre interested, but it‚Äôs pretty straightforward.</p>
<h2 id="closing-notes">Closing notes&nbsp;<a class="anchor" href="https://blog.nelhage.com/2010/11/exploiting-cve-2010-3081/#closing-notes"><i class="small linkify icon">	üîóÔ∏é</i></a> </h2>
<p>As far as I know, neither of these facts has been publically
documented prior to this post. I shared this information with Red Hat,
and they requested I keep it private until they released fixes for
RHEL 3, which happened last week. I would not be at all surprised to
learn that someone else has private exploits that incorporate either
or both of these observations, though.</p>
<p>One important moral here is you must be <em>very careful</em> when declaring
a system unaffected by a vulnerability, or declaring a mitigation to
be complete. Software systems have gotten tremendously complex, and
it‚Äôs often impossible to be totally confident you understand every
last way an attacker could tickle a vulnerability.</p>


</div>

    <footer>

      <div class="c2a">
        <form action="https://buttondown.email/api/emails/embed-subscribe/nelhage" method="post" target="popupwindow" onsubmit="window.open(&#39;https://buttondown.email/nelhage&#39;, &#39;popupwindow&#39;)" class="embeddable-buttondown-form">
          <p>
            <label for="bd-email">Subscribe to my newsletter (~1 post/week and blog updates):</label>
          </p>
          <p>
          <input type="email" name="email" placeholder="email@domain.com" id="bd-email">
          <input type="hidden" value="1" name="embed">
          <input type="submit" value="Subscribe">
          </p>
          <p>
            <a href="https://buttondown.email/" target="_blank">Powered by Buttondown.</a>
          </p>
        </form>
      </div>

    <p class="meta">
      
        <a class="basic-alignment left" href="https://blog.nelhage.com/2010/11/why-scons-is-cool/" title="Previous Post: Why scons is cool">¬´ Why scons is cool</a>
      
      
        <a class="basic-alignment right" href="https://blog.nelhage.com/2010/12/cve-2010-4258-from-dos-to-privesc/" title="Next Post: CVE-2010-4258: Turning denial-of-service into privilege escalation">CVE-2010-4258: Turning denial-of-service into privilege escalation ¬ª</a>
      
    </p>
  </footer>
</article>
</div>

<hr>

</div>
</div>
<footer role="contentinfo">

  <p>
    <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
      <img alt="Creative Commons License" style="border-width:0" src="./2010 - Some Notes on CVE-2010-3081 Exploitability_files/88x31.png">
    </a>
    <br>
    <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Made of Bugs</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="https://nelhage.com/" property="cc:attributionName" rel="cc:attributionURL">Nelson Elhage</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative
    Commons Attribution 4.0 International License</a>.
  </p>
</footer>
<script async="" defer="" src="./2010 - Some Notes on CVE-2010-3081 Exploitability_files/latest.js.‰∏ãËºâ"></script>
<noscript><img src="https://sa.nelhage.com/noscript.gif" alt=""/></noscript>



</body></html>