<!DOCTYPE html>
<!-- saved from url=(0036)https://qyn.app/posts/CVE-2023-3389/ -->
<html lang="en"><!-- The Head --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover">

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.2">
<meta property="og:title" content="CVE-2023-3389 - LinkedPoll">
<meta name="author" content="Querijn Voet">
<meta property="og:locale" content="en">
<meta name="description" content="Exploiting a vulnerability in the io_uring subsystem of the Linux kernel.">
<meta property="og:description" content="Exploiting a vulnerability in the io_uring subsystem of the Linux kernel.">
<link rel="canonical" href="https://qyn.app/posts/CVE-2023-3389/">
<meta property="og:url" content="/posts/CVE-2023-3389/">
<meta property="og:site_name" content="Querijn Voet">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-08-01T18:00:00+02:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="CVE-2023-3389 - LinkedPoll">
<meta name="twitter:site" content="@qynln">
<meta name="twitter:creator" content="@qynln">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Querijn Voet","url":"https://github.com/qyn-ctf/"},"dateModified":"2023-08-01T18:00:00+02:00","datePublished":"2023-08-01T18:00:00+02:00","description":"Exploiting a vulnerability in the io_uring subsystem of the Linux kernel.","headline":"CVE-2023-3389 - LinkedPoll","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/CVE-2023-3389/"},"url":"/posts/CVE-2023-3389/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>CVE-2023-3389 - LinkedPoll | Querijn Voet
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="https://qyn.app/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://qyn.app/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://qyn.app/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="https://qyn.app/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="https://qyn.app/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Querijn Voet">
<meta name="application-name" content="Querijn Voet">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com/">
      <link rel="dns-prefetch" href="https://fonts.googleapis.com/">
    
      <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
      <link rel="dns-prefetch" href="https://fonts.gstatic.com/" crossorigin="">
    
      <link rel="preconnect" href="https://fonts.googleapis.com/">
      <link rel="dns-prefetch" href="https://fonts.googleapis.com/">
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net/">
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net/">
    

    <link rel="stylesheet" href="./CVE-2023-3389 - LinkedPoll _ Querijn Voet_files/css2">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="./CVE-2023-3389 - LinkedPoll _ Querijn Voet_files/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="./CVE-2023-3389 - LinkedPoll _ Querijn Voet_files/all.min.css">

  <link rel="stylesheet" href="./CVE-2023-3389 - LinkedPoll _ Querijn Voet_files/style.css">

  
    <link rel="stylesheet" href="./CVE-2023-3389 - LinkedPoll _ Querijn Voet_files/tocbot.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="./CVE-2023-3389 - LinkedPoll _ Querijn Voet_files/magnific-popup.min.css">
  

  <!-- JavaScript -->

  
    <!-- Switch the mode between dark and light. -->

<script type="text/javascript">
  class ModeToggle {
    static get MODE_KEY() {
      return 'mode';
    }
    static get MODE_ATTR() {
      return 'data-mode';
    }
    static get DARK_MODE() {
      return 'dark';
    }
    static get LIGHT_MODE() {
      return 'light';
    }
    static get ID() {
      return 'mode-toggle';
    }

    constructor() {
      if (this.hasMode) {
        if (this.isDarkMode) {
          if (!this.isSysDarkPrefer) {
            this.setDark();
          }
        } else {
          if (this.isSysDarkPrefer) {
            this.setLight();
          }
        }
      }

      let self = this;

      /* always follow the system prefers */
      this.sysDarkPrefers.addEventListener('change', () => {
        if (self.hasMode) {
          if (self.isDarkMode) {
            if (!self.isSysDarkPrefer) {
              self.setDark();
            }
          } else {
            if (self.isSysDarkPrefer) {
              self.setLight();
            }
          }

          self.clearMode();
        }

        self.notify();
      });
    } /* constructor() */

    get sysDarkPrefers() {
      return window.matchMedia('(prefers-color-scheme: dark)');
    }

    get isSysDarkPrefer() {
      return this.sysDarkPrefers.matches;
    }

    get isDarkMode() {
      return this.mode === ModeToggle.DARK_MODE;
    }

    get isLightMode() {
      return this.mode === ModeToggle.LIGHT_MODE;
    }

    get hasMode() {
      return this.mode != null;
    }

    get mode() {
      return sessionStorage.getItem(ModeToggle.MODE_KEY);
    }

    /* get the current mode on screen */
    get modeStatus() {
      if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) {
        return ModeToggle.DARK_MODE;
      } else {
        return ModeToggle.LIGHT_MODE;
      }
    }

    setDark() {
      document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      document.documentElement.removeAttribute(ModeToggle.MODE_ATTR);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }

    /* Notify another plugins that the theme mode has changed */
    notify() {
      window.postMessage(
        {
          direction: ModeToggle.ID,
          message: this.modeStatus
        },
        '*'
      );
    }

    flipMode() {
      if (this.hasMode) {
        if (this.isSysDarkPrefer) {
          if (this.isLightMode) {
            this.clearMode();
          } else {
            this.setLight();
          }
        } else {
          if (this.isDarkMode) {
            this.clearMode();
          } else {
            this.setDark();
          }
        }
      } else {
        if (this.isSysDarkPrefer) {
          this.setLight();
        } else {
          this.setDark();
        }
      }

      this.notify();
    } /* flipMode() */
  } /* ModeToggle */

  const modeToggle = new ModeToggle();
</script>

  

  <!-- A placeholder to allow defining custom metadata -->

<style type="text/css">@font-face {
  font-family: 'rbicon';
  src: url(chrome-extension://dipiagiiohfljcicegpgffpbnjmgjcnf/fonts/rbicon.woff2) format("woff2");
  font-weight: normal;
  font-style: normal; }
</style></head>


  <body>
    <!-- The Side Bar -->

<div id="sidebar" class="d-flex flex-column align-items-end">
  <div class="profile-wrapper">
    <div class="site-title">
      <a href="https://qyn.app/">Querijn Voet</a>
    </div>
    <div class="site-subtitle fst-italic">Security &amp; CTF related stuff</div>
  </div>
  <!-- .profile-wrapper -->

  <ul class="nav flex-column flex-grow-1 w-100 ps-0">
    <!-- home -->
    <li class="nav-item">
      <a href="https://qyn.app/" class="nav-link">
        <i class="fa-fw fas fa-home"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
      <li class="nav-item">
        <a href="https://qyn.app/categories/" class="nav-link">
          <i class="fa-fw fas fa-stream"></i>
          

          <span>CATEGORIES</span>
        </a>
      </li>
      <!-- .nav-item -->
    
      <li class="nav-item">
        <a href="https://qyn.app/tags/" class="nav-link">
          <i class="fa-fw fas fa-tags"></i>
          

          <span>TAGS</span>
        </a>
      </li>
      <!-- .nav-item -->
    
      <li class="nav-item">
        <a href="https://qyn.app/archives/" class="nav-link">
          <i class="fa-fw fas fa-archive"></i>
          

          <span>ARCHIVES</span>
        </a>
      </li>
      <!-- .nav-item -->
    
      <li class="nav-item">
        <a href="https://qyn.app/about/" class="nav-link">
          <i class="fa-fw fas fa-info-circle"></i>
          

          <span>ABOUT</span>
        </a>
      </li>
      <!-- .nav-item -->
    
  </ul>
  <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    
      <button class="mode-toggle btn" aria-label="Switch Mode">
        <i class="fas fa-adjust"></i>
      </button>

      
        <span class="icon-border"></span>
      
    

    
      

      
        <a href="https://github.com/qyn-ctf" aria-label="github" target="_blank" rel="noopener noreferrer">
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a href="https://twitter.com/qynln" aria-label="twitter" target="_blank" rel="noopener noreferrer">
          <i class="fab fa-twitter"></i>
        </a>
      
    
      

      
    
      

      
        <a href="https://qyn.app/feed.xml" aria-label="rss">
          <i class="fas fa-rss"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</div>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div id="main" class="container px-xxl-5">
        <!-- The Top Bar -->

<div id="topbar-wrapper">
  <div id="topbar" class="container d-flex align-items-center justify-content-between h-100">
    <span id="breadcrumb">
      

      
        
          
            <span>
              <a href="https://qyn.app/">
                Home
              </a>
            </span>

          
        
          
        
          
            
              <span>CVE-2023-3389 - LinkedPoll</span>
            

          
        
      
    </span>
    <!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search...">
    </span>
    <span id="search-cancel">Cancel</span>
  </div>
</div>

        











<div class="row">
  <!-- core -->
  <div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pe-xl-4">
    

    <div class="post px-1 px-md-2">
      

      
        
      
        <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->


<!-- images -->




<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    

    

  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    

    

  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    

    

  

  
  

  




<!-- return -->




<h1 data-toc-skip="">CVE-2023-3389 - LinkedPoll</h1>

<div class="post-meta text-muted">
    <!-- published date -->
    <span>
      Posted
      <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Wed, Aug 2, 2023 12:00 AM">Aug 2, 2023</em>

    </span>

    <!-- lastmod date -->
    

  

  <div class="d-flex justify-content-between">
    <!-- author(s) -->
    <span>
      

      By

      <em>
      
        
          <a href="https://github.com/qyn-ctf/">Querijn Voet</a>
          
        
      
      </em>
    </span>

    <div>
      <!-- read time -->
      <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-original-title="5313 words">
  <em>29 min</em> read</span>

    </div>

  </div> <!-- .d-flex -->

</div> <!-- .post-meta -->

<div class="post-content">
  <p>Exploiting a vulnerability in the <code class="language-plaintext highlighter-rouge">io_uring</code> subsystem of the Linux kernel.</p>

<h2 id="introduction"><span class="me-2">Introduction</span><a href="https://qyn.app/posts/CVE-2023-3389/#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>In this post I will dive into a bug I discovered in the <code class="language-plaintext highlighter-rouge">io_uring</code> subsystem, which involves racing and canceling a linked timeout.<br>
But first, why <code class="language-plaintext highlighter-rouge">io_uring</code>?<br>
One of the driving factors behind my explo(ration/itation) of this subsystem is Google’s <code class="language-plaintext highlighter-rouge">kCTF</code> program. This unique initiative offers substantial rewards, up to $133,337 for successfully exploiting a Linux kernel bug within a <code class="language-plaintext highlighter-rouge">nsjail</code> environment. Motivated by the prospect of participating in this program, I began researching previous write-ups and interestingly, a lot of them targeted <code class="language-plaintext highlighter-rouge">io_uring</code>. Also, time was of the essence, as Google was preparing to make changes to the program, which would disable the <code class="language-plaintext highlighter-rouge">io_uring</code> for the most lucrative bounties. With this deadline looming, I embarked on my journey to uncover <em>yet another</em> vulnerability in the <code class="language-plaintext highlighter-rouge">io_uring</code> subsystem.</p>

<h2 id="io_uring"><span class="me-2">IO_URING</span><a href="https://qyn.app/posts/CVE-2023-3389/#io_uring" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Tons of writeups have already explained (and exploited) various parts of the <code class="language-plaintext highlighter-rouge">io_uring</code> subsystem better than I ever could so please read them:</p>
<ul>
  <li><a href="https://1day.dev/notes/CVE-2022-2602-DirtyCred-File-Exploitation-applied-on-an-io_uring-UAF/">CVE-2022-2602: DirtyCred</a> - <a href="https://twitter.com/kiks7_7">@kiks</a></li>
  <li><a href="https://exploiter.dev/blog/2022/CVE-2022-2602.html">CVE-2022-2602: DirtyCred Remastered</a> - <a href="https://twitter.com/LukeGix">@LukeGix</a></li>
  <li><a href="https://blog.kylebot.net/2022/10/16/CVE-2022-1786/">CVE-2022-1786: A Journey To The Dawn</a> - <a href="https://twitter.com/ky1ebot">@ky1ebot</a></li>
  <li><a href="https://ruia-ruia.github.io/2022/08/05/CVE-2022-29582-io-uring">CVE-2022-29582</a> - <a href="https://twitter.com/Awarau1">@Awarau1</a> &amp; <a href="https://twitter.com/pqlqpql">@pql</a></li>
  <li><a href="https://dawnslab.jd.com/linux-5.19-rc2_pbuf_ring_0day/">io_register_pbuf_ring</a> <a href="https://twitter.com/dawnseclab">@dawnseclab</a></li>
  <li><a href="https://starlabs.sg/blog/2022/06-io_uring-new-code-new-bugs-and-a-new-exploit-technique/">CVE-2021-41073: new code, new bugs, and a new exploit technique</a> <a href="https://twitter.com/junr0n">@junr0n</a></li>
  <li><a href="https://flattsecurity.medium.com/cve-2021-20226-a-reference-counting-bug-which-leads-to-local-privilege-escalation-in-io-uring-e946bd69177a">CVE-2021–20226: Reference counting bug</a> - <a href="https://twitter.com/Ga_ryo_">@Ga_ryo_</a></li>
  <li><a href="https://chompie.rip/Blog+Posts/Put+an+io_uring+on+it+-+Exploiting+the+Linux+Kernel">CVE-2021-41073: Put an io_uring on it</a> - <a href="https://twitter.com/chompie1337">@chompie</a></li>
</ul>

<p>In this post I aim to build upon these and specifically <a href="https://ruia-ruia.github.io/2022/08/05/CVE-2022-29582-io-uring">CVE-2022-29582</a>, due to the similarities with timeouts.</p>

<p>Within <code class="language-plaintext highlighter-rouge">io_uring</code> there are a lot of different operations one can use (40 in <code class="language-plaintext highlighter-rouge">v5.15.89</code>). I will just explain the relevant parts of the ones I used to trigger and exploit the bug.</p>

<h3 id="asynchronous-requests"><span class="me-2">Asynchronous Requests</span><a href="https://qyn.app/posts/CVE-2023-3389/#asynchronous-requests" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>For this post its just important to know that operations can be executed simultaneously using this flag.</p>

<h3 id="ioring_op_timeout"><span class="me-2">IORING_OP_TIMEOUT</span><a href="https://qyn.app/posts/CVE-2023-3389/#ioring_op_timeout" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>The <code class="language-plaintext highlighter-rouge">IORING_OP_TIMEOUT</code> operation allows developers to use timeouts. More information can be found in <a href="https://ruia-ruia.github.io/2022/08/05/CVE-2022-29582-io-uring/#timeout-operations-ioring_op_timeout">CVE-2022-29582#timeout-operations-ioring_op_timeout</a>.</p>

<h3 id="ioring_op_link_timeout"><span class="me-2">IORING_OP_LINK_TIMEOUT</span><a href="https://qyn.app/posts/CVE-2023-3389/#ioring_op_link_timeout" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>The <code class="language-plaintext highlighter-rouge">IORING_OP_LINK_TIMEOUT</code> operation allows developers to add a timeout to the previous request in the chain. This request is first <em>prepped</em> and then <em>armed</em>.<br>
Since sqe (submission queue entry) can be evaluated in various contexts (asynchronous, syscall), the preparation and arming of such a request may occur in different location:</p>
<div file="io_uring.c" class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="io_uring.c"><i class="far fa-file-code fa-fw"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">__io_queue_sqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
	<span class="n">__must_hold</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">uring_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">linked_timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">issue_sqe:</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">io_issue_sqe</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">IO_URING_F_NONBLOCK</span><span class="o">|</span><span class="n">IO_URING_F_COMPLETE_DEFER</span><span class="p">);</span>
    <span class="c1">// ...</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">linked_timeout</span> <span class="o">=</span> <span class="n">io_prep_linked_timeout</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">linked_timeout</span><span class="p">)</span>
			<span class="n">io_queue_linked_timeout</span><span class="p">(</span><span class="n">linked_timeout</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REQ_F_NOWAIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">linked_timeout</span> <span class="o">=</span> <span class="n">io_prep_linked_timeout</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">io_arm_poll_handler</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IO_APOLL_READY</span><span class="p">:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">linked_timeout</span><span class="p">)</span>
				<span class="n">io_queue_linked_timeout</span><span class="p">(</span><span class="n">linked_timeout</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">issue_sqe</span><span class="p">;</span>
            
            <span class="c1">// ...</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">linked_timeout</span><span class="p">)</span>
			<span class="n">io_queue_linked_timeout</span><span class="p">(</span><span class="n">linked_timeout</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div file="io_uring.c" class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="io_uring.c"><i class="far fa-file-code fa-fw"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">io_wq_submit_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_wq_work</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">io_kiocb</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="c1">// ...</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="n">io_prep_linked_timeout</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
		<span class="n">io_queue_linked_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>

    <span class="c1">// ...</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">io_issue_sqe</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="c1">// ..</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div file="io_uring.c" class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="io_uring.c"><i class="far fa-file-code fa-fw"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">io_queue_async_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">locked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">io_ring_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">io_prep_linked_timeout</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
    <span class="c1">// ...</span>
    <span class="n">io_wq_enqueue</span><span class="p">(</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">io_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="p">)</span>
		<span class="n">io_queue_linked_timeout</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Notice how all of these requests first call <code class="language-plaintext highlighter-rouge">io_prep_linked_timeout</code> before calling <code class="language-plaintext highlighter-rouge">io_issue_sqe</code> / <code class="language-plaintext highlighter-rouge">io_wq_enqueue</code> except for <code class="language-plaintext highlighter-rouge">__io_queue_sqe</code>.</p>

<p>Lets look a bit closer at the <code class="language-plaintext highlighter-rouge">io_prep_linked_timeout</code> method:</p>

<div file="io_uring.c" class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="io_uring.c"><i class="far fa-file-code fa-fw"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="nf">io_prep_linked_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REQ_F_ARM_LTIMEOUT</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__io_prep_linked_timeout</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="nf">__io_prep_linked_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">REQ_F_ARM_LTIMEOUT</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">REQ_F_LINK_TIMEOUT</span><span class="p">;</span>

	<span class="cm">/* linked timeouts should have two refs once prep'ed */</span>
	<span class="n">io_req_set_refcount</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">__io_req_set_refcount</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>It becomes clear that a request can <strong>only</strong> be prepped if it has the <code class="language-plaintext highlighter-rouge">REQ_F_ARM_LTIMEOUT</code> flag (<em>ready to be armed</em>) and will then <em>transition</em> to the <code class="language-plaintext highlighter-rouge">REQ_F_LINK_TIMEOUT</code> flag (indicating the request has been armed).</p>

<p>Lets look a bit closer at the <code class="language-plaintext highlighter-rouge">io_queue_linked_timeout</code> method:</p>

<div file="io_uring.c" class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="io_uring.c"><i class="far fa-file-code fa-fw"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">io_queue_linked_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">io_ring_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timeout_lock</span><span class="p">);</span>
	<span class="cm">/*
	 * If the back reference is NULL, then our linked request finished
	 * before we got a chance to setup the timer
	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">.</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">io_timeout_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">;</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">io_link_timeout_fn</span><span class="p">;</span>
		<span class="n">hrtimer_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">timespec64_to_ktime</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ts</span><span class="p">),</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ltimeout_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timeout_lock</span><span class="p">);</span>
	<span class="cm">/* drop submission reference */</span>
	<span class="n">io_put_req</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>This will start the linked timeout and add it to the <code class="language-plaintext highlighter-rouge">ctx-&gt;ltimeout_list</code> list.</p>

<h3 id="ioring_op_timeout_remove"><span class="me-2">IORING_OP_TIMEOUT_REMOVE</span><a href="https://qyn.app/posts/CVE-2023-3389/#ioring_op_timeout_remove" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>This operation allows developers to <strong>remove / cancel</strong> regular timeouts and <strong>update</strong> regular and linked timeouts. Updating works as follows:</p>
<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">io_timeout_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_ring_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">__u64</span> <span class="n">user_data</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">timespec64</span> <span class="o">*</span><span class="n">ts</span><span class="p">,</span> <span class="k">enum</span> <span class="n">hrtimer_mode</span> <span class="n">mode</span><span class="p">)</span>
	<span class="n">__must_hold</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timeout_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">io_timeout_extract</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">user_data</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">io_timeout_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">.</span><span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* noseq */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timeout_list</span><span class="p">);</span>
	<span class="n">hrtimer_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">io_timeout_get_clock</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">io_timeout_fn</span><span class="p">;</span>
	<span class="n">hrtimer_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">timespec64_to_ktime</span><span class="p">(</span><span class="o">*</span><span class="n">ts</span><span class="p">),</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">io_linked_timeout_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_ring_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">__u64</span> <span class="n">user_data</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">timespec64</span> <span class="o">*</span><span class="n">ts</span><span class="p">,</span> <span class="k">enum</span> <span class="n">hrtimer_mode</span> <span class="n">mode</span><span class="p">)</span>
	<span class="n">__must_hold</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timeout_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">io_timeout_data</span> <span class="o">*</span><span class="n">io</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ltimeout_list</span><span class="p">,</span> <span class="n">timeout</span><span class="p">.</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">found</span> <span class="o">=</span> <span class="n">user_data</span> <span class="o">==</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">user_data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">io</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hrtimer_try_to_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EALREADY</span><span class="p">;</span>
	<span class="n">hrtimer_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">io_timeout_get_clock</span><span class="p">(</span><span class="n">io</span><span class="p">),</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">io</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">io_link_timeout_fn</span><span class="p">;</span>
	<span class="n">hrtimer_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">timespec64_to_ktime</span><span class="p">(</span><span class="o">*</span><span class="n">ts</span><span class="p">),</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>For linked timeouts it first tries to find the ltimeout in the <code class="language-plaintext highlighter-rouge">ctx-&gt;ltimeout_list</code>, while <code class="language-plaintext highlighter-rouge">io_timeout_extract</code> locates the timeouts in <code class="language-plaintext highlighter-rouge">ctx-&gt;timeout_list</code>. Other than that the functions could be used interchangeably if a regular timeout is somehow able to get into the <code class="language-plaintext highlighter-rouge">ctx-&gt;ltimeout_list</code>.</p>

<h3 id="ioring_op_poll_add"><span class="me-2">IORING_OP_POLL_ADD</span><a href="https://qyn.app/posts/CVE-2023-3389/#ioring_op_poll_add" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>The <code class="language-plaintext highlighter-rouge">IORING_OP_POLL_ADD</code> operation allows developers to use polling.</p>

<h3 id="ioring_op_poll_remove"><span class="me-2">IORING_OP_POLL_REMOVE</span><a href="https://qyn.app/posts/CVE-2023-3389/#ioring_op_poll_remove" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>The <code class="language-plaintext highlighter-rouge">IORING_OP_POLL_REMOVE</code> operation allows developers to remove / update poll requests. It works by first finding the poll request, based on the provided <code class="language-plaintext highlighter-rouge">user_data</code> (<code class="language-plaintext highlighter-rouge">io_poll_find</code>) and subsequently cancels the request by invoking <code class="language-plaintext highlighter-rouge">io_req_complete</code> with that poll request, which in turn calls <code class="language-plaintext highlighter-rouge">__io_req_complete</code> and <code class="language-plaintext highlighter-rouge">io_req_complete_post</code>:</p>

<div file="io_uring.c" class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="io_uring.c"><i class="far fa-file-code fa-fw"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">io_poll_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">issue_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">io_ring_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">preq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret2</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">completion_lock</span><span class="p">);</span>
	<span class="n">preq</span> <span class="o">=</span> <span class="n">io_poll_find</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">poll_update</span><span class="p">.</span><span class="n">old_user_data</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">preq</span> <span class="o">||</span> <span class="o">!</span><span class="n">io_poll_disarm</span><span class="p">(</span><span class="n">preq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">completion_lock</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">preq</span> <span class="o">?</span> <span class="o">-</span><span class="n">EALREADY</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">completion_lock</span><span class="p">);</span>

	<span class="c1">// ...</span>
	<span class="n">req_set_fail</span><span class="p">(</span><span class="n">preq</span><span class="p">);</span>
	<span class="n">io_req_complete</span><span class="p">(</span><span class="n">preq</span><span class="p">,</span> <span class="o">-</span><span class="n">ECANCELED</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">req_set_fail</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="cm">/* complete update request, we're done with it */</span>
	<span class="n">io_req_complete</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div file="io_uring.c" class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="io_uring.c"><i class="far fa-file-code fa-fw"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">io_req_complete_post</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">s32</span> <span class="n">res</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">cflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">io_ring_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">completion_lock</span><span class="p">);</span>
	<span class="n">__io_fill_cqe</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">user_data</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">cflags</span><span class="p">);</span>
	<span class="cm">/*
	 * If we're the last reference to this request, add to our locked
	 * free_list cache.
	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req_ref_put_and_test</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">REQ_F_LINK</span> <span class="o">|</span> <span class="n">REQ_F_HARDLINK</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IO_DISARM_MASK</span><span class="p">)</span>
				<span class="n">io_disarm_next</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">io_req_task_queue</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">io_dismantle_req</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">io_put_task</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">inflight_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">locked_free_list</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">locked_free_nr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">percpu_ref_tryget</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">refs</span><span class="p">))</span>
			<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">io_commit_cqring</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">completion_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">io_cqring_ev_posted</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="n">percpu_ref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">refs</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>This method completes the current request and creates a new <code class="language-plaintext highlighter-rouge">cqe</code>. Afterwards it calls <code class="language-plaintext highlighter-rouge">io_disarm_next</code>:</p>
<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="n">bool</span> <span class="nf">io_disarm_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
	<span class="n">__must_hold</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">completion_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">posted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REQ_F_ARM_LTIMEOUT</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [1]</span>
		<span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">REQ_F_ARM_LTIMEOUT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link</span> <span class="o">&amp;&amp;</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">IORING_OP_LINK_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">io_remove_next_linked</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
			<span class="n">io_fill_cqe_req</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="o">-</span><span class="n">ECANCELED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">io_put_req_deferred</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
			<span class="n">posted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REQ_F_LINK_TIMEOUT</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [2]</span>
		<span class="k">struct</span> <span class="n">io_ring_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">;</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timeout_lock</span><span class="p">);</span>
		<span class="n">posted</span> <span class="o">=</span> <span class="n">io_kill_linked_timeout</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timeout_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REQ_F_FAIL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="o">!</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REQ_F_HARDLINK</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">posted</span> <span class="o">|=</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">io_fail_links</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">posted</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Taking the first path <code class="language-plaintext highlighter-rouge">[1]</code>, the request is checked for the <em>ready to be armed</em> flag. If it has the flag, the flag is removed, and the request is subsequently completed.
The second path <code class="language-plaintext highlighter-rouge">[2]</code>, on the other hand, checks whether the request has already been armed. In such a scenario, the linked request (<code class="language-plaintext highlighter-rouge">ltimeout</code>) is canceled accordingly.<br>
Looks good right?</p>

<p>Important to note here is that the chain of functions here are all called <em>directly</em> after each other, which is different compared to other cancel requests, i.e <code class="language-plaintext highlighter-rouge">IORING_OP_TIMEOUT_REMOVE</code>:</p>
<div file="io_uring.c" class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="io_uring.c"><i class="far fa-file-code fa-fw"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">io_timeout_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">issue_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">io_timeout_rem</span> <span class="o">*</span><span class="n">tr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">timeout_rem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">io_ring_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">timeout_rem</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORING_TIMEOUT_UPDATE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">completion_lock</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timeout_lock</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">io_timeout_cancel</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timeout_lock</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">completion_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="c1">// ...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div file="io_uring.c" class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="io_uring.c"><i class="far fa-file-code fa-fw"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">io_timeout_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_ring_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">__u64</span> <span class="n">user_data</span><span class="p">)</span>
	<span class="n">__must_hold</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">completion_lock</span><span class="p">)</span>
	<span class="n">__must_hold</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timeout_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">io_timeout_extract</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">user_data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="n">req_set_fail</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">io_fill_cqe_req</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">ECANCELED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">io_put_req_deferred</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Which calls <code class="language-plaintext highlighter-rouge">io_put_req_deferred</code>:</p>
<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">io_put_req_deferred</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req_ref_put_and_test</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">io_task_work</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">io_free_req_work</span><span class="p">;</span>
		<span class="n">io_req_task_work_add</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Which eventually also calls <code class="language-plaintext highlighter-rouge">io_disarm_next</code>, but its executed as <code class="language-plaintext highlighter-rouge">task_work</code>, which has <em>some</em> delay.</p>

<h2 id="linkedpoll"><span class="me-2">LinkedPoll</span><a href="https://qyn.app/posts/CVE-2023-3389/#linkedpoll" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Now, having gained some insight into the various operations let’s dive into what occurs when we introduce concurrency.<br>
Remember the <code class="language-plaintext highlighter-rouge">io_disarm_next</code>:</p>
<div file="io_uring.c" class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="io_uring.c"><i class="far fa-file-code fa-fw"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="n">bool</span> <span class="nf">io_disarm_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
	<span class="n">__must_hold</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">completion_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">posted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REQ_F_ARM_LTIMEOUT</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [1]</span>
		<span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">REQ_F_ARM_LTIMEOUT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link</span> <span class="o">&amp;&amp;</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">IORING_OP_LINK_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">io_remove_next_linked</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
			<span class="n">io_fill_cqe_req</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="o">-</span><span class="n">ECANCELED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">io_put_req_deferred</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
			<span class="n">posted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REQ_F_LINK_TIMEOUT</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [2]</span>
		<span class="k">struct</span> <span class="n">io_ring_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">;</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timeout_lock</span><span class="p">);</span>
		<span class="n">posted</span> <span class="o">=</span> <span class="n">io_kill_linked_timeout</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timeout_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REQ_F_FAIL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="o">!</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REQ_F_HARDLINK</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">posted</span> <span class="o">|=</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">io_fail_links</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">posted</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>and the <code class="language-plaintext highlighter-rouge">io_prep_linked_timeout</code>:</p>

<div file="io_uring.c" class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="io_uring.c"><i class="far fa-file-code fa-fw"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="nf">io_prep_linked_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REQ_F_ARM_LTIMEOUT</span><span class="p">)))</span> <span class="c1">// [3]</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__io_prep_linked_timeout</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="nf">__io_prep_linked_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">REQ_F_ARM_LTIMEOUT</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">REQ_F_LINK_TIMEOUT</span><span class="p">;</span>

	<span class="cm">/* linked timeouts should have two refs once prep'ed */</span>
	<span class="n">io_req_set_refcount</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">__io_req_set_refcount</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="c1">// [4]</span>
	<span class="k">return</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Now, what would happen when we could <em>somehow</em> arm a linked timeout while <em>canceling</em> it at the same time. In this case we would take the first path in the <code class="language-plaintext highlighter-rouge">io_disarm_next</code> function <code class="language-plaintext highlighter-rouge">[1]</code> (Not yet armed), and we would also pass the check in <code class="language-plaintext highlighter-rouge">io_prep_linked_timeout</code> (<code class="language-plaintext highlighter-rouge">[3]</code>), after which the <code class="language-plaintext highlighter-rouge">io_queue_linked_timeout</code> would actually start the timer. After this point, we would have a timer running while its <em>parent</em> request has already been completed.</p>
<pre class="unloaded"><code class="language-mermaid">%%{init: {'noteMargin':13}}%%
sequenceDiagram
    participant t1 as Thread 1 (io_disarm_next)
    participant t2 as Thread 2 (io_prep_linked_timeout)
    t1-&gt;t2: - 
    Note over t1: if (req-&gt;flags &amp; REQ_F_ARM_LTIMEOUT) {
    Note over t2: if (likely(!(req-&gt;flags &amp; REQ_F_ARM_LTIMEOUT)))
    Note over t1: req-&gt;flags &amp;= ~REQ_F_ARM_LTIMEOUT;
    Note over t2: req-&gt;flags &amp;= ~REQ_F_ARM_LTIMEOUT;
    Note over t2: req-&gt;flags |= REQ_F_LINK_TIMEOUT;
    Note over t2: io_queue_linked_timeout(timeout)

    Note over t1: io_remove_next_linked(req);

    Note over t1: ...
    Note over t2: ...

    t1-&gt;t2: -
</code></pre><pre class="mermaid" data-processed="true"><svg aria-roledescription="sequence" role="graphics-document document" viewBox="-100.5 -10 696 770" style="max-width: 696px;" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="mermaid-1693814797973"><g><rect class="actor" ry="3" rx="3" height="65" width="254" stroke="#666" fill="#eaeaea" y="684" x="245"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor" alignment-baseline="central" dominant-baseline="central" y="716.5" x="372"><tspan dy="0" x="372">Thread 2 (io_prep_linked_timeout)</tspan></text></g><g><rect class="actor" ry="3" rx="3" height="65" width="195" stroke="#666" fill="#eaeaea" y="684" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor" alignment-baseline="central" dominant-baseline="central" y="716.5" x="97.5"><tspan dy="0" x="97.5">Thread 1 (io_disarm_next)</tspan></text></g><g><line stroke="#999" stroke-width="0.5px" class="200" y2="684" x2="372" y1="5" x1="372" id="actor1"></line><g id="root-1"><rect class="actor" ry="3" rx="3" height="65" width="254" stroke="#666" fill="#eaeaea" y="0" x="245"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor" alignment-baseline="central" dominant-baseline="central" y="32.5" x="372"><tspan dy="0" x="372">Thread 2 (io_prep_linked_timeout)</tspan></text></g></g><g><line stroke="#999" stroke-width="0.5px" class="200" y2="684" x2="97.5" y1="5" x1="97.5" id="actor0"></line><g id="root-0"><rect class="actor" ry="3" rx="3" height="65" width="195" stroke="#666" fill="#eaeaea" y="0" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor" alignment-baseline="central" dominant-baseline="central" y="32.5" x="97.5"><tspan dy="0" x="97.5">Thread 1 (io_disarm_next)</tspan></text></g></g><style>#mermaid-1693814797973{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-1693814797973 .error-icon{fill:#552222;}#mermaid-1693814797973 .error-text{fill:#552222;stroke:#552222;}#mermaid-1693814797973 .edge-thickness-normal{stroke-width:2px;}#mermaid-1693814797973 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-1693814797973 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-1693814797973 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-1693814797973 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-1693814797973 .marker{fill:#333333;stroke:#333333;}#mermaid-1693814797973 .marker.cross{stroke:#333333;}#mermaid-1693814797973 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-1693814797973 .actor{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-1693814797973 text.actor&gt;tspan{fill:black;stroke:none;}#mermaid-1693814797973 .actor-line{stroke:grey;}#mermaid-1693814797973 .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaid-1693814797973 .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaid-1693814797973 #arrowhead path{fill:#333;stroke:#333;}#mermaid-1693814797973 .sequenceNumber{fill:white;}#mermaid-1693814797973 #sequencenumber{fill:#333;}#mermaid-1693814797973 #crosshead path{fill:#333;stroke:#333;}#mermaid-1693814797973 .messageText{fill:#333;stroke:none;}#mermaid-1693814797973 .labelBox{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-1693814797973 .labelText,#mermaid-1693814797973 .labelText&gt;tspan{fill:black;stroke:none;}#mermaid-1693814797973 .loopText,#mermaid-1693814797973 .loopText&gt;tspan{fill:black;stroke:none;}#mermaid-1693814797973 .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-1693814797973 .note{stroke:#aaaa33;fill:#fff5ad;}#mermaid-1693814797973 .noteText,#mermaid-1693814797973 .noteText&gt;tspan{fill:black;stroke:none;}#mermaid-1693814797973 .activation0{fill:#f4f4f4;stroke:#666;}#mermaid-1693814797973 .activation1{fill:#f4f4f4;stroke:#666;}#mermaid-1693814797973 .activation2{fill:#f4f4f4;stroke:#666;}#mermaid-1693814797973 .actorPopupMenu{position:absolute;}#mermaid-1693814797973 .actorPopupMenuPanel{position:absolute;fill:#ECECFF;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);filter:drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4));}#mermaid-1693814797973 .actor-man line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-1693814797973 .actor-man circle,#mermaid-1693814797973 line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;stroke-width:2px;}#mermaid-1693814797973 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g></g><defs><symbol height="24" width="24" id="computer"><path d="M2 2v13h20v-13h-20zm18 11h-16v-9h16v9zm-10.228 6l.466-1h3.524l.467 1h-4.457zm14.228 3h-24l2-6h2.104l-1.33 4h18.45l-1.297-4h2.073l2 6zm-5-10h-14v-7h14v7z" transform="scale(.5)"></path></symbol></defs><defs><symbol clip-rule="evenodd" fill-rule="evenodd" id="database"><path d="M12.258.001l.256.004.255.005.253.008.251.01.249.012.247.015.246.016.242.019.241.02.239.023.236.024.233.027.231.028.229.031.225.032.223.034.22.036.217.038.214.04.211.041.208.043.205.045.201.046.198.048.194.05.191.051.187.053.183.054.18.056.175.057.172.059.168.06.163.061.16.063.155.064.15.066.074.033.073.033.071.034.07.034.069.035.068.035.067.035.066.035.064.036.064.036.062.036.06.036.06.037.058.037.058.037.055.038.055.038.053.038.052.038.051.039.05.039.048.039.047.039.045.04.044.04.043.04.041.04.04.041.039.041.037.041.036.041.034.041.033.042.032.042.03.042.029.042.027.042.026.043.024.043.023.043.021.043.02.043.018.044.017.043.015.044.013.044.012.044.011.045.009.044.007.045.006.045.004.045.002.045.001.045v17l-.001.045-.002.045-.004.045-.006.045-.007.045-.009.044-.011.045-.012.044-.013.044-.015.044-.017.043-.018.044-.02.043-.021.043-.023.043-.024.043-.026.043-.027.042-.029.042-.03.042-.032.042-.033.042-.034.041-.036.041-.037.041-.039.041-.04.041-.041.04-.043.04-.044.04-.045.04-.047.039-.048.039-.05.039-.051.039-.052.038-.053.038-.055.038-.055.038-.058.037-.058.037-.06.037-.06.036-.062.036-.064.036-.064.036-.066.035-.067.035-.068.035-.069.035-.07.034-.071.034-.073.033-.074.033-.15.066-.155.064-.16.063-.163.061-.168.06-.172.059-.175.057-.18.056-.183.054-.187.053-.191.051-.194.05-.198.048-.201.046-.205.045-.208.043-.211.041-.214.04-.217.038-.22.036-.223.034-.225.032-.229.031-.231.028-.233.027-.236.024-.239.023-.241.02-.242.019-.246.016-.247.015-.249.012-.251.01-.253.008-.255.005-.256.004-.258.001-.258-.001-.256-.004-.255-.005-.253-.008-.251-.01-.249-.012-.247-.015-.245-.016-.243-.019-.241-.02-.238-.023-.236-.024-.234-.027-.231-.028-.228-.031-.226-.032-.223-.034-.22-.036-.217-.038-.214-.04-.211-.041-.208-.043-.204-.045-.201-.046-.198-.048-.195-.05-.19-.051-.187-.053-.184-.054-.179-.056-.176-.057-.172-.059-.167-.06-.164-.061-.159-.063-.155-.064-.151-.066-.074-.033-.072-.033-.072-.034-.07-.034-.069-.035-.068-.035-.067-.035-.066-.035-.064-.036-.063-.036-.062-.036-.061-.036-.06-.037-.058-.037-.057-.037-.056-.038-.055-.038-.053-.038-.052-.038-.051-.039-.049-.039-.049-.039-.046-.039-.046-.04-.044-.04-.043-.04-.041-.04-.04-.041-.039-.041-.037-.041-.036-.041-.034-.041-.033-.042-.032-.042-.03-.042-.029-.042-.027-.042-.026-.043-.024-.043-.023-.043-.021-.043-.02-.043-.018-.044-.017-.043-.015-.044-.013-.044-.012-.044-.011-.045-.009-.044-.007-.045-.006-.045-.004-.045-.002-.045-.001-.045v-17l.001-.045.002-.045.004-.045.006-.045.007-.045.009-.044.011-.045.012-.044.013-.044.015-.044.017-.043.018-.044.02-.043.021-.043.023-.043.024-.043.026-.043.027-.042.029-.042.03-.042.032-.042.033-.042.034-.041.036-.041.037-.041.039-.041.04-.041.041-.04.043-.04.044-.04.046-.04.046-.039.049-.039.049-.039.051-.039.052-.038.053-.038.055-.038.056-.038.057-.037.058-.037.06-.037.061-.036.062-.036.063-.036.064-.036.066-.035.067-.035.068-.035.069-.035.07-.034.072-.034.072-.033.074-.033.151-.066.155-.064.159-.063.164-.061.167-.06.172-.059.176-.057.179-.056.184-.054.187-.053.19-.051.195-.05.198-.048.201-.046.204-.045.208-.043.211-.041.214-.04.217-.038.22-.036.223-.034.226-.032.228-.031.231-.028.234-.027.236-.024.238-.023.241-.02.243-.019.245-.016.247-.015.249-.012.251-.01.253-.008.255-.005.256-.004.258-.001.258.001zm-9.258 20.499v.01l.001.021.003.021.004.022.005.021.006.022.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.023.018.024.019.024.021.024.022.025.023.024.024.025.052.049.056.05.061.051.066.051.07.051.075.051.079.052.084.052.088.052.092.052.097.052.102.051.105.052.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.048.144.049.147.047.152.047.155.047.16.045.163.045.167.043.171.043.176.041.178.041.183.039.187.039.19.037.194.035.197.035.202.033.204.031.209.03.212.029.216.027.219.025.222.024.226.021.23.02.233.018.236.016.24.015.243.012.246.01.249.008.253.005.256.004.259.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.021.224-.024.22-.026.216-.027.212-.028.21-.031.205-.031.202-.034.198-.034.194-.036.191-.037.187-.039.183-.04.179-.04.175-.042.172-.043.168-.044.163-.045.16-.046.155-.046.152-.047.148-.048.143-.049.139-.049.136-.05.131-.05.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.053.083-.051.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.05.023-.024.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.023.01-.022.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.127l-.077.055-.08.053-.083.054-.085.053-.087.052-.09.052-.093.051-.095.05-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.045-.118.044-.12.043-.122.042-.124.042-.126.041-.128.04-.13.04-.132.038-.134.038-.135.037-.138.037-.139.035-.142.035-.143.034-.144.033-.147.032-.148.031-.15.03-.151.03-.153.029-.154.027-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.01-.179.008-.179.008-.181.006-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.006-.179-.008-.179-.008-.178-.01-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.027-.153-.029-.151-.03-.15-.03-.148-.031-.146-.032-.145-.033-.143-.034-.141-.035-.14-.035-.137-.037-.136-.037-.134-.038-.132-.038-.13-.04-.128-.04-.126-.041-.124-.042-.122-.042-.12-.044-.117-.043-.116-.045-.113-.045-.112-.046-.109-.047-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.05-.093-.052-.09-.051-.087-.052-.085-.053-.083-.054-.08-.054-.077-.054v4.127zm0-5.654v.011l.001.021.003.021.004.021.005.022.006.022.007.022.009.022.01.022.011.023.012.023.013.023.015.024.016.023.017.024.018.024.019.024.021.024.022.024.023.025.024.024.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.052.11.051.114.051.119.052.123.05.127.051.131.05.135.049.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.044.171.042.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.022.23.02.233.018.236.016.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.012.241-.015.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.048.139-.05.136-.049.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.051.051-.049.023-.025.023-.024.021-.025.02-.024.019-.024.018-.024.017-.024.015-.023.014-.023.013-.024.012-.022.01-.023.01-.023.008-.022.006-.022.006-.022.004-.021.004-.022.001-.021.001-.021v-4.139l-.077.054-.08.054-.083.054-.085.052-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.044-.118.044-.12.044-.122.042-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.035-.143.033-.144.033-.147.033-.148.031-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.009-.179.009-.179.007-.181.007-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.007-.179-.007-.179-.009-.178-.009-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.031-.146-.033-.145-.033-.143-.033-.141-.035-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.04-.126-.041-.124-.042-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.051-.093-.051-.09-.051-.087-.053-.085-.052-.083-.054-.08-.054-.077-.054v4.139zm0-5.666v.011l.001.02.003.022.004.021.005.022.006.021.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.024.018.023.019.024.021.025.022.024.023.024.024.025.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.051.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.043.171.043.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.021.23.02.233.018.236.017.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.013.241-.014.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.049.139-.049.136-.049.131-.051.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.049.023-.025.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.022.01-.023.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.153l-.077.054-.08.054-.083.053-.085.053-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.048-.105.048-.106.048-.109.046-.111.046-.114.046-.115.044-.118.044-.12.043-.122.043-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.034-.143.034-.144.033-.147.032-.148.032-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.024-.161.024-.162.023-.163.023-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.01-.178.01-.179.009-.179.007-.181.006-.182.006-.182.004-.184.003-.184.001-.185.001-.185-.001-.184-.001-.184-.003-.182-.004-.182-.006-.181-.006-.179-.007-.179-.009-.178-.01-.176-.01-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.023-.162-.023-.161-.024-.159-.024-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.032-.146-.032-.145-.033-.143-.034-.141-.034-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.041-.126-.041-.124-.041-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.048-.105-.048-.102-.048-.1-.05-.097-.049-.095-.051-.093-.051-.09-.052-.087-.052-.085-.053-.083-.053-.08-.054-.077-.054v4.153zm8.74-8.179l-.257.004-.254.005-.25.008-.247.011-.244.012-.241.014-.237.016-.233.018-.231.021-.226.022-.224.023-.22.026-.216.027-.212.028-.21.031-.205.032-.202.033-.198.034-.194.036-.191.038-.187.038-.183.04-.179.041-.175.042-.172.043-.168.043-.163.045-.16.046-.155.046-.152.048-.148.048-.143.048-.139.049-.136.05-.131.05-.126.051-.123.051-.118.051-.114.052-.11.052-.106.052-.101.052-.096.052-.092.052-.088.052-.083.052-.079.052-.074.051-.07.052-.065.051-.06.05-.056.05-.051.05-.023.025-.023.024-.021.024-.02.025-.019.024-.018.024-.017.023-.015.024-.014.023-.013.023-.012.023-.01.023-.01.022-.008.022-.006.023-.006.021-.004.022-.004.021-.001.021-.001.021.001.021.001.021.004.021.004.022.006.021.006.023.008.022.01.022.01.023.012.023.013.023.014.023.015.024.017.023.018.024.019.024.02.025.021.024.023.024.023.025.051.05.056.05.06.05.065.051.07.052.074.051.079.052.083.052.088.052.092.052.096.052.101.052.106.052.11.052.114.052.118.051.123.051.126.051.131.05.136.05.139.049.143.048.148.048.152.048.155.046.16.046.163.045.168.043.172.043.175.042.179.041.183.04.187.038.191.038.194.036.198.034.202.033.205.032.21.031.212.028.216.027.22.026.224.023.226.022.231.021.233.018.237.016.241.014.244.012.247.011.25.008.254.005.257.004.26.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.022.224-.023.22-.026.216-.027.212-.028.21-.031.205-.032.202-.033.198-.034.194-.036.191-.038.187-.038.183-.04.179-.041.175-.042.172-.043.168-.043.163-.045.16-.046.155-.046.152-.048.148-.048.143-.048.139-.049.136-.05.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.05.051-.05.023-.025.023-.024.021-.024.02-.025.019-.024.018-.024.017-.023.015-.024.014-.023.013-.023.012-.023.01-.023.01-.022.008-.022.006-.023.006-.021.004-.022.004-.021.001-.021.001-.021-.001-.021-.001-.021-.004-.021-.004-.022-.006-.021-.006-.023-.008-.022-.01-.022-.01-.023-.012-.023-.013-.023-.014-.023-.015-.024-.017-.023-.018-.024-.019-.024-.02-.025-.021-.024-.023-.024-.023-.025-.051-.05-.056-.05-.06-.05-.065-.051-.07-.052-.074-.051-.079-.052-.083-.052-.088-.052-.092-.052-.096-.052-.101-.052-.106-.052-.11-.052-.114-.052-.118-.051-.123-.051-.126-.051-.131-.05-.136-.05-.139-.049-.143-.048-.148-.048-.152-.048-.155-.046-.16-.046-.163-.045-.168-.043-.172-.043-.175-.042-.179-.041-.183-.04-.187-.038-.191-.038-.194-.036-.198-.034-.202-.033-.205-.032-.21-.031-.212-.028-.216-.027-.22-.026-.224-.023-.226-.022-.231-.021-.233-.018-.237-.016-.241-.014-.244-.012-.247-.011-.25-.008-.254-.005-.257-.004-.26-.001-.26.001z" transform="scale(.5)"></path></symbol></defs><defs><symbol height="24" width="24" id="clock"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.848 12.459c.202.038.202.333.001.372-1.907.361-6.045 1.111-6.547 1.111-.719 0-1.301-.582-1.301-1.301 0-.512.77-5.447 1.125-7.445.034-.192.312-.181.343.014l.985 6.238 5.394 1.011z" transform="scale(.5)"></path></symbol></defs><defs><marker orient="auto" markerHeight="12" markerWidth="12" markerUnits="userSpaceOnUse" refY="5" refX="9" id="arrowhead"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker refY="5" refX="4" orient="auto" markerHeight="8" markerWidth="15" id="crosshead"><path style="stroke-dasharray: 0, 0;" d="M 1,2 L 6,7 M 6,2 L 1,7" stroke-width="1pt" stroke="#000000" fill="none"></path></marker></defs><defs><marker orient="auto" markerHeight="28" markerWidth="20" refY="7" refX="18" id="filled-head"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerHeight="40" markerWidth="60" refY="15" refX="15" id="sequencenumber"><circle r="6" cy="15" cx="15"></circle></marker></defs><g><rect class="note" ry="0" rx="0" height="45" width="296" stroke="#666" fill="#EDF2AE" y="127" x="-50.5"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="134" x="98"><tspan x="98">if (req-&gt;flags &amp; REQ_F_ARM_LTIMEOUT) {</tspan></text></g><g><rect class="note" ry="0" rx="0" height="45" width="347" stroke="#666" fill="#EDF2AE" y="182" x="198.5"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="189" x="372"><tspan x="372">if (likely(!(req-&gt;flags &amp; REQ_F_ARM_LTIMEOUT)))</tspan></text></g><g><rect class="note" ry="0" rx="0" height="45" width="283" stroke="#666" fill="#EDF2AE" y="237" x="-44"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="244" x="98"><tspan x="98">req-&gt;flags &amp;= ~REQ_F_ARM_LTIMEOUT</tspan></text></g><g><rect class="note" ry="0" rx="0" height="45" width="283" stroke="#666" fill="#EDF2AE" y="292" x="230.5"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="299" x="372"><tspan x="372">req-&gt;flags &amp;= ~REQ_F_ARM_LTIMEOUT</tspan></text></g><g><rect class="note" ry="0" rx="0" height="45" width="265" stroke="#666" fill="#EDF2AE" y="347" x="239.5"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="354" x="372"><tspan x="372">req-&gt;flags |= REQ_F_LINK_TIMEOUT</tspan></text></g><g><rect class="note" ry="0" rx="0" height="45" width="262" stroke="#666" fill="#EDF2AE" y="402" x="241"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="409" x="372"><tspan x="372">io_queue_linked_timeout(timeout)</tspan></text></g><g><rect class="note" ry="0" rx="0" height="45" width="215" stroke="#666" fill="#EDF2AE" y="457" x="-10"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="464" x="98"><tspan x="98">io_remove_next_linked(req)</tspan></text></g><g><rect class="note" ry="0" rx="0" height="45" width="195" stroke="#666" fill="#EDF2AE" y="512" x="0"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="519" x="98"><tspan x="98">...</tspan></text></g><g><rect class="note" ry="0" rx="0" height="45" width="254" stroke="#666" fill="#EDF2AE" y="567" x="245"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="574" x="372"><tspan x="372">...</tspan></text></g><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="80" x="235">-</text><line style="fill: none;" stroke="none" stroke-width="2" class="messageLine0" y2="117" x2="372" y1="117" x1="97.5"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="627" x="235">-</text><line style="fill: none;" stroke="none" stroke-width="2" class="messageLine0" y2="664" x2="372" y1="664" x1="97.5"></line></svg></pre>
<blockquote>
  <p>The linked timeout is still being queued despite its parent being disarmed.</p>
</blockquote>

<p>But, how do we actually cancel a linked timeout while simultaneously arming it?<br>
Introducing <code class="language-plaintext highlighter-rouge">IORING_OP_POLL_ADD</code> and <code class="language-plaintext highlighter-rouge">IORING_OP_POLL_REMOVE</code>. As seen before, using <code class="language-plaintext highlighter-rouge">IORING_OP_POLL_REMOVE</code> to cancel a <code class="language-plaintext highlighter-rouge">IORING_OP_POLL_ADD</code> request cancels the request <em>inline</em> (Doesn’t involve extra task work). This in combination with queueing the request via <code class="language-plaintext highlighter-rouge">__io_queue_sqe</code>, means that first the request is evaluated, then the <code class="language-plaintext highlighter-rouge">ltimeout</code> is armed, meaning that if we use a <em>well</em> timed cancel request (asynchronous), we could trigger the path described earlier.</p>

<blockquote class="prompt-info">
  <p>From now on, I’ll refer to our dangling linked timeout as <code class="language-plaintext highlighter-rouge">ltimeout</code></p>
</blockquote>

<p>However, let’s pause for a moment and take notice of the <code class="language-plaintext highlighter-rouge">io_remove_next_linked</code> function:</p>
<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="n">bool</span> <span class="nf">io_disarm_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
	<span class="n">__must_hold</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">completion_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">posted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REQ_F_ARM_LTIMEOUT</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [1]</span>
		<span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">REQ_F_ARM_LTIMEOUT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link</span> <span class="o">&amp;&amp;</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">IORING_OP_LINK_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">io_remove_next_linked</span><span class="p">(</span><span class="n">req</span><span class="p">);</span> <span class="c1">// [5]</span>
			<span class="c1">// ...</span>
		<span class="p">}</span> <span class="c1">// ...</span>
	<span class="p">}</span> <span class="c1">// ...</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">io_remove_next_linked</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">nxt</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="n">nxt</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
	<span class="n">nxt</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="nf">__io_prep_linked_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">REQ_F_ARM_LTIMEOUT</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">REQ_F_LINK_TIMEOUT</span><span class="p">;</span>

	<span class="cm">/* linked timeouts should have two refs once prep'ed */</span>
	<span class="n">io_req_set_refcount</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">__io_req_set_refcount</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="c1">// [4]</span>
	<span class="k">return</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>In this context <code class="language-plaintext highlighter-rouge">req-&gt;link</code> is our <code class="language-plaintext highlighter-rouge">ltimeout</code>, and so it sets <code class="language-plaintext highlighter-rouge">req-&gt;link = ltimeout-&gt;link</code>, which effectively removes the reference to <code class="language-plaintext highlighter-rouge">ltimeout</code>. Meaning that <code class="language-plaintext highlighter-rouge">io_prep_linked_timeout</code> could return <code class="language-plaintext highlighter-rouge">ltimeout-&gt;link</code> if we’re unlucky, which is fine because we can ensure its <code class="language-plaintext highlighter-rouge">NULL</code>, but <code class="language-plaintext highlighter-rouge">__io_req_set_refcount(req-&gt;link, 2);</code> (<code class="language-plaintext highlighter-rouge">[4]</code>) is a problem because it almost surely does a <code class="language-plaintext highlighter-rouge">NULL</code> pointer dereference. Lets analyse this further and look at how this is all implemented in assembly:</p>

<p><code class="language-plaintext highlighter-rouge">io_disarm_next</code>:</p>
<div file="io_uring.o" class="language-nasm highlighter-rouge"><div class="code-header">
        <span data-label-text="io_uring.o"><i class="far fa-file-code fa-fw"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="err">00008</span><span class="nl">e01:</span>  <span class="nf">test</span>    <span class="nb">eax</span><span class="p">,</span> <span class="mh">0x100000</span>
<span class="err">00008</span><span class="nl">e06:</span>  <span class="nf">je</span>      <span class="mh">0x8e4b</span>

<span class="err">00008</span><span class="nl">e08:</span>  <span class="nf">mov</span>     <span class="nb">edx</span><span class="p">,</span> <span class="nb">eax</span>
<span class="err">00008</span><span class="nl">e0a:</span>  <span class="nf">mov</span>     <span class="nb">rbp</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nb">rdi</span><span class="o">+</span><span class="mh">0x70</span><span class="p">]</span>
<span class="err">00008</span><span class="nl">e0e:</span>  <span class="nf">and</span>     <span class="nb">edx</span><span class="p">,</span> <span class="mh">0xffefffff</span>        <span class="c1">; [1]</span>
<span class="err">00008</span><span class="nl">e14:</span>  <span class="nf">mov</span>     <span class="kt">dword</span> <span class="p">[</span><span class="nb">rdi</span><span class="o">+</span><span class="mh">0x58</span><span class="p">],</span> <span class="nb">edx</span>
<span class="err">00008</span><span class="nl">e17:</span>  <span class="nf">test</span>    <span class="nb">rbp</span><span class="p">,</span> <span class="nb">rbp</span>
<span class="err">00008</span><span class="nl">e1a:</span>  <span class="nf">je</span>      <span class="mh">0x8edc</span>

<span class="err">00008</span><span class="nl">e20:</span>  <span class="nf">cmp</span>     <span class="kt">byte</span> <span class="p">[</span><span class="nb">rbp</span><span class="o">+</span><span class="mh">0x48</span><span class="p">],</span> <span class="mh">0xf</span>
<span class="err">00008</span><span class="nl">e24:</span>  <span class="nf">je</span>      <span class="mh">0x8f7b</span>
<span class="nf">...</span>
<span class="err">00008</span><span class="nl">f7b:</span>  <span class="nf">mov</span>     <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nb">rbp</span><span class="o">+</span><span class="mh">0x70</span><span class="p">]</span>
<span class="err">00008</span><span class="nl">f7f:</span>  <span class="nf">mov</span>     <span class="nb">edx</span><span class="p">,</span> <span class="mh">0xffffff83</span>
<span class="err">00008</span><span class="nl">f84:</span>  <span class="nf">mov</span>     <span class="kt">qword</span> <span class="p">[</span><span class="nb">rdi</span><span class="o">+</span><span class="mh">0x70</span><span class="p">],</span> <span class="nb">rax</span>  <span class="c1">; [2]</span>
<span class="err">00008</span><span class="nl">f88:</span>  <span class="nf">mov</span>     <span class="nb">rsi</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nb">rbp</span><span class="o">+</span><span class="mh">0x68</span><span class="p">]</span>
<span class="err">00008</span><span class="nl">f8c:</span>  <span class="nf">mov</span>     <span class="kt">qword</span> <span class="p">[</span><span class="nb">rbp</span><span class="o">+</span><span class="mh">0x70</span><span class="p">],</span> <span class="mh">0x0</span>
</pre></td></tr></tbody></table></code></div></div>
<p>So it takes 8 instructions to set <code class="language-plaintext highlighter-rouge">req-&gt;link = ltimeout-&gt;link</code>.</p>

<p><code class="language-plaintext highlighter-rouge">__io_queue_sqe</code> -&gt; <code class="language-plaintext highlighter-rouge">__io_prep_linked_timeout</code>:</p>
<div file="io_uring.o" class="language-nasm highlighter-rouge"><div class="code-header">
        <span data-label-text="io_uring.o"><i class="far fa-file-code fa-fw"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="rouge-code"><pre><span class="err">00010279:</span>  <span class="nf">test</span>    <span class="nb">eax</span><span class="p">,</span> <span class="mh">0x100000</span>          <span class="c1">; [3]</span>
<span class="err">0001027</span><span class="nl">e:</span>  <span class="nf">je</span>      <span class="mh">0x1024d</span>

<span class="err">00010280:</span>  <span class="nf">mov</span>     <span class="nb">rdi</span><span class="p">,</span> <span class="nv">r12</span>
<span class="err">00010283:</span>  <span class="nf">call</span>    <span class="nv">__io_prep_linked_timeout</span>

<span class="nl">__io_prep_linked_timeout:</span>
<span class="err">00001</span><span class="nl">af0:</span>  <span class="nf">call</span>    <span class="nv">__fentry__</span>
<span class="err">00001</span><span class="nl">af5:</span>  <span class="nf">mov</span>     <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nb">rdi</span><span class="o">+</span><span class="mh">0x70</span><span class="p">]</span>  <span class="c1">; [4]</span>
<span class="err">00001</span><span class="nl">af9:</span>  <span class="nf">test</span>    <span class="nb">rax</span><span class="p">,</span> <span class="nb">rax</span>               <span class="c1">; if (WARN_ON_ONCE(!req-&gt;link))</span>
<span class="err">00001</span><span class="nl">afc:</span>  <span class="nf">je</span>      <span class="mh">0x1b4d</span>                 <span class="c1">;     return NULL;</span>

<span class="err">00001</span><span class="nl">afe:</span>  <span class="nf">mov</span>     <span class="nb">ecx</span><span class="p">,</span> <span class="kt">dword</span> <span class="p">[</span><span class="nb">rdi</span><span class="o">+</span><span class="mh">0x58</span><span class="p">]</span>
<span class="err">00001</span><span class="nl">b01:</span>  <span class="nf">mov</span>     <span class="nb">edx</span><span class="p">,</span> <span class="nb">ecx</span>
<span class="err">00001</span><span class="nl">b03:</span>  <span class="nf">and</span>     <span class="nb">edx</span><span class="p">,</span> <span class="mh">0xffefffff</span>        <span class="c1">; req-&gt;flags &amp;= ~REQ_F_ARM_LTIMEOUT;</span>
<span class="err">00001</span><span class="nl">b09:</span>  <span class="nf">and</span>     <span class="nb">ecx</span><span class="p">,</span> <span class="mh">0x80000</span>           <span class="c1">; req-&gt;flags |= REQ_F_LINK_TIMEOUT;</span>
<span class="err">00001</span><span class="nl">b0f:</span>  <span class="nf">je</span>      <span class="mh">0x1b3b</span>                 <span class="c1">; io_req_set_refcount(req);</span>

<span class="err">00001</span><span class="nl">b11:</span>  <span class="nf">or</span>      <span class="nb">dh</span><span class="p">,</span> <span class="mh">0x10</span>
<span class="err">00001</span><span class="nl">b14:</span>  <span class="nf">mov</span>     <span class="kt">dword</span> <span class="p">[</span><span class="nb">rdi</span><span class="o">+</span><span class="mh">0x58</span><span class="p">],</span> <span class="nb">edx</span>

<span class="err">00001</span><span class="nl">b17:</span>  <span class="nf">mov</span>     <span class="nb">edx</span><span class="p">,</span> <span class="kt">dword</span> <span class="p">[</span><span class="nb">rax</span><span class="o">+</span><span class="mh">0x58</span><span class="p">]</span>
<span class="err">00001</span><span class="nl">b1a:</span>  <span class="nf">test</span>    <span class="nb">edx</span><span class="p">,</span> <span class="mh">0x80000</span>
<span class="err">00001</span><span class="nl">b20:</span>  <span class="nf">jne</span>     <span class="mh">0x1b36</span>

<span class="err">00001</span><span class="nl">b22:</span>  <span class="nf">or</span>      <span class="nb">edx</span><span class="p">,</span> <span class="mh">0x80000</span>
<span class="err">00001</span><span class="nl">b28:</span>  <span class="nf">mov</span>     <span class="kt">dword</span> <span class="p">[</span><span class="nb">rax</span><span class="o">+</span><span class="mh">0x5c</span><span class="p">],</span> <span class="mh">0x2</span>  <span class="c1">; __io_req_set_refcount(req-&gt;link, 2);</span>
<span class="err">00001</span><span class="nl">b2f:</span>  <span class="nf">mov</span>     <span class="kt">dword</span> <span class="p">[</span><span class="nb">rax</span><span class="o">+</span><span class="mh">0x58</span><span class="p">],</span> <span class="nb">edx</span>  <span class="c1">; req-&gt;flags |= REQ_F_REFCOUNT;</span>
<span class="err">00001</span><span class="nl">b32:</span>  <span class="nf">mov</span>     <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nb">rdi</span><span class="o">+</span><span class="mh">0x70</span><span class="p">]</span>  <span class="c1">; return req-&gt;link;</span>

<span class="err">00001</span><span class="nl">b36:</span>  <span class="nf">jmp</span>     <span class="nv">__x86_return_thunk</span>

<span class="nl">__fentry__:</span>
<span class="err">#</span><span class="nf">ifdef</span> <span class="nv">CONFIG_DYNAMIC_FTRACE</span>

<span class="nf">SYM_FUNC_START</span><span class="p">(</span><span class="nv">__fentry__</span><span class="p">)</span>
	<span class="nf">RET</span>
<span class="nf">SYM_FUNC_END</span><span class="p">(</span><span class="nv">__fentry__</span><span class="p">)</span>
<span class="k">EXPORT</span><span class="nv">_SYMBOL</span><span class="p">(</span><span class="nv">__fentry__</span><span class="p">)</span>
<span class="c1">; ...</span>
<span class="err">#</span><span class="nf">endif</span>
</pre></td></tr></tbody></table></code></div></div>

<blockquote class="prompt-info">
  <p>In the .config we’re given <code class="language-plaintext highlighter-rouge">CONFIG_DYNAMIC_FTRACE=y</code> is set so <code class="language-plaintext highlighter-rouge">__fentry__</code> is only <code class="language-plaintext highlighter-rouge">RET</code></p>
</blockquote>

<p>This means we’re lucky! It reuses / optimized <code class="language-plaintext highlighter-rouge">rax</code> from the beginning of the function when checking for <code class="language-plaintext highlighter-rouge">req-&gt;link = NULL</code> to calling <code class="language-plaintext highlighter-rouge">__io_req_set_refcount(req-&gt;link, 2);</code> and thus the race window becomes a bit more favourable.<br>
Let’s assume <em>worst</em> case scenario and assume that the test at <code class="language-plaintext highlighter-rouge">__io_queue_sqe</code> (<code class="language-plaintext highlighter-rouge">[3]</code>) is done at the same time as removing the flag in <code class="language-plaintext highlighter-rouge">io_disarm_next</code> (<code class="language-plaintext highlighter-rouge">[1]</code>). For <code class="language-plaintext highlighter-rouge">io_disarm_next</code> there are <code class="language-plaintext highlighter-rouge">8</code> instructions before it sets <code class="language-plaintext highlighter-rouge">req-&gt;link = ltimeout-&gt;link</code>, while there are only <code class="language-plaintext highlighter-rouge">6</code> instructions to reach setting <code class="language-plaintext highlighter-rouge">rax = req-&gt;link</code> (<code class="language-plaintext highlighter-rouge">[4]</code>) (But lets hope our CPU does some optimizations regarding the <code class="language-plaintext highlighter-rouge">call __fentry__</code>).<br>
While we can’t just assume that this will be fine, because <code class="language-plaintext highlighter-rouge">6 &lt; 8</code> (due to instruction clock cycles and CPU optimizations). In practice, I have never actually been able to trigger <code class="language-plaintext highlighter-rouge">req-&gt;link = ltimeout-&gt;link</code> before setting <code class="language-plaintext highlighter-rouge">rax = req-&gt;link</code>.</p>

<h2 id="exploitation"><span class="me-2">Exploitation</span><a href="https://qyn.app/posts/CVE-2023-3389/#exploitation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="triggered"><span class="me-2">Triggered?</span><a href="https://qyn.app/posts/CVE-2023-3389/#triggered" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Now knowing how to successfully trigger the bug, the challenge now lies in identifying whether the bug has actually been triggered. This is crucial, because the race window is extremely tight, and it often (Depending on CPU) requires numerous attempts to trigger the bug. Moreover, repeatedly <em>redoing</em> the entire exploitation phase, including heap <em>feng shui</em> and other steps, for each try can be extremely time-consuming.</p>

<p>So does our free’d linked timeout leave some dirt behind?<br>
Let’s look a bit closer at the <code class="language-plaintext highlighter-rouge">IORING_OP_LINK_TIMEOUT</code> from the previous section. We’ve seen that the <code class="language-plaintext highlighter-rouge">ltimeout</code> is added to the <code class="language-plaintext highlighter-rouge">ctx-&gt;ltimeout_list</code>, however, its not actually removed from the list (Because according to <code class="language-plaintext highlighter-rouge">io_disarm_next</code> it was not yet armed). So this is a way for us to figure out if we’ve triggered it.<br>
In short, there is still a reference to the linked timeout in the <code class="language-plaintext highlighter-rouge">ctx-&gt;ltimeout_list</code>, meaning that we could execute a <code class="language-plaintext highlighter-rouge">IORING_OP_TIMEOUT_REMOVE</code> with <code class="language-plaintext highlighter-rouge">LINKED_TIMEOUT</code> flag, which would cancel our <em>free’d</em> ltimeout.<br>
But this is not actually what we want, we want to keep our <code class="language-plaintext highlighter-rouge">ltimeout</code> alive. Thankfully, <code class="language-plaintext highlighter-rouge">io_uring</code> reuses <em>free’d</em> requests and adds them to a <code class="language-plaintext highlighter-rouge">locked_free_list</code> once they are completed as seen in <code class="language-plaintext highlighter-rouge">io_req_complete_post</code>;</p>

<p>Which is later flushed when calling <code class="language-plaintext highlighter-rouge">io_alloc_req</code>, this in turn calls <code class="language-plaintext highlighter-rouge">io_flush_cached_reqs</code> and it finally calls <code class="language-plaintext highlighter-rouge">io_flush_cached_locked_reqs</code> and joins the <code class="language-plaintext highlighter-rouge">ctx-&gt;locked_free_list</code> and the <code class="language-plaintext highlighter-rouge">ctx-&gt;submit_state.free_list</code>:</p>

<div file="io_uring.c" class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="io_uring.c"><i class="far fa-file-code fa-fw"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="rouge-code"><pre><span class="cm">/*
 * A request might get retired back into the request caches even before opcode
 * handlers and io_issue_sqe() are done with it, e.g. inline completion path.
 * Because of that, io_alloc_req() should be called only under -&gt;uring_lock
 * and with extra caution to not get a request that is still worked on.
 */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="nf">io_alloc_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_ring_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
	<span class="n">__must_hold</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">uring_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">// ...</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reqs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">IO_REQ_ALLOC_BATCH</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">free_reqs</span> <span class="o">||</span> <span class="n">io_flush_cached_reqs</span><span class="p">(</span><span class="n">ctx</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">got_req</span><span class="p">;</span>

	<span class="c1">// ...</span>
<span class="nl">got_req:</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">free_reqs</span><span class="o">--</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">reqs</span><span class="p">[</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">free_reqs</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/* Returns true IFF there are requests in the cache */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">io_flush_cached_reqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_ring_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">io_submit_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">submit_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr</span><span class="p">;</span>

	<span class="cm">/*
	 * If we have more than a batch's worth of requests in our IRQ side
	 * locked cache, grab the lock and move them over to our submission
	 * side cache.
	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">READ_ONCE</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">locked_free_nr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">IO_COMPL_BATCH</span><span class="p">)</span> <span class="c1">// IO_COMPL_BATCH == 32</span>
		<span class="n">io_flush_cached_locked_reqs</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

	<span class="n">nr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">free_reqs</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">io_kiocb</span><span class="p">,</span> <span class="n">inflight_entry</span><span class="p">);</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">inflight_entry</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">reqs</span><span class="p">[</span><span class="n">nr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">reqs</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">free_reqs</span> <span class="o">=</span> <span class="n">nr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">i</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">io_flush_cached_locked_reqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_ring_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">io_submit_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">completion_lock</span><span class="p">);</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">locked_free_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">locked_free_nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">completion_lock</span><span class="p">);</span>
<span class="p">}</span>


</pre></td></tr></tbody></table></code></div></div>

<p>So our <code class="language-plaintext highlighter-rouge">ltimeout</code> is in the <code class="language-plaintext highlighter-rouge">ctx-&gt;locked_free_list</code> when its being free’d, to figure out whether the bug has been triggered we can spray a ton of <code class="language-plaintext highlighter-rouge">IORING_OP_TIMEOUT</code> requests and reclaim the <code class="language-plaintext highlighter-rouge">ltimeout</code> in the  <code class="language-plaintext highlighter-rouge">ctx-&gt;ltimeout_list</code> as a <code class="language-plaintext highlighter-rouge">IORING_OP_TIMEOUT</code>, then we can add a single <code class="language-plaintext highlighter-rouge">IORING_OP_TIMEOUT_REMOVE</code> with the <code class="language-plaintext highlighter-rouge">LINKED_TIMEOUT</code> flag.</p>
<blockquote class="prompt-info">
  <p>Here I stumbled on a small difference, I initially compiled the kernel with <code class="language-plaintext highlighter-rouge">gcc</code>, while the actual kernel was compiled with <code class="language-plaintext highlighter-rouge">clang</code> and with the <code class="language-plaintext highlighter-rouge">gcc</code> version, it was enough to only spray 64 objects, while for the <em>actual</em> version it took way more.</p>
</blockquote>
<p>Then when the remove request is being executed it will try to find the <code class="language-plaintext highlighter-rouge">ltimeout</code> in the <code class="language-plaintext highlighter-rouge">ctx-&gt;ltimeout_list</code> list (At this time its actually just a regular timeout) and if it succeeds, meaning we’ve triggered the UAF, it will just update the regular timeout.<br>
Thankfully the update functions for the two different timeout operations are very similar and can be called interchangeably as seen before.</p>

<h3 id="replacing-the-ltimeout"><span class="me-2"><em>Replacing the ltimeout</em></span><a href="https://qyn.app/posts/CVE-2023-3389/#replacing-the-ltimeout" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>I hoped to exploit the bug in similar fashion to <a href="https://ruia-ruia.github.io/2022/08/05/CVE-2022-29582-io-uring">CVE-2022-29582</a>, sadly it took me a <em>very long</em> time to figure out the following:</p>
<div file="mm/slub.c" class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="mm/slub.c"><i class="far fa-file-code fa-fw"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">calculate_sizes</span><span class="p">(</span><span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">forced_order</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">//...</span>
	<span class="cm">/*
	* Store freelist pointer near middle of object to keep
	* it away from the edges of the object to avoid small
	* sized over/underflows from neighboring allocations.
	*/</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">ALIGN_DOWN</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">object_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
	<span class="c1">//...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>pahole io_timeout_data ./vmlinux <span class="nt">-E</span> 2&gt; /dev/null
</pre></td></tr></tbody></table></code></div></div>
<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">io_timeout_data</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">io_kiocb</span> <span class="o">*</span>          <span class="n">req</span><span class="p">;</span>                                                  <span class="cm">/*     0     8 */</span>
        <span class="k">struct</span> <span class="n">hrtimer</span> <span class="p">{</span>
                <span class="k">struct</span> <span class="n">timerqueue_node</span> <span class="p">{</span>
                        <span class="k">struct</span> <span class="n">rb_node</span> <span class="p">{</span>
                                <span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__rb_parent_color</span><span class="p">;</span>                     <span class="cm">/*     8     8 */</span>
                                <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span> <span class="n">rb_right</span><span class="p">;</span>                               <span class="cm">/*    16     8 */</span>
                                <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span> <span class="n">rb_left</span><span class="p">;</span>                                <span class="cm">/*    24     8 */</span>
                        <span class="p">}</span> <span class="n">node</span><span class="p">;</span> <span class="cm">/*     8    24 */</span>
                        <span class="cm">/* typedef ktime_t -&gt; s64 -&gt; __s64 */</span> <span class="kt">long</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">expires</span><span class="p">;</span>     <span class="cm">/*    32     8 */</span>
                <span class="p">}</span> <span class="n">node</span><span class="p">;</span> <span class="cm">/*     8    32 */</span>
                <span class="cm">/* typedef ktime_t -&gt; s64 -&gt; __s64 */</span> <span class="kt">long</span> <span class="kt">long</span> <span class="kt">int</span>      <span class="n">_softexpires</span><span class="p">;</span>   <span class="cm">/*    40     8 */</span>
                <span class="k">enum</span> <span class="n">hrtimer_restart</span> <span class="p">(</span><span class="o">*</span><span class="n">function</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hrtimer</span> <span class="o">*</span><span class="p">);</span>                      <span class="cm">/*    48     8 */</span>
                <span class="k">struct</span> <span class="n">hrtimer_clock_base</span> <span class="o">*</span> <span class="n">base</span><span class="p">;</span>                                        <span class="cm">/*    56     8 */</span>
                <span class="cm">/* --- cacheline 1 boundary (64 bytes) --- */</span>
                <span class="cm">/* typedef u8 -&gt; __u8 */</span> <span class="kt">unsigned</span> <span class="kt">char</span>      <span class="n">state</span><span class="p">;</span>                       <span class="cm">/*    64     1 */</span>
                <span class="cm">/* typedef u8 -&gt; __u8 */</span> <span class="kt">unsigned</span> <span class="kt">char</span>      <span class="n">is_rel</span><span class="p">;</span>                      <span class="cm">/*    65     1 */</span>
                <span class="cm">/* typedef u8 -&gt; __u8 */</span> <span class="kt">unsigned</span> <span class="kt">char</span>      <span class="n">is_soft</span><span class="p">;</span>                     <span class="cm">/*    66     1 */</span>
                <span class="cm">/* typedef u8 -&gt; __u8 */</span> <span class="kt">unsigned</span> <span class="kt">char</span>      <span class="n">is_hard</span><span class="p">;</span>                     <span class="cm">/*    67     1 */</span>
        <span class="p">}</span> <span class="n">timer</span><span class="p">;</span> <span class="cm">/*     8    64 */</span>

        <span class="cm">/* XXX last struct has 4 bytes of padding */</span>

        <span class="k">struct</span> <span class="n">timespec64</span> <span class="p">{</span>
                <span class="cm">/* typedef time64_t -&gt; __s64 */</span> <span class="kt">long</span> <span class="kt">long</span> <span class="kt">int</span>      <span class="n">tv_sec</span><span class="p">;</span>               <span class="cm">/*    72     8 */</span>
                <span class="kt">long</span> <span class="kt">int</span>           <span class="n">tv_nsec</span><span class="p">;</span>                                              <span class="cm">/*    80     8 */</span>
        <span class="p">}</span> <span class="n">ts</span><span class="p">;</span> <span class="cm">/*    72    16 */</span>
        <span class="k">enum</span> <span class="n">hrtimer_mode</span>          <span class="n">mode</span><span class="p">;</span>                                                 <span class="cm">/*    88     4 */</span>
        <span class="cm">/* typedef u32 -&gt; __u32 */</span> <span class="kt">unsigned</span> <span class="kt">int</span>               <span class="n">flags</span><span class="p">;</span>                     <span class="cm">/*    92     4 */</span>

        <span class="cm">/* size: 96, cachelines: 2, members: 5 */</span>
        <span class="cm">/* paddings: 1, sum paddings: 4 */</span>
        <span class="cm">/* last cacheline: 32 bytes */</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>
<p>So after <code class="language-plaintext highlighter-rouge">kfree</code> is called on our <code class="language-plaintext highlighter-rouge">io_timeout_data</code> object, the <code class="language-plaintext highlighter-rouge">freelist</code> pointer is placed at the <strong>exact</strong> same offset (<code class="language-plaintext highlighter-rouge">96/2 = 48</code>) as the <code class="language-plaintext highlighter-rouge">hrtimer_restart</code> pointer, therefore there is no way to trigger the <code class="language-plaintext highlighter-rouge">io_link_timeout_fn</code>.</p>

<h3 id="kaslr"><span class="me-2">kASLR</span><a href="https://qyn.app/posts/CVE-2023-3389/#kaslr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>With the above idea failing, a new idea is to control the heap such that the previously free’d <code class="language-plaintext highlighter-rouge">request-&gt;async_data</code> lies under our control. The goal is to control almost a full <code class="language-plaintext highlighter-rouge">kmalloc-96</code> object because the <code class="language-plaintext highlighter-rouge">rbtree</code> properties lie in the first few bytes of the object. Secondly, we’d need a kASLR leak to find a function to call.</p>

<p>Thankfully, theres no need to overcomplicate things, because there exists a full kaslr leak up till ~v6.2, <a href="https://www.willsroot.io/2022/12/entrybleed.html">called entrybleed, more details here</a>. Now, when the timer is succesfully reallocated, its possible to call <em>anything</em> once, where the first parameter is a reference to the timer itself, and the initial bytes are beyond our control (Due to timer constraints). Sadly, I could not find any gadgets that could simply call a full ROP chain.</p>

<!-- ### A blessing in disguise
While writing the writeup I figured out another way to get a `kASLR` base, TODO `io_async_connect` ETA: 2d -->

<h3 id="dirty-file"><span class="me-2"><em>Dirty</em> File</span><a href="https://qyn.app/posts/CVE-2023-3389/#dirty-file" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Before going further lets take a look at how our arbitrary function is actually called:</p>
<div file="kernel/time/hrtimer.c" class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="kernel/time/hrtimer.c"><i class="far fa-file-code fa-fw"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">__run_hrtimer</span><span class="p">(</span><span class="k">struct</span> <span class="n">hrtimer_cpu_base</span> <span class="o">*</span><span class="n">cpu_base</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">hrtimer_clock_base</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">hrtimer</span> <span class="o">*</span><span class="n">timer</span><span class="p">,</span> <span class="n">ktime_t</span> <span class="o">*</span><span class="n">now</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span> <span class="n">__must_hold</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_base</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">//...</span>
	<span class="n">__remove_hrtimer</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">HRTIMER_STATE_INACTIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">fn</span> <span class="o">=</span> <span class="n">timer</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">;</span>
	<span class="c1">//...</span>

	<span class="n">restart</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">timer</span><span class="p">);</span>

	<span class="c1">//...</span>

	<span class="cm">/*
	 * Note: We clear the running state after enqueue_hrtimer and
	 * we do not reprogram the event hardware. Happens either in
	 * hrtimer_start_range_ns() or in hrtimer_interrupt()
	 *
	 * Note: Because we dropped the cpu_base-&gt;lock above,
	 * hrtimer_start_range_ns() can have popped in and enqueued the timer
	 * for us already.
	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">restart</span> <span class="o">!=</span> <span class="n">HRTIMER_NORESTART</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">HRTIMER_STATE_ENQUEUED</span><span class="p">))</span>
		<span class="n">enqueue_hrtimer</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">HRTIMER_MODE_ABS</span><span class="p">);</span>

	<span class="c1">//...</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__remove_hrtimer</span><span class="p">(</span><span class="k">struct</span> <span class="n">hrtimer</span> <span class="o">*</span><span class="n">timer</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">hrtimer_clock_base</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="n">newstate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reprogram</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">// ...</span>
	<span class="n">WRITE_ONCE</span><span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">newstate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">HRTIMER_STATE_ENQUEUED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timerqueue_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">))</span>
		<span class="n">cpu_base</span><span class="o">-&gt;</span><span class="n">active_bases</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="c1">// ...</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>
<p>The <code class="language-plaintext highlighter-rouge">__run_hrtimer</code> function first makes sure to remove our timer from the <code class="language-plaintext highlighter-rouge">rbtree</code> by calling <code class="language-plaintext highlighter-rouge">__remove_hrtimer</code>, which makes sure the <code class="language-plaintext highlighter-rouge">HRTIMER_STATE_ENQUEUED</code> flag is set and will <em>gracefully</em> remove the timer and overwrite the <code class="language-plaintext highlighter-rouge">timer-&gt;state</code> with <code class="language-plaintext highlighter-rouge">HRTIMER_STATE_INACTIVE</code>. It is essential to remove the timer to avoid calling the same function infinitely many times, which is <em>very bad</em>, so we need to set the <code class="language-plaintext highlighter-rouge">HRTIMER_STATE_ENQUEUED</code> state.</p>

<p>Then <code class="language-plaintext highlighter-rouge">__run_hrtimer</code> calls our function and only if it returned <code class="language-plaintext highlighter-rouge">HRTIMER_NORESTART</code> (<code class="language-plaintext highlighter-rouge">0x00</code>) and our state does not have the <code class="language-plaintext highlighter-rouge">HRTIMER_STATE_ENQUEUED</code> flag set (it was just overwritten), it doesn’t enqueue the timer again.<br>
So in summary besides our single function call, our function needs to return <code class="language-plaintext highlighter-rouge">0x00</code>. The way to exploit this is to install a fake file object and control it.<br>
To do this we want to call <code class="language-plaintext highlighter-rouge">fd_install</code>:</p>
<div file="fs/file.c" class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="fs/file.c"><i class="far fa-file-code fa-fw"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="cm">/*
 * Install a file pointer in the fd array.
 *
 * The VFS is full of places where we drop the files lock between
 * setting the open_fds bitmap and installing the file in the file
 * array.  At any such point, we are vulnerable to a dup2() race
 * installing a file in the array before us.  We need to detect this and
 * fput() the struct file we are about to overwrite in this case.
 *
 * It should never happen - if we allow dup2() do it, _really_ bad things
 * will follow.
 *
 * This consumes the "file" refcount, so callers should treat it
 * as if they had called fput(file).
 */</span>

<span class="kt">void</span> <span class="n">fd_install</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>And in our case we call <code class="language-plaintext highlighter-rouge">receive_fd</code>:</p>

<div file="fs/file.c" class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="fs/file.c"><i class="far fa-file-code fa-fw"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">receive_fd</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">o_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__receive_fd</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">o_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**
 * __receive_fd() - Install received file into file descriptor table
 * @file: struct file that was received from another process
 * @ufd: __user pointer to write new fd number to
 * @o_flags: the O_* flags to apply to the new fd entry
 *
 * Installs a received file into the file descriptor table, with appropriate
 * checks and count updates. Optionally writes the fd number to userspace, if
 * @ufd is non-NULL.
 *
 * This helper handles its own reference counting of the incoming
 * struct file.
 *
 * Returns newly install fd or -ve on error.
 */</span>
<span class="kt">int</span> <span class="nf">__receive_fd</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ufd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">o_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new_fd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">security_file_receive</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">new_fd</span> <span class="o">=</span> <span class="n">get_unused_fd_flags</span><span class="p">(</span><span class="n">o_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">new_fd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ufd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">new_fd</span><span class="p">,</span> <span class="n">ufd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">put_unused_fd</span><span class="p">(</span><span class="n">new_fd</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">fd_install</span><span class="p">(</span><span class="n">new_fd</span><span class="p">,</span> <span class="n">get_file</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
	<span class="n">__receive_sock</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">new_fd</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>And luckily <code class="language-plaintext highlighter-rouge">__receive_fd</code>:</p>
<blockquote>
  <p>Returns newly install fd or -ve on error.</p>
</blockquote>

<p>By calling <code class="language-plaintext highlighter-rouge">close</code> on <code class="language-plaintext highlighter-rouge">fd-0</code> (<code class="language-plaintext highlighter-rouge">stdin</code>) before the timer fires, we can ensure that the function returns <code class="language-plaintext highlighter-rouge">0x00</code>.</p>

<p>After <code class="language-plaintext highlighter-rouge">__receive_fd</code> has been called and our <em>dirty</em> file has been installed, the initial UAF has been transformed into an UAF on a <code class="language-plaintext highlighter-rouge">struct file</code> object, which is much more useful.</p>

<!-- TODO However to call _any_ function it checks the `f_security` pointer at offset `192` which in our case is just a `dereference`   -->
<blockquote class="prompt-info">
  <p><code class="language-plaintext highlighter-rouge">sizeof(struct file) == 232</code> so to control every field of the <code class="language-plaintext highlighter-rouge">struct file</code> object we need to control <code class="language-plaintext highlighter-rouge">ceil(232 / 92) == 3</code> objects.</p>
</blockquote>

<h3 id="f_ops--heap-leak"><span class="me-2">f_ops / Heap leak</span><a href="https://qyn.app/posts/CVE-2023-3389/#f_ops--heap-leak" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Before we continue, what can we actually do with the <em>dirty</em> file. Given that we control the first chunk of the file object, we can overwrite <code class="language-plaintext highlighter-rouge">f_ops</code> to point to some arbitrary function (As long as the kernel has a pointer to that function).</p>

<p>In this case it was the easiest to first get a heap leak and construct a ROP chain in the chunks following that one. To get a heap leak there exists <code class="language-plaintext highlighter-rouge">netdev_init</code>:</p>
<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="cm">/* Initialize per network namespace state */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__net_init</span> <span class="nf">netdev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">GRO_HASH_BUCKETS</span> <span class="o">&gt;</span>
		     <span class="mi">8</span> <span class="o">*</span> <span class="n">sizeof_field</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span><span class="p">,</span> <span class="n">gro_bitmask</span><span class="p">));</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_base_head</span><span class="p">);</span>

	<span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_name_head</span> <span class="o">=</span> <span class="n">netdev_create_hash</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_name_head</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_name</span><span class="p">;</span>

	<span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_index_head</span> <span class="o">=</span> <span class="n">netdev_create_hash</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_index_head</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_idx</span><span class="p">;</span>

	<span class="n">RAW_INIT_NOTIFIER_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">netdev_chain</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_idx:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_name_head</span><span class="p">);</span>
<span class="nl">err_name:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>This results in a ‘two-way’ heap leak. Firstly, it leaks the address of <code class="language-plaintext highlighter-rouge">&amp;net-&gt;dev_base_head</code> due to the presence of <code class="language-plaintext highlighter-rouge">INIT_LIST_HEAD</code>. Secondly, <code class="language-plaintext highlighter-rouge">net-&gt;dev_name_head</code>, <code class="language-plaintext highlighter-rouge">net-&gt;dev_index_head</code>, and <code class="language-plaintext highlighter-rouge">net-&gt;netdev_chain</code> are truncated with null bytes, making it possible for us to detect their location. Its possible to detect these changes as long as we spray with a technique that allows us to read back what we sprayed; for example symlinks.<br>
Another thing that helps us is that these <em>two</em> ‘changes’ are at are at different offsets, <code class="language-plaintext highlighter-rouge">dev_base_head</code> is at <code class="language-plaintext highlighter-rouge">net+144</code> and <code class="language-plaintext highlighter-rouge">dev_index_head</code> at <code class="language-plaintext highlighter-rouge">net+304</code>, immediatly revealing the location of some sprayed chunks, 1 and 3 after our original base chunk.<br>
To determine the base chunk, we can utilize <code class="language-plaintext highlighter-rouge">dup</code> to increment our f_count at <code class="language-plaintext highlighter-rouge">file+56</code>. With this adjustment, we can iterate through all the chunks under our control, obtaining the heap leak, and then match these chunks with their symlink indexes.</p>

<h4 id="initial-spray"><span class="me-2">Initial Spray</span><a href="https://qyn.app/posts/CVE-2023-3389/#initial-spray" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>
<p>With <code class="language-plaintext highlighter-rouge">dev_index_head</code> located at <code class="language-plaintext highlighter-rouge">net+304</code>, the goal is to gain control over <code class="language-plaintext highlighter-rouge">ceil(304/92) = 4</code> consecutive chunks. To do this we first fill up the holes in the current CPU partial list and free some objects on a different CPU, ensuring the slabs of objects we don’t fully control land on another CPU partial list. Only then we can fill up some new slabs and free some objects, so the current CPU partial list is full of slabs of consecutive objects we control.<br>
Because it takes some tries (and time) to trigger the bug it is required to redo this step every <code class="language-plaintext highlighter-rouge">n</code> tries.</p>

<h3 id="shell"><span class="me-2">Shell</span><a href="https://qyn.app/posts/CVE-2023-3389/#shell" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Now to get <code class="language-plaintext highlighter-rouge">RIP</code> control we can free the first chunk and proceed to spray the first part of the ROP chain and repeat the process for the third chunk. Then lastly we also free our base chunk and spray our new <code class="language-plaintext highlighter-rouge">f_ops</code> pointing to our <code class="language-plaintext highlighter-rouge">ROP</code> chain. Finally giving us root.<br>
Now as root its not yet possible to call <code class="language-plaintext highlighter-rouge">system("sh")</code>, because stdin (<code class="language-plaintext highlighter-rouge">fd-0</code>) still points to our <em>dirty</em> file, so lets <em>just free and close it again.</em>. Well, to do this we <em>again</em> need to reallocate our <code class="language-plaintext highlighter-rouge">f_ops</code> to some <code class="language-plaintext highlighter-rouge">fops</code> that does not implement <code class="language-plaintext highlighter-rouge">flush</code> (It probably panics if it does call it), call <code class="language-plaintext highlighter-rouge">close(0)</code> and then <code class="language-plaintext highlighter-rouge">dup2(backup_fd_stdin, 0)</code>.<br>
And finally we have a shell (and hope it doesn’t break within a few seconds because the <code class="language-plaintext highlighter-rouge">rbtree</code> of the timer is most likely still slightly broken).</p>

<h2 id="affected-versions"><span class="me-2">Affected versions</span><a href="https://qyn.app/posts/CVE-2023-3389/#affected-versions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Even though the bug seemed to be fixed in ~v6.0 (Taken from the 5.10 &amp; 5.15 fix commit):</p>
<blockquote>
  <p>While reworking the poll hashing in the v6.0 kernel, we ended up
grabbing the ctx-&gt;uring_lock in poll update/removal. This also fixed
a bug with linked timeouts racing with timeout expiry and poll
removal.
Bring back just the locking fix for that.</p>
</blockquote>

<p>My reproducer was still able to crash upstream (Because the <code class="language-plaintext highlighter-rouge">uring_lock</code> was only held selectively).<br>
The final patch just holds the <code class="language-plaintext highlighter-rouge">uring_lock</code> while removing (and completing) a poll request.
Versions <code class="language-plaintext highlighter-rouge">5.13 - 6.4</code> and <code class="language-plaintext highlighter-rouge">5.10.162 - 5.10.185</code> were affected.<br>
Patch commits:</p>
<ul>
  <li><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ef7dfac51d8ed961b742218f526bd589f3900a59">upstream</a></li>
  <li><a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/?h=linux-5.15.y&amp;id=0e388fce7aec40992eadee654193cad345d62663">v5.15</a></li>
  <li><a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/?h=linux-5.10.y&amp;id=4716c73b188566865bdd79c3a6709696a224ac04">v5.10</a></li>
</ul>

</div>

<div class="post-tail-wrapper text-muted">

  <!-- categories -->
  
  <div class="post-meta mb-3">
    <i class="far fa-folder-open fa-fw me-1"></i>
    
      <a href="https://qyn.app/categories/pwn/">pwn</a>
  </div>
  

  <!-- tags -->
  
  <div class="post-tags">
    <i class="fa fa-tags fa-fw me-1"></i>
      
      <a href="https://qyn.app/tags/kernel/" class="post-tag no-text-decoration">kernel</a>
      
      <a href="https://qyn.app/tags/pwn/" class="post-tag no-text-decoration">pwn</a>
      
      <a href="https://qyn.app/tags/kctf/" class="post-tag no-text-decoration">kctf</a>
      
      <a href="https://qyn.app/tags/cve/" class="post-tag no-text-decoration">cve</a>
      
  </div>
  

  <div class="post-tail-bottom
    d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
    <div class="license-wrapper">

      

        

        This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.

      
    </div>

    <!-- Post sharing snippet -->

<div class="share-wrapper">
  <span class="share-label text-muted me-1">Share</span>
  <span class="share-icons">
    
    
    

    
      
      <a href="https://twitter.com/intent/tweet?text=CVE-2023-3389%20-%20LinkedPoll%20-%20Querijn%20Voet&amp;url=%2Fposts%2FCVE-2023-3389%2F" data-bs-toggle="tooltip" data-bs-placement="top" target="_blank" rel="noopener" aria-label="Twitter" data-bs-original-title="Twitter">
        <i class="fa-fw fab fa-twitter"></i>
      </a>
    
      
      <a href="https://www.facebook.com/sharer/sharer.php?title=CVE-2023-3389%20-%20LinkedPoll%20-%20Querijn%20Voet&amp;u=%2Fposts%2FCVE-2023-3389%2F" data-bs-toggle="tooltip" data-bs-placement="top" target="_blank" rel="noopener" aria-label="Facebook" data-bs-original-title="Facebook">
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    
      
      <a href="https://t.me/share/url?url=%2Fposts%2FCVE-2023-3389%2F&amp;text=CVE-2023-3389%20-%20LinkedPoll%20-%20Querijn%20Voet" data-bs-toggle="tooltip" data-bs-placement="top" target="_blank" rel="noopener" aria-label="Telegram" data-bs-original-title="Telegram">
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

    <i id="copy-link" class="fa-fw fas fa-link small" data-bs-toggle="tooltip" data-bs-placement="top" data-title-succeed="Link copied successfully!" aria-label="Copy link" data-bs-original-title="Copy link">
    </i>
  </span>
</div>


  </div><!-- .post-tail-bottom -->

</div><!-- div.post-tail-wrapper -->


      
    
      
    </div>
  </div>
  <!-- #core-wrapper -->

  <!-- panel -->
  <div id="panel-wrapper" class="col-xl-3 ps-2 text-muted">
    
      
      



  <div id="toc-wrapper" class="ps-0 pe-4 mb-5">
    <div class="panel-heading ps-3 pt-2 mb-2">Contents</div>
    <nav id="toc"><ul class="toc-list "><li class="toc-list-item is-active-li"><a href="https://qyn.app/posts/CVE-2023-3389/#introduction" class="toc-link node-name--H2  is-active-link">Introduction</a></li><li class="toc-list-item"><a href="https://qyn.app/posts/CVE-2023-3389/#io_uring" class="toc-link node-name--H2 ">IO_URING</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="https://qyn.app/posts/CVE-2023-3389/#asynchronous-requests" class="toc-link node-name--H3 ">Asynchronous Requests</a></li><li class="toc-list-item"><a href="https://qyn.app/posts/CVE-2023-3389/#ioring_op_timeout" class="toc-link node-name--H3 ">IORING_OP_TIMEOUT</a></li><li class="toc-list-item"><a href="https://qyn.app/posts/CVE-2023-3389/#ioring_op_link_timeout" class="toc-link node-name--H3 ">IORING_OP_LINK_TIMEOUT</a></li><li class="toc-list-item"><a href="https://qyn.app/posts/CVE-2023-3389/#ioring_op_timeout_remove" class="toc-link node-name--H3 ">IORING_OP_TIMEOUT_REMOVE</a></li><li class="toc-list-item"><a href="https://qyn.app/posts/CVE-2023-3389/#ioring_op_poll_add" class="toc-link node-name--H3 ">IORING_OP_POLL_ADD</a></li><li class="toc-list-item"><a href="https://qyn.app/posts/CVE-2023-3389/#ioring_op_poll_remove" class="toc-link node-name--H3 ">IORING_OP_POLL_REMOVE</a></li></ul></li><li class="toc-list-item"><a href="https://qyn.app/posts/CVE-2023-3389/#linkedpoll" class="toc-link node-name--H2 ">LinkedPoll</a></li><li class="toc-list-item"><a href="https://qyn.app/posts/CVE-2023-3389/#exploitation" class="toc-link node-name--H2 ">Exploitation</a><ul class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="https://qyn.app/posts/CVE-2023-3389/#triggered" class="toc-link node-name--H3 ">Triggered?</a></li><li class="toc-list-item"><a href="https://qyn.app/posts/CVE-2023-3389/#replacing-the-ltimeout" class="toc-link node-name--H3 ">Replacing the ltimeout</a></li><li class="toc-list-item"><a href="https://qyn.app/posts/CVE-2023-3389/#kaslr" class="toc-link node-name--H3 ">kASLR</a></li><li class="toc-list-item"><a href="https://qyn.app/posts/CVE-2023-3389/#dirty-file" class="toc-link node-name--H3 ">Dirty File</a></li><li class="toc-list-item"><a href="https://qyn.app/posts/CVE-2023-3389/#f_ops--heap-leak" class="toc-link node-name--H3 ">f_ops / Heap leak</a></li><li class="toc-list-item"><a href="https://qyn.app/posts/CVE-2023-3389/#shell" class="toc-link node-name--H3 ">Shell</a></li></ul></li><li class="toc-list-item"><a href="https://qyn.app/posts/CVE-2023-3389/#affected-versions" class="toc-link node-name--H2 ">Affected versions</a></li></ul></nav>
  </div>


    
  </div>
</div>

<!-- tail -->

  <div class="row">
    <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-3 pe-xl-4 mt-5">
      
        
        <!--
  Recommend the other 3 posts according to the tags and categories of the current post,
  if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->








  

  
    





<!-- Fill with the other newlest posts -->



  
    
    
  




      
        
        <!-- Navigation buttons at the bottom of the post. -->

<div class="post-navigation d-flex justify-content-between">
  
    <div class="btn btn-outline-primary disabled" prompt="Older">
      <p>-</p>
    </div>
  

  
    <div class="btn btn-outline-primary disabled" prompt="Newer">
      <p>-</p>
    </div>
  
</div>

      
        
        <!--  The comments switcher -->


      
    </div>
  </div>


        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 post-content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="https://qyn.app/tags/cve/">cve</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="https://qyn.app/tags/kctf/">kctf</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="https://qyn.app/tags/kernel/">kernel</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="https://qyn.app/tags/pwn/">pwn</a>
      
    </div>
  </div>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>
    </div>

    <!-- The Footer -->

<footer>
  <div class="container px-lg-4">
    <div class="d-flex justify-content-center align-items-center text-muted mx-md-3">
      <p>Just some blog
      </p>

      <p>©
        2023
        <a href="https://twitter.com/qynln">Querijn Voet</a>.
        
          <span data-bs-toggle="tooltip" data-bs-placement="top" data-bs-original-title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span>
        
      </p>
    </div>
  </div>
</footer>


    <div id="mask"></div>

    <button id="back-to-top" aria-label="back-to-top" class="btn btn-lg btn-box-shadow">
      <i class="fas fa-angle-up"></i>
    </button>

    
      <div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false">
        <div class="toast-header">
          <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body text-center pt-0">
          <p class="px-2 mb-3">A new version of content is available.</p>
          <button type="button" class="btn btn-primary" aria-label="Update">
            Update
          </button>
        </div>
      </div>
    

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="./CVE-2023-3389 - LinkedPoll _ Querijn Voet_files/mermaid.min.js.下載"></script>






<script defer="" src="./CVE-2023-3389 - LinkedPoll _ Querijn Voet_files/post.min.js.下載"></script>




  <!-- PWA -->
  
    <script defer="" src="./CVE-2023-3389 - LinkedPoll _ Querijn Voet_files/app.js.下載"></script>
  

  <!-- GA -->
  
    <!--
  The GA snippet
-->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script defer="" src="./CVE-2023-3389 - LinkedPoll _ Querijn Voet_files/js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}

    gtag('js', new Date());
    gtag('config', 'G-X3TQPDD7TE');
  });
</script>

  



    
      <!-- mermaid-js loader -->
<script type="text/javascript">
  (function () {
    function updateMermaid(event) {
      if (event.source === window && event.data && event.data.direction === ModeToggle.ID) {
        const mode = event.data.message;

        if (typeof mermaid === 'undefined') {
          return;
        }

        let expectedTheme = mode === ModeToggle.DARK_MODE ? 'dark' : 'default';
        let config = { theme: expectedTheme };

        /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */
        $('.mermaid').each(function () {
          let svgCode = $(this).prev().children().html();
          $(this).removeAttr('data-processed');
          $(this).html(svgCode);
        });

        mermaid.initialize(config);
        mermaid.init(undefined, '.mermaid');
      }
    }

    let initTheme = 'default';
    const html = document.documentElement;

    if (
      (html.hasAttribute('data-mode') && html.getAttribute('data-mode') === 'dark') ||
      (!html.hasAttribute('data-mode') && window.matchMedia('(prefers-color-scheme: dark)').matches)
    ) {
      initTheme = 'dark';
    }

    let mermaidConf = {
      theme: initTheme /* <default|dark|forest|neutral> */
    };

    /* Create mermaid tag */
    document.querySelectorAll('pre>code.language-mermaid').forEach((elem) => {
      const svgCode = elem.textContent;
      const backup = elem.parentElement;
      backup.classList.add('unloaded');
      /* create mermaid node */
      let mermaid = document.createElement('pre');
      mermaid.classList.add('mermaid');
      const text = document.createTextNode(svgCode);
      mermaid.appendChild(text);
      backup.after(mermaid);
    });

    mermaid.initialize(mermaidConf);

    window.addEventListener('message', updateMermaid);
  })();
</script>

    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '<div class="px-1 px-sm-2 px-lg-4 px-xl-0">  <a href="{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  


<div id="rememberry__extension__root" style="all: unset;"><template shadowrootmode="open"><main data-reactroot=""><!-- react-empty: 2 --><!-- react-empty: 3 --></main><style type="text/css">.Translator__wrapper__2qJID {
  position: absolute;
  left: 0;
  z-index: 1010;
  width: 100vw;
  opacity: 1;
  transition: opacity 200ms cubic-bezier(0.18, 0.65, 0.26, 0.98), transform 200ms ease-out; }
  .Translator__wrapper__2qJID[data-popup-direction="downward"] {
    top: 0;
    transform: translateY(9px); }
    .Translator__wrapper__2qJID[data-popup-direction="downward"] > .Translator__translation-popup__2_mD4 > .Translator__arrow__3eIZZ {
      top: -8px;
      transform: translateX(-50%) rotate(45deg);
      background-color: #2EC4B6; }
    .Translator__wrapper__2qJID[data-popup-direction="downward"] > .Translator__translation-popup__2_mD4:after {
      top: 0; }
  .Translator__wrapper__2qJID[data-popup-direction="upward"] {
    bottom: 0;
    transform: translateY(-8px); }
    .Translator__wrapper__2qJID[data-popup-direction="upward"] > .Translator__translation-popup__2_mD4 > .Translator__arrow__3eIZZ {
      bottom: -8px;
      transform: translateX(-50%) rotate(-135deg);
      background-color: #FDFFFC; }
    .Translator__wrapper__2qJID[data-popup-direction="upward"] > .Translator__translation-popup__2_mD4:after {
      bottom: 0; }
  .Translator__wrapper__2qJID:not([data-popup-direction="none"]) > .Translator__translation-popup__2_mD4:after {
    position: absolute;
    transform: translateX(-50%);
    width: 32px;
    height: 16px;
    background-color: #FDFFFC;
    content: ''; }
  .Translator__wrapper__2qJID:not([data-popup-direction="none"]) > .Translator__translation-popup__2_mD4 > .Translator__arrow__3eIZZ {
    position: absolute;
    width: 16px;
    height: 16px;
    border-top: 1px solid #2EC4B6;
    border-left: 1px solid #2EC4B6;
    box-shadow: 0 0 8px rgba(1, 22, 39, 0.3); }
  .Translator__wrapper__2qJID.Translator__in__3rwf1 {
    transform: translateY(0); }
  .Translator__wrapper__2qJID.Translator__in__3rwf1, .Translator__wrapper__2qJID.Translator__out__3AHaS {
    opacity: 0; }
  .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 {
    position: absolute;
    display: flex;
    min-width: 180px;
    max-width: 360px;
    border: 1px solid #2EC4B6;
    border-radius: 4px;
    box-shadow: 0 0 8px rgba(1, 22, 39, 0.3);
    flex-direction: column;
    color: #011627;
    background-color: #FDFFFC; }
    .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-10%"] {
      transform: translateX(-10%); }
      .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-10%"] > .Translator__arrow__3eIZZ, .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-10%"]:after {
        left: 10%; }
    .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-20%"] {
      transform: translateX(-20%); }
      .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-20%"] > .Translator__arrow__3eIZZ, .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-20%"]:after {
        left: 20%; }
    .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-30%"] {
      transform: translateX(-30%); }
      .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-30%"] > .Translator__arrow__3eIZZ, .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-30%"]:after {
        left: 30%; }
    .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-40%"] {
      transform: translateX(-40%); }
      .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-40%"] > .Translator__arrow__3eIZZ, .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-40%"]:after {
        left: 40%; }
    .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-50%"] {
      transform: translateX(-50%); }
      .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-50%"] > .Translator__arrow__3eIZZ, .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-50%"]:after {
        left: 50%; }
    .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-60%"] {
      transform: translateX(-60%); }
      .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-60%"] > .Translator__arrow__3eIZZ, .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-60%"]:after {
        left: 60%; }
    .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-70%"] {
      transform: translateX(-70%); }
      .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-70%"] > .Translator__arrow__3eIZZ, .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-70%"]:after {
        left: 70%; }
    .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-80%"] {
      transform: translateX(-80%); }
      .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-80%"] > .Translator__arrow__3eIZZ, .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-80%"]:after {
        left: 80%; }
    .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-90%"] {
      transform: translateX(-90%); }
      .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-90%"] > .Translator__arrow__3eIZZ, .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4[data-translateX="-90%"]:after {
        left: 90%; }
    .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__header__WILTl {
      z-index: 1;
      display: flex;
      height: 30px;
      background-color: #2EC4B6; }
      .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__header__WILTl > .Translator__btn__2x0P5 {
        display: inline-block;
        width: 30px;
        height: 30px;
        outline: none;
        flex-shrink: 0;
        color: #FDFFFC;
        font-size: 18px;
        line-height: 30px;
        text-align: center;
        text-shadow: 0 1px #20897f; }
        .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__header__WILTl > .Translator__btn__2x0P5:focus {
          color: #cc7f16; }
        .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__header__WILTl > .Translator__btn__2x0P5:active:not(.Translator__disabled__Cwgfb) {
          text-shadow: 0 -1px #20897f; }
        .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__header__WILTl > .Translator__btn__2x0P5.Translator__disabled__Cwgfb {
          color: #b8ebe6; }
      .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__header__WILTl > .Translator__languages__veNRV {
        vertical-align: top;
        display: inline-flex;
        margin: 5px 5px;
        flex-grow: 1;
        justify-content: center; }
        .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__header__WILTl > .Translator__languages__veNRV > i {
          margin-left: 2px;
          color: #FDFFFC; }
        .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__header__WILTl > .Translator__languages__veNRV > .Translator__container__1XAUw {
          position: relative;
          display: inline-flex; }
          .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__header__WILTl > .Translator__languages__veNRV > .Translator__container__1XAUw > select, .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__header__WILTl > .Translator__languages__veNRV > .Translator__container__1XAUw > select:hover {
            border: none;
            box-shadow: rgba(1, 22, 39, 0.078) 0 1px 0, rgba(253, 255, 252, 0.74) 0 1px 2px inset;
            border-radius: 5px;
            color: #011627;
            text-shadow: none;
            background-image: none;
            background-color: rgba(253, 255, 252, 0.9);
            cursor: pointer;
            -webkit-appearance: menulist;
            font-size: 12px;
            background-color: #FDFFFC; }
          .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__header__WILTl > .Translator__languages__veNRV > .Translator__container__1XAUw > select.Translator__true-select__1H8eq {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            opacity: 0; }
          .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__header__WILTl > .Translator__languages__veNRV > .Translator__container__1XAUw > select.Translator__fake-select__TiLW- {
            vertical-align: top;
            min-width: 40px;
            pointer-events: none; }
    .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo {
      position: relative;
      min-height: 30px;
      padding: 16px 5px; }
      .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translated-from__EL6tK {
        position: absolute;
        top: 4px;
        right: 8px;
        color: #2EC4B6;
        font-size: 12px;
        cursor: help; }
      .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__original__vxGtw {
        max-height: 116px;
        margin-bottom: 7px;
        padding: 0 8px;
        font-style: italic;
        word-break: break-word;
        overflow: auto; }
        .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__original__vxGtw > .Translator__pronunciation-btn__1kbhJ {
          display: inline-block;
          width: 22px;
          margin-right: 8px; }
        .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__original__vxGtw > .Translator__transcription-loader__3c8Vr {
          margin-top: 5px;
          text-align: center;
          cursor: help; }
        .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__original__vxGtw > .Translator__transcription__T_fKH {
          margin-top: 5px;
          margin-left: 30px;
          font-style: italic; }
      .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translations__29R5j {
        max-height: 250px;
        padding: 0 8px;
        overflow: auto; }
        .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translations__29R5j > .Translator__pos-wrapper__2Bd1U:not(:first-child) {
          margin-top: 10px; }
        .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translations__29R5j > .Translator__pos-wrapper__2Bd1U > .Translator__pos-header__12tEr {
          display: flex;
          border-bottom: 1px dotted #b8ebe6;
          justify-content: flex-end;
          color: #73d7ce;
          font-size: .9em;
          font-style: italic; }
          .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translations__29R5j > .Translator__pos-wrapper__2Bd1U > .Translator__pos-header__12tEr > .Translator__expand-terms__3MAyg {
            flex-grow: 1;
            text-align: left; }
            .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translations__29R5j > .Translator__pos-wrapper__2Bd1U > .Translator__pos-header__12tEr > .Translator__expand-terms__3MAyg > i.Translator__upside-down__2XYYt:before {
              transform: rotate(180deg);
              display: inline-block; }
            .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translations__29R5j > .Translator__pos-wrapper__2Bd1U > .Translator__pos-header__12tEr > .Translator__expand-terms__3MAyg > i:before {
              margin: 0; }
            .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translations__29R5j > .Translator__pos-wrapper__2Bd1U > .Translator__pos-header__12tEr > .Translator__expand-terms__3MAyg:hover, .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translations__29R5j > .Translator__pos-wrapper__2Bd1U > .Translator__pos-header__12tEr > .Translator__expand-terms__3MAyg:focus {
              color: #2EC4B6; }
              .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translations__29R5j > .Translator__pos-wrapper__2Bd1U > .Translator__pos-header__12tEr > .Translator__expand-terms__3MAyg:hover > i, .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translations__29R5j > .Translator__pos-wrapper__2Bd1U > .Translator__pos-header__12tEr > .Translator__expand-terms__3MAyg:focus > i {
                transform: scale(1.2);
                display: inline-block; }
        .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translations__29R5j > .Translator__pos-wrapper__2Bd1U > .Translator__term-line__gW8FJ {
          display: flex;
          min-height: 28px;
          padding: 4px 0;
          align-items: center;
          cursor: pointer; }
          .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translations__29R5j > .Translator__pos-wrapper__2Bd1U > .Translator__term-line__gW8FJ > .Translator__checkbox__cgTFI {
            display: inline-flex;
            width: 14px;
            height: 14px;
            margin-right: 5px;
            border: 1px solid #011627;
            border-radius: 2px;
            outline: none;
            flex-shrink: 0;
            justify-content: center;
            align-items: center; }
            .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translations__29R5j > .Translator__pos-wrapper__2Bd1U > .Translator__term-line__gW8FJ > .Translator__checkbox__cgTFI > i {
              display: none;
              color: #011627;
              font-size: 11px; }
              .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translations__29R5j > .Translator__pos-wrapper__2Bd1U > .Translator__term-line__gW8FJ > .Translator__checkbox__cgTFI > i:before {
                margin: 0; }
            .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translations__29R5j > .Translator__pos-wrapper__2Bd1U > .Translator__term-line__gW8FJ > .Translator__checkbox__cgTFI:focus {
              border-color: #cc7f16; }
            .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translations__29R5j > .Translator__pos-wrapper__2Bd1U > .Translator__term-line__gW8FJ > .Translator__checkbox__cgTFI.Translator__checked__REDlo > i {
              display: inline; }
          .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translations__29R5j > .Translator__pos-wrapper__2Bd1U > .Translator__term-line__gW8FJ:hover > .Translator__checkbox__cgTFI {
            box-shadow: inset 0 0 4px #73d7ce; }
          .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translations__29R5j > .Translator__pos-wrapper__2Bd1U > .Translator__term-line__gW8FJ > .Translator__term__3UT78 {
            min-height: 20px;
            max-height: 116px;
            flex-grow: 1;
            word-break: break-word;
            overflow: auto; }
          .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translations__29R5j > .Translator__pos-wrapper__2Bd1U > .Translator__term-line__gW8FJ > input {
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
            width: 0;
            padding: 0;
            border: none;
            flex-grow: 1;
            font-size: 15px;
            line-height: 20px; }
        .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translations__29R5j > .Translator__add-custom__2QhtK {
          display: flex;
          width: 14px;
          height: 14px;
          margin-top: 7px;
          border: 1px solid #011627;
          border-radius: 2px;
          outline: none;
          justify-content: center;
          align-items: center; }
          .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translations__29R5j > .Translator__add-custom__2QhtK > i {
            color: #1f837a;
            font-size: 10px; }
            .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translations__29R5j > .Translator__add-custom__2QhtK > i:before {
              margin: 0; }
          .Translator__wrapper__2qJID > .Translator__translation-popup__2_mD4 > .Translator__content-body__2mvzo > .Translator__translations__29R5j > .Translator__add-custom__2QhtK:focus {
            border-color: #cc7f16; }
</style><style type="text/css">.Button__btn__1lr0f:not(.Button__keep-cursor__V97qw) {
  cursor: pointer; }
  .Button__btn__1lr0f:not(.Button__keep-cursor__V97qw).Button__disabled__38AlQ {
    cursor: not-allowed; }
</style><style type="text/css">@charset "UTF-8";
/* stylelint-disable */
.icon-pencil:before {
  content: '\E800'; }

/* 'î €' */
.icon-ok:before {
  content: '\E801'; }

/* 'î ' */
.icon-ccw:before {
  content: '\E802'; }

/* 'î ‚' */
.icon-globe:before {
  content: '\E803'; }

/* 'î ƒ' */
.icon-info-circled:before {
  content: '\E804'; }

/* 'î „' */
.icon-cancel:before {
  content: '\E805'; }

/* 'î …' */
.icon-edit:before {
  content: '\E806'; }

/* 'î †' */
.icon-plus:before {
  content: '\E807'; }

/* 'î ‡' */
.icon-bookmark:before {
  content: '\E808'; }

/* 'î ˆ' */
.icon-settings:before {
  content: '\E809'; }

/* 'î ‰' */
.icon-down-1:before {
  content: '\E80A'; }

/* 'î Š' */
.icon-up-1:before {
  content: '\E80B'; }

/* 'î ‹' */
.icon-heart:before {
  content: '\E80C'; }

/* 'î Œ' */
.icon-export:before {
  content: '\E80D'; }

/* 'î ' */
.icon-keyboard-2:before {
  content: '\E80E'; }

/* 'î Ž' */
.icon-ok-circled:before {
  content: '\E814'; }

/* 'î ”' */
.icon-cancel-circled:before {
  content: '\E817'; }

/* 'î —' */
.icon-translate:before {
  content: '\E822'; }

/* 'î ¢' */
.icon-anki:before {
  content: '\E823'; }

/* 'î £' */
.icon-anki-1:before {
  content: '\E825'; }

/* 'î ¥' */
.icon-acc-basic:before {
  content: '\E830'; }

/* 'î °' */
.icon-acc-subscriber:before {
  content: '\E831'; }

/* 'î ±' */
.icon-rb-ico:before {
  content: '\E834'; }

/* 'î ´' */
.icon-cog:before {
  content: '\E840'; }

/* 'î¡€' */
.icon-login:before {
  content: '\E845'; }

/* 'î¡…' */
.icon-logout:before {
  content: '\E846'; }

/* 'î¡†' */
.icon-arrow-down-bold:before {
  content: '\E859'; }

/* 'î¡™' */
.icon-scissors:before {
  content: '\E88A'; }

/* 'î¢Š' */
.icon-home:before {
  content: '\E8C2'; }

/* 'î£‚' */
.icon-mute:before {
  content: '\E900'; }

/* 'î¤€' */
.icon-sound:before {
  content: '\E901'; }

/* 'î¤' */
.icon-left-bold:before {
  content: '\E929'; }

/* 'î¤©' */
.icon-down:before {
  content: '\E92C'; }

/* 'î¤¬' */
.icon-up:before {
  content: '\E92F'; }

/* 'î¤¯' */
.icon-switch:before {
  content: '\E937'; }

/* 'î¤·' */
.icon-graduation-cap-1:before {
  content: '\E96A'; }

/* 'î¥ª' */
.icon-floppy:before {
  content: '\E971'; }

/* 'î¥±' */
.icon-facebook:before {
  content: '\E98E'; }

/* 'î¦Ž' */
.icon-webstore:before {
  content: '\EC24'; }

/* 'î°¤' */
.icon-vk:before {
  content: '\EC71'; }

/* 'î±±' */
.icon-mail:before {
  content: '\ECD3'; }

/* 'î³“' */
.icon-graduation-cap:before {
  content: '\EE02'; }

/* 'î¸‚' */
.icon-emo-happy:before {
  content: '\EE63'; }

/* 'î¹£' */
.icon-emo-unhappy:before {
  content: '\EE66'; }

/* 'î¹¦' */
.icon-spin1:before {
  content: '\EE77'; }

/* 'î¹·' */
.icon-bookmark-empty:before {
  content: '\F097'; }

/* 'ï‚—' */
.icon-filter:before {
  content: '\F0B0'; }

/* 'ï‚°' */
.icon-paste:before {
  content: '\F0EA'; }

/* 'ïƒª' */
.icon-angle-double-left:before {
  content: '\F100'; }

/* 'ï„€' */
.icon-angle-double-right:before {
  content: '\F101'; }

/* 'ï„' */
.icon-angle-left:before {
  content: '\F104'; }

/* 'ï„„' */
.icon-angle-right:before {
  content: '\F105'; }

/* 'ï„…' */
.icon-angle-down:before {
  content: '\F107'; }

/* 'ï„‡' */
.icon-minus-squared:before {
  content: '\F147'; }

/* 'ï…‡' */
.icon-export-alt:before {
  content: '\F14D'; }

/* 'ï…' */
.icon-expand-right:before {
  content: '\F152'; }

/* 'ï…’' */
.icon-plus-squared:before {
  content: '\F196'; }

/* 'ï†–' */
.icon-language:before {
  content: '\F1AB'; }

/* 'ï†«' */
.icon-sliders:before {
  content: '\F1DE'; }

/* 'ï‡ž' */
.icon-trash:before {
  content: '\F1F8'; }

/* 'ï‡¸' */
.icon-clone:before {
  content: '\F24D'; }

/* 'ï‰' */
.icon-question-circle-o:before {
  content: '\F29C'; }

/* 'ïŠœ' */
.icon-user-circle:before {
  content: '\F2BD'; }

/* 'ïŠ½' */
.icon-twitter:before {
  content: '\F309'; }

/* 'ïŒ‰' */
.icon-gplus:before {
  content: '\F30F'; }

/* 'ïŒ' */
.icon-linkedin:before {
  content: '\F318'; }

/* 'ïŒ˜' */
[class^="icon-"]:before,
[class*=" icon-"]:before {
  display: inline-block;
  width: 1em;
  margin-right: .2em;
  margin-left: .2em;
  /* For safety - reset parent styles, that can break glyph codes*/
  font-family: "rbicon";
  font-variant: normal;
  font-weight: normal;
  font-style: normal;
  text-transform: none;
  text-align: center;
  text-decoration: inherit;
  -webkit-font-smoothing: antialiased;
  speak: none; }

/* stylelint-enable */
</style><style type="text/css">.Pronouncer__loading__2zqT4,
.Pronouncer__loading__2zqT4 > i {
  cursor: wait; }
</style><style type="text/css">@keyframes Bubble__zoom-in-out__1nY8w {
  0% {
    transform: translateX(-50%) scale(0.9); }
  50% {
    transform: translateX(-50%) scale(1.1); }
  100% {
    transform: translateX(-50%) scale(1); } }

.Bubble__bubble__2jKwp {
  position: absolute;
  z-index: 1009;
  transform: translateX(-50%);
  width: 28px;
  height: 28px;
  border-radius: 4px;
  box-shadow: 0 0 8px rgba(1, 22, 39, 0.3);
  background-color: #2EC4B6;
  animation: Bubble__zoom-in-out__1nY8w 200ms ease-out;
  transition: box-shadow 150ms ease-out; }
  .Bubble__bubble__2jKwp > i {
    display: inline-block;
    width: 100%;
    height: 100%;
    color: #FDFFFC;
    font-size: 18px;
    line-height: 28px;
    text-align: center;
    text-shadow: 0 1px #20897f; }
    .Bubble__bubble__2jKwp > i:before {
      margin: 0; }
  .Bubble__bubble__2jKwp:active > i {
    text-shadow: 0 -1px #20897f; }
</style><style type="text/css">::-webkit-scrollbar {
  width: 8px; }

::-webkit-scrollbar-thumb {
  border-radius: 8px;
  background-color: rgba(0, 0, 0, 0.45); }

main {
  all: initial;
  font-size: 16px;
  font-family: Georgia, Trebuchet MS, Helvetica, Helvetica Neue;
  -webkit-font-smoothing: antialiased; }

* {
  box-sizing: border-box; }

input,
button,
select {
  outline: none;
  font-family: Georgia, Trebuchet MS, Helvetica, Helvetica Neue;
  -webkit-font-smoothing: antialiased; }
</style></template></div></body></html>